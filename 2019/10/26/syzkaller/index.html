<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/leaf-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/leaf-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="linux内核fuzz工具syzkaller的编译及定制">
<meta property="og:type" content="article">
<meta property="og:title" content="syzkaller fuzz 工具的使用方法及实践实例">
<meta property="og:url" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/index.html">
<meta property="og:site_name" content="blingbling&#39;s blog">
<meta property="og:description" content="linux内核fuzz工具syzkaller的编译及定制">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-ethnet.png">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-running.png">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-display1.png">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-display2.png">
<meta property="og:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-display3.png">
<meta property="article:published_time" content="2019-10-25T16:00:00.000Z">
<meta property="article:modified_time" content="2023-07-05T17:01:00.683Z">
<meta property="article:author" content="blingbling">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/syzkaller-ethnet.png"><title>syzkaller fuzz 工具的使用方法及实践实例 | blingbling's blog</title><link ref="canonical" href="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"80px","tocMaxDepth":3},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: undefined,
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-thumbs-up"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">syzkaller fuzz 工具的使用方法及实践实例</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-10-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-07-06</span></span></div></header><div class="post-body"><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller" >Syzkaller</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 是google安全研究人员开发并维护的内核fuzz工具（2015年在github开源），由go语言编写，含少部分c/c++代码。支持多个操作系统内核，如linux、windows、darwin、openbsd等等，其对linux的支持最为全面。</p>
<p>本篇文章将搭建syzkaller环境的过程记录下来，供之后参考。</p>
<p>更新了一个视频：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gL4y1j7Cs?spm_id_from=333.999.0.0" >内核fuzz工具Syzkaller使用方法介绍</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="x86-64-linux虚拟机"   >
          <a href="#x86-64-linux虚拟机" class="heading-link"><i class="fas fa-link"></i></a><a href="#x86-64-linux虚拟机" class="headerlink" title="x86-64 linux虚拟机"></a>x86-64 linux虚拟机</h1>
      <blockquote>
<p>fuzz对象是linux kernel，架构是x86-64，使用qemu模拟运行。</p>
</blockquote>

        <h2 id="编译syzkaller"   >
          <a href="#编译syzkaller" class="heading-link"><i class="fas fa-link"></i></a><a href="#编译syzkaller" class="headerlink" title="编译syzkaller"></a>编译syzkaller</h2>
      <blockquote>
<p>以syzkaller github上最新版为准，项目一直在更新，今天（2022年2月）编译的时候，跟我上次（2020年12月）编译有挺多地方都不一样了。</p>
</blockquote>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup.md" >官方指导文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<ol>
<li><p>下载go语言编译器</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.google.com/go/go1.17.6.linux-amd64.tar.gz</span><br><span class="line">tar -xf go1.17.6.linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 后面这两条命令建议设置到～/.bashrc文件中，通过source ~/.bashrc命令更新配置</span></span><br><span class="line"><span class="built_in">export</span> GOROOT=`<span class="built_in">pwd</span>`/goroot</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GOROOT</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></div></figure></li>
<li><p>下载并编译syzkaller</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/syzkaller</span><br><span class="line"><span class="built_in">cd</span> syzkaller</span><br><span class="line">make</span><br><span class="line"><span class="comment"># 如果fuzz目标是arm 64位，则需指定交叉编译器，如下</span></span><br><span class="line"><span class="comment"># make CC=aarch64-linux-gnu-g++ TARGETARCH=arm64</span></span><br></pre></td></tr></table></div></figure>
<p>编译过程中遇到一个问题，是因为虚拟机内存给少了，给到12G内存后不再报错。</p>
</li>
</ol>
<p>编译完成后，在syzkaller目录下会出现一个bin目录，里面就是我们后面需要用到的二进制。如下是我编译的结果：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~/syzkaller$ tree ./bin</span><br><span class="line">./bin</span><br><span class="line">├── linux_amd64</span><br><span class="line">│   ├── syz-execprog</span><br><span class="line">│   ├── syz-executor</span><br><span class="line">│   ├── syz-fuzzer</span><br><span class="line">│   └── syz-stress</span><br><span class="line">├── syz-db</span><br><span class="line">├── syz-manager</span><br><span class="line">├── syz-mutate</span><br><span class="line">├── syz-prog2c</span><br><span class="line">├── syz-repro</span><br><span class="line">├── syz-runtest</span><br><span class="line">├── syz-sysgen</span><br><span class="line">└── syz-upgrade</span><br></pre></td></tr></table></div></figure>

        <h2 id="编译linux内核"   >
          <a href="#编译linux内核" class="heading-link"><i class="fas fa-link"></i></a><a href="#编译linux内核" class="headerlink" title="编译linux内核"></a>编译linux内核</h2>
      <ol>
<li><p>以linux 5.14内核为例，先将源码下载到本地</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --branch v5.14 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</span><br></pre></td></tr></table></div></figure></li>
<li><p>生成默认配置文件</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> linux</span><br><span class="line">make defconfig</span><br><span class="line">make kvm_guest.config</span><br></pre></td></tr></table></div></figure></li>
<li><p>更改.config文件</p>
<p>为了fuzz效率，以下内核配置必须打开。更多可选配置见<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/kernel_configs.md" >Linux kernel configs</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Coverage collection.</span></span><br><span class="line">CONFIG_KCOV=y         <span class="comment"># must</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debug info for symbolization.</span></span><br><span class="line">CONFIG_DEBUG_INFO=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory bug detector</span></span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Code coverage works better when KASLR Is disabled </span></span><br><span class="line"><span class="comment"># CONFIG_RANDOMIZE_BASE is not set</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选</span></span><br><span class="line">CONFIG_KCOV_INSTRUMENT_ALL=y</span><br><span class="line">CONFIG_KCOV_ENABLE_COMPARISONS=y</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line"></span><br><span class="line">CONFIG_DEBUG_KMEMLEAK=y</span><br></pre></td></tr></table></div></figure></li>
<li><p>重新生成配置文件并编译</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make olddefconfig</span><br><span class="line">make -j4</span><br></pre></td></tr></table></div></figure></li>
<li><p>漫长的等待后，就能在目录下看到<code>vmlinux</code> (kernel binary) 和 <code>bzImage</code> (packed kernel image)</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ ls linux/vmlinux</span><br><span class="line">linux/vmlinux</span><br><span class="line">~$ ls linux/arch/x86/boot/bzImage</span><br><span class="line">linux/arch/x86/boot/bzImage</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h2 id="配置qemu虚拟机"   >
          <a href="#配置qemu虚拟机" class="heading-link"><i class="fas fa-link"></i></a><a href="#配置qemu虚拟机" class="headerlink" title="配置qemu虚拟机"></a>配置qemu虚拟机</h2>
      <ol>
<li>安装qemu</li>
</ol>
<p>使用<code>sudo apt install qemu</code>或下载最新qemu源码编译。前者的版本较低，有些特性不支持。建议使用后者。</p>
<ol start="2">
<li>生成image</li>
</ol>
<p>使用debootstrap构建linux启动镜像：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install debootstrap</span><br><span class="line">cd $IMAGE/</span><br><span class="line">wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh</span><br><span class="line">chmod +x create-image.sh</span><br><span class="line">./create-image.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用./create-image.sh -h查看更多帮助选项</span></span><br></pre></td></tr></table></div></figure>
<p>完成之后目录内容如下：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~/s_image$</span><span class="bash"> ll</span></span><br><span class="line">total 502072</span><br><span class="line">drwxr-xr-x  3 bling bling       4096 1月   9 09:03 ./</span><br><span class="line">drwxr-xr-x 25 bling bling       4096 1月   9 00:45 ../</span><br><span class="line">drwxr-xr-x 21 root  root        4096 1月   9 02:25 chroot/</span><br><span class="line">-rwxr-xr-x  1 bling bling       6360 1月   9 00:13 create-image.sh*</span><br><span class="line">-rw-------  1 bling bling       1675 1月   9 09:03 stretch.id_rsa</span><br><span class="line">-rw-r--r--  1 bling bling        398 1月   9 09:03 stretch.id_rsa.pub</span><br><span class="line">-rw-r--r--  1 bling bling 2147483648 1月   9 09:04 stretch.img</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>启动虚拟机</li>
</ol>
<p>启动虚拟机试试</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -m 2G -smp 2 -kernel /home/bling/linux/arch/x86/boot/bzImage -append &quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot; -drive file=/home/bling/qemu-img/stretch.img,format=raw -net user,hostfwd=tcp:127.0.0.1:10021-:22 -net nic,model=e1000 -enable-kvm -nographic -pidfile vm.pid 2&gt;&amp;1 | tee vm.log</span><br></pre></td></tr></table></div></figure>
<p>对以上各参数我的理解如下：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-kernel xxx&#x2F;bzImage：用bzImage作为内核镜像，qemu的这个功能用来测试不同内核非常方便。</span><br><span class="line">-append cmdline：将cmdline作为内核的命令行参数</span><br><span class="line">-hda xxx&#x2F;xxx.img：指定xxx.img作为硬盘镜像</span><br><span class="line">-net user,hostfwd&#x3D;tcp::10021-:22 -net nic：客户机与宿主机之间通过指定的端口进行通讯</span><br><span class="line">-enable-kvm：开启kvm虚拟化</span><br><span class="line">-nographic：非图形界面启动</span><br><span class="line">-m 2G：分配2G内存给虚拟系统</span><br><span class="line">-smp 2：指定虚拟机由2个CPU</span><br><span class="line">-pidfile xxx.pid：将qemu进程pid储存在xxx.pid这个文件中</span><br><span class="line">2&gt;&amp;1 | tee vm.log：将执行过程中的输出同时定向到标准输出和vm.log文件中</span><br></pre></td></tr></table></div></figure>
<p>参考了两篇文章：（1）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/tzwsoho/article/details/80303088" >hostfwd的问题</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> （2）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/Dr_Unknown/article/details/76837708" >make 2&gt;&amp;1 | tee log.txt 命令解析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>qemu启动起来之后，运行ssh测试一下是否连通，便于后期syzkaller运行出错时定位问题。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i $IMAGE/stretch.id_rsa -p 10021 -o &quot;StrictHostKeyChecking no&quot; root@localhost</span><br></pre></td></tr></table></div></figure>
<p>曾经有一次连接时在这里出了问题，宿主机上ssh无法连接到虚拟机。原因如下：</p>
<p>由于上一步中create-image.sh中如下eth0跟实际qemu虚拟机中运行的网卡名称不一样，导致网卡没有分配IP地址。最后解决方法如下：qemu启动虚拟机，root用户身份登录后，设置网卡IP地址。</p>
<p><img src="syzkaller-ethnet.png"></p>
<p>参考文章：（1）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/wuzhong8809/article/details/83374140" >网卡没分配IP地址的解决方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>（2）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/web/2019/05/10/rsa/" >rsa公私钥知识点</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>（3）<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://embedsec.systems/zh/gnulinux-security/2017/06/05/syzkaller.html" >一个自己生成公私钥配置的方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭qemu虚拟机</span></span><br><span class="line">kill $(cat vm.pid)</span><br></pre></td></tr></table></div></figure>

        <h2 id="启动syzkaller-qemu"   >
          <a href="#启动syzkaller-qemu" class="heading-link"><i class="fas fa-link"></i></a><a href="#启动syzkaller-qemu" class="headerlink" title="启动syzkaller - qemu"></a>启动syzkaller - qemu</h2>
      <p>为了使syzkaller运行起来，在syzkaller目录下，新建一个workdir目录，并新建一个config文件用于配置运行所需参数（命名为xxx.cfg）</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir workdir</span><br><span class="line">./bin/syz-manager -config=abcd.cfg</span><br></pre></td></tr></table></div></figure>
<p>cfg文件的格式如下，根据实际情况各参数可做更改：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        &quot;target&quot;: &quot;linux&#x2F;amd64&quot;,</span><br><span class="line">        &quot;http&quot;: &quot;127.0.0.1:56741&quot;,</span><br><span class="line">        &quot;workdir&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;google&#x2F;syzkaller&#x2F;workdir&quot;,</span><br><span class="line">        &quot;kernel_obj&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;linux&quot;,</span><br><span class="line">        &quot;image&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;s_image&#x2F;stretch.img&quot;,</span><br><span class="line">        &quot;sshkey&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;s_image&#x2F;stretch.id_rsa&quot;,</span><br><span class="line">        &quot;syzkaller&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;gopath&#x2F;src&#x2F;github.com&#x2F;google&#x2F;syzkaller&#x2F;&quot;,</span><br><span class="line">        &quot;procs&quot;: 8,</span><br><span class="line">        &quot;type&quot;: &quot;qemu&quot;,</span><br><span class="line">        &quot;vm&quot;: &#123;</span><br><span class="line">                &quot;count&quot;: 4,</span><br><span class="line">                &quot;kernel&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;linux&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImage&quot;,</span><br><span class="line">                &quot;cpu&quot;: 2,</span><br><span class="line">                &quot;mem&quot;: 2048</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>执行成功后，如下图所示：</p>
<p><img src="syzkaller-running.png"></p>

        <h2 id="启动syzkaller-isolated"   >
          <a href="#启动syzkaller-isolated" class="heading-link"><i class="fas fa-link"></i></a><a href="#启动syzkaller-isolated" class="headerlink" title="启动syzkaller - isolated"></a>启动syzkaller - isolated</h2>
      <p>对于两台通过网络连接的独立机器，使用syzkaller进行fuzz时，需要设置ssh连接并更改config配置文件。</p>
<blockquote>
<p>ps. 由于没有两台物理机，这里复用上一步的qemu，不同点在于将虚拟机和物理机看作两台独立运行的机器</p>
</blockquote>
<p>可参考如下步骤，先配置好待测试设备，然后再运行syzkaller。</p>

        <h3 id="配置好待测试设备"   >
          <a href="#配置好待测试设备" class="heading-link"><i class="fas fa-link"></i></a><a href="#配置好待测试设备" class="headerlink" title="配置好待测试设备"></a>配置好待测试设备</h3>
      <p>在使用syzkaller进行fuzz之前，需要确保目标设备上运行着上一步编译的内核，并且设置好了ssh连接。</p>
<p>可参考官方文档：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/setup_linux-host_isolated.md" >setup_linux-host_isolated</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>提炼一下，需保证如下几点：</p>
<ol>
<li><p><strong>待测试设备上运行着ssh服务</strong></p>
</li>
<li><p><strong>打开ssh的AllowTcpForwarding选项</strong></p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~#</span><span class="bash"> grep Forwarding /etc/ssh/sshd_config</span></span><br><span class="line">AllowTcpForwarding yes</span><br></pre></td></tr></table></div></figure></li>
<li><p><strong>配置ssh无密码连接</strong></p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在本地生成公私钥对文件</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"><span class="comment"># 然后，将公钥文件拷贝到目标测试机器的/root/.ssh/目录下，并重命名为authorized_keys</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="运行syzkaller"   >
          <a href="#运行syzkaller" class="heading-link"><i class="fas fa-link"></i></a><a href="#运行syzkaller" class="headerlink" title="运行syzkaller"></a>运行syzkaller</h3>
      </li>
<li><p>在本地和目标设备上各创建一个工作目录</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地：</span></span><br><span class="line"><span class="built_in">cd</span> syzkaller</span><br><span class="line">mkdir workdir</span><br><span class="line"><span class="comment"># 远端：</span></span><br><span class="line"><span class="built_in">cd</span> home</span><br><span class="line">mkdir fuzzdir</span><br></pre></td></tr></table></div></figure></li>
<li><p>在syzkaller目录下新建一个fuzz.cfg文件</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;target&quot;: &quot;linux/amd64&quot;,</span><br><span class="line">	&quot;http&quot;: &quot;127.0.0.1:56741&quot;,</span><br><span class="line">	&quot;rpc&quot;: &quot;127.0.0.1:0&quot;,</span><br><span class="line">	&quot;sshkey&quot; : &quot;//home/bling/qemu-img/stretch.id_rsa&quot;,</span><br><span class="line">	&quot;workdir&quot;: &quot;/home/bling/syzkaller/workdir&quot;,</span><br><span class="line">	&quot;kernel_obj&quot;: &quot;/home/bling/linux&quot;,</span><br><span class="line">	&quot;syzkaller&quot;: &quot;/home/bling/syzkaller&quot;,</span><br><span class="line">	&quot;sandbox&quot;: &quot;setuid&quot;,</span><br><span class="line">	&quot;type&quot;: &quot;isolated&quot;,</span><br><span class="line">	&quot;vm&quot;: &#123;</span><br><span class="line">		&quot;targets&quot; : [ &quot;127.0.0.1:10021&quot; ],</span><br><span class="line">		&quot;pstore&quot;: false,</span><br><span class="line">		&quot;target_dir&quot; : &quot;/home/fuzzdir&quot;,</span><br><span class="line">    &quot;target_reboot&quot; : false</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>target指定待测试设备的操作系统内核及cpu架构</li>
<li>vm.targets指定待fuzz设备的ip地址及ssh端口（默认是22）</li>
<li>enbale_syscalls：测试特定的几个系统调用</li>
<li>disable_syscalls：不调用某几个系统调用</li>
</ul>
<p>对各个字段的解释，贴两个官方文档：</p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/pkg/mgrconfig/config.go" >config文件中各字段的解释</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/vm/isolated/isolated.go" >isolated情况下vm字段中参数的解释</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<blockquote>
<p>ps. “kernel_obj”删除不指定也是可以的，区别在于无法在web面板中查看代码覆盖率情况</p>
</blockquote>
</li>
<li><p>启动syzkaller</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;syz-manager -config&#x3D;fuzz.cfg</span><br></pre></td></tr></table></div></figure>

</li>
</ol>

        <h1 id="提高fuzz效率"   >
          <a href="#提高fuzz效率" class="heading-link"><i class="fas fa-link"></i></a><a href="#提高fuzz效率" class="headerlink" title="提高fuzz效率"></a>提高fuzz效率</h1>
      <p>syzkaller无法根据源码自动分析出有哪些设备节点，也无法获得系统调用及参数信息。如果不针对内核版本进一步定制，那么fuzz效率将非常低。</p>

        <h2 id="定制syscall-description"   >
          <a href="#定制syscall-description" class="heading-link"><i class="fas fa-link"></i></a><a href="#定制syscall-description" class="headerlink" title="定制syscall description"></a>定制syscall description</h2>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md" >syscall descriptions官方说明</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>syzkaller自己定义了一套描述系统调用模版的声明式语言（syzlang），我称之为描述文件/声明文件。</p>
<p>为了提高fuzz效率，我们必须为目标系统量身定制这种声明文件。通常一个设备节点对应一个声明文件。</p>
<p>所谓的声明文件就是一个txt，根据syzkaller定义的语法，在这个txt文档中描述设备节点的接口信息以及参数格式。</p>

        <h3 id="用syzlang描述系统调用"   >
          <a href="#用syzlang描述系统调用" class="heading-link"><i class="fas fa-link"></i></a><a href="#用syzlang描述系统调用" class="headerlink" title="用syzlang描述系统调用"></a>用syzlang描述系统调用</h3>
      <p>定制（即对新的内核接口，增加系统调用描述文件）是一个比较繁琐的过程，官方给了如下文档用作参考：</p>
<ul>
<li><p>txt声明文件的语法： <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md" >syscall description语法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
<li><p>一些linux下的syscall description：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/tree/master/sys/linux" >现有可参考的声明文件</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</li>
</ul>
<p>举一个例子，从系统调用open()函数开始，它的函数定义如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span>;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>flags：<code>O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</code></li>
<li>mode：<code>S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</code></li>
</ul>
<p>用syzlang来描述它：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">resource fd_test[fd]</span><br><span class="line">open(file ptr[<span class="keyword">in</span>, filename], flags flags[open_flags], mode flags[open_mode]) fd_test</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="comment"># open(file ptr[in, string[&quot;/dev/xxx&quot;]], flags flags[open_flags], mode flags[open_mode]) fd_test</span></span><br></pre></td></tr></table></div></figure>
<ul>
<li><p><code>file ptr[in, filename]</code>：open()函数的第一个参数，命名为file，是一个输入指针类型，指针指向一个文件名字符串</p>
</li>
<li><p><code>flags flags[open_flags]</code>：flags表明该参数是open_flags数组中的任意一个值</p>
<ul>
<li><code>open_flags = O_WRONLY, O_RDWR, O_APPEND, ...</code></li>
</ul>
</li>
<li><p><code>mode flags[open_mode]</code>：flags表明该参数是open_mode数组中的任意一个值</p>
<ul>
<li><code>open_mode = S_IRUSR, S_IWUSR, S_IXUSR, ...</code></li>
</ul>
</li>
<li><p><code>fd_test</code>：open()函数的返回值将给fd_test，这是一个文件描述符</p>
</li>
</ul>
<p><code>fd_test</code>将被用于其他系统调用，如read、write、ioctl</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read(fd_1 fd_test, buf buffer[out], count len[buf])</span><br><span class="line">write(fd_1 fd_test, buf buffer[in], count len[buf])</span><br></pre></td></tr></table></div></figure>
<ul>
<li>buffer是任意大小的数组空间，填满了int8类型的值。可以是输入参数也可以作为输出参数。</li>
<li>len[buf]得到buf的长度</li>
</ul>
<p>ioctl通常承载更多更复杂的功能，syzkaller针对ioctl提供了一种通用的描述方法：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(fd_1 fd_test, cmd intptr, arg buffer[in])</span><br></pre></td></tr></table></div></figure>
<p>上面这种方式并不准确，为了更精确地触发ioclt中各个case分支，通常需要做额外的适配工作：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ioctl$DRM_IOCTL_VERSION(fd fd_dri, cmd const[DRM_IOCTL_VERSION], arg ptr[in, drm_version])</span><br><span class="line">ioctl$VIDIOC_QUERYCAP(fd fd_video, cmd const[VIDIOC_QUERYCAP], arg ptr[out, v4l2_capability])</span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>
<ul>
<li><p><code>DRM_IOCTL_VERSION</code>和<code>VIDIOC_QUERYCAP</code>是ioctl中的某两个case分支</p>
</li>
<li><p><code>drm_version</code>和<code>v4l2_capability</code>分别是以上两个分支其arg指针指向的结构体（同样需要用syzlang描述）</p>
</li>
</ul>
<p>可以对比如下参考文件，学习基本使用方法：</p>
<ul>
<li><p>/dev/random字符设备</p>
<ul>
<li>random源码路径：linux/drivers/char/random.c</li>
<li>random描述文件：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/sys/linux/dev_random.txt" >https://github.com/google/syzkaller/blob/master/sys/linux/dev_random.txt</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</li>
<li><p>/dev/ptmx字符设备</p>
<ul>
<li>ptmx源码路径：linux/drivers/tty/tty_ioctl.c</li>
<li>ptmx描述文件：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/sys/linux/dev_ptmx.txt" >https://github.com/google/syzkaller/blob/master/sys/linux/dev_ptmx.txt</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</li>
</ul>

        <h3 id="将描述信息编译进syzkaller"   >
          <a href="#将描述信息编译进syzkaller" class="heading-link"><i class="fas fa-link"></i></a><a href="#将描述信息编译进syzkaller" class="headerlink" title="将描述信息编译进syzkaller"></a>将描述信息编译进syzkaller</h3>
      <p>那么，整个定制过程分为4步：</p>
<ol>
<li>根据目标内核模块的信息，撰写符合syzlang语法的txt声明文件</li>
<li>syz-extract根据txt及linux源码，提取符号常量的值，生成中间文件***.const文件</li>
<li>syz-sysgen根据const文件生成syzkaller执行时使用的go文件</li>
<li>重新编译syzkaller</li>
</ol>
<p>如果syzkaller/bin目录下，没有syz-extract和syz-sysgen这两个文件的话，需要执行如下命令编译：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bin/syz-extract</span><br><span class="line">make bin/syz-sysgen</span><br></pre></td></tr></table></div></figure>
<p>它俩的关系是这样的：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-------+            +---------+           +------+</span><br><span class="line">|xxx.txt+-----------&gt;|xxx.const+----------&gt;|xxx.go|</span><br><span class="line">+---+---+            +---------+           +------+</span><br><span class="line">    |    syz-extract            syz-sysgen    ^</span><br><span class="line">    |                                         |</span><br><span class="line">    +-----------------------------------------+</span><br></pre></td></tr></table></div></figure>
<p>我们针对某个驱动接口写出xxx.txt，然后使用syz-extract利用txt和源码生成const文档，最后执行syz-sysgen时syzkaller会根据txt和const生成一个go文件。可在sys/linux/gen/amd64.go和executor/syscalls.h中看到结果。</p>

        <h2 id="一次定制示例（isolated）"   >
          <a href="#一次定制示例（isolated）" class="heading-link"><i class="fas fa-link"></i></a><a href="#一次定制示例（isolated）" class="headerlink" title="一次定制示例（isolated）"></a>一次定制示例（isolated）</h2>
      <ul>
<li>编写一个有漏洞的驱动接口，并将其编译进内核（或者使用打ko的方式）。</li>
<li>编写驱动接口对应的txt文件，将其放入syzkaller/sys/linux目录下，生成go文件并重新编译syzkaller。</li>
<li>运行syzkaller，改config文件指定fuzz接口提高速率，最后分析crash。</li>
</ul>

        <h3 id="编译进内核"   >
          <a href="#编译进内核" class="heading-link"><i class="fas fa-link"></i></a><a href="#编译进内核" class="headerlink" title="编译进内核"></a>编译进内核</h3>
      <blockquote>
<p>方法1：将内核模块编译进内核</p>
</blockquote>

        <h4 id="一个有漏洞的内核模块"   >
          <a href="#一个有漏洞的内核模块" class="heading-link"><i class="fas fa-link"></i></a><a href="#一个有漏洞的内核模块" class="headerlink" title="一个有漏洞的内核模块"></a>一个有漏洞的内核模块</h4>
      <ol>
<li><p>在<code>kernel_src/drivers/char</code>目录下，新建一个<a href="testxy.c">testxy.c</a>。这是一个有漏洞的内核模块，漏洞代码片段如下：</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">proc_write</span> <span class="params">(struct file *proc_file, <span class="keyword">const</span> <span class="keyword">char</span> __user *proc_user, <span class="keyword">size_t</span> n, <span class="keyword">loff_t</span> *loff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *c = kmalloc(<span class="number">512</span>, GFP_KERNEL);</span><br><span class="line">    copy_from_user(c, proc_user, <span class="number">4096</span>);</span><br><span class="line">    printk(<span class="string">&quot;:into write!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li>
<li><p>打开char/目录下的Kconfig文件，添加：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config TESTXY_MODULE</span><br><span class="line">        tristate <span class="string">&quot;heap overflow test&quot;</span></span><br><span class="line">        default y</span><br><span class="line">        <span class="built_in">help</span></span><br><span class="line">          This file is to <span class="built_in">test</span> a buffer overflow</span><br></pre></td></tr></table></div></figure></li>
<li><p>打开char/目录下的Makefile文件，添加：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_TESTXY_MODULE) += testxy.o</span><br></pre></td></tr></table></div></figure>
<p>​        若/linux/drivers/char/是新目录，还需修改/linux/drivers/Kconfig（加上source “drivers/char/Kconfig”）；修改/linux/drivers/Makefile（加上obj-$(CONFIG_TEST_MODULE) += char/）。</p>
</li>
<li><p>make menuconfig时可以在<code>Device Drivers -&gt; Heap Overflow Test</code> (*表示直接编入内核，M表示模块形式) 处看到刚刚添加的测试模块。</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">make menuconfig</span><br><span class="line">make -j8</span><br></pre></td></tr></table></div></figure></li>
<li><p>用新的内核启动虚拟机，查看模块是否加载成功</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模块对应设备节点是否存在</span></span><br><span class="line">ls /proc/test1</span><br><span class="line"><span class="comment"># 查看模块加载时的log信息</span></span><br><span class="line">dmesg | grep <span class="string">&quot;proc init&quot;</span></span><br></pre></td></tr></table></div></figure>

        <h4 id="定制txt系统调用描述文件"   >
          <a href="#定制txt系统调用描述文件" class="heading-link"><i class="fas fa-link"></i></a><a href="#定制txt系统调用描述文件" class="headerlink" title="定制txt系统调用描述文件"></a>定制txt系统调用描述文件</h4>
      </li>
<li><p>syzkaller源码中，找到sys/linux/目录，新建一个文件，命名为<code>proc_testxy.txt</code>，内容如下：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux/fs.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">open$</span><span class="bash">testxy(file ptr[<span class="keyword">in</span>, string[<span class="string">&quot;/proc/test1&quot;</span>]], flags flags[proc_open_flags], mode flags[proc_open_mode]) fd</span></span><br><span class="line"><span class="meta">read$</span><span class="bash">testxy(fd fd, buf buffer[out], count len[buf]) len[buf]</span></span><br><span class="line"><span class="meta">write$</span><span class="bash">testxy(fd fd, buf buffer[<span class="keyword">in</span>], count len[buf]) len[buf]</span></span><br><span class="line"></span><br><span class="line">proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></div></figure></li>
<li><p>使用syz-extract生成const文件。指定txt文件名，可单独生成该文件对应的const文件。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/syz-extract -os linux -arch amd64 -sourcedir &quot;/home/bling/linux&quot; proc_testxy.txt</span><br></pre></td></tr></table></div></figure></li>
<li><p>运行syz-sysgen</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;syz-extract</span><br></pre></td></tr></table></div></figure></li>
<li><p>重新编译syzkaller</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make generate</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure>

        <h4 id="验证能否成功触发crash"   >
          <a href="#验证能否成功触发crash" class="heading-link"><i class="fas fa-link"></i></a><a href="#验证能否成功触发crash" class="headerlink" title="验证能否成功触发crash"></a>验证能否成功触发crash</h4>
      </li>
</ol>
<p>启动syzkaller的配置文件如下。为了更快看到crash结果，增加了“enable_syscalls”项，只允许某些系统调用，能更快地触发漏洞。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;target&quot;: &quot;linux&#x2F;amd64&quot;,</span><br><span class="line">	&quot;http&quot;: &quot;127.0.0.1:56741&quot;,</span><br><span class="line">	&quot;rpc&quot;: &quot;127.0.0.1:0&quot;,</span><br><span class="line">	&quot;sshkey&quot; : &quot;&#x2F;&#x2F;home&#x2F;bling&#x2F;qemu-img&#x2F;stretch.id_rsa&quot;,</span><br><span class="line">	&quot;workdir&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;syzkaller&#x2F;workdir&quot;,</span><br><span class="line">	&quot;kernel_obj&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;linux&quot;,</span><br><span class="line">	&quot;syzkaller&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;syzkaller&quot;,</span><br><span class="line">	&quot;sandbox&quot;: &quot;setuid&quot;,</span><br><span class="line">	&quot;type&quot;: &quot;isolated&quot;,</span><br><span class="line">	&quot;enable_syscalls&quot;:[</span><br><span class="line">        		&quot;open$testxy&quot;,</span><br><span class="line">        		&quot;read$testxy&quot;,</span><br><span class="line">        		&quot;write$testxy&quot;,</span><br><span class="line">        		&quot;close$testxy&quot;</span><br><span class="line">     ],</span><br><span class="line">	&quot;vm&quot;: &#123;</span><br><span class="line">		&quot;targets&quot; : [ &quot;127.0.0.1:10021&quot; ],</span><br><span class="line">		&quot;pstore&quot;: false,</span><br><span class="line">		&quot;target_dir&quot; : &quot;&#x2F;home&#x2F;fuzzdir&quot;,</span><br><span class="line">    &quot;target_reboot&quot; : false</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>启动syzkaller进行测试：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;syz-manager -config&#x3D;abcd.cfg</span><br></pre></td></tr></table></div></figure>
<p>触发到漏洞分支！（图片跟笔记稍微有点区别，图片是两年前的，笔记是22年更新的）</p>
<p><img src="syzkaller-display1.png"></p>
<p><img src="syzkaller-display2.png"></p>
<p><img src="syzkaller-display3.png"></p>

        <h3 id="打ko"   >
          <a href="#打ko" class="heading-link"><i class="fas fa-link"></i></a><a href="#打ko" class="headerlink" title="打ko"></a>打ko</h3>
      <blockquote>
<p>方法2：insmod方式植入内核模块</p>
</blockquote>
<p>源码及makefile文件：<a href="test.c">test.c</a>和<a href="Makefile">Makefile</a>。编译完成后，insmod进待fuzz的linux系统中。</p>
<p>通过如下5个步骤完成定制：</p>
<ol>
<li><p>在sys/linux/目录下，新建针对目标内核模块的txt声明文件（本例中将其命名为<code>proc_test.txt</code>）</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux&#x2F;fs.h&gt;</span><br><span class="line"></span><br><span class="line">resource fd_111[fd]</span><br><span class="line"></span><br><span class="line">open$aaa(file ptr[in, string[&quot;&#x2F;proc&#x2F;newtest&quot;]], flags flags[proc_open_flags], mode flags[proc_open_mode]) fd_111</span><br><span class="line">read$aaa(fd_a fd_111, buf buffer[out], count len[buf])</span><br><span class="line">write$aaa(fd_a fd_111, buf buffer[in], count len[buf])</span><br><span class="line"></span><br><span class="line">proc_open_flags &#x3D; O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">proc_open_mode &#x3D; S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br><span class="line"></span><br></pre></td></tr></table></div></figure></li>
<li><p>执行syz-extract</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;syz-extract -os linux -arch amd64 -sourcedir &quot;&#x2F;home&#x2F;bling&#x2F;linux&quot; proc_test.txt</span><br></pre></td></tr></table></div></figure>
<p>该步骤将在sys/linux/目录下产生一个名为<code>proc_test.txt.const</code>的文件</p>
</li>
<li><p>执行syz-sysgen</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin&#x2F;syz-sysgen</span><br></pre></td></tr></table></div></figure>
<p>该步骤将更新syzkaller/sys/linux/gen/amd64.go，自动添加上新定义的系统调用，如下片段：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;NR:2,Name:&quot;open$aaa&quot;,CallName:&quot;open&quot;,Args:[]Field&#123;</span><br><span class="line">&#123;Name:&quot;file&quot;,Type:Ref(9200)&#125;,</span><br><span class="line">&#123;Name:&quot;flags&quot;,Type:Ref(5481)&#125;,</span><br><span class="line">&#123;Name:&quot;mode&quot;,Type:Ref(6042)&#125;,</span><br><span class="line">&#125;,Ret:Ref(11058)&#125;,</span><br><span class="line"></span><br><span class="line">&#123;Name:&quot;read$aaa&quot;,CallName:&quot;read&quot;,Args:[]Field&#123;</span><br><span class="line">&#123;Name:&quot;fd&quot;,Type:Ref(11058)&#125;,</span><br><span class="line">&#123;Name:&quot;buf&quot;,Type:Ref(10466)&#125;,</span><br><span class="line">&#123;Name:&quot;count&quot;,Type:Ref(6978)&#125;,</span><br><span class="line">&#125;&#125;,</span><br><span class="line"></span><br><span class="line">&#123;NR:1,Name:&quot;write$aaa&quot;,CallName:&quot;write&quot;,Args:[]Field&#123;</span><br><span class="line">&#123;Name:&quot;fd&quot;,Type:Ref(11058)&#125;,</span><br><span class="line">&#123;Name:&quot;buf&quot;,Type:Ref(8697)&#125;,</span><br><span class="line">&#123;Name:&quot;count&quot;,Type:Ref(6978)&#125;,</span><br><span class="line">&#125;&#125;,</span><br></pre></td></tr></table></div></figure></li>
<li><p>重新编译syzkaller</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make generate</span><br><span class="line">make</span><br></pre></td></tr></table></div></figure></li>
<li><p>指定syscall，重新运行syzkaller</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;target&quot;: &quot;linux&#x2F;amd64&quot;,</span><br><span class="line">	&quot;http&quot;: &quot;127.0.0.1:56741&quot;,</span><br><span class="line">	&quot;rpc&quot;: &quot;127.0.0.1:0&quot;,</span><br><span class="line">	&quot;sshkey&quot; : &quot;&#x2F;&#x2F;home&#x2F;bling&#x2F;qemu-img&#x2F;stretch.id_rsa&quot;,</span><br><span class="line">	&quot;workdir&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;syzkaller&#x2F;workdir&quot;,</span><br><span class="line">	&quot;kernel_obj&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;linux&quot;,</span><br><span class="line">	&quot;syzkaller&quot;: &quot;&#x2F;home&#x2F;bling&#x2F;syzkaller&quot;,</span><br><span class="line">	&quot;sandbox&quot;: &quot;setuid&quot;,</span><br><span class="line">	&quot;type&quot;: &quot;isolated&quot;,</span><br><span class="line">	&quot;enable_syscalls&quot;: [&quot;open$aaa&quot;, &quot;read$aaa&quot;, &quot;write$aaa&quot;],</span><br><span class="line">	&quot;vm&quot;: &#123;</span><br><span class="line">		&quot;targets&quot; : [ &quot;127.0.0.1:10021&quot; ],</span><br><span class="line">		&quot;pstore&quot;: false,</span><br><span class="line">		&quot;target_dir&quot; : &quot;&#x2F;home&#x2F;fuzzdir&quot;,</span><br><span class="line">    &quot;target_reboot&quot; : true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>执行<code>./bin/syz-manager -config=abcd.cfg</code>，开始fuzz。</p>
</li>
</ol>

        <h1 id="附录"   >
          <a href="#附录" class="heading-link"><i class="fas fa-link"></i></a><a href="#附录" class="headerlink" title="附录"></a>附录</h1>
      
        <h2 id="1-安装GCC"   >
          <a href="#1-安装GCC" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-安装GCC" class="headerlink" title="1 安装GCC"></a>1 安装GCC</h2>
      <blockquote>
<p>gcc下载地址：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://ftp.gnu.org/gnu/gcc/" >gcc下载</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>宿主机自带的gcc版本过低的话，需要在原本的基础上新装一个高版本的gcc。这里我选择源码安装，并且将它安装到一个单独目录，这样今后想卸载的话，直接删除该目录即可。</p>
<ul>
<li>解压gcc-7.4.0源码包：<code>tar -zxvf gcc-7.4.0.tar.gz</code>（或者<code>tar -Jxvf gcc-7.4.0.tar.xz</code>）</li>
<li>下载安装依赖项：在解压完的源码包中，执行./contrib/download_prerequisites（需更改base_url为<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://mirror.linux-ia64.org/gnu/gcc/infrastructure/%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%A7%E8%A1%8C%E6%97%B6%E4%B8%80%E7%9B%B4%E6%B2%A1%E6%9C%89%E8%BF%9B%E5%BA%A6%EF%BC%8C%E8%80%83%E8%99%91%E5%8A%A0%E4%B8%8Asudo%E6%9D%83%E9%99%90%E6%89%A7%E8%A1%8C%EF%BC%89%E3%80%82%E8%8B%A5%E6%89%A7%E8%A1%8C%E4%B8%8D%E6%88%90%E5%8A%9F%EF%BC%8C%E5%88%99%E9%9C%80%E8%87%AA%E8%A1%8C%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%EF%BC%8C%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B%E3%80%82" >http://mirror.linux-ia64.org/gnu/gcc/infrastructure/，如果执行时一直没有进度，考虑加上sudo权限执行）。若执行不成功，则需自行下载安装，步骤如下。</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gcc7.4.0依赖的gmp,mpfr和mpc版本如下：</span><br><span class="line">	gmp&#x3D;&#39;gmp-6.1.0.tar.bz2&#39;</span><br><span class="line">	mpfr&#x3D;&#39;mpfr-3.1.4.tar.bz2&#39;</span><br><span class="line">	mpc&#x3D;&#39;mpc-1.0.3.tar.gz&#39;</span><br><span class="line"></span><br><span class="line">安装过程参考链接：</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;lwbeyond&#x2F;article&#x2F;details&#x2F;77718040（主要参考该文档）</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;xs1102&#x2F;article&#x2F;details&#x2F;89175293</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;davidhopper&#x2F;article&#x2F;details&#x2F;79681695</span><br><span class="line"></span><br><span class="line">安装gmp到configure步骤时，出现“no usable m4”错误：</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;wangqing_12345&#x2F;article&#x2F;details&#x2F;52484723</span><br></pre></td></tr></table></div></figure>



        <h2 id="2-txt文件语法"   >
          <a href="#2-txt文件语法" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-txt文件语法" class="headerlink" title="2 txt文件语法"></a>2 txt文件语法</h2>
      <p>以ioctl为例，用户态调用规则：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int (*ioctl) (struct inode *inode,struct file *filp,unsigned int cmd,unsigned long arg);</span><br><span class="line">&#x2F;*</span><br><span class="line">inode与filp两个指针对应于应用程序传递的文件描述符fd，这和传递open方法的参数一样。</span><br><span class="line">cmd 由用户空间直接不经修改的传递给驱动程序</span><br><span class="line">arg 可选。</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></div></figure>
<p>定制过程：</p>
<p>1、 分析目标驱动的ioctl函数实现。 2、 找到每个cmd对应的代码块，分析arg的解析过程（结构体）。 3、 把所有这类结构体，按照 syzkaller 的规则写成类似go语言的结构体定义。结构体中如果包含了其他结构体，也都要写上 。 4、 每个cmd码都写成一个ioctl系统调用，以上面的结构体为参数。如：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">static long ion_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)</span><br><span class="line">&#123;</span><br><span class="line">	struct ion_client *client &#x3D; filp-&gt;private_data;</span><br><span class="line">	struct ion_device *dev &#x3D; client-&gt;dev;</span><br><span class="line">	struct ion_handle *cleanup_handle &#x3D; NULL;</span><br><span class="line">	int ret &#x3D; 0;</span><br><span class="line">	unsigned int dir;</span><br><span class="line"></span><br><span class="line">	union &#123;</span><br><span class="line">		struct ion_fd_data fd;</span><br><span class="line">		struct ion_allocation_data allocation;</span><br><span class="line">		struct ion_handle_data handle;</span><br><span class="line">		struct ion_custom_data custom;</span><br><span class="line">	&#125; data;</span><br><span class="line"></span><br><span class="line">	dir &#x3D; ion_ioctl_dir(cmd);</span><br><span class="line"></span><br><span class="line">	if (_IOC_SIZE(cmd) &gt; sizeof(data))</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	if (dir &amp; _IOC_WRITE)</span><br><span class="line">		if (copy_from_user(&amp;data, (void __user *)arg, _IOC_SIZE(cmd)))</span><br><span class="line">			return -EFAULT;</span><br><span class="line"></span><br><span class="line">	switch (cmd) &#123;</span><br><span class="line">	case ION_IOC_ALLOC:</span><br><span class="line">	&#123;</span><br><span class="line">		struct ion_handle *handle;</span><br><span class="line"></span><br><span class="line">		handle &#x3D; ion_alloc(client, data.allocation.len,</span><br><span class="line">						data.allocation.align,</span><br><span class="line">						data.allocation.heap_id_mask,</span><br><span class="line">						data.allocation.flags);</span><br><span class="line">		if (IS_ERR(handle))</span><br><span class="line">			return PTR_ERR(handle);</span><br><span class="line"></span><br><span class="line">		data.allocation.handle &#x3D; handle-&gt;id;</span><br><span class="line"></span><br><span class="line">		cleanup_handle &#x3D; handle;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	case ION_IOC_FREE:</span><br><span class="line">	&#123;</span><br><span class="line">		struct ion_handle *handle;</span><br><span class="line"></span><br><span class="line">		handle &#x3D; ion_handle_get_by_id(client, data.handle.handle);</span><br><span class="line">		if (IS_ERR(handle))</span><br><span class="line">			return PTR_ERR(handle);</span><br><span class="line">		ion_free(client, handle);</span><br><span class="line">		ion_handle_put(handle);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	case ION_IOC_SHARE:</span><br><span class="line">	case ION_IOC_MAP:</span><br><span class="line">	&#123;</span><br><span class="line">		struct ion_handle *handle;</span><br><span class="line"></span><br><span class="line">		handle &#x3D; ion_handle_get_by_id(client, data.handle.handle);</span><br><span class="line">		if (IS_ERR(handle))</span><br><span class="line">			return PTR_ERR(handle);</span><br><span class="line">		data.fd.fd &#x3D; ion_share_dma_buf_fd(client, handle);</span><br><span class="line">		ion_handle_put(handle);</span><br><span class="line">		if (data.fd.fd &lt; 0)</span><br><span class="line">			ret &#x3D; data.fd.fd;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	case ION_IOC_IMPORT:</span><br><span class="line">	&#123;</span><br><span class="line">		struct ion_handle *handle;</span><br><span class="line"></span><br><span class="line">		handle &#x3D; ion_import_dma_buf(client, data.fd.fd);</span><br><span class="line">		if (IS_ERR(handle))</span><br><span class="line">			ret &#x3D; PTR_ERR(handle);</span><br><span class="line">		else</span><br><span class="line">			data.handle.handle &#x3D; handle-&gt;id;</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	case ION_IOC_SYNC:</span><br><span class="line">	&#123;</span><br><span class="line">		ret &#x3D; ion_sync_for_device(client, data.fd.fd);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	case ION_IOC_CUSTOM:</span><br><span class="line">	&#123;</span><br><span class="line">		if (!dev-&gt;custom_ioctl)</span><br><span class="line">			return -ENOTTY;</span><br><span class="line">		ret &#x3D; dev-&gt;custom_ioctl(client, data.custom.cmd,</span><br><span class="line">						data.custom.arg);</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	default:</span><br><span class="line">		return -ENOTTY;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (dir &amp; _IOC_READ) &#123;</span><br><span class="line">		if (copy_to_user((void __user *)arg, &amp;data, _IOC_SIZE(cmd))) &#123;</span><br><span class="line">			if (cleanup_handle)</span><br><span class="line">				ion_free(client, cleanup_handle);</span><br><span class="line">			return -EFAULT;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>对应定制的txt：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">include &lt;asm&#x2F;ioctl.h&gt;</span><br><span class="line">include &lt;linux&#x2F;fcntl.h&gt;</span><br><span class="line">include &lt;..&#x2F;drivers&#x2F;staging&#x2F;android&#x2F;uapi&#x2F;ion.h&gt;</span><br><span class="line"></span><br><span class="line">resource fd_ion[fd]</span><br><span class="line">resource fd_ion_generic[fd]</span><br><span class="line"></span><br><span class="line">resource ion_handle[int32]</span><br><span class="line"></span><br><span class="line">openat$ion(fd const[AT_FDCWD], file ptr[in, string[&quot;&#x2F;dev&#x2F;ion&quot;]], flags flags[open_flags], mode const[0]) fd_ion</span><br><span class="line">ioctl$ION_IOC_ALLOC(fd fd_ion, cmd const[ION_IOC_ALLOC], arg ptr[inout, ion_allocation_data])</span><br><span class="line">ioctl$ION_IOC_FREE(fd fd_ion, cmd const[ION_IOC_FREE], arg ptr[in, ion_handle_data])</span><br><span class="line">ioctl$ION_IOC_MAP(fd fd_ion, cmd const[ION_IOC_MAP], arg ptr[inout, ion_fd_data])</span><br><span class="line">ioctl$ION_IOC_SHARE(fd fd_ion, cmd const[ION_IOC_SHARE], arg ptr[inout, ion_fd_data])</span><br><span class="line">ioctl$ION_IOC_IMPORT(fd fd_ion, cmd const[ION_IOC_IMPORT], arg ptr[inout, ion_fd_data])</span><br><span class="line">ioctl$ION_IOC_SYNC(fd fd_ion, cmd const[ION_IOC_SYNC], arg ptr[inout, ion_fd_data])</span><br><span class="line">ioctl$ION_IOC_CUSTOM(fd fd_ion, cmd const[ION_IOC_CUSTOM], arg ptr[inout, ion_custom_data])</span><br><span class="line"></span><br><span class="line">ion_allocation_data &#123;</span><br><span class="line">	len	intptr</span><br><span class="line">	align	intptr</span><br><span class="line">	heapid	int32</span><br><span class="line">	flags	int32</span><br><span class="line">	handle	ion_handle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ion_handle_data &#123;</span><br><span class="line">	handle	ion_handle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ion_fd_data &#123;</span><br><span class="line">	handle	ion_handle</span><br><span class="line">	fd	fd_ion_generic</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ion_custom_data &#123;</span><br><span class="line">	cmd	int32</span><br><span class="line">	arg	intptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>





        <h1 id="参考文章推荐"   >
          <a href="#参考文章推荐" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考文章推荐" class="headerlink" title="参考文章推荐"></a>参考文章推荐</h1>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5079?spm=5176.12901015.0.i12901015.3af8525coJ6I6t" >内核漏洞挖掘技术系列(4)——syzkaller(1)</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/790b733f80a2" >【漏洞挖掘】使用Syzkaller&amp;QEMU捕捉内核堆溢出Demo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://pwn4.fun/2019/10/09/Syzkaller-Crash-Demo/" >Syzkaller Crash Demo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-265405.htm#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%EF%BC%88%E5%90%90%E8%A1%80%E8%B8%A9%E5%9D%91%EF%BC%89" >从0到1开始使用syzkaller进行Linux内核漏洞挖掘 </a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.collabora.com/news-and-blog/blog/2020/03/26/syzkaller-fuzzing-the-kernel/" >Using syzkaller, part 1: Fuzzing the Linux kernel</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.collabora.com/news-and-blog/blog/2020/04/17/using-syzkaller-to-detect-programming-bugs-in-linux/" >Using syzkaller, part 2: Detecting programming bugs in the Linux kernel</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/24/NOTE-0X06-LINUX-KERNEL-PWN-PART-III/" >Linux Kernel Pwn III：使用 syzkaller 进行漏洞挖掘</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://xairy.io/articles/2021/syzkaller-syntax-highlight" >Highlighting syzkaller descriptions syntax with Rouge</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://blingblingxuanxuan.github.io">blingbling</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/">http://blingblingxuanxuan.github.io/2019/10/26/syzkaller/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-share"><div class="social-share" data-sites="qzone, qq, weibo, wechat, douban, linkedin, facebook, twitter, google">Share to: </div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/02/08/SIM/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">SIM卡复制原理</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/01/01/linux-releated/"><span class="paginator-prev__text">linux releated</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#x86-64-linux%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.</span> <span class="toc-text">
          x86-64 linux虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91syzkaller"><span class="toc-number">1.1.</span> <span class="toc-text">
          编译syzkaller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91linux%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.</span> <span class="toc-text">
          编译linux内核</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEqemu%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.3.</span> <span class="toc-text">
          配置qemu虚拟机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8syzkaller-qemu"><span class="toc-number">1.4.</span> <span class="toc-text">
          启动syzkaller - qemu</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8syzkaller-isolated"><span class="toc-number">1.5.</span> <span class="toc-text">
          启动syzkaller - isolated</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%A5%BD%E5%BE%85%E6%B5%8B%E8%AF%95%E8%AE%BE%E5%A4%87"><span class="toc-number">1.5.1.</span> <span class="toc-text">
          配置好待测试设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8Csyzkaller"><span class="toc-number">1.5.2.</span> <span class="toc-text">
          运行syzkaller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E9%AB%98fuzz%E6%95%88%E7%8E%87"><span class="toc-number">2.</span> <span class="toc-text">
          提高fuzz效率</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6syscall-description"><span class="toc-number">2.1.</span> <span class="toc-text">
          定制syscall description</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8syzlang%E6%8F%8F%E8%BF%B0%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.1.</span> <span class="toc-text">
          用syzlang描述系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF%E7%BC%96%E8%AF%91%E8%BF%9Bsyzkaller"><span class="toc-number">2.1.2.</span> <span class="toc-text">
          将描述信息编译进syzkaller</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E6%AC%A1%E5%AE%9A%E5%88%B6%E7%A4%BA%E4%BE%8B%EF%BC%88isolated%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">
          一次定制示例（isolated）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E8%BF%9B%E5%86%85%E6%A0%B8"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          编译进内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93ko"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          打ko</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">
          附录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85GCC"><span class="toc-number">3.1.</span> <span class="toc-text">
          1 安装GCC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-txt%E6%96%87%E4%BB%B6%E8%AF%AD%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">
          2 txt文件语法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0%E6%8E%A8%E8%8D%90"><span class="toc-number">4.</span> <span class="toc-text">
          参考文章推荐</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/uploads/littledog.jpg" alt="avatar"></div></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/blingblingxuanxuan" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">78</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">15</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">49</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>blingbling</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.3.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="访问人数"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon" data-popover-pos="up" data-popover="浏览总量"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div>Just follow your heart, and keep smiling.</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>